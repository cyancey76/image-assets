function ASSERT(e,t){if(!e){if(t="Failed assert: "+t,DEBUG_MODE)alert(t);else{var i={api:"room.log",error:t,clientid:turntable.clientId};turntable.user.id&&(i.userid=turntable.user.id,i.userauth=turntable.user.auth),turntable.socket.send(JSON.stringify(i))}throw t}}var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function i(e,t){var i,n,o,s,r,a,l,u,d,h,c=t&&t.split("/"),p=m.map,f=p&&p["*"]||{};if(e&&"."===e.charAt(0))if(t){for(c=c.slice(0,c.length-1),e=c.concat(e.split("/")),u=0;u<e.length;u+=1)if(h=e[u],"."===h)e.splice(u,1),u-=1;else if(".."===h){if(1===u&&(".."===e[2]||".."===e[0]))break;u>0&&(e.splice(u-1,2),u-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((c||f)&&p){for(i=e.split("/"),u=i.length;u>0;u-=1){if(n=i.slice(0,u).join("/"),c)for(d=c.length;d>0;d-=1)if(o=p[c.slice(0,d).join("/")],o&&(o=o[n])){s=o,r=u;break}if(s)break;!a&&f&&f[n]&&(a=f[n],l=u)}!s&&a&&(s=a,r=l),s&&(i.splice(0,r,s),e=i.join("/"))}return e}function n(t,i){return function(){return d.apply(e,b.call(arguments,0).concat([t,i]))}}function o(e){return function(t){return i(t,e)}}function s(e){return function(t){p[e]=t}}function r(i){if(t(f,i)){var n=f[i];delete f[i],g[i]=!0,u.apply(e,n)}if(!t(p,i)&&!t(g,i))throw new Error("No "+i);return p[i]}function a(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function l(e){return function(){return m&&m.config&&m.config[e]||{}}}var u,d,h,c,p={},f={},m={},g={},v=Object.prototype.hasOwnProperty,b=[].slice;h=function(e,t){var n,s=a(e),l=s[0];return e=s[1],l&&(l=i(l,t),n=r(l)),l?e=n&&n.normalize?n.normalize(e,o(t)):i(e,t):(e=i(e,t),s=a(e),l=s[0],e=s[1],l&&(n=r(l))),{f:l?l+"!"+e:e,n:e,pr:l,p:n}},c={require:function(e){return n(e)},exports:function(e){var t=p[e];return"undefined"!=typeof t?t:p[e]={}},module:function(e){return{id:e,uri:"",exports:p[e],config:l(e)}}},u=function(i,o,a,l){var u,d,m,v,b,w,y=[];if(l=l||i,"function"==typeof a){for(o=!o.length&&a.length?["require","exports","module"]:o,b=0;b<o.length;b+=1)if(v=h(o[b],l),d=v.f,"require"===d)y[b]=c.require(i);else if("exports"===d)y[b]=c.exports(i),w=!0;else if("module"===d)u=y[b]=c.module(i);else if(t(p,d)||t(f,d)||t(g,d))y[b]=r(d);else{if(!v.p)throw new Error(i+" missing "+d);v.p.load(v.n,n(l,!0),s(d),{}),y[b]=p[d]}m=a.apply(p[i],y),i&&(u&&u.exports!==e&&u.exports!==p[i]?p[i]=u.exports:m===e&&w||(p[i]=m))}else i&&(p[i]=a)},requirejs=require=d=function(t,i,n,o,s){return"string"==typeof t?c[t]?c[t](i):r(h(t,i).f):(t.splice||(m=t,i.splice?(t=i,i=n,n=null):t=e),i=i||function(){},"function"==typeof n&&(n=o,o=s),o?u(e,t,i,n):setTimeout(function(){u(e,t,i,n)},4),d)},d.config=function(e){return m=e,m.deps&&d(m.deps,m.callback),d},define=function(e,i,n){i.splice||(n=i,i=[]),t(p,e)||t(f,e)||(f[e]=[e,i,n])},define.amd={jQuery:!0}}(),define("lib/almond",function(){}),function(e,t){function i(i,n){function o(e){return pt.preferFlash&&at&&!pt.ignoreFlash&&pt.flash[e]!==t&&pt.flash[e]}function s(e){return function(t){var i,n=this._s;return n&&n._a?i=e.call(this,t):(n&&n.id?pt._wD(n.id+": Ignoring "+t.type):pt._wD(bt+"Ignoring "+t.type),i=null),i}}this.setupOptions={url:i||null,flashVersion:8,debugMode:!0,debugFlash:!1,useConsole:!0,consoleOnly:!0,waitForWindowLoad:!1,bgColor:"#ffffff",useHighPerformance:!1,flashPollingInterval:null,html5PollingInterval:null,flashLoadTimeout:1e3,wmode:null,allowScriptAccess:"always",useFlashBlock:!1,useHTML5Audio:!0,html5Test:/^(probably|maybe)$/i,preferFlash:!0,noSWFCache:!1},this.defaultOptions={autoLoad:!1,autoPlay:!1,from:null,loops:1,onid3:null,onload:null,whileloading:null,onplay:null,onpause:null,onresume:null,whileplaying:null,onposition:null,onstop:null,onfailure:null,onfinish:null,multiShot:!0,multiShotEvents:!1,position:null,pan:0,stream:!0,to:null,type:null,usePolicyFile:!1,volume:100},this.flash9Options={isMovieStar:null,usePeakData:!1,useWaveformData:!1,useEQData:!1,onbufferchange:null,ondataerror:null},this.movieStarOptions={bufferTime:3,serverURL:null,onconnect:null,duration:null},this.audioFormats={mp3:{type:['audio/mpeg; codecs="mp3"',"audio/mpeg","audio/mp3","audio/MPA","audio/mpa-robust"],required:!0},mp4:{related:["aac","m4a","m4b"],type:['audio/mp4; codecs="mp4a.40.2"',"audio/aac","audio/x-m4a","audio/MP4A-LATM","audio/mpeg4-generic"],required:!1},ogg:{type:["audio/ogg; codecs=vorbis"],required:!1},wav:{type:['audio/wav; codecs="1"',"audio/wav","audio/wave","audio/x-wav"],required:!1}},this.movieID="sm2-container",this.id=n||"sm2movie",this.debugID="soundmanager-debug",this.debugURLParam=/([#?&])debug=1/i,this.versionNumber="V2.97a.20130101",this.version=null,this.movieURL=null,this.altURL=null,this.swfLoaded=!1,this.enabled=!1,this.oMC=null,this.sounds={},this.soundIDs=[],this.muted=!1,this.didFlashBlock=!1,this.filePattern=null,this.filePatterns={flash8:/\.mp3(\?.*)?$/i,flash9:/\.mp3(\?.*)?$/i},this.features={buffering:!1,peakData:!1,waveformData:!1,eqData:!1,movieStar:!1},this.sandbox={type:null,types:{remote:"remote (domain-based) rules",localWithFile:"local with file access (no internet access)",localWithNetwork:"local with network (internet access only, no local access)",localTrusted:"local, trusted (local+internet access)"},description:null,noRemote:null,noLocal:null},this.html5={usingFlash:null},this.flash={},this.html5Only=!1,this.ignoreFlash=!1;var r,a,l,u,d,h,c,p,f,m,g,v,b,w,y,_,x,S,k,C,T,I,M,P,$,A,E,D,R,L,O,j,F,B,N,z,V,q,U,X,H,W,G,Y,Q,K,J,Z,et,tt,it,nt,ot,st,rt,at,lt,ut,dt,ht,ct,pt=this,ft=null,mt=null,gt="soundManager",vt=gt+": ",bt="HTML5::",wt=navigator.userAgent,yt=e.location.href.toString(),_t=document,xt=[],St=!0,kt=!1,Ct=!1,Tt=!1,It=!1,Mt=!1,Pt=0,$t=["log","info","warn","error"],At=8,Et=null,Dt=null,Rt=!1,Lt=!1,Ot=0,jt=null,Ft=[],Bt=null,Nt=Array.prototype.slice,zt=!1,Vt=wt.match(/(ipad|iphone|ipod)/i),qt=wt.match(/android/i),Ut=wt.match(/msie/i),Xt=wt.match(/webkit/i),Ht=wt.match(/safari/i)&&!wt.match(/chrome/i),Wt=wt.match(/opera/i),Gt=wt.match(/(mobile|pre\/|xoom)/i)||Vt||qt,Yt=!yt.match(/usehtml5audio/i)&&!yt.match(/sm2\-ignorebadua/i)&&Ht&&!wt.match(/silk/i)&&wt.match(/OS X 10_6_([3-7])/i),Qt=e.console!==t&&console.log!==t,Kt=_t.hasFocus!==t?_t.hasFocus():null,Jt=Ht&&(_t.hasFocus===t||!_t.hasFocus()),Zt=!Jt,ei=/(mp3|mp4|mpa|m4a|m4b)/i,ti="about:blank",ii=_t.location?_t.location.protocol.match(/http/i):null,ni=ii?"":"http://",oi=/^\s*audio\/(?:x-)?(?:mpeg4|aac|flv|mov|mp4||m4v|m4a|m4b|mp4v|3gp|3g2)\s*(?:$|;)/i,si=["mpeg4","aac","flv","mov","mp4","m4v","f4v","m4a","m4b","mp4v","3gp","3g2"],ri=new RegExp("\\.("+si.join("|")+")(\\?.*)?$","i");this.mimePattern=/^\s*audio\/(?:x-)?(?:mp(?:eg|3))\s*(?:$|;)/i,this.useAltURL=!ii,V={swfBox:"sm2-object-box",swfDefault:"movieContainer",swfError:"swf_error",swfTimedout:"swf_timedout",swfLoaded:"swf_loaded",swfUnblocked:"swf_unblocked",sm2Debug:"sm2_debug",highPerf:"high_performance",flashDebug:"flash_debug"},this.hasHTML5=function(){try{return Audio!==t&&(Wt&&opera!==t&&opera.version()<10?new Audio(null):new Audio).canPlayType!==t}catch(e){return!1}}(),this.setup=function(e){var i=!pt.url;return e!==t&&Tt&&Bt&&pt.ok()&&(e.flashVersion!==t||e.url!==t||e.html5Test!==t)&&H(B("setupLate")),g(e),i&&$&&e.url!==t&&pt.beginDelayedInit(),$||e.url===t||"complete"!==_t.readyState||setTimeout(M,1),pt},this.ok=function(){return Bt?Tt&&!It:pt.useHTML5Audio&&pt.hasHTML5},this.supported=this.ok,this.getMovie=function(t){return a(t)||_t[t]||e[t]},this.createSound=function(e,i){function n(){return a=U(a),pt.sounds[a.id]=new r(a),pt.soundIDs.push(a.id),pt.sounds[a.id]}var o,s,a,l=null;return o=gt+".createSound(): ",s=o+B(Tt?"notOK":"notReady"),Tt&&pt.ok()?(i!==t&&(e={id:e,url:i}),a=m(e),a.url=K(a.url),a.id.toString().charAt(0).match(/^[0-9]$/)&&pt._wD(o+B("badID",a.id),2),pt._wD(o+a.id+" ("+a.url+")",1),W(a.id,!0)?(pt._wD(o+a.id+" exists",1),pt.sounds[a.id]):(Z(a)?(l=n(),pt._wD(a.id+": Using HTML5"),l._setup_html5(a)):(h>8&&(null===a.isMovieStar&&(a.isMovieStar=!(!a.serverURL&&(a.type?!a.type.match(oi):1)&&!a.url.match(ri))),a.isMovieStar&&(pt._wD(o+"using MovieStar handling"),a.loops>1&&p("noNSLoop"))),a=X(a,o),l=n(),8===h?mt._createSound(a.id,a.loops||1,a.usePolicyFile):(mt._createSound(a.id,a.url,a.usePeakData,a.useWaveformData,a.useEQData,a.isMovieStar,a.isMovieStar?a.bufferTime:!1,a.loops||1,a.serverURL,a.duration||null,a.autoPlay,!0,a.autoLoad,a.usePolicyFile),a.serverURL||(l.connected=!0,a.onconnect&&a.onconnect.apply(l))),a.serverURL||!a.autoLoad&&!a.autoPlay||l.load(a)),!a.serverURL&&a.autoPlay&&l.play(),l)):(H(s),!1)},this.destroySound=function(e,t){if(!W(e))return!1;var i,n=pt.sounds[e];for(n._iO={},n.stop(),n.unload(),i=0;i<pt.soundIDs.length;i++)if(pt.soundIDs[i]===e){pt.soundIDs.splice(i,1);break}return t||n.destruct(!0),n=null,delete pt.sounds[e],!0},this.load=function(e,t){return W(e)?pt.sounds[e].load(t):!1},this.unload=function(e){return W(e)?pt.sounds[e].unload():!1},this.onPosition=function(e,t,i,n){return W(e)?pt.sounds[e].onposition(t,i,n):!1},this.onposition=this.onPosition,this.clearOnPosition=function(e,t,i){return W(e)?pt.sounds[e].clearOnPosition(t,i):!1},this.play=function(e,t){var i=!1;return Tt&&pt.ok()?W(e)?pt.sounds[e].play(t):(t instanceof Object||(t={url:t}),t&&t.url&&(pt._wD(gt+'.play(): attempting to create "'+e+'"',1),t.id=e,i=pt.createSound(t).play()),i):(H(gt+".play(): "+B(Tt?"notOK":"notReady")),i)},this.start=this.play,this.setPosition=function(e,t){return W(e)?pt.sounds[e].setPosition(t):!1},this.stop=function(e){return W(e)?(pt._wD(gt+".stop("+e+")",1),pt.sounds[e].stop()):!1},this.stopAll=function(){var e;pt._wD(gt+".stopAll()",1);for(e in pt.sounds)pt.sounds.hasOwnProperty(e)&&pt.sounds[e].stop()},this.pause=function(e){return W(e)?pt.sounds[e].pause():!1},this.pauseAll=function(){var e;for(e=pt.soundIDs.length-1;e>=0;e--)pt.sounds[pt.soundIDs[e]].pause()},this.resume=function(e){return W(e)?pt.sounds[e].resume():!1},this.resumeAll=function(){var e;for(e=pt.soundIDs.length-1;e>=0;e--)pt.sounds[pt.soundIDs[e]].resume()},this.togglePause=function(e){return W(e)?pt.sounds[e].togglePause():!1},this.setPan=function(e,t){return W(e)?pt.sounds[e].setPan(t):!1},this.setVolume=function(e,t){return W(e)?pt.sounds[e].setVolume(t):!1},this.mute=function(e){var t=0;if(e instanceof String&&(e=null),e)return W(e)?(pt._wD(gt+'.mute(): Muting "'+e+'"'),pt.sounds[e].mute()):!1;for(pt._wD(gt+".mute(): Muting all sounds"),t=pt.soundIDs.length-1;t>=0;t--)pt.sounds[pt.soundIDs[t]].mute();return pt.muted=!0,!0},this.muteAll=function(){pt.mute()},this.unmute=function(e){var t;if(e instanceof String&&(e=null),e)return W(e)?(pt._wD(gt+'.unmute(): Unmuting "'+e+'"'),pt.sounds[e].unmute()):!1;for(pt._wD(gt+".unmute(): Unmuting all sounds"),t=pt.soundIDs.length-1;t>=0;t--)pt.sounds[pt.soundIDs[t]].unmute();return pt.muted=!1,!0},this.unmuteAll=function(){pt.unmute()},this.toggleMute=function(e){return W(e)?pt.sounds[e].toggleMute():!1},this.getMemoryUse=function(){var e=0;return mt&&8!==h&&(e=parseInt(mt._getMemoryUse(),10)),e},this.disable=function(i){var n;if(i===t&&(i=!1),It)return!1;for(It=!0,p("shutdown",1),n=pt.soundIDs.length-1;n>=0;n--)O(pt.sounds[pt.soundIDs[n]]);return f(i),st.remove(e,"load",y),!0},this.canPlayMIME=function(e){var t;return pt.hasHTML5&&(t=et({type:e})),!t&&Bt&&(t=e&&pt.ok()?!!((h>8?e.match(oi):null)||e.match(pt.mimePattern)):null),t},this.canPlayURL=function(e){var t;return pt.hasHTML5&&(t=et({url:e})),!t&&Bt&&(t=e&&pt.ok()?!!e.match(pt.filePattern):null),t},this.canPlayLink=function(e){return e.type!==t&&e.type&&pt.canPlayMIME(e.type)?!0:pt.canPlayURL(e.href)},this.getSoundById=function(e,t){if(!e)throw new Error(gt+".getSoundById(): sID is null/_undefined");var i=pt.sounds[e];return i||t||pt._wD('"'+e+'" is an invalid sound ID.',2),i},this.onready=function(t,i){var n="onready",o=!1;if("function"!=typeof t)throw B("needFunction",n);return Tt&&pt._wD(B("queue",n)),i||(i=e),b(n,t,i),w(),o=!0,o},this.ontimeout=function(t,i){var n="ontimeout",o=!1;if("function"!=typeof t)throw B("needFunction",n);return Tt&&pt._wD(B("queue",n)),i||(i=e),b(n,t,i),w({type:n}),o=!0,o},this._writeDebug=function(e,i){var n,o,s="soundmanager-debug";return pt.debugMode?Qt&&pt.useConsole&&(i&&"object"==typeof i?console.log(e,i):$t[i]!==t?console[$t[i]](e):console.log(e),pt.consoleOnly)?!0:(n=a(s))?(o=_t.createElement("div"),0===++Pt%2&&(o.className="sm2-alt"),i=i===t?0:parseInt(i,10),o.appendChild(_t.createTextNode(e)),i&&(i>=2&&(o.style.fontWeight="bold"),3===i&&(o.style.color="#ff3333")),n.insertBefore(o,n.firstChild),n=null,!0):!1:!1},-1!==yt.indexOf("sm2-debug=alert")&&(this._writeDebug=function(t){e.alert(t)}),this._wD=this._writeDebug,this._debug=function(){var e,t;for(p("currentObj",1),e=0,t=pt.soundIDs.length;t>e;e++)pt.sounds[pt.soundIDs[e]]._debug()},this.reboot=function(t,i){pt.soundIDs.length&&pt._wD("Destroying "+pt.soundIDs.length+" SMSound objects...");var n,o,s;for(n=pt.soundIDs.length-1;n>=0;n--)pt.sounds[pt.soundIDs[n]].destruct();if(mt)try{Ut&&(Dt=mt.innerHTML),Et=mt.parentNode.removeChild(mt),p("flRemoved")}catch(r){p("badRemove",2)}if(Dt=Et=Bt=mt=null,pt.enabled=$=Tt=Rt=Lt=kt=Ct=It=zt=pt.swfLoaded=!1,pt.soundIDs=[],pt.sounds={},t)xt=[];else for(n in xt)if(xt.hasOwnProperty(n))for(o=0,s=xt[n].length;s>o;o++)xt[n][o].fired=!1;return i||pt._wD(gt+": Rebooting..."),pt.html5={usingFlash:null},pt.flash={},pt.html5Only=!1,pt.ignoreFlash=!1,e.setTimeout(function(){I(),i||pt.beginDelayedInit()},20),pt},this.reset=function(){return p("reset"),pt.reboot(!0,!0)},this.getMoviePercent=function(){return mt&&"PercentLoaded"in mt?mt.PercentLoaded():null},this.beginDelayedInit=function(){Mt=!0,M(),setTimeout(function(){return Lt?!1:(E(),T(),Lt=!0,!0)},20),_()},this.destruct=function(){pt._wD(gt+".destruct()"),pt.disable(!0)},r=function(e){var i,n,o,s,r,a,l,u,d,f=this,g=!1,v=[],b=0,w=null;d={duration:null,time:null},this.id=e.id,this.sID=this.id,this.url=e.url,this.options=m(e),this.instanceOptions=this.options,this._iO=this.instanceOptions,this.pan=this.options.pan,this.volume=this.options.volume,this.isHTML5=!1,this._a=null,this.id3={},this._debug=function(){pt._wD(f.id+": Merged options:",f.options)},this.load=function(e){var i,n=null;if(e!==t?f._iO=m(e,f.options):(e=f.options,f._iO=e,w&&w!==f.url&&(p("manURL"),f._iO.url=f.url,f.url=null)),f._iO.url||(f._iO.url=f.url),f._iO.url=K(f._iO.url),f.instanceOptions=f._iO,i=f._iO,pt._wD(f.id+": load ("+i.url+")"),i.url===f.url&&0!==f.readyState&&2!==f.readyState)return p("onURL",1),3===f.readyState&&i.onload&&i.onload.apply(f,[!!f.duration]),f;if(f.loaded=!1,f.readyState=1,f.playState=0,f.id3={},Z(i))n=f._setup_html5(i),n._called_load?pt._wD(f.id+": Ignoring request to load again"):(f._html5_canplay=!1,f.url!==i.url&&(pt._wD(p("manURL")+": "+i.url),f._a.src=i.url,f.setPosition(0)),f._a.autobuffer="auto",f._a.preload="auto",f._a._called_load=!0,i.autoPlay&&f.play());else try{f.isHTML5=!1,f._iO=X(U(i)),i=f._iO,8===h?mt._load(f.id,i.url,i.stream,i.autoPlay,i.usePolicyFile):mt._load(f.id,i.url,!!i.stream,!!i.autoPlay,i.loops||1,!!i.autoLoad,i.usePolicyFile)}catch(o){p("smError",2),c("onload",!1),D({type:"SMSOUND_LOAD_JS_EXCEPTION",fatal:!0})}return f.url=i.url,f},this.unload=function(){return 0!==f.readyState&&(pt._wD(f.id+": unload()"),f.isHTML5?(s(),f._a&&(f._a.pause(),it(f._a,ti),w=ti)):8===h?mt._unload(f.id,ti):mt._unload(f.id),i()),f},this.destruct=function(e){pt._wD(f.id+": Destruct"),f.isHTML5?(s(),f._a&&(f._a.pause(),it(f._a),zt||o(),f._a._s=null,f._a=null)):(f._iO.onfailure=null,mt._destroySound(f.id)),e||pt.destroySound(f.id,!0)},this.play=function(e,i){var n,o,s,l,d=!0,c=null;if(n=f.id+": play(): ",i=i===t?!0:i,e||(e={}),f.url&&(f._iO.url=f.url),f._iO=m(f._iO,f.options),f._iO=m(e,f._iO),f._iO.url=K(f._iO.url),f.instanceOptions=f._iO,f._iO.serverURL&&!f.connected)return f.getAutoPlay()||(pt._wD(n+" Netstream not connected yet - setting autoPlay"),f.setAutoPlay(!0)),f;if(Z(f._iO)&&(f._setup_html5(f._iO),r()),1!==f.playState||f.paused||(o=f._iO.multiShot,o?pt._wD(n+"Already playing (multi-shot)",1):(pt._wD(n+"Already playing (one-shot)",1),c=f)),null!==c)return c;if(e.url&&e.url!==f.url&&f.load(f._iO),f.loaded?pt._wD(n):0===f.readyState?(pt._wD(n+"Attempting to load"),f.isHTML5?f.load(f._iO):(f._iO.autoPlay=!0,f.load(f._iO)),f.instanceOptions=f._iO):2===f.readyState?(pt._wD(n+"Could not load - exiting",2),c=f):pt._wD(n+"Loading - attempting to play..."),null!==c)return c;if(!f.isHTML5&&9===h&&f.position>0&&f.position===f.duration&&(pt._wD(n+"Sound at end, resetting to position:0"),e.position=0),f.paused&&f.position>=0&&(!f._iO.serverURL||f.position>0))pt._wD(n+"Resuming from paused state",1),f.resume();else{if(f._iO=m(e,f._iO),null!==f._iO.from&&null!==f._iO.to&&0===f.instanceCount&&0===f.playState&&!f._iO.serverURL){if(l=function(){f._iO=m(e,f._iO),f.play(f._iO)},f.isHTML5&&!f._html5_canplay?(pt._wD(n+"Beginning load for from/to case"),f.load({oncanplay:l}),c=!1):f.isHTML5||f.loaded||f.readyState&&2===f.readyState||(pt._wD(n+"Preloading for from/to case"),f.load({onload:l}),c=!1),null!==c)return c;f._iO=u()}pt._wD(n+"Starting to play"),(!f.instanceCount||f._iO.multiShotEvents||!f.isHTML5&&h>8&&!f.getAutoPlay())&&f.instanceCount++,f._iO.onposition&&0===f.playState&&a(f),f.playState=1,f.paused=!1,f.position=f._iO.position===t||isNaN(f._iO.position)?0:f._iO.position,f.isHTML5||(f._iO=X(U(f._iO))),f._iO.onplay&&i&&(f._iO.onplay.apply(f),g=!0),f.setVolume(f._iO.volume,!0),f.setPan(f._iO.pan,!0),f.isHTML5?(r(),s=f._setup_html5(),f.setPosition(f._iO.position),s.play()):(d=mt._start(f.id,f._iO.loops||1,9===h?f._iO.position:f._iO.position/1e3,f._iO.multiShot),9!==h||d||(pt._wD(n+"No sound hardware, or 32-sound ceiling hit"),f._iO.onplayerror&&f._iO.onplayerror.apply(f)))}return f},this.start=this.play,this.stop=function(e){var t,i=f._iO;return 1===f.playState&&(pt._wD(f.id+": stop()"),f._onbufferchange(0),f._resetOnPosition(0),f.paused=!1,f.isHTML5||(f.playState=0),l(),i.to&&f.clearOnPosition(i.to),f.isHTML5?f._a&&(t=f.position,f.setPosition(0),f.position=t,f._a.pause(),f.playState=0,f._onTimer(),s()):(mt._stop(f.id,e),i.serverURL&&f.unload()),f.instanceCount=0,f._iO={},i.onstop&&i.onstop.apply(f)),f},this.setAutoPlay=function(e){pt._wD(f.id+": Autoplay turned "+(e?"on":"off")),f._iO.autoPlay=e,f.isHTML5||(mt._setAutoPlay(f.id,e),e&&(f.instanceCount||1!==f.readyState||(f.instanceCount++,pt._wD(f.id+": Incremented instance count to "+f.instanceCount))))},this.getAutoPlay=function(){return f._iO.autoPlay},this.setPosition=function(e){e===t&&(e=0);var i,n,o,s=f.isHTML5?Math.max(e,0):Math.min(f.duration||f._iO.duration,Math.max(e,0));if(i=f.position,f.position=s,o=f.position/1e3,f._resetOnPosition(f.position),f._iO.position=s,f.isHTML5){if(f._a)if(f._html5_canplay){if(f._a.currentTime!==o){pt._wD(f.id+": setPosition("+o+")");try{f._a.currentTime=o,(0===f.playState||f.paused)&&f._a.pause()}catch(r){pt._wD(f.id+": setPosition("+o+") failed: "+r.message,2)}}}else pt._wD(f.id+": setPosition("+o+"): Cannot seek yet, sound not ready")}else n=9===h?f.position:o,f.readyState&&2!==f.readyState&&mt._setPosition(f.id,n,f.paused||!f.playState,f._iO.multiShot);return f.isHTML5&&f.paused&&f._onTimer(!0),f},this.pause=function(e){return f.paused||0===f.playState&&1!==f.readyState?f:(pt._wD(f.id+": pause()"),f.paused=!0,f.isHTML5?(f._setup_html5().pause(),s()):(e||e===t)&&mt._pause(f.id,f._iO.multiShot),f._iO.onpause&&f._iO.onpause.apply(f),f)},this.resume=function(){var e=f._iO;return f.paused?(pt._wD(f.id+": resume()"),f.paused=!1,f.playState=1,f.isHTML5?(f._setup_html5().play(),r()):(e.isMovieStar&&!e.serverURL&&f.setPosition(f.position),mt._pause(f.id,e.multiShot)),!g&&e.onplay?(e.onplay.apply(f),g=!0):e.onresume&&e.onresume.apply(f),f):f},this.togglePause=function(){return pt._wD(f.id+": togglePause()"),0===f.playState?(f.play({position:9!==h||f.isHTML5?f.position/1e3:f.position}),f):(f.paused?f.resume():f.pause(),f)},this.setPan=function(e,i){return e===t&&(e=0),i===t&&(i=!1),f.isHTML5||mt._setPan(f.id,e),f._iO.pan=e,i||(f.pan=e,f.options.pan=e),f},this.setVolume=function(e,i){return e===t&&(e=100),i===t&&(i=!1),f.isHTML5?f._a&&(f._a.volume=Math.max(0,Math.min(1,e/100))):mt._setVolume(f.id,pt.muted&&!f.muted||f.muted?0:e),f._iO.volume=e,i||(f.volume=e,f.options.volume=e),f},this.mute=function(){return f.muted=!0,f.isHTML5?f._a&&(f._a.muted=!0):mt._setVolume(f.id,0),f},this.unmute=function(){f.muted=!1;var e=f._iO.volume!==t;return f.isHTML5?f._a&&(f._a.muted=!1):mt._setVolume(f.id,e?f._iO.volume:f.options.volume),f},this.toggleMute=function(){return f.muted?f.unmute():f.mute()},this.onPosition=function(e,i,n){return v.push({position:parseInt(e,10),method:i,scope:n!==t?n:f,fired:!1}),f},this.onposition=this.onPosition,this.clearOnPosition=function(e,t){var i;if(e=parseInt(e,10),isNaN(e))return!1;for(i=0;i<v.length;i++)e===v[i].position&&(t&&t!==v[i].method||(v[i].fired&&b--,v.splice(i,1)))},this._processOnPosition=function(){var e,t,i=v.length;if(!i||!f.playState||b>=i)return!1;for(e=i-1;e>=0;e--)t=v[e],!t.fired&&f.position>=t.position&&(t.fired=!0,b++,t.method.apply(t.scope,[t.position]));return!0},this._resetOnPosition=function(e){var t,i,n=v.length;if(!n)return!1;for(t=n-1;t>=0;t--)i=v[t],i.fired&&e<=i.position&&(i.fired=!1,b--);return!0},u=function(){var e,t,i=f._iO,n=i.from,o=i.to;return t=function(){pt._wD(f.id+': "To" time of '+o+" reached."),f.clearOnPosition(o,t),f.stop()},e=function(){pt._wD(f.id+': Playing "from" '+n),null===o||isNaN(o)||f.onPosition(o,t)},null===n||isNaN(n)||(i.position=n,i.multiShot=!1,e()),i},a=function(){var e,t=f._iO.onposition;if(t)for(e in t)t.hasOwnProperty(e)&&f.onPosition(parseInt(e,10),t[e])},l=function(){var e,t=f._iO.onposition;if(t)for(e in t)t.hasOwnProperty(e)&&f.clearOnPosition(parseInt(e,10))},r=function(){f.isHTML5&&G(f)},s=function(){f.isHTML5&&Y(f)},i=function(e){e||(v=[],b=0),g=!1,f._hasTimer=null,f._a=null,f._html5_canplay=!1,f.bytesLoaded=null,f.bytesTotal=null,f.duration=f._iO&&f._iO.duration?f._iO.duration:null,f.durationEstimate=null,f.buffered=[],f.eqData=[],f.eqData.left=[],f.eqData.right=[],f.failures=0,f.isBuffering=!1,f.instanceOptions={},f.instanceCount=0,f.loaded=!1,f.metadata={},f.readyState=0,f.muted=!1,f.paused=!1,f.peakData={left:0,right:0},f.waveformData={left:[],right:[]},f.playState=0,f.position=null,f.id3={}},i(),this._onTimer=function(e){var t,i,n=!1,o={};return f._hasTimer||e?(f._a&&(e||(f.playState>0||1===f.readyState)&&!f.paused)&&(t=f._get_html5_duration(),t!==d.duration&&(d.duration=t,f.duration=t,n=!0),f.durationEstimate=f.duration,i=1e3*f._a.currentTime||0,i!==d.time&&(d.time=i,n=!0),(n||e)&&f._whileplaying(i,o,o,o,o)),n):void 0},this._get_html5_duration=function(){var e=f._iO,t=f._a&&f._a.duration?1e3*f._a.duration:e&&e.duration?e.duration:null,i=t&&!isNaN(t)&&1/0!==t?t:null;return i},this._apply_loop=function(e,t){!e.loop&&t>1&&pt._wD("Note: Native HTML5 looping is infinite.",1),e.loop=t>1?"loop":""},this._setup_html5=function(e){var t,o=m(f._iO,e),s=decodeURI,r=zt?ft:f._a,a=s(o.url);if(zt?a===rt&&(t=!0):a===w&&(t=!0),r){if(r._s)if(zt)r._s&&r._s.playState&&!t&&r._s.stop();else if(!zt&&a===s(w))return f._apply_loop(r,o.loops),r;t||(i(!1),r.src=o.url,f.url=o.url,w=o.url,rt=o.url,r._called_load=!1)}else f._a=o.autoLoad||o.autoPlay?new Audio(o.url):Wt&&opera.version()<10?new Audio(null):new Audio,r=f._a,r._called_load=!1,zt&&(ft=r);return f.isHTML5=!0,f._a=r,r._s=f,n(),f._apply_loop(r,o.loops),o.autoLoad||o.autoPlay?f.load():(r.autobuffer=!1,r.preload="auto"),r},n=function(){function e(e,t,i){return f._a?f._a.addEventListener(e,t,i||!1):null}if(f._a._added_events)return!1;var t;f._a._added_events=!0;for(t in dt)dt.hasOwnProperty(t)&&e(t,dt[t]);return!0},o=function(){function e(e,t,i){return f._a?f._a.removeEventListener(e,t,i||!1):null}var t;pt._wD(f.id+": Removing event listeners"),f._a._added_events=!1;for(t in dt)dt.hasOwnProperty(t)&&e(t,dt[t])},this._onload=function(e){var t,i=!!e||!f.isHTML5&&8===h&&f.duration;return t=f.id+": ",pt._wD(t+(i?"onload()":"Failed to load? - "+f.url),i?1:2),i||f.isHTML5||(pt.sandbox.noRemote===!0&&pt._wD(t+B("noNet"),1),pt.sandbox.noLocal===!0&&pt._wD(t+B("noLocal"),1)),f.loaded=i,f.readyState=i?3:2,f._onbufferchange(0),f._iO.onload&&f._iO.onload.apply(f,[i]),!0},this._onbufferchange=function(e){return 0===f.playState?!1:e&&f.isBuffering||!e&&!f.isBuffering?!1:(f.isBuffering=1===e,f._iO.onbufferchange&&(pt._wD(f.id+": Buffer state change: "+e),f._iO.onbufferchange.apply(f)),!0)},this._onsuspend=function(){return f._iO.onsuspend&&(pt._wD(f.id+": Playback suspended"),f._iO.onsuspend.apply(f)),!0},this._onfailure=function(e,t,i){f.failures++,pt._wD(f.id+": Failures = "+f.failures),f._iO.onfailure&&1===f.failures?f._iO.onfailure(f,e,t,i):pt._wD(f.id+": Ignoring failure")},this._onfinish=function(){var e=f._iO.onfinish;f._onbufferchange(0),f._resetOnPosition(0),f.instanceCount&&(f.instanceCount--,f.instanceCount||(l(),f.playState=0,f.paused=!1,f.instanceCount=0,f.instanceOptions={},f._iO={},s(),f.isHTML5&&(f.position=0)),(!f.instanceCount||f._iO.multiShotEvents)&&e&&(pt._wD(f.id+": onfinish()"),e.apply(f)))},this._whileloading=function(e,t,i,n){var o=f._iO;f.bytesLoaded=e,f.bytesTotal=t,f.duration=Math.floor(i),f.bufferLength=n,f.durationEstimate=f.isHTML5||o.isMovieStar?f.duration:o.duration?f.duration>o.duration?f.duration:o.duration:parseInt(f.bytesTotal/f.bytesLoaded*f.duration,10),f.isHTML5||(f.buffered=[{start:0,end:f.duration}]),(3!==f.readyState||f.isHTML5)&&o.whileloading&&o.whileloading.apply(f)},this._whileplaying=function(e,i,n,o,s){var r,a=f._iO;return isNaN(e)||null===e?!1:(f.position=Math.max(0,e),f._processOnPosition(),!f.isHTML5&&h>8&&(a.usePeakData&&i!==t&&i&&(f.peakData={left:i.leftPeak,right:i.rightPeak}),a.useWaveformData&&n!==t&&n&&(f.waveformData={left:n.split(","),right:o.split(",")}),a.useEQData&&s!==t&&s&&s.leftEQ&&(r=s.leftEQ.split(","),f.eqData=r,f.eqData.left=r,s.rightEQ!==t&&s.rightEQ&&(f.eqData.right=s.rightEQ.split(",")))),1===f.playState&&(f.isHTML5||8!==h||f.position||!f.isBuffering||f._onbufferchange(0),a.whileplaying&&a.whileplaying.apply(f)),!0)},this._oncaptiondata=function(e){pt._wD(f.id+": Caption data received."),f.captiondata=e,f._iO.oncaptiondata&&f._iO.oncaptiondata.apply(f,[e])},this._onmetadata=function(e,t){pt._wD(f.id+": Metadata received.");var i,n,o={};for(i=0,n=e.length;n>i;i++)o[e[i]]=t[i];f.metadata=o,f._iO.onmetadata&&f._iO.onmetadata.apply(f)},this._onid3=function(e,t){pt._wD(f.id+": ID3 data received.");var i,n,o=[];for(i=0,n=e.length;n>i;i++)o[e[i]]=t[i];f.id3=m(f.id3,o),f._iO.onid3&&f._iO.onid3.apply(f)},this._onconnect=function(e){e=1===e,pt._wD(f.id+": "+(e?"Connected.":"Failed to connect? - "+f.url),e?1:2),f.connected=e,e&&(f.failures=0,W(f.id)&&(f.getAutoPlay()?f.play(t,f.getAutoPlay()):f._iO.autoLoad&&f.load()),f._iO.onconnect&&f._iO.onconnect.apply(f,[e]))},this._ondataerror=function(e){f.playState>0&&(pt._wD(f.id+": Data error: "+e),f._iO.ondataerror&&f._iO.ondataerror.apply(f))},this._debug()},A=function(){return _t.body||_t._docElement||_t.getElementsByTagName("div")[0]},a=function(e){return _t.getElementById(e)},m=function(e,i){var n,o,s=e||{};n=i===t?pt.defaultOptions:i;for(o in n)n.hasOwnProperty(o)&&s[o]===t&&(s[o]="object"!=typeof n[o]||null===n[o]?n[o]:m(s[o],n[o]));return s},v={onready:1,ontimeout:1,defaultOptions:1,flash9Options:1,movieStarOptions:1},g=function(e,i){var n,o=!0,s=i!==t,r=pt.setupOptions,a=v;if(e===t){o=[];for(n in r)r.hasOwnProperty(n)&&o.push(n);for(n in a)a.hasOwnProperty(n)&&("object"==typeof pt[n]?o.push(n+": {...}"):pt[n]instanceof Function?o.push(n+": function() {...}"):o.push(n));return pt._wD(B("setup",o.join(", "))),!1}for(n in e)if(e.hasOwnProperty(n))if("object"!=typeof e[n]||null===e[n]||e[n]instanceof Array||e[n]instanceof RegExp)s&&a[i]!==t?pt[i][n]=e[n]:r[n]!==t?(pt.setupOptions[n]=e[n],pt[n]=e[n]):a[n]===t?(H(B(pt[n]===t?"setupUndef":"setupError",n),2),o=!1):pt[n]instanceof Function?pt[n].apply(pt,e[n]instanceof Array?e[n]:[e[n]]):pt[n]=e[n];else{if(a[n]!==t)return g(e[n],n);H(B(pt[n]===t?"setupUndef":"setupError",n),2),o=!1}return o},st=function(){function t(e){var t=Nt.call(e),i=t.length;return s?(t[1]="on"+t[1],i>3&&t.pop()):3===i&&t.push(!1),t}function i(e,t){var i=e.shift(),n=[r[t]];s?i[n](e[0],e[1]):i[n].apply(i,e)}function n(){i(t(arguments),"add")}function o(){i(t(arguments),"remove")}var s=e.attachEvent,r={add:s?"attachEvent":"addEventListener",remove:s?"detachEvent":"removeEventListener"};return{add:n,remove:o}}(),dt={abort:s(function(){pt._wD(this._s.id+": abort")}),canplay:s(function(){var e,i=this._s;if(i._html5_canplay)return!0;if(i._html5_canplay=!0,pt._wD(i.id+": canplay"),i._onbufferchange(0),e=i._iO.position===t||isNaN(i._iO.position)?null:i._iO.position/1e3,i.position&&this.currentTime!==e){pt._wD(i.id+": canplay: Setting position to "+e);try{this.currentTime=e}catch(n){pt._wD(i.id+": canplay: Setting position of "+e+" failed: "+n.message,2)}}i._iO._oncanplay&&i._iO._oncanplay()}),canplaythrough:s(function(){var e=this._s;e.loaded||(e._onbufferchange(0),e._whileloading(e.bytesLoaded,e.bytesTotal,e._get_html5_duration()),e._onload(!0))}),ended:s(function(){var e=this._s;pt._wD(e.id+": ended"),e._onfinish()}),error:s(function(){pt._wD(this._s.id+": HTML5 error, code "+this.error.code),this._s._onload(!1)}),loadeddata:s(function(){var e=this._s;pt._wD(e.id+": loadeddata"),e._loaded||Ht||(e.duration=e._get_html5_duration())}),loadedmetadata:s(function(){pt._wD(this._s.id+": loadedmetadata")}),loadstart:s(function(){pt._wD(this._s.id+": loadstart"),this._s._onbufferchange(1)}),play:s(function(){pt._wD(this._s.id+": play()"),this._s._onbufferchange(0)}),playing:s(function(){pt._wD(this._s.id+": playing"),this._s._onbufferchange(0)}),progress:s(function(e){var t,i,n,o=this._s,s=0,r="progress"===e.type,a=e.target.buffered,l=e.loaded||0,u=e.total||1,d=1e3;if(o.buffered=[],a&&a.length){for(t=0,i=a.length;i>t;t++)o.buffered.push({start:a.start(t)*d,end:a.end(t)*d});if(s=(a.end(0)-a.start(0))*d,l=s/(e.target.duration*d),r&&a.length>1){for(n=[],i=a.length,t=0;i>t;t++)n.push(e.target.buffered.start(t)*d+"-"+e.target.buffered.end(t)*d);pt._wD(this._s.id+": progress, timeRanges: "+n.join(", "))}r&&!isNaN(l)&&pt._wD(this._s.id+": progress, "+Math.floor(100*l)+"% loaded")}isNaN(l)||(o._onbufferchange(0),o._whileloading(l,u,o._get_html5_duration()),l&&u&&l===u&&dt.canplaythrough.call(this,e))}),ratechange:s(function(){pt._wD(this._s.id+": ratechange")}),suspend:s(function(e){var t=this._s;pt._wD(this._s.id+": suspend"),dt.progress.call(this,e),t._onsuspend()}),stalled:s(function(){pt._wD(this._s.id+": stalled")}),timeupdate:s(function(){this._s._onTimer()}),waiting:s(function(){var e=this._s;pt._wD(this._s.id+": waiting"),e._onbufferchange(1)})},Z=function(e){var t;return t=e.serverURL||e.type&&o(e.type)?!1:e.type?et({type:e.type}):et({url:e.url})||pt.html5Only},it=function(e,t){e&&(e.src=t,e._called_load=!1),zt&&(rt=null)},et=function(e){if(!pt.useHTML5Audio||!pt.hasHTML5)return!1;var i,n,s,r,a=e.url||null,l=e.type||null,u=pt.audioFormats;if(l&&pt.html5[l]!==t)return pt.html5[l]&&!o(l);if(!tt){tt=[];for(r in u)u.hasOwnProperty(r)&&(tt.push(r),u[r].related&&(tt=tt.concat(u[r].related)));tt=new RegExp("\\.("+tt.join("|")+")(\\?.*)?$","i")}return s=a?a.toLowerCase().match(tt):null,s&&s.length?s=s[1]:l?(n=l.indexOf(";"),s=(-1!==n?l.substr(0,n):l).substr(6)):i=!1,s&&pt.html5[s]!==t?i=pt.html5[s]&&!o(s):(l="audio/"+s,i=pt.html5.canPlayType({type:l}),pt.html5[s]=i,i=i&&pt.html5[l]&&!o(l)),i},ot=function(){function e(e){var t,i,n,o=!1,s=!1;if(!r||"function"!=typeof r.canPlayType)return o;if(e instanceof Array){for(i=0,n=e.length;n>i;i++)(pt.html5[e[i]]||r.canPlayType(e[i]).match(pt.html5Test))&&(s=!0,pt.html5[e[i]]=!0,pt.flash[e[i]]=!!e[i].match(ei));o=s}else t=r&&"function"==typeof r.canPlayType?r.canPlayType(e):!1,o=!(!t||!t.match(pt.html5Test));return o}if(!pt.useHTML5Audio||!pt.hasHTML5)return!1;var i,n,o,s,r=Audio!==t?Wt&&opera.version()<10?new Audio(null):new Audio:null,a={};o=pt.audioFormats;
for(i in o)if(o.hasOwnProperty(i)&&(n="audio/"+i,a[i]=e(o[i].type),a[n]=a[i],i.match(ei)?(pt.flash[i]=!0,pt.flash[n]=!0):(pt.flash[i]=!1,pt.flash[n]=!1),o[i]&&o[i].related))for(s=o[i].related.length-1;s>=0;s--)a["audio/"+o[i].related[s]]=a[i],pt.html5[o[i].related[s]]=a[i],pt.flash[o[i].related[s]]=a[i];return a.canPlayType=r?e:null,pt.html5=m(pt.html5,a),!0},C={notReady:"Unavailable - wait until onready() has fired.",notOK:"Audio support is not available.",domError:gt+"exception caught while appending SWF to DOM.",spcWmode:"Removing wmode, preventing known SWF loading issue(s)",swf404:vt+"Verify that %s is a valid path.",tryDebug:"Try "+gt+".debugFlash = true for more security details (output goes to SWF.)",checkSWF:"See SWF output for more debug info.",localFail:vt+"Non-HTTP page ("+_t.location.protocol+" URL?) Review Flash player security settings for this special case:\nhttp://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html\nMay need to add/allow path, eg. c:/sm2/ or /users/me/sm2/",waitFocus:vt+"Special case: Waiting for SWF to load with window focus...",waitForever:vt+"Waiting indefinitely for Flash (will recover if unblocked)...",waitSWF:vt+"Waiting for 100% SWF load...",needFunction:vt+"Function object expected for %s",badID:'Warning: Sound ID "%s" should be a string, starting with a non-numeric character',currentObj:vt+"_debug(): Current sound objects",waitOnload:vt+"Waiting for window.onload()",docLoaded:vt+"Document already loaded",onload:vt+"initComplete(): calling soundManager.onload()",onloadOK:gt+".onload() complete",didInit:vt+"init(): Already called?",secNote:"Flash security note: Network/internet URLs will not load due to security restrictions. Access can be configured via Flash Player Global Security Settings Page: http://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html",badRemove:vt+"Failed to remove Flash node.",shutdown:gt+".disable(): Shutting down",queue:vt+"Queueing %s handler",smError:"SMSound.load(): Exception: JS-Flash communication failed, or JS error.",fbTimeout:"No flash response, applying ."+V.swfTimedout+" CSS...",fbLoaded:"Flash loaded",flRemoved:vt+"Flash movie removed.",fbHandler:vt+"flashBlockHandler()",manURL:"SMSound.load(): Using manually-assigned URL",onURL:gt+".load(): current URL already assigned.",badFV:gt+'.flashVersion must be 8 or 9. "%s" is invalid. Reverting to %s.',as2loop:"Note: Setting stream:false so looping can work (flash 8 limitation)",noNSLoop:"Note: Looping not implemented for MovieStar formats",needfl9:"Note: Switching to flash 9, required for MP4 formats.",mfTimeout:"Setting flashLoadTimeout = 0 (infinite) for off-screen, mobile flash case",needFlash:vt+"Fatal error: Flash is needed to play some required formats, but is not available.",gotFocus:vt+"Got window focus.",policy:"Enabling usePolicyFile for data access",setup:gt+".setup(): allowed parameters: %s",setupError:gt+'.setup(): "%s" cannot be assigned with this method.',setupUndef:gt+'.setup(): Could not find option "%s"',setupLate:gt+".setup(): url, flashVersion and html5Test property changes will not take effect until reboot().",noURL:vt+"Flash URL required. Call soundManager.setup({url:...}) to get started.",sm2Loaded:"SoundManager 2: Ready.",reset:gt+".reset(): Removing event callbacks",mobileUA:"Mobile UA detected, preferring HTML5 by default.",globalHTML5:"Using singleton HTML5 Audio() pattern for this device."},B=function(){var e,t,i=Nt.call(arguments),n=i.shift(),o=C&&C[n]?C[n]:"";if(o&&i&&i.length)for(e=0,t=i.length;t>e;e++)o=o.replace("%s",i[e]);return o},U=function(e){return 8===h&&e.loops>1&&e.stream&&(p("as2loop"),e.stream=!1),e},X=function(e,t){return e&&!e.usePolicyFile&&(e.onid3||e.usePeakData||e.useWaveformData||e.useEQData)&&(pt._wD((t||"")+B("policy")),e.usePolicyFile=!0),e},H=function(e){console!==t&&console.warn!==t?console.warn(e):pt._wD(e)},l=function(){return!1},O=function(e){var t;for(t in e)e.hasOwnProperty(t)&&"function"==typeof e[t]&&(e[t]=l);t=null},j=function(e){e===t&&(e=!1),(It||e)&&pt.disable(e)},F=function(e){var t,i=null;if(e)if(e.match(/\.swf(\?.*)?$/i)){if(i=e.substr(e.toLowerCase().lastIndexOf(".swf?")+4))return e}else e.lastIndexOf("/")!==e.length-1&&(e+="/");return t=(e&&-1!==e.lastIndexOf("/")?e.substr(0,e.lastIndexOf("/")+1):"./")+pt.movieURL,pt.noSWFCache&&(t+="?ts="+(new Date).getTime()),t},S=function(){h=parseInt(pt.flashVersion,10),8!==h&&9!==h&&(pt._wD(B("badFV",h,At)),pt.flashVersion=h=At);var e=pt.debugMode||pt.debugFlash?"_debug.swf":".swf";pt.useHTML5Audio&&!pt.html5Only&&pt.audioFormats.mp4.required&&9>h&&(pt._wD(B("needfl9")),pt.flashVersion=h=9),pt.version=pt.versionNumber+(pt.html5Only?" (HTML5-only mode)":9===h?" (AS3/Flash 9)":" (AS2/Flash 8)"),h>8?(pt.defaultOptions=m(pt.defaultOptions,pt.flash9Options),pt.features.buffering=!0,pt.defaultOptions=m(pt.defaultOptions,pt.movieStarOptions),pt.filePatterns.flash9=new RegExp("\\.(mp3|"+si.join("|")+")(\\?.*)?$","i"),pt.features.movieStar=!0):pt.features.movieStar=!1,pt.filePattern=pt.filePatterns[8!==h?"flash9":"flash8"],pt.movieURL=(8===h?"soundmanager2.swf":"soundmanager2_flash9.swf").replace(".swf",e),pt.features.peakData=pt.features.waveformData=pt.features.eqData=h>8},R=function(e,t){return mt?(mt._setPolling(e,t),void 0):!1},L=function(){if(pt.debugURLParam.test(yt)&&(pt.debugMode=!0),a(pt.debugID))return!1;var e,t,i,n,o;if(!(!pt.debugMode||a(pt.debugID)||Qt&&pt.useConsole&&pt.consoleOnly)){e=_t.createElement("div"),e.id=pt.debugID+"-toggle",n={position:"fixed",bottom:"0px",right:"0px",width:"1.2em",height:"1.2em",lineHeight:"1.2em",margin:"2px",textAlign:"center",border:"1px solid #999",cursor:"pointer",background:"#fff",color:"#333",zIndex:10001},e.appendChild(_t.createTextNode("-")),e.onclick=q,e.title="Toggle SM2 debug console",wt.match(/msie 6/i)&&(e.style.position="absolute",e.style.cursor="hand");for(o in n)n.hasOwnProperty(o)&&(e.style[o]=n[o]);if(t=_t.createElement("div"),t.id=pt.debugID,t.style.display=pt.debugMode?"block":"none",pt.debugMode&&!a(e.id)){try{i=A(),i.appendChild(e)}catch(s){throw new Error(B("domError")+" \n"+s.toString())}i.appendChild(t)}}i=null},W=this.getSoundById,p=function(e,t){return e?pt._wD(B(e),t):""},q=function(){var e=a(pt.debugID),t=a(pt.debugID+"-toggle");return e?(St?(t.innerHTML="+",e.style.display="none"):(t.innerHTML="-",e.style.display="block"),St=!St,void 0):!1},c=function(i,n,o){if(e.sm2Debugger!==t)try{sm2Debugger.handleEvent(i,n,o)}catch(s){}return!0},z=function(){var e=[];return pt.debugMode&&e.push(V.sm2Debug),pt.debugFlash&&e.push(V.flashDebug),pt.useHighPerformance&&e.push(V.highPerf),e.join(" ")},N=function(){var e=B("fbHandler"),t=pt.getMoviePercent(),i=V,n={type:"FLASHBLOCK"};return pt.html5Only?!1:(pt.ok()?(pt.didFlashBlock&&pt._wD(e+": Unblocked"),pt.oMC&&(pt.oMC.className=[z(),i.swfDefault,i.swfLoaded+(pt.didFlashBlock?" "+i.swfUnblocked:"")].join(" "))):(Bt&&(pt.oMC.className=z()+" "+i.swfDefault+" "+(null===t?i.swfTimedout:i.swfError),pt._wD(e+": "+B("fbTimeout")+(t?" ("+B("fbLoaded")+")":""))),pt.didFlashBlock=!0,w({type:"ontimeout",ignoreInit:!0,error:n}),D(n)),void 0)},b=function(e,i,n){xt[e]===t&&(xt[e]=[]),xt[e].push({method:i,scope:n||null,fired:!1})},w=function(e){if(e||(e={type:pt.ok()?"onready":"ontimeout"}),!Tt&&e&&!e.ignoreInit)return!1;if("ontimeout"===e.type&&(pt.ok()||It&&!e.ignoreInit))return!1;var t,i,n={success:e&&e.ignoreInit?pt.ok():!It},o=e&&e.type?xt[e.type]||[]:[],s=[],r=[n],a=Bt&&!pt.ok();for(e.error&&(r[0].error=e.error),t=0,i=o.length;i>t;t++)o[t].fired!==!0&&s.push(o[t]);if(s.length)for(t=0,i=s.length;i>t;t++)s[t].scope?s[t].method.apply(s[t].scope,r):s[t].method.apply(this,r),a||(s[t].fired=!0);return!0},y=function(){e.setTimeout(function(){pt.useFlashBlock&&N(),w(),"function"==typeof pt.onload&&(p("onload",1),pt.onload.apply(e),p("onloadOK",1)),pt.waitForWindowLoad&&st.add(e,"load",y)},1)},lt=function(){if(at!==t)return at;var i,n,o,s=!1,r=navigator,a=r.plugins,l=e.ActiveXObject;if(a&&a.length)n="application/x-shockwave-flash",o=r.mimeTypes,o&&o[n]&&o[n].enabledPlugin&&o[n].enabledPlugin.description&&(s=!0);else if(l!==t&&!wt.match(/MSAppHost/i)){try{i=new l("ShockwaveFlash.ShockwaveFlash")}catch(u){}s=!!i,i=null}return at=s,s},J=function(){var e,t,i=!0,n=pt.audioFormats,o=Vt&&!!wt.match(/os (1|2|3_0|3_1)/i);if(o?(pt.hasHTML5=!1,pt.html5Only=!0,pt.oMC&&(pt.oMC.style.display="none"),i=!1):pt.useHTML5Audio&&(pt.html5&&pt.html5.canPlayType||(pt._wD("SoundManager: No HTML5 Audio() support detected."),pt.hasHTML5=!1),Yt&&pt._wD(vt+"Note: Buggy HTML5 Audio in Safari on this OS X release, see https://bugs.webkit.org/show_bug.cgi?id=32159 - "+(at?"will use flash fallback for MP3/MP4, if available":" would use flash fallback for MP3/MP4, but none detected."),1)),pt.useHTML5Audio&&pt.hasHTML5)for(t in n)n.hasOwnProperty(t)&&(n[t].required&&!pt.html5.canPlayType(n[t].type)||pt.preferFlash&&(pt.flash[t]||pt.flash[n[t].type]))&&(e=!0);return pt.ignoreFlash&&(e=!1),pt.html5Only=pt.hasHTML5&&pt.useHTML5Audio&&!e,!pt.html5Only},K=function(e){var t,i,n,o=0;if(e instanceof Array){for(t=0,i=e.length;i>t;t++)if(e[t]instanceof Object){if(pt.canPlayMIME(e[t].type)){o=t;break}}else if(pt.canPlayURL(e[t])){o=t;break}e[o].url&&(e[o]=e[o].url),n=e[o]}else n=e;return n},G=function(t){t._hasTimer||(t._hasTimer=!0,!Gt&&pt.html5PollingInterval&&(null===jt&&0===Ot&&(jt=e.setInterval(Q,pt.html5PollingInterval)),Ot++))},Y=function(e){e._hasTimer&&(e._hasTimer=!1,!Gt&&pt.html5PollingInterval&&Ot--)},Q=function(){var t;if(null!==jt&&!Ot)return e.clearInterval(jt),jt=null,!1;for(t=pt.soundIDs.length-1;t>=0;t--)pt.sounds[pt.soundIDs[t]].isHTML5&&pt.sounds[pt.soundIDs[t]]._hasTimer&&pt.sounds[pt.soundIDs[t]]._onTimer()},D=function(i){i=i!==t?i:{},"function"==typeof pt.onerror&&pt.onerror.apply(e,[{type:i.type!==t?i.type:null}]),i.fatal!==t&&i.fatal&&pt.disable()},ut=function(){if(!Yt||!lt())return!1;var e,t,i=pt.audioFormats;for(t in i)if(i.hasOwnProperty(t)&&("mp3"===t||"mp4"===t)&&(pt._wD(gt+": Using flash fallback for "+t+" format"),pt.html5[t]=!1,i[t]&&i[t].related))for(e=i[t].related.length-1;e>=0;e--)pt.html5[i[t].related[e]]=!1},this._setSandboxType=function(e){var i=pt.sandbox;i.type=e,i.description=i.types[i.types[e]!==t?e:"unknown"],"localWithFile"===i.type?(i.noRemote=!0,i.noLocal=!1,p("secNote",2)):"localWithNetwork"===i.type?(i.noRemote=!1,i.noLocal=!0):"localTrusted"===i.type&&(i.noRemote=!1,i.noLocal=!1)},this._externalInterfaceOK=function(e,t){if(pt.swfLoaded)return!1;var i;return c("swf",!0),c("flashtojs",!0),pt.swfLoaded=!0,Jt=!1,Yt&&ut(),t&&t.replace(/\+dev/i,"")===pt.versionNumber.replace(/\+dev/i,"")?(setTimeout(d,Ut?100:1),void 0):(i=gt+': Fatal: JavaScript file build "'+pt.versionNumber+'" does not match Flash SWF build "'+t+'" at '+pt.url+". Ensure both are up-to-date.",setTimeout(function(){throw new Error(i)},0),!1)},E=function(e,i){function n(){var e,t=[],i=[],n=" + ";e="SoundManager "+pt.version+(!pt.html5Only&&pt.useHTML5Audio?pt.hasHTML5?" + HTML5 audio":", no HTML5 audio support":""),pt.html5Only?pt.html5PollingInterval&&t.push("html5PollingInterval ("+pt.html5PollingInterval+"ms)"):(pt.preferFlash&&t.push("preferFlash"),pt.useHighPerformance&&t.push("useHighPerformance"),pt.flashPollingInterval&&t.push("flashPollingInterval ("+pt.flashPollingInterval+"ms)"),pt.html5PollingInterval&&t.push("html5PollingInterval ("+pt.html5PollingInterval+"ms)"),pt.wmode&&t.push("wmode ("+pt.wmode+")"),pt.debugFlash&&t.push("debugFlash"),pt.useFlashBlock&&t.push("flashBlock")),t.length&&(i=i.concat([t.join(n)])),pt._wD(e+(i.length?n+i.join(", "):""),1),ht()}function o(e,t){return'<param name="'+e+'" value="'+t+'" />'}if(kt&&Ct)return!1;if(pt.html5Only)return S(),n(),pt.oMC=a(pt.movieID),d(),kt=!0,Ct=!0,!1;var s,r,l,u,h,c,p,f,m=i||pt.url,g=pt.altURL||m,v="JS/Flash audio component (SoundManager 2)",b=A(),w=z(),y=null,_=_t.getElementsByTagName("html")[0];if(y=_&&_.dir&&_.dir.match(/rtl/i),e=e===t?pt.id:e,S(),pt.url=F(ii?m:g),i=pt.url,pt.wmode=!pt.wmode&&pt.useHighPerformance?"transparent":pt.wmode,null!==pt.wmode&&(wt.match(/msie 8/i)||!Ut&&!pt.useHighPerformance)&&navigator.platform.match(/win32|win64/i)&&(Ft.push(C.spcWmode),pt.wmode=null),s={name:e,id:e,src:i,quality:"high",allowScriptAccess:pt.allowScriptAccess,bgcolor:pt.bgColor,pluginspage:ni+"www.macromedia.com/go/getflashplayer",title:v,type:"application/x-shockwave-flash",wmode:pt.wmode,hasPriority:"true"},pt.debugFlash&&(s.FlashVars="debug=1"),pt.wmode||delete s.wmode,Ut)r=_t.createElement("div"),u=['<object id="'+e+'" data="'+i+'" type="'+s.type+'" title="'+s.title+'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="'+ni+'download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0">',o("movie",i),o("AllowScriptAccess",pt.allowScriptAccess),o("quality",s.quality),pt.wmode?o("wmode",pt.wmode):"",o("bgcolor",pt.bgColor),o("hasPriority","true"),pt.debugFlash?o("FlashVars",s.FlashVars):"","</object>"].join("");else{r=_t.createElement("embed");for(l in s)s.hasOwnProperty(l)&&r.setAttribute(l,s[l])}if(L(),w=z(),b=A())if(pt.oMC=a(pt.movieID)||_t.createElement("div"),pt.oMC.id)f=pt.oMC.className,pt.oMC.className=(f?f+" ":V.swfDefault)+(w?" "+w:""),pt.oMC.appendChild(r),Ut&&(h=pt.oMC.appendChild(_t.createElement("div")),h.className=V.swfBox,h.innerHTML=u),Ct=!0;else{if(pt.oMC.id=pt.movieID,pt.oMC.className=V.swfDefault+" "+w,c=null,h=null,pt.useFlashBlock||(pt.useHighPerformance?c={position:"fixed",width:"8px",height:"8px",bottom:"0px",left:"0px",overflow:"hidden"}:(c={position:"absolute",width:"6px",height:"6px",top:"-9999px",left:"-9999px"},y&&(c.left=Math.abs(parseInt(c.left,10))+"px"))),Xt&&(pt.oMC.style.zIndex=1e4),!pt.debugFlash)for(p in c)c.hasOwnProperty(p)&&(pt.oMC.style[p]=c[p]);try{Ut||pt.oMC.appendChild(r),b.appendChild(pt.oMC),Ut&&(h=pt.oMC.appendChild(_t.createElement("div")),h.className=V.swfBox,h.innerHTML=u),Ct=!0}catch(x){throw new Error(B("domError")+" \n"+x.toString())}}return kt=!0,n(),!0},T=function(){return pt.html5Only?(E(),!1):mt?!1:pt.url?(mt=pt.getMovie(pt.id),mt||(Et?(Ut?pt.oMC.innerHTML=Dt:pt.oMC.appendChild(Et),Et=null,kt=!0):E(pt.id,pt.url),mt=pt.getMovie(pt.id)),"function"==typeof pt.oninitmovie&&setTimeout(pt.oninitmovie,1),ct(),!0):(p("noURL"),!1)},_=function(){setTimeout(x,1e3)},x=function(){var t,i=!1;return pt.url?Rt?!1:(Rt=!0,st.remove(e,"load",_),Jt&&!Kt?(p("waitFocus"),!1):(Tt||(t=pt.getMoviePercent(),t>0&&100>t&&(i=!0)),setTimeout(function(){return t=pt.getMoviePercent(),i?(Rt=!1,pt._wD(B("waitSWF")),e.setTimeout(_,1),!1):(Tt||(pt._wD(gt+": No Flash response within expected time. Likely causes: "+(0===t?"SWF load failed, ":"")+"Flash blocked or JS-Flash security error."+(pt.debugFlash?" "+B("checkSWF"):""),2),!ii&&t&&(p("localFail",2),pt.debugFlash||p("tryDebug",2)),0===t&&pt._wD(B("swf404",pt.url),1),c("flashtojs",!1," (Check flash security or flash blockers)")),!Tt&&Zt&&(null===t?pt.useFlashBlock||0===pt.flashLoadTimeout?(pt.useFlashBlock&&N(),p("waitForever")):(p("waitForever"),w({type:"ontimeout",ignoreInit:!0})):0===pt.flashLoadTimeout?p("waitForever"):j(!0)),void 0)},pt.flashLoadTimeout),void 0)):!1},k=function(){function t(){st.remove(e,"focus",k)}return Kt||!Jt?(t(),!0):(Zt=!0,Kt=!0,p("gotFocus"),Rt=!1,_(),t(),!0)},ct=function(){Ft.length&&(pt._wD("SoundManager 2: "+Ft.join(" "),1),Ft=[])},ht=function(){ct();var e,t=[];if(pt.useHTML5Audio&&pt.hasHTML5){for(e in pt.audioFormats)pt.audioFormats.hasOwnProperty(e)&&t.push(e+" = "+pt.html5[e]+(!pt.html5[e]&&at&&pt.flash[e]?" (using flash)":pt.preferFlash&&pt.flash[e]&&at?" (preferring flash)":pt.html5[e]?"":" ("+(pt.audioFormats[e].required?"required, ":"")+"and no flash support)"));pt._wD("SoundManager 2 HTML5 support: "+t.join(", "),1)}},f=function(t){if(Tt)return!1;if(pt.html5Only)return p("sm2Loaded"),Tt=!0,y(),c("onload",!0),!0;var i,n=pt.useFlashBlock&&pt.flashLoadTimeout&&!pt.getMoviePercent(),o=!0;return n||(Tt=!0,It&&(i={type:!at&&Bt?"NO_FLASH":"INIT_TIMEOUT"})),pt._wD("SoundManager 2 "+(It?"failed to load":"loaded")+" ("+(It?"Flash security/load error":"OK")+")",It?2:1),It||t?(pt.useFlashBlock&&pt.oMC&&(pt.oMC.className=z()+" "+(null===pt.getMoviePercent()?V.swfTimedout:V.swfError)),w({type:"ontimeout",error:i,ignoreInit:!0}),c("onload",!1),D(i),o=!1):c("onload",!0),It||(pt.waitForWindowLoad&&!Mt?(p("waitOnload"),st.add(e,"load",y)):(pt.waitForWindowLoad&&Mt&&p("docLoaded"),y())),o},u=function(){var e,i=pt.setupOptions;for(e in i)i.hasOwnProperty(e)&&(pt[e]===t?pt[e]=i[e]:pt[e]!==i[e]&&(pt.setupOptions[e]=pt[e]))},d=function(){function t(){st.remove(e,"load",pt.beginDelayedInit)}if(Tt)return p("didInit"),!1;if(pt.html5Only)return Tt||(t(),pt.enabled=!0,f()),!0;T();try{mt._externalInterfaceTest(!1),R(!0,pt.flashPollingInterval||(pt.useHighPerformance?10:50)),pt.debugMode||mt._disableDebug(),pt.enabled=!0,c("jstoflash",!0),pt.html5Only||st.add(e,"unload",l)}catch(i){return pt._wD("js/flash exception: "+i.toString()),c("jstoflash",!1),D({type:"JS_TO_FLASH_EXCEPTION",fatal:!0}),j(!0),f(),!1}return f(),t(),!0},M=function(){return $?!1:($=!0,u(),L(),function(){var i="sm2-usehtml5audio=",n="sm2-preferflash=",o=null,s=null,r=e.console!==t&&"function"==typeof console.log,a=yt.toLowerCase();-1!==a.indexOf(i)&&(o="1"===a.charAt(a.indexOf(i)+i.length),r&&console.log((o?"Enabling ":"Disabling ")+"useHTML5Audio via URL parameter"),pt.setup({useHTML5Audio:o})),-1!==a.indexOf(n)&&(s="1"===a.charAt(a.indexOf(n)+n.length),r&&console.log((s?"Enabling ":"Disabling ")+"preferFlash via URL parameter"),pt.setup({preferFlash:s}))}(),!at&&pt.hasHTML5&&(pt._wD("SoundManager: No Flash detected"+(pt.useHTML5Audio?". Trying HTML5-only mode.":", enabling HTML5."),1),pt.setup({useHTML5Audio:!0,preferFlash:!1})),ot(),pt.html5.usingFlash=J(),Bt=pt.html5.usingFlash,!at&&Bt&&(Ft.push(C.needFlash),pt.setup({flashLoadTimeout:1})),_t.removeEventListener&&_t.removeEventListener("DOMContentLoaded",M,!1),T(),!0)},nt=function(){return"complete"===_t.readyState&&(M(),_t.detachEvent("onreadystatechange",nt)),!0},P=function(){Mt=!0,st.remove(e,"load",P)},I=function(){Gt&&((!pt.setupOptions.useHTML5Audio||pt.setupOptions.preferFlash)&&Ft.push(C.mobileUA),pt.setupOptions.useHTML5Audio=!0,pt.setupOptions.preferFlash=!1,(Vt||qt&&!wt.match(/android\s2\.3/i))&&(Ft.push(C.globalHTML5),Vt&&(pt.ignoreFlash=!0),zt=!0))},I(),lt(),st.add(e,"focus",k),st.add(e,"load",_),st.add(e,"load",P),_t.addEventListener?_t.addEventListener("DOMContentLoaded",M,!1):_t.attachEvent?_t.attachEvent("onreadystatechange",nt):(c("onload",!1),D({type:"NO_DOM2_EVENTS",fatal:!0}))}var n=null;void 0!==e.SM2_DEFER&&SM2_DEFER||(n=new i),e.SoundManager=i,e.soundManager=n}(window),define("soundmanager",function(e){return function(){var t;return t||e.soundManager}}(this)),function(){var e=this,t=e._,i={},n=Array.prototype,o=Object.prototype,s=Function.prototype,r=n.push,a=n.slice,l=n.concat,u=o.toString,d=o.hasOwnProperty,h=n.forEach,c=n.map,p=n.reduce,f=n.reduceRight,m=n.filter,g=n.every,v=n.some,b=n.indexOf,w=n.lastIndexOf,y=Array.isArray,_=Object.keys,x=s.bind,S=function(e){return e instanceof S?e:this instanceof S?(this._wrapped=e,void 0):new S(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=S),exports._=S):e._=S,S.VERSION="1.4.4";var k=S.each=S.forEach=function(e,t,n){if(null!=e)if(h&&e.forEach===h)e.forEach(t,n);else if(e.length===+e.length){for(var o=0,s=e.length;s>o;o++)if(t.call(n,e[o],o,e)===i)return}else for(var r in e)if(S.has(e,r)&&t.call(n,e[r],r,e)===i)return};S.map=S.collect=function(e,t,i){var n=[];return null==e?n:c&&e.map===c?e.map(t,i):(k(e,function(e,o,s){n[n.length]=t.call(i,e,o,s)}),n)};var C="Reduce of empty array with no initial value";S.reduce=S.foldl=S.inject=function(e,t,i,n){var o=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return n&&(t=S.bind(t,n)),o?e.reduce(t,i):e.reduce(t);if(k(e,function(e,s,r){o?i=t.call(n,i,e,s,r):(i=e,o=!0)}),!o)throw new TypeError(C);return i},S.reduceRight=S.foldr=function(e,t,i,n){var o=arguments.length>2;if(null==e&&(e=[]),f&&e.reduceRight===f)return n&&(t=S.bind(t,n)),o?e.reduceRight(t,i):e.reduceRight(t);var s=e.length;if(s!==+s){var r=S.keys(e);s=r.length}if(k(e,function(a,l,u){l=r?r[--s]:--s,o?i=t.call(n,i,e[l],l,u):(i=e[l],o=!0)}),!o)throw new TypeError(C);return i},S.find=S.detect=function(e,t,i){var n;return T(e,function(e,o,s){return t.call(i,e,o,s)?(n=e,!0):void 0}),n},S.filter=S.select=function(e,t,i){var n=[];return null==e?n:m&&e.filter===m?e.filter(t,i):(k(e,function(e,o,s){t.call(i,e,o,s)&&(n[n.length]=e)}),n)},S.reject=function(e,t,i){return S.filter(e,function(e,n,o){return!t.call(i,e,n,o)},i)},S.every=S.all=function(e,t,n){t||(t=S.identity);var o=!0;return null==e?o:g&&e.every===g?e.every(t,n):(k(e,function(e,s,r){return(o=o&&t.call(n,e,s,r))?void 0:i}),!!o)};var T=S.some=S.any=function(e,t,n){t||(t=S.identity);var o=!1;return null==e?o:v&&e.some===v?e.some(t,n):(k(e,function(e,s,r){return o||(o=t.call(n,e,s,r))?i:void 0}),!!o)};S.contains=S.include=function(e,t){return null==e?!1:b&&e.indexOf===b?-1!=e.indexOf(t):T(e,function(e){return e===t})},S.invoke=function(e,t){var i=a.call(arguments,2),n=S.isFunction(t);return S.map(e,function(e){return(n?t:e[t]).apply(e,i)})},S.pluck=function(e,t){return S.map(e,function(e){return e[t]})},S.where=function(e,t,i){return S.isEmpty(t)?i?null:[]:S[i?"find":"filter"](e,function(e){for(var i in t)if(t[i]!==e[i])return!1;return!0})},S.findWhere=function(e,t){return S.where(e,t,!0)},S.max=function(e,t,i){if(!t&&S.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);if(!t&&S.isEmpty(e))return-1/0;var n={computed:-1/0,value:-1/0};return k(e,function(e,o,s){var r=t?t.call(i,e,o,s):e;r>=n.computed&&(n={value:e,computed:r})}),n.value},S.min=function(e,t,i){if(!t&&S.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);if(!t&&S.isEmpty(e))return 1/0;var n={computed:1/0,value:1/0};return k(e,function(e,o,s){var r=t?t.call(i,e,o,s):e;r<n.computed&&(n={value:e,computed:r})}),n.value},S.shuffle=function(e){var t,i=0,n=[];return k(e,function(e){t=S.random(i++),n[i-1]=n[t],n[t]=e}),n};var I=function(e){return S.isFunction(e)?e:function(t){return t[e]}};S.sortBy=function(e,t,i){var n=I(t);return S.pluck(S.map(e,function(e,t,o){return{value:e,index:t,criteria:n.call(i,e,t,o)}}).sort(function(e,t){var i=e.criteria,n=t.criteria;if(i!==n){if(i>n||void 0===i)return 1;if(n>i||void 0===n)return-1}return e.index<t.index?-1:1}),"value")};var M=function(e,t,i,n){var o={},s=I(t||S.identity);return k(e,function(t,r){var a=s.call(i,t,r,e);n(o,a,t)}),o};S.groupBy=function(e,t,i){return M(e,t,i,function(e,t,i){(S.has(e,t)?e[t]:e[t]=[]).push(i)})},S.countBy=function(e,t,i){return M(e,t,i,function(e,t){S.has(e,t)||(e[t]=0),e[t]++})},S.sortedIndex=function(e,t,i,n){i=null==i?S.identity:I(i);for(var o=i.call(n,t),s=0,r=e.length;r>s;){var a=s+r>>>1;i.call(n,e[a])<o?s=a+1:r=a}return s},S.toArray=function(e){return e?S.isArray(e)?a.call(e):e.length===+e.length?S.map(e,S.identity):S.values(e):[]},S.size=function(e){return null==e?0:e.length===+e.length?e.length:S.keys(e).length},S.first=S.head=S.take=function(e,t,i){return null==e?void 0:null==t||i?e[0]:a.call(e,0,t)},S.initial=function(e,t,i){return a.call(e,0,e.length-(null==t||i?1:t))},S.last=function(e,t,i){return null==e?void 0:null==t||i?e[e.length-1]:a.call(e,Math.max(e.length-t,0))},S.rest=S.tail=S.drop=function(e,t,i){return a.call(e,null==t||i?1:t)},S.compact=function(e){return S.filter(e,S.identity)};var P=function(e,t,i){return k(e,function(e){S.isArray(e)?t?r.apply(i,e):P(e,t,i):i.push(e)}),i};S.flatten=function(e,t){return P(e,t,[])},S.without=function(e){return S.difference(e,a.call(arguments,1))},S.uniq=S.unique=function(e,t,i,n){S.isFunction(t)&&(n=i,i=t,t=!1);var o=i?S.map(e,i,n):e,s=[],r=[];return k(o,function(i,n){(t?n&&r[r.length-1]===i:S.contains(r,i))||(r.push(i),s.push(e[n]))}),s},S.union=function(){return S.uniq(l.apply(n,arguments))},S.intersection=function(e){var t=a.call(arguments,1);return S.filter(S.uniq(e),function(e){return S.every(t,function(t){return S.indexOf(t,e)>=0})})},S.difference=function(e){var t=l.apply(n,a.call(arguments,1));return S.filter(e,function(e){return!S.contains(t,e)})},S.zip=function(){for(var e=a.call(arguments),t=S.max(S.pluck(e,"length")),i=new Array(t),n=0;t>n;n++)i[n]=S.pluck(e,""+n);return i},S.object=function(e,t){if(null==e)return{};for(var i={},n=0,o=e.length;o>n;n++)t?i[e[n]]=t[n]:i[e[n][0]]=e[n][1];return i},S.indexOf=function(e,t,i){if(null==e)return-1;var n=0,o=e.length;if(i){if("number"!=typeof i)return n=S.sortedIndex(e,t),e[n]===t?n:-1;n=0>i?Math.max(0,o+i):i}if(b&&e.indexOf===b)return e.indexOf(t,i);for(;o>n;n++)if(e[n]===t)return n;return-1},S.lastIndexOf=function(e,t,i){if(null==e)return-1;var n=null!=i;if(w&&e.lastIndexOf===w)return n?e.lastIndexOf(t,i):e.lastIndexOf(t);for(var o=n?i:e.length;o--;)if(e[o]===t)return o;return-1},S.range=function(e,t,i){arguments.length<=1&&(t=e||0,e=0),i=arguments[2]||1;for(var n=Math.max(Math.ceil((t-e)/i),0),o=0,s=new Array(n);n>o;)s[o++]=e,e+=i;return s},S.bind=function(e,t){if(e.bind===x&&x)return x.apply(e,a.call(arguments,1));var i=a.call(arguments,2);return function(){return e.apply(t,i.concat(a.call(arguments)))}},S.partial=function(e){var t=a.call(arguments,1);return function(){return e.apply(this,t.concat(a.call(arguments)))}},S.bindAll=function(e){var t=a.call(arguments,1);return 0===t.length&&(t=S.functions(e)),k(t,function(t){e[t]=S.bind(e[t],e)}),e},S.memoize=function(e,t){var i={};return t||(t=S.identity),function(){var n=t.apply(this,arguments);return S.has(i,n)?i[n]:i[n]=e.apply(this,arguments)}},S.delay=function(e,t){var i=a.call(arguments,2);return setTimeout(function(){return e.apply(null,i)},t)},S.defer=function(e){return S.delay.apply(S,[e,1].concat(a.call(arguments,1)))},S.throttle=function(e,t){var i,n,o,s,r=0,a=function(){r=new Date,o=null,s=e.apply(i,n)};return function(){var l=new Date,u=t-(l-r);return i=this,n=arguments,0>=u?(clearTimeout(o),o=null,r=l,s=e.apply(i,n)):o||(o=setTimeout(a,u)),s}},S.debounce=function(e,t,i){var n,o;return function(){var s=this,r=arguments,a=function(){n=null,i||(o=e.apply(s,r))},l=i&&!n;return clearTimeout(n),n=setTimeout(a,t),l&&(o=e.apply(s,r)),o}},S.once=function(e){var t,i=!1;return function(){return i?t:(i=!0,t=e.apply(this,arguments),e=null,t)}},S.wrap=function(e,t){return function(){var i=[e];return r.apply(i,arguments),t.apply(this,i)}},S.compose=function(){var e=arguments;return function(){for(var t=arguments,i=e.length-1;i>=0;i--)t=[e[i].apply(this,t)];return t[0]}},S.after=function(e,t){return 0>=e?t():function(){return--e<1?t.apply(this,arguments):void 0}},S.keys=_||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var i in e)S.has(e,i)&&(t[t.length]=i);return t},S.values=function(e){var t=[];for(var i in e)S.has(e,i)&&t.push(e[i]);return t},S.pairs=function(e){var t=[];for(var i in e)S.has(e,i)&&t.push([i,e[i]]);return t},S.invert=function(e){var t={};for(var i in e)S.has(e,i)&&(t[e[i]]=i);return t},S.functions=S.methods=function(e){var t=[];for(var i in e)S.isFunction(e[i])&&t.push(i);return t.sort()},S.extend=function(e){return k(a.call(arguments,1),function(t){if(t)for(var i in t)e[i]=t[i]}),e},S.pick=function(e){var t={},i=l.apply(n,a.call(arguments,1));return k(i,function(i){i in e&&(t[i]=e[i])}),t},S.omit=function(e){var t={},i=l.apply(n,a.call(arguments,1));for(var o in e)S.contains(i,o)||(t[o]=e[o]);return t},S.defaults=function(e){return k(a.call(arguments,1),function(t){if(t)for(var i in t)null==e[i]&&(e[i]=t[i])}),e},S.clone=function(e){return S.isObject(e)?S.isArray(e)?e.slice():S.extend({},e):e},S.tap=function(e,t){return t(e),e};var $=function(e,t,i,n){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof S&&(e=e._wrapped),t instanceof S&&(t=t._wrapped);var o=u.call(e);if(o!=u.call(t))return!1;switch(o){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var s=i.length;s--;)if(i[s]==e)return n[s]==t;i.push(e),n.push(t);var r=0,a=!0;if("[object Array]"==o){if(r=e.length,a=r==t.length)for(;r--&&(a=$(e[r],t[r],i,n)););}else{var l=e.constructor,d=t.constructor;if(l!==d&&!(S.isFunction(l)&&l instanceof l&&S.isFunction(d)&&d instanceof d))return!1;for(var h in e)if(S.has(e,h)&&(r++,!(a=S.has(t,h)&&$(e[h],t[h],i,n))))break;if(a){for(h in t)if(S.has(t,h)&&!r--)break;a=!r}}return i.pop(),n.pop(),a};S.isEqual=function(e,t){return $(e,t,[],[])},S.isEmpty=function(e){if(null==e)return!0;if(S.isArray(e)||S.isString(e))return 0===e.length;for(var t in e)if(S.has(e,t))return!1;return!0},S.isElement=function(e){return!(!e||1!==e.nodeType)},S.isArray=y||function(e){return"[object Array]"==u.call(e)},S.isObject=function(e){return e===Object(e)},k(["Arguments","Function","String","Number","Date","RegExp"],function(e){S["is"+e]=function(t){return u.call(t)=="[object "+e+"]"}}),S.isArguments(arguments)||(S.isArguments=function(e){return!(!e||!S.has(e,"callee"))}),"function"!=typeof/./&&(S.isFunction=function(e){return"function"==typeof e}),S.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},S.isNaN=function(e){return S.isNumber(e)&&e!=+e},S.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==u.call(e)},S.isNull=function(e){return null===e},S.isUndefined=function(e){return void 0===e},S.has=function(e,t){return d.call(e,t)},S.noConflict=function(){return e._=t,this},S.identity=function(e){return e},S.times=function(e,t,i){for(var n=Array(e),o=0;e>o;o++)n[o]=t.call(i,o);return n},S.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var A={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};A.unescape=S.invert(A.escape);var E={escape:new RegExp("["+S.keys(A.escape).join("")+"]","g"),unescape:new RegExp("("+S.keys(A.unescape).join("|")+")","g")};S.each(["escape","unescape"],function(e){S[e]=function(t){return null==t?"":(""+t).replace(E[e],function(t){return A[e][t]})}}),S.result=function(e,t){if(null==e)return null;var i=e[t];return S.isFunction(i)?i.call(e):i},S.mixin=function(e){k(S.functions(e),function(t){var i=S[t]=e[t];S.prototype[t]=function(){var e=[this._wrapped];return r.apply(e,arguments),j.call(this,i.apply(S,e))}})};var D=0;S.uniqueId=function(e){var t=++D+"";return e?e+t:t},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var R=/(.)^/,L={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},O=/\\|'|\r|\n|\t|\u2028|\u2029/g;S.template=function(e,t,i){var n;i=S.defaults({},i,S.templateSettings);var o=new RegExp([(i.escape||R).source,(i.interpolate||R).source,(i.evaluate||R).source].join("|")+"|$","g"),s=0,r="__p+='";e.replace(o,function(t,i,n,o,a){return r+=e.slice(s,a).replace(O,function(e){return"\\"+L[e]}),i&&(r+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"),n&&(r+="'+\n((__t=("+n+"))==null?'':__t)+\n'"),o&&(r+="';\n"+o+"\n__p+='"),s=a+t.length,t}),r+="';\n",i.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+r+"return __p;\n";try{n=new Function(i.variable||"obj","_",r)}catch(a){throw a.source=r,a}if(t)return n(t,S);var l=function(e){return n.call(this,e,S)};return l.source="function("+(i.variable||"obj")+"){\n"+r+"}",l},S.chain=function(e){return S(e).chain()};var j=function(e){return this._chain?S(e).chain():e};S.mixin(S),k(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=n[e];S.prototype[e]=function(){var i=this._wrapped;return t.apply(i,arguments),"shift"!=e&&"splice"!=e||0!==i.length||delete i[0],j.call(this,i)
}}),k(["concat","join","slice"],function(e){var t=n[e];S.prototype[e]=function(){return j.call(this,t.apply(this._wrapped,arguments))}}),S.extend(S.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this),define("underscore",function(e){return function(){var t;return t||e._}}(this)),function(){var e,t=this,i=t.Backbone,n=[],o=n.push,s=n.slice,r=n.splice;e="undefined"!=typeof exports?exports:t.Backbone={},e.VERSION="1.0.0";var a=t._;a||"undefined"==typeof require||(a=require("underscore")),e.$=t.jQuery||t.Zepto||t.ender||t.$,e.noConflict=function(){return t.Backbone=i,this},e.emulateHTTP=!1,e.emulateJSON=!1;var l=e.Events={on:function(e,t,i){if(!d(this,"on",e,[t,i])||!t)return this;this._events||(this._events={});var n=this._events[e]||(this._events[e]=[]);return n.push({callback:t,context:i,ctx:i||this}),this},once:function(e,t,i){if(!d(this,"once",e,[t,i])||!t)return this;var n=this,o=a.once(function(){n.off(e,o),t.apply(this,arguments)});return o._callback=t,this.on(e,o,i)},off:function(e,t,i){var n,o,s,r,l,u,h,c;if(!this._events||!d(this,"off",e,[t,i]))return this;if(!e&&!t&&!i)return this._events={},this;for(r=e?[e]:a.keys(this._events),l=0,u=r.length;u>l;l++)if(e=r[l],s=this._events[e]){if(this._events[e]=n=[],t||i)for(h=0,c=s.length;c>h;h++)o=s[h],(t&&t!==o.callback&&t!==o.callback._callback||i&&i!==o.context)&&n.push(o);n.length||delete this._events[e]}return this},trigger:function(e){if(!this._events)return this;var t=s.call(arguments,1);if(!d(this,"trigger",e,t))return this;var i=this._events[e],n=this._events.all;return i&&h(i,t),n&&h(n,arguments),this},stopListening:function(e,t,i){var n=this._listeners;if(!n)return this;var o=!t&&!i;"object"==typeof t&&(i=this),e&&((n={})[e._listenerId]=e);for(var s in n)n[s].off(t,i,this),o&&delete this._listeners[s];return this}},u=/\s+/,d=function(e,t,i,n){if(!i)return!0;if("object"==typeof i){for(var o in i)e[t].apply(e,[o,i[o]].concat(n));return!1}if(u.test(i)){for(var s=i.split(u),r=0,a=s.length;a>r;r++)e[t].apply(e,[s[r]].concat(n));return!1}return!0},h=function(e,t){var i,n=-1,o=e.length,s=t[0],r=t[1],a=t[2];switch(t.length){case 0:for(;++n<o;)(i=e[n]).callback.call(i.ctx);return;case 1:for(;++n<o;)(i=e[n]).callback.call(i.ctx,s);return;case 2:for(;++n<o;)(i=e[n]).callback.call(i.ctx,s,r);return;case 3:for(;++n<o;)(i=e[n]).callback.call(i.ctx,s,r,a);return;default:for(;++n<o;)(i=e[n]).callback.apply(i.ctx,t)}},c={listenTo:"on",listenToOnce:"once"};a.each(c,function(e,t){l[t]=function(t,i,n){var o=this._listeners||(this._listeners={}),s=t._listenerId||(t._listenerId=a.uniqueId("l"));return o[s]=t,"object"==typeof i&&(n=this),t[e](i,n,this),this}}),l.bind=l.on,l.unbind=l.off,a.extend(e,l);var p=e.Model=function(e,t){var i,n=e||{};t||(t={}),this.cid=a.uniqueId("c"),this.attributes={},a.extend(this,a.pick(t,f)),t.parse&&(n=this.parse(n,t)||{}),(i=a.result(this,"defaults"))&&(n=a.defaults({},n,i)),this.set(n,t),this.changed={},this.initialize.apply(this,arguments)},f=["url","urlRoot","collection"];a.extend(p.prototype,l,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return a.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return a.escape(this.get(e))},has:function(e){return null!=this.get(e)},set:function(e,t,i){var n,o,s,r,l,u,d,h;if(null==e)return this;if("object"==typeof e?(o=e,i=t):(o={})[e]=t,i||(i={}),!this._validate(o,i))return!1;s=i.unset,l=i.silent,r=[],u=this._changing,this._changing=!0,u||(this._previousAttributes=a.clone(this.attributes),this.changed={}),h=this.attributes,d=this._previousAttributes,this.idAttribute in o&&(this.id=o[this.idAttribute]);for(n in o)t=o[n],a.isEqual(h[n],t)||r.push(n),a.isEqual(d[n],t)?delete this.changed[n]:this.changed[n]=t,s?delete h[n]:h[n]=t;if(!l){r.length&&(this._pending=!0);for(var c=0,p=r.length;p>c;c++)this.trigger("change:"+r[c],this,h[r[c]],i)}if(u)return this;if(!l)for(;this._pending;)this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,a.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var i in this.attributes)t[i]=void 0;return this.set(t,a.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!a.isEmpty(this.changed):a.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?a.clone(this.changed):!1;var t,i=!1,n=this._changing?this._previousAttributes:this.attributes;for(var o in e)a.isEqual(n[o],t=e[o])||((i||(i={}))[o]=t);return i},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return a.clone(this._previousAttributes)},fetch:function(e){e=e?a.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=this,i=e.success;return e.success=function(n){return t.set(t.parse(n,e),e)?(i&&i(t,n,e),t.trigger("sync",t,n,e),void 0):!1},j(this,e),this.sync("read",this,e)},save:function(e,t,i){var n,o,s,r=this.attributes;if(null==e||"object"==typeof e?(n=e,i=t):(n={})[e]=t,!(!n||i&&i.wait||this.set(n,i)))return!1;if(i=a.extend({validate:!0},i),!this._validate(n,i))return!1;n&&i.wait&&(this.attributes=a.extend({},r,n)),void 0===i.parse&&(i.parse=!0);var l=this,u=i.success;return i.success=function(e){l.attributes=r;var t=l.parse(e,i);return i.wait&&(t=a.extend(n||{},t)),a.isObject(t)&&!l.set(t,i)?!1:(u&&u(l,e,i),l.trigger("sync",l,e,i),void 0)},j(this,i),o=this.isNew()?"create":i.patch?"patch":"update","patch"===o&&(i.attrs=n),s=this.sync(o,this,i),n&&i.wait&&(this.attributes=r),s},destroy:function(e){e=e?a.clone(e):{};var t=this,i=e.success,n=function(){t.trigger("destroy",t,t.collection,e)};if(e.success=function(o){(e.wait||t.isNew())&&n(),i&&i(t,o,e),t.isNew()||t.trigger("sync",t,o,e)},this.isNew())return e.success(),!1;j(this,e);var o=this.sync("delete",this,e);return e.wait||n(),o},url:function(){var e=a.result(this,"urlRoot")||a.result(this.collection,"url")||O();return this.isNew()?e:e+("/"===e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(e){return this._validate({},a.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=a.extend({},this.attributes,e);var i=this.validationError=this.validate(e,t)||null;return i?(this.trigger("invalid",this,i,a.extend(t||{},{validationError:i})),!1):!0}});var m=["keys","values","pairs","invert","pick","omit"];a.each(m,function(e){p.prototype[e]=function(){var t=s.call(arguments);return t.unshift(this.attributes),a[e].apply(a,t)}});var g=e.Collection=function(e,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,a.extend({silent:!0},t))},v={add:!0,remove:!0,merge:!0},b={add:!0,merge:!1,remove:!1};a.extend(g.prototype,l,{model:p,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return e.sync.apply(this,arguments)},add:function(e,t){return this.set(e,a.defaults(t||{},b))},remove:function(e,t){e=a.isArray(e)?e.slice():[e],t||(t={});var i,n,o,s;for(i=0,n=e.length;n>i;i++)s=this.get(e[i]),s&&(delete this._byId[s.id],delete this._byId[s.cid],o=this.indexOf(s),this.models.splice(o,1),this.length--,t.silent||(t.index=o,s.trigger("remove",s,this,t)),this._removeReference(s));return this},set:function(e,t){t=a.defaults(t||{},v),t.parse&&(e=this.parse(e,t)),a.isArray(e)||(e=e?[e]:[]);var i,n,s,l,u,d=t.at,h=this.comparator&&null==d&&t.sort!==!1,c=a.isString(this.comparator)?this.comparator:null,p=[],f=[],m={};for(i=0,n=e.length;n>i;i++)(s=this._prepareModel(e[i],t))&&((l=this.get(s))?(t.remove&&(m[l.cid]=!0),t.merge&&(l.set(s.attributes,t),h&&!u&&l.hasChanged(c)&&(u=!0))):t.add&&(p.push(s),s.on("all",this._onModelEvent,this),this._byId[s.cid]=s,null!=s.id&&(this._byId[s.id]=s)));if(t.remove){for(i=0,n=this.length;n>i;++i)m[(s=this.models[i]).cid]||f.push(s);f.length&&this.remove(f,t)}if(p.length&&(h&&(u=!0),this.length+=p.length,null!=d?r.apply(this.models,[d,0].concat(p)):o.apply(this.models,p)),u&&this.sort({silent:!0}),t.silent)return this;for(i=0,n=p.length;n>i;i++)(s=p[i]).trigger("add",s,this,t);return u&&this.trigger("sort",this,t),this},reset:function(e,t){t||(t={});for(var i=0,n=this.models.length;n>i;i++)this._removeReference(this.models[i]);return t.previousModels=this.models,this._reset(),this.add(e,a.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,a.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,a.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return null==e?void 0:this._byId[null!=e.id?e.id:e.cid||e]},at:function(e){return this.models[e]},where:function(e,t){return a.isEmpty(e)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var i in e)if(e[i]!==t.get(i))return!1;return!0})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),a.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(a.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},sortedIndex:function(e,t,i){t||(t=this.comparator);var n=a.isFunction(t)?t:function(e){return e.get(t)};return a.sortedIndex(this.models,e,n,i)},pluck:function(e){return a.invoke(this.models,"get",e)},fetch:function(e){e=e?a.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=e.success,i=this;return e.success=function(n){var o=e.reset?"reset":"set";i[o](n,e),t&&t(i,n,e),i.trigger("sync",i,n,e)},j(this,e),this.sync("read",this,e)},create:function(e,t){if(t=t?a.clone(t):{},!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var i=this,n=t.success;return t.success=function(o){t.wait&&i.add(e,t),n&&n(e,o,t)},e.save(null,t),e},parse:function(e){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(e instanceof p)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var i=new this.model(e,t);return i._validate(e,t)?i:(this.trigger("invalid",this,e,t),!1)},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,i,n){("add"!==e&&"remove"!==e||i===this)&&("destroy"===e&&this.remove(t,n),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],null!=t.id&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments))}});var w=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];a.each(w,function(e){g.prototype[e]=function(){var t=s.call(arguments);return t.unshift(this.models),a[e].apply(a,t)}});var y=["groupBy","countBy","sortBy"];a.each(y,function(e){g.prototype[e]=function(t,i){var n=a.isFunction(t)?t:function(e){return e.get(t)};return a[e](this.models,n,i)}});var _=e.View=function(e){this.cid=a.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},x=/^(\S+)\s*(.*)$/,S=["model","collection","el","id","attributes","className","tagName","events"];a.extend(_.prototype,l,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,i){return this.$el&&this.undelegateEvents(),this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0],i!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=a.result(this,"events")))return this;this.undelegateEvents();for(var t in e){var i=e[t];if(a.isFunction(i)||(i=this[e[t]]),i){var n=t.match(x),o=n[1],s=n[2];i=a.bind(i,this),o+=".delegateEvents"+this.cid,""===s?this.$el.on(o,i):this.$el.on(o,s,i)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(e){this.options&&(e=a.extend({},a.result(this,"options"),e)),a.extend(this,a.pick(e,S)),this.options=e},_ensureElement:function(){if(this.el)this.setElement(a.result(this,"el"),!1);else{var t=a.extend({},a.result(this,"attributes"));this.id&&(t.id=a.result(this,"id")),this.className&&(t["class"]=a.result(this,"className"));var i=e.$("<"+a.result(this,"tagName")+">").attr(t);this.setElement(i,!1)}}}),e.sync=function(t,i,n){var o=k[t];a.defaults(n||(n={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var s={type:o,dataType:"json"};if(n.url||(s.url=a.result(i,"url")||O()),null!=n.data||!i||"create"!==t&&"update"!==t&&"patch"!==t||(s.contentType="application/json",s.data=JSON.stringify(n.attrs||i.toJSON(n))),n.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),n.emulateHTTP&&("PUT"===o||"DELETE"===o||"PATCH"===o)){s.type="POST",n.emulateJSON&&(s.data._method=o);var r=n.beforeSend;n.beforeSend=function(e){return e.setRequestHeader("X-HTTP-Method-Override",o),r?r.apply(this,arguments):void 0}}"GET"===s.type||n.emulateJSON||(s.processData=!1),"PATCH"!==s.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(s.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var l=n.xhr=e.ajax(a.extend(s,n));return i.trigger("request",i,l,n),l};var k={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var C=e.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},T=/\((.*?)\)/g,I=/(\(\?)?:\w+/g,M=/\*\w+/g,P=/[\-{}\[\]+?.,\\\^$|#\s]/g;a.extend(C.prototype,l,{initialize:function(){},route:function(t,i,n){a.isRegExp(t)||(t=this._routeToRegExp(t)),a.isFunction(i)&&(n=i,i=""),n||(n=this[i]);var o=this;return e.history.route(t,function(s){var r=o._extractParameters(t,s);n&&n.apply(o,r),o.trigger.apply(o,["route:"+i].concat(r)),o.trigger("route",i,r),e.history.trigger("route",o,i,r)}),this},navigate:function(t,i){return e.history.navigate(t,i),this},_bindRoutes:function(){if(this.routes){this.routes=a.result(this,"routes");for(var e,t=a.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])}},_routeToRegExp:function(e){return e=e.replace(P,"\\$&").replace(T,"(?:$1)?").replace(I,function(e,t){return t?e:"([^/]+)"}).replace(M,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){var i=e.exec(t).slice(1);return a.map(i,function(e){return e?decodeURIComponent(e):null})}});var $=e.History=function(){this.handlers=[],a.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},A=/^[#\/]|\s+$/g,E=/^\/+|\/+$/g,D=/msie [\w.]+/,R=/\/$/;$.started=!1,a.extend($.prototype,l,{interval:50,getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(null==e)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var i=this.root.replace(R,"");e.indexOf(i)||(e=e.substr(i.length))}else e=this.getHash();return e.replace(A,"")},start:function(t){if($.started)throw new Error("Backbone.history has already been started");$.started=!0,this.options=a.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var i=this.getFragment(),n=document.documentMode,o=D.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(E,"/"),o&&this._wantsHashChange&&(this.iframe=e.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(i)),this._hasPushState?e.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!o?e.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=i;var s=this.location,r=s.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!r?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&r&&s.hash&&(this.fragment=this.getHash().replace(A,""),this.history.replaceState({},document.title,this.root+this.fragment+s.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){e.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),$.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();return e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e===this.fragment?!1:(this.iframe&&this.navigate(e),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(e){var t=this.fragment=this.getFragment(e),i=a.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0});return i},navigate:function(e,t){if(!$.started)return!1;if(t&&t!==!0||(t={trigger:t}),e=this.getFragment(e||""),this.fragment!==e){this.fragment=e;var i=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)}},_updateHash:function(e,t,i){if(i){var n=e.href.replace(/(javascript:|#).*$/,"");e.replace(n+"#"+t)}else e.hash="#"+t}}),e.history=new $;var L=function(e,t){var i,n=this;i=e&&a.has(e,"constructor")?e.constructor:function(){return n.apply(this,arguments)},a.extend(i,n,t);var o=function(){this.constructor=i};return o.prototype=n.prototype,i.prototype=new o,e&&a.extend(i.prototype,e),i.__super__=n.prototype,i};p.extend=g.extend=C.extend=_.extend=$.extend=L;var O=function(){throw new Error('A "url" property or function must be specified')},j=function(e,t){var i=t.error;t.error=function(n){i&&i(e,n,t),e.trigger("error",e,n,t)}}}.call(this),define("backbone",["underscore"],function(e){return function(){var t;return t||e.Backbone}}(this)),function(e){var t=function(e,t){return e<<t|e>>>32-t},i=function(e){var t,i,n="";for(t=7;t>=0;t--)i=15&e>>>4*t,n+=i.toString(16);return n},n=function(e){e=e.replace(/\x0d\x0a/g,"\n");for(var t="",i=0;i<e.length;i++){var n=e.charCodeAt(i);128>n?t+=String.fromCharCode(n):n>127&&2048>n?(t+=String.fromCharCode(192|n>>6),t+=String.fromCharCode(128|63&n)):(t+=String.fromCharCode(224|n>>12),t+=String.fromCharCode(128|63&n>>6),t+=String.fromCharCode(128|63&n))}return t};e.extend({sha1:function(e){var o,s,r,a,l,u,d,h,c,p=new Array(80),f=1732584193,m=4023233417,g=2562383102,v=271733878,b=3285377520;e=n(e);var w=e.length,y=new Array;for(s=0;w-3>s;s+=4)r=e.charCodeAt(s)<<24|e.charCodeAt(s+1)<<16|e.charCodeAt(s+2)<<8|e.charCodeAt(s+3),y.push(r);switch(w%4){case 0:s=2147483648;break;case 1:s=8388608|e.charCodeAt(w-1)<<24;break;case 2:s=32768|(e.charCodeAt(w-2)<<24|e.charCodeAt(w-1)<<16);break;case 3:s=128|(e.charCodeAt(w-3)<<24|e.charCodeAt(w-2)<<16|e.charCodeAt(w-1)<<8)}for(y.push(s);14!=y.length%16;)y.push(0);for(y.push(w>>>29),y.push(4294967295&w<<3),o=0;o<y.length;o+=16){for(s=0;16>s;s++)p[s]=y[o+s];for(s=16;79>=s;s++)p[s]=t(p[s-3]^p[s-8]^p[s-14]^p[s-16],1);for(a=f,l=m,u=g,d=v,h=b,s=0;19>=s;s++)c=4294967295&t(a,5)+(l&u|~l&d)+h+p[s]+1518500249,h=d,d=u,u=t(l,30),l=a,a=c;for(s=20;39>=s;s++)c=4294967295&t(a,5)+(l^u^d)+h+p[s]+1859775393,h=d,d=u,u=t(l,30),l=a,a=c;for(s=40;59>=s;s++)c=4294967295&t(a,5)+(l&u|l&d|u&d)+h+p[s]+2400959708,h=d,d=u,u=t(l,30),l=a,a=c;for(s=60;79>=s;s++)c=4294967295&t(a,5)+(l^u^d)+h+p[s]+3395469782,h=d,d=u,u=t(l,30),l=a,a=c;f=4294967295&f+a,m=4294967295&m+l,g=4294967295&g+u,v=4294967295&v+d,b=4294967295&b+h}var c=i(f)+i(m)+i(g)+i(v)+i(b);return c.toLowerCase()}})}(jQuery),define("lib/jquery.sha1",function(){}),define("config",["require","lib/jquery.sha1"],function(e){e("lib/jquery.sha1");var t=window.location.host,i="turntable.fm"!=t||"47381f2767629f64daa0d70c79d91baaeb702835"==$.sha1(location.hash),n={DEBUG_MODE:i,IS_FRAMED:window!==window.top};return window.DEBUG_MODE=i,window.WEB_SOCKET_SWF_LOCATION="/static/swf/WebSocketMain.swf",n}),define("class",["require","underscore","config"],function(require){var _=require("underscore"),config=require("config"),Class=function(){this.init.apply(this,arguments)};Class.prototype.init=function(){};var extend=function(protoProps,staticProps){var parent=this,child,prop=protoProps,_super=parent.prototype,fnTest=/test/.test(function(){this.test="test"})?/\b_super\b/:/.*/,makeFnWrapper=function(e,t){return function(){var i=this._super;this._super=_super[e];var n=t.apply(this,arguments);return this._super=i,n}};for(var name in prop)"function"==typeof prop[name]&&"function"==typeof _super[name]&&fnTest.test(prop[name])&&(prop[name]=makeFnWrapper(name,prop[name]));var newClassName;if(config.DEBUG_MODE){if(staticProps&&staticProps.hasOwnProperty("_name")){var potentialClassName=staticProps._name;potentialClassName=potentialClassName.replace(/[^\w$]/g,""),potentialClassName.length>0&&(/^[a-zA-Z_$].*$/.test(potentialClassName)||(potentialClassName="Class"+potentialClassName),newClassName=potentialClassName)}if(newClassName){var constructorFn;constructorFn=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:parent,eval("var "+newClassName+" = function(){ return constructorFn.apply(this, arguments); };"),eval("child = "+newClassName)}}newClassName||(child=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)}),_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&_.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};return Class.extend=extend,Class}),function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define("spin",t):e.Spinner=t()}(this,function(){function e(e,t){var i,n=document.createElement(e||"div");for(i in t)n[i]=t[i];return n}function t(e){for(var t=1,i=arguments.length;i>t;t++)e.appendChild(arguments[t]);return e}function i(e,t,i,n){var o=["opacity",t,~~(100*e),i,n].join("-"),s=.01+100*(i/n),r=Math.max(1-(1-e)/t*(100-s),e),a=u.substring(0,u.indexOf("Animation")).toLowerCase(),l=a&&"-"+a+"-"||"";return h[o]||(c.insertRule("@"+l+"keyframes "+o+"{"+"0%{opacity:"+r+"}"+s+"%{opacity:"+e+"}"+(s+.01)+"%{opacity:1}"+(s+t)%100+"%{opacity:"+e+"}"+"100%{opacity:"+r+"}"+"}",c.cssRules.length),h[o]=1),o}function n(e,t){var i,n,o=e.style;if(void 0!==o[t])return t;for(t=t.charAt(0).toUpperCase()+t.slice(1),n=0;n<d.length;n++)if(i=d[n]+t,void 0!==o[i])return i}function o(e,t){for(var i in t)e.style[n(e,i)||i]=t[i];return e}function s(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)void 0===e[n]&&(e[n]=i[n])}return e}function r(e){for(var t={x:e.offsetLeft,y:e.offsetTop};e=e.offsetParent;)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function a(e){return"undefined"==typeof this?new a(e):(this.opts=s(e||{},a.defaults,p),void 0)}function l(){function i(t,i){return e("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',i)}c.addRule(".spin-vml","behavior:url(#default#VML)"),a.prototype.lines=function(e,n){function s(){return o(i("group",{coordsize:u+" "+u,coordorigin:-l+" "+-l}),{width:u,height:u})}function r(e,r,a){t(h,t(o(s(),{rotation:360/n.lines*e+"deg",left:~~r}),t(o(i("roundrect",{arcsize:n.corners}),{width:l,height:n.width,left:n.radius,top:-n.width>>1,filter:a}),i("fill",{color:n.color,opacity:n.opacity}),i("stroke",{opacity:0}))))}var a,l=n.length+n.width,u=2*l,d=2*-(n.width+n.length)+"px",h=o(s(),{position:"absolute",top:d,left:d});if(n.shadow)for(a=1;a<=n.lines;a++)r(a,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(a=1;a<=n.lines;a++)r(a);return t(e,h)},a.prototype.opacity=function(e,t,i,n){var o=e.firstChild;n=n.shadow&&n.lines||0,o&&t+n<o.childNodes.length&&(o=o.childNodes[t+n],o=o&&o.firstChild,o=o&&o.firstChild,o&&(o.opacity=i))}}var u,d=["webkit","Moz","ms","O"],h={},c=function(){var i=e("style",{type:"text/css"});return t(document.getElementsByTagName("head")[0],i),i.sheet||i.styleSheet}(),p={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};a.defaults={},s(a.prototype,{spin:function(t){this.stop();var i,n,s=this,a=s.opts,l=s.el=o(e(0,{className:a.className}),{position:a.position,width:0,zIndex:a.zIndex}),d=a.radius+a.length+a.width;if(t&&(t.insertBefore(l,t.firstChild||null),n=r(t),i=r(l),o(l,{left:("auto"==a.left?n.x-i.x+(t.offsetWidth>>1):parseInt(a.left,10)+d)+"px",top:("auto"==a.top?n.y-i.y+(t.offsetHeight>>1):parseInt(a.top,10)+d)+"px"})),l.setAttribute("role","progressbar"),s.lines(l,s.opts),!u){var h,c=0,p=(a.lines-1)*(1-a.direction)/2,f=a.fps,m=f/a.speed,g=(1-a.opacity)/(m*a.trail/100),v=m/a.lines;!function b(){c++;for(var e=0;e<a.lines;e++)h=Math.max(1-(c+(a.lines-e)*v)%m*g,a.opacity),s.opacity(l,e*a.direction+p,h,a);s.timeout=s.el&&setTimeout(b,~~(1e3/f))}()}return s},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=void 0),this},lines:function(n,s){function r(t,i){return o(e(),{position:"absolute",width:s.length+s.width+"px",height:s.width+"px",background:t,boxShadow:i,transformOrigin:"left",transform:"rotate("+~~(360/s.lines*l+s.rotate)+"deg) translate("+s.radius+"px"+",0)",borderRadius:(s.corners*s.width>>1)+"px"})}for(var a,l=0,d=(s.lines-1)*(1-s.direction)/2;l<s.lines;l++)a=o(e(),{position:"absolute",top:1+~(s.width/2)+"px",transform:s.hwaccel?"translate3d(0,0,0)":"",opacity:s.opacity,animation:u&&i(s.opacity,s.trail,d+l*s.direction,s.lines)+" "+1/s.speed+"s linear infinite"}),s.shadow&&t(a,o(r("#000","0 0 4px #000"),{top:"2px"})),t(n,t(a,r(s.color,"0 0 1px rgba(0,0,0,.1)")));return n},opacity:function(e,t,i){t<e.childNodes.length&&(e.childNodes[t].style.opacity=i)}});var f=o(e("group"),{behavior:"url(#default#VML)"});return!n(f,"transform")&&f.adj?l():u=n(f,"animation"),a}),jQuery.cookie=function(e,t,i){if(arguments.length>1&&"[object Object]"!==String(t)){if(i=jQuery.extend({},i),(null===t||void 0===t)&&(i.expires=-1),"number"==typeof i.expires){var n=i.expires,o=i.expires=new Date;o.setDate(o.getDate()+n)}return t=String(t),document.cookie=[encodeURIComponent(e),"=",i.raw?t:encodeURIComponent(t),i.expires?"; expires="+i.expires.toUTCString():"",i.path?"; path="+i.path:"",i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join("")}i=t||{};var s,r=i.raw?function(e){return e}:decodeURIComponent;return(s=new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)").exec(document.cookie))?r(s[1]):null},define("lib/jquery.cookie",function(){}),function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var i=(new Date).getTime(),n=Math.max(0,16-(i-e)),o=window.setTimeout(function(){t(i+n)},n);return e=i+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),define("blackswan/requestAnimationFrame",function(){});var util=function(){var e=function(){function e(e,t){return e.height&&e.width?(t.resolve(e),!0):!1}function t(e,t,n){if("object"!==$.type(t))return LOG("WARNING: 'events' "+String(t)+" is not a dict"),void 0;for(var o in t){var s=t[o];if("string"===$.type(s)){if(!n){LOG("WARNING: no owner provided for event handler '"+s+"'");continue}var r=n[s];if(!r){LOG("WARNING: no event handler "+String(n)+"."+s);continue}s=r}s&&(window.DEBUG_MODE||(s=i.eventHandlerDecorator(s)),$(e).on(o,s))}}var i=this,n={lines:13,length:10,width:3,radius:13,color:"#FFF",shadow:!0};this.endsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},this.stripTrailingSlash=function(e){return"/"===e[e.length-1]&&(e=e.substr(0,e.length-1)),e},this.strip=function(e,t){if(void 0===t)return $.trim(e);if(""===t)return e;t=t.replace("\\","\\\\");var i=new RegExp("^["+t+"]+|["+t+"]+$","g");return e.replace(i,"")},this.alphabetize=function(e,t){return e.sort(function(e,i){var n,o;return t?(n=e[t].toLowerCase(),o=i[t].toLowerCase()):(n=e.toLowerCase(),o=i.toLowerCase()),o>n?-1:n>o?1:0}),e},this.domify=function(e){var t=$.parseHTML(e);if(!t)return document.createDocumentFragment();var i=t.length;if(i>1){for(var n=document.createDocumentFragment(),o=0;i>o;o++)n.appendChild(t[o]);return n}return 1===i?t[0]:void 0},this.isDOMNode=function(e){return"object"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName};var o="[a-zA-Z][_a-zA-Z0-9-]*",s=new RegExp("[^#]#("+o+")"),r=new RegExp("##(\\$?"+o+")"),a=new RegExp("\\$("+o+")"),l=new RegExp("\\."+o,"g"),u=new RegExp("("+o+")([\\.#]|$)"),d=/\./g;this.createElement=function(e,i,n){var o,h=e.match(s),c=e.match(a),p=e.match(l),f=document.createElement(e.match(u)[1]);if(h&&(f.id=h[1]),c&&n)c=c[1],n[c]=f,n["$"+c]=o=$(f);else{var m=e.match(r);m&&n&&(n[m[1]]=f)}if(p&&(f.className=p.join("").replace(d," ").trim()),i){var g;for(var v in i)g=i[v],"style"===v?(o||(o=$(f)),o=$(f).css(g)):"data"===v?$.data(f,g):"event"===v?t(f,g,n):"cssClass"===v||"className"===v?(o||(o=$(f)),o.addClass(g)):null!==g&&void 0!==g?f.setAttribute(v,g):f.removeAttribute(v)}return f},this.buildTree=function(e,t){if(this.isDOMNode(e))return e;var n=typeof e;if("string"===n||"number"===n)return document.createTextNode(e);var o,s,r,a,l,u;if(e instanceof Array)if(o=e[0],s=typeof o,"string"===s||"function"===s){a=e.slice(1);var d=a[0];"object"!=typeof d||d instanceof Array||this.isDOMNode(d)||(r=a[0],a=a.slice(1))}else u=l=document.createDocumentFragment(),a=e;else{if("function"!==n)return;o=e,s=n}if("string"===s&&(u=l=this.createElement(o,r,t),"a"!==o.toLowerCase()||l.href||(l.href="#")),a&&a.length){u||(u=document.createDocumentFragment());for(var h=0,c=a.length;c>h;h++)d=a[h],null!==d&&void 0!==d&&u.appendChild(i.buildTree(d,t))}if("function"===s){var p=new o(r,u);l=p.el,t&&(t[p.options.idd]=p)}return"string"===s&&"input"===o.toLowerCase()&&i.setupPlaceholders(l),l};var h=function(e,t){return t+": "+e+";"},c=function(e,t){return t+"{"+_.map(e,h).join("")+"}"};this.css=function(e){var t=_.map(e,c).join(""),i=document.createElement("style");return i.type="text/css",i.styleSheet?i.styleSheet.cssText=t:i.appendChild(document.createTextNode(t)),document.head.appendChild(i),i},this.createImageWithLoader=function(t){var n=$.Deferred(),o=new Image;return o.onload=function(){i.retry(null,e)(o,n)},o.onerror=function(){n.reject()},o.src=t,[o,n]},this.loadImage=function(t){var n=$.Deferred(),o=new Image;
return o.onload=function(){i.retry(null,e)(o,n)},o.onerror=function(){n.reject()},o.src=t,n.promise()},this.detectIEVersion=function(){var e=navigator.userAgent,t=new RegExp("MSIE ([0-9]{1,}[\\.0-9]{0,})");return null!==t.exec(e)?parseFloat(RegExp.$1):void 0},this.transitionEnd=function(){var e=document.createElement("fakeelement"),t={transition:"transitionend",OTransition:"otransitionend",MSTransition:"msTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(var i in t)if(void 0!==e.style[i])return t[i]}(),this.eventHandlerDecorator=function(e){return function(){try{return e.apply(this,arguments)}catch(t){LOG("Exception in event handler: "+String(t))}return!1}},this.now=function(){return(new Date).getTime()},this.nowStr=function(){return String(new Date).substr(16,8)},this.capitalize=function(e){return e.charAt(0).toUpperCase()+e.substr(1)},this.commafy=function(e){return(e+"").replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.asciify=function(e){return e.replace(/[\u00E0-\u00E5]/g,"a").replace(/[\u00E8-\u00EB\u0112-\u011B]/g,"e").replace(/[\u00EC-\u00EF]/g,"i").replace(/[\u00F1\u0143-\u014B]/g,"n").replace(/[\u00F2-\u00F6\u00F8\u014C-\u0151]/g,"o").replace(/[\u00D9-\u00DC\u00F9-\u00FC]/,"u").replace(/[\u00DD\u00FD\u00FF]/,"y")},this.normalize=function(e){return e.replace(/\0.*/,"")},this.stripComboDiacritics=function(e){return e.replace(/[\u0300-\u036F\u0483-\u0489\u1DC0-\u1DFF\u20D0-\u20FF\uFE20-\uFE2F]/g,"")},this.cleanText=function(e){return i.asciify(i.normalize(i.stripComboDiacritics(e)))},this.messageFilter=function(e){return i.emojify(i.linkify(i.safeText(i.memeify(e))))},this.linkify=function(e){var t=/(\b(https?|ftp):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;'\(\)\*\$]*[\-A-Z0-9+&@#\/%=~_\(\)|])/gim,i=e.replace(t,'<a href="$1" target="_blank" rel="nofollow">$1</a>'),n=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;return i=i.replace(n,'<a href="mailto:$1">$1</a>')},this.emojify=function(e){e=e.replace(/:\+1:/g,":thumbsup:");var t=/:([\w\d\-_]+):/g,i=e.match(t);if(i)for(var n=0,o=i.length;o>n;n++){var s=this.emojiToHtml(i[n]);s&&(e=e.replace(i[n],s))}var r={":man_with_turban:":/@:\)/g,":imp:":/&gt;:\(/g,":smiling_imp:":/&gt;:\)/g,":smile:":/:-?\)/g,":unamused:":/:-?\(/g,":wink:":/;-?\)/g,":stuck_out_tongue:":/:-?[Pp]/g,":heart:":/&lt;3/g};for(var a in r){var l=r[a];l.test(e)&&(e=e.replace(l,this.emojiToHtml(a)))}return e},this.emojiToHtml=function(e){var t=e.replace(/:/g,"").toLowerCase();return t in v?"<span title='"+t+"' class='emoji emoji-"+t+"'></span>":void 0},this.emojiToTree=function(e){var t=e.replace(/:/g,"").toLowerCase();return t in v?["span.emoji.emoji-"+t,{title:t}]:void 0},this.emojiTypeahead=function(e,t){var i=[],n=0,o=e.length;for(name in v)if(v.hasOwnProperty(name)&&name.substring(0,o)===e&&(i[n]=name,n++,n>=t))break;if(t>n)for(name in v)if(v.hasOwnProperty(name)&&-1!==name.indexOf(e)&&-1===i.indexOf(name)&&(i[n]=name,n++,n>=t))break;return i},this.memeify=function(e){return e&&e.indexOf("/")>-1?e.replace(/\/seriousface/g,"\u0ca0_\u0ca0").replace(/\/monocle/g,"\u0ca0_\u0cb0\u0cc3").replace(/\/tableflip/g,"(\u256f\xb0\u25a1\xb0)\u256f\ufe35 \u253b\u2501\u253b").replace(/\/tablefix/g,"\u252c\u2500\u252c\u30ce( \xba _ \xba\u30ce)").replace(/\/whatever/g,"\xaf\\_(\u30c4)_/\xaf").replace(/\/danceparty/g,"\u266a\u250f(\u30fbo\uff65)\u251b\u266a\u2517 ( \uff65o\uff65) \u2513\u266a").replace(/\/koala/g,"\u0295 \u2022\u1d25\u2022\u0294").replace(/\/love/g,"\u2665\u203f\u2665").replace(/\/nano/g,">: |"):e},this.safeText=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},this.brText=function(e){return e.replace(/\n$/,"<br/>&nbsp;").replace(/\n/g,"<br/>")},this.title=function(e){return e.replace(/(^|\s)([a-z])/g,function(e,t,i){return t+i.toUpperCase()})},this.spaceToNbsps=function(e){return e.replace(/ {2,}/g,function(e){for(var t="",i=0,n=e.length-1;n>i;i++)t+="&nbsp;";return t+" "})},this.setupPlaceholders=function(e){if(!$.browser.webkit){var e=$(e),t=e.attr("placeholder");t&&(e.addClass("placeholder"),e.attr("value",t),e.focus(function(){e.val()==t&&(e.removeClass("placeholder"),e.attr("value",""))}),e.blur(function(){""===$.trim(e.val())&&(e.addClass("placeholder"),e.attr("value",t))}))}},this.nBAInQ=function(e){if(e)for(var t in e)"function"==typeof e[t]&&(e[t].toString=function(){})},this.safariVersion=function(){var e=/Version\/((\d+\.?)+) Safari\//.exec(navigator.userAgent);return e?e[1]:void 0},this.versionNumberCompare=function(e,t){for(var i,n,o=[e,t],s=0;2>s;s++){if(i=o[s],n=$.type(i),"string"===n)i=$.map(i.split("."),function(e){return parseInt(e)});else if("array"===n)i=$.map(i,function(e){return parseInt(e)});else{if("number"!==n)throw"invalid version format";i=[i]}o[s]=i}for(var r,a,l,s=0,u=Math.max(o[0].length,o[1].length);u>s;){if(r=o[0][s]||0,a=o[1][s]||0,l=r-a,0!==l)return l;s++}return 0},this.fullCanvasCompositionSupport=function(){var e=util.safariVersion();return void 0!==e&&util.versionNumberCompare(e,6)<0?!1:!0},this.webkitMaskSupport=function(){if(!$.browser.webkit)return!1;var e=util.safariVersion();return void 0!==e&&util.versionNumberCompare(e,"5.1.2")<=0?!1:!0},this.prettyTime=function(e){var t=Math.floor(e/60);if(e%=60,e=10>e?"0"+e:e,60>t)return t+":"+e;var i=Math.floor(t/60);return t%=60,t=10>t?"0"+t:t,i+":"+t+":"+e},this.prettyDate=function(e){var t=new Date(1e3*e);return t.getMonth()+1+"."+t.getDate()+"."+t.getFullYear()%100},this.prettierDate=function(e){var t=new Date(1e3*e),i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return i[t.getDay()]+" "+n[t.getMonth()]+" "+t.getDate()+", "+t.getFullYear()},this.prettyTimeDelta=function(e){var t=[[120,"1 minute ago","1 minute from now"],[3600,"minutes",60],[7200,"1 hour ago","1 hour from now"],[86400,"hours",3600],[172800,"yesterday","tomorrow"],[604800,"days",86400],[1209600,"last week","next week"],[2419200,"weeks",604800],[4838400,"last month","next month"],[29030400,"months",2419200],[58060800,"last year","next year"],[290304e4,"years",29030400],[580608e4,"last century","next century"],[580608e5,"centuries",290304e4]],n=i.now()/1e3-e,o="ago",s=1;if(0>n&&(n=-n,o="from now",s=2),60>n)return"just now";for(var r=0;r<t.length;r++){var a=t[r];if(n<a[0])return"string"==typeof a[2]?a[s]:Math.floor(n/a[2])+" "+a[1]+" "+o}return e},this.notEmpty=function(){for(var e=arguments.length,t=0;e>t;t++){var i=arguments[t];if(null===i||void 0===i)return!1;if("object"==$.type(i)){var n=!0;for(var o in i)if(i.hasOwnProperty(o)){n=!1;break}if(n)return!1}else if("array"==$.type(i)&&0===i.length)return!1}return!0},this.mergeDicts=function(){for(var e={},t=0;t<arguments.length;t++){var i=arguments[t];for(var n in i)e[n]=i[n]}return e},this.getSetting=function(e,t){var n=$.cookie("setting_"+e);return t||i.setSetting(e,n),n},this.setSetting=function(e,t,i){$.cookie("setting_"+e,t,{path:"/",expires:i||365})},this.centsToDollarString=function(e){var t=e+"",i=t.length;return 1==i?"$0.0"+t:"$"+(t.substring(0,i-2)||"0")+"."+t.substring(i-2)},this.validators={email:function(e){var t=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return t.test(e)?{valid:!0}:{valid:!1,err:"Please enter a valid email address"}},password:function(e){return e.length>=6?{valid:!0}:{valid:!1,err:"Your password must be at least 6 characters long"}},makePasswordConfirm:function(e){return function(t){var i=$(e).val();return t!=i?{valid:!1,err:"Your passwords must match"}:{valid:!0}}}},this.binarySearch=function(e,t,i,n){for(var o,s,r,a=0,l=e.length-1;l>=a;){if(o=Math.floor((a+l)/2),s=e[o],!n&&s===t)return o;if(r=i(s,t),0>r)a=o+1;else{if(!(r>0)){if(n)return o;break}l=o-1}}if(n)return a;if(e[o]===t)return o;for(var u=o+1,s=e[u];s&&0===i(s,t);u++,s=e[u])if(s===t)return u;for(u=o-1,s=e[u];s&&0===i(s,t);u--,s=e[u])if(s===t)return u},this.makeSpinner=function(e,t){var i=new Spinner($.extend({},n,t));return i.spin(e),i};var p=function(){window.clearTimeout(this.timeout),this.timeout=null},f=function(){window.cancelAnimationFrame(this.requestId),this.requestId=null};this.retry=function(e,t,i,n){var o=i||10;n=n||1e3;var s=function(){var i=Array.prototype.slice.call(arguments),r=t.apply(e,i);r===!1&&o>=0&&(o--,window.setTimeout(function(){s.apply(e,i)},n))};return s},this.delay=function(e,t,i){var n={},o=function(){n.timeout&&window.clearTimeout(n.timeout);var o=Array.prototype.slice.call(arguments);n.timeout=window.setTimeout(function(){n.timeout=null,t.apply(e,o)},i)};return o.cancel=_.bind(p,n),o},this.rateLimit=function(e,t,i){var n={},o=null,s=function(){n.timeout||(n.timeout=window.setTimeout(function(){n.timeout=null,t.apply(e,o)},i)),o=Array.prototype.slice.call(arguments)};return s.cancel=_.bind(p,n),s},this.makeDrawer=function(e,t){var i={},n=null,o=function(){i.requestId||(i.requestId=window.requestAnimationFrame(function(){i.requestId=null,t.apply(e,n)})),n=Array.prototype.slice.call(arguments)};return o.cancel=_.bind(f,i),o},this.getUrlParam=function(e){var t=window.location.search.match("[?&]"+e+"=([^&#]*)");return t&&(t=t[1]),t},this.hashString=function(e,t,i){if("string"!=typeof e)throw"hashString only works with strings.";for(var n=0,o=0;o<e.length;++o)n+=e.charCodeAt(o);return n%(i-t+1)+t};var m=Function.prototype.bind,g=function(){};this.applyNew=function(e,t){if(m)return new(m.apply(e,[e].concat(t)));g.prototype=e.prototype;var i=new g;return e.apply(i,t),i},this.parse=function(e){try{return JSON.parse(e)}catch(t){return{}}},this.errorCode=function(e){return this.parse(e).error},this.errorMsg=function(e){return this.parse(e).errmsg},this.albumProxy=function(e,t){if(-1!==e.indexOf("images.mndigital.com")||-1!==e.indexOf("images.musicnet.com")){var i=e.split("albums");if(2===i.length){if("piki"===t)return"https://piki.fm/static/albums"+i[1];if("turntable"===t)return"https://turntable.fm/roommanager_assets/albums"+i[1]}}return e};var v={"-1":null,"+1":null,100:null,109:null,1234:null,"8ball":null,a:null,ab:null,abc:null,abcd:null,accept:null,aerial_tramway:null,airplane:null,alarm_clock:null,alien:null,ambulance:null,anchor:null,angel:null,anger:null,angry:null,anguished:null,ant:null,apple:null,aquarius:null,aries:null,arrow_backward:null,arrow_double_down:null,arrow_double_up:null,arrow_down:null,arrow_down_small:null,arrow_forward:null,arrow_heading_down:null,arrow_heading_up:null,arrow_left:null,arrow_lower_left:null,arrow_lower_right:null,arrow_right:null,arrow_right_hook:null,arrow_up:null,arrow_up_down:null,arrow_up_small:null,arrow_upper_left:null,arrow_upper_right:null,arrows_clockwise:null,arrows_counterclockwise:null,art:null,articulated_lorry:null,astonished:null,atm:null,b:null,baby:null,baby_bottle:null,baby_chick:null,baby_symbol:null,baggage_claim:null,balloon:null,ballot_box_with_check:null,bamboo:null,banana:null,bangbang:null,bank:null,bar_chart:null,barber:null,baseball:null,basketball:null,bath:null,bathtub:null,battery:null,bear:null,beer:null,beers:null,beetle:null,beginner:null,bell:null,bento:null,bicyclist:null,bike:null,bikini:null,bird:null,birthday:null,black_circle:null,black_joker:null,black_nib:null,black_square:null,black_square_button:null,blossom:null,blowfish:null,blue_book:null,blue_car:null,blue_heart:null,blush:null,boar:null,boat:null,bomb:null,book:null,bookmark:null,bookmark_tabs:null,books:null,boom:null,boot:null,bouquet:null,bow:null,bowling:null,bowtie:null,boy:null,bread:null,bride_with_veil:null,bridge_at_night:null,briefcase:null,broken_heart:null,bug:null,bulb:null,bullettrain_front:null,bullettrain_side:null,bus:null,busstop:null,bust_in_silhouette:null,busts_in_silhouette:null,cactus:null,cake:null,calendar:null,calling:null,camel:null,camera:null,cancer:null,candy:null,capital_abcd:null,capricorn:null,car:null,card_index:null,carousel_horse:null,cat:null,cat2:null,cd:null,chart:null,chart_with_downwards_trend:null,chart_with_upwards_trend:null,checkered_flag:null,cherries:null,cherry_blossom:null,chestnut:null,chicken:null,children_crossing:null,chocolate_bar:null,christmas_tree:null,church:null,cinema:null,circus_tent:null,city_sunrise:null,city_sunset:null,cl:null,clap:null,clapper:null,clipboard:null,clock1:null,clock10:null,clock1030:null,clock11:null,clock1130:null,clock12:null,clock1230:null,clock130:null,clock2:null,clock230:null,clock3:null,clock330:null,clock4:null,clock430:null,clock5:null,clock530:null,clock6:null,clock630:null,clock7:null,clock730:null,clock8:null,clock830:null,clock9:null,clock930:null,closed_book:null,closed_lock_with_key:null,closed_umbrella:null,cloud:null,clubs:null,cn:null,cocktail:null,coffee:null,cold_sweat:null,collision:null,computer:null,confetti_ball:null,confounded:null,confused:null,congratulations:null,construction:null,construction_worker:null,convenience_store:null,cookie:null,cool:null,cop:null,copyright:null,corn:null,couple:null,couple_with_heart:null,couplekiss:null,cow:null,cow2:null,credit_card:null,crocodile:null,crossed_flags:null,crown:null,cry:null,crying_cat_face:null,crystal_ball:null,cupid:null,curly_loop:null,currency_exchange:null,curry:null,custard:null,customs:null,cyclone:null,dancer:null,dancers:null,dango:null,dart:null,dash:null,date:null,de:null,deciduous_tree:null,department_store:null,diamond_shape_with_a_dot_inside:null,diamonds:null,disappointed:null,dizzy:null,dizzy_face:null,do_not_litter:null,dog:null,dog2:null,dollar:null,dolls:null,dolphin:null,door:null,doughnut:null,dragon:null,dragon_face:null,dress:null,dromedary_camel:null,droplet:null,dvd:null,"e-mail":null,ear:null,ear_of_rice:null,earth_africa:null,earth_americas:null,earth_asia:null,egg:null,eggplant:null,eight:null,eight_pointed_black_star:null,eight_spoked_asterisk:null,electric_plug:null,elephant:null,email:null,end:null,envelope:null,es:null,euro:null,european_castle:null,european_post_office:null,evergreen_tree:null,exclamation:null,expressionless:null,eyeglasses:null,eyes:null,facepunch:null,factory:null,fallen_leaf:null,family:null,fast_forward:null,fax:null,fearful:null,feelsgood:null,feet:null,ferris_wheel:null,file_folder:null,finnadie:null,fire:null,fire_engine:null,fireworks:null,first_quarter_moon:null,first_quarter_moon_with_face:null,fish:null,fish_cake:null,fishing_pole_and_fish:null,fist:null,five:null,flags:null,flashlight:null,floppy_disk:null,flower_playing_cards:null,flushed:null,foggy:null,football:null,fork_and_knife:null,fountain:null,four:null,four_leaf_clover:null,fr:null,free:null,fried_shrimp:null,fries:null,frog:null,frowning:null,fuelpump:null,full_moon:null,full_moon_with_face:null,game_die:null,gb:null,gem:null,gemini:null,ghost:null,gift:null,gift_heart:null,girl:null,globe_with_meridians:null,goat:null,goberserk:null,godmode:null,golf:null,grapes:null,green_apple:null,green_book:null,green_heart:null,grey_exclamation:null,grey_question:null,grimacing:null,grin:null,grinning:null,guardsman:null,guitar:null,gun:null,haircut:null,hamburger:null,hammer:null,hamster:null,hand:null,handbag:null,hankey:null,hash:null,hatched_chick:null,hatching_chick:null,headphones:null,hear_no_evil:null,heart:null,heart_decoration:null,heart_eyes:null,heart_eyes_cat:null,heartbeat:null,heartpulse:null,hearts:null,heavy_check_mark:null,heavy_division_sign:null,heavy_dollar_sign:null,heavy_exclamation_mark:null,heavy_minus_sign:null,heavy_multiplication_x:null,heavy_plus_sign:null,helicopter:null,herb:null,hibiscus:null,high_brightness:null,high_heel:null,hocho:null,honey_pot:null,honeybee:null,horse:null,horse_racing:null,hospital:null,hotel:null,hotsprings:null,hourglass:null,hourglass_flowing_sand:null,house:null,house_with_garden:null,hurtrealbad:null,hushed:null,ice_cream:null,icecream:null,id:null,ideograph_advantage:null,imp:null,inbox_tray:null,incoming_envelope:null,information_desk_person:null,information_source:null,innocent:null,interrobang:null,iphone:null,it:null,izakaya_lantern:null,jack_o_lantern:null,japan:null,japanese_castle:null,japanese_goblin:null,japanese_ogre:null,jeans:null,joy:null,joy_cat:null,jp:null,key:null,keycap_ten:null,kimono:null,kiss:null,kissing:null,kissing_cat:null,kissing_closed_eyes:null,kissing_heart:null,kissing_smiling_eyes:null,koala:null,koko:null,kr:null,large_blue_circle:null,large_blue_diamond:null,large_orange_diamond:null,last_quarter_moon:null,last_quarter_moon_with_face:null,laughing:null,leaves:null,ledger:null,left_luggage:null,left_right_arrow:null,leftwards_arrow_with_hook:null,lemon:null,leo:null,leopard:null,libra:null,light_rail:null,link:null,lips:null,lipstick:null,lock:null,lock_with_ink_pen:null,lollipop:null,loop:null,loudspeaker:null,love_hotel:null,love_letter:null,low_brightness:null,m:null,mag:null,mag_right:null,mahjong:null,mailbox:null,mailbox_closed:null,mailbox_with_mail:null,mailbox_with_no_mail:null,man:null,man_with_gua_pi_mao:null,man_with_turban:null,mans_shoe:null,maple_leaf:null,mask:null,massage:null,meat_on_bone:null,mega:null,melon:null,memo:null,mens:null,metal:null,metro:null,microphone:null,microscope:null,milky_way:null,minibus:null,minidisc:null,mobile_phone_off:null,money_with_wings:null,moneybag:null,monkey:null,monkey_face:null,monorail:null,moon:null,mortar_board:null,mount_fuji:null,mountain_bicyclist:null,mountain_cableway:null,mountain_railway:null,mouse:null,mouse2:null,movie_camera:null,moyai:null,muscle:null,mushroom:null,musical_keyboard:null,musical_note:null,musical_score:null,mute:null,nail_care:null,name_badge:null,neckbeard:null,necktie:null,negative_squared_cross_mark:null,neutral_face:null,"new":null,new_moon:null,new_moon_with_face:null,newspaper:null,ng:null,nine:null,no_bell:null,no_bicycles:null,no_entry:null,no_entry_sign:null,no_good:null,no_mobile_phones:null,no_mouth:null,no_pedestrians:null,no_smoking:null,"non-potable_water":null,nose:null,notebook:null,notebook_with_decorative_cover:null,notes:null,nut_and_bolt:null,o:null,o2:null,ocean:null,octocat:null,octopus:null,oden:null,office:null,ok:null,ok_hand:null,ok_woman:null,older_man:null,older_woman:null,on:null,oncoming_automobile:null,oncoming_bus:null,oncoming_police_car:null,oncoming_taxi:null,one:null,open_file_folder:null,open_hands:null,open_mouth:null,ophiuchus:null,orange_book:null,outbox_tray:null,ox:null,page_facing_up:null,page_with_curl:null,pager:null,palm_tree:null,panda_face:null,paperclip:null,parking:null,part_alternation_mark:null,partly_sunny:null,passport_control:null,paw_prints:null,peach:null,pear:null,pencil:null,pencil2:null,penguin:null,pensive:null,performing_arts:null,persevere:null,person_frowning:null,person_with_blond_hair:null,person_with_pouting_face:null,phone:null,pig:null,pig2:null,pig_nose:null,pill:null,pineapple:null,pisces:null,pizza:null,plus1:null,point_down:null,point_left:null,point_right:null,point_up:null,point_up_2:null,police_car:null,poodle:null,poop:null,post_office:null,postal_horn:null,postbox:null,potable_water:null,pouch:null,poultry_leg:null,pound:null,pouting_cat:null,pray:null,princess:null,punch:null,purple_heart:null,purse:null,pushpin:null,put_litter_in_its_place:null,question:null,rabbit:null,rabbit2:null,racehorse:null,radio:null,radio_button:null,rage:null,rage1:null,rage2:null,rage3:null,rage4:null,railway_car:null,rainbow:null,raised_hand:null,raised_hands:null,ram:null,ramen:null,rat:null,recycle:null,red_car:null,red_circle:null,registered:null,relaxed:null,relieved:null,repeat:null,repeat_one:null,restroom:null,revolving_hearts:null,rewind:null,ribbon:null,rice:null,rice_ball:null,rice_cracker:null,rice_scene:null,ring:null,rocket:null,roller_coaster:null,rooster:null,rose:null,rotating_light:null,round_pushpin:null,rowboat:null,ru:null,rugby_football:null,runner:null,running:null,running_shirt_with_sash:null,sa:null,sagittarius:null,sailboat:null,sake:null,sandal:null,santa:null,satellite:null,satisfied:null,saxophone:null,school:null,school_satchel:null,scissors:null,scorpius:null,scream:null,scream_cat:null,scroll:null,seat:null,secret:null,see_no_evil:null,seedling:null,seven:null,shaved_ice:null,sheep:null,shell:null,ship:null,shipit:null,shirt:null,shit:null,shoe:null,shower:null,signal_strength:null,six:null,six_pointed_star:null,ski:null,skull:null,sleeping:null,sleepy:null,slot_machine:null,small_blue_diamond:null,small_orange_diamond:null,small_red_triangle:null,small_red_triangle_down:null,smile:null,smile_cat:null,smiley:null,smiley_cat:null,smiling_imp:null,smirk:null,smirk_cat:null,smoking:null,snail:null,snake:null,snowboarder:null,snowflake:null,snowman:null,sob:null,soccer:null,soon:null,sos:null,sound:null,space_invader:null,spades:null,spaghetti:null,sparkler:null,sparkles:null,sparkling_heart:null,speak_no_evil:null,speaker:null,speech_balloon:null,speedboat:null,squirrel:null,star:null,star2:null,stars:null,station:null,statue_of_liberty:null,steam_locomotive:null,stew:null,straight_ruler:null,strawberry:null,stuck_out_tongue:null,stuck_out_tongue_closed_eyes:null,stuck_out_tongue_winking_eye:null,sun_with_face:null,sunflower:null,sunglasses:null,sunny:null,sunrise:null,sunrise_over_mountains:null,surfer:null,sushi:null,suspect:null,suspension_railway:null,sweat:null,sweat_drops:null,sweat_smile:null,sweet_potato:null,swimmer:null,symbols:null,syringe:null,tada:null,tanabata_tree:null,tangerine:null,taurus:null,taxi:null,tea:null,telephone:null,telephone_receiver:null,telescope:null,tennis:null,tent:null,thought_balloon:null,three:null,thumbsdown:null,thumbsup:null,ticket:null,tiger:null,tiger2:null,tired_face:null,tm:null,toilet:null,tokyo_tower:null,tomato:null,tongue:null,top:null,tophat:null,tractor:null,traffic_light:null,train:null,train2:null,tram:null,triangular_flag_on_post:null,triangular_ruler:null,trident:null,triumph:null,trolleybus:null,trollface:null,trophy:null,tropical_drink:null,tropical_fish:null,truck:null,trumpet:null,tshirt:null,tulip:null,turtle:null,tv:null,twisted_rightwards_arrows:null,two:null,two_hearts:null,two_men_holding_hands:null,two_women_holding_hands:null,u5272:null,u5408:null,u55b6:null,u6307:null,u6708:null,u6709:null,u6e80:null,u7121:null,u7533:null,u7981:null,u7a7a:null,uk:null,umbrella:null,unamused:null,underage:null,unlock:null,up:null,us:null,v:null,vertical_traffic_light:null,vhs:null,vibration_mode:null,video_camera:null,video_game:null,violin:null,virgo:null,volcano:null,vs:null,walking:null,waning_crescent_moon:null,waning_gibbous_moon:null,warning:null,watch:null,water_buffalo:null,watermelon:null,wave:null,wavy_dash:null,waxing_crescent_moon:null,waxing_gibbous_moon:null,wc:null,weary:null,wedding:null,whale:null,whale2:null,wheelchair:null,white_check_mark:null,white_circle:null,white_flower:null,white_square:null,white_square_button:null,wind_chime:null,wine_glass:null,wink:null,wink2:null,wolf:null,woman:null,womans_clothes:null,womans_hat:null,womens:null,worried:null,wrench:null,x:null,yellow_heart:null,yen:null,yum:null,zap:null,zero:null,zzz:null}};return new e}(),initLog=function(){window.DEBUG_MODE&&console?_.isFunction(console.log)?window.LOG=_.bind(console.log,console):console.log&&(window.LOG=function(){console.log(Array.prototype.slice.apply(arguments))}):window.LOG=function(){}};initLog(),window.require&&"function"==typeof require&&require(["config"],initLog),define("util",["spin","config","lib/jquery.cookie","blackswan/requestAnimationFrame","underscore"],function(e){return function(){var t,i;return i=function(e){return window.Spinner=e,this.util},t=i.apply(e,arguments),t||e.util}}(this)),define("app",["require","backbone"],function(e){var t=e("backbone");return new t.Model}),define("store",["require","class","config"],function(e){var t=e("class"),i=e("config"),n=t.extend({options:{ctor:Object,key:"_id",objKey:"cid",cleanupName:"cleanup",trackReferenceOwners:i.DEBUG_MODE},init:function(e){e=this.options=_.extend({},this.options,e),this._counter={},this._keyMap={},this.cid=_.uniqueId("store")},get:function(e,t){var i=_.isString(this.options.key)?e[0][this.options.key]:this.options.key.apply(null,e),n=this._counter[i];if(!n){var o=util.applyNew(this.options.ctor,e);n=this._counter[i]={count:0,obj:o},this.options.trackReferenceOwners&&(n.owners=[]);var s=_.isString(this.options.objKey)?_.result(o,this.options.objKey):this.options.objKey.call(o,o);this._keyMap[s]=i}return n.count+=1,this.options.trackReferenceOwners&&t&&n.owners.push(t),n.obj},release:function(e,t){var i,n=_.isString(this.options.objKey)?_.result(e,this.options.objKey):this.options.objKey.call(e,e),o=this._keyMap[n],s=this._counter[o];o&&s&&(this.options.trackReferenceOwners&&t&&(i=s.owners.indexOf(t),-1===i)||(s.count-=1,0===s.count?this._releaseContainer(n,o):this.options.trackReferenceOwners&&t&&s.owners.splice(i,1)))},has:function(e){var t=_.isString(this.options.key)?e[0][this.options.key]:this.options.key.apply(null,e),i=this._counter[t];return i?!0:!1},_releaseContainer:function(e,t){var i=this._counter[t].obj;i[this.cleanupName]&&i[this.cleanupName](),delete this._counter[t],delete this._keyMap[e]}},{_name:"Store"}),o=new n({ctor:n,key:"name"});return{Store:n,stores:o}}),define("tt-common",["require","underscore","util","app","config"],function(e){var t=e("underscore"),i=e("util"),n=e("app"),o=e("config"),s={getRoomUrl:function(e){var t=e.shortcut||e.roomid||e.id;return"/"+t},sendIEMessageProxy:function(e){var t=$.Deferred(),n=document.createElement("iframe"),o=function(){document.body.removeChild(n),window.removeEventListener("message",s)},s=function(s){if(i.endsWith(s.origin,"turntable.fm")){var r=JSON.parse(s.data);r.ready?n.contentWindow.postMessage(JSON.stringify(e),n.src):"success"===r.result?(e.success&&e.success(r.response),t.resolve(r.response),o()):"error"===r.result&&(e.error&&e.error(r.response),t.reject(r.response),o())}};return n.setAttribute("src","https://"+window.location.host+"/ie_message_proxy"),n.setAttribute("id","ie-message-proxy"),document.body.appendChild(n),window.addEventListener("message",s,!1),t.promise()},crossDomainAjaxRequest:function(e){return e.dataType="json",e.xhrFields={withCredentials:!0},e.retryLimit=5,window.XDomainRequest&&$.browser.msie&&$.browser.version<10?s.sendIEMessageProxy(e):$.ajax(e)},apiGet:function(e,t){if(o.IS_FRAMED)return!1;var i=s.prepareWebApiCall(e,t),n=i.ajaxParams;return e=i.obj,n.type="GET",n.data=e,s.dispatchRequest(n)},apiPost:function(e,t){if(o.IS_FRAMED)return!1;var i=s.prepareWebApiCall(e,t),n=i.ajaxParams,r=JSON.stringify(i.obj);return n.type="POST",n.contentType="application/json; charset=utf-8",n.data=r,s.dispatchRequest(n)},dispatchRequest:function(e,i,n){var o=$.Deferred();return LOG("Dispatching API",e.type,"to",e.url+":",JSON.stringify(e.data)),$.ajax(e).done(function(s){LOG("Received API "+e.type+":",JSON.stringify(s)),s[0]?(t.isFunction(n)&&n(s[1])===!1&&o.reject(t.extend(s[1],{err:i.validationError,type:"validation error"})),o.resolve(s[1])):o.reject(t.extend(s[1],{type:"api error"}))}).fail(function(e,t){o.reject({err:t,type:"jqXHR error"})}),o.promise()},prepApiData:function(e){var t=n.userAuth||n.user;return t&&t.id&&!e.userid&&(e.userid=t.id,e.userauth=t.auth),e.client="web",e.decache=(new Date).valueOf(),e},prepareWebApiCall:function(e,i){e=s.prepApiData(t.clone(e));var n=e.api;delete e.api;var o="/api/"+n,r={},a=!1;return(i||"password"in e)&&"https:"!==window.location.protocol&&(o="https://"+window.location.host+o,r.withCredentials=!0,a=!0),{obj:e,ajaxParams:{url:o,dataType:"json",xhrFields:r,crossDomain:a,traditional:!0}}},toSnakeCase:function(e){return e.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()})},toCamelCase:function(e){return e.replace(/(\-[a-z])/g,function(e){return e.toUpperCase().replace("-","")})},modalCloseOverride:function(){return n.router.navigateHome(),!1}};return s}),define("lib/backbone.queryparams",["underscore","backbone"],function(e,t){function i(t,i){var n=t.split("&");e.each(n,function(e){var t=e.indexOf("="),n=[e.slice(0,t),e.slice(t+1)];n.length>1&&i(n[0],n[1])})}"undefined"!=typeof require&&(e=e||require("underscore"),t=t||require("backbone"));var n=/^\?(.*)/,o=/\((.*?)\)/g,s=/(\(\?)?:\w+/g,r=/\*\w+/g,a=/[\-{}\[\]+?.,\\\^$|#\s]/g,l=/(\?.*)$/,u=/^([^\?]*)/,d=/(\?)[\w-]+=/i,h=/[\:\*]([^\:\?\/\(\)]+)/g,c=/^[#\/]|\s+$/g,p=/\/$/;t.Router.arrayValueSplit="|";var f=function(e,t){if(null==e)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var i=this.root.replace(p,""),n=this.location.search;e.indexOf(i)||(e=e.substr(i.length)),n&&(e+=n)}else e=this.getHash();return e.replace(c,"")};e.extend(t.History.prototype,{getFragment:function(e){var t=this._wantsHashChange&&this._wantsPushState&&!this._hasPushState,i=f.apply(this,arguments);return null!=e||d.test(i)?t&&(i=i.replace(l,"")):i+=this.location.search,i},getQueryParameters:function(t){t=f.apply(this,arguments);var o=t.replace(u,""),s=o.match(n);if(s){o=s[1];var r={};return i(o,function(t,i){r[t]?e.isString(r[t])?r[t]=[r[t],i]:r[t].push(i):r[t]=i}),r}return{}}}),e.extend(t.Router.prototype,{initialize:function(e){this.encodedSplatParts=e&&e.encodedSplatParts},getFragment:function(e,t,i){return e=f.apply(this,arguments),i&&(e=e.replace(l,"")),e},_routeToRegExp:function(t){var i=r.exec(t)||{index:-1},n=s.exec(t)||{index:-1},l=t.match(h)||[];t=t.replace(a,"\\$&").replace(o,"(?:$1)?").replace(s,function(e,t){return t?e:"([^\\/\\?]+)"}).replace(r,"([^?]*?)"),t+="([?]{1}.*)?";var u=new RegExp("^"+t+"$");return i.index>=0&&(u.splatMatch=n>=0?i.index-n.index:-1),u.paramNames=e.map(l,function(e){return e.substring(1)}),u.namedParameters=this.namedParameters,u},_extractParameters:function(o,s){var r=o.exec(s).slice(1),a={};r.length>0&&e.isUndefined(r[r.length-1])&&r.splice(r.length-1,1);var l=r.length&&r[r.length-1]&&r[r.length-1].match(n);if(l){var u=l[1],d={};if(u){var h=this;i(u,function(e,t){h._setParamValue(e,t,d)})}r[r.length-1]=d,e.extend(a,d)}var c=r.length;if(o.splatMatch&&this.encodedSplatParts){if(o.splatMatch<0)return r;c-=1}for(var p=0;c>p;p++)e.isString(r[p])&&(r[p]=decodeURIComponent(r[p]),o.paramNames.length>=p-1&&(a[o.paramNames[p]]=r[p]));return t.Router.namedParameters||o.namedParameters?[a]:r},_setParamValue:function(e,t,i){for(var n=e.split("."),o=i,s=0;s<n.length;s++){var r=n[s];s===n.length-1?o[r]=this._decodeParamValue(t,o[r]):o=o[r]=o[r]||{}}},_decodeParamValue:function(i,n){var o=t.Router.arrayValueSplit;if(i=decodeURIComponent((i+"").replace(/\+/g,"%20")),i.indexOf(o)>=0){for(var s=i.split(o),r=s.length-1;r>=0;r--)s[r]?s[r]=decodeURIComponent(s[r]):s.splice(r,1);return s}return n?e.isArray(n)?(n.push(decodeURIComponent(i)),n):[n,decodeURIComponent(i)]:decodeURIComponent(i)},toFragment:function(t,i){return i&&(e.isString(i)||(i=this._toQueryString(i)),i&&(t+="?"+i)),t},_toQueryString:function(i,n){function o(e){return String(e).replace(s,encodeURIComponent(s))}var s=t.Router.arrayValueSplit;if(!i)return"";n=n||"";var r="";for(var a in i){var l=i[a];if(e.isString(l)||e.isNumber(l)||e.isBoolean(l)||e.isDate(l))l=this._toQueryParam(l),(e.isBoolean(l)||e.isNumber(l)||l)&&(r+=(r?"&":"")+this._toQueryParamName(a,n)+"="+o(encodeURIComponent(l)));else if(e.isArray(l)){for(var u="",d=0;d<l.length;d++){var h=this._toQueryParam(l[d]);(e.isBoolean(h)||h)&&(u+=s+o(h))}u&&(r+=(r?"&":"")+this._toQueryParamName(a,n)+"="+u)}else{var c=this._toQueryString(l,this._toQueryParamName(a,n,!0));c&&(r+=(r?"&":"")+c)}}return r},_toQueryParamName:function(e,t,i){return t+e+(i?".":"")},_toQueryParam:function(t){return e.isNull(t)||e.isUndefined(t)?null:t}})}),define("tt-base",["require","underscore","backbone","class","util","app","store","tt-common","lib/backbone.queryparams"],function(e){var t=e("underscore"),i=e("backbone"),n=e("class"),o=e("util"),s=e("app"),r=e("store"),a=e("tt-common");e("lib/backbone.queryparams");var l=function(){},u=function(e){return function(){var i=n.extend.apply(this,arguments),o=i.prototype,s=Object.getPrototypeOf(o);return t.each(e,t.bind(h,null,o,s)),i}},d=function(){var e=this,i=function(i){e[i]=t.bind(e[i],e)
};t.each(t.result(this,"methodsToBind"),function(n){n instanceof RegExp?t.chain(t.functions(e)).filter(function(e){return n.test(e)}).each(i):i(n)})},h=function(e,i,n){i[n]&&e.hasOwnProperty(n)&&(e[n]instanceof Array?e[n]=i[n].concat(e[n]):e[n]instanceof Object&&(e[n]=t.extend({},i[n],e[n])))},c=function(e,t){e.release(t,this)},p=function(e,t){var i=this._stores[t]=r.stores.get([{name:e}],this),n=o.capitalize(t),s=this["_retrieved"+n]=[];this["get"+n]=function(){var e=Array.prototype.slice.call(arguments),t=i.get(e,this);return s.push(t),t},this["release"+n]=function(e){var t=s.indexOf(e);return-1===t?!1:(i.release(e,this),s.splice(t,1),!0)}},f=function(e,i){var n=this._stores[i],s=o.capitalize(i),a=this["_retrieved"+s];t.each(a,t.bind(c,this,n)),r.stores.release(n,this),this["get"+s]=this["release"+s]=void 0},m=function(){this._stores={},t.each(this.stores,p,this)},g=function(){t.each(this.stores,f,this),this._stores=void 0},v={read:"GET",create:"POST",update:"POST",patch:"POST"},b=t.once(function(){return s.turntable&&s.turntable.ZxcLsz});i.sync=function(e,i,n){var o=v[e];if(!o)return!1;n||(n={});var r=n.attrs||{};r.api=n.api||i.api;var l;if(n.websocket&&b()){var u=n.success;l=s.turntable.ZxcLsz(r,function(e){e.success&&u(t.omit(e,"msgid","success"))===!1&&(e.success=!1)}).fail(n.error)}else{var d=a.prepareWebApiCall(r),h=d.ajaxParams;"POST"==o?(h.data=JSON.stringify(d.obj),h.contentType="application/json; charset=utf-8"):h.data=d.obj,h.type=o,l=a.dispatchRequest(h,i,n.success).fail(n.error)}return i.trigger("request",i,l,n),l};var w={addSubview:function(e,t){return(this._subviews||(this._subviews=[])).push(e),t&&(this[t]=e),e},removeSubviews:function(e){t.invoke(this._subviews,"remove",e),this._subviews=void 0,t.each(this._subviewNames,this._derefSubview),this._subviewNames=void 0},_derefSubview:function(e){this[e]=void 0}},y=function(){d.call(this),this.stores&&m.call(this),this.init.apply(this,arguments)};t.extend(y.prototype,i.Events,{init:l,cleanup:function(){this.stores&&g.call(this)}}),y.extend=u(["stores"]);var _=n.extend,x=_.call(i.Collection,{initialize:y,init:l,cleanup:function(){this.stopListening(),this.stores&&g.call(this)}},{_name:"Collection"});x.extend=u(["stores"]),u(["methodsToBind","subModels"]);var S=_.call(i.Model,{idAttribute:"_id",initialize:y,init:l,set:function(e,i,n){if(!this.subModels)return this._super.apply(this,arguments);"object"==typeof e?(attrs=e,n=i):(attrs={})[e]=i;var o=this._changing;this._changing=!0;var s=t.keys(this.subModels),r=t.pick(attrs,s),a=t.some(t.map(r,this._mergeSubModel,this));this._changing=o;var l=!1,u=function(){l=!0};this.once("change",u),this._super(t.omit(attrs,s),n),this.off("change",u),l||!a||o||this.trigger("change",this,n)},_mergeSubModel:function(e,t){var i=this.subModels[t],n=this.get(t);if("object"==typeof i&&(i=i.ctor),n instanceof i&&!(e instanceof i)){var o=!1,s=function(){o=!0};return n.once("change",s),n.set(e),n.off("change",s),o}return n===e?!1:(this._setSubModel(t,e),!0)},_setSubModel:function(e,i){var n,o=this.subModels[e],s=this.get(e);"object"==typeof o&&(n=o.options,o=o.ctor),s instanceof o&&this.stopListening(s),i instanceof o||(i=new o(i,n)),this.attributes[e]=i,this.listenTo(i,"change",t.bind(this._manualTrigger,this,e,i)),this._manualTrigger(e,i)},_manualTrigger:function(e,t){this.trigger("change:"+e,this,t),this._changing||this.trigger("change",this)},cleanup:function(){this.stopListening(),this.stores&&g.call(this)}},{_name:"Model"});S.extend=u(["stores"]);var k=u(["options","events","methodsToBind","stores"]),C=k.call(i.View,{options:{idd:"view"},_configure:function(){d.call(this),this._super.apply(this,arguments),this.nodes={},this.children={}},setElement:function(e,t){var i=e instanceof Array;i&&(e=o.buildTree(e,this.nodes)),this._super(e,t),i&&(this.options.id&&(this.el.id=this.options.id),this.options.className&&this.$el.addClass(this.options.className)),this.options.style&&this.$el.css(this.options.style),this.options["class"]&&this.$el.attr("class",this.options["class"])},initialize:function(e,t){this.nodes.childrenPlaceholder&&t&&($(this.nodes.childrenPlaceholder).replaceWith(t),this.nodes.childrenPlaceholder=void 0),this.stores&&m.call(this),this.init.apply(this,arguments)},init:l,build:function(e){var i,n,s=this.constructor.layouts,r=s[e];return t.isFunction(r)?(i=Array.prototype.slice.call(arguments,1),n=r.apply(s,i)):n=r,o.buildTree(n,this.nodes)},addSubView:function(e,t){if(!(t instanceof C))throw new Error("Subviews must be a TTBase.View");return this.children[e]=t,this},renderSubView:function(e,t){var i=this.children[e];this._renderSubView(e,i,t)},renderSubViews:function(e){var t=this.children;for(var i in t)this._renderSubView(i,t[i],e);return this},_renderSubView:function(e,t,i){"undefined"==typeof i&&(i=!0),i&&this.attachSubView(e),t.render()},removeSubView:function(e,t){var i=this.children[e];this._removeSubView(e,i,t)},removeSubViews:function(e){var t=this.children;for(var i in t)this._removeSubView(i,t[i],e);return this},_removeSubView:function(e,t,i){"undefined"==typeof i&&(i=!0),i&&this.detachSubView(e),t.remove(),this.children[e]=null},attachSubView:function(e){var t=this.children[e],i=this.nodes[e];t&&i&&($(i).replaceWith(t.el),this.nodes[e]=t.el)},detachSubView:function(e){var t=this.children[e],i=this.nodes[e];if(t&&i){var n=o.buildTree(["div",{style:{display:"none"}}]);t.$el.replaceWith(n),this.nodes[e]=n}},remove:function(e){return this.stores&&g.call(this),this.rivetsView&&this.rivetsView.unbind(),this.removeSubViews(e)._super()}},{_name:"View"});C.Children=["div##childrenPlaceholder",{style:{display:"none"}}],C.extend=k;var T=/\((.*?)\)/g,I=/(\(\?)?:(\w+)/g,M=window.location.href.split("turntable.fm/")[1],P=!0;i.Router.namedParameters=!0;var A=_.call(i.Router,{methodsToBind:["setTitle","navigateHome"],initialize:function(e,i){if(this._routes={},e&&t.map(e,t.bind(this.route,this)),i.routeLinks){var n=this;$(function(){$("body").on("click","a[href^='/']",function(e){var t=$(e.currentTarget);if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||"_blank"==t.attr("target")||"true"===t.attr("data-no-route"))){var i=t.attr("href").replace(/^\//,"");n.hasRouteForFragment(i)&&(e.preventDefault(),n.navigate(i,{trigger:!0}))}})})}i.title&&(this.title=i.title),this.on("route",this.trackPageview),y.apply(this,arguments)},init:l,trackPageview:function(){var e=i.history.getFragment();P&&(P=!1,e===M)||_gaq.push(["_trackPageview","/"+e])},setTitle:function(e){var t="";this.title&&(t+=this.title),e&&(t+=(this.title?" - ":"")+e),document.title=t},route:function(e){var i=e.path,n=function(){var t=Array.prototype.slice.call(arguments);e.page&&!this._arePagesEqual(e.page,t)?(this.currentPage&&this.currentPage.cleanup(e),this.currentPage=o.applyNew(e.page,t),this.currentPageArgs=t):e.modal&&this.currentPage&&this.currentPage.clearModals&&this.currentPage.clearModals(),this.currentPage?this.currentPage.loadingTitle.done(this.setTitle):e.title&&this.setTitle(e.title),this.currentModal&&this.currentModal.cleanup(e),this.currentModal=void 0,e.modal&&(this.currentModal=o.applyNew(e.modal,t),this.currentModal.loadingTitle.done(this.setTitle))},s=i;return t.isRegExp(i)||(i=this._routeToRegExp(i)),this._routes[e.name]=t.extend({},e,{route:i,path:s,callback:n}),this._super(s,n)},setRoute:function(e,t,n,o){var s=this._routes[e];if(!s)return!1;if(s.callback.call(this,t,n)===!1)return!1;var r=this.toFragment(e,t);return r=i.history.getFragment(r),this.navigate(r,o),this.trackPageview(),!0},navigateHome:function(){this.navigate(s.baseUrl,{trigger:!0})},hasRoute:function(e){return this._routes.hasOwnProperty(e)},hasRouteForFragment:function(e){e=i.history.getFragment(e);var n=t.any(i.history.handlers,function(t){return t.route.test(e)?!0:void 0});return n},toFragment:function(e,i){var n=this._routes[e];if(!n)return!1;i=t.clone(i);var o=n.path.replace(I,function(e,t,n){if(i.hasOwnProperty(n)){var o=i[n];return delete i[n],t?t+o:o}return""}).replace(T,"");return this._super(o,i)},_arePagesEqual:function(e,i){return this.currentPage&&e.prototype===Object.getPrototypeOf(this.currentPage)&&t.isEqual(i[0],this.currentPageArgs[0])?!0:!1}},{_name:"Router"});return x.extend=S.extend=y.extend=_,C.extend=k,A.extend=_,{Class:y,Collection:x,Model:S,View:C,Router:A,Layout:w}}),define("models/product",["require","tt-base","util"],function(e){var t=e("tt-base"),i=e("util"),n=function(e){return 100*e},o=function(e){return e/100},s=function(e){return i.commafy(e.toFixed(2))},r=t.Model.extend({defaults:{quantity:1},get:function(e,t){var i=this._super(e);return t&&t.dollars&&(i=s(o(i))),i},setPrice:function(e){return this.set("price",n(e))},validate:function(e){return e.price?void 0:"A product needs a price"}},{_name:"Product"});return r.dollarToCents=n,r.centsToDollars=o,r.prettyCurrency=s,r}),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},i=[].slice,n={}.hasOwnProperty,o=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},s=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};e={},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),e.Binding=function(){function n(i,n,o,s,r,a){var l,u,d,h;if(this.view=i,this.el=n,this.type=o,this.key=s,this.keypath=r,this.options=null!=a?a:{},this.update=t(this.update,this),this.unbind=t(this.unbind,this),this.bind=t(this.bind,this),this.publish=t(this.publish,this),this.sync=t(this.sync,this),this.set=t(this.set,this),this.eventHandler=t(this.eventHandler,this),this.formattedValue=t(this.formattedValue,this),!(this.binder=e.internalBinders[this.type]||this.view.binders[o])){h=this.view.binders;for(l in h)d=h[l],"*"!==l&&-1!==l.indexOf("*")&&(u=new RegExp("^"+l.replace("*",".+")+"$"),u.test(o)&&(this.binder=d,this.args=new RegExp("^"+l.replace("*","(.+)")+"$").exec(o),this.args.shift()))}this.binder||(this.binder=this.view.binders["*"]),this.binder instanceof Function&&(this.binder={routine:this.binder}),this.formatters=this.options.formatters||[],this.model=this.key?this.view.models[this.key]:this.view.models}return n.prototype.formattedValue=function(e){var t,n,o,s,r,a;for(a=this.formatters,s=0,r=a.length;r>s;s++)n=a[s],t=n.split(/\s+/),o=t.shift(),n=this.model[o]instanceof Function?this.model[o]:this.view.formatters[o],(null!=n?n.read:void 0)instanceof Function?e=n.read.apply(n,[e].concat(i.call(t))):n instanceof Function&&(e=n.apply(null,[e].concat(i.call(t))));return e},n.prototype.eventHandler=function(e){var t,i;return i=(t=this).view.config.handler,function(n){return i.call(e,this,n,t)}},n.prototype.set=function(e){var t;return e=e instanceof Function&&!this.binder["function"]?this.formattedValue(e.call(this.model)):this.formattedValue(e),null!=(t=this.binder.routine)?t.call(this,this.el,e):void 0},n.prototype.sync=function(){return this.set(this.options.bypass?this.model[this.keypath]:this.view.config.adapter.read(this.model,this.keypath))},n.prototype.publish=function(){var t,n,o,s,r,a,l,u,d;for(s=e.Util.getInputValue(this.el),l=this.formatters.slice(0).reverse(),r=0,a=l.length;a>r;r++)n=l[r],t=n.split(/\s+/),o=t.shift(),(null!=(u=this.view.formatters[o])?u.publish:void 0)&&(s=(d=this.view.formatters[o]).publish.apply(d,[s].concat(i.call(t))));return this.view.config.adapter.publish(this.model,this.keypath,s)},n.prototype.bind=function(){var e,t,i,n,o,s,r,a,l;if(null!=(s=this.binder.bind)&&s.call(this,this.el),this.options.bypass?this.sync():(this.view.config.adapter.subscribe(this.model,this.keypath,this.sync),this.view.config.preloadData&&this.sync()),null!=(r=this.options.dependencies)?r.length:void 0){for(a=this.options.dependencies,l=[],n=0,o=a.length;o>n;n++)e=a[n],/^\./.test(e)?(i=this.model,t=e.substr(1)):(e=e.split("."),i=this.view.models[e.shift()],t=e.join(".")),l.push(this.view.config.adapter.subscribe(i,t,this.sync));return l}},n.prototype.unbind=function(){var e,t,i,n,o,s,r,a,l;if(null!=(s=this.binder.unbind)&&s.call(this,this.el),this.options.bypass||this.view.config.adapter.unsubscribe(this.model,this.keypath,this.sync),null!=(r=this.options.dependencies)?r.length:void 0){for(a=this.options.dependencies,l=[],n=0,o=a.length;o>n;n++)e=a[n],/^\./.test(e)?(i=this.model,t=e.substr(1)):(e=e.split("."),i=this.view.models[e.shift()],t=e.join(".")),l.push(this.view.config.adapter.unsubscribe(i,t,this.sync));return l}},n.prototype.update=function(e){var t;return null==e&&(e={}),this.key?e[this.key]&&(this.options.bypass||this.view.config.adapter.unsubscribe(this.model,this.keypath,this.sync),this.model=e[this.key],this.options.bypass?this.sync():(this.view.config.adapter.subscribe(this.model,this.keypath,this.sync),this.view.config.preloadData&&this.sync())):this.sync(),null!=(t=this.binder.update)?t.call(this,e):void 0},n}(),e.ComponentBinding=function(i){function n(i,n,o){var r,a,l,u,d;for(this.view=i,this.el=n,this.type=o,this.unbind=t(this.unbind,this),this.bind=t(this.bind,this),this.update=t(this.update,this),this.locals=t(this.locals,this),this.component=e.components[this.type],this.attributes={},this.inflections={},u=this.el.attributes||[],a=0,l=u.length;l>a;a++)r=u[a],d=r.name,s.call(this.component.attributes,d)>=0?this.attributes[r.name]=r.value:this.inflections[r.name]=r.value}return o(n,i),n.prototype.sync=function(){},n.prototype.locals=function(e){var t,i,n,o,s,r;null==e&&(e=this.view.models),o={},s=this.inflections;for(i in s)t=s[i],o[i]=e[t];for(i in e)n=e[i],null==(r=o[i])&&(o[i]=n);return o},n.prototype.update=function(e){var t;return null!=(t=this.componentView)?t.update(this.locals(e)):void 0},n.prototype.bind=function(){var t,i;return null!=this.componentView?null!=(i=this.componentView)?i.bind():void 0:(t=this.component.build.call(this.attributes),(this.componentView=new e.View(t,this.locals(),this.view.options)).bind(),this.el.parentNode.replaceChild(t,this.el))},n.prototype.unbind=function(){var e;return null!=(e=this.componentView)?e.unbind():void 0},n}(e.Binding),e.View=function(){function n(i,n,o){var s,r,a,l,u,d,h,c,p,f;for(this.els=i,this.models=n,this.options=null!=o?o:{},this.update=t(this.update,this),this.publish=t(this.publish,this),this.sync=t(this.sync,this),this.unbind=t(this.unbind,this),this.bind=t(this.bind,this),this.select=t(this.select,this),this.build=t(this.build,this),this.componentRegExp=t(this.componentRegExp,this),this.bindingRegExp=t(this.bindingRegExp,this),this.els.jquery||this.els instanceof Array||(this.els=[this.els]),h=["config","binders","formatters"],u=0,d=h.length;d>u;u++){if(r=h[u],this[r]={},this.options[r]){c=this.options[r];for(s in c)a=c[s],this[r][s]=a}p=e[r];for(s in p)a=p[s],null==(f=(l=this[r])[s])&&(l[s]=a)}this.build()}return n.prototype.bindingRegExp=function(){var e;return e=this.config.prefix,e?new RegExp("^data-"+e+"-"):/^data-/},n.prototype.componentRegExp=function(){var e,t;return new RegExp("^"+(null!=(e=null!=(t=this.config.prefix)?t.toUpperCase():void 0)?e:"RV")+"-")},n.prototype.build=function(){var t,n,o,r,a,l,u,d,h,c=this;for(this.bindings=[],l=[],t=this.bindingRegExp(),o=this.componentRegExp(),n=function(t,i,n){var o,s,r,a,l,u,d,h,p,f;return u={},p=function(){var e,t,i,o;for(i=n.split("|"),o=[],e=0,t=i.length;t>e;e++)h=i[e],o.push(h.trim());return o}(),o=function(){var e,t,i,n;for(i=p.shift().split("<"),n=[],e=0,t=i.length;t>e;e++)s=i[e],n.push(s.trim());return n}(),d=o.shift(),f=d.split(/\.|:/),u.formatters=p,u.bypass=-1!==d.indexOf(":"),f[0]?a=f.shift():(a=null,f.shift()),l=f.join("."),(r=o.shift())&&(u.dependencies=r.split(/\s+/)),c.bindings.push(new e.Binding(c,t,i,a,l,u))},a=function(r){var u,d,h,p,f,m,g,v,b,w,y,_,x,S,k,C,T,I,M,P,$,A,E,D,R,L,O,j,F,B,N,z;if(s.call(l,r)<0){if(r.nodeType===Node.TEXT_NODE){if(v=e.TextTemplateParser,(f=c.config.templateDelimiters)&&(S=v.parse(r.data,f)).length&&(1!==S.length||S[0].type!==v.types.text)){switch(y=S[0],w=2<=S.length?i.call(S,1):[],r.data=y.value,y.type){case 0:r.data=y.value;break;case 1:n(r,"textNode",y.value)}for(T=0,$=w.length;$>T;T++)x=w[T],r.parentNode.appendChild(_=document.createTextNode(x.value)),1===x.type&&n(_,"textNode",x.value)}}else if(o.test(r.tagName))k=r.tagName.replace(o,"").toLowerCase(),c.bindings.push(new e.ComponentBinding(c,r,k));else if(null!=r.attributes){for(O=r.attributes,I=0,A=O.length;A>I;I++)if(u=O[I],t.test(u.name)){if(k=u.name.replace(t,""),!(h=c.binders[k])){j=c.binders;for(m in j)C=j[m],"*"!==m&&-1!==m.indexOf("*")&&(b=new RegExp("^"+m.replace("*",".+")+"$"),b.test(k)&&(h=C))}if(h||(h=c.binders["*"]),h.block){for(F=r.childNodes,M=0,E=F.length;E>M;M++)g=F[M],l.push(g);d=[u]}}for(B=d||r.attributes,P=0,D=B.length;D>P;P++)u=B[P],t.test(u.name)&&(k=u.name.replace(t,""),n(r,k,u.value))}for(N=r.childNodes,z=[],L=0,R=N.length;R>L;L++)p=N[L],z.push(a(p));return z}},h=this.els,u=0,d=h.length;d>u;u++)r=h[u],a(r)},n.prototype.select=function(e){var t,i,n,o,s;for(o=this.bindings,s=[],i=0,n=o.length;n>i;i++)t=o[i],e(t)&&s.push(t);return s},n.prototype.bind=function(){var e,t,i,n,o;for(n=this.bindings,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.bind());return o},n.prototype.unbind=function(){var e,t,i,n,o;for(n=this.bindings,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.unbind());return o},n.prototype.sync=function(){var e,t,i,n,o;for(n=this.bindings,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.sync());return o},n.prototype.publish=function(){var e,t,i,n,o;for(n=this.select(function(e){return e.binder.publishes}),o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.publish());return o},n.prototype.update=function(e){var t,i,n,o,s,r,a;null==e&&(e={});for(i in e)n=e[i],this.models[i]=n;for(r=this.bindings,a=[],o=0,s=r.length;s>o;o++)t=r[o],a.push(t.update(e));return a},n}(),e.TextTemplateParser=function(){function e(){}return e.types={text:0,binding:1},e.parse=function(e,t){var i,n,o,s,r,a,l;for(a=[],s=e.length,i=0,n=0;s>n;){if(i=e.indexOf(t[0],n),0>i){a.push({type:this.types.text,value:e.slice(n)});break}if(i>0&&i>n&&a.push({type:this.types.text,value:e.slice(n,i)}),n=i+2,i=e.indexOf(t[1],n),0>i){r=e.slice(n-2),o=a[a.length-1],(null!=o?o.type:void 0)===this.types.text?o.value+=r:a.push({type:this.types.text,value:r});break}l=e.slice(n,i).trim(),a.push({type:this.types.binding,value:l}),n=i+2}return a},e}(),e.Util={bindEvent:function(e,t,i){return null!=window.jQuery?(e=jQuery(e),null!=e.on?e.on(t,i):e.bind(t,i)):null!=window.addEventListener?e.addEventListener(t,i,!1):(t="on"+t,e.attachEvent(t,i))},unbindEvent:function(e,t,i){return null!=window.jQuery?(e=jQuery(e),null!=e.off?e.off(t,i):e.unbind(t,i)):null!=window.removeEventListener?e.removeEventListener(t,i,!1):(t="on"+t,e.detachEvent(t,i))},getInputValue:function(e){var t,i,n,o;if(null!=window.jQuery)switch(e=jQuery(e),e[0].type){case"checkbox":return e.is(":checked");default:return e.val()}else switch(e.type){case"checkbox":return e.checked;case"select-multiple":for(o=[],i=0,n=e.length;n>i;i++)t=e[i],t.selected&&o.push(t.value);return o;default:return e.value}}},e.binders={enabled:function(e,t){return e.disabled=!t},disabled:function(e,t){return e.disabled=!!t},checked:{publishes:!0,bind:function(t){return e.Util.bindEvent(t,"change",this.publish)},unbind:function(t){return e.Util.unbindEvent(t,"change",this.publish)},routine:function(e,t){var i;return e.checked="radio"===e.type?(null!=(i=e.value)?i.toString():void 0)===(null!=t?t.toString():void 0):!!t}},unchecked:{publishes:!0,bind:function(t){return e.Util.bindEvent(t,"change",this.publish)},unbind:function(t){return e.Util.unbindEvent(t,"change",this.publish)},routine:function(e,t){var i;return e.checked="radio"===e.type?(null!=(i=e.value)?i.toString():void 0)!==(null!=t?t.toString():void 0):!t}},show:function(e,t){return e.style.display=t?"":"none"},hide:function(e,t){return e.style.display=t?"none":""},html:function(e,t){return e.innerHTML=null!=t?t:""},value:{publishes:!0,bind:function(t){return e.Util.bindEvent(t,"change",this.publish)},unbind:function(t){return e.Util.unbindEvent(t,"change",this.publish)},routine:function(e,t){var i,n,o,r,a,l,u;if(null!=window.jQuery){if(e=jQuery(e),(null!=t?t.toString():void 0)!==(null!=(r=e.val())?r.toString():void 0))return e.val(null!=t?t:"")}else if("select-multiple"===e.type){if(null!=t){for(u=[],n=0,o=e.length;o>n;n++)i=e[n],u.push(i.selected=(a=i.value,s.call(t,a)>=0));return u}}else if((null!=t?t.toString():void 0)!==(null!=(l=e.value)?l.toString():void 0))return e.value=null!=t?t:""}},text:function(e,t){return null!=e.innerText?e.innerText=null!=t?t:"":e.textContent=null!=t?t:""},"if":{block:!0,bind:function(e){var t,i;return null==this.marker?(t=["data",this.view.config.prefix,this.type].join("-").replace("--","-"),i=e.getAttribute(t),this.marker=document.createComment(" rivets: "+this.type+" "+i+" "),e.removeAttribute(t),e.parentNode.insertBefore(this.marker,e),e.parentNode.removeChild(e)):void 0},unbind:function(){var e;return null!=(e=this.nested)?e.unbind():void 0},routine:function(t,i){var n,o,s,r,a;if(!!i==(null==this.nested)){if(i){s={},a=this.view.models;for(n in a)o=a[n],s[n]=o;return r={binders:this.view.options.binders,formatters:this.view.options.formatters,config:this.view.options.config},(this.nested=new e.View(t,s,r)).bind(),this.marker.parentNode.insertBefore(t,this.marker.nextSibling)}return t.parentNode.removeChild(t),this.nested.unbind(),delete this.nested}},update:function(e){return this.nested.update(e)}},unless:{block:!0,bind:function(t){return e.binders["if"].bind.call(this,t)},unbind:function(){return e.binders["if"].unbind.call(this)},routine:function(t,i){return e.binders["if"].routine.call(this,t,!i)},update:function(t){return e.binders["if"].update.call(this,t)}},"on-*":{"function":!0,unbind:function(t){return this.handler?e.Util.unbindEvent(t,this.args[0],this.handler):void 0},routine:function(t,i){return this.handler&&e.Util.unbindEvent(t,this.args[0],this.handler),e.Util.bindEvent(t,this.args[0],this.handler=this.eventHandler(i))}},"each-*":{block:!0,bind:function(e){var t;return null==this.marker?(t=["data",this.view.config.prefix,this.type].join("-").replace("--","-"),this.marker=document.createComment(" rivets: "+this.type+" "),this.iterated=[],e.removeAttribute(t),e.parentNode.insertBefore(this.marker,e),e.parentNode.removeChild(e)):void 0},unbind:function(){var e,t,i,n,o;if(null!=this.iterated){for(n=this.iterated,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.unbind());return o}},routine:function(t,i){var n,o,s,r,a,l,u,d,h,c,p,f,m,g,v,b,w,y,_,x,S;if(u=this.args[0],i=i||[],this.iterated.length>i.length)for(w=Array(this.iterated.length-i.length),m=0,v=w.length;v>m;m++)o=w[m],f=this.iterated.pop(),f.unbind(),this.marker.parentNode.removeChild(f.els[0]);for(S=[],s=g=0,b=i.length;b>g;s=++g)if(l=i[s],n={},n[u]=l,null==this.iterated[s]){y=this.view.models;for(a in y)l=y[a],null==(_=n[a])&&(n[a]=l);h=this.iterated.length?this.iterated[this.iterated.length-1].els[0]:this.marker,d={binders:this.view.options.binders,formatters:this.view.options.formatters,config:{}},x=this.view.options.config;for(r in x)p=x[r],d.config[r]=p;d.config.preloadData=!0,c=t.cloneNode(!0),f=new e.View(c,n,d),f.bind(),this.iterated.push(f),S.push(this.marker.parentNode.insertBefore(c,h.nextSibling))}else this.iterated[s].models[u]!==l?S.push(this.iterated[s].update(n)):S.push(void 0);return S},update:function(e){var t,i,n,o,s,r,a,l;t={};for(i in e)n=e[i],i!==this.args[0]&&(t[i]=n);for(a=this.iterated,l=[],s=0,r=a.length;r>s;s++)o=a[s],l.push(o.update(t));return l}},"class-*":function(e,t){var i;return i=" "+e.className+" ",!t==(-1!==i.indexOf(" "+this.args[0]+" "))?e.className=t?""+e.className+" "+this.args[0]:i.replace(" "+this.args[0]+" "," ").trim():void 0},"*":function(e,t){return t?e.setAttribute(this.type,t):e.removeAttribute(this.type)}},e.internalBinders={textNode:function(e,t){return e.data=null!=t?t:""}},e.components={},e.config={preloadData:!0,handler:function(e,t,i){return this.call(e,t,i.view.models)}},e.formatters={},e.factory=function(t){return t._=e,t.binders=e.binders,t.components=e.components,t.formatters=e.formatters,t.config=e.config,t.configure=function(t){var i,n;null==t&&(t={});for(i in t)n=t[i],e.config[i]=n},t.bind=function(t,i,n){var o;return null==i&&(i={}),null==n&&(n={}),o=new e.View(t,i,n),o.bind(),o}},"object"==typeof exports?e.factory(exports):"function"==typeof define&&define.amd?define("lib/rivets",["exports"],function(t){return e.factory(this.rivets=t),t}):e.factory(this.rivets={})}.call(this),define("rivets",["require","models/product","lib/rivets","util"],function(e){var t=e("models/product"),i=e("lib/rivets"),n=e("util");return i.configure({prefix:"rv",templateDelimiters:["{{","}}"],adapter:{subscribe:function(e,t,i){e.on("change:"+t,i)},unsubscribe:function(e,t,i){e.off("change:"+t,i)},read:function(e,t){return e.get(t)},publish:function(e,t,i){e.set(t,i)}}}),_.extend(i.formatters,{not:function(e){return!e},date:n.prettyDate,messageFilter:function(e){return e?n.brText(n.messageFilter(e)):void 0},linkify:function(e){return e?n.linkify(n.safeText(e)):void 0},dollarfy:function(e){return e?"$"+t.prettyCurrency(t.centsToDollars(e)):void 0},commafy:function(e){return e?n.commafy(e):0==e?"0":void 0}}),_.extend(i.binders,{toggle:{publishes:!0,bind:function(e){this._boundToggle=_.bind(this.binder.toggle,this),$(e).on("click",this._boundToggle)},unbind:function(e){$(e).off("click",this._boundToggle)},toggle:function(){var e=!this.view.config.adapter.read(this.model,this.keypath);this.view.config.adapter.publish(this.model,this.keypath,e)}},"add-class":function(e,t){this._prevValue&&($(e).removeClass(this._prevValue),this._prevValue=void 0),null!=t&&(t=t.toString(),t&&($(e).addClass(t),this._prevValue=t))}}),i}),function(e){function t(e,t){return"function"==typeof e?e.call(t):e}function i(e){for(;e=e.parentNode;)if(e==document)return!0;return!1}function n(t,i){this.$element=e(t),this.options=i,this.enabled=!0,this.fixTitle()}n.prototype={show:function(){var i=this.getTitle();if(i&&this.enabled){var n=this.tip();n.find(".tipsy-inner")[this.options.html?"html":"text"](i),n[0].className="tipsy",n.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body),this.options.className&&n.addClass(t(this.options.className,this.$element[0]));var o,s=e.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight}),r=n[0].offsetWidth,a=n[0].offsetHeight,l=t(this.options.gravity,this.$element[0]);switch(l.charAt(0)){case"n":o={top:s.top+s.height+this.options.offset,left:s.left+s.width/2-r/2};break;case"s":o={top:s.top-a-this.options.offset,left:s.left+s.width/2-r/2};break;case"e":o={top:s.top+s.height/2-a/2,left:s.left-r-this.options.offset};break;case"w":o={top:s.top+s.height/2-a/2,left:s.left+s.width+this.options.offset}}2==l.length&&(o.left="w"==l.charAt(1)?s.left+s.width/2-15:s.left+s.width/2-r+15),n.css(o).addClass("tipsy-"+l),n.find(".tipsy-arrow").addClass("tipsy-arrow-"+l.charAt(0)),this.options.fade?n.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):n.css({visibility:"visible",opacity:this.options.opacity})}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){e(this).remove()}):this.tip().remove()},fixTitle:function(){var e=this.$element;(e.attr("title")||"string"!=typeof e.attr("original-title"))&&e.attr("original-title",e.attr("title")||"").removeAttr("title")},getTitle:function(){var e,t=this.$element,i=this.options;this.fixTitle();var e,i=this.options;return"string"==typeof i.title?e=t.attr("title"==i.title?"original-title":i.title):"function"==typeof i.title&&(e=i.title.call(t[0])),e=(""+e).replace(/(^\s*|\s*$)/,""),e||i.fallback},tip:function(){return this.$tip||(this.$tip=e('<div class="tipsy"></div>').html('<div class="tipsy-arrow outer"></div><div class="tipsy-arrow"></div><div class="tipsy-inner"></div>'),this.$tip.data("tipsy-pointee",this.$element[0])),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},e.fn.tipsy=function(t){function i(i){var o=e.data(i,"tipsy");return o||(o=new n(i,e.fn.tipsy.elementOptions(i,t)),e.data(i,"tipsy",o)),o}function o(){var e=i(this);e.hoverState="in",0==t.delayIn?e.show():(e.fixTitle(),setTimeout(function(){"in"==e.hoverState&&e.show()},t.delayIn))}function s(){var e=i(this);e.hoverState="out",0==t.delayOut?e.hide():setTimeout(function(){"out"==e.hoverState&&e.hide()},t.delayOut)}if(t===!0)return this.data("tipsy");if("string"==typeof t){var r=this.data("tipsy");return r&&r[t](),this}if(t=e.extend({},e.fn.tipsy.defaults,t),t.live||this.each(function(){i(this)}),"manual"!=t.trigger){var a=t.live?"live":"bind",l="hover"==t.trigger?"mouseenter":"focus",u="hover"==t.trigger?"mouseleave":"blur";this[a](l,o)[a](u,s)}return this},e.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover"},e.fn.tipsy.revalidate=function(){e(".tipsy").each(function(){var t=e.data(this,"tipsy-pointee");t&&i(t)||e(this).remove()})},e.fn.tipsy.elementOptions=function(t,i){return e.metadata?e.extend({},i,e(t).metadata()):i},e.fn.tipsy.autoNS=function(){return e(this).offset().top>e(document).scrollTop()+e(window).height()/2?"s":"n"},e.fn.tipsy.autoWE=function(){return e(this).offset().left>e(document).scrollLeft()+e(window).width()/2?"e":"w"},e.fn.tipsy.autoBounds=function(t,i){return function(){var n={ns:i[0],ew:i.length>1?i[1]:!1},o=e(document).scrollTop()+t,s=e(document).scrollLeft()+t,r=e(this);return r.offset().top<o&&(n.ns="n"),r.offset().left<s&&(n.ew="w"),e(window).width()+e(document).scrollLeft()-r.offset().left<t&&(n.ew="e"),e(window).height()+e(document).scrollTop()-r.offset().top<t&&(n.ns="s"),n.ns+(n.ew?n.ew:"")}}}(jQuery),define("lib/jquery.tipsy",function(){}),define("views/favorite",["require","rivets","tt-base","lib/jquery.tipsy"],function(e){var t=e("rivets"),i=e("tt-base");e("lib/jquery.tipsy");var n=i.View.extend({el:function(){return["div.favorite$favorite",{"data-rv-title":"view:getTitle < favorites."+this.options.roomId},["div.favorite-star",{"data-rv-class-favorited":"favorites."+this.options.roomId}]]},events:{click:"onClick"},init:function(){this.rivetsView=t.bind(this.el,{favorites:this.options.favorites,view:this}),this.nodes.$favorite.tipsy({opacity:1,gravity:"nw"})},onClick:function(){var e=this.options.roomId,t=this.options.favorites;t[t.has(e)?"remove":"add"](e),this.nodes.$favorite.tipsy("hide")},getTitle:function(){return this.options.favorites.has(this.options.roomId)?"Remove room from favorites":"Add room to favorites"},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)}},{_name:"FavoriteView"});return n}),define("popout",["require","app","tt-common"],function(e){var t,i=e("app"),n=e("tt-common"),o=!1;return{popOut:function(){window.localStorage.setItem("popout","true"),window.localStorage.setItem("clientId",turntable.clientId);var e=window.innerHeight;window.open(n.getRoomUrl(i.room.roomData),"popout","status=0,toolbar=0,height="+e+",width=360"),o=!0,i.trigger("popOut"),_gaq.push(["_trackEvent","miniplayer","popout"])},resizeToFull:function(){window.resizeTo(800,window.outerHeight),_gaq.push(["_trackEvent","miniplayer","auto expand","true"])},resizeToMini:function(){window.resizeTo(360,window.outerHeight),_gaq.push(["_trackEvent","miniplayer","auto contract","true"])},isPopout:function(){return void 0===t&&(t="true"===window.localStorage.getItem("popout")),t},isPopoutHost:function(){return o},becomePopout:function(){window.localStorage.setItem("popout","")},getClientId:function(){return window.localStorage.getItem("clientId")}}}),define("resize",["require"],function(){var e={canResize:!1},t=function(){e.canResize=!0},i=window.outerWidth,n=window.outerHeight;
return $(window).one("resize",t),window.resizeTo(i-1,n-1),window.resizeTo(i,n),window.setTimeout(function(){$(window).off("resize",t)},1e3),e}),function(e){function t(t){var i=t||window.event,n=[].slice.call(arguments,1),o=0,s=0,r=0;return t=e.event.fix(i),t.type="mousewheel",i.wheelDelta&&(o=i.wheelDelta/120),i.detail&&(o=-i.detail/3),r=o,void 0!==i.axis&&i.axis===i.HORIZONTAL_AXIS&&(r=0,s=-1*o),void 0!==i.wheelDeltaY&&(r=i.wheelDeltaY/120),void 0!==i.wheelDeltaX&&(s=-1*i.wheelDeltaX/120),n.unshift(t,o,s,r),(e.event.dispatch||e.event.handle).apply(this,n)}var i=["DOMMouseScroll","mousewheel"];if(e.event.fixHooks)for(var n=i.length;n;)e.event.fixHooks[i[--n]]=e.event.mouseHooks;e.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=i.length;e;)this.addEventListener(i[--e],t,!1);else this.onmousewheel=t},teardown:function(){if(this.removeEventListener)for(var e=i.length;e;)this.removeEventListener(i[--e],t,!1);else this.onmousewheel=null}},e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery),define("lib/jquery.mousewheel",function(){}),define("draggable",["require","class","util","lib/jquery.mousewheel"],function(e){var t=e("class"),i=e("util");e("lib/jquery.mousewheel");var n,o,s;$(function(){o=$("html"),s=$(window)});var r=t.extend({init:function(e){n||(n=$(".clear-overlay")),0===n.length&&(n=$(i.buildTree(["div.clear-overlay"])).hide().appendTo(document.body)),this.setup=$.proxy(this.setup,this),this._setupOverlay=$.proxy(this._setupOverlay,this),this._endDrag=$.proxy(this._endDrag,this),this._scroll=$.proxy(this._scroll,this),this.cancelDrag=$.proxy(this.cancelDrag,this),this.setCursor=$.proxy(this.setCursor,this),this._setScroll=i.makeDrawer(this,this._setScroll),$.extend(this,e)},setup:function(e){return 1===e.which?(s.one("mousemove",this._setupOverlay).one("mouseup",this._endDrag),this.setupComplete=!0,this.mousedown(e)):void 0},_setupOverlay:function(){o.addClass("dragging"),this.parent&&$(this.parent).append(n),n.css("cursor",this.cursor||"").show().on("mousemove",this.mousemove).one("mouseup",this._endDrag),this.scroller&&(n.on("mousewheel",this._scroll),this._scrollDeltaX=0,this._scrollDeltaY=0)},_endDrag:function(e){this.mouseup(e),this.cancelDrag()},_scroll:function(e,t,i,n){this._scrollDeltaX-=20*i,this._scrollDeltaY-=20*n,this._setScroll(),e.preventDefault()},_setScroll:function(){this.scroller.scrollLeft+=this._scrollDeltaX,this.scroller.scrollTop+=this._scrollDeltaY,this._scrollDeltaX=0,this._scrollDeltaY=0},cancelDrag:function(){this.setupComplete&&(s.off("mousemove",this._setupOverlay).off("mouseup",this._endDrag),n.hide().off("mousemove",this.mousemove).off("mouseup",this._endDrag).css("cursor","").off("mousewheel",this._scroll),o.removeClass("dragging"),this.setupComplete=!1,this.parent&&n.appendTo(document.body))},setCursor:function(e){n.css("cursor",e),this.cursor=e},mousedown:function(){},mousemove:function(){},mouseup:function(){}},{_name:"Draggable"});return r}),define("views/volume-icon",["require","tt-base","draggable"],function(e){var t=e("tt-base");e("draggable");var i="volume-level-";return t.View.extend({el:["div.volume-icon##$icon"],events:{click:"onClick"},init:function(){_.extend(this,this.nodes),this.onVolumeChange(this.model),this.listenTo(this.model,{"change:volume":this.onVolumeChange,"change:mute":this.onVolumeChange})},onClick:function(){this.model.set("mute",!this.model.get("mute"))},onVolumeChange:function(e){var t=e.get("mute")?"mute":Math.round(2*e.get("volume"));this.currentState!==t&&(this.$icon.removeClass(i+this.currentState).addClass(i+t),this.currentState=t)}},{_name:"VolumeSlider"})}),define("views/volume-slider",["require","tt-base","draggable"],function(e){var t=e("tt-base"),i=e("draggable");return t.View.extend({methodsToBind:[/onMouse/],options:{orientation:"vertical"},el:["div.volume-slider##$slider",["div.volume-slider-fill##$fill",["div.volume-slider-knob##$knob"]]],events:{click:"onClick"},init:function(){_.extend(this,this.nodes),this.$el.addClass(this.options.orientation),"vertical"===this.options.orientation?(this.cssProp="height",this.mouseProp="pageY"):(this.cssProp="width",this.mouseProp="pageX");var e=this.volumeKnob=new i({parent:this.options.dragParent,mousedown:this.onMouseDown,mousemove:this.onMouseMove,cursor:"pointer"});this.$knob.on("mousedown",e.setup),this.onVolumeChange(this.model),this.listenTo(this.model,{"change:volume":this.onVolumeChange,"change:mute":this.onVolumeChange}),this.listenTo(this.model,"change:mute",this.onMuteChange),this.onMuteChange(this.model)},onMouseDown:function(e){return this._determineBounds(e),!1},onMouseMove:function(e){var t=e[this.mouseProp]-this.mouseOffsetFromKnobCenter,i=(t-this.min)/this.range;return this.model.set("volume",i),!1},onClick:function(e){this._determineBounds();var t=e[this.mouseProp],i=(t-this.min)/this.range;this.model.set("volume",i)},onVolumeChange:function(e){this.$fill.css(this.cssProp,e.get("mute")?0:100*e.get("volume")+"%")},onMuteChange:function(e){this.$el[(e.get("mute")?"add":"remove")+"Class"]("volume-level-mute")},_determineBounds:function(e){var t=this.$slider.offset();"vertical"===this.options.orientation?(this.max=t.top,this.min=this.max+this.$slider.height(),e&&(this.mouseOffsetFromKnobCenter=e.pageY-this.$fill.offset().top)):(this.min=t.left,this.max=this.min+this.$slider.width(),e&&(this.mouseOffsetFromKnobCenter=e.pageX-(this.$fill.offset().left+this.$fill.width()))),this.range=this.max-this.min}},{_name:"VolumeSlider"})}),define("views/room-settings-options",["require","rivets","tt-base","app","popout","resize","views/volume-icon","views/volume-slider"],function(e){var t=e("rivets"),i=e("tt-base"),n=e("app"),o=e("popout"),s=e("resize"),r=e("views/volume-icon"),a=e("views/volume-slider");return i.View.extend({el:function(){return["ul.dropdown",["li.dropdown-volume-container",[r,{model:n.volume}],[a,{orientation:"horizontal",model:n.volume,dragParent:".settings-dropdown .dropdown"}]],["ul",["li.option.full-view",{"data-rv-if":"prefs.miniplayer"},"Full View"],["li.option.link",{"data-rv-if":"prefs.miniplayer"},["a",{href:"/rooms"},"Switch Room"]],["li.option.link.avatar",["a",{href:"/profile/avatar"},"Change Avatar"]],["li.option.link",["a",{href:"/profile/stickers"},"Laptop Stickers"]],["li.option.link",["a.profile-link",{href:"/profile/"+n.user.id},"Profile"]],["li.option.link",["a",{href:"/account/ignore"},"Ignored Users"]],["li.option.link",{"data-rv-unless":"prefs.miniplayer"},["a",{href:"/graphics"},"Graphics Settings"]],["li.option.split-option#layout-option",{title:"Choose between one or two sidebars","data-rv-unless":"prefs.miniplayer"},["div.description","Layout"],["div.options",["div.option.single-panel",{"data-rv-class-selected":"prefs:isSinglePanel < .layout",data:{layout:"single"}}],["div.option.dual-panel",{"data-rv-class-selected":"prefs:isDualPanel < .layout",data:{layout:"dual"}}]]]],["li.logout","Logout"]]},events:{"click .full-view":"onFullViewClick","click .logout":"onLogoutClick"},init:function(){this.prefs=n.prefs,this.rivetsView=t.bind(this.el,{prefs:this.prefs}),this.$("#layout-option, #zoom-option, #animation-option").tipsy({className:"graphics-option",offset:-8,gravity:"e",fade:!0,opacity:1}).on("click",".option",$.proxy(function(e){var t=$(e.currentTarget).data();this.prefs.set(t)},this))},onFullViewClick:function(){s.canResize?o.resizeToFull():(n.turntable.showAlert("You can return to the full-view by making your browser window wider."),_gaq.push(["_trackEvent","miniplayer","can't auto resize"]))},onLogoutClick:function(){n.user.logout()},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)}},{_name:"RoomSettingsOptions"})}),function(e){function t(t){var i,n=e(this),o=null,s=[],r=null,a=null,l=e.extend({rowSelector:"> li",submenuSelector:"*",submenuDirection:"right",tolerance:75,enter:e.noop,exit:e.noop,activate:e.noop,deactivate:e.noop,exitMenu:e.noop},t),u=3,d=300,h=function(e){s.push({x:e.pageX,y:e.pageY}),s.length>u&&s.shift()},c=function(){a&&clearTimeout(a),w(),l.exitMenu(this)&&(o&&l.deactivate(o),o=null)},p=function(){a&&clearTimeout(a),l.enter(this),w(this)},f=function(){l.exit(this)},m=function(){p.call(o)},g=function(){f.call(o)},v=function(){b(this)},b=function(t){t!=o&&(o&&(l.deactivate(o),i&&i.off("mouseenter",m).off("mouseleave",g)),i=e(l.activate(t)),i.on("mouseenter",m).on("mouseleave",g),o=t)},w=function(e){var t=y();t?a=setTimeout(function(){w(e)},t):b(e)},y=function(){function t(e,t){return(t.y-e.y)/(t.x-e.x)}if(!o||!e(o).is(l.submenuSelector))return 0;var a=n.offset(),u={x:a.left,y:a.top-l.tolerance},h={x:a.left+n.outerWidth(),y:u.y},c={x:a.left,y:a.top+n.outerHeight()+l.tolerance},p={x:a.left+n.outerWidth(),y:c.y},f=s[s.length-1],m=s[0];if(!f)return 0;if(m||(m=f),m.x<a.left||m.x>p.x||m.y<a.top||m.y>p.y)return 0;if(r&&f.x==r.x&&f.y==r.y)return 0;var g=i.outerWidth(),v=i.outerHeight();a=i.offset(),u={x:a.left,y:a.top-l.tolerance},h={x:a.left+g,y:u.y},c={x:a.left,y:a.top+v+l.tolerance},p={x:a.left+g,y:c.y};var b=u,w=c;"left"==l.submenuDirection?(b=p,w=h):"below"==l.submenuDirection?(b=h,w=u):"above"==l.submenuDirection&&(b=c,w=p);var y=t(f,b),_=t(f,w),x=t(m,b),S=t(m,w);return x>y&&_>S?(r=f,d):(r=null,0)};n.mouseleave(c).find(l.rowSelector).mouseenter(p).mouseleave(f).click(v),e(document).mousemove(h)}e.fn.menuAim=function(e){return this.each(function(){t.call(this,e)}),this}}(jQuery),define("lib/jquery.menu-aim",function(){}),define("views/settings-dropdown",["require","tt-base","lib/jquery.menu-aim"],function(e){var t=e("tt-base");return e("lib/jquery.menu-aim"),t.View.extend({methodsToBind:["_show","_hide"],el:["div#settings.settings-dropdown",["div.settings-button"],t.View.Children],init:function(){this.$el.menuAim({activate:this._show,deactivate:this._hide,rowSelector:".settings-button",submenuDirection:"below",tolerance:5})},_show:function(e){return e?(this.$el.addClass("visible"),this.$(".dropdown")):void 0},_hide:function(e){e&&this.$el.removeClass("visible")}},{_name:"SettingsDropdown"})}),define("views/header",["require","tt-base","app","views/favorite","popout","views/room-settings-options","views/settings-dropdown","tt-common","lib/jquery.tipsy"],function(e){var t=e("tt-base"),i=e("app"),n=e("views/favorite"),o=e("popout"),s=e("views/room-settings-options"),r=e("views/settings-dropdown");e("tt-common"),e("lib/jquery.tipsy");var a=t.View.extend({methodsToBind:["onRoomLoad"],options:{idd:"header"},el:function(){return["div.header-bar",["div.header-content",["a.header-logo",{href:"/"}],["div.header-room",["div##$favContainer.header-favorite-container"],["div##$roomName.header-room-name"],["div.header-social",["div.header-room-facebook",{title:"Share on Facebook"}],["div.header-room-twitter",{title:"Share on Twitter"}]]],["div.header-buttons",["div.header-search",{title:"Search rooms"}],["div.header-pop-out",{title:"Pop out miniplayer"}],[r,[s]]]]]},events:{"click .header-pop-out":"_popOut","click .header-search":"_showRoomSearch"},init:function(){this.listenTo(i,"room:join",this.onRoomJoin),this.$(".header-room-facebook, .header-room-twitter, .header-search, .header-pop-out").tipsy({opacity:1,gravity:"ne"})},onRoomJoin:function(e){this.currentRoom=e,e.loading.done(this.onRoomLoad),this.favoriteView&&this.favoriteView.remove(),this.favoriteView=new n({roomId:e.roomId,favorites:i.favorites}),this.nodes.$favContainer.append(this.favoriteView.el)},onRoomLoad:function(){this.nodes.$roomName.text(this.currentRoom.roomData.name)},_popOut:function(){o.isPopout()?window.resizeTo(360,window.outerWidth):o.popOut()},_showRoomSearch:function(){i.router.setRoute("rooms")}},{_name:"HeaderView"});return a}),define("views/avatar-head",["require","tt-base","util","app"],function(e){var t=e("tt-base"),i=e("util"),n=e("app");return t.View.extend({methodsToBind:["_onImageLoad"],options:{scale:.5,dark:!1,model:void 0},el:function(){return["div.avatar-head"+(this.options.dark?".dark":"")]},init:function(){this.listenTo(this.model,"change:avatarId",this._onAvatarChange),this._onAvatarChange(this.model)},_onAvatarChange:function(e){var t,o=e.get("avatarId");t=n.avatars&&n.avatars[o]&&n.avatars[o].images.hf?n.avatars[o].images.hf:e.get("images").headfront,i.loadImage(t).done(this._onImageLoad)},_onImageLoad:function(e){this.$el.css({backgroundImage:"url("+e.src+")",backgroundSize:e.width*this.options.scale})}},{_name:"AvatarHead"})}),define("views/message",["require","rivets","tt-base","views/avatar-head","util"],function(e){var t=e("rivets"),i=e("tt-base"),n=e("views/avatar-head"),o=e("util");return i.View.extend({stores:{user:"users"},el:function(){return["li.message-view.no-hover"+(this.options.startsWithMe?".self-action":""),["div.message-username",{"data-rv-text":"user.name"}],["ul.message-fragments##$fragments"]]},init:function(){this.sender=this.getUser({_id:this.model.get("senderid")}),this.options.startsWithMe||this.sender.loading.done(_.bind(this.addAvatarHead,this)),this.rivetsView=t.bind(this.el,{user:this.sender}),this.addMessage(this.model)},addAvatarHead:function(){var e=new n({model:this.sender,scale:.5});this.$el.prepend(e.el)},addMessage:function(e){var t=e.get("text");this.options.startsWithMe&&(t=t.substr(3)),this.nodes.$fragments.append(o.buildTree(["li.message-fragment",o.domify(o.messageFilter(t))]))},remove:function(){this.rivetsView.unbind(),this.releaseUser(this.sender),this._super.apply(this,arguments)}},{_name:"MessageView"})}),define("views/message-history",["require","rivets","tt-base","app","views/message"],function(e){var t=(e("rivets"),e("tt-base")),i=e("app"),n=e("views/message"),o=t.View.extend({options:{idd:"messageHistoryView"},el:["ul.message-history"],events:{scroll:"_onScroll"},init:function(){this._onScroll=_.debounce(this._onScroll,50),this._delayedUpdateScroll=_.debounce(this._updateScroll,50),this.isAtBottom=!0,this.onSync(),this.listenTo(this.collection,{add:this.onAddModel,sync:this.onSync}),this.user=this.options.conversation.user,this.listenTo(this.user,"change:status",this._onStatusChange),this.listenTo(i.user,"change:blocked",this._onBlockChange),this.isBlocked=i.user.isBlocked(this.user.id),this.presence=this.options.presence,this.listenTo(this.presence,"change:unavailable",this._onAvailabilityChange)},onAddModel:function(e){var t=e.get("senderid"),i="/me "===e.get("text").substr(0,4);if(i){var o=new n({model:e,startsWithMe:!0});this.$el.append(o.el),this.lastSenderId=void 0}else if(this.lastSenderId&&t===this.lastSenderId)this.lastMessageView.addMessage(e);else{var o=new n({model:e});this.$el.append(o.el),this.lastSenderId=t,this.lastMessageView=o}this._delayedUpdateScroll()},onSync:function(){this.collection.each(this.onAddModel,this)},onResize:function(){this._updateScroll()},_onScroll:function(){var e=this.el;this.isAtBottom=e.scrollTop+e.offsetHeight+20>=e.scrollHeight},_updateScroll:function(){this.isAtBottom&&(this.el.scrollTop=this.el.scrollHeight)},_onStatusChange:function(){this.oldStatus=this.currentStatus,this.currentStatus=this.user.get("status"),this.showStatusMessage(this.oldStatus,this.currentStatus)},_onBlockChange:function(){var e=i.user.isBlocked(this.user.id);this.isBlocked&&!e?(this.showStatusMessage("ignored","unignored"),this.isBlocked=!1):!this.isBlocked&&e&&(this.showStatusMessage("unignored","ignored"),this.isBlocked=!0)},_onAvailabilityChange:function(){var e=this.presence.get("unavailable");e?this.showStatusMessage("senderAvailable","senderUnavailable"):this.showStatusMessage("senderUnavailable","senderAvailable")},showStatusMessage:function(e,t){var i;"offline"==t?i={text:this.user.get("name")+" went offline.",color:"red"}:"unavailable"==t||"no-pm"==t?i={text:this.user.get("name")+" became unavailable.",color:"red"}:"away"!=t&&"available"!=t||"offline"!=e?"away"!=t&&"available"!=t||"unavailable"!=e&&"no-pm"!=e?"ignored"==t&&"unignored"==e?i={text:"You ignored "+this.user.get("name")+".",color:"red"}:"unignored"==t&&"ignored"==e?i={text:"You unignored "+this.user.get("name")+".",color:"green"}:"senderUnavailable"==t&&"senderAvailable"==e?i={text:"You became unavailable.",color:"red"}:"senderAvailable"==t&&"senderUnavailable"==e&&(i={text:"You became available.",color:"green"}):i={text:this.user.get("name")+" became available.",color:"green"}:i={text:this.user.get("name")+" came online.",color:"green"},i&&(this.lastSenderId=void 0,this.$el.append(util.buildTree(o.layouts.pmStatus(i)))),this._updateScroll()}},{_name:"MessageHistoryView",layouts:{pmStatus:function(e){return["li.status-message"+(e.color?"."+e.color:""),e.text]}}});return o}),define("typeahead",["require","underscore","tt-base","util","app"],function(e){var t=e("underscore"),i=e("tt-base"),n=e("util"),o=e("app"),s=/([^:](:[\w\d\-_+]+:)?)*:([\w\d\-_+]+)$/,r=i.View.extend({className:"typeahead",methodsToBind:["inputKeyupListener","inputKeydownListener"],events:{"click .suggestion":"clickSuggestion","mouseenter .suggestion":"hoverSuggestion"},options:{checkUsers:!1,checkEmoji:!0,suggestionLimit:5},initAttributes:{type:null,suggestions:[],selectedIndex:!1,replacementIndex:0},init:function(e){this.$body=$("body"),e.checkUsers&&(this.room=e.room),this.input=e.input,this.$input=$(e.input).on("keyup",this.inputKeyupListener).on("keydown",this.inputKeydownListener),this.clearTypeahead(!0),this.listenTo(o,"Typeahead:clear",function(e){this.cid!==e.cid&&this.suggestions.length&&this.clearTypeahead()})},render:function(e,i,n){this.type=e,this.suggestions=i,this.selectedIndex=n;var o=[];t.each(i,function(t,i){o.push(this.build(e,t,i===n))},this),this.$el.append(o),this.$body.append(this.$el);var s=this.$input.offset(),r=this.$el.outerHeight(!0);return this.$el.css({left:s.left+1+"px",top:s.top-5-r+"px"}),this},inputKeyupListener:function(e){var t=e.charCode||e.keyCode;if(38!=t&&40!=t&&27!=t&&(39!=t||this.input.selectionEnd!=this.input.value.length)&&13!=t&&9!=t){var i=this.input.value.substring(0,e.target.selectionEnd);this.clearTypeahead(!0),this.generateTypeahead(i)}},inputKeydownListener:function(e){if(this.suggestions.length){var t,i,n=e.charCode||e.keyCode,o=this.input;if(13==n||9==n)return this.chooseSuggestion(),e.stopImmediatePropagation(),!1;if(38==n)return t=this.$el.find(".selected"),t.length&&(i=t.prev()),i&&i.length||(i=this.$el.find(".suggestion").last()),t.removeClass("selected"),this.selectedIndex=i.addClass("selected").index(),!1;if(40==n)return t=this.$el.find(".selected"),t.length&&(i=t.next()),i&&i.length||(i=this.$el.find(".suggestion").first()),t.removeClass("selected"),this.selectedIndex=i.addClass("selected").index(),!1;if(27==n||39==n&&o.selectionEnd==o.value.length)return this.clearTypeahead(),!1}},generateTypeahead:function(e){var t;if(this.options.checkUsers&&(t=this._lastValidAtSymbolIndex(e))>=0){var i=e.slice(t+1).toLowerCase();if(!i)return;var o=this._filterUsersByName(i);if(o.length)return this.replacementIndex=t+1,this.render("users",o,0),void 0}var r;if(this.options.checkEmoji&&(r=s.exec(e))){var a=r[3].toLowerCase(),l=n.emojiTypeahead(a,this.options.suggestionLimit);if(l.length){l.sort(function(e,t){return e.indexOf(a)-t.indexOf(a)}),this.replacementIndex=e.lastIndexOf(r[3]);var u=1===a.length?!1:0;return this.render("emoji",l,u),void 0}}},clearTypeahead:function(e){t.extend(this,this.initAttributes),this.$el.empty().detach(),e&&o.trigger("Typeahead:clear",this)},clickSuggestion:function(){this.chooseSuggestion()},hoverSuggestion:function(e){var t=$(e.currentTarget);t.hasClass("selected")||(this.selectedIndex=t.index(),t.addClass("selected").siblings(".selected").removeClass("selected"))},chooseSuggestion:function(){if(this.selectedIndex===!1)return this.clearTypeahead(),void 0;var e=this.suggestions[this.selectedIndex];"users"===this.type?(e=e.get("name"),"@"===e[0]&&(e=e.slice(1))):"emoji"===this.type&&(e+=":");var t=this.input,i=t.value.substring(0,t.selectionEnd),n=t.value.substring(t.selectionEnd),o=i.slice(0,this.replacementIndex)+e+" ";this.$input.val(o+n),t.selectionEnd=t.selectionStart=o.length,this.clearTypeahead()},_lastValidAtSymbolIndex:function(e){var t=e.split("@");if(t.length>1){for(var i=t.length-2;i>=0;i--)if(!t[i].length||t[i].length&&" "==t[i][t[i].length-1])return t.slice(0,i+1).join("@").length;if(""===t[0])return 0}return-1},_filterUsersByName:function(e){var t,i,o=[],s=this.room.listenerids,r=this.room.userMap;e.toLowerCase();for(var a=0,l=s.length;l>a&&(t=r[s[a]],!(t.registered&&(i=t.get("name").toLowerCase(),i="@"==i[0]?i.slice(1):i,i.substring(0,e.length)===e&&(o.push(t),o.length>=this.options.suggestionLimit))));a++);return n.alphabetize(o,"name")},remove:function(){return this.$input.off("keyup",this.inputKeyupListener).off("keydown",this.inputKeydownListener),this._super()}},{_name:"Typeahead"});return r.layouts={users:function(e,t){var i=e.get("images").headfront;return["div.suggestion"+(t?".selected":""),["div.avatar",{style:{"background-image":"url("+i+")"}}],e.get("name")]},emoji:function(e,t){var i="+1"===e?"thumbsup":e;return["div.suggestion"+(t?".selected":""),n.emojiToTree(i),e]}},r}),function(e){var t,i={className:"autosizejs",append:"",callback:!1,resizeDelay:10},n='<textarea tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>',o=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],s=e(n).data("autosize",!0)[0];s.style.lineHeight="99px","99px"===e(s).css("lineHeight")&&o.push("lineHeight"),s.style.lineHeight="",e.fn.autosize=function(n){return n=e.extend({},i,n||{}),s.parentNode!==document.body&&e(document.body).append(s),this.each(function(){function i(){var i,r={};if(t=h,s.className=n.className,l=parseInt(c.css("maxHeight"),10),e.each(o,function(e,t){r[t]=c.css(t)}),e(s).css(r),"oninput"in h){var a=h.style.width;h.style.width="0px",i=h.offsetWidth,h.style.width=a}}function r(){var o,r,a,d;t!==h&&i(),s.value=h.value+n.append,s.style.overflowY=h.style.overflowY,r=parseInt(h.style.height,10),"getComputedStyle"in window?(d=window.getComputedStyle(h),a=h.getBoundingClientRect().width,e.each(["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],function(e,t){a-=parseInt(d[t],10)}),s.style.width=a+"px"):s.style.width=Math.max(c.width(),0)+"px",s.scrollTop=0,s.scrollTop=9e4,o=s.scrollTop,l&&o>l?(h.style.overflowY="scroll",o=l):(h.style.overflowY="hidden",u>o&&(o=u)),o+=p,r!==o&&(h.style.height=o+"px",f&&n.callback.call(h,h))}function a(){clearTimeout(d),d=setTimeout(function(){c.width()!==g&&r()},parseInt(n.resizeDelay,10))}var l,u,d,h=this,c=e(h),p=0,f=e.isFunction(n.callback),m={height:h.style.height,overflow:h.style.overflow,overflowY:h.style.overflowY,wordWrap:h.style.wordWrap,resize:h.style.resize},g=c.width();c.data("autosize")||(c.data("autosize",!0),("border-box"===c.css("box-sizing")||"border-box"===c.css("-moz-box-sizing")||"border-box"===c.css("-webkit-box-sizing"))&&(p=c.outerHeight()-c.height()),u=Math.max(parseInt(c.css("minHeight"),10)-p||0,c.height()),c.css({overflow:"hidden",overflowY:"hidden",wordWrap:"break-word",resize:"none"===c.css("resize")||"vertical"===c.css("resize")?"none":"horizontal"}),"onpropertychange"in h?"oninput"in h?c.on("input.autosize keyup.autosize",r):c.on("propertychange.autosize",function(){"value"===event.propertyName&&r()}):c.on("input.autosize",r),n.resizeDelay!==!1&&e(window).on("resize.autosize",a),c.on("autosize.resize",r),c.on("autosize.resizeIncludeStyle",function(){t=null,r()}),c.on("autosize.destroy",function(){t=null,clearTimeout(d),e(window).off("resize",a),c.off("autosize").off(".autosize").css(m).removeData("autosize")}),r())})}}(window.jQuery||window.Zepto),define("lib/jquery.autosize",function(){}),define("views/message-input",["require","tt-base","typeahead","lib/jquery.autosize"],function(e){var t=e("tt-base"),i=e("typeahead");return e("lib/jquery.autosize"),t.View.extend({methodsToBind:["resetInput","onKeydown"],options:{idd:"messageInput",delegate:null},el:["form.message-input-view",["div.message-input-container",["textarea##$input.message-input",{placeholder:"enter a message"}]]],events:{submit:"onSubmit"},init:function(){this.typeahead=new i({input:this.nodes.input}),this.nodes.$input.on("keydown",this.onKeydown)},getValue:function(){return this.nodes.$input.val()},setValue:function(e){this.nodes.$input.val(e)},focus:function(){this.nodes.$input.focus()},onSubmit:function(e){e.preventDefault();var t,i=this.options.delegate;return i&&i.onMessageInputSubmit&&(t=i.onMessageInputSubmit(this.getValue())),t!==!1?"function"==typeof t.done?(t.done(this.resetInput),void 0):(this.resetInput(),void 0):void 0},onKeydown:function(e){this.nodes.$input.data("autosize")||this.nodes.$input.autosize({callback:_.bind(this.onAutosize,this)});var t=e.charCode||e.keyCode;13!==t||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||(this.$el.submit(),e.preventDefault())},onAutosize:function(){this.trigger("resize",this)},resetInput:function(){this.nodes.$input.val("").trigger("autosize.resize")},remove:function(){this.nodes.$input.trigger("autosize.destroy"),this._super.apply(this,arguments)}},{_name:"MessageInput"})}),define("views/conversation",["require","tt-base","app","views/message-history","views/message-input"],function(e){var t=e("tt-base"),i=e("app"),n=e("views/message-history"),o=e("views/message-input");return t.View.extend({el:function(){return["div.conversation-view",[n,{collection:this.model.messageHistory,conversation:this.model,presence:this.options.presence}],["div.error-message##$error"],[o,{delegate:this}]]},init:function(){this.user=this.model.user,this.presence=this.options.presence,this.hasError=!1,this.listenTo(this.presence,"change:unavailable",this._setError),this.listenTo(this.user,"change:status",this._setError),this.listenTo(i.user,"change:blocked",this._onBlockChange),this._onBlockChange(),this._setError(),this.listenTo(this.nodes.messageInput,"resize",this._onMessageInputResize),this.listenTo(this.model,"change:visible",this._onVisibilityChange),this.listenTo(this.model,"change:visible change:selected",this._checkFocus),this._onVisibilityChange()},_onVisibilityChange:function(){this.model.get("visible")&&this._resizeMessageHistory()},_checkFocus:function(){this.model.get("visible")&&this.model.get("selected")&&this.nodes.messageInput.focus()},_resizeMessageHistory:function(){var e=this.nodes.messageInput.$el.outerHeight();this.hasError&&(e+=this.nodes.$error.outerHeight()),this.nodes.messageHistoryView.$el.css("bottom",e),this.nodes.messageHistoryView.onResize()},_onBlockChange:function(){var e=i.user.isBlocked(this.user.id);this.isBlocked&&!e?(this.isBlocked=!1,this._setError()):!this.isBlocked&&e&&(this.isBlocked=!0,this._setError())},_setError:function(e){var t,e=this.user.get("status");this.presence.get("unavailable")?t="You are currently unavailable and cannot send or receive messages.":"offline"==e?t=this.user.get("name")+" is offline, your message(s) cannot be delivered.":this.isBlocked?t="You have ignored "+this.user.get("name")+" and cannot exchange messages with them.":"unavailable"!=e||i.user.isGatekeeper()?"no-pm"==e&&(t=this.user.get("name")+" is using a mobile app which currently does "+"not support private messages. Your message(s) cannot be delivered."):t=this.user.get("name")+" is unavailable, your message(s) cannot be delivered.",t?(this._showError(t),this.hasError=!0):(this._hideError(),this.hasError=!1)},_showError:function(e){this.nodes.$error.text(e).show(),this._resizeMessageHistory()},_hideError:function(){this.nodes.$error.hide(),this._resizeMessageHistory()},onMessageInputSubmit:function(e){var t=this;return this.model.send(e).fail(function(){t.nodes.messageInput.setValue(e)}),!0},_onMessageInputResize:function(){this._resizeMessageHistory()}},{_name:"ConversationView"})}),define("views/options-menu",["require","tt-base","app"],function(e){"use strict";var t=e("tt-base");return e("app"),t.View.extend({options:{idd:"optionsMenu",position:"bottom"},el:function(){return["div.options-menu.closed."+this.options.position,["div.nib"],["ul.options",t.View.Children]]},events:{click:"toggle"},init:function(){this.isShown=!1},toggle:function(){this.isShown?(this.$el.addClass("closed"),this.isShown=!1):(this.$el.removeClass("closed"),this.isShown=!0)}},{_name:"OptionsMenu"})}),define("views/conversation-options-menu",["require","rivets","tt-base","app","views/options-menu"],function(e){var t=e("rivets"),i=e("tt-base"),n=e("app"),o=e("views/options-menu");return i.View.extend({options:{idd:"conversationOptionsMenu"},el:[o,{className:"conversation-options-menu"},["li.option.view-profile","View profile"],["li.option.fan-option",{"data-rv-hide":"user.isFanned | not"},"Unfan"],["li.option.fan-option",{"data-rv-hide":"user.isFanned"},"Become a fan"],["li.option.ignore-user##$ignore","Ignore user"],["li.option.report-user","Report user"],["li.option.join-in-room##$join","Join in ",["strong","{{ user.roomName }}"]]],events:{"click .view-profile":"_onProfileOptionClick","click .fan-option":"_onFanOptionClick","click .ignore-user":"_onIgnoreOptionClick","click .report-user":"_onReportOptionClick","click .join-in-room":"_onJoinOptionClick"},init:function(){this.user=this.model.user,this.rivetsView=t.bind(this.el,{conversation:this.model,user:this.user}),this.listenTo(n.user,"change:blocked",this._onBlockChange),this.listenTo(this.user,"change:status",this._checkJoinOption),this.listenTo(this.model,"change:inSameRoom",this._checkJoinOption),this._checkJoinOption()},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)},_onProfileOptionClick:function(){n.router.setRoute("profile",{userId:this.user.id})},_onFanOptionClick:function(){var e=n.user.isFanof(this.user.id)?"remove_fan":"become_fan";n.room.zApRhMCallback(e,this.user.id)},_onIgnoreOptionClick:function(){this.isBlocked?n.router.setRoute("ignore"):n.router.setRoute("ignore",{},{ignoreName:this.user.get("name")})},_onReportOptionClick:function(){var e=this.user;n.router.setRoute("reportUser",{userId:e.id},{username:e.get("name")})},_onJoinOptionClick:function(){var e=this.user;n.room.moveRoom(e.get("roomShortcut")||e.get("roomId"),e.get("roomId"))},_onBlockChange:function(){var e=n.user.isBlocked(this.user.id);this.isBlocked&&!e?(this.nodes.$ignore.text("Ignore user"),this.isBlocked=!1):!this.isBlocked&&e&&(this.nodes.$ignore.text("Unignore user"),this.isBlocked=!0)},_checkJoinOption:function(){var e=this.user.get("status");"offline"===e||"unavailable"===e||this.model.get("inSameRoom")?this.nodes.$join.hide():this.nodes.$join.css("display","block")}},{_name:"ConversationOptionsMenu"})}),define("views/collection",["require","tt-base"],function(e){var t=e("tt-base");return t.View.extend({options:{idd:"collectionView",view:t.View,reverse:!1},el:["ul"],init:function(){this.$list=this.$("ul"),this.$list.length||(this.$list=this.$el);var e=this.options.reverse;this._domActions={append:e?"prepend":"append",prepend:e?"append":"prepend",after:e?"before":"after",before:e?"after":"before"},this.modelViews=[],this.viewMap={},this.collection.each(function(e,t){this.onAddModel(e,this.collection,{index:t})},this),this.listenTo(this.collection,{add:this.onAddModel,remove:this.onRemoveModel,reset:this.onReset})},onAddModel:function(e,t,i){var n;n=i&&_.isNumber(i.index)?i.index:t.indexOf(e),this._addView(e,n,i)},onRemoveModel:function(e,t,i){this._removeView(e,i.index)},onReset:function(){_.invoke(this.modelViews,"remove"),this.modelViews=[],this.collection.each(this._addView,this)},_addView:function(e,t,i){var n=new this.options.view(_.extend({model:e},i)),o=this._domActions;this.viewMap[e.cid]=n;var s=this.modelViews.length;if(0===s||t>this.collection.indexOf(this.modelViews[s-1].model))this.modelViews.push(n),this.$list[o.append](n.el);
else if(t<this.collection.indexOf(this.modelViews[0].model))this.modelViews.unshift(n),this.$list[o.prepend](n.el);else{var r=this.modelViews[t];if(r&&this.collection.indexOf(r.model)===t+1)this.modelViews.splice(t,0,n),r.$el[o.before](n.el);else{for(var a,l=0;s>l&&(r=this.modelViews[l],this.collection.indexOf(r.model)<t);l++)a=r;this.modelViews.splice(l,0,n),0===l?r.$el[o.before](n.el):a.$el[o.after](n.el)}}},_removeView:function(e,t){var i=this.viewMap[e.cid];this.modelViews[t]!==i&&(t=this.modelViews.indexOf(i)),this.modelViews.splice(t,1),i.remove()}},{_name:"CollectionView"})}),define("views/mixins/selectable",["require"],function(){return{select:function(){return this.isSelected?!1:(this.isSelected=!0,this.$el.addClass("selected"),this.trigger("select",this),void 0)},deselect:function(){return this.isSelected?(this.isSelected=!1,this.$el.removeClass("selected"),this.trigger("deselect",this),void 0):!1}}}),define("views/conversation-item",["require","rivets","tt-base","app","views/avatar-head","views/mixins/selectable","util","lib/jquery.tipsy"],function(e){var t=e("rivets"),i=e("tt-base"),n=e("app"),o=e("views/avatar-head"),s=e("views/mixins/selectable");return e("util"),e("lib/jquery.tipsy"),i.View.extend(_.extend({el:function(){return["li.conversation-item",["div.conversation-user-avatar",[o,{model:this.model.user,scale:.5}],["div.conversation-unread-count",{"data-rv-show":"unread.count","data-rv-text":"unread.count"}]],["div.conversation-info",["div.conversation-username",{"data-rv-text":"user.name"}],["div.conversation-user-room",{"data-rv-hide":"user.roomName | not","data-rv-title":"view:getRoomLinkTitle < user.name"},"in ",["a.conversation-user-room-link","{{ user.roomName }}"]]],["div.conversation-user-status",{"data-rv-add-class":"user.status"}]]},events:{click:"_onClick","click .conversation-user-room-link":"_onRoomLinkClick"},init:function(){this.rivetsView=t.bind(this.el,{user:this.model.user,unread:this.model.unreadCount,view:this}),this.$(".conversation-user-room").tipsy({opacity:1})},_onClick:function(){var e=this.options.delegate;e&&e.onConversationClick&&e.onConversationClick(this)},_onRoomLinkClick:function(){var e=this.model.user;return n.room.moveRoom(e.get("roomShortcut")||e.get("roomId"),e.get("roomId")),!1},getRoomLinkTitle:function(){return"Join "+this.model.user.get("name")+"'s room"},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)}},s),{_name:"ConversationItem"})}),define("views/conversations-list",["require","views/collection","views/conversation-item"],function(e){var t=e("views/collection"),i=e("views/conversation-item");return t.extend({options:{idd:"conversationsList",view:i},el:["div.conversations-list",["div.no-conversations.default-message##$empty",["p","None of your buddies are online."]],["ul"]],init:function(){this._onLengthChange(),this.listenTo(this.collection,"add remove",util.delay(this,this._onLengthChange,100)),this._super.apply(this,arguments)},onAddModel:function(e,t,i){this.listenTo(e,"select",this._onConversationSelect),(i||(i={})).delegate=this.options.itemDelegate,this._super(e,t,i)},onRemoveModel:function(e){this.stopListening(e),this._super.apply(this,arguments)},_onConversationSelect:function(e){this.trigger("select:conversation",e)},_onLengthChange:function(){this.collection.isEmpty()?this.nodes.$empty.show():this.nodes.$empty.hide()}},{_name:"ConversationsList"})}),define("views/pm-options-menu",["require","rivets","tt-base","app","views/options-menu"],function(e){"use strict";var t=e("rivets"),i=e("tt-base"),n=e("app"),o=e("views/options-menu");return i.View.extend({options:{idd:"pmOptionsMenu",position:"bottom"},el:function(){return[o,{className:"pm-options-menu",position:this.options.position},["li.option",{"data-rv-toggle":"presence.unavailable","data-rv-class-checked":"presence.unavailable | not"},"Available for private chat"],["li.option",{"data-rv-toggle":"volume.pmDing","data-rv-class-checked":"volume.pmDing"},"Ding on new message"],["li.option.ignored-users","Ignored users..."]]},events:{"click .ignored-users":"_onIgnoredUsersClick"},init:function(){this.rivetsView=t.bind(this.el,{presence:this.options.presence,volume:this.options.volume})},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)},_onIgnoredUsersClick:function(){n.router.setRoute("ignore")}},{_name:"PMOptionsMenu"})}),define("views/pm-unavailable-warning",["require","rivets","tt-base"],function(e){var t=e("rivets"),i=e("tt-base");return i.View.extend({options:{idd:"pmUnavailableWarning"},el:["div.pm-unavailable-warning",{"data-rv-class-visible":"presence.unavailable"},["div.pm-unavailable-text","You are unavailable to chat."],["div.pm-become-available",{"data-rv-toggle":"presence.unavailable"}]],init:function(){this.rivetsView=t.bind(this.el,{presence:this.options.presence})},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)}},{_name:"PMUnavailableWarning"})}),define("views/mini-pms-main",["require","rivets","tt-base","app","views/conversations-list","views/pm-options-menu","views/pm-unavailable-warning"],function(e){var t=e("rivets"),i=e("tt-base"),n=e("app"),o=e("views/conversations-list"),s=e("views/pm-options-menu"),r=e("views/pm-unavailable-warning");return i.View.extend({el:function(){return["div.mini-pms-main-view",{"data-pm-class-unavailable":"presence.unavailable"},[r,{presence:n.presence}],["div.mini-pms-scroller",[o,{collection:this.collection,itemDelegate:this.options.itemDelegate}]],["div.bottom-bar",[s,{presence:n.presence,volume:n.volume,position:"top"}]]]},init:function(){this.rivetsView=t.bind(this.el,{presence:n.presence},{config:{prefix:"pm"}})}},{_name:"MiniPMsMainView"})}),define("views/sliding-nav-pane",["require","rivets","tt-base","util"],function(e){var t=(e("rivets"),e("tt-base"));return e("util"),t.View.extend({options:{mainView:void 0,headerRightView:void 0,showHeader:!0,title:"",backText:""},el:function(){return["div.sliding-nav-pane"+(this.options.showHeader?"":".sliding-nav-no-header"),this.options.showHeader?["div.sliding-nav-pane-header",["button.sliding-nav-pane-back.back","Back"],["div.sliding-nav-pane-title",this.options.title instanceof t.View?this.options.title.el:this.options.title],["div.sliding-nav-pane-header-right",this.options.headerRightView&&this.options.headerRightView.el],this.options.headerView?this.options.headerView.el:null]:null,this.options.mainView.el]},init:function(){this.options.mainView.$el.addClass("sliding-nav-pane-content")}},{_name:"SlidingNavPane"})}),function(e){function t(e){if(e in h.style)return e;var t=["Moz","Webkit","O","ms"],i=e.charAt(0).toUpperCase()+e.substr(1);if(e in h.style)return e;for(var n=0;n<t.length;++n){var o=t[n]+i;if(o in h.style)return o}}function i(){return h.style[c.transform]="",h.style[c.transform]="rotateY(90deg)",""!==h.style[c.transform]}function n(e){return"string"==typeof e&&this.parse(e),this}function o(e,t,i){t===!0?e.queue(i):t?e.queue(t,i):i()}function s(t){var i=[];return e.each(t,function(t){t=e.camelCase(t),t=e.transit.propertyMap[t]||e.cssProps[t]||t,t=l(t),-1===e.inArray(t,i)&&i.push(t)}),i}function r(t,i,n,o){var r=s(t);e.cssEase[n]&&(n=e.cssEase[n]);var a=""+d(i)+" "+n;parseInt(o,10)>0&&(a+=" "+d(o));var l=[];return e.each(r,function(e,t){l.push(t+" "+a)}),l.join(", ")}function a(t,i){i||(e.cssNumber[t]=!0),e.transit.propertyMap[t]=c.transform,e.cssHooks[t]={get:function(i){var n=e(i).css("transit:transform");return n.get(t)},set:function(i,n){var o=e(i).css("transit:transform");o.setFromString(t,n),e(i).css({"transit:transform":o})}}}function l(e){return e.replace(/([A-Z])/g,function(e){return"-"+e.toLowerCase()})}function u(e,t){return"string"!=typeof e||e.match(/^[\-0-9\.]+$/)?""+e+t:e}function d(t){var i=t;return"string"!=typeof i||i.match(/^[\-0-9\.]+/)||(i=e.fx.speeds[i]||e.fx.speeds._default),u(i,"ms")}e.transit={version:"0.9.9",propertyMap:{marginLeft:"margin",marginRight:"margin",marginBottom:"margin",marginTop:"margin",paddingLeft:"padding",paddingRight:"padding",paddingBottom:"padding",paddingTop:"padding"},enabled:!0,useTransitionEnd:!1};var h=document.createElement("div"),c={},p=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;c.transition=t("transition"),c.transitionDelay=t("transitionDelay"),c.transform=t("transform"),c.transformOrigin=t("transformOrigin"),c.transform3d=i();var f={transition:"transitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",WebkitTransition:"webkitTransitionEnd",msTransition:"MSTransitionEnd"},m=c.transitionEnd=f[c.transition]||null;for(var g in c)c.hasOwnProperty(g)&&"undefined"==typeof e.support[g]&&(e.support[g]=c[g]);h=null,e.cssEase={_default:"ease","in":"ease-in",out:"ease-out","in-out":"ease-in-out",snap:"cubic-bezier(0,1,.5,1)",easeOutCubic:"cubic-bezier(.215,.61,.355,1)",easeInOutCubic:"cubic-bezier(.645,.045,.355,1)",easeInCirc:"cubic-bezier(.6,.04,.98,.335)",easeOutCirc:"cubic-bezier(.075,.82,.165,1)",easeInOutCirc:"cubic-bezier(.785,.135,.15,.86)",easeInExpo:"cubic-bezier(.95,.05,.795,.035)",easeOutExpo:"cubic-bezier(.19,1,.22,1)",easeInOutExpo:"cubic-bezier(1,0,0,1)",easeInQuad:"cubic-bezier(.55,.085,.68,.53)",easeOutQuad:"cubic-bezier(.25,.46,.45,.94)",easeInOutQuad:"cubic-bezier(.455,.03,.515,.955)",easeInQuart:"cubic-bezier(.895,.03,.685,.22)",easeOutQuart:"cubic-bezier(.165,.84,.44,1)",easeInOutQuart:"cubic-bezier(.77,0,.175,1)",easeInQuint:"cubic-bezier(.755,.05,.855,.06)",easeOutQuint:"cubic-bezier(.23,1,.32,1)",easeInOutQuint:"cubic-bezier(.86,0,.07,1)",easeInSine:"cubic-bezier(.47,0,.745,.715)",easeOutSine:"cubic-bezier(.39,.575,.565,1)",easeInOutSine:"cubic-bezier(.445,.05,.55,.95)",easeInBack:"cubic-bezier(.6,-.28,.735,.045)",easeOutBack:"cubic-bezier(.175, .885,.32,1.275)",easeInOutBack:"cubic-bezier(.68,-.55,.265,1.55)"},e.cssHooks["transit:transform"]={get:function(t){return e(t).data("transform")||new n},set:function(t,i){var o=i;o instanceof n||(o=new n(o)),t.style[c.transform]="WebkitTransform"!==c.transform||p?o.toString():o.toString(!0),e(t).data("transform",o)}},e.cssHooks.transform={set:e.cssHooks["transit:transform"].set},e.fn.jquery<"1.8"&&(e.cssHooks.transformOrigin={get:function(e){return e.style[c.transformOrigin]},set:function(e,t){e.style[c.transformOrigin]=t}},e.cssHooks.transition={get:function(e){return e.style[c.transition]},set:function(e,t){e.style[c.transition]=t}}),a("scale"),a("translate"),a("rotate"),a("rotateX"),a("rotateY"),a("rotate3d"),a("perspective"),a("skewX"),a("skewY"),a("x",!0),a("y",!0),n.prototype={setFromString:function(e,t){var i="string"==typeof t?t.split(","):t.constructor===Array?t:[t];i.unshift(e),n.prototype.set.apply(this,i)},set:function(e){var t=Array.prototype.slice.apply(arguments,[1]);this.setter[e]?this.setter[e].apply(this,t):this[e]=t.join(",")},get:function(e){return this.getter[e]?this.getter[e].apply(this):this[e]||0},setter:{rotate:function(e){this.rotate=u(e,"deg")},rotateX:function(e){this.rotateX=u(e,"deg")},rotateY:function(e){this.rotateY=u(e,"deg")},scale:function(e,t){void 0===t&&(t=e),this.scale=e+","+t},skewX:function(e){this.skewX=u(e,"deg")},skewY:function(e){this.skewY=u(e,"deg")},perspective:function(e){this.perspective=u(e,"px")},x:function(e){this.set("translate",e,null)},y:function(e){this.set("translate",null,e)},translate:function(e,t){void 0===this._translateX&&(this._translateX=0),void 0===this._translateY&&(this._translateY=0),null!==e&&void 0!==e&&(this._translateX=u(e,"px")),null!==t&&void 0!==t&&(this._translateY=u(t,"px")),this.translate=this._translateX+","+this._translateY}},getter:{x:function(){return this._translateX||0},y:function(){return this._translateY||0},scale:function(){var e=(this.scale||"1,1").split(",");return e[0]&&(e[0]=parseFloat(e[0])),e[1]&&(e[1]=parseFloat(e[1])),e[0]===e[1]?e[0]:e},rotate3d:function(){for(var e=(this.rotate3d||"0,0,0,0deg").split(","),t=0;3>=t;++t)e[t]&&(e[t]=parseFloat(e[t]));return e[3]&&(e[3]=u(e[3],"deg")),e}},parse:function(e){var t=this;e.replace(/([a-zA-Z0-9]+)\((.*?)\)/g,function(e,i,n){t.setFromString(i,n)})},toString:function(e){var t=[];for(var i in this)if(this.hasOwnProperty(i)){if(!c.transform3d&&("rotateX"===i||"rotateY"===i||"perspective"===i||"transformOrigin"===i))continue;"_"!==i[0]&&(e&&"scale"===i?t.push(i+"3d("+this[i]+",1)"):e&&"translate"===i?t.push(i+"3d("+this[i]+",0)"):t.push(i+"("+this[i]+")"))}return t.join(" ")}},e.fn.transition=e.fn.transit=function(t,i,n,s){var a=this,l=0,u=!0,h=jQuery.extend(!0,{},t);"function"==typeof i&&(s=i,i=void 0),"object"==typeof i&&(n=i.easing,l=i.delay||0,u=i.queue||!0,s=i.complete,i=i.duration),"function"==typeof n&&(s=n,n=void 0),"undefined"!=typeof h.easing&&(n=h.easing,delete h.easing),"undefined"!=typeof h.duration&&(i=h.duration,delete h.duration),"undefined"!=typeof h.complete&&(s=h.complete,delete h.complete),"undefined"!=typeof h.queue&&(u=h.queue,delete h.queue),"undefined"!=typeof h.delay&&(l=h.delay,delete h.delay),"undefined"==typeof i&&(i=e.fx.speeds._default),"undefined"==typeof n&&(n=e.cssEase._default),i=d(i);var p=r(h,i,n,l),f=e.transit.enabled&&c.transition,g=f?parseInt(i,10)+parseInt(l,10):0;if(0===g){var v=function(e){a.css(h),s&&s.apply(a),e&&e()};return o(a,u,v),a}var b={},w=function(t){var i=!1,n=_.once(function(){i&&a.unbind(m,n),g>0&&a.each(function(){this.style[c.transition]=b[this]||null}),"function"==typeof s&&s.apply(a),"function"==typeof t&&t()});g>0&&m&&e.transit.useTransitionEnd&&(i=!0,a.bind(m,n)),window.setTimeout(n,g),a.each(function(){g>0&&(this.style[c.transition]=p),e(this).css(h)})},y=function(e){this.offsetWidth,w(e)};return o(a,u,y),this},e.transit.getTransitionValue=r}(jQuery),define("lib/jquery.transit",function(){}),define("views/sliding-nav",["require","tt-base","util","views/sliding-nav-pane","lib/jquery.transit"],function(e){var t=e("tt-base"),i=(e("util"),e("views/sliding-nav-pane"));return e("lib/jquery.transit"),t.View.extend({options:{duration:300},el:["div.sliding-nav",["div.sliding-nav-slider##$slider"]],events:{"click .sliding-nav-pane-back":"_onClickBack"},init:function(){this.views=[],this.pushView(this.options.topView)},getCurrentView:function(){return _.last(this.views)},pushView:function(e){if(!(e instanceof i))throw"View must be SlidingNavPane";var t=_.last(this.views);this.views.push(e),t?e.$(".sliding-nav-pane-back").text(t.options.backText||t.options.title||"Back"):e.$(".sliding-nav-pane-back").hide(),e.$el.css("left",this._getPaneOffset()),this.nodes.$slider.append(e.$el),this.trigger("show",e),this.nodes.$slider.transition({left:this._getSliderOffset(),duration:this.options.duration,complete:_.bind(function(){t&&this.trigger("hide",t)},this)})},popView:function(){var e=this.views.pop(),t=_.last(this.views);this.trigger("show",t),this.nodes.$slider.transition({left:this._getSliderOffset(),duration:this.options.duration,complete:_.bind(function(){e.$el.detach(),this.trigger("hide",e)},this)})},_onClickBack:function(){this.popView()},_getPaneOffset:function(){return 100*(this.views.length-1)+"%"},_getSliderOffset:function(){return 100*-(this.views.length-1)+"%"}},{_name:"SlidingNav"})}),define("views/mini-pms",["require","tt-base","util","app","views/conversation","views/conversation-options-menu","views/mini-pms-main","views/sliding-nav","views/sliding-nav-pane"],function(e){var t=e("tt-base"),i=(e("util"),e("app")),n=e("views/conversation"),o=e("views/conversation-options-menu"),s=e("views/mini-pms-main"),r=e("views/sliding-nav"),a=e("views/sliding-nav-pane");return t.View.extend({el:["div.mini-pms-view",["div#mini-pms-guest-view",["div.guest-chat-icon"],["div.message-1","Sign up to PM"],["div.message-2","Send messages to your friends on turntable.fm!"],["div.message-3","Users you've fanned will show up here. You can send them messages whenever they're online!"],["button.sign-up.tt-button.small.primary.inset","Sign up"]]],events:{"click .sign-up":"_onSignupClick"},init:function(){this.pms=i.pms,this.conversationViews={},this.pmsMainView=new s({collection:this.pms,itemDelegate:this}),this.slidingNav=new r({topView:new a({mainView:this.pmsMainView,showHeader:!1,backText:"People"})}),this.$el.append(this.slidingNav.el),this.slidingNav.$el.hide(),i.user.get("registered")?this._onUserRegister():this.listenTo(i.user,"change:registered",this._onUserRegister),this.listenTo(this.pms,{"change:selected":this._onConversationSelectedChange}),this.listenTo(this.slidingNav,{show:this._onViewShow,hide:this._onViewHide})},onShow:function(){this.isVisible=!0,this.activeConversationView&&this.activeConversationView.options.mainView.model.set("visible",!0)},onHide:function(){this.isVisible=!1,this.activeConversationView&&this.activeConversationView.options.mainView.model.set("visible",!1)},_onConversationSelectedChange:function(e,t){var s=this.conversationViews[e.id];t?(s||(s=this.conversationViews[e.id]=new a({mainView:new n({model:e,presence:i.presence}),title:e.user.get("name"),headerView:new o({model:e})})),this.activeConversationView&&this.activeConversationView===s||(this.activeConversationView=s),s!==this.slidingNav.getCurrentView()&&this.slidingNav.pushView(s)):(s===this.slidingNav.getCurrentView()&&this.slidingNav.popView(),this.activeConversationView===s&&(this.activeConversationView=void 0))},_onUserRegister:function(){this.$("#mini-pms-guest-view").remove(),this.slidingNav.$el.show()},_onSignupClick:function(e){e&&e.preventDefault(),i.router.setRoute("signup")},_onViewShow:function(e){e.options.mainView instanceof n&&(this.activeConversationView=e,this.isVisible&&e.options.mainView.model.set("visible",!0))},_onViewHide:function(e){e.options.mainView instanceof n&&(e.options.mainView.model.deselect(),this.isVisible&&e.options.mainView.model.set("visible",!1))},onConversationClick:function(e){e.model.select()}},{_name:"MiniPMsView"})}),define("views/tabbed-panel",["require","tt-base"],function(e){var t=e("tt-base"),i=t.View.extend({methodsToBind:["onTabItemClick"],options:{tabPanes:[]},el:["ul.tabbed-panel"],init:function(){this.tabs=[],this.tabMap={},_.each(this.options.tabPanes,this.insertTab,this)},insertTab:function(e,t,i,n){i=_.isNumber(i)?i:this.tabs.length,n=n||_.uniqueId("tabObject");var o={item:e,pane:t,name:n,el:util.buildTree(["li.tabbed-panel-tab",e.el,t.el])};this.tabs.length===i?this.$el.append(o.el):this.$el.children().eq(i).before(o.el),this.tabMap[n]=o,this.tabs.splice(i,0,o),this.$el.removeClass("tabs-"+(this.tabs.length-1)).addClass("tabs-"+this.tabs.length),e.$el.data("tabName",n).on("click",this.onTabItemClick),this.selectedTabObject?this._deselectTab(o):this._selectTab(o)},removeTab:function(e){this._removeTab(this.tabMap[e])},removeTabByIndex:function(e){this._removeTab(this.tabs[e])},_removeTab:function(e){if(!e)return!1;this._deselectTab(e);var t=this.tabs.indexOf(e);-1!==t&&this.tabs.splice(t,1),this.tabMap[e.name]=void 0,e.item.$el.detach(),e.pane.$el.detach(),this.$el.children().eq(t).remove(),this.$el.removeClass("tabs-"+(this.tabs.length+1)).addClass("tabs-"+this.tabs.length),e.item.$el.off("click",this.onTabItemClick).data("tabName",null),this.tabs.length&&this.selectTabByIndex(t===this.tabs.length?t-1:t)},selectTab:function(e){this._selectTab(this.tabMap[e])},selectTabByIndex:function(e){this._selectTab(this.tabs[e])},onTabItemClick:function(e){this.selectTab($(e.target).closest(".tab-item").data("tabName"))},_selectTab:function(e){if(this.selectedTabObject){if(this.selectedTabObject===e)return;this._deselectTab(this.selectedTabObject)}$(e.el).addClass("selected"),e.item.select(),e.pane.select(),this.selectedTabObject=e},_deselectTab:function(e){e.item.deselect(),e.pane.deselect(),$(e.el).removeClass("selected"),this.selectedTabObject===e&&(this.selectedTabObject=void 0)}},{_name:"TabbedPanel"});return i}),define("views/tab-item",["require","rivets","tt-base","views/mixins/selectable"],function(e){var t=e("rivets"),i=e("tt-base"),n=e("views/mixins/selectable"),o=i.View.extend(_.extend({el:function(){return["div.tab-item",["div.tab-icon."+this.options.iconClass,["div.tab-badge##$badge",{"data-rv-show":"model.count","data-rv-text":"model.count"}]],["div.tab-title",this.options.title]]},init:function(){var e=this.options;e.badgeModel?this.setBadgeModel(e.badgeModel):this.nodes.$badge.hide()},setBadgeModel:function(e){this.badgeModel&&this.rivetsView&&this.rivetsView.unbind(),this.nodes.$badge.css("display",""),this.badgeModel=e,this.rivetsView=t.bind(this.el,{model:e})},remove:function(){this.rivetsView&&this.rivetsView.unbind(),this._super.apply(this,arguments)}},n),{_name:"TabItem"});return o}),define("views/tab-pane",["require","tt-base"],function(e){var t=e("tt-base"),i=t.View.extend({el:["div.tab-pane"],select:function(){this.trigger("select")},deselect:function(){this.trigger("deselect")}},{_name:"TabPane"});return i}),define("views/chrome",["require","tt-base","util","app","views/header","views/mini-pms","views/tabbed-panel","views/tab-item","views/tab-pane"],function(e){var t=e("tt-base"),i=e("util"),n=e("app"),o=e("views/header"),s=e("views/mini-pms"),r=e("views/tabbed-panel"),a=e("views/tab-item"),l=e("views/tab-pane"),u=1200,d=700,h=t.View.extend({methodsToBind:["onLayoutSettingChange"],el:function(){return["div.chrome",[o],[r,{idd:"leftPanel",className:"left-panel"}],[r,{idd:"rightPanel",className:"right-panel"}]]},init:function(){this.throttledSetLayout=i.rateLimit(this,this.setPanelLayout,300),this.$window=$(window).on("resize",this.throttledSetLayout),this.$html=$("html"),this.playlistTabItem=new a({title:"Queue",iconClass:"queue-icon"}),this.playlistPane=new l,this.playlistPane.$el.append(i.buildTree(["div#playlist"])),this.roomTabItem=new a({title:"Room",iconClass:"room-icon"}),this.roomPane=new l,this.chatTabItem=new a({title:"Chat",iconClass:"chat-icon"}),this.chatPane=new l,this.chatPane.$el.append(i.buildTree(["div.chat"])),this.nodes.rightPanel.insertTab(this.chatTabItem,this.chatPane,0,"chat"),window.miniPMs=this.miniPMs=new s,this.pmTabItem=new a({title:"PM",iconClass:"pm-icon",badgeModel:this.miniPMs.pms.unreadCount}),this.pmPane=new l,this.pmPane.$el.append(this.miniPMs.el),this.listenTo(this.pmPane,{deselect:_.bind(this.miniPMs.onHide,this.miniPMs),select:_.bind(this.miniPMs.onShow,this.miniPMs)}),this.listenTo(this.playlistPane,"select",_.bind(this._onTabSelect,this,"queue")),this.listenTo(this.roomPane,"select",_.bind(this._onTabSelect,this,"room")),this.listenTo(this.chatPane,"select",_.bind(this._onTabSelect,this,"chat")),this.listenTo(this.pmPane,"select",_.bind(this._onTabSelect,this,"pm"));var e=this.prefs=n.prefs;e.loading.done(this.onLayoutSettingChange),this.listenTo(e,"change:layout",this.onLayoutSettingChange),this.listenTo(n,"popOut",this.remove),n.user.get("registered")||(this.$html.addClass("guest-layout"),this.listenTo(n.user,"change:registered",this._onUserRegister))},onResize:function(){u>width?this.singlePanelMode||(this.singlePanelMode=!0,this._setSinglePanel()):this.singlePanelMode&&(this.singlePanelMode=!1,this._setDualPanel())},onLayoutSettingChange:function(){this.setPanelLayout(!0)},setPanelLayout:function(e){var t=this.prefs.get("layout")||"single",i=this.$window.width();"dual"===t?i>=u?this._setDualPanel():(e===!0&&this.hasMessaged&&(alert("Sorry, the layout you've chosen doesn't fit your window size. Please select a different layout or resize your window."),this.hasMessaged=!0),this._setSinglePanel()):this._setSinglePanel(),d>i?this._setMiniplayer():this._unsetMiniplayer()},_setSinglePanel:function(){"single"!==this.visibleLayout&&(this.visibleLayout="single",this.nodes.leftPanel.removeTab("queue"),this.nodes.leftPanel.removeTab("room"),this.nodes.rightPanel.insertTab(this.playlistTabItem,this.playlistPane,0,"queue"),this.nodes.rightPanel.insertTab(this.roomTabItem,this.roomPane,1,"room"),this.$html.addClass("single-panel-chrome"),n.trigger("change:layout"))},_setDualPanel:function(){"dual"!==this.visibleLayout&&(this.visibleLayout="dual",this.nodes.rightPanel.removeTab("queue"),this.nodes.rightPanel.removeTab("room"),this.nodes.leftPanel.insertTab(this.playlistTabItem,this.playlistPane,0,"queue"),this.nodes.leftPanel.insertTab(this.roomTabItem,this.roomPane,1,"room"),this.$html.removeClass("single-panel-chrome"),n.trigger("change:layout"))},_setMiniplayer:function(){n.get("miniplayer")||(this.$html.addClass("miniplayer"),this.nodes.rightPanel.insertTab(this.pmTabItem,this.pmPane,0,"pm"),n.set("miniplayer",!0),_gaq.push(["_trackEvent","miniplayer","on"]))},_unsetMiniplayer:function(){n.get("miniplayer")&&(this.$html.removeClass("miniplayer"),this.nodes.rightPanel.removeTab("pm"),n.set("miniplayer",!1),_gaq.push(["_trackEvent","miniplayer","off"]))},_onUserRegister:function(){this.$html.removeClass("guest-layout")},_onTabSelect:function(e){_gaq.push(["_trackEvent","tab select",e,n.get("miniplayer")?"mini":"full"])},remove:function(){this.$window.off("resize",this.throttledSetLayout),this._super.apply(this,arguments)}},{_name:"ChromeView"});return h}),define("models/directory-graph",["require","tt-base","app"],function(e){var t=e("tt-base"),i=e("app");return t.Model.extend({api:"room.directory_graph",methodsToBind:["_poll"],pollInterval:6e4,idlePollInterval:6e5,init:function(e,t){this.presence=t&&t.presence?t.presence:null,this.initPolling(),this.presence&&this.listenTo(this.presence,"change:idle",this._onIdleChange),this.listenTo(i,"popOut",this.stopPolling)},initPolling:function(){this.pollTimer||this._poll()},stopPolling:function(){this.pollTimer&&(window.clearTimeout(this.pollTimer),this.pollTimer=void 0)},_poll:function(){this.fetch(),this.pollTimer=window.setTimeout(this._poll,!this.presence||this.presence.get("idle")?this.idlePollInterval:this.pollInterval)},_onIdleChange:function(){this.presence.get("idle")||(this.stopPolling(),this.initPolling())}},{_name:"DirectoryGraph"})}),define("set",["require","tt-base"],function(e){var t=e("tt-base"),i=t.Class.extend({init:function(e){this.ids={},e&&this.add(e)},add:function(e){_.isArray(e)||(e=e?[e]:[]);for(var t,i=0,n=e.length;n>i;i++)t=e[i],this.ids[t]||(this.ids[t]=!0,this.trigger("add",t,this),this.trigger("change:"+t,this,!0))},remove:function(e){_.isArray(e)||(e=e?[e]:[]);for(var t,i=0,n=e.length;n>i;i++)t=e[i],this.ids[t]&&(delete this.ids[t],this.trigger("remove",t,this),this.trigger("change:"+t,this,!1))},set:function(e){var t=_.keys(this.ids),i=_.difference(t,e),n=_.difference(e,t);this.remove(i),this.add(n)},has:function(e){return this.ids[e]}},{_name:"Set"});return i.prototype.get=i.prototype.has,i}),define("models/favorites",["require","set","tt-common"],function(e){var t=e("set"),i=e("tt-common");return t.extend({methodsToBind:["_onLoad"],init:function(){this._super.apply(this,arguments),this.loading=i.apiGet({api:"room.get_favorites"}).done(this._onLoad)},add:function(e){i.apiPost({api:"room.add_favorite",roomid:e}).done(_.bind(this._super,this,e))},remove:function(e){i.apiPost({api:"room.rem_favorite",roomid:e}).done(_.bind(this._super,this,e))},_onLoad:function(e){var i=e.list;t.prototype.add.call(this,i)}},{_name:"Favorites"})}),define("mixins",["require","underscore"],function(e){var t=e("underscore"),i=function(e){return e.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()})},n=function(e){return e.replace(/(\_[a-z])/g,function(e){return e.toUpperCase().slice(1)})},o=function(e,i){return t.map(e,function(e){return e[0]=i(e[0]),e})},s=function(e){return null!=e},r=function(e){return e!==!1&&s(e)},a=function(e,i){return t.reduce(e,function(e,t,n){var o=i(n);return r(o)&&(e[o]=t),e},{})};t.mixin({existy:s,truthy:r,pluckAs:a,pluckWithMap:function(e,t){a(e,function(e){return t[e]})},camelCaseKeys:function(e){return t.object(o(t.pairs(e),n))},snakeCaseKeys:function(e){return t.object(o(t.pairs(e),i))},moveKeys:function(e,i){var n={};return t.each(e,function(e,o){n[t.has(i,o)?i[o]:o]=e}),n}})}),define("models/preferences",["require","tt-base","app","mixins"],function(e){var t=e("tt-base"),i=e("app");e("mixins");var n=t.Model.extend({methodsToBind:["onLoad"],init:function(){this.loading=this.fetch().done(this.onLoad),this.listenTo(i,"change:miniplayer",this._onMiniplayerChange)},onLoad:function(){this.on("change",function(){this.save()}),this.has("miniplayer")&&this.save()},parse:function(e){return _.camelCaseKeys(e)},sync:function(e,t,i){return"create"===e||"update"===e?(i.api="user.edit_prefs",i.attrs=_.snakeCaseKeys(t.attributes),i.attrs.userid=void 0):"read"===e&&(i.api="user.get_prefs"),this._super(e,t,i)},isSinglePanel:function(){return!this.isDualPanel()},isDualPanel:function(){return"dual"===this.get("layout")},_onMiniplayerChange:function(){this.set("miniplayer",i.get("miniplayer"))}},{_name:"Preferences"});return n}),define("models/presence",["require","tt-base","app"],function(e){var t=e("tt-base"),i=e("app");return t.Model.extend({api:"presence.update",idleThreshold:18e4,idleCheckInterval:6e4,idleCheckEvents:"focus keydown mousemove mousedown",updateInterval:1e4,lastSaveTime:0,methodsToBind:["_trackPresence","_checkIdle"],init:function(){this.set({unavailable:"true"===util.getSetting("isUnavailable"),idle:!1}),this._onUserAction=_.throttle(_.bind(this._onUserAction,this),2e3),this._onUserAction(),this.wMqvZl(),this.trackPresence(),this.on("change:unavailable",this._onUnavailableChange),this.listenTo(i,"popOut",this.stopPresenceTracking)},getStatus:function(){return this.get("unavailable")?"unavailable":this.get("idle")?"away":"available"},getIdleTime:function(){return this.lastActionTime?Date.now()-this.lastActionTime:0},wMqvZl:function(){$(window).on(this.idleCheckEvents,this._onUserAction),this.idleCheckTimer=window.setInterval(this._checkIdle,this.idleCheckInterval)},trackPresence:function(){this.presenceTimer||this._trackPresence()},_trackPresence:function(){this.presenceTimer=window.setTimeout(this._trackPresence,this.updateInterval),this.save()},stopPresenceTracking:function(){window.clearTimeout(this.presenceTimer),this.presenceTimer=void 0},parse:function(e){e.interval&&(this.updateInterval=1e3*e.interval),e.now&&(this.clientTimeDelta=(Date.now()+this.lastSaveTime)/2/1e3-e.now)},sync:function(e,t,i){if("create"===e||"update"===e){if(!i.force&&Date.now()-this.lastSaveTime<this.updateInterval)return;return i.websocket=!0,i.attrs={status:this.getStatus()},this.lastSaveTime=Date.now(),this._super(e,t,i)}},cleanup:function(){$(window).off(this.idleCheckEvents,this._onUserAction),window.clearInterval(this.idleCheckTimer),this._super.apply(this,arguments)},_onUserAction:function(){this.lastActionTime=Date.now(),this.set("idle",!1)},_checkIdle:function(){this.getIdleTime()>this.idleThreshold&&this.set("idle",!0)},_onUnavailableChange:function(e,t){util.setSetting("isUnavailable",t.toString())}},{_name:"Presence"})}),define("overlay",["require","util","tt-base"],function(e){var t,i,n,o,s=e("util"),r=e("tt-base"),a=!1,l=r.View.extend({init:function(){a||(t=$(window),i=$("html"),n=$("#maindiv"),o=$(s.buildTree(["div#overlay.overlay"])).appendTo(n),a=!0),this.$window=t,this.$html=i,this.$maindiv=n,this.$overlay=o,this.show=$.proxy(this.show,this),this.hide=$.proxy(this.hide,this)},_show:function(){var e=$.Deferred(),t=function(){e.resolve()};return this.$overlay.css("opacity",1).one(s.transitionEnd,t),window.setTimeout(t,600),e},_hide:function(){var e=$.Deferred(),t=function(){e.resolve()};return this.$overlay.css("opacity",0).one(s.transitionEnd,t),window.setTimeout(t,600),e},hide:function(){return this.visible?this._hide().done($.proxy(this.cleanup,this)):void 0},cleanup:function(){},overlayState:{visible:!1}}),u=l.extend({show:function(){return this.overlayState.visible?void 0:(this.visible=this.overlayState.visible=!0,this.$html.addClass("scrollable-overlay-mode"),this._show())},cleanup:function(){this.visible=this.overlayState.visible=!1,this.$html.removeClass("scrollable-overlay-mode")}}),d=l.extend({show:function(){if(!this.overlayState.visible){this.visible=this.overlayState.visible=!0,this.scrollTop=this.$window.scrollTop(),this.scrollLeft=this.$window.scrollLeft();var e=$("body");
return $("#turntable").outerHeight(!0)>this.$window.height()&&e.css("overflow-y","scroll"),this.$html.addClass("nonscrollable-overlay-mode"),this.$maindiv.css({top:-this.scrollTop,left:-this.scrollLeft}),this.$overlay.css({position:"fixed"}),e.css({"background-position":"50% -"+this.scrollTop+"px"}).scrollTop(0),this._show()}},cleanup:function(){this.visible=this.overlayState.visible=!1,this.$html.removeClass("nonscrollable-overlay-mode"),this.$overlay.css("opacity",""),this.$maindiv.css({top:"",left:""}),$("body").css({"background-position":"","overflow-y":""}),this.$window.scrollTop(this.scrollTop),this.$window.scrollLeft(this.scrollLeft)}});return{NonscrollableOverlay:d,ScrollableOverlay:u}}),define("modal",["require","underscore","util","app","overlay","tt-base"],function(e){var t,i,n,o,s=e("underscore"),r=e("util"),a=e("app"),l=e("overlay"),u=e("tt-base"),d=48,h=110,c=300,p=new l.NonscrollableOverlay,f=!1,m=function(e,t){e=s.once(e),t.one(r.transitionEnd,e),window.setTimeout(e,c+100)};$(function(){i=$("#transition-overlay"),i.length||(i=$(r.buildTree(["div#transition-overlay",["div#transition-modal-container",["div#transition-modal.modal"]]])).appendTo("#maindiv")),i.addClass("out"),n=i.find("#transition-modal"),o={fadeIn:function(e){var t=$.Deferred();return f?t.resolve():(n.css(e),m(function(){f=!0,t.resolve()},i),i.removeClass("out"),s.defer(function(){i.addClass("visible")})),t},resizeAndFadeOut:function(e,t){var o=$.Deferred(),s=function(){f=!1,o.resolve(),i.addClass("out")};return m(function(){t(),m(s,i),i.removeClass("visible")},n),n.css({width:e.width,height:e.height}),o}}});var g=u.View.extend({options:{idd:"modal",title:null,showCallback:null,preCloseCallback:null,closeCallback:null,showClose:!0,clickOut:!0,footer:null,shouldSetMaxHeight:!0},el:function(){return["div.modal",["div.close-x"],["h2.title",this.options.title],["div.content-container",["div.content",u.View.Children],this.options.footer?["div.footer",this.options.footer]:null]]},methodsToBind:["resize","_preClose","close","show","_onPrevModalClose","_show","_onShow","close","_close","_onClose","_onOverlayClick"],init:function(){$.data(this.el,"object",this),this.showing=$.Deferred(),this.closing=$.Deferred(),this.overlay=p,this.$overlay=p.$overlay,this.$window=p.$window,this.options.fullscreen&&this.$el.addClass("fullscreen-modal"),this.options.width&&this.$el.css("width",this.options.width),(null===this.options.title||void 0===this.options.title)&&this.$(".title").remove(),this.options.showClose?this.$(".close-x").on("click",this._preClose):this.$(".close-x").remove()},show:function(){return t===this||this.inDOM||(this.$container=$(r.buildTree(["div.modal-container.modal-hidden",this.el])).appendTo("body"),this.inDOM=!0,$.when(t?t.closing:{}).done(this._onPrevModalClose),this.previousModal=t,t=this),this.showing.promise()},_onPrevModalClose:function(e){this.isClosing||(this.isShowing=!0,e&&e.isTransitioning?this._transitionIn().done(this._onShow):this._fadeIn().done(this._onShow))},_transitionIn:function(){return o.resizeAndFadeOut({width:this.options.fullscreen?this.$window.innerWidth():this.$el.innerWidth(),height:this.options.fullscreen?this.$window.innerHeight():Math.min(window.innerHeight-d,this.$el.innerHeight())},this._show)},_fadeIn:function(){return this._show(),this.overlay.show()},_show:function(){this.$container.detach().appendTo(this.$overlay).removeClass("modal-hidden"),this.options.clickOut&&this.$overlay.on("click",this._onOverlayClick),this.options.shouldSetMaxHeight&&(this.$window.on("resize",this.resize),this.listenTo(a,"change:miniplayer",this.resize),this.resize()),this.options.showCallback&&this.options.showCallback()},_onShow:function(){this.showing.resolve()},_preClose:function(){this.options.preCloseCallback&&this.options.preCloseCallback()===!1||this.close()},close:function(e){if(this.wasCloseCalled)return this.closing.promise();if(this.wasCloseCalled=!0,this.options.closeCallback&&this.options.closeCallback(),e&&e.transition&&(this.isTransitioning=!0),this.isShowing)this.showing.done(this._close);else{this.showing.reject(),this.isClosing=!0;var t=this.previousModal;$.when(t?t.closing:{}).done(this._close)}return this.closing.promise()},_close:function(){this.$overlay.off("click",this._onOverlayClick),this.options.shouldSetMaxHeight&&(this.$window.off("resize",this.resize),this.stopListening(a,"change:miniplayer",this.resize)),this.isTransitioning?o.fadeIn({width:this.$el.innerWidth(),height:this.$el.innerHeight()}).done(this._onClose):this.overlay.hide().done(this._onClose)},_onClose:function(){this.$container.remove(),this.closing.resolve(this)},resize:function(){if(a.get("miniplayer"))this.$(".content").css("max-height","");else{var e=this.$el.find(".title").height(),t=this.$el.find(".footer").height();this.$el.find(".content").css("max-height",window.innerHeight-h-e-t)}},showAlert:function(e,t,i){var i=i||3e3;$.when(this.showing).done($.proxy(function(){var n=t?"."+t:"",o=$(r.buildTree(["div.alert"+n,["div",e]]));o.css({display:"block",visibility:"hidden"}),this.$el.find(".content-container").prepend(o);var s=o.outerHeight(!0);o.css({top:-s,visibility:"visible",opacity:0}),o.addClass("transitioning"),window.setTimeout(function(){o.css({top:"0",opacity:1})}),window.setTimeout($.proxy(this.hideAlert,this),i)},this))},hideAlert:function(){var e=this.$el.find("div.alert"),t=e.outerHeight(!0);e&&e.css({top:-t,opacity:0}),window.setTimeout(function(){e.remove()},500)},_onOverlayClick:function(e){var t=$(e.target);(t.hasClass("modal-container")||t.hasClass("overlay"))&&this._preClose()}},{_name:"Modal"});return g}),define("action-modal",["require","modal","tt-base"],function(e){var t=e("modal"),i=e("tt-base"),n=t.extend({options:{submitCallback:null,submitText:"OK",cancelCallback:null,cancelText:"Cancel",showCancel:!0,alterateText:"Close",showAlternate:!1},el:function(){return["div.modal",{style:{width:this.options.width}},["div.close-x"],["h2.title",this.options.title],["div.content-container",["div.content",i.View.Children,["div.buttons",["button.cancel"],["button.submit",{type:"submit"}]]]]]},init:function(){this._super.apply(this,arguments),this.$el.find(".submit").text(this.options.submitText).on("click",$.proxy(this.submit,this)),this.options.showCancel?this.$el.find(".cancel").text(this.options.cancelText).on("click",$.proxy(this.cancel,this)):this.$el.find(".cancel").remove(),this.options.showAlternate&&(this.$el.find(".submit").hide(),this.$el.find(".cancel").text(this.options.alterateText))},submit:function(){this.options.submitCallback&&0==this.options.submitCallback()||this._preClose()},cancel:function(){this.options.cancelCallback&&0==this.options.cancelCallback()||this._preClose()},revertAlternate:function(){1==this.options.showAlternate&&(this.$el.find(".submit").show(),this.$el.find(".cancel").text(this.options.cancelText),this.options.showAlternate=!1)},showAlternate:function(){0==this.options.showAlternate&&(this.$el.find("submit").hide(),this.$el.find(".cancel").text(this.options.alternateText),this.options.showAlternate=!0)}});return n}),define("sticker-config",{STICKER_PATH:"/roommanager_assets/stickers/"}),define("sticker",["require","util","action-modal","app","config","sticker-config","tt-common"],function(e){var t=e("util"),i=e("action-modal"),n=e("app"),o=e("config"),s=e("sticker-config"),r=e("tt-common"),a={ZOOM_VIEW_RADIUS:80,ZOOM_RATIO:.5,DJ_RATIO:.11,CORNER_DRAG_RADIUS:20,IMAGE_PATH:"/roommanager_assets/props/",LAPTOP_WIDTH:564,LAPTOP_HEIGHT:381,SCREEN_WIDTH:500,SCREEN_HEIGHT:325,SCREEN_CORNER_RADIUS:23,SCREEN_OFFSET_X:0,SCREEN_OFFSET_Y:0,MAX_PLACEMENTS:20,PICKER_STICKER_WIDTH:130,UNPURCHASED_STICKER_OPACITY:.5,$zoomView:null,context:null,tempCanvas:null,tempContext:null,hoverUserid:null,updateZoomCanvas:null,$boundingBox:null,stickerMap:{},stickersLoaded:!1,stickersLoad:null,stickerPlacements:{},images:{},loading:null,numPlacements:0};a.init=function(){window.turntable&&turntable.addEventListener("message",a.messageHandler),$(document).on("add_sticker_placements",a.addStickerPlacements),$(document).on("drawDjLaptop",a.drawDjStickerPlacements);var e=a.cacheImages(),t=a.cacheStickers();a.loading=l.loading=$.when(e,t)},a.initZoomView=function(){var e=t.buildTree(a.layouts.zoomView);$("#maindiv").append(e),a.$zoomView=$(e);var i=$("#zoomCanvas")[0],n=a.ZOOM_VIEW_RADIUS;i.width=2*n,i.height=2*n;var o=i.getContext("2d");a.context=o,o.beginPath(),o.arc(n,n,n,0,2*Math.PI,!1),o.clip(),a.tempCanvas=t.buildTree(["canvas",{width:a.LAPTOP_WIDTH+2*a.ZOOM_VIEW_RADIUS,height:a.LAPTOP_HEIGHT+2*a.ZOOM_VIEW_RADIUS}]),a.tempContext=a.tempCanvas.getContext("2d")},a.cacheImages=function(){for(var e,i=[],n=["mac","windows","linux","chrome"],o=["screen","mask","laptop"],s=n.length,r=o.length,l=0;r>l;l++){var u=o[l];if(a.images[u]={},"mask"!=u)for(var d=0;s>d;d++){var h=n[d];e=t.createImageWithLoader(a.IMAGE_PATH+u+"-"+h+".png"),a.images[u][h]=e[0],i.push(e[1])}else e=t.createImageWithLoader(a.IMAGE_PATH+"mask-mac.png"),a.images.mask.mac=e[0],i.push(e[1]),e=t.createImageWithLoader(a.IMAGE_PATH+"mask-pc.png"),a.images.mask.pc=e[0],i.push(e[1])}return $.when.apply(this,i)},a.cacheStickers=function(e){return a.stickersLoad=$.Deferred(),r.apiGet({api:"sticker.get"}).done(function(i){var n,o=[];$.each(i.stickers,function(){var e=this,i=!1;e._id in a.stickerMap?($.extend(a.stickerMap[e._id],e),a.stickerMap[e._id].path==e.path&&a.stickerMap[e._id].image&&(i=!0)):a.stickerMap[e._id]=e,i||(n=t.createImageWithLoader(s.STICKER_PATH+e.path+".png"),a.stickerMap[e._id].image=n[0],o.push(n[1]),a.stickerMap[e._id].smallImage=t.buildTree(["img",{src:s.STICKER_PATH+e.path+"_small.png"}]))}),a.stickersLoaded=!1;var r=$.when.apply(this,o);r.done(function(){a.stickersLoaded=!0,void 0!=e&&e(i),a.stickersLoad.resolve()})}),a.stickersLoad.promise()},a.messageHandler=function(e){!e.hasOwnProperty("msgid")&&void 0!=e.command&&e.command in a.messageHandlers&&a.messageHandlers[e.command](e)},a.messageHandlers={add_dj:function(e){var t=e.user[0].userid;a.stickerPlacements[t]=e.placements},rem_dj:function(e){var t=e.user[0].userid;t==a.hoverUserid&&a.djLaptopLeave()},update_sticker_placements:function(e){var t=e.userid;a.stickerPlacements[t]=e.placements,a.updateDjStickerPlacements(t)}},a.addStickerPlacements=function(e,t){$.each(t,function(e,t){a.stickerPlacements[e]=t})},a.drawDjStickerPlacements=function(e,i,n,o,s){if(!(turntable.sOxwLW.users[i].laptop in{iphone:1,android:1})){if(!a.stickersLoaded)return a.stickersLoad.done(function(){a.drawDjStickerPlacements(e,i,n,o)}),void 0;s||(s=$(".dj-laptop[data-userid="+i+"]"));var r="mac"===turntable.sOxwLW.users[i].laptop,l=0,u=0;.1>o?(l=r?"3px":"1px",u="3px"):.2>o&&(l=r?"4px":0,u="5px");var d=s.find("canvas");1!==d.length&&(d=$(t.buildTree(["canvas.laptopCanvas",{width:n.x,height:n.y,data:{userid:i},style:{position:"absolute",top:l,left:u}}])).appendTo(s));var h=d[0].getContext("2d");a.drawStickerPlacementsCanvas(i,h,o)}},a.updateDjStickerPlacements=function(e){if(!(turntable.sOxwLW.users[e].laptop in{iphone:1,android:1})){var t=$(".dj-laptop[data-userid="+e+"]");if(1==t.length){var i=t.find("canvas");1!=i.length&&LOG("Canvas for DJ's laptop not found: "+e);var n=i[0].getContext("2d");n.clearRect(0,0,a.SCREEN_WIDTH,a.SCREEN_HEIGHT),a.drawStickerPlacementsCanvas(e,n,a.DJ_RATIO)}}},a.drawStickerCSS=function(e){if(!(e in this.stickerMap))return null;var i=this.stickerMap[e],n=t.buildTree(this.layouts.sticker);return n.style.background="url("+i.image.src+")",n.style.height=i.image.height+"px",n.style.width=i.image.width+"px",n},a.drawStickerPlacementCSS=function(e,t){var i=a.drawStickerCSS(t.sticker_id);if(!i)return!1;var n=$(i),o=a.stickerMap[t.sticker_id];o.price&&!o.purchased&&n.css("opacity",a.UNPURCHASED_STICKER_OPACITY);var s="rotate("+t.angle+"deg)";n.css({top:t.top+"px",left:t.left+"px",transform:s}),$.data(i,t),e.append(i),a.numPlacements++,a.updateSlotCount()},a.drawStickerPlacementsCanvas=function(e,t,i,n,o,s){t.save(),i&&t.scale(i,i),n&&t.translate(n.x,n.y);for(var r=a.stickerPlacements[e],l=r.length,u=0;l>u;u++){var d=r[u];if(!a.stickerMap.hasOwnProperty(d.sticker_id)){if(o)continue;return t.restore(),a.cacheStickers(function(){a.drawStickerPlacementsCanvas(e,t,i,n,!0)}),void 0}var h=a.stickerMap[d.sticker_id],c=h.image.width/2,p=h.image.height/2,f=d.left+c,m=d.top+p;t.save(),t.translate(f,m),t.rotate(d.angle*Math.PI/180);var g=h.image;(.2>i||s)&&(g=h.smallImage),t.drawImage(g,-1*c,-1*p,h.image.width,h.image.height),t.restore()}t.restore()},a.drawLaptopCanvas=function(e,t,i,n,o){n||(n=e&&turntable.sOxwLW?turntable.sOxwLW.userMap[e].get("laptop"):"mac"),n in{iphone:1,android:1}||("pc"===n&&(n="windows"),e&&(offset={x:a.SCREEN_OFFSET_X,y:a.SCREEN_OFFSET_Y},a.drawStickerPlacementsCanvas(e,t,i,offset,!1,o)),t.save(),t.scale(i,i),t.globalCompositeOperation="destination-in",t.drawImage(a.images.screen[n],0,0),t.globalCompositeOperation="destination-over",t.drawImage(a.images.laptop[n],0,0),t.restore())},a.djLaptopEnter=function(e){var t=$(this),i=t.data("userid");a.replaceUpdateZoomCanvas(t,i),a.djLaptopHover(e),a.$zoomView.show()},a.djLaptopHover=function(e){a.$zoomView.css({top:e.pageY+10,left:e.pageX-a.ZOOM_VIEW_RADIUS}),a.updateZoomCanvas(e)},a.djLaptopLeave=function(){a.$zoomView.hide()},a.replaceUpdateZoomCanvas=function(e,t){var i=e.offset(),n=turntable.sOxwLW.users[t].laptop;a.images.laptop[n];var o=this.context,s=a.SCREEN_HEIGHT*a.ZOOM_RATIO-a.ZOOM_VIEW_RADIUS+22,r=a.ZOOM_VIEW_RADIUS-8,l=a.tempContext;l.drawImage(a.images.wallpaper,0,0),l.save(),l.translate(a.ZOOM_VIEW_RADIUS,a.ZOOM_VIEW_RADIUS),a.drawLaptopCanvas(t,l,a.ZOOM_RATIO),l.restore(),a.updateZoomCanvas=function(t){var n=(t.pageX-i.left)/e.width(),l=(t.pageY-i.top)/e.height(),u=a.SCREEN_WIDTH*a.ZOOM_RATIO*n,d=Math.max(Math.min(a.SCREEN_HEIGHT*a.ZOOM_RATIO*l,s),r),h=-u-a.SCREEN_OFFSET_X*a.ZOOM_RATIO,c=-d-a.SCREEN_OFFSET_Y*a.ZOOM_RATIO;o.drawImage(a.tempCanvas,h,c)}},a.showEditor=function(e){a.cacheStickers(function(){a.stickerPickerEventHandlersSet=!1,t.buildTree(a.layouts.editView,a),e.shouldRoute&&(a.modal.options.preCloseCallback=r.modalCloseOverride),l.modal=a.modal;var i=a.modal.$el;a.$laptopView=a.modal.$el.find("#laptopView"),r.apiGet({api:"sticker.get_placements"}).done(function(e){$.each(e.placements,function(){a.drawStickerPlacementCSS(a.$laptopView,this)}),a.refreshPurchaseData(),a.modal.show()}),a.modal.$el.find("#remainingNumber").text(a.MAX_PLACEMENTS),a.numPlacements=0;var o=n.user.get("laptop");"pc"===o&&(o="windows"),i.find("#laptopScreen").css("background","url("+a.images.screen[o].src+")"),"mac"!=o&&(o="pc"),i.find("#laptopMask").css("background","url("+a.images.mask[o].src+") bottom left");var s=t.buildTree(a.layouts.boundingBox);a.$boundingBox=$(s),i.find("#laptopScreen").append(s),a.addLaptopViewListeners(),a.$boundingBox.on("mouseup","#boundingBoxX",a.removeCurrentSticker),i.find("#stickerSaveButton").click(a.save),a.$laptopView.on("dragover",a.stickerDragOver).on("dragenter",a.stickerDragOver).on("drop",a.stickerDrop)})},a.refreshPurchaseData=function(){r.apiGet({api:"sticker.get_purchased_stickers"}).done(function(e){var t=e;for(stickerid in a.stickerMap)a.stickerMap.hasOwnProperty(stickerid)&&(a.stickerMap[stickerid].purchased=!1);for(var i=t.stickers,n=i.length,o=0;n>o;o++){var s=a.stickerMap[i[o].sticker_id];s.purchased=!0}a.initStickerPicker(),a.checkForUnpurchasedStickers(),a.modal.$el.find("#laptopView").find(".sticker").each(function(){var e=$(this),t=$.data(this,"sticker_id"),i=a.stickerMap[t];i.price&&(i.purchased?e.css("opacity",""):e.css("opacity",a.UNPURCHASED_STICKER_OPACITY))})})},a.initStickerPicker=function(){var e=a.modal.$el.find("#picker"),i=0,n=e.find("#stickerList").empty();$.each(a.stickerMap,function(e,o){if("active"==o.state){i+=1;var s=t.buildTree(a.layouts.sticker),r=$(s),l=t.buildTree(["div.stickerImage"]),u=$(l);$.data(s,o),r.attr("draggable","true"),u.css({"background-image":"url("+o.image.src+")"}),o.image.height<100&&o.image.width<100&&u.css("background-size","auto");var d=t.buildTree(a.layouts.stickerContainer),h=$(d);h.prepend(l).prepend(s).find(".stickerName").text(o.name);var c=!1,p=h.find(".priceInfo");if(0==o.price)c=!0;else if(o.purchased)p.text("Purchased");else{var f=o.price.toString();f="$"+f.slice(0,-2)+"."+f.slice(-2),p.text(f)}n.append(d)}}),n.css({width:i*a.PICKER_STICKER_WIDTH,left:0}),a.numPages=Math.ceil(i/4),a.currentPage=0;var o=e.find("#stickerListScrollLeft"),s=e.find("#stickerListScrollRight");o.addClass("inactive"),a.numPages>1?s.addClass("active"):s.addClass("inactive"),a.stickerPickerEventHandlersSet||(o.click(a.stickerListScrollLeft),s.click(a.stickerListScrollRight),a.stickerPickerEventHandlersSet=!0,n.on("dragstart",".sticker",a.stickerDragStart))},a.stickerListScrollLeft=function(){a.currentPage>0&&(a.currentPage==a.numPages-1&&$("#stickerListScrollRight").removeClass("inactive").addClass("active"),a.currentPage--,$("#stickerList").css({left:4*-a.currentPage*a.PICKER_STICKER_WIDTH}),0==a.currentPage&&$("#stickerListScrollLeft").removeClass("active").addClass("inactive"))},a.stickerListScrollRight=function(){a.currentPage<a.numPages-1&&(0==a.currentPage&&$("#stickerListScrollLeft").removeClass("inactive").addClass("active"),a.currentPage++,$("#stickerList").css({left:4*-a.currentPage*a.PICKER_STICKER_WIDTH}),a.currentPage==a.numPages-1&&$("#stickerListScrollRight").removeClass("active").addClass("inactive"))},a.save=function(){var e=a.getUnpurchasedStickers();if(e.length)return!1;var t=$.map($("#laptopView").find(".sticker"),function(e){return $.data(e)});return r.apiPost({api:"sticker.place",placements:t}).done(function(){n.router.setRoute("profile",{userId:n.user.id})}).fail(function(e){var t=e.err;1!=t.indexOf("slow")?a.modal.showAlert(e.err):1!=t.indexOf("limit")?a.modal.showAlert("You've passed the sticker limit. Please remove some and try saving again."):1!=t.indexOf("unpurchased")?a.modal.showAlert("You must purchase the paid stickers."):a.modal.showAlert("Sorry, there was an error saving your stickers. Please try again.")}),!1},a.removeCurrentSticker=function(){$(a.currentSticker).remove(),a.numPlacements--,a.updateSlotCount(),a.checkForUnpurchasedStickers()},a.updateSlotCount=function(){var e=a.MAX_PLACEMENTS-a.numPlacements;a.modal.$el.find("#remainingNumber").text(e);var t=a.modal.$el.find("#picker .sticker");0==e?t.addClass("inactive").removeAttr("draggable"):1==e&&t.removeClass("inactive").attr("draggable","true")},a.getOffsetFromTarget=function(e,t){var i;return i=t?t.offset():$(e.target).offset(),{x:e.originalEvent.pageX-i.left,y:e.originalEvent.pageY-i.top}},a.stickerDragStart=function(e){var t=$(this).parent();e.originalEvent.dataTransfer.effectAllowed="copyMove";var i=a.getOffsetFromTarget(e),n=$.data(this),o=i.x/t.width()*n.image.width,s=i.y/t.height()*n.image.height,r=['{"sticker_id": "',n._id,'"',', "offsetX": ',o,', "offsetY": ',s,"}"].join("");e.originalEvent.dataTransfer.setDragImage(a.stickerMap[n._id].image,o,s),e.originalEvent.dataTransfer.setData("text",r)},a.stickerDragOver=function(e){return e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy",!1},a.stickerDrop=function(e){if(e.preventDefault(),e.stopPropagation(),a.numPlacements>=a.MAX_PLACEMENTS)return!1;$dropZone=$(this);var t=e.originalEvent.dataTransfer.getData("text");t=$.parseJSON(t);var i=a.getOffsetFromTarget(e,$dropZone),n=Math.ceil(i.y-t.offsetY),o=Math.ceil(i.x-t.offsetX),s={sticker_id:t.sticker_id,top:n,left:o,angle:0};return a.drawStickerPlacementCSS(a.$laptopView,s),a.checkForUnpurchasedStickers(),!1},a.getCorners=function(e){var t=e.style.left;t=parseInt(t.substring(0,t.length-2));var i=e.style.top;i=parseInt(i.substring(0,i.length-2));var n=e.style.width;n=parseInt(n.substring(0,n.length-2));var o=e.style.height;o=parseInt(o.substring(0,o.length-2));for(var s=n/2,r=o/2,a=[[-1*s,-1*r],[s,-1*r],[s,r],[-1*s,r]],l=[],u=a.length,d=$.data(e,"angle")*Math.PI/180,h=0;u>h;h++){var c=a[h];l[h]=[c[0]*Math.cos(d)-c[1]*Math.sin(d),c[0]*Math.sin(d)+c[1]*Math.cos(d)]}for(var p=t+s,f=i+r,h=0;u>h;h++){var c=l[h];l[h]=[c[0]+p,c[1]+f]}return l},a.addLaptopViewListeners=function(){a.$laptopView.on("mouseenter",".sticker",a.showBoundingBox),a.$boundingBox.on("mouseleave",a.hideBoundingBox).on("mouseenter",a.cancelHideBoundingBox).on("mousedown",a.boundingBoxDrag)},a.removeLaptopViewListeners=function(){a.$laptopView.off("mouseenter",".sticker",a.showBoundingBox),a.$boundingBox.off("mouseleave",a.hideBoundingBox).off("mouseenter",a.cancelHideBoundingBox).off("mousedown",a.boundingBoxDrag)},a.showBoundingBox=function(){a.currentSticker=this;var e=a.getCorners(this),t=function(e){return e[0]},i=function(e){return e[1]},n=Math.min.apply(Math,e.map(t)),o=Math.max.apply(Math,e.map(t)),s=Math.min.apply(Math,e.map(i)),r=Math.max.apply(Math,e.map(i)),l=o-n,u=r-s,d=a.stickerMap[$.data(this,"sticker_id")],h=a.$boundingBox.find(".unpurchased");d.price&&0==d.purchased?(95>l?h.text("$"):h.text("UNPURCHASED"),h.show()):a.$boundingBox.find(".unpurchased").hide(),a.$boundingBox.find(".top.left").css("cursor","url("+a.IMAGE_PATH+"rotate_top_left.png) 12 12"+", auto"),a.$boundingBox.find(".bottom.left").css("cursor","url("+a.IMAGE_PATH+"rotate_bottom_left.png) 12 12"+", auto"),a.$boundingBox.find(".bottom.right").css("cursor","url("+a.IMAGE_PATH+"rotate_bottom_right.png) 12 12"+", auto"),a.$boundingBox.hide().css("transform",""),a.$boundingBox.css({width:l,height:u}),window.setTimeout(function(){a.$boundingBox.css({left:n,top:s}).show()})},a.hideBoundingBox=function(){a.hideTimer=window.setTimeout(function(){a.$boundingBox.hide()},1e3)},a.cancelHideBoundingBox=function(){window.clearTimeout(a.hideTimer)},a.boundingBoxDrag=function(e){e.preventDefault(),e.stopPropagation(),a.removeLaptopViewListeners();var t=this,i=$(this),n=a.currentSticker,o=$(n),s=e.pageX,r=e.pageY,l=a.$laptopView.offset(),u=n.style.left;u=parseInt(u.substring(0,u.length-2));var d=n.style.top;d=parseInt(d.substring(0,d.length-2));var h=t.style.left;h=parseInt(h.substring(0,h.length-2));var c=t.style.top;c=parseInt(c.substring(0,c.length-2));var p=t.style.width;p=parseInt(p.substring(0,p.length-2));var f=t.style.height;f=parseInt(f.substring(0,f.length-2));var m=p/2,g=f/2,v=!1;corners=[[h,c],[h+p,c],[h+p,c+f],[h,c+f]];for(var b=corners.length,w=0;b>w;w++){var y=corners[w];if(Math.abs(l.left+y[0]-s)<a.CORNER_DRAG_RADIUS&&Math.abs(l.top+y[1]-r)<a.CORNER_DRAG_RADIUS){v=!0;break}}if(v){var _,x,S=l.left+h+m,k=l.top+c+g,C=s-S,T=k-r;a.newStickerAngle,_=$.data(n,"angle"),x=a.getAngle(C,T);var I=!1,M=$("#overlay"),P=null;M.mousemove(a.boundingBoxDragRotate(S,k,P,M,i,o,_,x,I)),M.mouseup(function(){a.addLaptopViewListeners(),i.hide(),i.find(".dragBox").show(),$("#boundingBoxX").show(),$.data(n,{angle:a.newStickerAngle}),M.off("mousemove").off("mouseup"),M.css("cursor","auto"),i.css("cursor","")})}else{var A={};$("#laptopScreen").mousemove(a.boundingBoxDragMove(s,r,l,h,c,u,d,A,o,i)),$("#laptopScreen").mouseup(function(){a.addLaptopViewListeners(),$.data(n,{top:A.top,left:A.left}),$("#laptopScreen").unbind("mousemove").unbind("mouseup")})}},a.boundingBoxDragRotate=function(e,t,i,n,o,s,r,l,u){return function(d){d.preventDefault(),d.stopPropagation(),u||($("#boundingBoxX").hide(),o.find(".dragBox").hide(),o.find(".unpurchased").hide(),u=!0);var h=d.pageX,c=d.pageY,p=h-e,f=t-c,m=a.getAngle(p,f);if(cursor=a.getRotateCursor(m),null==i||cursor!=i){i=cursor;var g="url("+a.IMAGE_PATH+"rotate_"+cursor+".png) 12 12, auto";n.css("cursor",g),o.css("cursor",g)}newAngle=m-l,d.shiftKey&&(newAngle=45*Math.round(newAngle/45)),a.newStickerAngle=r+newAngle;var v="rotate("+a.newStickerAngle+"deg)";s.css("transform",v),v="rotate("+newAngle+"deg)",o.css("transform",v)}},a.boundingBoxDragMove=function(e,t,i,n,o,s,r,l,u,d){return function(h){var c,p,f=h.pageX,m=h.pageY;f<i.left||m<i.top||f>i.left+a.SCREEN_WIDTH||m>i.top+a.SCREEN_HEIGHT||(l.left=s+f-e,l.top=r+m-t,c=n+f-e,p=o+m-t,u.css({left:l.left+"px",top:l.top+"px"}),d.css({left:c+"px",top:p+"px"}))}},a.getAngle=function(e,t){var i=Math.atan(e/t),n=180*i/Math.PI;return 0>t&&(n=180+n),n},a.getRotateCursor=function(e){for(;0>e;)e+=360;return e%=360,e>=0&&90>e?"top_right":e>=90&&180>e?"bottom_right":e>=180&&270>e?"bottom_left":"top_left"},a.checkForUnpurchasedStickers=function(){var e=a.modal.$el.find(".submit");a.getUnpurchasedStickers().length?e.text("Checkout"):e.text("Save")},a.getUnpurchasedStickers=function(){var e={};$.map(a.modal.$el.find("#laptopView").find(".sticker"),function(t){var i=a.stickerMap[$.data(t,"sticker_id")];!i.price||1==i.purchased||i.sticker_id in e||(e[i._id]=!0)});var t=[];for(key in e)e.hasOwnProperty(key)&&t.push(key);return t},a.purchaseCallback=function(){t.buildTree(a.layouts.successModal,a),a.successModal.show(),a.refreshPurchaseData()},a.cancelCallback=function(){a.modal.show()},a.layouts={zoomView:["div#zoomView",["canvas#zoomCanvas"],["div#zoomOverlay"]],stickerContainer:["div.stickerContainer",["div.stickerName"],["div.priceInfo"]],sticker:["div.sticker"],boundingBox:["div.boundingBox",["div.unpurchased","UNPURCHASED"],["div#boundingBoxX"],["div.dragBox.top.left"],["div.dragBox.bottom.left"],["div.dragBox.bottom.right"]],successModal:[i,{id:"stickerSuccessModal",idd:"successModal",title:"Success!",showClose:!1,clickOut:!1,submitCallback:function(){a.modal.show()},submitText:"Sweet!",showCancel:!1},["div.hellsYeah"],["div.section.top",["Sticker acquired! You may now review and ","save your sticker placements."].join("")]]},a.layouts.editView=[i,{id:"stickerModal",title:"Edit Your Laptop Cover",submitText:"Save",submitCallback:a.save,showCancel:!1},["div#laptop",["div#laptopScreen",["div#laptopView"]],["div#laptopMask"]],["h3","Your Stickers"],["div#remainingCount",["span#remainingNumber"]," slots remaining."],["div#picker",["div#stickerListScrollLeft"],["div#stickerScroller",["div#stickerList"]],["div#stickerListScrollRight"]]];var l=a;return o.DEBUG_MODE||(l={init:a.init,showEditor:a.showEditor,drawLaptopCanvas:a.drawLaptopCanvas,loading:a.loading}),l});var httpStream=function(){function e(){var e=Array.prototype.slice.call(arguments),t=e[0];if(e=e.slice(1),p&&p.apply(null,arguments),"initialized"==t){if(h)return;LOG("HTTPSimpleStream initialized"),h=$("#httpstream")[0],h.setVolume(String(httpStream.volume)),c&&a()}else"streamstart"==t?m="buffered":"resync"==t?m="buffering":"streamfinish"==t?(f="stopped",m="",g&&g()):"status"==t&&LOG("HTTPSimpleStream status: "+e[0])}function t(e){p=e}function i(e,t,i,n,o){c={args:[e,t,i,Number(n)],time:util.now()},h&&a(),g=o&&o.onfinish}function n(){c=null,f="stopped",m="",h&&h.closeStream("")}function o(e){httpStream.volume=e,h&&h.setVolume(String(e))}function s(){return"playing"==f}function r(){return f}function a(){var e=c,t=util.now()-e.time;e[3]+=t,e.time+=t,h.loadStream(e.args.join(",")),f="playing",m="buffering"}function l(){return Number(h.getPosition(""))}function u(){f="paused",h&&h.pause("")}function d(e){f="playing",h&&h.resume(""),g=e&&e.onfinish}var h=null,c=null,p=null,f="stopped",m="",g=null;return{volume:100,setVolume:o,callback:e,setCallback:t,loadStream:i,closeStream:n,isPlaying:s,getPosition:l,getPlayState:r,pause:u,play:d}}();HTTPSimpleStreamCallback=httpStream.callback,define("httpstream",function(e){return function(){var t;return t||e.httpStream}}(this));var io=this.io={SOCKET_LOG:function(e){window.turntable&&turntable.socketLog("[object Object]"==String(e)?"[]":e)},version:"0.6.3",setPath:function(e){window.console&&console.error&&console.error("io.setPath will be removed. Please set the variable WEB_SOCKET_SWF_LOCATION pointing to WebSocketMain.swf"),this.path=/\/$/.test(e)?e:e+"/",WEB_SOCKET_SWF_LOCATION=e+"lib/vendor/web-socket-js/WebSocketMain.swf"}};"jQuery"in this&&(jQuery.io=this.io),"undefined"!=typeof window&&"undefined"==typeof WEB_SOCKET_SWF_LOCATION&&(WEB_SOCKET_SWF_LOCATION="/socket.io/lib/vendor/web-socket-js/WebSocketMain.swf"),function(){var e=this.io,t=!1;e.util={load:function(e){return/loaded|complete/.test(document.readyState)||t?e():("attachEvent"in window?window.attachEvent("onload",e):window.addEventListener("load",e,!1),void 0)},defer:function(t){return e.util.webkit?(e.util.load(function(){setTimeout(t,100)}),void 0):t()},inherit:function(e,t){for(var i in t.prototype)e.prototype[i]=t.prototype[i]},indexOf:function(e,t,i){for(var n=e.length,o=0>i?Math.max(0,n+i):i||0;n>o;o++)if(e[o]===t)return o;return-1},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},merge:function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])}},e.util.webkit=/webkit/i.test(navigator.userAgent),e.util.load(function(){t=!0})}(),function(){var e=this.io,t="~m~",i=function(e){if("[object Object]"==Object.prototype.toString.call(e)){if(!("JSON"in window)){var t="Socket.IO Error: Trying to encode as JSON, but JSON.stringify is missing.";if(!("console"in window&&console.error))throw new Error(t);return console.error(t),'{ "$error": "'+t+'" }'}return"~j~"+JSON.stringify(e)}return String(e)},n=e.Transport=function(t,i){this.base=t,this.options={timeout:15e3},e.util.merge(this.options,i)};n.prototype.send=function(){throw new Error("Missing send() implementation")},n.prototype.connect=function(){throw new Error("Missing connect() implementation")},n.prototype.disconnect=function(){throw new Error("Missing disconnect() implementation")},n.prototype.encode=function(n){var o,s="";n=e.util.isArray(n)?n:[n];for(var r=0,a=n.length;a>r;r++)o=null===n[r]||void 0===n[r]?"":i(n[r]),s+=t+o.length+t+o;return s},n.prototype.decode=function(e){var i,n,o=[];do{if(e.substr(0,3)!==t)return o;e=e.substr(3),i="",n="";for(var s=0,r=e.length;r>s;s++){if(n=Number(e.substr(s,1)),e.substr(s,1)!=n){e=e.substr(i.length+t.length),i=Number(i);break}i+=n}o.push(e.substr(0,i)),e=e.substr(i)}while(""!==e);return o},n.prototype.onData=function(e){this.setTimeout();var t=this.decode(e);if(t&&t.length)for(var i=0,n=t.length;n>i;i++)this.onMessage(t[i])},n.prototype.setTimeout=function(){var e=this;this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){e.onTimeout()},this.options.timeout)},n.prototype.onTimeout=function(){e.SOCKET_LOG("timeout"),this.onDisconnect()},n.prototype.onMessage=function(e){this.sessionid?"~h~"==e.substr(0,3)?this.onHeartbeat(e.substr(3)):"~j~"==e.substr(0,3)?this.base.onMessage(JSON.parse(e.substr(3))):this.base.onMessage(e):(this.sessionid=e,this.onConnect())},n.prototype.onHeartbeat=function(t){"websocket"==this.type&&e.SOCKET_LOG(this.sockets[0].id+":hb"),this.send("~h~"+t)},n.prototype.onConnect=function(){this.connected=!0,this.connecting=!1,this.base.onConnect(),this.setTimeout()},n.prototype.onDisconnect=function(){this.timeout&&clearTimeout(this.timeout),this.connecting=!1,this.connected=!1,this.sessionid=null,this.base.onDisconnect()},n.prototype.prepareUrl=function(){return(this.base.options.secure?"https":"http")+"://"+this.base.host+":"+this.base.options.port+"/"+this.base.options.resource+"/"+this.type+(this.sessionid?"/"+this.sessionid:"/")}}(),function(){var e=this.io,t=new Function,i=function(){if(!("XMLHttpRequest"in window))return!1;var e=new XMLHttpRequest;return void 0!=e.withCredentials}(),n=function(e){if("XDomainRequest"in window&&e)return new XDomainRequest;if("XMLHttpRequest"in window&&(!e||i))return new XMLHttpRequest;if(!e){try{var t=new ActiveXObject("MSXML2.XMLHTTP");return t}catch(n){}try{var o=new ActiveXObject("Microsoft.XMLHTTP");return o}catch(n){}}return!1},o=e.Transport.XHR=function(){e.Transport.apply(this,arguments),this.sendBuffer=[]};e.util.inherit(o,e.Transport),o.prototype.connect=function(){return this.get(),this},o.prototype.checkSend=function(){if(!this.posting&&this.sendBuffer.length){var e=this.encode(this.sendBuffer);this.sendBuffer=[],this.sendIORequest(e)}},o.prototype.send=function(t){return e.util.isArray(t)?this.sendBuffer.push.apply(this.sendBuffer,t):this.sendBuffer.push(t),this.checkSend(),this},o.prototype.sendIORequest=function(e){var i=this;
this.posting=!0,this.sendXHR=this.request("send","POST"),this.sendXHR.onreadystatechange=function(){var e;if(4==i.sendXHR.readyState){i.sendXHR.onreadystatechange=t;try{e=i.sendXHR.status}catch(n){}i.posting=!1,200==e?i.checkSend():i.onDisconnect()}},this.sendXHR.send("data="+encodeURIComponent(e))},o.prototype.disconnect=function(){return this.onDisconnect(),this},o.prototype.onDisconnect=function(){if(this.xhr){this.xhr.onreadystatechange=t;try{this.xhr.abort()}catch(i){}this.xhr=null}if(this.sendXHR){this.sendXHR.onreadystatechange=t;try{this.sendXHR.abort()}catch(i){}this.sendXHR=null}this.sendBuffer=[],e.Transport.prototype.onDisconnect.call(this)},o.prototype.request=function(e,t,i){var o=n(this.base.isXDomain());return i&&(o.multipart=!0),o.open(t||"GET",this.prepareUrl()+(e?"/"+e:"")),"POST"==t&&"setRequestHeader"in o&&o.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=utf-8"),o},o.check=function(e){try{if(n(e))return!0}catch(t){}return!1},o.xdomainCheck=function(){return o.check(!0)},o.request=n}(),function(){var e=this.io,t=e.Transport.websocket=function(){e.Transport.apply(this,arguments)};e.util.inherit(t,e.Transport),t.prototype.type="websocket",t.prototype.connect=function(){var t=this;this.sockets||(this.sockets=[]);var i=new WebSocket(this.prepareUrl());return this.sockets.unshift(i),e.socketsCreated=(e.socketsCreated||0)+1,i.id="ws"+e.socketsCreated,e.SOCKET_LOG(i.id+":create"),i.onmessage=function(n){if((!t.base.connected||t.base.connecting)&&e.SOCKET_LOG(i.id+":awake"),t.sockets.length>1){var o=$.inArray(i,t.sockets);if(-1==o)return;t.sockets.splice(o,1);for(var s=0;s<t.sockets.length;s++)t.sockets[s].onmessage=null,t.sockets[s].onclose=null,t.sockets[s].onerror=null,t.sockets[s].close(),e.SOCKET_LOG(t.sockets[s].id+":kill");t.sockets=[i]}t.onData(n.data)},i.onclose=function(){e.SOCKET_LOG(i.id+":die");var n=$.inArray(i,t.sockets);-1!=n&&t.sockets.splice(n,1),t.onDisconnect()},i.onerror=function(e){t.onError(e)},this},t.prototype.send=function(e){return this.sockets.length&&this.sockets[0].send(this.encode(e)),this},t.prototype.disconnect=function(){if(this.sockets.length){for(;this.sockets.length;){var e=this.sockets.pop();e.onmessage=null,e.onclose=null,e.onerror=null,e.close()}this.onDisconnect()}return this},t.prototype.onError=function(e){this.base.emit("error",[e])},t.prototype.prepareUrl=function(){return(this.base.options.secure?"wss":"ws")+"://"+this.base.host+":"+this.base.options.port+"/"+this.base.options.resource+"/"+this.type+(this.sessionid?"/"+this.sessionid:"")},t.check=function(){return"WebSocket"in window&&WebSocket.prototype&&WebSocket.prototype.send&&!!WebSocket.prototype.send.toString().match(/native/i)&&"undefined"!=typeof WebSocket},t.xdomainCheck=function(){return!0}}(),function(){var e=this.io,t=e.Transport.flashsocket=function(){e.Transport.websocket.apply(this,arguments)};e.util.inherit(t,e.Transport.websocket),t.prototype.type="flashsocket",t.prototype.connect=function(){e.SOCKET_LOG("fsock:connect");var t=this,i=arguments;return WebSocket.__addTask(function(){e.Transport.websocket.prototype.connect.apply(t,i)}),this},t.prototype.send=function(){var t=this,i=arguments;return WebSocket.__addTask(function(){e.Transport.websocket.prototype.send.apply(t,i)}),this},t.check=function(){return"undefined"!=typeof WebSocket&&"__addTask"in WebSocket&&swfobject?swfobject.hasFlashPlayerVersion("10.0.0"):!1},t.xdomainCheck=function(){return!0}}(),function(){var e=this.io,t=e.Transport.htmlfile=function(){e.Transport.XHR.apply(this,arguments)};e.util.inherit(t,e.Transport.XHR),t.prototype.type="htmlfile",t.prototype.get=function(){var e=this;this.open(),window.attachEvent("onunload",function(){e.destroy()})},t.prototype.open=function(){this.doc=new ActiveXObject("htmlfile"),this.doc.open(),this.doc.write("<html></html>"),this.doc.parentWindow.s=this,this.doc.close();var e=this.doc.createElement("div");this.doc.body.appendChild(e),this.iframe=this.doc.createElement("iframe"),e.appendChild(this.iframe),this.iframe.src=this.prepareUrl()+"/"+ +new Date},t.prototype._=function(e,t){this.onData(e);var i=t.getElementsByTagName("script")[0];i.parentNode.removeChild(i)},t.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null,CollectGarbage()}},t.prototype.disconnect=function(){return this.destroy(),e.Transport.XHR.prototype.disconnect.call(this)},t.check=function(){if("ActiveXObject"in window)try{var t=new ActiveXObject("htmlfile");return t&&e.Transport.XHR.check()}catch(i){}return!1},t.xdomainCheck=function(){return!1}}(),function(){var e=this.io,t=e.Transport["xhr-multipart"]=function(){e.Transport.XHR.apply(this,arguments)};e.util.inherit(t,e.Transport.XHR),t.prototype.type="xhr-multipart",t.prototype.get=function(){var e=this;this.xhr=this.request("","GET",!0),this.xhr.onreadystatechange=function(){4==e.xhr.readyState&&e.onData(e.xhr.responseText)},this.xhr.send(null)},t.check=function(){return"XMLHttpRequest"in window&&"prototype"in XMLHttpRequest&&"multipart"in XMLHttpRequest.prototype},t.xdomainCheck=function(){return!0}}(),function(){var e=this.io,t=new Function,i=e.Transport["xhr-polling"]=function(){e.Transport.XHR.apply(this,arguments)};e.util.inherit(i,e.Transport.XHR),i.prototype.type="xhr-polling",i.prototype.connect=function(){var t=this;return e.util.defer(function(){e.Transport.XHR.prototype.connect.call(t)}),!1},i.prototype.get=function(){var e=this;this.xhr=this.request(+new Date,"GET"),this.xhr.onreadystatechange=function(){var i;if(4==e.xhr.readyState){e.xhr.onreadystatechange=t;try{i=e.xhr.status}catch(n){}200==i?(e.onData(e.xhr.responseText),e.get()):e.onDisconnect()}},this.xhr.send(null)},i.check=function(){return e.Transport.XHR.check()},i.xdomainCheck=function(){return e.Transport.XHR.xdomainCheck()}}(),function(){var e=this.io,t=e.Transport["jsonp-polling"]=function(){e.Transport.XHR.apply(this,arguments),this.insertAt=document.getElementsByTagName("head")[0],this.index=e.JSONP.length,e.JSONP.push(this)};e.util.inherit(t,e.Transport["xhr-polling"]),e.JSONP=[],t.prototype.type="jsonp-polling",t.prototype.sendIORequest=function(e){function t(){i(),n.posting=!1,n.checkSend()}function i(){n.iframe&&n.form.removeChild(n.iframe);try{o=document.createElement('<iframe name="'+n.iframeId+'">')}catch(e){o=document.createElement("iframe"),o.name=n.iframeId}o.id=n.iframeId,n.form.appendChild(o),n.iframe=o}var n=this;if(!("form"in this)){var o,s=document.createElement("FORM"),r=document.createElement("TEXTAREA"),a=this.iframeId="socket_io_iframe_"+this.index;s.style.position="absolute",s.style.top="-1000px",s.style.left="-1000px",s.target=a,s.method="POST",s.action=this.prepareUrl()+"/"+ +new Date+"/"+this.index,r.name="data",s.appendChild(r),this.insertAt.insertBefore(s,null),document.body.appendChild(s),this.form=s,this.area=r}i(),this.posting=!0,this.area.value=e;try{this.form.submit()}catch(l){}this.iframe.attachEvent?o.onreadystatechange=function(){"complete"==n.iframe.readyState&&t()}:this.iframe.onload=t},t.prototype.get=function(){var e=this,t=document.createElement("SCRIPT");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.prepareUrl()+"/"+ +new Date+"/"+this.index,t.onerror=function(){e.onDisconnect()},this.insertAt.insertBefore(t,null),this.script=t},t.prototype._=function(){return this.onData.apply(this,arguments),this.get(),this},t.check=function(){return!0},t.xdomainCheck=function(){return!0}}(),function(){var e=this.io,t=e.Socket=function(t,i){this.host=t||document.domain,this.options={secure:!1,document:document,port:document.location.port||80,resource:"socket.io",transports:["websocket","flashsocket","htmlfile","xhr-multipart","xhr-polling","jsonp-polling"],transportOptions:{"xhr-polling":{timeout:25e3},"jsonp-polling":{timeout:25e3}},connectTimeout:5e3,tryTransportsOnConnectTimeout:!0,reconnect:!0,reconnectionDelay:500,maxReconnectionAttempts:10,rememberTransport:!0},e.util.merge(this.options,i),this.connected=!1,this.connecting=!1,this.reconnecting=!1,this.events={},this.transport=this.getTransport(),!this.transport&&"console"in window&&console.error("No transport available")};t.prototype.getTransport=function(t){var i,n=t||this.options.transports;this.options.rememberTransport&&!t&&(i=this.options.document.cookie.match("(?:^|;)\\s*socketio=([^;]*)"),i&&(this.rememberedTransport=!0,n=[decodeURIComponent(i[1])]));for(var o,s=0;o=n[s];s++)if(e.Transport[o]&&e.Transport[o].check()&&(!this.isXDomain()||e.Transport[o].xdomainCheck()))return new e.Transport[o](this,this.options.transportOptions[o]||{});return null},t.prototype.connect=function(e){if(this.transport&&!this.connected&&(this.connecting&&"websocket"!=this.transport.type&&this.disconnect(!0),this.connecting=!0,this.emit("connecting",[this.transport.type]),this.transport.connect(),this.options.connectTimeout&&!this.reconnecting)){var t=this;this.connectTimeoutTimer=setTimeout(function(){if(!t.connected){if(t.disconnect(!0),t.options.tryTransportsOnConnectTimeout&&!t.rememberedTransport){t.remainingTransports||(t.remainingTransports=t.options.transports.slice(0));for(var e=t.remainingTransports;e.length>0&&e.splice(0,1)[0]!=t.transport.type;);e.length&&(t.transport=t.getTransport(e),t.connect())}t.remainingTransports&&0!=t.remainingTransports.length||t.emit("connect_failed")}t.remainingTransports&&0==t.remainingTransports.length&&delete t.remainingTransports},this.options.connectTimeout)}return e&&"function"==typeof e&&this.once("connect",e),this},t.prototype.send=function(e){return this.transport&&this.transport.connected?(this.transport.send(e),this):this.queue(e)},t.prototype.disconnect=function(e){return this.connectTimeoutTimer&&clearTimeout(this.connectTimeoutTimer),e||(this.options.reconnect=!1),this.transport.disconnect(),this},t.prototype.on=function(e,t){return e in this.events||(this.events[e]=[]),this.events[e].push(t),this},t.prototype.once=function(e,t){var i=this,n=function(){i.removeEvent(e,n),t.apply(i,arguments)};return n.ref=t,i.on(e,n),this},t.prototype.emit=function(e,t){if(e in this.events)for(var i=this.events[e].concat(),n=0,o=i.length;o>n;n++)i[n].apply(this,void 0===t?[]:t);return this},t.prototype.removeEvent=function(e,t){if(e in this.events)for(var i=0,n=this.events[e].length;n>i;i++)(this.events[e][i]==t||this.events[e][i].ref&&this.events[e][i].ref==t)&&this.events[e].splice(i,1);return this},t.prototype.queue=function(e){return"queueStack"in this||(this.queueStack=[]),this.queueStack.push(e),this},t.prototype.doQueue=function(){return"queueStack"in this&&this.queueStack.length?(this.transport.send(this.queueStack),this.queueStack=[],this):this},t.prototype.isXDomain=function(){var e=window.location.port||80;return this.host!==document.domain||this.options.port!=e},t.prototype.onConnect=function(){this.connected=!0,this.connecting=!1,this.doQueue(),this.options.rememberTransport&&(this.options.document.cookie="socketio="+encodeURIComponent(this.transport.type)),this.emit("connect")},t.prototype.onMessage=function(e){this.emit("message",[e])},t.prototype.onDisconnect=function(){var t=this.connected;this.connected=!1,this.connecting=!1,this.queueStack=[],t&&(e.SOCKET_LOG("dc"),this.emit("disconnect"),this.options.reconnect&&!this.reconnecting&&this.onReconnect())},t.prototype.onReconnect=function(){function e(){i.connected&&i.emit("reconnect",[i.transport.type,i.reconnectionAttempts]),i.removeEvent("connect_failed",t).removeEvent("connect",t),i.reconnecting=!1,delete i.reconnectionAttempts,delete i.reconnectionDelay,delete i.reconnectionTimer,delete i.redoTransports,i.options.tryTransportsOnConnectTimeout=n,i.options.rememberTransport=o}function t(){if(i.reconnecting)if(i.connected)e();else{var n=!i.connecting||"websocket"==i.transport.type;if(!n)return i.reconnectionTimer=setTimeout(t,1e3);i.reconnectionAttempts++>=i.options.maxReconnectionAttempts?i.redoTransports?(i.emit("reconnect_failed"),e()):(i.on("connect_failed",t),i.options.tryTransportsOnConnectTimeout=!0,i.disconnect(!0),i.transport=i.getTransport(i.options.transports),i.redoTransports=!0,i.connect()):(i.reconnectionDelay*=2,i.connect(),i.emit("reconnecting",[i.reconnectionDelay,i.reconnectionAttempts]),i.reconnectionTimer=setTimeout(t,i.reconnectionDelay))}}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options.reconnectionDelay;var i=this,n=this.options.tryTransportsOnConnectTimeout,o=this.options.rememberTransport;this.options.tryTransportsOnConnectTimeout=!1,this.reconnectionTimer=setTimeout(t,this.reconnectionDelay),this.on("connect",t)},t.prototype.fire=t.prototype.emit,t.prototype.addListener=t.prototype.addEvent=t.prototype.addEventListener=t.prototype.on,t.prototype.removeListener=t.prototype.removeEventListener=t.prototype.removeEvent}();var swfobject=function(){function e(){if(!q){try{var e=O.getElementsByTagName("body")[0].appendChild(g("span"));e.parentNode.removeChild(e)}catch(t){return}q=!0;for(var i=B.length,n=0;i>n;n++)B[n]()}}function t(e){q?e():B[B.length]=e}function i(e){if(typeof L.addEventListener!=M)L.addEventListener("load",e,!1);else if(typeof O.addEventListener!=M)O.addEventListener("load",e,!1);else if(typeof L.attachEvent!=M)v(L,"onload",e);else if("function"==typeof L.onload){var t=L.onload;L.onload=function(){t(),e()}}else L.onload=e}function n(){F?o():s()}function o(){var e=O.getElementsByTagName("body")[0],t=g(P);t.setAttribute("type",E);var i=e.appendChild(t);if(i){var n=0;!function(){if(typeof i.GetVariable!=M){var o=i.GetVariable("$version");o&&(o=o.split(" ")[1].split(","),H.pv=[parseInt(o[0],10),parseInt(o[1],10),parseInt(o[2],10)])}else if(10>n)return n++,setTimeout(arguments.callee,10),void 0;e.removeChild(t),i=null,s()}()}else s()}function s(){var e=N.length;if(e>0)for(var t=0;e>t;t++){var i=N[t].id,n=N[t].callbackFn,o={success:!1,id:i};if(H.pv[0]>0){var s=m(i);if(s)if(!b(N[t].swfVersion)||H.wk&&H.wk<312)if(N[t].expressInstall&&a()){var d={};d.data=N[t].expressInstall,d.width=s.getAttribute("width")||"0",d.height=s.getAttribute("height")||"0",s.getAttribute("class")&&(d.styleclass=s.getAttribute("class")),s.getAttribute("align")&&(d.align=s.getAttribute("align"));for(var h={},c=s.getElementsByTagName("param"),p=c.length,f=0;p>f;f++)"movie"!=c[f].getAttribute("name").toLowerCase()&&(h[c[f].getAttribute("name")]=c[f].getAttribute("value"));l(d,h,i,n)}else u(s),n&&n(o);else y(i,!0),n&&(o.success=!0,o.ref=r(i),n(o))}else if(y(i,!0),n){var g=r(i);g&&typeof g.SetVariable!=M&&(o.success=!0,o.ref=g),n(o)}}}function r(e){var t=null,i=m(e);if(i&&"OBJECT"==i.nodeName)if(typeof i.SetVariable!=M)t=i;else{var n=i.getElementsByTagName(P)[0];n&&(t=n)}return t}function a(){return!U&&b("6.0.65")&&(H.win||H.mac)&&!(H.wk&&H.wk<312)}function l(e,t,i,n){U=!0,k=n||null,C={success:!1,id:i};var o=m(i);if(o){"OBJECT"==o.nodeName?(x=d(o),S=null):(x=o,S=i),e.id=D,(typeof e.width==M||!/%$/.test(e.width)&&parseInt(e.width,10)<310)&&(e.width="310"),(typeof e.height==M||!/%$/.test(e.height)&&parseInt(e.height,10)<137)&&(e.height="137"),O.title=O.title.slice(0,47)+" - Flash Player Installation";var s=H.ie&&H.win?"ActiveX":"PlugIn",r="MMredirectURL="+L.location.toString().replace(/&/g,"%26")+"&MMplayerType="+s+"&MMdoctitle="+O.title;if(typeof t.flashvars!=M?t.flashvars+="&"+r:t.flashvars=r,H.ie&&H.win&&4!=o.readyState){var a=g("div");i+="SWFObjectNew",a.setAttribute("id",i),o.parentNode.insertBefore(a,o),o.style.display="none",function(){4==o.readyState?o.parentNode.removeChild(o):setTimeout(arguments.callee,10)}()}h(e,t,i)}}function u(e){if(H.ie&&H.win&&4!=e.readyState){var t=g("div");e.parentNode.insertBefore(t,e),t.parentNode.replaceChild(d(e),t),e.style.display="none",function(){4==e.readyState?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}else e.parentNode.replaceChild(d(e),e)}function d(e){var t=g("div");if(H.win&&H.ie)t.innerHTML=e.innerHTML;else{var i=e.getElementsByTagName(P)[0];if(i){var n=i.childNodes;if(n)for(var o=n.length,s=0;o>s;s++)1==n[s].nodeType&&"PARAM"==n[s].nodeName||8==n[s].nodeType||t.appendChild(n[s].cloneNode(!0))}}return t}function h(e,t,i){var n,o=m(i);if(H.wk&&H.wk<312)return n;if(o)if(typeof e.id==M&&(e.id=i),H.ie&&H.win){var s="";for(var r in e)e[r]!=Object.prototype[r]&&("data"==r.toLowerCase()?t.movie=e[r]:"styleclass"==r.toLowerCase()?s+=' class="'+e[r]+'"':"classid"!=r.toLowerCase()&&(s+=" "+r+'="'+e[r]+'"'));var a="";for(var l in t)t[l]!=Object.prototype[l]&&(a+='<param name="'+l+'" value="'+t[l]+'" />');o.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+s+">"+a+"</object>",z[z.length]=e.id,n=m(e.id)}else{var u=g(P);u.setAttribute("type",E);for(var d in e)e[d]!=Object.prototype[d]&&("styleclass"==d.toLowerCase()?u.setAttribute("class",e[d]):"classid"!=d.toLowerCase()&&u.setAttribute(d,e[d]));for(var h in t)t[h]!=Object.prototype[h]&&"movie"!=h.toLowerCase()&&c(u,h,t[h]);o.parentNode.replaceChild(u,o),n=u}return n}function c(e,t,i){var n=g("param");n.setAttribute("name",t),n.setAttribute("value",i),e.appendChild(n)}function p(e){var t=m(e);t&&"OBJECT"==t.nodeName&&(H.ie&&H.win?(t.style.display="none",function(){4==t.readyState?f(e):setTimeout(arguments.callee,10)}()):t.parentNode.removeChild(t))}function f(e){var t=m(e);if(t){for(var i in t)"function"==typeof t[i]&&(t[i]=null);t.parentNode.removeChild(t)}}function m(e){var t=null;try{t=O.getElementById(e)}catch(i){}return t}function g(e){return O.createElement(e)}function v(e,t,i){e.attachEvent(t,i),V[V.length]=[e,t,i]}function b(e){var t=H.pv,i=e.split(".");return i[0]=parseInt(i[0],10),i[1]=parseInt(i[1],10)||0,i[2]=parseInt(i[2],10)||0,t[0]>i[0]||t[0]==i[0]&&t[1]>i[1]||t[0]==i[0]&&t[1]==i[1]&&t[2]>=i[2]?!0:!1}function w(e,t,i,n){if(!H.ie||!H.mac){var o=O.getElementsByTagName("head")[0];if(o){var s=i&&"string"==typeof i?i:"screen";if(n&&(T=null,I=null),!T||I!=s){var r=g("style");r.setAttribute("type","text/css"),r.setAttribute("media",s),T=o.appendChild(r),H.ie&&H.win&&typeof O.styleSheets!=M&&O.styleSheets.length>0&&(T=O.styleSheets[O.styleSheets.length-1]),I=s}H.ie&&H.win?T&&typeof T.addRule==P&&T.addRule(e,t):T&&typeof O.createTextNode!=M&&T.appendChild(O.createTextNode(e+" {"+t+"}"))}}}function y(e,t){if(X){var i=t?"visible":"hidden";q&&m(e)?m(e).style.visibility=i:w("#"+e,"visibility:"+i)}}function _(e){var t=/[\\\"<>\.;]/,i=null!=t.exec(e);return i&&typeof encodeURIComponent!=M?encodeURIComponent(e):e}var x,S,k,C,T,I,M="undefined",P="object",$="Shockwave Flash",A="ShockwaveFlash.ShockwaveFlash",E="application/x-shockwave-flash",D="SWFObjectExprInst",R="onreadystatechange",L=window,O=document,j=navigator,F=!1,B=[n],N=[],z=[],V=[],q=!1,U=!1,X=!0,H=function(){var e=typeof O.getElementById!=M&&typeof O.getElementsByTagName!=M&&typeof O.createElement!=M,t=j.userAgent.toLowerCase(),i=j.platform.toLowerCase(),n=i?/win/.test(i):/win/.test(t),o=i?/mac/.test(i):/mac/.test(t),s=/webkit/.test(t)?parseFloat(t.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,r=!1,a=[0,0,0],l=null;if(typeof j.plugins!=M&&typeof j.plugins[$]==P)l=j.plugins[$].description,!l||typeof j.mimeTypes!=M&&j.mimeTypes[E]&&!j.mimeTypes[E].enabledPlugin||(F=!0,r=!1,l=l.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),a[0]=parseInt(l.replace(/^(.*)\..*$/,"$1"),10),a[1]=parseInt(l.replace(/^.*\.(.*)\s.*$/,"$1"),10),a[2]=/[a-zA-Z]/.test(l)?parseInt(l.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof L.ActiveXObject!=M)try{var u=new ActiveXObject(A);u&&(l=u.GetVariable("$version"),l&&(r=!0,l=l.split(" ")[1].split(","),a=[parseInt(l[0],10),parseInt(l[1],10),parseInt(l[2],10)]))}catch(d){}return{w3:e,pv:a,wk:s,ie:r,win:n,mac:o}}();return function(){H.w3&&((typeof O.readyState!=M&&"complete"==O.readyState||typeof O.readyState==M&&(O.getElementsByTagName("body")[0]||O.body))&&e(),q||(typeof O.addEventListener!=M&&O.addEventListener("DOMContentLoaded",e,!1),H.ie&&H.win&&(O.attachEvent(R,function(){"complete"==O.readyState&&(O.detachEvent(R,arguments.callee),e())}),L==top&&function(){if(!q){try{O.documentElement.doScroll("left")}catch(t){return setTimeout(arguments.callee,0),void 0}e()}}()),H.wk&&function(){return q?void 0:/loaded|complete/.test(O.readyState)?(e(),void 0):(setTimeout(arguments.callee,0),void 0)}(),i(e)))}(),function(){H.ie&&H.win&&window.attachEvent("onunload",function(){for(var e=V.length,t=0;e>t;t++)V[t][0].detachEvent(V[t][1],V[t][2]);for(var i=z.length,n=0;i>n;n++)p(z[n]);for(var o in H)H[o]=null;H=null;for(var s in swfobject)swfobject[s]=null;swfobject=null})}(),{registerObject:function(e,t,i,n){if(H.w3&&e&&t){var o={};o.id=e,o.swfVersion=t,o.expressInstall=i,o.callbackFn=n,N[N.length]=o,y(e,!1)}else n&&n({success:!1,id:e})},getObjectById:function(e){return H.w3?r(e):void 0},embedSWF:function(e,i,n,o,s,r,u,d,c,p){var f={success:!1,id:i};H.w3&&!(H.wk&&H.wk<312)&&e&&i&&n&&o&&s?(y(i,!1),t(function(){n+="",o+="";var t={};if(c&&typeof c===P)for(var m in c)t[m]=c[m];t.data=e,t.width=n,t.height=o;var g={};if(d&&typeof d===P)for(var v in d)g[v]=d[v];if(u&&typeof u===P)for(var w in u)typeof g.flashvars!=M?g.flashvars+="&"+w+"="+u[w]:g.flashvars=w+"="+u[w];if(b(s)){var _=h(t,g,i);t.id==i&&y(i,!0),f.success=!0,f.ref=_}else{if(r&&a())return t.data=r,l(t,g,i,p),void 0;y(i,!0)}p&&p(f)})):p&&p(f)},switchOffAutoHideShow:function(){X=!1},ua:H,getFlashPlayerVersion:function(){return{major:H.pv[0],minor:H.pv[1],release:H.pv[2]}},hasFlashPlayerVersion:b,createSWF:function(e,t,i){return H.w3?h(e,t,i):void 0},showExpressInstall:function(e,t,i,n){H.w3&&a()&&l(e,t,i,n)},removeSWF:function(e){H.w3&&p(e)},createCSS:function(e,t,i,n){H.w3&&w(e,t,i,n)},addDomLoadEvent:t,addLoadEvent:i,getQueryParamValue:function(e){var t=O.location.search||O.location.hash;if(t){if(/\?/.test(t)&&(t=t.split("?")[1]),null==e)return _(t);for(var i=t.split("&"),n=0;n<i.length;n++)if(i[n].substring(0,i[n].indexOf("="))==e)return _(i[n].substring(i[n].indexOf("=")+1))}return""},expressInstallCallback:function(){if(U){var e=m(D);e&&x&&(e.parentNode.replaceChild(x,e),S&&(y(S,!0),H.ie&&H.win&&(x.style.display="block")),k&&k(C)),U=!1}}}}();!function(){if(!window.WebSocket){var e=window.console;if(e&&e.log&&e.error||(e={log:function(){},error:function(){}}),!swfobject.hasFlashPlayerVersion("10.0.0"))return e.error("Flash Player >= 10.0.0 is required."),void 0;"file:"==location.protocol&&e.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),WebSocket=function(e,t,i,n,o){var s=this;s.__id=WebSocket.__nextId++,WebSocket.__instances[s.__id]=s,s.readyState=WebSocket.CONNECTING,s.bufferedAmount=0,s.__events={},t?"string"==typeof t&&(t=[t]):t=[],setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(s.__id,e,t,i||null,n||0,o||null)})},0)},WebSocket.prototype.send=function(e){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";var t=WebSocket.__flash.send(this.__id,encodeURIComponent(e));return 0>t?!0:(this.bufferedAmount+=t,!1)},WebSocket.prototype.close=function(){this.readyState!=WebSocket.CLOSED&&this.readyState!=WebSocket.CLOSING&&(this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id))},WebSocket.prototype.addEventListener=function(e,t){e in this.__events||(this.__events[e]=[]),this.__events[e].push(t)},WebSocket.prototype.removeEventListener=function(e,t){if(e in this.__events)for(var i=this.__events[e],n=i.length-1;n>=0;--n)if(i[n]===t){i.splice(n,1);break}},WebSocket.prototype.dispatchEvent=function(e){for(var t=this.__events[e.type]||[],i=0;i<t.length;++i)t[i](e);var n=this["on"+e.type];n&&n(e)},WebSocket.prototype.__handleEvent=function(e){"readyState"in e&&(this.readyState=e.readyState),"protocol"in e&&(this.protocol=e.protocol);var t;if("open"==e.type||"error"==e.type)t=this.__createSimpleEvent(e.type);else if("close"==e.type)t=this.__createSimpleEvent("close");else{if("message"!=e.type)throw"unknown event type: "+e.type;var i=decodeURIComponent(e.message);t=this.__createMessageEvent("message",i)}this.dispatchEvent(t)},WebSocket.prototype.__createSimpleEvent=function(e){if(document.createEvent&&window.Event){var t=document.createEvent("Event");return t.initEvent(e,!1,!1),t}return{type:e,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=function(e,t){if(document.createEvent&&window.MessageEvent&&!window.opera){var i=document.createEvent("MessageEvent");return i.initMessageEvent("message",!1,!1,t,null,null,window,null),i}return{type:e,data:t,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(e){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(e)})},WebSocket.__initialize=function(){if(!WebSocket.__flash){if(WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation),!window.WEB_SOCKET_SWF_LOCATION)return e.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf"),void 0;var t=document.createElement("div");t.id="webSocketContainer",t.style.position="absolute",WebSocket.__isFlashLite()?(t.style.left="0px",t.style.top="0px"):(t.style.left="-100px",t.style.top="-100px");var i=document.createElement("div");i.id="webSocketFlash",t.appendChild(i),document.body.appendChild(t),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(t){t.success||e.error("[WebSocket] swfobject.embedSWF failed")})}},WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash"),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var e=0;e<WebSocket.__tasks.length;++e)WebSocket.__tasks[e]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){return setTimeout(function(){try{for(var t=WebSocket.__flash.receiveEvents(),i=0;i<t.length;++i)WebSocket.__instances[t[i].webSocketId].__handleEvent(t[i])}catch(n){e.error(n)}},0),!0},WebSocket.__log=function(t){e.log(decodeURIComponent(t))},WebSocket.__error=function(t){e.error(decodeURIComponent(t))},WebSocket.__addTask=function(e){WebSocket.__flash?e():WebSocket.__tasks.push(e)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var e=window.navigator.mimeTypes["application/x-shockwave-flash"];return e&&e.enabledPlugin&&e.enabledPlugin.filename?e.enabledPlugin.filename.match(/flashlite/i)?!0:!1:!1},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||(window.addEventListener?window.addEventListener("load",function(){WebSocket.__initialize()},!1):window.attachEvent("onload",function(){WebSocket.__initialize()}))}}(),define("socket.io",["config"],function(e){return function(){var t;return t||e.io}}(this));var swfobject=function(){function e(){if(!q){try{var e=O.getElementsByTagName("body")[0].appendChild(g("span"));e.parentNode.removeChild(e)}catch(t){return}q=!0;for(var i=B.length,n=0;i>n;n++)B[n]()}}function t(e){q?e():B[B.length]=e}function i(e){if(typeof L.addEventListener!=M)L.addEventListener("load",e,!1);else if(typeof O.addEventListener!=M)O.addEventListener("load",e,!1);else if(typeof L.attachEvent!=M)v(L,"onload",e);else if("function"==typeof L.onload){var t=L.onload;L.onload=function(){t(),e()}}else L.onload=e}function n(){F?o():s()}function o(){var e=O.getElementsByTagName("body")[0],t=g(P);t.setAttribute("type",E);var i=e.appendChild(t);if(i){var n=0;!function(){if(typeof i.GetVariable!=M){var o=i.GetVariable("$version");o&&(o=o.split(" ")[1].split(","),H.pv=[parseInt(o[0],10),parseInt(o[1],10),parseInt(o[2],10)])}else if(10>n)return n++,setTimeout(arguments.callee,10),void 0;e.removeChild(t),i=null,s()}()}else s()}function s(){var e=N.length;if(e>0)for(var t=0;e>t;t++){var i=N[t].id,n=N[t].callbackFn,o={success:!1,id:i};if(H.pv[0]>0){var s=m(i);if(s)if(!b(N[t].swfVersion)||H.wk&&H.wk<312)if(N[t].expressInstall&&a()){var d={};d.data=N[t].expressInstall,d.width=s.getAttribute("width")||"0",d.height=s.getAttribute("height")||"0",s.getAttribute("class")&&(d.styleclass=s.getAttribute("class")),s.getAttribute("align")&&(d.align=s.getAttribute("align"));for(var h={},c=s.getElementsByTagName("param"),p=c.length,f=0;p>f;f++)"movie"!=c[f].getAttribute("name").toLowerCase()&&(h[c[f].getAttribute("name")]=c[f].getAttribute("value"));l(d,h,i,n)}else u(s),n&&n(o);else y(i,!0),n&&(o.success=!0,o.ref=r(i),n(o))}else if(y(i,!0),n){var g=r(i);g&&typeof g.SetVariable!=M&&(o.success=!0,o.ref=g),n(o)}}}function r(e){var t=null,i=m(e);if(i&&"OBJECT"==i.nodeName)if(typeof i.SetVariable!=M)t=i;else{var n=i.getElementsByTagName(P)[0];n&&(t=n)}return t}function a(){return!U&&b("6.0.65")&&(H.win||H.mac)&&!(H.wk&&H.wk<312)}function l(e,t,i,n){U=!0,k=n||null,C={success:!1,id:i};var o=m(i);if(o){"OBJECT"==o.nodeName?(x=d(o),S=null):(x=o,S=i),e.id=D,(typeof e.width==M||!/%$/.test(e.width)&&parseInt(e.width,10)<310)&&(e.width="310"),(typeof e.height==M||!/%$/.test(e.height)&&parseInt(e.height,10)<137)&&(e.height="137"),O.title=O.title.slice(0,47)+" - Flash Player Installation";var s=H.ie&&H.win?"ActiveX":"PlugIn",r="MMredirectURL="+L.location.toString().replace(/&/g,"%26")+"&MMplayerType="+s+"&MMdoctitle="+O.title;if(typeof t.flashvars!=M?t.flashvars+="&"+r:t.flashvars=r,H.ie&&H.win&&4!=o.readyState){var a=g("div");i+="SWFObjectNew",a.setAttribute("id",i),o.parentNode.insertBefore(a,o),o.style.display="none",function(){4==o.readyState?o.parentNode.removeChild(o):setTimeout(arguments.callee,10)}()}h(e,t,i)}}function u(e){if(H.ie&&H.win&&4!=e.readyState){var t=g("div");e.parentNode.insertBefore(t,e),t.parentNode.replaceChild(d(e),t),e.style.display="none",function(){4==e.readyState?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}else e.parentNode.replaceChild(d(e),e)}function d(e){var t=g("div");if(H.win&&H.ie)t.innerHTML=e.innerHTML;else{var i=e.getElementsByTagName(P)[0];if(i){var n=i.childNodes;if(n)for(var o=n.length,s=0;o>s;s++)1==n[s].nodeType&&"PARAM"==n[s].nodeName||8==n[s].nodeType||t.appendChild(n[s].cloneNode(!0))}}return t}function h(e,t,i){var n,o=m(i);if(H.wk&&H.wk<312)return n;if(o)if(typeof e.id==M&&(e.id=i),H.ie&&H.win){var s="";for(var r in e)e[r]!=Object.prototype[r]&&("data"==r.toLowerCase()?t.movie=e[r]:"styleclass"==r.toLowerCase()?s+=' class="'+e[r]+'"':"classid"!=r.toLowerCase()&&(s+=" "+r+'="'+e[r]+'"'));var a="";for(var l in t)t[l]!=Object.prototype[l]&&(a+='<param name="'+l+'" value="'+t[l]+'" />');o.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+s+">"+a+"</object>",z[z.length]=e.id,n=m(e.id)}else{var u=g(P);u.setAttribute("type",E);for(var d in e)e[d]!=Object.prototype[d]&&("styleclass"==d.toLowerCase()?u.setAttribute("class",e[d]):"classid"!=d.toLowerCase()&&u.setAttribute(d,e[d]));for(var h in t)t[h]!=Object.prototype[h]&&"movie"!=h.toLowerCase()&&c(u,h,t[h]);o.parentNode.replaceChild(u,o),n=u}return n}function c(e,t,i){var n=g("param");n.setAttribute("name",t),n.setAttribute("value",i),e.appendChild(n)}function p(e){var t=m(e);t&&"OBJECT"==t.nodeName&&(H.ie&&H.win?(t.style.display="none",function(){4==t.readyState?f(e):setTimeout(arguments.callee,10)}()):t.parentNode.removeChild(t))}function f(e){var t=m(e);if(t){for(var i in t)"function"==typeof t[i]&&(t[i]=null);t.parentNode.removeChild(t)}}function m(e){var t=null;try{t=O.getElementById(e)}catch(i){}return t}function g(e){return O.createElement(e)}function v(e,t,i){e.attachEvent(t,i),V[V.length]=[e,t,i]}function b(e){var t=H.pv,i=e.split(".");return i[0]=parseInt(i[0],10),i[1]=parseInt(i[1],10)||0,i[2]=parseInt(i[2],10)||0,t[0]>i[0]||t[0]==i[0]&&t[1]>i[1]||t[0]==i[0]&&t[1]==i[1]&&t[2]>=i[2]?!0:!1}function w(e,t,i,n){if(!H.ie||!H.mac){var o=O.getElementsByTagName("head")[0];if(o){var s=i&&"string"==typeof i?i:"screen";if(n&&(T=null,I=null),!T||I!=s){var r=g("style");
r.setAttribute("type","text/css"),r.setAttribute("media",s),T=o.appendChild(r),H.ie&&H.win&&typeof O.styleSheets!=M&&O.styleSheets.length>0&&(T=O.styleSheets[O.styleSheets.length-1]),I=s}H.ie&&H.win?T&&typeof T.addRule==P&&T.addRule(e,t):T&&typeof O.createTextNode!=M&&T.appendChild(O.createTextNode(e+" {"+t+"}"))}}}function y(e,t){if(X){var i=t?"visible":"hidden";q&&m(e)?m(e).style.visibility=i:w("#"+e,"visibility:"+i)}}function _(e){var t=/[\\\"<>\.;]/,i=null!=t.exec(e);return i&&typeof encodeURIComponent!=M?encodeURIComponent(e):e}var x,S,k,C,T,I,M="undefined",P="object",$="Shockwave Flash",A="ShockwaveFlash.ShockwaveFlash",E="application/x-shockwave-flash",D="SWFObjectExprInst",R="onreadystatechange",L=window,O=document,j=navigator,F=!1,B=[n],N=[],z=[],V=[],q=!1,U=!1,X=!0,H=function(){var e=typeof O.getElementById!=M&&typeof O.getElementsByTagName!=M&&typeof O.createElement!=M,t=j.userAgent.toLowerCase(),i=j.platform.toLowerCase(),n=i?/win/.test(i):/win/.test(t),o=i?/mac/.test(i):/mac/.test(t),s=/webkit/.test(t)?parseFloat(t.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,r=!1,a=[0,0,0],l=null;if(typeof j.plugins!=M&&typeof j.plugins[$]==P)l=j.plugins[$].description,!l||typeof j.mimeTypes!=M&&j.mimeTypes[E]&&!j.mimeTypes[E].enabledPlugin||(F=!0,r=!1,l=l.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),a[0]=parseInt(l.replace(/^(.*)\..*$/,"$1"),10),a[1]=parseInt(l.replace(/^.*\.(.*)\s.*$/,"$1"),10),a[2]=/[a-zA-Z]/.test(l)?parseInt(l.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof L.ActiveXObject!=M)try{var u=new ActiveXObject(A);u&&(l=u.GetVariable("$version"),l&&(r=!0,l=l.split(" ")[1].split(","),a=[parseInt(l[0],10),parseInt(l[1],10),parseInt(l[2],10)]))}catch(d){}return{w3:e,pv:a,wk:s,ie:r,win:n,mac:o}}();return function(){H.w3&&((typeof O.readyState!=M&&"complete"==O.readyState||typeof O.readyState==M&&(O.getElementsByTagName("body")[0]||O.body))&&e(),q||(typeof O.addEventListener!=M&&O.addEventListener("DOMContentLoaded",e,!1),H.ie&&H.win&&(O.attachEvent(R,function(){"complete"==O.readyState&&(O.detachEvent(R,arguments.callee),e())}),L==top&&function(){if(!q){try{O.documentElement.doScroll("left")}catch(t){return setTimeout(arguments.callee,0),void 0}e()}}()),H.wk&&function(){return q?void 0:/loaded|complete/.test(O.readyState)?(e(),void 0):(setTimeout(arguments.callee,0),void 0)}(),i(e)))}(),function(){H.ie&&H.win&&window.attachEvent("onunload",function(){for(var e=V.length,t=0;e>t;t++)V[t][0].detachEvent(V[t][1],V[t][2]);for(var i=z.length,n=0;i>n;n++)p(z[n]);for(var o in H)H[o]=null;H=null;for(var s in swfobject)swfobject[s]=null;swfobject=null})}(),{registerObject:function(e,t,i,n){if(H.w3&&e&&t){var o={};o.id=e,o.swfVersion=t,o.expressInstall=i,o.callbackFn=n,N[N.length]=o,y(e,!1)}else n&&n({success:!1,id:e})},getObjectById:function(e){return H.w3?r(e):void 0},embedSWF:function(e,i,n,o,s,r,u,d,c,p){var f={success:!1,id:i};H.w3&&!(H.wk&&H.wk<312)&&e&&i&&n&&o&&s?(y(i,!1),t(function(){n+="",o+="";var t={};if(c&&typeof c===P)for(var m in c)t[m]=c[m];t.data=e,t.width=n,t.height=o;var g={};if(d&&typeof d===P)for(var v in d)g[v]=d[v];if(u&&typeof u===P)for(var w in u)typeof g.flashvars!=M?g.flashvars+="&"+w+"="+u[w]:g.flashvars=w+"="+u[w];if(b(s)){var _=h(t,g,i);t.id==i&&y(i,!0),f.success=!0,f.ref=_}else{if(r&&a())return t.data=r,l(t,g,i,p),void 0;y(i,!0)}p&&p(f)})):p&&p(f)},switchOffAutoHideShow:function(){X=!1},ua:H,getFlashPlayerVersion:function(){return{major:H.pv[0],minor:H.pv[1],release:H.pv[2]}},hasFlashPlayerVersion:b,createSWF:function(e,t,i){return H.w3?h(e,t,i):void 0},showExpressInstall:function(e,t,i,n){H.w3&&a()&&l(e,t,i,n)},removeSWF:function(e){H.w3&&p(e)},createCSS:function(e,t,i,n){H.w3&&w(e,t,i,n)},addDomLoadEvent:t,addLoadEvent:i,getQueryParamValue:function(e){var t=O.location.search||O.location.hash;if(t){if(/\?/.test(t)&&(t=t.split("?")[1]),null==e)return _(t);for(var i=t.split("&"),n=0;n<i.length;n++)if(i[n].substring(0,i[n].indexOf("="))==e)return _(i[n].substring(i[n].indexOf("=")+1))}return""},expressInstallCallback:function(){if(U){var e=m(D);e&&x&&(e.parentNode.replaceChild(x,e),S&&(y(S,!0),H.ie&&H.win&&(x.style.display="block")),k&&k(C)),U=!1}}}}();define("swfobject",function(e){return function(){var t;return t||e.swfobject}}(this)),define("player",[],function(){var e={initDeferred:$.Deferred(),volume:3,ephemeralCache:{},oLWsfDd:!1,init:function(){e.initDeferred.resolve()},zPSPGa:function(t){e.oLWsfDd=t,e.setVolume(e.volume)},setVolume:function(t){t!=e.volume&&(e.volume=t,e.previewSound&&t&&e.previewSound.setVolume(e.realVolume(t)));var i=e.realVolume(e.calculatedBarsVolume());httpStream.setVolume(i)},realVolume:function(e){return e>0?100*Math.pow(2,e-4):0},barsVolume:function(e){return e>0?Math.max(0,Math.log(e/100)/Math.LN2+4):0},calculatedBarsVolume:function(){return e.previewSound||e.oLWsfDd?0:e.volume},samplePlay:function(t,i){e.previewTimer&&(clearTimeout(e.previewTimer),clearInterval(e.previewProgressTimer),e.previewCallback("stop")),e.previewTimer=setTimeout(e.sampleStop,3e4),e.previewProgressTimer=setInterval(e.sampleUpdateProgress,100),e.initDeferred.done(function(){e.fade(httpStream,0),e.previewSound&&e.fade(e.previewSound,0).done(function(e){e.destruct()});var i=window.location.protocol+"//"+MEDIA_HOST+"/previewfile/?fileid="+t;e.previewSound=soundManager.createSound({id:"preview"+t,url:i}),e.previewSound.play();var n=e.realVolume(e.volume||3);e.previewSound.setVolume(n)}),e.previewCallback=i},sampleUpdateProgress:function(){try{var t=100*(Number(e.previewSound.position)/27e3)+"%";e.previewCallback("progress",t)}catch(i){}},sampleStop:function(){e.previewTimer&&(clearTimeout(e.previewTimer),clearInterval(e.previewProgressTimer),e.previewTimer=null,e.previewProgressTimer=null,e.previewSound&&(e.fade(e.previewSound,0).done(function(e){e.destruct()}),e.previewSound=null),e.fade(httpStream,e.calculatedBarsVolume())),e.previewCallback&&(e.previewCallback("stop"),e.previewCallback=null)},fade:function(t,i,n){var o=$.Deferred();n&&"number"==typeof n||(n=1.5);var s=e.barsVolume(t.volume),r=i-s,a=util.now(),l=setInterval(function(){var u=(util.now()-a)/(1e3*n);1>u?t.setVolume(e.realVolume(s+u*r)):(t.setVolume(e.realVolume(i)),clearInterval(l),o.resolve(t))},100);return o.promise()},playEphemeral:function(t,i){e.initDeferred.done(function(){e.loadEphemeralUrl(t,i)})},loadEphemeralUrl:function(t,i){var n=null;if(i&&(n=e.ephemeralCache[t]),n){if(n.playState)return n.setPosition(0),void 0}else{var o={id:"ephemeral"+util.now(),url:t};i||(o.onfinish=function(){this.destruct()}),n=soundManager.createSound(o),i&&(e.ephemeralCache[t]=n)}n.setVolume(e.realVolume(e.volume)),n.play()}};return e}),define("pmwindow",["require","tt-base","util","app","views/conversation-options-menu","views/conversation","rivets","player"],function(e){var t=e("tt-base"),i=e("util"),n=e("app"),o=e("views/conversation-options-menu"),s=e("views/conversation"),r=e("rivets");e("player");var a=t.Class.extend({buddyList:{},otherUser:{},otherUserId:!1,isClosed:!0,isMinimized:!1,isOverflow:!1,firstPM:!1,iAmUnavailable:!1,hasError:!1,isBlocked:!1,methodsToBind:["close","toggleMinimize","_onOptionsClick","_onContainerClick"],init:function(e,t){this.model=e;var n=e.user;this.buddyList=t,this.otherUser=n,this.otherUserId=n.id,this.nodes={};var o=n.get("status")||"available";this.pmWindow=$(i.buildTree(a.layouts.pmWindow.call(this,this.otherUser,o),this.nodes)),this.$optionsContainer=$(this.nodes.optionsContainer);var s=$(".pmContainer").last();s.length&&this.pmWindow.css({left:s.offset().left+s.outerWidth()+10+"px"}),$("#closedPMWindows").append(this.pmWindow),this.rivetsView=r.bind(this.pmWindow[0],{user:this.model.user,unread:this.model.unreadCount}),$(this.nodes.close).click(this.close),$(this.nodes.header).click(this.toggleMinimize),$(this.nodes.container).on("click",this._onContainerClick),this.nodes.conversationOptionsMenu.$el.on("click",this._onOptionsClick),this.listenTo(this.model,"change:unreadCount",this._onUnreadCountChange)},_onUnreadCountChange:function(e,t){t.get("count")&&this.isOverflow&&($("div#pmOverflowIcon").addClass("newMessage"),$(this.nodes.overflowListItem).addClass("newMessage"))},open:function(e){this.isClosed||this.isOverflow&&e?(this.isClosed=!1,this.isMinimized=!1,$(this.nodes.container).queue($.proxy(function(){this.unOverflow(!1),e?($(this.nodes.container).detach().prependTo("#pmWindows"),this.model.select()):$(this.nodes.container).detach().appendTo("#pmWindows"),$(this.nodes.container).css({marginBottom:-$(this.nodes.container).height()+"px"}),this.buddyList.repositionPMWindows(!1),this.isOverflow?this.buddyList.isVisible&&this.model.set("visible",!0):this.animateOpen(e),$(this.nodes.container).dequeue()},this)),"no-pm"!=this.otherUser.get("status")&&turntable.ZxcLsz({api:"presence.get",uid:this.otherUserId},$.proxy(function(e){e.success&&"presence"in e&&this.model.user.set("status",e.presence.status)},this))):this.isMinimized&&e&&this.toggleMinimize()},animateOpen:function(e){$(this.nodes.container).animate({marginBottom:"0px"},"fast",$.proxy(function(){this.buddyList.isVisible&&this.model.set("visible",!0),e&&$(this.nodes.pmInput).focus()},this))},close:function(e){this.isClosed||(this.isClosed=!0,$(this.nodes.container).animate({marginBottom:-$(this.nodes.container).height()+"px"},"fast"),$(this.nodes.container).queue($.proxy(function(){$(this.nodes.container).detach().appendTo("#closedPMWindows"),this.buddyList.repositionPMWindows(!0),$(this.nodes.container).dequeue()},this)),this.model.deselect(),this.buddyList.isVisible&&this.model.set("visible",!1),e&&e.stopPropagation())},redraw:function(){this.repositionMinimized()},toggleMinimize:function(){parseInt($(this.nodes.container).css("margin-bottom"))<0?(this.isMinimized=!1,$(this.nodes.container).animate({marginBottom:"0px"},"fast"),this.model.select(),this.buddyList.isVisible&&this.model.set("visible",!0)):(this.isMinimized=!0,this.repositionMinimized(!0),this.model.deselect(),this.buddyList.isVisible&&this.model.set("visible",!1))},repositionMinimized:function(e){this.isMinimized&&(e?$(this.nodes.container).animate({marginBottom:-$(this.nodes.container).height()+28+"px"},"fast"):$(this.nodes.container).css({marginBottom:-$(this.nodes.container).height()+28+"px"}))},overflow:function(){if(!this.isOverflow){this.isOverflow=!0,$(this.nodes.container).detach().appendTo("#overflowPMWindows");var e=this.buddyList.constructor.layouts.buddyListBuddy(this.otherUser,!0);$(this.buddyList.nodes.pmOverflowList).append(i.buildTree(e,this.nodes))}},unOverflow:function(e){this.isOverflow&&(this.isOverflow=!1,$(this.nodes.container).detach().appendTo("#pmWindows").css({marginBottom:-$(this.nodes.container).height()+"px"}),$(this.nodes.overflowListItem).remove(),$("#pmOverflowList li.newMessage").length||$("div#pmOverflowIcon").removeClass("newMessage"),e&&(this.animateOpen(!1),this.model.select(),this.buddyList.isVisible&&this.model.set("visible",!0)))},_onOptionsClick:function(e){this.isMinimized&&this.toggleMinimize(),this.$optionsContainer.is(":visible")?this.$optionsContainer.fadeOut("fast"):this.$optionsContainer.fadeIn("fast"),e&&e.stopPropagation()},_onContainerClick:function(e){0===$(e.target).closest(".pmHeader").length&&this.model.select()}},{_name:"PMWindow"});return a.layouts={pmWindow:function(e){return["div##container.pmContainer",{data:{userId:e.id}},["div##header.pmHeader.pmGreyTop",{"data-rv-class-new-message":"unread.count"},["span.username","{{ user.name }}"],["div.status",{"data-rv-add-class":"user.status"}],["div##close.pmWindowIcon.pmClose"],[o,{model:this.model}]],[s,{model:this.model,presence:n.presence}]]}},a}),define("fingerprint",["require","underscore","lib/jquery.sha1"],function(e){function t(){var e="";if(navigator.plugins){for(var t=new Array,i=0;i<navigator.plugins.length;i++){var n=navigator.plugins[i];t[i]=n.name+", "+n.description+", "+n.filename;for(var o=0;o<n.length;o++)t[i]+=" ("+n[o].description+", "+n[o].type+", "+n[o].suffixes+")"}t.sort(),e=t.join("")}return e}function i(){var e=new Date(2e3,1,1);return e.toLocaleString()+e.getTimezoneOffset()}function n(){var e=$.Deferred();window.fontList=function(t){1==$("#fprint > embed#fontshelper").length&&(window.fontList=null,e.resolve(t))},setTimeout(function(){"resolved"!==e.state()&&e.resolve("")},300);var t=$('<div id="fprint" style="position: absolute; right: -10;"><embed height="1" flashvars pluginspage="http://www.adobe.com/go/getflashplayer" src="/static/swf/fontdetect.swf" type="application/x-shockwave-flash" width="1" swliveconnect="true" id="fontshelper" name="fontshelper"></div>');return t.appendTo("body"),e.promise()}var o=e("underscore");return e("lib/jquery.sha1"),o.once(function(){var e=$.Deferred();return n().done(function(n){var o=navigator.userAgent+t()+i()+n;e.resolve($.sha1(o))}),e.promise()})}),function(){var e,t,i,n,o,s={}.hasOwnProperty,r=function(e,t){function i(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},a=this;for(this.Stripe=function(){function e(){}return e.version=2,e.endpoint="https://api.stripe.com/v1",e.setPublishableKey=function(t){e.key=t},e.complete=function(t){return function(i){var n;return"success"!==i?(n=Math.round((new Date).getTime()/1e3),(new Image).src="http://q.stripe.com?event=stripejs-error&type="+i+"&key="+e.key+"&timestamp="+n,"function"==typeof t?t(500,{error:{code:i,type:i,message:"An unexpected error has occurred with Stripe.js. This may\nbe due to network connectivity issues, so you should try\nagain (you won't be charged twice). If you're still having\nproblems, please let us know!"}}):void 0):void 0}},e}.call(this),e=this.Stripe,this.Stripe.token=function(){function t(){}return t.validate=function(e,t){if(!e)throw t+" required";if("object"!=typeof e)throw t+" invalid"},t.formatData=function(t,i){return e.utils.isElement(t)&&(t=e.utils.paramsFromForm(t,i)),e.utils.underscoreKeys(t),t},t.create=function(t,i){return t.key||(t.key=e.key||e.publishableKey),e.utils.validateKey(t.key),e.ajaxJSONP({url:""+e.endpoint+"/tokens",data:t,method:"POST",success:function(e,t){return"function"==typeof i?i(t,e):void 0},complete:e.complete(i),timeout:4e4})},t.get=function(t,i){if(!t)throw"token required";return e.utils.validateKey(e.key),e.ajaxJSONP({url:""+e.endpoint+"/tokens/"+t,data:{key:e.key},success:function(e,t){return"function"==typeof i?i(t,e):void 0},complete:e.complete(i),timeout:4e4})},t}.call(this),this.Stripe.card=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return r(i,t),i.tokenName="card",i.whitelistedAttrs=["number","cvc","exp_month","exp_year","name","address_line1","address_line2","address_city","address_state","address_zip","address_country"],i.createToken=function(t,n,o){var s;return null==n&&(n={}),e.token.validate(t,"card"),"function"==typeof n?(o=n,n={}):"object"!=typeof n&&(s=parseInt(n,10),n={},s>0&&(n.amount=s)),n[i.tokenName]=e.token.formatData(t,i.whitelistedAttrs),e.token.create(n,o)},i.getToken=function(t,i){return e.token.get(t,i)},i.validateCardNumber=function(e){return e=(e+"").replace(/\s+|-/g,""),e.length>=10&&e.length<=16&&i.luhnCheck(e)},i.validateCVC=function(t){return t=e.utils.trim(t),/^\d+$/.test(t)&&t.length>=3&&t.length<=4},i.validateExpiry=function(t,i){var n,o;return t=e.utils.trim(t),i=e.utils.trim(i),/^\d+$/.test(t)?/^\d+$/.test(i)?parseInt(t,10)<=12?(o=new Date(i,t),n=new Date,o.setMonth(o.getMonth()-1),o.setMonth(o.getMonth()+1,1),o>n):!1:!1:!1},i.luhnCheck=function(e){var t,i,n,o,s,r;for(n=!0,o=0,i=(e+"").split("").reverse(),s=0,r=i.length;r>s;s++)t=i[s],t=parseInt(t,10),(n=!n)&&(t*=2),t>9&&(t-=9),o+=t;return 0===o%10},i.cardType=function(e){return i.cardTypes[e.slice(0,2)]||"Unknown"},i.cardTypes=function(){var e,t,i,n;for(t={},e=i=40;49>=i;e=++i)t[e]="Visa";for(e=n=50;59>=n;e=++n)t[e]="MasterCard";return t[34]=t[37]="American Express",t[60]=t[62]=t[64]=t[65]="Discover",t[35]="JCB",t[30]=t[36]=t[38]=t[39]="Diners Club",t}(),i}.call(this,this.Stripe.token),this.Stripe.bankAccount=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return r(i,t),i.tokenName="bank_account",i.whitelistedAttrs=["country","routing_number","account_number"],i.createToken=function(t,n,o){return null==n&&(n={}),e.token.validate(t,"bank account"),"function"==typeof n&&(o=n,n={}),n[i.tokenName]=e.token.formatData(t,i.whitelistedAttrs),e.token.create(n,o)},i.getToken=function(t,i){return e.token.get(t,i)},i.validateRoutingNumber=function(t,n){switch(t=e.utils.trim(t),n){case"US":return/^\d+$/.test(t)&&9===t.length&&i.routingChecksum(t);case"CA":return/\d{5}\-\d{3}/.test(t)&&9===t.length;default:return!0}},i.validateAccountNumber=function(t,i){switch(t=e.utils.trim(t),i){case"US":return/^\d+$/.test(t)&&t.length>=1&&t.length<=17;default:return!0}},i.routingChecksum=function(e){var t,i,n,o,s,r;for(n=0,t=(e+"").split(""),r=[0,3,6],o=0,s=r.length;s>o;o++)i=r[o],n+=3*parseInt(t[i]),n+=7*parseInt(t[i+1]),n+=parseInt(t[i+2]);return 0!==n&&0===n%10},i}.call(this,this.Stripe.token),t=["createToken","getToken","cardType","validateExpiry","validateCVC","validateCardNumber"],n=0,o=t.length;o>n;n++)i=t[n],this.Stripe[i]=this.Stripe.card[i];"undefined"!=typeof module&&null!==module&&(module.exports=this.Stripe),"function"==typeof define&&define("stripe",[],function(){return a.Stripe})}.call(this),function(){var e,t,i,n=[].slice;e=encodeURIComponent,t=(new Date).getTime(),i=function(t,n,o){var s,r;null==n&&(n=[]);for(s in t)r=t[s],o&&(s=""+o+"["+s+"]"),"object"==typeof r?i(r,n,s):n.push(""+s+"="+e(r));return n.join("&").replace(/%20/g,"+")},this.Stripe.ajaxJSONP=function(e){var o,s,r,a,l,u;return null==e&&(e={}),r="sjsonp"+ ++t,l=document.createElement("script"),s=null,o=function(t){var i;return null==t&&(t="abort"),clearTimeout(s),null!=(i=l.parentNode)&&i.removeChild(l),r in window&&(window[r]=function(){}),"function"==typeof e.complete?e.complete(t,u,e):void 0},u={abort:o},l.onerror=function(){return u.abort(),"function"==typeof e.error?e.error(u,e):void 0},window[r]=function(){var t;t=1<=arguments.length?n.call(arguments,0):[],clearTimeout(s),l.parentNode.removeChild(l);try{delete window[r]}catch(i){window[r]=void 0}return"function"==typeof e.success&&e.success.apply(e,t),"function"==typeof e.complete?e.complete("success",u,e):void 0},e.data||(e.data={}),e.data.callback=r,e.method&&(e.data._method=e.method),l.src=e.url+"?"+i(e.data),a=document.getElementsByTagName("head")[0],a.appendChild(l),e.timeout>0&&(s=setTimeout(function(){return u.abort("timeout")},e.timeout)),u}}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};this.Stripe.utils=function(){function t(){}return t.trim=function(e){return(e+"").replace(/^\s+|\s+$/g,"")},t.underscore=function(e){return(e+"").replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()}).replace(/-/g,"_")},t.underscoreKeys=function(e){var t,i,n;n=[];for(t in e)i=e[t],delete e[t],n.push(e[this.underscore(t)]=i);return n},t.isElement=function(e){return"object"!=typeof e?!1:"undefined"!=typeof jQuery&&null!==jQuery&&e instanceof jQuery?!0:1===e.nodeType},t.paramsFromForm=function(t,i){var n,o,s,r,a,l,u,d,h,c;for(null==i&&(i=[]),"undefined"!=typeof jQuery&&null!==jQuery&&t instanceof jQuery&&(t=t[0]),s=t.getElementsByTagName("input"),a=t.getElementsByTagName("select"),l={},u=0,h=s.length;h>u;u++)o=s[u],n=this.underscore(o.getAttribute("data-stripe")),e.call(i,n)<0||(l[n]=o.value);for(d=0,c=a.length;c>d;d++)r=a[d],n=this.underscore(r.getAttribute("data-stripe")),e.call(i,n)<0||null!=r.selectedIndex&&(l[n]=r.options[r.selectedIndex].value);return l},t.validateKey=function(e){if(!e||"string"!=typeof e)throw new Error("You did not set a valid publishable key. Call Stripe.setPublishableKey() with your publishable key. For more info, see https://stripe.com/docs/stripe.js");if(/\s/g.test(e))throw new Error("Your key is invalid, as it contains whitespace. For more info, see https://stripe.com/docs/stripe.js");if(/^sk_/.test(e))throw new Error("You are using a secret key with Stripe.js, instead of the publishable one. For more info, see https://stripe.com/docs/stripe.js")},t}()}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};this.Stripe.validator={"boolean":function(e,t){return"true"!==t&&"false"!==t?"Enter a boolean string (true or false)":void 0},integer:function(e,t){return/^\d+$/.test(t)?void 0:"Enter an integer"},positive:function(e,t){return!this.integer(e,t)&&parseInt(t,10)>0?void 0:"Enter a positive value"},range:function(t,i){var n;return n=parseInt(i,10),e.call(t,n)<0?"Needs to be between "+t[0]+" and "+t[t.length-1]:void 0},required:function(e,t){return!e||null!=t&&""!==t?void 0:"Required"},year:function(e,t){return/^\d{4}$/.test(t)?void 0:"Enter a 4-digit year"},birthYear:function(e,t){var i;return i=this.year(e,t),i?i:parseInt(t,10)>2e3?"You must be over 18":parseInt(t,10)<1900?"Enter your birth year":void 0},month:function(e,t){return this.integer(e,t)?"Please enter a month":this.range([1,2,3,4,5,6,7,8,9,10,11,12],t)?"Needs to be between 1 and 12":void 0},choices:function(t,i){return e.call(t,i)<0?"Not an acceptable value for this field":void 0},email:function(e,t){return/^[^@<\s>]+@[^@<\s>]+$/.test(t)?void 0:"That doesn't look like an email address"},url:function(e,t){return/^https?:\/\/.+\..+/.test(t)?void 0:"Not a valid url"},usTaxID:function(e,t){return/^\d{2}-?\d{1}-?\d{2}-?\d{4}$/.test(t)?void 0:"Not a valid tax ID"},ein:function(e,t){return/^\d{2}-?\d{7}$/.test(t)?void 0:"Not a valid EIN"},ssnLast4:function(e,t){return/^\d{4}$/.test(t)?void 0:"Not a valid last 4 digits for an SSN"},ownerPersonalID:function(e,t){var i;return i=function(){switch(e){case"CA":return/^\d{3}-?\d{3}-?\d{3}$/.test(t);case"US":return!0}}(),i?void 0:"Not a valid ID"},bizTaxID:function(e,t){var i,n,o,s,r,a,l,u;if(a={CA:["Tax ID",[/^\d{9}$/]],US:["EIN",[/^\d{2}-?\d{7}$/]]},r=a[e],null!=r){for(i=r[0],s=r[1],n=!1,l=0,u=s.length;u>l;l++)if(o=s[l],o.test(t)){n=!0;break}if(!n)return"Not a valid "+i}},zip:function(e,t){var i;return i=function(){switch(e.toUpperCase()){case"CA":return/^[\d\w]{6}$/.test(null!=t?t.replace(/\s+/g,""):void 0);case"US":return/^\d{5}$/.test(t)||/^\d{9}$/.test(t)}}(),i?void 0:"Not a valid zip"},bankAccountNumber:function(e,t){return/^\d{1,17}$/.test(t)?void 0:"Invalid bank account number"},usRoutingNumber:function(e){var t,i,n,o,s,r,a;if(!/^\d{9}$/.test(e))return"Routing number must have 9 digits";for(s=0,t=r=0,a=e.length-1;a>=r;t=r+=3)i=3*parseInt(e.charAt(t),10),n=7*parseInt(e.charAt(t+1),10),o=parseInt(e.charAt(t+2),10),s+=i+n+o;return 0===s||0!==s%10?"Invalid routing number":void 0},caRoutingNumber:function(e){return/^\d{5}\-\d{3}$/.test(e)?void 0:"Invalid transit number"},routingNumber:function(e,t){switch(e.toUpperCase()){case"CA":return this.caRoutingNumber(t);case"US":return this.usRoutingNumber(t)}},phoneNumber:function(e,t){var i;return i=t.replace(/[^0-9]/g,""),10!==i.length?"Invalid phone number":void 0},bizDBA:function(e,t){return/^.{1,23}$/.test(t)?void 0:"Statement descriptors can only have up to 23 characters"},nameLength:function(e,t){return 1===t.length?"Names need to be longer than one character":void 0}}}.call(this),define("facebook",[],function(){Date.prototype.addMonths=function(e){return this.setMonth(this.getMonth()+e),this};var e=$.Deferred(),t=function(e){window.location.href="/facebook_login?fbtoken="+e.authResponse.accessToken},i=function(){window.location.replace("/")},n={scope:"publish_actions,offline_access,email,user_about_me,user_birthday"},o={FB:null,USER_FBTOKEN:null,authenticating:e.promise(),login:function(e,i){this.FB.login(e||t,i||n)},logout:function(e){this.FB.logout(e||i)}};window.fbAsyncInit=function(){var t=o.FB=window.FB;t._https="https:"==window.location.protocol,t&&(t.init({appId:"127146244018710",cookie:!0,status:!0,xfbml:!0}),t.getLoginStatus(function(t){t&&"connected"==t.status?(o.USER_FBTOKEN=t.authResponse.accessToken,e.resolve(),window.USER_FBTOKEN=null):e.reject()})),window.FB=null};var s=document.createElement("div");s.id="fb-root",$(function(){$("#maindiv").append(s)});var r=document.createElement("script");return r.src=document.location.protocol+"//connect.facebook.net/en_US/all.js",r.async=!0,$(s).ready(function(){s.appendChild(r)}),o}),define("models/user",["require","tt-base","fingerprint","stripe","store","tt-common","mixins","lib/jquery.cookie","facebook"],function(e){var t=e("tt-base"),i=e("fingerprint"),n=e("stripe"),o=e("store"),s=e("tt-common");e("mixins"),e("lib/jquery.cookie");var r=["auth","registered"],a=t.Model.extend({methodsToBind:["_onStatusFetch"],init:function(e,t){if(_.bindAll(this),e=e||{},this.id&&this.id!==this.getUser().id||this.initUser(),_.extend(this,_.pick(this.attributes,r)),this.on("change:registered",function(e,t){e.registered=t}),this.isSelf){var i,n=this.loading=$.Deferred();if(this.get("name"))n.resolve(),i=$.Deferred().resolve();else{i=this.authenticating=this.id&&this.auth?this.fetch({api:"user.authenticate"}):this.registerGuest();var o=this.fetchInfo;i.done(function(){o(t).done(n.resolve).fail(n.reject)})}}else this.get("name")?(this.loading=$.Deferred(),this.loading.resolve()):this.loading=this.fetchInfo()},parse:function(e){if(e=_.clone(e),_.has(e,"avatarid")&&(e.avatarId=e.avatarid,delete e.avatarid),_.has(e,"subscription_level")&&(e.subscriptionLevel=e.subscription_level,delete e.subscription_level),_.has(e,"blocks")){var t={};_(e.blocks).each(function(e){t[e.block.blockedid]=!0}),e=_.omit(e,"blocks"),e.blocked=t}return _.has(e,"presence")&&(e.status=e.presence,delete e.presence),e},sync:function(e,t,i){return("create"===e||"update"===e||"patch"===e)&&(i=_.extend({api:"user.modify"},i)),i.attrs=_.extend({userid:this.id,userauth:this.auth},i.attrs),this._super(e,t,i)},fetchInfo:function(e){if(e&&e.shouldFetchInfo===!1)return $.Deferred().resolve();var t=this.fetch({api:"user.info"});return e&&e.fullInfo===!0&&t.done(this.fetchFans,this.fetchBuddies,this.setLaptopType,this.fetchBlockedUsers),t},fetchFans:function(){return this.fetch({api:"user.get_fan_of"})},fetchBuddies:function(){return this.fetch({api:"user.get_buddies"})},fetchBlockedUsers:function(){return this.fetch({api:"block.list_all"})},fetchStatus:function(){return s.apiGet({api:"presence.get",uid:this.id}).done(this._onStatusFetch)},_onStatusFetch:function(e){this.set("status",e.presence.status)},getSubscription:function(){return this.has("subscription")?this.pick("subscription"):this.fetchSubscription()},fetchSubscription:function(){var e=this;return s.apiGet({api:"order.subscription_info"},!0).done(function(t){e.set("subscription",t)})},getCard:function(){return this.has("card")?this.pick("card"):this.fetchCard()},fetchCard:function(){var e=this;return s.apiGet({api:"order.get_payment_info"}).done(function(t){e.set(_.pick(t,"card"))})},getCardNumber:function(){if(!this.has("card"))return"";var e="";return _.times(3,function(){e+="\u2022\u2022\u2022\u2022 "}),e+this.get("card").last_four},getExpirationDate:function(){if(!this.has("card"))return"";var e=this.get("card");return e.exp_month+"/"+e.exp_year},createCCToken:function(e){var t=$.Deferred(),i=this;return e=_.pick(e,"number","exp_year","exp_month","cvc","address_zip"),n.createToken(e,function(e,n){n.error?t.reject(n):s.apiPost({api:"order.set_payment_info",token:n.id}).done(function(e){i.set(_.pick(e,"card")),t.resolve(e)}).fail(function(e){t.reject(e)})}),t.promise()},cancelSubscription:function(){var e=this,t=$.Deferred();return $.when(this.getSubscription()).done(function(){s.apiPost({api:"order.cancel_subscription",subid:e.get("subscription").id}).done(function(e){t.resolve(e)}).fail(function(e){t.reject(e)})}),t.promise()},reactivateSubscription:function(){var e=this,t=$.Deferred();return $.when(this.getSubscription()).done(function(){s.apiPost({api:"order.reactivate_subscription",subid:e.get("subscription").id}).done(function(e){t.resolve(e)}).fail(function(e){t.reject(e)})}),t.promise()},order:function(e,t){var i=$.Deferred();if(!_.isString(e))return i.reject("Whoops. Looks like we missed some important info. Try restarting again!"),i.promise();var n={api:t.findSubscription()?"order.subscribe":"order.buy",password:e,order:t.pluck("id")},o=this;return s.apiPost(n,!0).done(function(e){var n;n=t.findSubscription()?{api:"order.subscription_state",subid:e.subid}:{api:"order.state",orderid:e.orderid},o.pollOrderState(n).done(function(e){t.findSubscription()&&o.set("subscriptionLevel",e.level),i.resolve(e)}).fail(function(e){i.reject(e)})}),i.promise()},pollOrderState:function(e){var t=$.Deferred(),i=!1,n=function(){s.apiGet(e).done(function(e){"succeeded"===e.state||"active"===e.state?t.resolve(e):"failed"===e.state?t.reject(e):i?t.reject(e):window.setTimeout(n,2e3)})};return n(),window.setTimeout(function(){i=!0},3e4),t.promise()},getUser:function(){var e={};return e.id=util.getUrlParam("ui"),e.auth=util.getUrlParam("ua"),e.registered="true"==$.cookie("turntableUserNamed"),e.id&&e.auth||(e.id=$.cookie("turntableUserId"),e.auth=$.cookie("turntableUserAuth")),e.id&&e.auth?e:null},initUser:function(){var e=this.getUser();e&&(e._id=e.id,delete e.id,this.set(e)),this.isSelf=!0,_.extend(this,_.pick(this.attributes,r))},setEmail:function(e){this.set({has_tt_password:!0,email:e}),this.unset("unverified_email")},setUnverifiedEmail:function(e){this.set("unverified_email",e)},verifyEmail:function(){this.setEmail(this.get("unverified_email"))},passwordChanged:function(){this.set("has_tt_password",!0),this.unset("unverified_email")},registerGuest:function(){var e=$.Deferred(),t=this;return i().done(function(i){s.apiPost({api:"user.guest_create",usertoken:window.TURNTABLE_TOKEN,fingerprint:i}).done(function(i){var n=s.prepApiData(i),o="https://"+window.location.host+"/guest_login/";s.crossDomainAjaxRequest({url:o,type:"POST",data:n,success:function(){t.initUser(),e.resolve()},error:function(){e.reject()}})}).fail(function(){e.reject()})}),e.promise()},isSuperuser:function(){return this.get("acl")>0},isGatekeeper:function(){return this.get("acl")>1},isFanof:function(e){return-1!==(this.get("fanof")||[]).indexOf(e)},addFan:function(e){return s.apiGet({api:"user.become_fan",djid:e}).done(_.bind(function(){var t=this.get("fanof");t.push(e),this._manualTrigger("fanof",t)},this))},removeFan:function(e){return s.apiGet({api:"user.remove_fan",djid:e}).done(_.bind(function(){var t=this.get("fanof"),i=t.indexOf(e);t.splice(i,1),this._manualTrigger("fanof",t)},this))},isBuddy:function(e){return-1!==(this.get("buddies")||[]).indexOf(e)},isBlocked:function(e){return(this.get("blocked")||{})[e]===!0},addBlocked:function(e){return s.apiGet({api:"block.add",blockedid:e}).done(_.bind(function(){var t=this.get("blocked");t[e]=!0,this._manualTrigger("blocked",t)},this))},removeBlocked:function(e){return s.apiGet({api:"block.remove",blockedid:e}).done(_.bind(function(){var t=this.get("blocked");t[e]=!1,this._manualTrigger("blocked",t)},this))},getAvatarUrl:function(e,t){return!t&&this.get("custom_avatar")?this.get("images")[e]:this._getAvatarUrl(e,t||this.get("avatarId"))},_getAvatarUrl:function(e,t){return"/roommanager_assets/avatars/"+t+"/"+e+".png"},setLaptopType:function(){var e="linux";-1!=navigator.userAgent.indexOf("Macintosh")||-1!=navigator.userAgent.indexOf("iPhone")||-1!=navigator.userAgent.indexOf("iPad")?e="mac":-1!=navigator.userAgent.indexOf("Windows")?e="pc":-1!=navigator.userAgent.indexOf("CrOS")&&(e="chrome"),this.save("laptop",e,{websocket:!0,patch:!0})},isPro:function(){return this.get("subscriptionLevel")>0},logout:function(){$.cookie("turntableUserId",null,{path:"/",expires:0}),$.cookie("turntableUserAuth",null,{path:"/",expires:0}),$.cookie("turntableUserNamed",null,{path:"/",expires:0});var t=e("facebook"),i=function(){window.location.replace("/")};t.authenticating.done(function(){t.logout(i)}).fail(function(){i()})}},{_name:"User"});
return o.stores.get([{name:"users",ctor:a}]),a}),define("buddylistpm",["require","tt-base","util","app","views/conversations-list","views/pm-options-menu","views/pm-unavailable-warning","pmwindow","models/user"],function(e){var t=e("tt-base"),i=e("util"),n=e("app"),o=e("views/conversations-list"),s=e("views/pm-options-menu"),r=e("views/pm-unavailable-warning"),a=e("pmwindow");e("models/user");var l=function(){$(this).addClass("hover")},u=function(){$(this).removeClass("hover")},d=t.Class.extend({methodsToBind:["_onOptionsClick","toggle"],room:{},knownUsers:{},onlineBuddies:{},nodes:{},pmWindows:{},status:"available",$pmTab:null,init:function(e){this.room=e,this.listenTo(n.presence,"change:unavailable change:idle",this.onChangeAvailability),$("body").append(i.buildTree(["div#pmWindows"])),$("body").append($(i.buildTree(["div#closedPMWindows"])).hide()),$("body").append($(i.buildTree(["div#overflowPMWindows"])).hide()),this.$pmTab=$("#pmWindows");var t=$(i.buildTree(d.layouts.privateChatIcon(turntable.isIdle),this.nodes));t.click(this.toggle),this.$pmTab.append(t);var o=d.layouts.buddyList.call(this),s=this.$buddyListContainer=$(i.buildTree(o,this.nodes)).hide();$("#maindiv").append(s),$(this.nodes.optionsContainer).hide(),$(this.nodes.buddyListHeader).click(this.toggle);var r=$(i.buildTree(d.layouts.pmOverflowIcon(),this.nodes)).hide();this.$pmTab.append(r);var a=$(i.buildTree(d.layouts.pmOverflow(),this.nodes)).hide();$("#maindiv").append(a),$(window).resize($.proxy(this.repositionPMWindows,this)),this.repositionPMWindows(),this.nodes.pmOptionsMenu.$el.on("click",this._onOptionsClick),this.listenTo(n.pms,{"change:selected":this._onConversationSelectedChange,newMessage:this._onNewMessage}),this.hidePMWindows(),this._onMiniplayerChange(),this.listenTo(n.user,"change:registered",this._onUserRegister),this.listenTo(n,{"change:miniplayer":this._onMiniplayerChange,popOut:this._onMiniplayerOn})},hidePMWindows:function(){this.$pmTab.hide()},showPMWindows:function(){this.$pmTab.show()},updateMyStatus:function(e){e!=this.status&&(this.status=e,$(this.nodes.status).removeClass("available away offline unavailable").addClass(e))},updateBuddyStatus:function(e){"status"in e&&("offline"==e.get("status")&&e.id in this.onlineBuddies?this.removeBuddy(e.id):"offline"!=e.get("status")&&(e.id in this.onlineBuddies?e.id in this.onlineBuddies&&"status"+e.id in this.nodes&&$(this.nodes["status"+e.id]).removeClass("available away offline unavailable no-pm").addClass(e.get("status")):this.addBuddy(e,!0)))},toggle:function(){var e=$("div#privateChatIcon");if(e.hasClass("open"))e.removeClass("open"),this.nodes.pmOptionsMenu.isShown&&this.nodes.pmOptionsMenu.toggle(),$("div#buddyListContainer").fadeOut(200),$(document).unbind("click",turntable.buddyList.bodyClickHandler);else{e.addClass("open");var t=turntable.isUnavailable?63:0;$("ul#buddyList").css({maxHeight:$(window).height()-(80+t)+"px"}),$("div#buddyListContainer").fadeIn(200),$(document).click(turntable.buddyList.bodyClickHandler),_gaq.push(["_trackEvent","tab select","pm","full"])}},isClosed:function(){var e=$("div#privateChatIcon");return e.hasClass("open")?!1:!0},bodyClickHandler:function(e){-1==$(e.target).parents().index($("#buddyListContainer"))&&-1==$(e.target).parents().index($("#privateChatIcon"))&&!$(e.target).is("#privateChatIcon")&&$("div#privateChatIcon").hasClass("open")&&turntable.buddyList.toggle()},addPMWindow:function(e,t,i){var o=e.user,s=n.user.isBlocked(o.id);this.pmWindows[o.id]=new a(e,this,s),this.pmWindows[o.id].open(t),i&&i()},repositionPMWindows:function(e){for(var t=!1,i=$("#pmWindows .pmContainer"),n=0;n<i.length;n++){var o=i.eq(n);t=this.positionPMWindow(o,n,e)}if(!t)for(var s=$("#overflowPMWindows .pmContainer"),n=s.length-1;n>=0;n--){var o=s.eq(n),r=i.length+(s.length-(n+1));if(t=this.positionPMWindow(o,r,e))break}s=$("#overflowPMWindows .pmContainer"),s.length?($(this.nodes.pmOverflowIcon).show(),$(this.nodes.pmOverflowCount).text(s.length)):($(this.nodes.pmOverflowIcon).hide(),$(this.nodes.pmOverflowContainer).hide()),this.nodes.conversationsList.$el.css("max-height",window.innerHeight-100)},positionPMWindow:function(e,t,i){var n=e.data("userId");if(n in this.pmWindows){var o=this.pmWindows[n],s=52+t*(e.width()+5);if(s+e.width()>$(window).width()-50)return o.overflow(),!0;o.unOverflow(!0);var r=parseInt(e.css("left"));if(r==s)return;return i?e.animate({left:s+"px"},"fast"):e.css({left:s+"px"}),!1}},allPMWindowsClosed:function(){for(var e in this.pmWindows)if(!this.pmWindows[e].isClosed)return!1;return!0},toggleDing:function(){i.setSetting("pmding","false"==i.getSetting("pmding")?"true":"false"),this.refreshOptions()},_onOptionsClick:function(e){e&&e.stopPropagation()},onChangeAvailability:function(e){e.get("unavailable")?this.updateMyStatus("unavailable"):e.get("idle")?this.updateMyStatus("away"):this.updateMyStatus("available")},_onMiniplayerChange:function(){n.get("miniplayer")?this._onMiniplayerOn():this._onMiniplayerOff()},_onMiniplayerOn:function(){this.$pmTab.hide(),this.$buddyListContainer.is(":visible")&&this.toggle(),this.isVisible=!1,_.each(this.pmWindows,function(e){e.model.set("visible",!1)})},_onMiniplayerOff:function(){n.user.get("registered")&&(this.$pmTab.show(),this.isVisible=!0,_.each(this.pmWindows,function(e){e.isMinimized||e.isClosed||e.isOverflow||e.model.set("visible",!0)}))},_onUserRegister:function(){n.get("miniplayer")?this._onMiniplayerOn():this._onMiniplayerOff()},_onNewMessage:function(e){if(this.isVisible){var t=e.user,i=t.id,o=this.pmWindows[i],s=!n.pms.selectedConversation&&!$("#chat-input").is(":focus");o?o.isClosed&&o.open(s):turntable.buddyList.addPMWindow(e,s)}},_onConversationSelectedChange:function(e,t){if(this.isVisible&&t){var i=e.user,n=i.id;_.has(this.pmWindows,n)?this.pmWindows[n].open(!0):turntable.buddyList.addPMWindow(e,!0)}},onConversationClick:function(e){e.model.select(),this.toggle()}});return d.layouts={privateChatIcon:function(e){var t=e?".away":"";return["div#privateChatIcon.pmGreyTop",{event:{mouseover:l,mouseout:u}},["div##status.status"+t],["div.chatIcon"]]},buddyList:function(){return["div#buddyListContainer",{},["div#buddyListMain",{},["div#buddyListHeader##buddyListHeader",{},["div#buddyListTitle",{},"Private chat"],[s,{presence:n.presence,volume:n.volume}]],[r,{presence:n.presence}],[o,{collection:n.pms,itemDelegate:this}],["ul#buddyList##buddyList",{}]],["div#buddyListNipple"]]},pmOverflowIcon:function(){return["div#pmOverflowIcon##pmOverflowIcon.pmGreyTop",{event:{click:function(){$("div#pmOverflowContainer").fadeToggle("fast")},mouseover:l,mouseout:u}},["span#pmOverflowCount##pmOverflowCount",{},"0"],["div#pmOverflowArrow"]]},pmOverflow:function(){return["div#pmOverflowContainer##pmOverflowContainer",{},["ul#pmOverflowList##pmOverflowList",{}],["div#pmOverflowNipple"]]},buddyListBuddy:function(e,t){var i,n="roomName"in e&&!t?["div.room",{},e.get("roomName")]:"",o=function(){turntable.sOxwLW.handlePM({senderid:e.id},!0),t?$("div#pmOverflowContainer").fadeOut("fast"):turntable.buddyList.toggle()},s=t?"overflowListItem":"buddy"+e.id;return i="fbid"in e?"https://graph.facebook.com/"+e.get("fbid")+"/picture":"twitter_profile_image"in e?e.get("twitter_profile_image"):e.get("images").headfront,["li##"+s+".buddy",{event:{click:o,mouseover:l,mouseout:u}},["div.avatar",{style:{"background-image":"url("+i+")"}}],["div.user",{},["div.name",{},e.get("name")],n],["div##status"+e.id+".status."+e.get("status")]]}},d}),define("views/chatsticker-picker",["require","tt-base"],function(e){var t=e("tt-base"),i=["wink","smh","sad","laughing","happy"],n=["thumbsup","thumbsdown","rock","peace"],o=["poop","heart","glowstick"],s=i.concat(n).concat(o),r=/\$([\w\-]+)\$/;return t.View.extend({el:function(){var e=_.reduce(s,function(e,t,i){i%3||e.push(["div.sticker-row"]);var n=Math.floor(i/3);return e[n+1].push(["div.container",["div.chatsticker.chatstickers-"+t,{data:{sticker:t}}]]),e},["div.sticker-content"]);return["div#chatsticker-picker.floating-menu",e]},events:{mouseenter:"onMouseenter",mouseleave:"onMouseleave","click .container":"onStickerClick"},init:function(){this.$el.hide().appendTo("body")},toggle:function(){this.$el.toggle()},open:function(){this.$el.show()},close:function(){this.$el.hide()},onMouseenter:function(){this.clearCloseTimer()},onMouseleave:function(){this.setCloseTimer()},clearCloseTimer:function(){window.clearTimeout(this.closeTimeout)},setCloseTimer:function(){this.closeTimeout=window.setTimeout(_.bind(this.close,this),500)},onStickerClick:function(e){var t=this.options.delegate;if(t&&t.onStickerClick){var i=$(e.currentTarget).find(".chatsticker").data("sticker");t.onStickerClick(i),this.close()}}},{_name:"Chatsticker",stickers:s,stickerPattern:r,throttleText:function(e){var t=e.match(this.stickerPattern);return t?"$"+t[1]+"$":e},showChatstickers:function(e,t,i){var n=t.isPro(),o=e.match(this.stickerPattern);if(n&&o&&-1!==_.indexOf(s,o[1])){var r=o[1];return util.buildTree(["div.chatsticker.chatstickers-animated-"+r,i?{style:i}:null])}return e}})}),define("models/counter",["require","tt-base"],function(e){var t=e("tt-base");return t.Model.extend({init:function(e,t){t&&t.max&&(this.max=t.max),this.reset(),this._super.apply(this,arguments)},inc:function(){this.set("count",this.get("count")+1)},set:function(e,t,i){var n;"object"==typeof e?(n=e,i=t):(n={})[e]=t,this.max&&_.has(n,"count")&&n.count>this.max&&(n.count=this.max),this._super(n,i)},reset:function(){this.set("count",0)}},{_name:"Counter"})}),define("crowd-control",["require","underscore","backbone","tt-base"],function(e){"use strict";var t=e("underscore"),i=(e("backbone"),e("tt-base")),n=700,o=100,s=5,r=function(e,t){var i=e.indexOf(t);return-1!==i?(e.splice(i,1),t):!1},a=function(e,t,i){i=i||Math;var n=e.length;if(n>0){var o=Math.floor(i.random()*n),s=e[o];return t&&e.splice(o,1),s}},l=[{range:[1,8],probability:20},{range:34,probability:20},{range:[9,17],probability:10},{range:[18,19],probability:6},{range:121,probability:6},{range:[20,22],probability:5,tall:!0},{range:23,probability:5,tall:!0},{range:[36,37],probability:4},{range:[27,33],probability:3},{range:[218,221],probability:2},{range:[222,230],probability:2}],u=t.filter(l,function(e){return!e.tall}),d=function(e){for(var t=[],i=0,n=e.length;n>i;i++){var o=e[i],s=o.range,r=o.probability;if("number"===$.type(s)){for(var a=0;r>a;a++)t.push(s);t.push(s)}else if("array"===$.type(s))for(var l=s[0];l<=s[1];l++)for(var a=0;r>a;a++)t.push(l)}return t},h=d(l),c=d(u),p=function(e){return a(h,!1,e)},f=function(e){return a(c,!1,e)},m=function(e){e=e*Math.PI/2;for(var t,i,n=.001,o=1,s=0,r=1;r>n;)i=(o+s)/2,t=Math.asin(i)+i*Math.sqrt(1-i*i),t>e?o=i:s=i,r=Math.abs(t-e);return i},g={zOffset:70,radiusMultiplier:1e3/Math.sqrt(200),xMultiplier:.7,zMultiplier:1.2,radius:function(e){return this.radiusMultiplier*Math.sqrt(e)}},v=i.Class.extend({init:function(e,i){this.room=e,this.isSection=i,this.roomEntropy=turntable.seedPRNG&&turntable.serverNow?turntable.seedPRNG(this.room.roomId+Math.round(turntable.serverNow()/21600)):Math,this.capacity=e.roomData.metadata.max_size,this.changeCount=0,this.audienceMemberMap={},this.audienceMemberIds=[],this.crowdExists=!1,this.crowdMemberMap={},this.crowdMembers=[],this.hiddenCrowdMembers=[],this.hiddenCrowdMemberMap={},this.visibleCrowdMembersInAudienceArea=[],this.visibleCrowdMembersInAudienceAreaMap={},this.crowdBoppers=[],this.crowdNotBoppers=[],this.audienceRadius=0,this.audienceZOffset=0,this.addListener=$.proxy(this.addListener,this),this.removeListener=$.proxy(this.removeListener,this),e.$eventBus.on("Room.addListener",this.addListener),e.$eventBus.on("Room.removeListener",this.removeListener),this.regenerateAudienceLocations=t.debounce(this.regenerateAudienceLocations,100)},cleanup:function(){this.room.$eventBus.off("Room.addListener",this.addListener),this.room.$eventBus.off("Room.removeListener",this.removeListener),this.addListener=void 0,this.removeListener=void 0,this.room=void 0},generateLocation:function(e,t,i){var n=g.radius(t),s=.8+.4*e.random();i&&o>i&&(s*=1.8/(i/o+.8)),n*=s;var r=e.random()*Math.PI,a=Math.cos(r)*n*g.xMultiplier,l=Math.sin(r)*n*g.zMultiplier+g.zOffset;return{x:a,y:0,z:l}},generateAudienceLocation:function(e,t){var i=this.room.getEntropyForUser(e);null==t&&(t=this.audienceMemberIds.indexOf(e.id),-1===t&&(t=this.room.listenerids.length));var n=this.audienceMemberIds.length;this.crowdExists&&(n=Math.max(n,this.crowdSize));var o=this.generateLocation(i,t,n);return o.z+=this.audienceZOffset,o},isLocationInAudience:function(e){var t=e.x,i=e.z-this.audienceZOffset-g.zOffset;return i>=0&&Math.sqrt(Math.pow(t,2)+Math.pow(i,2))<=this.audienceRadius?!0:void 0},addCrowdMember:function(e){e=e||this.crowdMembers.length;var t,i=this.generateLocation(this.roomEntropy,e),n=e;t=e<1.2*this.capacity?f(this.roomEntropy):p(this.roomEntropy);var o={id:n,avatarId:t,location:i};return this.crowdMemberMap[n]=o,this.crowdMembers.push(o),this.crowdNotBoppers.push(n),o},removeCrowdMember:function(){var e=this.crowdMembers.pop(),t=e&&e.id;return t?(r(this.crowdBoppers,t),r(this.crowdNotBoppers,t),this.crowdMemberMap[t]=void 0,e):void 0},addListener:function(e,t){var i=this.audienceMemberIds,n=t,o=this.room.userMap[n];-1===i.indexOf(n)&&(i.push(n),this.audienceMemberMap[n]={user:o,location:this.generateAudienceLocation(o)},this.audienceRadius=g.radius(i.length),this.onChangeNumListeners())},removeListener:function(e,t){r(this.audienceMemberIds,t)&&(this.audienceMemberMap[t]=void 0,this.audienceRadius=g.radius(this.audienceMemberIds.length),this.onChangeNumListeners())},updateCrowd:function(e){if(!(e>n&&this.hasUpdatedAtMax)){n>e&&(this.hasUpdatedAtMax=!1),e=Math.min(e,n),this.crowdSize=e;var i=this.audienceMemberIds.length,o=[],s=[];if(e>i&&(this.crowdExists=!0),this.isSection||this.crowdExists){var r=this.crowdMembers,a=r.length;if(a>e)for(;r.length>e;)s.push(this.removeCrowdMember());else for(var l=r.length;e>l;l++)o.push(this.addCrowdMember(l));i>=e&&(this.crowdExists=!1)}this.isSection&&this.repositionAudience(e);var u=this.adjustHiddenCrowdMembers();return u.membersToHide=u.membersToHide.concat(s),u.membersToShow=t.difference(u.membersToShow.concat(o),u.membersToHide),e===n&&(this.hasUpdatedAtMax=!0),u}},repositionAudience:function(e){var t,i=this.audienceMemberIds.length,n=e-i;n>this.capacity?(e=this.capacity+i,t=g.radius(e)*m(this.capacity/e)):t=n?g.radius(e)*m(n/e):0,this.audienceZOffset=t*g.zMultiplier,this.regenerateAudienceLocations()},adjustHiddenCrowdMembers:function(){var e=this.crowdMembers,i=this.visibleCrowdMembersInAudienceAreaMap,n=this.hiddenCrowdMemberMap,o=this.numCrowdMembersHidden||0,s=this.audienceMemberIds.length,a=[],l=[];t.each(n,$.proxy(function(e,t){this.isLocationInAudience(e.location)||(delete n[t],o--,a.push(e),this.crowdBoppers.push(t),this.crowdNotBoppers.push(t))},this));for(var u=0,d=e.length;d>u;u++){var h=e[u],c=h.id;this.isLocationInAudience(h.location)?s>o&&!n[c]?(l.push(h),i[c]=void 0,n[c]=h,o++,l.push(e),r(this.crowdBoppers,c),r(this.crowdNotBoppers,c)):i[c]=h:i[c]&&(i[c]=void 0)}return this.numCrowdMembersHidden=o,{membersToHide:l,membersToShow:a}},updateCrowdBoppers:function(e){var t=this.crowdBoppers.length,i=[],n=[];if(t>e)for(;t>e;)n.push(this.stopCrowdBopper()),t--;else for(;e>t;)i.push(this.startCrowdBopper()),t++;return{membersToStart:i,membersToStop:n}},startCrowdBopper:function(){var e=a(this.crowdNotBoppers,!0);return e?(this.crowdBoppers.push(e),e):void 0},stopCrowdBopper:function(e){var e=a(this.crowdBoppers,!0);return e?(this.crowdNotBoppers.push(e),e):void 0},getLocation:function(e){var t=this.audienceMemberMap[e]||this.crowdMemberMap[e];return t.location},regenerateAudienceLocations:function(){for(var e,t,i,n=this.audienceMemberIds,o=this.audienceMemberMap,s=[],r=0,a=n.length;a>r;r++)e=o[n[r]],t=e.location,i=this.generateAudienceLocation(e.user,r),(i.x!==t.x||i.y!==t.y||i.z!==t.z)&&(e.location=i,s.push(e));this.audienceRadius=g.radius(a),s.length&&this.trigger("change",s)},onChangeNumListeners:function(){this.changeCount+=1,this.changeCount>s&&(this.regenerateAudienceLocations(),this.changeCount=0)}},{_name:"CrowdControl"});return v}),define("collections/djs",["require","tt-base","models/user"],function(e){var t=e("tt-base"),i=e("models/user");return t.Collection.extend({model:i},{_name:"DjsCollection"})}),define("dmca",[],function(){return{showPreview:function(e){for(var t=[],i=0;i<t.length;++i)if(e.metadata.labelid==t[i])return!1;return!0}}}),define("extensions",["require"],function(){function e(e){return r[e]?r[e].name:null}function t(e){var t=$.Deferred(),i=r[e];return i?void 0!==i.resource?$.ajax({url:"chrome-extension://"+e+i.resource,cache:!1}).done(function(){t.resolve()}).fail(function(){t.reject()}):void 0!==i.match_script?$("script").each(function(){null!==new RegExp(i.match_script).exec(this.src)?t.resolve():t.reject()}):void 0!==i.find_elem?$(i.find_elem).length>0?t.resolve():t.reject():t.reject():t.reject(),t.promise()}function i(){var e=$.Deferred(),i=_.map(_.keys(r),function(e){return[e,s(t(e))]});return $.when.apply(null,_.map(i,o)).then(function(){var t=_.object(_.map(i,n),arguments);e.resolve(t)}),e.promise()}function n(e){return e[0]}function o(e){return e[1]}function s(e){var t=$.Deferred();return e.done(function(){t.resolve(!0)}).fail(function(){t.resolve(!1)}),t.promise()}var r={icgjnmfceciegoonlpegpcaaeggghemc:{name:"Turntable Plus",resource:"/styles/ttp.css"},mnciafhfaahhafklckmcabbncbgcjpeg:{name:"Turntable.fm Extended",resource:"/css/turntable.fm.extend.css"},maeachdejbbdclpjocabmghabpbhcehm:{name:"Turntable X",match_script:"^https?://turntablex.com/source.php"},femhaoibopdmjanecjeeookdamkdfjaf:{name:"Turntable Customs",resource:"/css/customavi.css"},eimhdmlhdgmboegnmecdnfbmdmhdoool:{name:"Turntable.fm Playlist Manager",resource:"/js/playlists.js"},ldipemodldjfgcejcgpehbnocimlllhn:{name:"Turntable.FM Squared",resource:"/manifest.json"},fgcfdgdgmkhbebhllhoeghgmhaggpedc:{name:"Turntable Tweaks",match_script:"^https?://yayramen.com/tx.js"},ncpolodaokonmnmmdgdjljeomgoimfbi:{name:"TurnTable.FM AutoBop (Auto Awesome)",resource:"/manifest.json"},mkmhlagbcibaoealbggancljmkfbbfgc:{name:"TurntableTube (turntable.fm extension)",resource:"/manifest.json"},hmfikafklimedjffeonfomgdcknifpok:{name:"Turntable.fm Grooveshark Search",resource:"/manifest.json"},nnldmhlcgdkhgbnekldmppjoffikbclm:{name:"turntable autopilot",resource:"/manifest.json"},haphlddgggajdjamlcmnbpaijkggaekm:{name:"Turntable Expander",resource:"/manifest.json"},mfhjhlndnnifpjpbcfjjempddnjadklj:{name:"TurnTable.FM AutoBop (Auto Awesome)",match_script:"^https?://turntablefm-autobop-quickfix.googlecode.com/svn/trunk/ttfmautobop.js"},pgglgmmdgkkoodghfkhbjpdcdjdbpeel:{name:"Bacon Bits -- for Turntable.fm",resource:"/css/baconBits.css"},kkknfcianaominiidemeiafgkjlgagnn:{name:"Turntable Show User IDs",resource:"/manifest.json"},epcfmdmkikkolbiblblhgjpfoichkhch:{name:"Turntable Scriptlets",resource:"/manifest.json"},nhjclkggjlllgdjhcbbfkcjkgpfbnkgd:{name:"Turntable Enhanced",resource:"/styles/base.css"},opcolbabpobjampnljjmocakacmbpmmp:{name:"Fancy Cats on Turntable",resource:"/manifest.json"},hghdjdoklbmgdncibajljnlhimmeegfn:{name:"Turntable.fm: Autobop",match_script:"^https?://aim2wingaming.com/downloads/autobopv2.js"},jnfflkklekdbjpfbmgcmfchcnlmfldkf:{name:"Turntabler",resource:"/manifest.json"},mnfeodcjgdpofbliehldeadlfmbjhffm:{name:"Playlistt",match_script:"^https?://raw.github.com/gist/33e9c91570ff1f657977/playlistt.min.js"},idnhinafnplidpdhokniphoofjkfoill:{name:"Gimme My Playlist!",resource:"/manifest.json"},abgahpfoemegcefacbimgdjgefgmppnl:{name:"Awesome List for Rdio",find_elem:"#RdioButton",status:"not working"},ilfabbcicjljflkkeoljgdepceenlolm:{name:"ThePhish Themes.",resource:"/manifest.json"},hnhcbpemimcfcclejmmchcfpnclfceee:{name:"TurnTaste",resource:"/manifest.json"},cohnlgocahnimdhmbooiohlccomcdjam:{name:"jarTT",match_script:"^https?://raw.github.com/chrisinajar/jarTT/master/jarTT.js"},gphbkioiildnhpkjpihdcpfbbjbddelc:{name:"TT QueueLights",resource:"/QueueLights.css"},dcgjiomdaefemdhmhljfboidffmjlmdf:{name:"ttTools Loader",match_script:"^https?://raw.github.com/JNehlsen/ttTools/master/releases/latest/ttTools.extension.min.js"},hgjpnmnpjmabddgmjdiaggacbololbjm:{name:"Proxmate",resource:"/elements/overlay.css"}};return{getExtensionName:e,testForExtension:t,testForKnownExtensions:i}}),define("headband",["require","underscore","util","tt-common"],function(e){var t=e("underscore"),i=e("util"),n=e("tt-common"),o={api:"headband.get_headbands"},s=21,r=function(e){return i.setSetting("hide"+e[0].id,"true",s),$("#turntable").trigger("Headband","up"),e.slideUp().promise().done(function(){this.remove()})},a=function(e){var t=e.color||"red";return["div.alert-bar",{style:{display:"none"},className:t,id:e.id},["div.alert-mid",i.domify(e.content)],["div.alert-close",{event:{click:function(e){var t=$(e.currentTarget).closest(".alert-bar");r(t)}}}]]};return{isValid:function(e){return e&&e.hasOwnProperty("id")?i.getSetting("hide"+e.id,!0)?!1:!0:!1},displayHeadband:function(e){var t,n=$(".alert-bar");t=n.length?r(n):{},$.when(t).done(function(){var t=$("#turntable").trigger("Headband","down");$(i.buildTree(a(e))).appendTo(t).slideDown()})},displayValidHeadband:function(){n.apiGet(o).done(t.bind(function(e){var i=t(e).find(this.isValid);i&&this.displayHeadband(i)},this))}}}),define("views/mini-dj",["require","tt-base","app","views/avatar-head","lib/jquery.menu-aim"],function(e){var t=e("tt-base"),i=e("app"),n=e("views/avatar-head");return e("lib/jquery.menu-aim"),t.View.extend({methodsToBind:[/_.*Popover/],el:function(){return["li.mini-dj",[n,{model:this.model,scale:.5,dark:!0}],["div.mini-dj-popover##$popover"]]},events:{"click .mini-dj-popover":"_onPopoverClick"},init:function(){this.nodes.$popover.hide(),this.$el.menuAim({activate:this._showPopover,deactivate:this._hidePopover,rowSelector:".avatar-head",submenuDirection:"below",tolerance:5})},_showPopover:function(e){return e?(this.nodes.$popover.html(i.room.roomView.makePopoverContent(this.model.id,!0)).show(),this.nodes.popover.firstChild):void 0},_hidePopover:function(e){e&&this.nodes.$popover.hide()},_onPopoverClick:function(){this.nodes.$popover.hide()}},{_name:"MiniDjView"})}),define("views/mini-djs",["require","app","views/collection","views/mini-dj"],function(e){var t=e("app"),i=e("views/collection"),n=e("views/mini-dj");return i.extend({options:{idd:"miniDjs",view:n},el:["div.mini-djs",["ul"],["div.invite-dj-btn##$invite","Invite DJ"],["div.become-dj-btn##$become","Play Music"]],events:{"click .invite-dj-btn":"_onInviteDjClick","click .become-dj-btn":"_onBecomeDjClick"},init:function(){this._super.apply(this,arguments),this.nodes.$become.hide(),this.nodes.$invite.hide(),this.listenTo(this.collection,"add remove",this.onCollectionChange),this.listenTo(t.user,"change:registered",this.updateDjButton),this.updateDjButton(),this.listenTo(t,"currentSong:change",this._onSongChange)},updateDjButton:function(){this.nodes.$become.hide(),this.nodes.$invite.hide(),!this.options.room.section&&t.user.get("registered")&&(this.options.room.roomData.metadata&&(this.options.room.djs.length>=this.options.room.roomData.metadata.max_djs||this.options.room.roomData.metadata.dj_reservation===!0)||(this.options.room.djs.contains(t.user)?this.nodes.$invite.css("display","inline-block"):this.nodes.$become.css("display","inline-block")))},onCollectionChange:function(){this.updateDjButton(),this._onSongChange(t.currentSongPlay)},onReset:function(){this._super.apply(this,arguments),this.updateDjButton(),this._onSongChange(t.currentSongPlay)},_onInviteDjClick:function(){this.options.room.inviteDj()},_onBecomeDjClick:function(){this.options.room.fusWBa()},_onSongChange:function(e){this.$(".mini-dj").removeClass("active"),e&&this.$(".mini-dj").eq(this.collection.indexOf(this.collection.get(e.get("djId")))).addClass("active")}},{_name:"MiniDjsView"})}),define("views/songboard",["require","tt-base","util","app"],function(e){var t=e("tt-base"),i=e("util"),n=e("app"),o=t.View.extend({methodsToBind:["_tick"],options:{artistSpacing:10,songSpacing:10,artistStepWidth:50,songStepWidth:30},el:["div.board##board",["div.songboard##songboard",["div.song-details",["div.songboard-artist-line##artist",["span.songboard-artist.songboard-main"],["span.songboard-artist.songboard-clone"]],["div.songboard-song-line##title",["span.songboard-song.songboard-main"],["span.songboard-song.songboard-clone"]],["div.songboard-time##time"],["div.songboard-time-left##time-remaining"],["div.songboard-progress-bar##progress",["div.songboard-progress##progress-lit"]]],["div.songboard-add",["div.songboard-add-text##add","Add song to:"],["ul.songboard-services",["li",["div.service-btn.queue##tt",{data:{service:"queue"}}],["div.service-name##ttText"]],["li",["div.service-btn.soundcloud##soundcloud",{data:{service:"soundcloud"}}],["div.service-name","soundcloud"]],["li",["div.service-btn.amazon##amazon",{data:{service:"amazon"}}],["div.service-name","amazon"]],["li",["div.service-btn.itunes##itunes",{data:{service:"itunes"}}],["div.service-name","itunes"]],["li",["div.service-btn.lastfm##lastfm",{data:{service:"lastfm"}}],["div.service-name","last.fm"]],["li",["div.service-btn.spotify##spotify",{data:{service:"spotify"}}],["div.service-name","spotify"]]]]],["div.awesome-button##up"],["div.lame-button##down"],["div.awesome-meter##dial"],["div.awesome-needle##needle"]],events:{"click .awesome-button":"upvote","click .lame-button":"downvote","click .service-btn":"onSongAddClick"},loadingMessages:["the bits are breeding","go ahead - hold your breath","at least you're not on hold","we're testing your patience","as if you had any other choice","don't think of purple hippos","follow the white rabbit","reticulating splines","frobulating widgets","pc load letter"],init:function(){this._setupMarquees(),this.$progress=$(this.nodes["progress-lit"]),this.$timeSinceStart=$(this.nodes.time),this.$timeLeft=$(this.nodes["time-remaining"]),this.$awesome=$(this.nodes.up),this.$lame=$(this.nodes.down),this.listenTo(n,{"currentSong:change":this.setCurrentSong}),this.model&&this.setCurrentSong(this.model),this.throttledResize=i.rateLimit(this,this._onResize,100),$(window).on("resize",this.throttledResize),this.listenTo(this.options.songVote,"change:vote",this.updateVote),this.listenTo(n,"registered",this.modifyQueueText),this.modifyQueueText()},modifyQueueText:function(){$(this.nodes.ttText).text(n.user.registered?"current playlist":"sign up to save songs")},setCurrentSong:function(e){this.model&&(this.tickId&&(window.clearInterval(this.tickId),this.tickId=void 0),this.stopListening(this.model)),this._resetMarquees(),this.model=e,e?(this.tickId=window.setInterval(this._tick,1e3),this._setMarquees(),this.listenTo(e,{"change:progress":this.updateProgress,"change:timeSinceStart":this.updateTimeSinceStart,"change:timeLeft":this.updateTimeLeft}),this.$el.addClass("song-playing")):this.$el.removeClass("song-playing")},updateProgress:function(e){this.$progress.css("width",100*e.get("progress")+"%")},updateTimeSinceStart:function(e){this.$timeSinceStart.text(i.prettyTime(e.get("timeSinceStart")))},updateTimeLeft:function(e){this.$timeLeft.text(i.prettyTime(e.get("timeLeft")))},updateVote:function(e){var t=e.get("vote");"up"===t?(this.$awesome.addClass("selected"),this.$lame.removeClass("selected")):"down"===t?(this.$awesome.removeClass("selected"),this.$lame.addClass("selected")):(this.$awesome.removeClass("selected"),this.$lame.removeClass("selected"))},upvote:function(){this.options.songVote.upvote()},downvote:function(){this.options.songVote.downvote()},onSongAddClick:function(e){var t=$.data(e.target,"service");n.room.addSong(t)},remove:function(){$(window).off("resize",this.throttledResize),this._super.apply(this,arguments)},marqueeTypes:["artist","song"],_setupMarquees:function(){_.each(this.marqueeTypes,this._setupMarquee,this)},_setupMarquee:function(e){var t=".songboard-"+e,i=this[e]={$line:this.$(t+"-line"),$text:this.$(t),$main:this.$(t+".songboard-main"),$clone:this.$(t+".songboard-clone"),spacing:this.options[e+"Spacing"],stepWidth:this.options[e+"StepWidth"],offset:0,loopWidth:0,shouldScroll:!1};i.$clone.css("margin-left",i.spacing)},_resetMarquees:function(){_.each(this.marqueeTypes,this._resetMarquee,this)},_resetMarquee:function(e){var t=this[e];t.$text.text(""),t.offset=0,t.loopWidth=0},_setMarquees:function(){_.each(this.marqueeTypes,this._setMarquee,this),this._onResize()},_setMarquee:function(e){var t=this[e];t.$text.text(this.model.get("metadata")[e]),t.loopWidth=t.$main.width()+t.spacing,t.offset=0,t.shouldScroll=!1},_tick:function(){_.each(this.marqueeTypes,this._tickMarquee,this)},_tickMarquee:function(e){var t=this[e];t.shouldScroll&&(t.$main.css("margin-left",-t.offset),t.offset=(t.offset+t.stepWidth)%t.loopWidth)},_onResize:function(){_.each(this.marqueeTypes,this._checkMarquee,this)},_checkMarquee:function(e){var t=this[e];t.$main.width()>t.$line.width()?(t.$line.addClass("marquee"),t.shouldScroll=!0):(t.$line.removeClass("marquee"),t.shouldScroll=!1,t.$main.css("margin-left",""),t.offset=0)}},{_name:"Songboard"});return o}),define("views/mini-room",["require","tt-base","app","views/mini-djs","views/songboard"],function(e){var t=e("tt-base"),i=e("app"),n=e("views/mini-djs"),o=e("views/songboard"),s=t.View.extend({el:function(){return["div.mini-room-view",[o,{model:this.model.currentSongPlay,songVote:this.model.songVote}],[n,{collection:this.model.djs,room:this.model}],["div.mini-room-current-dj##$djField","Current DJ: ",["span.mini-room-current-dj-name##$djName"]]]},init:function(){this.listenTo(i,"currentSong:change",this._onSongChange)},_onSongChange:function(e){e?(this.nodes.$djName.text(i.room.userMap[e.get("djId")].get("name")),this.nodes.$djField.show()):(this.nodes.$djName.text(""),this.nodes.$djField.hide())}},{_name:"MiniplayerRoomView"});return s}),function(){function e(){this.returnValue=!1}function t(){this.cancelBubble=!0}var i,n,o=0,s=[],r={},a={},l={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},u=/[<>&\"\']/g,d=window.setTimeout,h={};!function(e){var t,i,n,o=e.split(/,/);for(t=0;t<o.length;t+=2)for(n=o[t+1].split(/ /),i=0;i<n.length;i++)a[n[i]]=o[t]}("application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mpga mpega mp2 mp3,audio/x-wav,wav,audio/mp4,m4a,image/bmp,bmp,image/gif,gif,image/jpeg,jpeg jpg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/vnd.rn-realvideo,rv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe");var c={VERSION:"1.5.4",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:a,ua:function(){var e,t,i,n=navigator,o=n.userAgent,s=n.vendor;return e=/WebKit/.test(o),i=e&&-1!==s.indexOf("Apple"),t=window.opera&&window.opera.buildNumber,{windows:-1!==navigator.platform.indexOf("Win"),ie:!e&&!t&&/MSIE/gi.test(o)&&/Explorer/gi.test(n.appName),webkit:e,gecko:!e&&/Gecko/.test(o),safari:i,opera:!!t}
}(),typeOf:function(e){return{}.toString.call(e).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()},extend:function(e){return c.each(arguments,function(t,i){i>0&&c.each(t,function(t,i){e[i]=t})}),e},cleanName:function(e){var t,i;for(i=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"],t=0;t<i.length;t+=2)e=e.replace(i[t],i[t+1]);return e=e.replace(/\s+/g,"_"),e=e.replace(/[^a-z0-9_\-\.]+/gi,"")},addRuntime:function(e,t){return t.name=e,s[e]=t,s.push(t),t},guid:function(){var e,t=(new Date).getTime().toString(32);for(e=0;5>e;e++)t+=Math.floor(65535*Math.random()).toString(32);return(c.guidPrefix||"p")+t+(o++).toString(32)},buildUrl:function(e,t){var i="";return c.each(t,function(e,t){i+=(i?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),i&&(e+=(e.indexOf("?")>0?"&":"?")+i),e},each:function(e,t){var n,o,s;if(e)if(n=e.length,n===i){for(o in e)if(e.hasOwnProperty(o)&&t(e[o],o)===!1)return}else for(s=0;n>s;s++)if(t(e[s],s)===!1)return},formatSize:function(e){return e===i||/\D/.test(e)?c.translate("N/A"):e>1073741824?Math.round(e/1073741824,1)+" GB":e>1048576?Math.round(e/1048576,1)+" MB":e>1024?Math.round(e/1024,1)+" KB":e+" b"},getPos:function(e,t){function i(e){var t,i,n=0,o=0;return e&&(i=e.getBoundingClientRect(),t="CSS1Compat"===l.compatMode?l.documentElement:l.body,n=i.left+t.scrollLeft,o=i.top+t.scrollTop),{x:n,y:o}}var n,o,s,r=0,a=0,l=document;if(e=e,t=t||l.body,e&&e.getBoundingClientRect&&navigator.userAgent.indexOf("MSIE")>0&&l.documentMode<8)return o=i(e),s=i(t),{x:o.x-s.x,y:o.y-s.y};for(n=e;n&&n!=t&&n.nodeType;)r+=n.offsetLeft||0,a+=n.offsetTop||0,n=n.offsetParent;for(n=e.parentNode;n&&n!=t&&n.nodeType;)r-=n.scrollLeft||0,a-=n.scrollTop||0,n=n.parentNode;return{x:r,y:a}},getSize:function(e){return{w:e.offsetWidth||e.clientWidth,h:e.offsetHeight||e.clientHeight}},parseSize:function(e){var t;return"string"==typeof e&&(e=/^([0-9]+)([mgk]?)$/.exec(e.toLowerCase().replace(/[^0-9mkg]/g,"")),t=e[2],e=+e[1],"g"==t&&(e*=1073741824),"m"==t&&(e*=1048576),"k"==t&&(e*=1024)),e},xmlEncode:function(e){return e?(""+e).replace(u,function(e){return l[e]?"&"+l[e]+";":e}):e},toArray:function(e){var t,i=[];for(t=0;t<e.length;t++)i[t]=e[t];return i},inArray:function(e,t){if(t){if(Array.prototype.indexOf)return Array.prototype.indexOf.call(t,e);for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return i}return-1},addI18n:function(e){return c.extend(r,e)},translate:function(e){return r[e]||e},isEmptyObj:function(e){if(e===i)return!0;for(var t in e)return!1;return!0},hasClass:function(e,t){var i;return""==e.className?!1:(i=new RegExp("(^|\\s+)"+t+"(\\s+|$)"),i.test(e.className))},addClass:function(e,t){c.hasClass(e,t)||(e.className=""==e.className?t:e.className.replace(/\s+$/,"")+" "+t)},removeClass:function(e,t){var i=new RegExp("(^|\\s+)"+t+"(\\s+|$)");e.className=e.className.replace(i,function(e,t,i){return" "===t&&" "===i?" ":""})},getStyle:function(e,t){return e.currentStyle?e.currentStyle[t]:window.getComputedStyle?window.getComputedStyle(e,null)[t]:void 0},addEvent:function(o,s,r){var a,l,u;u=arguments[3],s=s.toLowerCase(),n===i&&(n="Plupload_"+c.guid()),o.addEventListener?(a=r,o.addEventListener(s,a,!1)):o.attachEvent&&(a=function(){var i=window.event;i.target||(i.target=i.srcElement),i.preventDefault=e,i.stopPropagation=t,r(i)},o.attachEvent("on"+s,a)),o[n]===i&&(o[n]=c.guid()),h.hasOwnProperty(o[n])||(h[o[n]]={}),l=h[o[n]],l.hasOwnProperty(s)||(l[s]=[]),l[s].push({func:a,orig:r,key:u})},removeEvent:function(e,t){var o,s,r;if("function"==typeof arguments[2]?s=arguments[2]:r=arguments[2],t=t.toLowerCase(),e[n]&&h[e[n]]&&h[e[n]][t]){o=h[e[n]][t];for(var a=o.length-1;a>=0&&(o[a].key!==r&&o[a].orig!==s||(e.removeEventListener?e.removeEventListener(t,o[a].func,!1):e.detachEvent&&e.detachEvent("on"+t,o[a].func),o[a].orig=null,o[a].func=null,o.splice(a,1),s===i));a--);if(o.length||delete h[e[n]][t],c.isEmptyObj(h[e[n]])){delete h[e[n]];try{delete e[n]}catch(l){e[n]=i}}}},removeAllEvents:function(e){var t=arguments[1];e[n]!==i&&e[n]&&c.each(h[e[n]],function(i,n){c.removeEvent(e,n,t)})}};c.Uploader=function(e){function t(){var e,t,i=0;if(this.state==c.STARTED){for(t=0;t<l.length;t++)e||l[t].status!=c.QUEUED?i++:(e=l[t],e.status=c.UPLOADING,this.trigger("BeforeUpload",e)&&this.trigger("UploadFile",e));i==l.length&&(this.stop(),this.trigger("UploadComplete",l))}}function n(){var e,t;for(o.reset(),e=0;e<l.length;e++)t=l[e],t.size!==i?(o.size+=t.size,o.loaded+=t.loaded):o.size=i,t.status==c.DONE?o.uploaded++:t.status==c.FAILED?o.failed++:o.queued++;o.size===i?o.percent=l.length>0?Math.ceil(100*(o.uploaded/l.length)):0:(o.bytesPerSec=Math.ceil(o.loaded/((+new Date-r||1)/1e3)),o.percent=o.size>0?Math.ceil(100*(o.loaded/o.size)):0)}var o,r,a={},l=[],u=!1;o=new c.QueueProgress,e=c.extend({chunk_size:0,multipart:!0,multi_selection:!0,file_data_name:"file",filters:[]},e),c.extend(this,{state:c.STOPPED,runtime:"",features:{},files:l,settings:e,total:o,id:c.guid(),init:function(){function o(){var e,t,i,n=u[f++];if(n){if(e=n.getFeatures(),t=p.settings.required_features)for(t=t.split(","),i=0;i<t.length;i++)if(!e[t[i]])return o(),void 0;n.init(p,function(t){t&&t.success?(p.features=e,p.runtime=n.name,p.trigger("Init",{runtime:n.name}),p.trigger("PostInit"),p.refresh()):o()})}else p.trigger("Error",{code:c.INIT_ERROR,message:c.translate("Init error.")})}var a,u,h,p=this,f=0;if("function"==typeof e.preinit?e.preinit(p):c.each(e.preinit,function(e,t){p.bind(t,e)}),e.page_url=e.page_url||document.location.pathname.replace(/\/[^\/]+$/g,"/"),/^(\w+:\/\/|\/)/.test(e.url)||(e.url=e.page_url+e.url),e.chunk_size=c.parseSize(e.chunk_size),e.max_file_size=c.parseSize(e.max_file_size),p.bind("FilesAdded",function(t,n){var o,s,r,a=0,u=e.filters;for(u&&u.length&&(r=[],c.each(u,function(e){c.each(e.extensions.split(/,/),function(e){/^\s*\*\s*$/.test(e)?r.push("\\.*"):r.push("\\."+e.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})}),r=new RegExp(r.join("|")+"$","i")),o=0;o<n.length;o++)s=n[o],s.loaded=0,s.percent=0,s.status=c.QUEUED,!r||r.test(s.name)?s.size!==i&&s.size>e.max_file_size?t.trigger("Error",{code:c.FILE_SIZE_ERROR,message:c.translate("File size error."),file:s}):(l.push(s),a++):t.trigger("Error",{code:c.FILE_EXTENSION_ERROR,message:c.translate("File extension error."),file:s});return a?(d(function(){p.trigger("QueueChanged"),p.refresh()},1),void 0):!1}),e.unique_names&&p.bind("UploadFile",function(e,t){var i=t.name.match(/\.([^.]+)$/),n="tmp";i&&(n=i[1]),t.target_name=t.id+"."+n}),p.bind("UploadProgress",function(e,t){t.percent=t.size>0?Math.ceil(100*(t.loaded/t.size)):100,n()}),p.bind("StateChanged",function(e){if(e.state==c.STARTED)r=+new Date;else if(e.state==c.STOPPED)for(a=e.files.length-1;a>=0;a--)e.files[a].status==c.UPLOADING&&(e.files[a].status=c.QUEUED,n())}),p.bind("QueueChanged",n),p.bind("Error",function(e,i){i.file&&(i.file.status=c.FAILED,n(),e.state==c.STARTED&&d(function(){t.call(p)},1))}),p.bind("FileUploaded",function(e,i){i.status=c.DONE,i.loaded=i.size,e.trigger("UploadProgress",i),d(function(){t.call(p)},1)}),e.runtimes)for(u=[],h=e.runtimes.split(/\s?,\s?/),a=0;a<h.length;a++)s[h[a]]&&u.push(s[h[a]]);else u=s;o(),"function"==typeof e.init?e.init(p):c.each(e.init,function(e,t){p.bind(t,e)})},refresh:function(){this.trigger("Refresh")},start:function(){l.length&&this.state!=c.STARTED&&(this.state=c.STARTED,this.trigger("StateChanged"),t.call(this))},stop:function(){this.state!=c.STOPPED&&(this.state=c.STOPPED,this.trigger("CancelUpload"),this.trigger("StateChanged"))},disableBrowse:function(){u=arguments[0]!==i?arguments[0]:!0,this.trigger("DisableBrowse",u)},getFile:function(e){var t;for(t=l.length-1;t>=0;t--)if(l[t].id===e)return l[t]},removeFile:function(e){var t;for(t=l.length-1;t>=0;t--)if(l[t].id===e.id)return this.splice(t,1)[0]},splice:function(e,t){var n;return n=l.splice(e===i?0:e,t===i?l.length:t),this.trigger("FilesRemoved",n),this.trigger("QueueChanged"),n},trigger:function(e){var t,i,n=a[e.toLowerCase()];if(n)for(i=Array.prototype.slice.call(arguments),i[0]=this,t=0;t<n.length;t++)if(n[t].func.apply(n[t].scope,i)===!1)return!1;return!0},hasEventListener:function(e){return!!a[e.toLowerCase()]},bind:function(e,t,i){var n;e=e.toLowerCase(),n=a[e]||[],n.push({func:t,scope:i||this}),a[e]=n},unbind:function(e){e=e.toLowerCase();var t,n=a[e],o=arguments[1];if(n){if(o!==i){for(t=n.length-1;t>=0;t--)if(n[t].func===o){n.splice(t,1);break}}else n=[];n.length||delete a[e]}},unbindAll:function(){var e=this;c.each(a,function(t,i){e.unbind(i)})},destroy:function(){this.stop(),this.trigger("Destroy"),this.unbindAll()}})},c.File=function(e,t,i){var n=this;n.id=e,n.name=t,n.size=i,n.loaded=0,n.percent=0,n.status=0},c.Runtime=function(){this.getFeatures=function(){},this.init=function(){}},c.QueueProgress=function(){var e=this;e.size=0,e.loaded=0,e.uploaded=0,e.failed=0,e.queued=0,e.percent=0,e.bytesPerSec=0,e.reset=function(){e.size=e.loaded=e.uploaded=e.failed=e.queued=e.percent=e.bytesPerSec=0}},c.runtimes={},window.plupload=c}(),function(){if(!window.google||!google.gears){var e=null;if("undefined"!=typeof GearsFactory)e=new GearsFactory;else try{e=new ActiveXObject("Gears.Factory"),-1!=e.getBuildInfo().indexOf("ie_mobile")&&e.privateSetGlobalObject(this)}catch(t){"undefined"!=typeof navigator.mimeTypes&&navigator.mimeTypes["application/x-googlegears"]&&(e=document.createElement("object"),e.style.display="none",e.width=0,e.height=0,e.type="application/x-googlegears",document.documentElement.appendChild(e))}e&&(window.google||(window.google={}),google.gears||(google.gears={factory:e}))}}(),function(e,t,i){function n(e,t,i){var n,o;n=google.gears.factory.create("beta.canvas");try{if(n.decode(e),t.width||(t.width=n.width),t.height||(t.height=n.height),o=Math.min(width/n.width,height/n.height),1>o||1===o&&"image/jpeg"===i)return n.resize(Math.round(n.width*o),Math.round(n.height*o)),t.quality?n.encode(i,{quality:t.quality/100}):n.encode(i)}catch(s){}return e}var o={};i.runtimes.Gears=i.addRuntime("gears",{getFeatures:function(){return{dragdrop:!0,jpgresize:!0,pngresize:!0,chunks:!0,progress:!0,multipart:!0,multi_selection:!0}},init:function(s,r){function a(e){var t,n,r,a=[];for(n=0;n<e.length;n++)t=e[n],r=i.guid(),o[r]=t.blob,a.push(new i.File(r,t.name,t.blob.length));s.trigger("FilesAdded",a)}var l,u,d=!1;if(!e.google||!google.gears)return r({success:!1});try{l=google.gears.factory.create("beta.desktop")}catch(h){return r({success:!1})}s.bind("PostInit",function(){var e=s.settings,n=t.getElementById(e.drop_element);n&&(i.addEvent(n,"dragover",function(e){l.setDropEffect(e,"copy"),e.preventDefault()},s.id),i.addEvent(n,"drop",function(e){var t=l.getDragData(e,"application/x-gears-files");t&&a(t.files),e.preventDefault()},s.id),n=0),i.addEvent(t.getElementById(e.browse_button),"click",function(t){var i,n,o,s=[];if(t.preventDefault(),!d){e:for(i=0;i<e.filters.length;i++)for(o=e.filters[i].extensions.split(","),n=0;n<o.length;n++){if("*"===o[n]){s=[];break e}s.push("."+o[n])}l.openFiles(a,{singleFile:!e.multi_selection,filter:s})}},s.id)}),s.bind("CancelUpload",function(){u.abort&&u.abort()}),s.bind("UploadFile",function(e,t){function s(){function n(n){var o,s,r,a="----pluploadboundary"+i.guid(),l="--",d="\r\n";p&&(u.setRequestHeader("Content-Type","multipart/form-data; boundary="+a),o=google.gears.factory.create("beta.blobbuilder"),i.each(i.extend(m,e.settings.multipart_params),function(e,t){o.append(l+a+d+'Content-Disposition: form-data; name="'+t+'"'+d+d),o.append(e+d)}),r=i.mimeTypes[t.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream",o.append(l+a+d+'Content-Disposition: form-data; name="'+e.settings.file_data_name+'"; filename="'+t.name+'"'+d+"Content-Type: "+r+d+d),o.append(n),o.append(d+l+a+l+d),s=o.getAsBlob(),f=s.length-n.length,n=s),u.send(n)}var c,p=e.settings.multipart,f=0,m={name:t.target_name||t.name},g=e.settings.url;t.status!=i.DONE&&t.status!=i.FAILED&&e.state!=i.STOPPED&&(l&&(m.chunk=d,m.chunks=r),c=Math.min(a,t.size-d*a),p||(g=i.buildUrl(e.settings.url,m)),u=google.gears.factory.create("beta.httprequest"),u.open("POST",g),p||(u.setRequestHeader("Content-Disposition",'attachment; filename="'+t.name+'"'),u.setRequestHeader("Content-Type","application/octet-stream")),i.each(e.settings.headers,function(e,t){u.setRequestHeader(t,e)}),u.upload.onprogress=function(i){t.loaded=h+i.loaded-f,e.trigger("UploadProgress",t)},u.onreadystatechange=function(){var n;if(4==u.readyState&&e.state!==i.STOPPED)if(200==u.status){if(n={chunk:d,chunks:r,response:u.responseText,status:u.status},e.trigger("ChunkUploaded",t,n),n.cancelled)return t.status=i.FAILED,void 0;h+=c,++d>=r?(t.status=i.DONE,e.trigger("FileUploaded",t,{response:u.responseText,status:u.status})):s()}else e.trigger("Error",{code:i.HTTP_ERROR,message:i.translate("HTTP Error."),file:t,chunk:d,chunks:r,status:u.status})},r>d&&n(o[t.id].slice(d*a,c)))}var r,a,l,d=0,h=0,c=e.settings.resize;c&&/\.(png|jpg|jpeg)$/i.test(t.name)&&(o[t.id]=n(o[t.id],c,/\.png$/i.test(t.name)?"image/png":"image/jpeg")),t.size=o[t.id].length,a=e.settings.chunk_size,l=a>0,r=Math.ceil(t.size/a),l||(a=t.size,r=1),s()}),s.bind("DisableBrowse",function(e,t){d=t}),s.bind("Destroy",function(e){var n,o,s={browseButton:e.settings.browse_button,dropElm:e.settings.drop_element};for(n in s)o=t.getElementById(s[n]),o&&i.removeAllEvents(o,e.id)}),r({success:!0})}})}(window,document,plupload),function(e,t,i,n){function o(e){var t,i,s,r,a=typeof e;if(e===n||null===e)return"null";if("string"===a)return t="\bb	t\nn\ff\rr\"\"''\\\\",'"'+e.replace(/([\u0080-\uFFFF\x00-\x1f\"])/g,function(e,i){var n=t.indexOf(i);return n+1?"\\"+t.charAt(n+1):(e=i.charCodeAt().toString(16),"\\u"+"0000".substring(e.length)+e)})+'"';if("object"==a){if(i=e.length!==n,t="",i){for(s=0;s<e.length;s++)t&&(t+=","),t+=o(e[s]);t="["+t+"]"}else{for(r in e)e.hasOwnProperty(r)&&(t&&(t+=","),t+=o(r)+":"+o(e[r]));t="{"+t+"}"}return t}return""+e}function s(e){var t,i,n,o,s,r=!1,a=null,l=0;try{try{a=new ActiveXObject("AgControl.AgControl"),a.IsVersionSupported(e)&&(r=!0),a=null}catch(u){var d=navigator.plugins["Silverlight Plug-In"];if(d){for(t=d.description,"1.0.30226.2"===t&&(t="2.0.30226.2"),i=t.split(".");i.length>3;)i.pop();for(;i.length<4;)i.push(0);for(n=e.split(".");n.length>4;)n.pop();do o=parseInt(n[l],10),s=parseInt(i[l],10),l++;while(l<n.length&&o===s);s>=o&&!isNaN(o)&&(r=!0)}}}catch(h){r=!1}return r}var r={},a={};i.silverlight={trigger:function(e,t){var n,o=r[e];o&&(n=i.toArray(arguments).slice(1),n[0]="Silverlight:"+t,setTimeout(function(){o.trigger.apply(o,n)},0))}},i.runtimes.Silverlight=i.addRuntime("silverlight",{getFeatures:function(){return{jpgresize:!0,pngresize:!0,chunks:!0,progress:!0,multipart:!0,multi_selection:!0}},init:function(n,l){function u(){return t.getElementById(n.id+"_silverlight").content.Upload}var d,h,c="",p=n.settings.filters,f=t.body;if(!s("2.0.31005.0")||e.opera&&e.opera.buildNumber)return l({success:!1}),void 0;for(a[n.id]=!1,r[n.id]=n,d=t.createElement("div"),d.id=n.id+"_silverlight_container",i.extend(d.style,{position:"absolute",top:"0px",background:n.settings.shim_bgcolor||"transparent",zIndex:99999,width:"100px",height:"100px",overflow:"hidden",opacity:n.settings.shim_bgcolor||t.documentMode>8?"":.01}),d.className="plupload silverlight",n.settings.container&&(f=t.getElementById(n.settings.container),"static"===i.getStyle(f,"position")&&(f.style.position="relative")),f.appendChild(d),h=0;h<p.length;h++)c+=(""!=c?"|":"")+p[h].title+" | *."+p[h].extensions.replace(/,/g,";*.");d.innerHTML='<object id="'+n.id+'_silverlight" data="data:application/x-silverlight," type="application/x-silverlight-2" style="outline:none;" width="1024" height="1024"><param name="source" value="'+n.settings.silverlight_xap_url+'"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="id='+n.id+",filter="+c+",multiselect="+n.settings.multi_selection+'"/></object>',n.bind("Silverlight:Init",function(){var e,s={};a[n.id]||(a[n.id]=!0,n.bind("Silverlight:StartSelectFiles",function(){e=[]}),n.bind("Silverlight:SelectFile",function(t,n,o,r){var a;a=i.guid(),s[a]=n,s[n]=a,e.push(new i.File(a,o,r))}),n.bind("Silverlight:SelectSuccessful",function(){e.length&&n.trigger("FilesAdded",e)}),n.bind("Silverlight:UploadChunkError",function(e,t,o,r,a){n.trigger("Error",{code:i.IO_ERROR,message:"IO Error.",details:a,file:e.getFile(s[t])})}),n.bind("Silverlight:UploadFileProgress",function(e,t,n,o){var r=e.getFile(s[t]);r.status!=i.FAILED&&(r.size=o,r.loaded=n,e.trigger("UploadProgress",r))}),n.bind("Refresh",function(e){var n,o,s;n=t.getElementById(e.settings.browse_button),n&&(o=i.getPos(n,t.getElementById(e.settings.container)),s=i.getSize(n),i.extend(t.getElementById(e.id+"_silverlight_container").style,{top:o.y+"px",left:o.x+"px",width:s.w+"px",height:s.h+"px"}))}),n.bind("Silverlight:UploadChunkSuccessful",function(e,t,n,o,r){var a,l=e.getFile(s[t]);a={chunk:n,chunks:o,response:r},e.trigger("ChunkUploaded",l,a),l.status!=i.FAILED&&e.state!==i.STOPPED&&u().UploadNextChunk(),n==o-1&&(l.status=i.DONE,e.trigger("FileUploaded",l,{response:r}))}),n.bind("Silverlight:UploadSuccessful",function(e,t,n){var o=e.getFile(s[t]);o.status=i.DONE,e.trigger("FileUploaded",o,{response:n})}),n.bind("FilesRemoved",function(e,t){var i;for(i=0;i<t.length;i++)u().RemoveFile(s[t[i].id])}),n.bind("UploadFile",function(e,t){var n=e.settings,r=n.resize||{};u().UploadFile(s[t.id],e.settings.url,o({name:t.target_name||t.name,mime:i.mimeTypes[t.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream",chunk_size:n.chunk_size,image_width:r.width,image_height:r.height,image_quality:r.quality||90,multipart:!!n.multipart,multipart_params:n.multipart_params||{},file_data_name:n.file_data_name,headers:n.headers}))}),n.bind("CancelUpload",function(){u().CancelUpload()}),n.bind("Silverlight:MouseEnter",function(e){var o,s;o=t.getElementById(n.settings.browse_button),s=e.settings.browse_button_hover,o&&s&&i.addClass(o,s)}),n.bind("Silverlight:MouseLeave",function(e){var o,s;o=t.getElementById(n.settings.browse_button),s=e.settings.browse_button_hover,o&&s&&i.removeClass(o,s)}),n.bind("Silverlight:MouseLeftButtonDown",function(e){var o,s;o=t.getElementById(n.settings.browse_button),s=e.settings.browse_button_active,o&&s&&(i.addClass(o,s),i.addEvent(t.body,"mouseup",function(){i.removeClass(o,s)}))}),n.bind("Sliverlight:StartSelectFiles",function(e){var o,s;o=t.getElementById(n.settings.browse_button),s=e.settings.browse_button_active,o&&s&&i.removeClass(o,s)}),n.bind("DisableBrowse",function(e,t){u().DisableBrowse(t)}),n.bind("Destroy",function(e){var n;i.removeAllEvents(t.body,e.id),delete a[e.id],delete r[e.id],n=t.getElementById(e.id+"_silverlight_container"),n&&f.removeChild(n)}),l({success:!0}))})}})}(window,document,plupload),function(e,t,i){function n(){var e;try{e=navigator.plugins["Shockwave Flash"],e=e.description}catch(t){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(i){e="0.0"}}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1])}var o={},s={};i.flash={trigger:function(e,t,i){setTimeout(function(){var n=o[e];n&&n.trigger("Flash:"+t,i)},0)}},i.runtimes.Flash=i.addRuntime("flash",{getFeatures:function(){return{jpgresize:!0,pngresize:!0,maxWidth:8091,maxHeight:8091,chunks:!0,progress:!0,multipart:!0,multi_selection:!0}},init:function(e,r){function a(){return t.getElementById(e.id+"_flash")}function l(){return h++>5e3?(r({success:!1}),void 0):(s[e.id]===!1&&setTimeout(l,1),void 0)}var u,d,h=0,c=t.body;return n()<10?(r({success:!1}),void 0):(s[e.id]=!1,o[e.id]=e,u=t.getElementById(e.settings.browse_button),d=t.createElement("div"),d.id=e.id+"_flash_container",i.extend(d.style,{position:"absolute",top:"0px",background:e.settings.shim_bgcolor||"transparent",zIndex:99999,width:"100%",height:"100%"}),d.className="plupload flash",e.settings.container&&(c=t.getElementById(e.settings.container),"static"===i.getStyle(c,"position")&&(c.style.position="relative")),c.appendChild(d),function(){var n,o;n='<object id="'+e.id+'_flash" type="application/x-shockwave-flash" data="'+e.settings.flash_swf_url+'" ',i.ua.ie&&(n+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),n+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+e.settings.flash_swf_url+'" /><param name="flashvars" value="id='+escape(e.id)+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',i.ua.ie?(o=t.createElement("div"),d.appendChild(o),o.outerHTML=n,o=null):d.innerHTML=n}(),l(),u=d=null,e.bind("Destroy",function(e){var n;i.removeAllEvents(t.body,e.id),delete s[e.id],delete o[e.id],n=t.getElementById(e.id+"_flash_container"),n&&c.removeChild(n)}),e.bind("Flash:Init",function(){var n={};try{a().setFileFilters(e.settings.filters,e.settings.multi_selection)}catch(o){return r({success:!1}),void 0}s[e.id]||(s[e.id]=!0,e.bind("UploadFile",function(t,o){var s=t.settings,r=e.settings.resize||{};a().uploadFile(n[o.id],s.url,{name:o.target_name||o.name,mime:i.mimeTypes[o.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream",chunk_size:s.chunk_size,width:r.width,height:r.height,quality:r.quality,multipart:s.multipart,multipart_params:s.multipart_params||{},file_data_name:s.file_data_name,format:/\.(jpg|jpeg)$/i.test(o.name)?"jpg":"png",headers:s.headers,urlstream_upload:s.urlstream_upload})}),e.bind("CancelUpload",function(){a().cancelUpload()}),e.bind("Flash:UploadProcess",function(e,t){var o=e.getFile(n[t.id]);o.status!=i.FAILED&&(o.loaded=t.loaded,o.size=t.size,e.trigger("UploadProgress",o))}),e.bind("Flash:UploadChunkComplete",function(e,t){var o,s=e.getFile(n[t.id]);o={chunk:t.chunk,chunks:t.chunks,response:t.text},e.trigger("ChunkUploaded",s,o),s.status!==i.FAILED&&e.state!==i.STOPPED&&a().uploadNextChunk(),t.chunk==t.chunks-1&&(s.status=i.DONE,e.trigger("FileUploaded",s,{response:t.text}))}),e.bind("Flash:SelectFiles",function(t,o){var s,r,a,l=[];for(r=0;r<o.length;r++)s=o[r],a=i.guid(),n[a]=s.id,n[s.id]=a,l.push(new i.File(a,s.name,s.size));l.length&&e.trigger("FilesAdded",l)}),e.bind("Flash:SecurityError",function(t,o){e.trigger("Error",{code:i.SECURITY_ERROR,message:i.translate("Security error."),details:o.message,file:e.getFile(n[o.id])})}),e.bind("Flash:GenericError",function(t,o){e.trigger("Error",{code:i.GENERIC_ERROR,message:i.translate("Generic error."),details:o.message,file:e.getFile(n[o.id])})}),e.bind("Flash:IOError",function(t,o){e.trigger("Error",{code:i.IO_ERROR,message:i.translate("IO error."),details:o.message,file:e.getFile(n[o.id])})}),e.bind("Flash:ImageError",function(t,o){e.trigger("Error",{code:parseInt(o.code,10),message:i.translate("Image error."),file:e.getFile(n[o.id])})}),e.bind("Flash:StageEvent:rollOver",function(n){var o,s;o=t.getElementById(e.settings.browse_button),s=n.settings.browse_button_hover,o&&s&&i.addClass(o,s)}),e.bind("Flash:StageEvent:rollOut",function(n){var o,s;o=t.getElementById(e.settings.browse_button),s=n.settings.browse_button_hover,o&&s&&i.removeClass(o,s)}),e.bind("Flash:StageEvent:mouseDown",function(n){var o,s;o=t.getElementById(e.settings.browse_button),s=n.settings.browse_button_active,o&&s&&(i.addClass(o,s),i.addEvent(t.body,"mouseup",function(){i.removeClass(o,s)},n.id))}),e.bind("Flash:StageEvent:mouseUp",function(n){var o,s;o=t.getElementById(e.settings.browse_button),s=n.settings.browse_button_active,o&&s&&i.removeClass(o,s)}),e.bind("Flash:ExifData",function(t,i){e.trigger("ExifData",e.getFile(n[i.id]),i.data)}),e.bind("Flash:GpsData",function(t,i){e.trigger("GpsData",e.getFile(n[i.id]),i.data)}),e.bind("QueueChanged",function(){e.refresh()}),e.bind("FilesRemoved",function(e,t){var i;for(i=0;i<t.length;i++)a().removeFile(n[t[i].id])}),e.bind("StateChanged",function(){e.refresh()}),e.bind("Refresh",function(n){var o,s,r;a().setFileFilters(e.settings.filters,e.settings.multi_selection),o=t.getElementById(n.settings.browse_button),o&&(s=i.getPos(o,t.getElementById(n.settings.container)),r=i.getSize(o),i.extend(t.getElementById(n.id+"_flash_container").style,{top:s.y+"px",left:s.x+"px",width:r.w+"px",height:r.h+"px"}))}),e.bind("DisableBrowse",function(e,t){a().disableBrowse(t)}),r({success:!0}))}),void 0)}})}(window,document,plupload),function(e){e.runtimes.BrowserPlus=e.addRuntime("browserplus",{getFeatures:function(){return{dragdrop:!0,jpgresize:!0,pngresize:!0,chunks:!0,progress:!0,multipart:!0,multi_selection:!0}},init:function(t,i){function n(i){var n,o,s,a=[];for(n=0;n<i.length;n++)o=i[n],s=e.guid(),r[s]=o,a.push(new e.File(s,o.name,o.size));n&&t.trigger("FilesAdded",a)}function o(){var o=!1;t.bind("PostInit",function(){function i(e,t){s.DragAndDrop.AddDropTarget({id:e},function(){s.DragAndDrop.AttachCallbacks({id:e,hover:function(e){!e&&t&&t()},drop:function(e){t&&t(),n(e)}},function(){})})}function r(){document.getElementById(d).style.top="-1000px"}var l,u=a.drop_element,d=t.id+"_droptarget",h=document.getElementById(u);h&&(document.attachEvent&&/MSIE/gi.test(navigator.userAgent)?(l=document.createElement("div"),l.setAttribute("id",d),e.extend(l.style,{position:"absolute",top:"-1000px",background:"red",filter:"alpha(opacity=0)",opacity:0}),document.body.appendChild(l),e.addEvent(h,"dragenter",function(){var t,i;t=document.getElementById(u),i=e.getPos(t),e.extend(document.getElementById(d).style,{top:i.y+"px",left:i.x+"px",width:t.offsetWidth+"px",height:t.offsetHeight+"px"})}),i(d,r)):i(u)),e.addEvent(document.getElementById(a.browse_button),"click",function(t){var i,r,l,u,d=[],h=a.filters;if(t.preventDefault(),!o){e:for(i=0;i<h.length;i++)for(l=h[i].extensions.split(","),r=0;r<l.length;r++){if("*"===l[r]){d=[];break e}u=e.mimeTypes[l[r]],u&&-1===e.inArray(u,d)&&d.push(e.mimeTypes[l[r]])}s.FileBrowse.OpenBrowseDialog({mimeTypes:d},function(e){e.success&&n(e.value)})}}),h=l=null}),t.bind("CancelUpload",function(){s.Uploader.cancel({},function(){})}),t.bind("DisableBrowse",function(e,t){o=t}),t.bind("UploadFile",function(t,i){function n(o,r){var l;i.status!=e.FAILED&&(d.name=i.target_name||i.name,h&&(d.chunk=""+o,d.chunks=""+r),l=c.shift(),s.Uploader.upload({url:t.settings.url,files:{file:l},cookies:document.cookies,postvars:e.extend(d,t.settings.multipart_params),progressCallback:function(e){var n,s=0;for(a[o]=parseInt(e.filePercent*l.size/100,10),n=0;n<a.length;n++)s+=a[n];i.loaded=s,t.trigger("UploadProgress",i)}},function(s){var a;s.success?(a=s.value.statusCode,h&&t.trigger("ChunkUploaded",i,{chunk:o,chunks:r,response:s.value.body,status:a}),c.length>0?n(++o,r):(i.status=e.DONE,t.trigger("FileUploaded",i,{response:s.value.body,status:a}),a>=400&&t.trigger("Error",{code:e.HTTP_ERROR,message:e.translate("HTTP Error."),file:i,status:a}))):t.trigger("Error",{code:e.GENERIC_ERROR,message:e.translate("Generic Error."),file:i,details:s.error})}))}function o(e){i.size=e.size,h?s.FileAccess.chunk({file:e,chunkSize:h},function(e){if(e.success){var t=e.value,i=t.length;a=Array(i);for(var o=0;i>o;o++)a[o]=0,c.push(t[o]);n(0,i)}}):(a=Array(1),c.push(e),n(0,1))}var a,u=r[i.id],d={},h=t.settings.chunk_size,c=[];l&&/\.(png|jpg|jpeg)$/i.test(i.name)?BrowserPlus.ImageAlter.transform({file:u,quality:l.quality||90,actions:[{scale:{maxwidth:l.width,maxheight:l.height}}]},function(e){e.success&&o(e.value.file)}):o(u)}),i({success:!0})}var s=window.BrowserPlus,r={},a=t.settings,l=a.resize;s?s.init(function(e){var t=[{service:"Uploader",version:"3"},{service:"DragAndDrop",version:"1"},{service:"FileBrowse",version:"1"},{service:"FileAccess",version:"2"}];l&&t.push({service:"ImageAlter",version:"4"}),e.success?s.require({services:t},function(e){e.success?o():i()}):i()}):i()}})}(plupload),function(e,t,n,o){function s(t,i){var n;return"FileReader"in e?(n=new FileReader,n.readAsDataURL(t),n.onload=function(){i(n.result)},void 0):i(t.getAsDataURL())}function r(t,i){var n;return"FileReader"in e?(n=new FileReader,n.readAsBinaryString(t),n.onload=function(){i(n.result)},void 0):i(t.getAsBinary())}function a(e,i,n,o){var r,a,l,h,p=this;s(c[e.id],function(s){r=t.createElement("canvas"),r.style.display="none",t.body.appendChild(r),a=r.getContext("2d"),l=new Image,l.onerror=l.onabort=function(){o({success:!1})},l.onload=function(){var t,c,f,m;if(i.width||(i.width=l.width),i.height||(i.height=l.height),h=Math.min(i.width/l.width,i.height/l.height),1>h||1===h&&"image/jpeg"===n){if(t=Math.round(l.width*h),c=Math.round(l.height*h),r.width=t,r.height=c,a.drawImage(l,0,0,t,c),"image/jpeg"===n){if(f=new u(atob(s.substring(s.indexOf("base64,")+7))),f.headers&&f.headers.length&&(m=new d,m.init(f.get("exif")[0])&&(m.setExif("PixelXDimension",t),m.setExif("PixelYDimension",c),f.set("exif",m.getBinary()),p.hasEventListener("ExifData")&&p.trigger("ExifData",e,m.EXIF()),p.hasEventListener("GpsData")&&p.trigger("GpsData",e,m.GPS()))),i.quality)try{s=r.toDataURL(n,i.quality/100)}catch(g){s=r.toDataURL(n)}}else s=r.toDataURL(n);s=s.substring(s.indexOf("base64,")+7),s=atob(s),f&&f.headers&&f.headers.length&&(s=f.restore(s),f.purge()),r.parentNode.removeChild(r),o({success:!0,data:s})}else o({success:!1})},l.src=s})}function l(){function e(e,t){var i,o=s?0:-8*(t-1),r=0;for(i=0;t>i;i++)r|=n.charCodeAt(e+i)<<Math.abs(o+8*i);return r}function t(e,t,i){var i=3===arguments.length?i:n.length-t-1;n=n.substr(0,t)+e+n.substr(i+t)}function i(e,i,n){var o,r="",a=s?0:-8*(n-1);for(o=0;n>o;o++)r+=String.fromCharCode(255&i>>Math.abs(a+8*o));t(r,e,n)}var n,s=!1;return{II:function(e){return e===o?s:(s=e,void 0)},init:function(e){s=!1,n=e},SEGMENT:function(e,i,o){switch(arguments.length){case 1:return n.substr(e,n.length-e-1);case 2:return n.substr(e,i);case 3:t(o,e,i);break;default:return n}},BYTE:function(t){return e(t,1)},SHORT:function(t){return e(t,2)},LONG:function(t,n){return n===o?e(t,4):(i(t,n,4),void 0)},SLONG:function(t){var i=e(t,4);return i>2147483647?i-4294967296:i},STRING:function(t,i){var n="";for(i+=t;i>t;t++)n+=String.fromCharCode(e(t,1));return n}}}function u(e){var t,i,n,s={65505:{app:"EXIF",name:"APP1",signature:"Exif\0"},65506:{app:"ICC",name:"APP2",signature:"ICC_PROFILE\0"},65517:{app:"IPTC",name:"APP13",signature:"Photoshop 3.0\0"}},r=[],a=o,d=0;if(t=new l,t.init(e),65496===t.SHORT(0)){for(i=2,n=Math.min(1048576,e.length);n>=i;)if(a=t.SHORT(i),a>=65488&&65495>=a)i+=2;else{if(65498===a||65497===a)break;d=t.SHORT(i+2)+2,s[a]&&t.STRING(i+4,s[a].signature.length)===s[a].signature&&r.push({hex:a,app:s[a].app.toUpperCase(),name:s[a].name.toUpperCase(),start:i,length:d,segment:t.SEGMENT(i,d)}),i+=d}return t.init(null),{headers:r,restore:function(e){t.init(e);var n=new u(e);if(!n.headers)return!1;for(var o=n.headers.length;o>0;o--){var s=n.headers[o-1];t.SEGMENT(s.start,s.length,"")}n.purge(),i=65504==t.SHORT(2)?4+t.SHORT(4):2;for(var o=0,a=r.length;a>o;o++)t.SEGMENT(i,0,r[o].segment),i+=r[o].length;return t.SEGMENT()},get:function(e){for(var t=[],i=0,n=r.length;n>i;i++)r[i].app===e.toUpperCase()&&t.push(r[i].segment);return t},set:function(e,t){var i=[];"string"==typeof t?i.push(t):i=t;for(var n=ii=0,o=r.length;o>n&&(r[n].app===e.toUpperCase()&&(r[n].segment=i[ii],r[n].length=i[ii].length,ii++),!(ii>=i.length));n++);},purge:function(){r=[],t.init(null)}}}}function d(){function e(e,t){var i,n,s,a,l,h,c,p,f=r.SHORT(e),m=[],g={};for(i=0;f>i;i++)if(c=h=e+12*i+2,s=t[r.SHORT(c)],s!==o){switch(a=r.SHORT(c+=2),l=r.LONG(c+=2),c+=4,m=[],a){case 1:case 7:for(l>4&&(c=r.LONG(c)+d.tiffHeader),n=0;l>n;n++)m[n]=r.BYTE(c+n);break;case 2:l>4&&(c=r.LONG(c)+d.tiffHeader),g[s]=r.STRING(c,l-1);continue;case 3:for(l>2&&(c=r.LONG(c)+d.tiffHeader),n=0;l>n;n++)m[n]=r.SHORT(c+2*n);break;case 4:for(l>1&&(c=r.LONG(c)+d.tiffHeader),n=0;l>n;n++)m[n]=r.LONG(c+4*n);break;case 5:for(c=r.LONG(c)+d.tiffHeader,n=0;l>n;n++)m[n]=r.LONG(c+4*n)/r.LONG(c+4*n+4);
break;case 9:for(c=r.LONG(c)+d.tiffHeader,n=0;l>n;n++)m[n]=r.SLONG(c+4*n);break;case 10:for(c=r.LONG(c)+d.tiffHeader,n=0;l>n;n++)m[n]=r.SLONG(c+4*n)/r.SLONG(c+4*n+4);break;default:continue}p=1==l?m[0]:m,g[s]=u.hasOwnProperty(s)&&"object"!=typeof p?u[s][p]:p}return g}function t(){var t=o,i=d.tiffHeader;return r.II(18761==r.SHORT(i)),42!==r.SHORT(i+=2)?!1:(d.IFD0=d.tiffHeader+r.LONG(i+=2),t=e(d.IFD0,a.tiff),d.exifIFD="ExifIFDPointer"in t?d.tiffHeader+t.ExifIFDPointer:o,d.gpsIFD="GPSInfoIFDPointer"in t?d.tiffHeader+t.GPSInfoIFDPointer:o,!0)}function s(e,t,n){var o,s,l,u=0;if("string"==typeof t){var h=a[e.toLowerCase()];for(hex in h)if(h[hex]===t){t=hex;break}}for(o=d[e.toLowerCase()+"IFD"],s=r.SHORT(o),i=0;s>i;i++)if(l=o+12*i+2,r.SHORT(l)==t){u=l+8;break}return u?(r.LONG(u,n),!0):!1}var r,a,u,d={};return r=new l,a={tiff:{274:"Orientation",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}},u={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}},{init:function(e){return d={tiffHeader:10},e!==o&&e.length?(r.init(e),65505===r.SHORT(0)&&"EXIF\0"===r.STRING(4,5).toUpperCase()?t():!1):!1},EXIF:function(){var t;if(t=e(d.exifIFD,a.exif),t.ExifVersion&&"array"===n.typeOf(t.ExifVersion)){for(var i=0,o="";i<t.ExifVersion.length;i++)o+=String.fromCharCode(t.ExifVersion[i]);t.ExifVersion=o}return t},GPS:function(){var t;return t=e(d.gpsIFD,a.gps),t.GPSVersionID&&(t.GPSVersionID=t.GPSVersionID.join(".")),t},setExif:function(e,t){return"PixelXDimension"!==e&&"PixelYDimension"!==e?!1:s("exif",e,t)},getBinary:function(){return r.SEGMENT()}}}var h,c={};n.runtimes.Html5=n.addRuntime("html5",{getFeatures:function(){var i,o,s,r,a,l;return o=s=a=l=!1,e.XMLHttpRequest&&(i=new XMLHttpRequest,s=!!i.upload,o=!(!i.sendAsBinary&&!i.upload)),o&&(r=!!(i.sendAsBinary||e.Uint8Array&&e.ArrayBuffer),a=!(!File||!File.prototype.getAsDataURL&&!e.FileReader||!r),l=!(!File||!(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice))),h=n.ua.safari&&n.ua.windows,{html5:o,dragdrop:function(){var e=t.createElement("div");return"draggable"in e||"ondragstart"in e&&"ondrop"in e}(),jpgresize:a,pngresize:a,multipart:a||!!e.FileReader||!!e.FormData,canSendBinary:r,cantSendBlobInFormData:!(!(n.ua.gecko&&e.FormData&&e.FileReader)||FileReader.prototype.readAsArrayBuffer),progress:s,chunks:l,multi_selection:!(n.ua.safari&&n.ua.windows),triggerDialog:n.ua.gecko&&e.FormData||n.ua.webkit}},init:function(i,o){function s(e){var t,o,s,r=[],a={};for(o=0;o<e.length;o++)t=e[o],a[t.name]||(a[t.name]=!0,s=n.guid(),c[s]=t,r.push(new n.File(s,t.fileName||t.name,t.fileSize||t.size)));r.length&&i.trigger("FilesAdded",r)}var l,u;return l=this.getFeatures(),l.html5?(i.bind("Init",function(e){var o,r,a,l,u,d,h,c=[],p=e.settings.filters,f=t.body;o=t.createElement("div"),o.id=e.id+"_html5_container",n.extend(o.style,{position:"absolute",background:i.settings.shim_bgcolor||"transparent",width:"100px",height:"100px",overflow:"hidden",zIndex:99999,opacity:i.settings.shim_bgcolor?"":0}),o.className="plupload html5",i.settings.container&&(f=t.getElementById(i.settings.container),"static"===n.getStyle(f,"position")&&(f.style.position="relative")),f.appendChild(o);e:for(a=0;a<p.length;a++)for(u=p[a].extensions.split(/,/),l=0;l<u.length;l++){if("*"===u[l]){c=[];break e}d=n.mimeTypes[u[l]],d&&-1===n.inArray(d,c)&&c.push(d)}if(o.innerHTML='<input id="'+i.id+'_html5"  style="font-size:999px" type="file" accept="'+c.join(",")+'" '+(i.settings.multi_selection&&i.features.multi_selection?'multiple="multiple"':"")+" />",o.scrollTop=100,h=t.getElementById(i.id+"_html5"),e.features.triggerDialog?n.extend(h.style,{position:"absolute",width:"100%",height:"100%"}):n.extend(h.style,{cssFloat:"right",styleFloat:"right"}),h.onchange=function(){s(this.files),this.value=""},r=t.getElementById(e.settings.browse_button)){var m=e.settings.browse_button_hover,g=e.settings.browse_button_active,v=e.features.triggerDialog?r:o;m&&(n.addEvent(v,"mouseover",function(){n.addClass(r,m)},e.id),n.addEvent(v,"mouseout",function(){n.removeClass(r,m)},e.id)),g&&(n.addEvent(v,"mousedown",function(){n.addClass(r,g)},e.id),n.addEvent(t.body,"mouseup",function(){n.removeClass(r,g)},e.id)),e.features.triggerDialog&&n.addEvent(r,"click",function(i){var n=t.getElementById(e.id+"_html5");n&&!n.disabled&&n.click(),i.preventDefault()},e.id)}}),i.bind("PostInit",function(){var e=t.getElementById(i.settings.drop_element);if(e){if(h)return n.addEvent(e,"dragenter",function(){var o,r,a;o=t.getElementById(i.id+"_drop"),o||(o=t.createElement("input"),o.setAttribute("type","file"),o.setAttribute("id",i.id+"_drop"),o.setAttribute("multiple","multiple"),n.addEvent(o,"change",function(){s(this.files),n.removeEvent(o,"change",i.id),o.parentNode.removeChild(o)},i.id),e.appendChild(o)),r=n.getPos(e,t.getElementById(i.settings.container)),a=n.getSize(e),"static"===n.getStyle(e,"position")&&n.extend(e.style,{position:"relative"}),n.extend(o.style,{position:"absolute",display:"block",top:0,left:0,width:a.w+"px",height:a.h+"px",opacity:0})},i.id),void 0;n.addEvent(e,"dragover",function(e){e.preventDefault()},i.id),n.addEvent(e,"drop",function(e){var t=e.dataTransfer;t&&t.files&&s(t.files),e.preventDefault()},i.id)}}),i.bind("Refresh",function(e){var o,s,r,a,l;o=t.getElementById(i.settings.browse_button),o&&(s=n.getPos(o,t.getElementById(e.settings.container)),r=n.getSize(o),a=t.getElementById(i.id+"_html5_container"),n.extend(a.style,{top:s.y+"px",left:s.x+"px",width:r.w+"px",height:r.h+"px"}),i.features.triggerDialog&&("static"===n.getStyle(o,"position")&&n.extend(o.style,{position:"relative"}),l=parseInt(n.getStyle(o,"z-index"),10),isNaN(l)&&(l=0),n.extend(o.style,{zIndex:l}),n.extend(a.style,{zIndex:l-1})))}),i.bind("DisableBrowse",function(e,i){var n=t.getElementById(e.id+"_html5");n&&(n.disabled=i)}),i.bind("CancelUpload",function(){u&&u.abort&&u.abort()}),i.bind("UploadFile",function(t,i){function o(e,t,i){var n;if(!File.prototype.slice)return(n=File.prototype.webkitSlice||File.prototype.mozSlice)?n.call(e,t,i):null;try{return e.slice(),e.slice(t,i)}catch(o){return e.slice(t,i-t)}}function s(s){function r(){function p(o){var s,h=0,c="----pluploadboundary"+n.guid(),p="--",_="\r\n",x="";if(u=new XMLHttpRequest,u.upload&&(u.upload.onprogress=function(e){i.loaded=Math.min(i.size,d+e.loaded-h),t.trigger("UploadProgress",i)}),u.onreadystatechange=function(){var e,l;if(4==u.readyState&&t.state!==n.STOPPED){try{e=u.status}catch(h){e=0}if(e>=400)t.trigger("Error",{code:n.HTTP_ERROR,message:n.translate("HTTP Error."),file:i,status:e});else{if(m){if(l={chunk:a,chunks:m,response:u.responseText,status:e},t.trigger("ChunkUploaded",i,l),d+=b,l.cancelled)return i.status=n.FAILED,void 0;i.loaded=Math.min(i.size,(a+1)*v)}else i.loaded=i.size;t.trigger("UploadProgress",i),o=f=s=x=null,!m||++a>=m?(i.status=n.DONE,t.trigger("FileUploaded",i,{response:u.responseText,status:e})):r()}}},t.settings.multipart&&l.multipart){if(g.name=i.target_name||i.name,u.open("post",y,!0),n.each(t.settings.headers,function(e,t){u.setRequestHeader(t,e)}),"string"!=typeof o&&e.FormData)return s=new FormData,n.each(n.extend(g,t.settings.multipart_params),function(e,t){s.append(t,e)}),s.append(t.settings.file_data_name,o),u.send(s),void 0;if("string"==typeof o){if(u.setRequestHeader("Content-Type","multipart/form-data; boundary="+c),n.each(n.extend(g,t.settings.multipart_params),function(e,t){x+=p+c+_+'Content-Disposition: form-data; name="'+t+'"'+_+_,x+=unescape(encodeURIComponent(e))+_}),w=n.mimeTypes[i.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream",x+=p+c+_+'Content-Disposition: form-data; name="'+t.settings.file_data_name+'"; filename="'+unescape(encodeURIComponent(i.name))+'"'+_+"Content-Type: "+w+_+_+o+_+p+c+p+_,h=x.length-o.length,o=x,u.sendAsBinary)u.sendAsBinary(o);else if(l.canSendBinary){for(var S=new Uint8Array(o.length),k=0;k<o.length;k++)S[k]=255&o.charCodeAt(k);u.send(S.buffer)}return}}y=n.buildUrl(t.settings.url,n.extend(g,t.settings.multipart_params)),u.open("post",y,!0),u.setRequestHeader("Content-Type","application/octet-stream"),n.each(t.settings.headers,function(e,t){u.setRequestHeader(t,e)}),u.send(o)}var f,m,g,v,b,w,y=t.settings.url;i.status!=n.DONE&&i.status!=n.FAILED&&t.state!=n.STOPPED&&(g={name:i.target_name||i.name},h.chunk_size&&i.size>h.chunk_size&&(l.chunks||"string"==typeof s)?(v=h.chunk_size,m=Math.ceil(i.size/v),b=Math.min(v,i.size-a*v),f="string"==typeof s?s.substring(a*v,a*v+b):o(s,a*v,a*v+b),g.chunk=a,g.chunks=m):(b=i.size,f=s),t.settings.multipart&&l.multipart&&"string"!=typeof f&&c&&l.cantSendBlobInFormData&&l.chunks&&t.settings.chunk_size?(c.onload=function(){p(c.result)},c.readAsBinaryString(f)):p(f))}var a=0,d=0,c="FileReader"in e?new FileReader:null;r()}var d,h=t.settings;d=c[i.id],l.jpgresize&&t.settings.resize&&/\.(png|jpg|jpeg)$/i.test(i.name)?a.call(t,i,t.settings.resize,/\.png$/i.test(i.name)?"image/png":"image/jpeg",function(e){e.success?(i.size=e.data.length,s(e.data)):l.chunks?s(d):r(d,s)}):!l.chunks&&l.jpgresize?r(d,s):s(d)}),i.bind("Destroy",function(e){var i,o,s=t.body,r={inputContainer:e.id+"_html5_container",inputFile:e.id+"_html5",browseButton:e.settings.browse_button,dropElm:e.settings.drop_element};for(i in r)o=t.getElementById(r[i]),o&&n.removeAllEvents(o,e.id);n.removeAllEvents(t.body,e.id),e.settings.container&&(s=t.getElementById(e.settings.container)),s.removeChild(t.getElementById(r.inputContainer))}),o({success:!0}),void 0):(o({success:!1}),void 0)}})}(window,document,plupload),function(e,t,i){function n(e){return t.getElementById(e)}i.runtimes.Html4=i.addRuntime("html4",{getFeatures:function(){return{multipart:!0,triggerDialog:i.ua.gecko&&e.FormData||i.ua.webkit}},init:function(o,s){o.bind("Init",function(s){function r(){var e,a,l,u;d=i.guid(),v.push(d),e=t.createElement("form"),e.setAttribute("id","form_"+d),e.setAttribute("method","post"),e.setAttribute("enctype","multipart/form-data"),e.setAttribute("encoding","multipart/form-data"),e.setAttribute("target",s.id+"_iframe"),e.style.position="absolute",a=t.createElement("input"),a.setAttribute("id","input_"+d),a.setAttribute("type","file"),a.setAttribute("accept",w),a.setAttribute("size",1),u=n(s.settings.browse_button),s.features.triggerDialog&&u&&i.addEvent(n(s.settings.browse_button),"click",function(e){a.disabled||a.click(),e.preventDefault()},s.id),i.extend(a.style,{width:"100%",height:"100%",opacity:0,fontSize:"99px",cursor:"pointer"}),i.extend(e.style,{overflow:"hidden"}),l=s.settings.shim_bgcolor,l&&(e.style.background=l),b&&i.extend(a.style,{filter:"alpha(opacity=0)"}),i.addEvent(a,"change",function(t){var l,h=t.target,c=[];h.value&&(n("form_"+d).style.top="-1048575px",l=h.value.replace(/\\/g,"/"),l=l.substring(l.length,l.lastIndexOf("/")+1),c.push(new i.File(d,l)),s.features.triggerDialog?i.removeEvent(u,"click",s.id):i.removeAllEvents(e,s.id),i.removeEvent(a,"change",s.id),r(),c.length&&o.trigger("FilesAdded",c))},s.id),e.appendChild(a),m.appendChild(e),s.refresh()}function a(){var n=t.createElement("div");n.innerHTML='<iframe id="'+s.id+'_iframe" name="'+s.id+'_iframe" src="'+g+':&quot;&quot;" style="display:none"></iframe>',l=n.firstChild,m.appendChild(l),i.addEvent(l,"load",function(t){var n,o,r=t.target;if(u){try{n=r.contentWindow.document||r.contentDocument||e.frames[r.id].document}catch(a){return s.trigger("Error",{code:i.SECURITY_ERROR,message:i.translate("Security error."),file:u}),void 0}o=n.body.innerHTML,o&&(u.status=i.DONE,u.loaded=1025,u.percent=100,s.trigger("UploadProgress",u),s.trigger("FileUploaded",u,{response:o}))}},s.id)}var l,u,d,h,c,p,f,m=t.body,g="javascript",v=[],b=/MSIE/.test(navigator.userAgent),w=[],y=s.settings.filters;e:for(h=0;h<y.length;h++)for(c=y[h].extensions.split(/,/),f=0;f<c.length;f++){if("*"===c[f]){w=[];break e}p=i.mimeTypes[c[f]],p&&-1===i.inArray(p,w)&&w.push(p)}w=w.join(","),s.settings.container&&(m=n(s.settings.container),"static"===i.getStyle(m,"position")&&(m.style.position="relative")),s.bind("UploadFile",function(e,o){var s,r;o.status!=i.DONE&&o.status!=i.FAILED&&e.state!=i.STOPPED&&(s=n("form_"+o.id),r=n("input_"+o.id),r.setAttribute("name",e.settings.file_data_name),s.setAttribute("action",e.settings.url),i.each(i.extend({name:o.target_name||o.name},e.settings.multipart_params),function(e,n){var o=t.createElement("input");i.extend(o,{type:"hidden",name:n,value:e}),s.insertBefore(o,s.firstChild)}),u=o,n("form_"+d).style.top="-1048575px",s.submit())}),s.bind("FileUploaded",function(e){e.refresh()}),s.bind("StateChanged",function(t){t.state==i.STARTED?a():t.state==i.STOPPED&&e.setTimeout(function(){i.removeEvent(l,"load",t.id),l.parentNode&&l.parentNode.removeChild(l)},0),i.each(t.files,function(e){if(e.status===i.DONE||e.status===i.FAILED){var t=n("form_"+e.id);t&&t.parentNode.removeChild(t)}})}),s.bind("Refresh",function(e){var o,s,r,a,l,u,h,c,p;o=n(e.settings.browse_button),o&&(l=i.getPos(o,n(e.settings.container)),u=i.getSize(o),h=n("form_"+d),c=n("input_"+d),i.extend(h.style,{top:l.y+"px",left:l.x+"px",width:u.w+"px",height:u.h+"px"}),e.features.triggerDialog&&("static"===i.getStyle(o,"position")&&i.extend(o.style,{position:"relative"}),p=parseInt(o.style.zIndex,10),isNaN(p)&&(p=0),i.extend(o.style,{zIndex:p}),i.extend(h.style,{zIndex:p-1})),r=e.settings.browse_button_hover,a=e.settings.browse_button_active,s=e.features.triggerDialog?o:h,r&&(i.addEvent(s,"mouseover",function(){i.addClass(o,r)},e.id),i.addEvent(s,"mouseout",function(){i.removeClass(o,r)},e.id)),a&&(i.addEvent(s,"mousedown",function(){i.addClass(o,a)},e.id),i.addEvent(t.body,"mouseup",function(){i.removeClass(o,a)},e.id)))}),o.bind("FilesRemoved",function(e,t){var i,o;for(i=0;i<t.length;i++)o=n("form_"+t[i].id),o&&o.parentNode.removeChild(o)}),o.bind("DisableBrowse",function(e,i){var n=t.getElementById("input_"+d);n&&(n.disabled=i)}),o.bind("Destroy",function(e){var o,s,r,a={inputContainer:"form_"+d,inputFile:"input_"+d,browseButton:e.settings.browse_button};for(o in a)s=n(a[o]),s&&i.removeAllEvents(s,e.id);i.removeAllEvents(t.body,e.id),i.each(v,function(e){r=n("form_"+e),r&&m.removeChild(r)})}),r()}),s({success:!0})}})}(window,document,plupload),define("plupload",function(e){return function(){var t;return t||e.plupload}}(this)),define("views/song-item",["require","tt-base","app","dmca"],function(e){var t=e("tt-base"),i=e("app"),n=e("dmca");return t.View.extend({el:function(){var e,t=this.model,i=t.get("metadata"),o=n.showPreview(t);return t.get("djName")&&(e=["span.dj-info",["a.dj",{href:"/profile/"+t.get("djId")},t.get("djName")]]),source="sc"==t.get("source")?".soundcloud":"",["div.song",{data:{songData:t.attributes}},["div.progress-bar",["div.progress"]],["div.thumb",{style:{"background-image":i.coverart?"url("+i.coverart+")":""}}],["div.source"+source],["div.playSample",{style:o?{}:{display:"none"}}],["div.pauseSample"],["div.title",{title:i.song},i.song],["div.details",["span",i.artist,["span.divider"," \u2022 "],util.prettyTime(i.length)]],["div.score$score"],e]},init:function(){if(this.model.get("score")&&(this.listenTo(this.model,"change:score",this.updateScore),this.updateScore()),this.model.get("djName")){var e=this.$el.closest("body").length;e?this._updateDetailsMargin():this.listenToOnce(i,"songLog:visible",this._updateDetailsMargin)}},updateScore:function(){var e=this.model.get("score");this.nodes.$score.text(Math.round(100*e)+"%"),e>=.5?this.nodes.$score.addClass("scoregood").removeClass("scorebad"):this.nodes.$score.removeClass("scoregood").addClass("scorebad")},_updateDetailsMargin:function(){var e=this.$(".dj-info").width()+16;this.$(".details").css("right",e)}},{_name:"SongItem"})}),define("views/song-list",["require","app","views/collection","views/song-item","player"],function(e){var t=e("app"),i=e("views/collection"),n=e("views/song-item"),o=e("player");return i.extend({methodsToBind:["_onSongAddClick"],options:{idd:"songList",view:n},el:function(){return["div.song-list",["div.default-message$default",["p",this.options.defaultMessage]],["ul"]]},events:{"mouseenter .song":"_onSongMouseenter","mouseleave .song":"_onSongMouseleave","click .playSample":"_onPreviewPlayClick","click .pauseSample":o.sampleStop},init:function(){this._super.apply(this,arguments),this.listenTo(this.collection,"add remove",_.debounce(_.bind(this._onLengthChange,this),100))},_onLengthChange:function(){0===this.collection.length?this.nodes.$default.show():this.nodes.$default.hide()},_onSongMouseenter:function(e){var i=$(e.currentTarget);i.closest(".song").append($(util.buildTree(["div#song-add-menu",["div.service-btn.queue"+(t.user.registered?"":".disabled"),{data:{site:"queue"}}],["div.service-btn.amazon",{data:{site:"amazon"}}],["div.service-btn.spotify",{data:{site:"spotify"}}],["div.service-btn.itunes",{data:{site:"itunes"}}],["div.service-btn.soundcloud",{data:{site:"soundcloud"}}],["div.service-btn.lastfm",{data:{site:"lastfm"}}]])).on("click",".service-btn",this._onSongAddClick))},_onSongMouseleave:function(e){$(e.currentTarget).find("#song-add-menu").remove()},_onSongAddClick:function(e){var i=$(e.currentTarget),n=i.closest(".song").data("songData"),o=i.data("site");t.user.registered?t.room.addSong(o,n):t.room.openRegistration()},_onPreviewPlayClick:function(e){var t=$(e.currentTarget).closest(".song");o.samplePlay(t.data("songData")._id,this._previewCallback),t.addClass("currentPreview")},_previewCallback:function(e,t){"progress"==e?$(".currentPreview .progress").css({width:t}):"stop"==e&&($(".currentPreview .progress").css({width:"0%"}),$(".currentPreview").removeClass("currentPreview"))}},{_name:"SongList"})}),define("tip",["require","tt-base"],function(e){var t=e("tt-base"),i=t.View.extend({options:{text:null,duration:5},events:{click:"hideTip"},init:function(){this.$el.fadeIn(),setTimeout($.proxy(function(){var e=this.$el.find(".text");e.text(this.options.text),e.css("margin-top",(this.$el.height()-e.height())/2+"px")},this),0),this.options.duration&&(this.timer=setTimeout(_.bind(this.hideTip,this),1e3*this.options.duration))},el:function(){return["div.roomTip",["div.roomTipClose"],["div.text"]]},hideTip:function(){this.$el.fadeOut(),this.timer&&(clearTimeout(this.timer),this.timer=null)}});return i}),define("playlist",["require","plupload","util","action-modal","app","dmca","draggable","views/song-list","tip","player","tt-base","tt-common","lib/jquery.tipsy"],function(e){var t=e("plupload"),i=e("util"),n=e("action-modal"),o=e("app"),s=e("dmca"),r=e("draggable"),a=e("views/song-list"),l=e("tip"),u=e("player"),d=e("tt-base"),h=e("tt-common");e("lib/jquery.tipsy");var c,p={MAX_API_RETRIES:5,SEARCH_DELAY:500,defaultPlaylistName:"default",playlists:[],activePlaylist:null,fileids:[],songsByFid:{},searchResultsByFid:{},filteredSearchResults:{},currentSong:null,currentSongTimer:null,filesUploading:[],filesProcessing:{},filesProcessed:0,filesToProcess:0,searchBarValue:"",lastQuery:"",lastSearchTime:0,queueEditsLocked:!1,FILTER_REGEX:/^(artist|title|album):/i,playlistLoading:$.Deferred(),init:function(e){c=o.user,this.loadList=$.proxy(this.loadList,this),p.loadPlaylists().done(function(){p.loadList().done(function(){p.playlistLoading.resolve()})});var t=$(i.buildTree(this.layouts.playlistView)).appendTo("body"),n=i.buildTree([m,{$viewport:t.find("#songs"),titleText:"Results from your queue",backingMap:this.songsByFid,songConstructor:this.layouts.songView,highlightTopSong:!0,id:"queue"}],this);t.find("#queue").replaceWith(n),this.queue.hideTitle();var s=i.buildTree([f,{$viewport:t.find("#songs"),titleText:"Other results",alwaysShowTitle:!0,backingMap:this.searchResultsByFid,songConstructor:this.layouts.searchedSongView,idd:"searchResults",id:"search-results"}],this);t.find("#search-results").replaceWith(s),$(s).hide(),this.$playlistView=t,this.$songs=t.find("#songs"),this.$queue=t.find("#queue"),this.$queueMessage=t.find(".queue-message"),this.$emptyQueue=t.find("#empty-queue"),this.$searchResults=t.find("#search-results"),this.$searchLoading=t.find("#search-loading"),this.$searchEmpty=t.find("#search-empty"),this.$searchInput=t.find("#song-search-input"),this.$panes=t.find("#queue-view-panes"),this.$queueHeader=t.find("#queue-header"),i.makeSpinner(this.$searchLoading[0],{color:"#333",radius:5,length:5,width:2,lines:10,top:-5,left:11,shadow:!1}),this.songsByFid=$.extend(this.songsByFid,this.cache.toObject());var r=$.proxy(this.initPlaylistDropdown(),this);t.find("#playlist-display").click(r),this.$queueHeader.find(".done").on("click",function(){p.$queueHeader.addClass("normal").removeClass("edit"),p.queue.normalMode(),t.find("#playlist-dropdown").remove()}),this.$queueHeader.find(".remove").on("click",function(e){$(e.currentTarget).hasClass("disabled")||(i.buildTree(p.layouts.removeSongConfirmation("the selected songs",p.activePlaylist,function(){p.queue.removeSelectedSongs()}),p),p.modal.show())}),this.$queueHeader.find(".show-playlists").on("click",function(e){if(!$(e.currentTarget).hasClass("disabled")){var n=p.displayMenu.getMenu();if(n&&n.is("#batch-copy-dropdown"))return p.displayMenu.removeMenu(),void 0;var o=$(i.buildTree(p.layouts.batchCopyDropdown())),s=t.find("#queue-view"),r=$(e.currentTarget);s.append(p.displayMenu.create(o,r)),o.on("click",".playlist",function(e){var t=$(e.currentTarget).closest(".playlist");t.html("Adding..."),p.queue.addSelectedSongs(t.data("playlist")).done(function(){p.displayMenu.removeMenu(o)})})}}),this.$queueHeader.find(".show-playlists").tipsy({className:"batch-add",offset:-5,gravity:$.fn.tipsy.autoWE,fade:!0,opacity:1,title:function(){return 1==p.playlists.length?"Create a playlist to add songs":p.queue.selectedSongExists()?void 0:"Select songs below to add to your playlist"}}),t.find("#upload-button").on("click",function(){p.filterQueue(""),p.$panes.addClass("subsection-visible");var e=$("#pickfiles");$("#plUpload .plupload.html5").css({width:e.outerWidth(),height:e.outerHeight(!0)})}),t.find("#upload-pane .back").click($.proxy(function(){this.$panes.removeClass("subsection-visible")},this)),this.$searchResults.on("click",".addSong",$.proxy(this.addSearchResult,this)),this.$songs.on("SongList:previewCreated",$.proxy(function(){var e=this.currentPreviewid,t=this.queue.getNodeBySongid(e)||this.searchResults.getNodeBySongid(e);t&&(this.$currentPreview=t,this.currentPreviewIsFresh=!0)},this)),this.lastHoverSongid=null,this.createSongOverlayTimeout=null,this.$searchInput.on("keyup",function(e){var t=$(e.currentTarget),i=t.val(),n=p.$queueHeader.find(".filter");0===i.length?t.closest("#queue-view").removeClass("search-focused"):t.closest("#queue-view").addClass("search-focused");var o=n.hasClass("selected"),s=i.match(p.FILTER_REGEX);!o&&s?(n.filter(".by-"+s[1]).addClass("selected"),_gaq.push(["_trackEvent","song","filter","type:"+s[1]])):o&&!s&&(n.removeClass("selected"),_gaq.push(["_trackEvent","song","filter","type:all"]))}),this.$queueHeader.find(".filter").on("click",function(e){var t=p.$searchInput.val(),i=$(e.currentTarget),n=i.hasClass("selected"),o=t.length,s="";n?_gaq.push(["_trackEvent","song","filter","click:all"]):(s=i.data("filter"),_gaq.push(["_trackEvent","song","filter","click:"+s]),s+=":"),p.$queueHeader.find(".filter").removeClass("selected"),n||i.addClass("selected"),t=s+t.replace(p.FILTER_REGEX,""),p.$searchInput.val(t),o&&(p.filterQueue(t),p.initSongSearch(t))}),t.find("#upload-button").tipsy({gravity:"nw",fade:!0,opacity:1}),turntable.addEventListener("message",$.proxy(this.messageReceived,this)),i.nBAInQ(this),this.initSongSearch=$.proxy(this.initSongSearch,this),this.delayedSongSearch=i.delay(this,this.songSearch,this.SEARCH_DELAY),this.songSearch=$.proxy(this.songSearch,this),this.showSearchResults=$.proxy(this.showSearchResults,this),this.filterQueue=$.proxy(this.filterQueue,this),this.beginUpload=$.proxy(this.beginUpload,this),this.notifyCurrentSong=$.proxy(this.notifyCurrentSong,this),this.checkBlockMessageInView=i.rateLimit(this,this.checkBlockMessageInView,250),this.updateFileid=$.proxy(this.updateFileid,this),this.searchScrollHandler=i.delay(this,this.searchScrollHandler,250),this.clearSearchBar=$.proxy(this.clearSearchBar,this),this.initDragAndDrop(),e.replaceWith(t)},initBlockedSongsMessage:function(e){if(e){var t,i=this.$queueMessage,n=this.$playlistView;t=e>1?e+" songs were":e+" song was",i.find(".blockedSongs").text(t),i.show(),this.queueMessageInitialized=!0,n.on("scroll",this.checkBlockMessageInView),this.checkBlockMessageInView(),i.find(".hide").on("click",$.proxy(function(){i.hide(),this.queueMessageInitialized=!1},this))}},checkBlockMessageInView:function(){var e=this.$queueMessage,t=this.$playlistView,i=e.position().top+e.height(),n=t.height();n+5>i&&(this.markMessageSeen(this.MAX_API_RETRIES),t.off("scroll",this.checkBlockMessageInView))},markMessageSeen:function(e){h.apiGet({api:"playlist.mark_message_seen"}).done(function(t){t.success||e>0&&window.setTimeout(function(){p.markMessageSeen(e-1)},1e3)})},loadPlaylists:function(){return this.playlists=[],h.apiGet({api:"playlist.list_all"}).done($.proxy(function(e){for(var t=e.list,i=0;i<t.length;i++)this.playlists.push(t[i].name),t[i].active&&this.setActivePlaylist(t[i].name);this.activePlaylist||(this.playlists.push(this.defaultPlaylistName),this.setActivePlaylist(this.defaultPlaylistName))},this))},loadList:function(){function e(){for(var e=[],i=0;i<p.fileids.length;i++){var n=p.fileids[i];n in p.songsByFid&&e.push(n)}p.currentSong&&p.activePlaylist==p.currentSong.playlist&&-1!=e.indexOf(p.currentSong.fileId)?p.queue.setCurrentlyPlayingSongid(p.currentSong.fileId):p.queue.clearCurrentlyPlayingSongid(),p.fileids=e,p.queue.reset(e),p.filterQueue($("#song-search-input").val()),p.isFiltering||p.decorateQueueView(),t.resolve()}var t=$.Deferred();return this.fileids=[],this.loadListDone=!1,h.apiPost({api:"playlist.all",playlist_name:p.activePlaylist,minimal:!0}).done(function(t){p.loadListDone=!0;for(var i=[],n=0;n<t.list.length;n++){var o=t.list[n]._id;p.fileids.push(o),o in p.songsByFid||(i.push(o),p.songsByFid[o]={}),t.list[n].last_played&&(p.songsByFid[o].lastPlayed=t.list[n].last_played)}return i.length?(h.apiPost({api:"playlist.get_metadata",playlist_name:p.activePlaylist,files:i}).done(function(t){for(var i in t.files)if(t.files.hasOwnProperty(i)){var n=t.files[i];n.fileId=n._id,delete n._id,$.extend(p.songsByFid[i],n)}e(),p.cache.usable&&window.setTimeout(function(){var e=p.cache.loadObject(t.files);e||(e=p.resetCache(),e||p.cache.fromObject(t.files))},1e3)}),void 0):(e(),void 0)}).fail(function(e){$("#room-view").append(i.buildTree([l,{text:e.err}]));var t=[];p.fileids=t,p.queue.reset(t),p.filterQueue($("#song-search-input").val())}),h.apiGet({api:"playlist.new_blocked_song_count"}).done(function(e){e.count>0&&p.initBlockedSongsMessage(e.count)}),t.promise()},initPlaylistDropdown:function(){function e(e){e.removeClass("edit"),a=null}function t(t){a&&e(a),t.addClass("edit"),t.find("input[type=text]").val(t.data("playlist")).select(),a=t}function n(e){var t=e.find(".playlist-label"),n=e.find("input[type=text]").val();return t.html("Creating..."),p.createPlaylist(n).done(function(t){p.playlists.push(t.playlist_name),p.queue.queueButtonDecorator(),e.before(i.buildTree(p.layouts.playlistRow(t.playlist_name)))}).always(function(){t.html("New Playlist")})}function o(e){var t=e.find(".playlist-label"),i=e.find("input[type=text]").val(),n=e.data("playlist");return t.html("Renaming..."),p.renamePlaylist(n,i).done(function(i){p.playlists.splice(p.playlists.indexOf(n),1,i.playlist_name),p.activePlaylist==n&&p.setActivePlaylist(i.playlist_name),e.data("playlist",i.playlist_name),t.text(i.playlist_name)}).fail(function(){t.text(n)})}function s(e){var t=e.find(".playlist-label"),i=e.data("playlist");return t.html("Deleting..."),p.deletePlaylist(i).done(function(){i==p.activePlaylist&&p.loadPlaylists().done(p.loadList),p.playlists.splice(p.playlists.indexOf(i),1),p.queue.queueButtonDecorator(),e.remove()}).fail(function(){t.html(i)})}var r,a;return function(){if(r&&r===this.displayMenu.getMenu())return this.displayMenu.removeMenu(),void 0;var l=r=$(i.buildTree(this.layouts.playlistHeaderDropdown())),u=$("#playlist-display");a=null,$("#queue-view").append(this.displayMenu.create(l,u)),l.on("click",".playlist:not(.active, .edit)",function(e){var t=$(e.currentTarget),i=t.data("playlist");p.switchPlaylist(i).done(function(){p.setActivePlaylist(i,t),p.loadList().done(function(){p.isFiltering&&p.clearSearchBar(),p.displayMenu.removeMenu(l)})})}).on("click",".playlist .playlist-edit",function(e){var i=$(e.currentTarget).closest(".playlist");return t(i),!1}).on("click",".playlist-delete-playlist",function(t){var n=$(t.currentTarget).closest(".playlist"),o=n.data("playlist");return e(n),i.buildTree(p.layouts.removePlaylistConfirmation(o,function(){s(n)},function(){p.displayMenu.bindListeners(l),p.displayMenu.removeMenuWithDelay(l,750)}),p),p.displayMenu.unbindListeners(l),p.modal.show(),!1}).on("click",".cancel",function(t){var i=$(t.currentTarget).closest(".option");return e(i),!1}).on("submit",".playlist-input",function(t){var i=$(t.currentTarget).closest(".new-playlist, .playlist");i.hasClass("new-playlist")?(e(i),n(i)):(e(i),o(i)),t.preventDefault()}),l.find(".new-playlist").on("click",function(e){var i=$(e.currentTarget);i.hasClass("edit")||t(i)}),$("#trigger-batch").click(function(){$("#queue-header").removeClass("normal").addClass("edit"),p.isFiltering&&p.clearSearchBar(),p.queue.batchEditMode(),p.displayMenu.removeMenu(r)
})}},displayMenu:function(){function e(){r&&(r.trigger("menu.removed"),o(),r.remove(),this.$menu=r=null),t()}function t(){window.clearTimeout(s),s=null}function i(t,i){s||(i="number"==typeof i?i:500,s=window.setTimeout(e,i))}function n(){a.on("mouseover",t).on("mouseleave",i)}function o(){a.off("mouseover",t).off("mouseleave",i)}var s,r,a;return{getMenu:function(){return r},create:function(t,i){return e(),this.$menu=r=t,a=r.add(i),n(),r},bindListeners:function(e){e&&e!=r||n()},unbindListeners:function(e){e&&e!=r||o()},removeMenu:function(e){this.removeMenuWithDelay(e,0)},removeMenuWithDelay:function(e,t){e&&e!=r||a.trigger("mouseleave",t)}}}(),resetCache:function(){for(var e=this.fileids.length,t={},i=0;e>i;i++){var n=this.fileids[i];t[n]=this.songsByFid[n]}return this.cache.fromObject(t)},notifyCurrentSong:function(e,t){if(t!=o.user.id&&(e=null),null!=this.currentSong||null!=e){if(this.previewStop(),this.currentSongTimer&&(window.clearInterval(this.currentSongTimer),this.currentSongTimer=null),this.currentSong=e?{fileId:e._id,metadata:e.metadata,playlist:e.playlist}:null,this.currentSong){var i=Math.max(500,1e3*e.metadata.length/$("#playlist").width());this.currentSongTimer=setInterval(this.updateCurrentSongProgress,i)}this.loadList()}},updateCurrentSongProgress:function(){try{var e=turntable.sOxwLW.getCurrentSongProgress();p.queue.$el.find(".current-song .progress").css("width",100*e+"%")}catch(t){}},messageReceived:function(e){if("upload_complete"==e.command){if(this.filesProcessed+=1,this.updateProcessing(),this.filesProcessing[e.jobid].remove(),this.queue.contains(e.fid))return;this.addToCurrentPlaylist({fileId:e.fid,metadata:e.metadata})}else if("upload_failed"==e.command){var t=e.err||"Your upload failed. There may have been a problem with the file, or the song wasn't long enough.";$("#room-view").append(i.buildTree([l,{text:t}])),this.filesProcessing[e.jobid].remove(),this.filesToProcess>0&&(this.filesToProcess-=1,this.updateProcessing())}else("search_complete"==e.command||"search_failed"==e.command)&&this.showSearchResults(e)},updateFileid:function(e,t){this.currentPreviewid==e&&(this.currentPreviewid=t);var i=this.queue.options.songids,n=i.indexOf(e);-1!=n&&(i[n]=t);var o=this.queue.renderedItems,s=o[e];o[e]&&(o[t]=s,delete o[e]),i=this.queue.filteredSongids,n=i.indexOf(e),-1!=n&&(i[n]=t),o=this.queue.songsToShow,o[e]&&(o[t]=!0,delete o[e]),o=this.songsByFid,s=o[e],s&&(s.fileId=t,o[t]=s,o[e]=null),i=this.searchResults.options.songids,n=i.indexOf(e),-1!=n&&(i[n]=t),o=this.searchResults.songsToShow,o[e]&&(o[t]=!0,delete o[e]),o=this.searchResultsByFid,s=o[e],s&&(s.fileId=t,o[t]=s,o[e]=null),this.queue.reset(),this.searchResults.reset()},initDragAndDrop:function(){var e;$(document).bind("dragenter dragover",function(t){for(var i=t.originalEvent.dataTransfer.types.length,n=0;i>n;n++)if("Files"==t.originalEvent.dataTransfer.types[n]){$("#drop-zone").show(),window.clearTimeout(e);break}}).bind("dragleave dragexit",function(){e=window.setTimeout(function(){$("#drop-zone").hide()},100)}).bind("drop",function(){$("#drop-zone").attr("style","").hide()}).bind("mouseleave",function(){$("#drop-zone").attr("style","").hide()});var t;this.$playlistView.find("#drop-zone").bind("dragenter dragover",function(){$(this).css("background","#ccc"),window.clearTimeout(t)}).bind("dragleave",function(){t=window.setTimeout(function(){$("#drop-zone").css("background","")},100)})},initUploader:function(){LOG("Initializing plupload...");var e=turntable.uploader=new t.Uploader({runtimes:"html5,flash,silverlight",browse_button:"pickfiles",browse_button_hover:"hover",browse_button_active:"active",drop_element:"drop-zone",autostart:!0,max_file_size:"30mb",url:"/upload/"+turntable.currentSocketServer,flash_swf_url:"/static/swf/plupload.flash.swf",silverlight_xap_url:"/static/js/lib/plupload/plupload.silverlight.xap",filters:[{title:"Music files",extensions:"mp3"}],multipart_params:{type:"file"}});e.init(),e.bind("FilesAdded",p.beginUpload),e.bind("UploadProgress",function(e,t){$(".plFile-"+t.id+" .progress").css("width",t.percent+"%")}),e.bind("FileUploaded",function(e,t,i){LOG("file uploaded: "+i.response);var n=JSON.parse(i.response);if(p.endUpload(t,n.jobid),!n.success){var o="There was an error uploading "+n.filename+" \u2014 please check the song file.";p.messageReceived({command:"upload_failed",err:o,jobid:n.jobid})}})},beginUpload:function(e,t){ASSERT(t.length,"beginUpload called with 0 files... intentional?"),$("#drop-zone").attr("style","").hide(),this.$panes.removeClass("subsection-visible"),this.clearSearchBar(),p.filesToProcess+=t.length,p.updateProcessing();for(var n=$("#songs"),s=n.find(".uploads"),r=0,a=t.length;a>r;r++){var l=i.buildTree(p.layouts.uploadingView(t[r].name));$(l).addClass("plFile-"+t[r].id).appendTo(s)}n.scrollTop(p.queue.$el.height()),p.filesUploading=p.filesUploading.concat(t),turntable.uploader.settings.url="/upload/"+turntable.currentSocketServer,turntable.uploader.settings.multipart_params.userid=o.user.id,turntable.uploader.settings.multipart_params.userauth=o.user.auth,turntable.uploader.settings.multipart_params.port=String(turntable.socket.options.port),e.start()},endUpload:function(e,t){LOG(e.name+" finished uploading");var i=$.inArray(e,p.filesUploading);ASSERT(-1!=i,"Never began uploading "+e.name),p.filesUploading.splice(i,1);var n=e.id,o=$(".plFile-"+n);p.filesProcessing[t]=o,o.find(" .details").text("Processing..."),p.updateProcessing()},addSearchResult:function(e){if(!this.queueEditsLocked){var t=$(e.target).closest(".song").data("songData");this.addToCurrentPlaylist(t,0)}},switchPlaylist:function(e){return h.apiPost({api:"playlist.switch",playlist_name:e}).done(function(){p.queue.deselectAllSongs()}).fail(function(e){$("#room-view").append(i.buildTree([l,{text:e.err}]))})},createPlaylist:function(e){return e=i.safeText(e),h.apiPost({api:"playlist.create",playlist_name:e}).fail(function(e){$("#room-view").append(i.buildTree([l,{text:e.err}]))})},renamePlaylist:function(e,t){return t=i.safeText(t),h.apiPost({api:"playlist.rename",old_playlist_name:e,new_playlist_name:t}).fail(function(e){$("#room-view").append(i.buildTree([l,{text:e.err}]))})},deletePlaylist:function(e){return h.apiPost({api:"playlist.delete",playlist_name:e}).fail(function(e){$("#room-view").append(i.buildTree([l,{text:e.err}]))})},addToCurrentPlaylist:function(e,t){return this.addSong(e,void 0,t)},addSong:function(e,t,i){return this.addSongs([e],t,i)},addSongs:function(e,t,n){for(var o=this.queue,s=[],r=0;r<e.length;r++)s.push({fileid:e[r].fileId});return void 0===n&&(n=t==this.activePlaylist&&this.currentSong?o.options.songids.length-1:-1),void 0===t&&(t=this.activePlaylist),this.lockQueueEdits(),h.apiPost({api:"playlist.add",playlist_name:t,index:n,song_dict:s}).done(function(i){if(t!=p.activePlaylist)return p.unlockQueueEdits(),void 0;for(var o=0;o<e.length;o++){var s=e[o],r=e[o].fileId;if(p.songsByFid[r]=s,p.cache.usable)try{p.cache.setItem(r,s)}catch(a){}p.isFiltering&&(p.queue.songsToShow[r]=!0,delete p.searchResults.songsToShow[r]),i.song_dicts[o].mnid&&(p.updateFileid(i.song_dicts[o].mnid,i.song_dicts[o].fileid),r=i.song_dicts[o].fileid),p.queue.add(r,n)}p.isFiltering&&(p.searchResults.refilter(),p.savedScrollPosition=0),p.unlockQueueEdits()}).fail(function(e){$("#room-view").append(i.buildTree([l,{text:e.err}])),p.loadList(),p.unlockQueueEdits()})},removeSong:function(e,t){return this.removeSongs([t])},removeSongs:function(e){return this.lockQueueEdits(),h.apiPost({api:"playlist.remove",playlist_name:p.activePlaylist,index:e}).done(function(e){for(var t=0;t<e.song_dict.length;t++){var i=e.song_dict[t].fileid;p.searchResults.songsToShow&&(p.searchResults.songsToShow[i]=!0),delete p.songsByFid[i],p.currentPreviewid==i&&p.previewStop()}p.searchResults.songsToShow&&p.searchResults.refilter(),p.unlockQueueEdits()}).fail(function(e){$("#room-view").append(i.buildTree([l,{text:e.err}])),p.unlockQueueEdits()})},reorder:function(e,t){var i={api:"playlist.reorder",playlist_name:this.activePlaylist,index_from:e,index_to:t};return this.lockQueueEdits(),h.apiPost(i).done(function(){p.unlockQueueEdits()})},lockQueueEdits:function(){this.$songs.addClass("locked"),this.queueEditsLocked=!0,this.queue.locked=!0,this.searchResults.locked=!0,this.unlockTimer=window.setTimeout($.proxy(function(){this.unlockTimer=null,this.loadList(),this.unlockQueueEdits()},this),5e3)},unlockQueueEdits:function(){this.unlockTimer&&(window.clearTimeout(this.unlockTimer),this.unlockTImer=null),this.$songs.removeClass("locked"),this.queueEditsLocked=!1,this.queue.locked=!1,this.searchResults.locked=!1},searchKeyUp:function(e){var t=$(e.target),n=t.closest(".search"),o=n.find(".mag-glass"),s=t.val().trim(),r=!1;this.searchBarValue!=s&&(this.searchBarValue||(this.savedScrollPosition=this.$songs.scrollTop()),s?(o.addClass("clear-search"),this.isFiltering=!0):(o.removeClass("clear-search"),this.isFiltering=!1,r=!0),p.filterQueue(s),p.initSongSearch(s),this.decorateQueueView(),r&&i.notEmpty(this.savedScrollPosition)&&(this.$songs.scrollTop(this.savedScrollPosition),this.savedScrollPosition=null))},clearSearchButtonClicked:function(e){var t=$(e.target);t.hasClass("clear-search")&&(p.clearSearchBar(),p.$searchInput.blur())},clearSearchBar:function(){var e=$(".clear-search").removeClass("clear-search"),t=e.closest(".search"),n=t.find("input");n.val("").focus(),this.searchBarValue="",this.isFiltering=!1,$("#queue-view").removeClass("search-focused").find(".filter").removeClass("selected"),p.filterQueue(""),p.initSongSearch(""),i.notEmpty(this.savedScrollPosition)&&(this.$songs.scrollTop(this.savedScrollPosition),this.savedScrollPosition=null),this.decorateQueueView()},decorateQueueView:function(){var e=this.$emptyQueue||$("#empty-queue");if(this.loadListDone&&0==this.queue.options.songids.length&&!this.isFiltering?e.show():e.hide(),this.queueMessageInitialized){var t=this.$queueMessage||$(".queue-message");this.isFiltering?t.hide():t.show()}},parseFilter:function(e){for(var t=new RegExp(/\b(album|artist|duration|title):(.*?)(?=\balbum:|\bartist:|\bduration:|\btitle:|$)/),i={};;){var n=t.exec(e);if(null==n)break;i[n[1]]="duration"==n[1]?$.trim(n[2]):new RegExp($.trim(n[2]).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),e=e.replace(n[0],"")}return i.all=null!=e?e:"",i},filterQueue:function(e){if(e&&e.length>0){for(var t=this.parseFilter(e),i=t.all.split(/\s+/g),n=$.map(i,function(e){return new RegExp(e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i")}),o={},s=0,r=this.queue.options.songids,a=i.length,l=0,u=r.length;u>l;l++){for(var d=r[l],h=this.songsByFid[d].metadata,c=h.song,f=h.artist,m=h.album,g=h.length,v=!0,b=0;a>b;b++){var w=n[b];if(!w.test(c)&&!w.test(f)&&!w.test(m)){v=!1;break}}if(v&&t.hasOwnProperty("artist")&&(t.artist.test(f)||(v=!1)),v&&t.hasOwnProperty("title")&&(t.title.test(c)||(v=!1)),v&&t.hasOwnProperty("album")&&(t.album.test(m)||(v=!1)),v&&t.hasOwnProperty("duration")){var y=parseInt(t.duration.split(":")[0]);isNaN(y)||(60*y>g||g>60*(y+1))&&(v=!1)}v&&(o[d]=!0,s++)}this.queue.setFilter(o),this.queue.showTitle(),this.currentPreviewid&&!o[this.currentPreviewid]&&this.previewStop(),p.notifyGAOfFilter(e,s)}else this.queue.clearFilter(),this.queue.hideTitle(),this.currentPreviewid&&!this.queue.contains(this.currentPreviewid)&&this.previewStop()},notifyGAOfFilter:i.delay(null,function(e,t){_gaq.push(["_trackEvent","queue","filter",e,t])},1e3),initSongSearch:function(e){this.searchBarValue=e,this.searchFailed=!1,this.searchResults.reset([]),e.replace(p.FILTER_REGEX,"").length>2?(this.$searchResults.show(),this.$searchLoading.show()):(this.$searchResults.hide(),this.$searchLoading.hide()),this.delayedSongSearch(e),this.$searchEmpty.hide(),this.lastQuery="",this.$songs.off("scroll",this.searchScrollHandler)},songSearch:function(e){if(!(e.replace(p.FILTER_REGEX,"").length<=2)){var t=1;if(e==this.lastQuery){if(this.searchFailed)return;t=this.latestResultsPage+1;var i=Date.now();if(t===this.lastPageRequested&&i-this.lastSearchTime<this.SEARCH_DELAY)return}else _gaq.push(["_trackEvent","song","search",e]),this.searchFailed=!1,this.latestResultsPage=0;this.lastSearchTime=Date.now(),this.lastPageRequested=t,turntable.ZxcLsz({api:"file.search",query:e,page:t}),1==t&&this.$searchResults.show(),this.$searchLoading.show(),this.lastQuery=e}},showSearchResults:function(e){if(!("search_complete"!=e.command&&"search_failed"!=e.command||e.query!=this.searchBarValue||p.latestResultsPage&&e.page!=p.latestResultsPage+1)){this.$searchLoading.hide();var t;if(e.success?0==e.docs.length&&(t="Sorry, no results could be found."):t=e.err?"Error: "+e.err:"Sorry, the search failed. Please try again later.",t)return this.$searchEmpty.text(t).show(),this.searchFailed=!0,void 0;if(this.$searchEmpty.hide(),1==e.page){this.filteredSearchResults={};for(var i in this.searchResultsByFid)this.searchResultsByFid.hasOwnProperty(i)&&delete this.searchResultsByFid[i]}var n=e.docs,o=[],s=this.filteredSearchResults,r=this.searchResultsByFid;this.queue.options.songids;for(var a=0,l=n.length;l>a;a++){var u=n[a],d=u._id,h={fileId:d,metadata:u.metadata};r[d]||(r[d]=h,o[a]=d,this.queue.contains(d)||(s[d]=!0))}if(1==e.page)this.searchResults.reset(o),this.$songs.on("scroll",this.searchScrollHandler);else{var c=this.searchResults.options.songids;this.searchResults.reset(c.concat(o))}p.searchResults.setFilter(s),this.latestResultsPage=e.page,this.searchScrollHandler()}},searchScrollHandler:function(){this.$searchResults.offset().top+this.$searchResults.height()-(this.$songs.offset().top+this.$songs.height())<50&&this.songSearch(this.lastQuery)},buySong:function(){var e=$(this).closest(".song").data("songData").fileId;if(e){var t="itunes";window.open("/link/?fileid="+e+"&site="+t,t+e)}},soundCloudLink:function(){var e=$(this).closest(".song").data("songData").fileId;if(e){var t="soundcloud";window.open("/link/?fileid="+e+"&site="+t,t+e)}},previewPlay:function(){var e=$(this).closest(".song"),t=e.data("songData").fileId;u.samplePlay(t,p.previewCallback),e.addClass("currentPreview").find(".progress").css("width","0%"),p.currentPreviewid=t,p.$currentPreview=e},previewCallback:function(e,t){if("progress"==e){var i=p.$currentPreview;i&&(p.currentPreviewIsFresh&&(i.addClass("currentPreview"),p.currentPreviewIsFresh=!1),i.find(".progress").css("width",t))}else"stop"==e&&($("#playlist .song.currentPreview").removeClass("currentPreview").find(".progress").css("width","0%"),p.currentPreviewid=null,p.$currentPreview=null)},previewStop:u.sampleStop,updateProcessing:function(){var e=this.$playlistView.find(".processing");this.filesProcessed>=this.filesToProcess&&(this.filesProcessed=this.filesToProcess=0),this.filesToProcess>0?(e.find(".text").html("Uploads &mdash; Processed "+this.filesProcessed+" of "+this.filesToProcess+" files"),e.show()):e.hide()},setPlaylistHeight:function(e){return null===e||void 0===e?e=351:25>e&&(e=25),this.$playlistView.css({height:e}),e},setActivePlaylist:function(e,t){var i=this.activePlaylist=e;this.playlistLoading.done(function(){$("#playlist-display").find(".text").text(e);var n=$("#playlist-dropdown");n.length&&($("#playlist-dropdown .playlist").removeClass("active"),t?t.addClass("active"):n.find(".playlist").each(function(e,t){$.data(t,"playlist")==i&&(t.className+=" active")}))})}};p.layouts={playlistView:["div#playlist##root",{},["div#queue-view-panes",{},["div#queue-view.main-pane",{},["div#playlist-header.floating-panel-header",["div#playlist-display.panel-button",["div.pushdown-content",["div.playlist-queue-inset"],["div.text"],["div.down-arrow"]]]],["div#queue-header.floating-panel-header.normal",["div#normal-mode",["div#upload-button.down",{title:"Upload music"},["button","Upload music"]],["div.divider"],["form.search.song-search",{event:{submit:function(){return!1}}},["input#song-search-input",{type:"text",placeholder:"search for songs",event:{keyup:$.proxy(p.searchKeyUp,p)}}],["div.mag-glass",{event:{click:p.clearSearchButtonClicked}}]],["div.btn-group",["button.btn.panel-button.filter.by-artist",{data:{filter:"artist"}},"Artist"],["button.btn.panel-button.filter.by-title",{data:{filter:"title"}},"Title"],["button.btn.panel-button.filter.by-album",{data:{filter:"album"}},"Album"]]],["div#batch-edit-mode",["div.show-playlists.disabled.panel-button",["div.pushdown-content",["div.playlist-queue-plus-inset"],["div.text","Add to Playlist"],["div.down-arrow"]]],["div.remove.disabled.panel-button",["div.pushdown-content",["div.playlist-trash"]]],["button.done.primary.small.inset.tt-button","Done"]]],["div#songs-wrapper",["div#songs",{},["div#queue"],["div.uploads",{},["div.processing.separator",{style:{display:"none"}},["div.text"]]],["div.queue-message",{style:{display:"none"}},["div.hide"],"Sorry! ",["span.blockedSongs"]," pulled from your queue. ",["a",{href:"/removed_songs",target:"_blank"},"Learn more"],"."],["div#empty-queue.default-message",{style:{display:"none"}},["p","No songs in your queue. Start searching for songs to add!"]],["div#search-results"],["div#search-loading",{style:{display:"none"}},["div.text","Searching turntable"]],["div#search-empty",{style:{display:"none"}}]]]],["div#upload-pane.main-pane",["div.floating-panel-header",{},["button.back","Back"],["span.title","Upload Music"]],["div#upload-view",["div.info","To get your tracks into Turntable, upload them to SoundCloud and then search for them here. This will allow anyone to find and play your music."]]]],["div#drop-zone",{},["div#drop-zone-text.centered-pane",{},["img",{src:IMG_PATH+"playlist/drag-icon-big.png"}],["div#drop-zone-main-text","Drop songs here"],["div#drop-zone-small-text","to upload them to your queue"]]]],songView:function(e,t,n){var o=e.metadata,r=[],a=o.artist+" \u2022 "+i.prettyTime(o.length);return s.showPreview(e)||r.push(".noPreview"),void 0!==n&&0===n%2&&r.push(".nth-child-even"),source="sc"==e.source||e.fileId.match(/^sc_/i)||o.original_title?".soundcloud":"",["li.song"+r.join(""),{data:{songData:e},style:void 0!==t?{top:t}:{}},["div.progress-bar",["div.progress"]],["div.vinyl"],["div.thumb",{style:{"background-image":o.coverart?"url("+o.coverart+")":""}}],["div.source"+source],["div.playSample"],["div.pauseSample"],["div.title",{title:o.song},o.song],["div.details",["span",{title:a},o.artist,["span.divider"," \u2022 "],i.prettyTime(o.length)],["span.played-frequency"]],["div.playlist-go-top"],["div.playlist-open-options"],["div.playlist-checkbox"]]},searchedSongView:function(e,t,n){var o=e.metadata,r=[],a=o.artist+" \u2022 "+i.prettyTime(o.length);return s.showPreview(e)||r.push(".noPreview"),0===n%2&&r.push(".nth-child-even"),source=e.fileId.match(/^sc_/i)?".soundcloud":"",["div.song"+r.join(""),{data:{songData:e},style:void 0!==t?{top:t}:{}},["div.progress-bar",["div.progress"]],["div.thumb",{style:{"background-image":o.coverart?"url("+o.coverart+")":""}}],["div.source"+source],["div.playSample"],["div.pauseSample"],["div.title",{title:o.song},o.song],["div.details",{title:a},["span",o.artist,["span.didver"," \u2022 "],i.prettyTime(o.length)]],["div.addSong"]]},uploadingView:function(e){return["div.song.uploading",{},["div.thumb"],["div.progress-bar",["div.progress"]],["div.title",{},e],["div.details",{},"Uploading..."]]},batchCopyDropdown:function(){for(var e=["ul#batch-copy-dropdown.floating-menu"],t=["div.content-scroller"],i=p.playlists,n=0;n<i.length;n++){var o=i[n],s=["li.option.playlist",{data:{playlist:o}},["div.playlist-queue"],["span.playlist-label",o]];p.activePlaylist!=o&&t.push(s)}return e.push(t),e},playlistRow:function(e){var t=["li.option.playlist",{data:{playlist:e}},["div.playlist-queue"],["span.playlist-label",e]];return e!=p.defaultPlaylistName&&t.push(["div.playlist-edit"],["div.playlist-delete-playlist"],["form.playlist-input",["input",{type:"text"}]],["div.cancel","cancel"]),e==p.activePlaylist&&(t[0]+=".active"),t},playlistHeaderDropdown:function(){for(var e=["ul.floating-menu#playlist-dropdown"],t=["div.content-scroller"],i=p.playlists,n=0;n<i.length;n++){var o=i[n];t.push(p.layouts.playlistRow(o))}return t.push(["li.option.new-playlist",["div.playlist-queue-plus"],["span.playlist-label","New Playlist"],["form.playlist-input",["input",{type:"text"}]],["div.cancel","cancel"]],["li.option#trigger-batch",["span.text","Organize Songs"]]),e.push(t),e},songOptionsMenu:function(e){var t=p.layouts;return["ul.floating-menu.song-options",{data:{songid:e}},["div.outer-arrow"],["div.inner-arrow"],["div.menu-wrapper",["div#song-option-panes",["div#song-option-first-pane",t.firstMenu()],["div#song-option-second-pane",t.secondMenu()]]]]},firstMenu:function(){return[["li.option.switch-menu"+(p.playlists.length>1?"":".disabled"),["div.queue-plus-icon"],["div.playlist-right-arrow"],["div.text","Add to playlist"]],["li.option.playlist-remove",["div.playlist-trash"],["div.text","Remove from playlist"]],["li.option.move-bottom",["div.playlist-move-bottom"],["div.text","Move to bottom"]],["li.option.site-add",["div.service-btn.amazon",{data:{site:"amazon"}}],["div.service-btn.spotify",{data:{site:"spotify"}}],["div.service-btn.itunes",{data:{site:"itunes"}}],["div.service-btn.soundcloud",{data:{site:"soundcloud"}}],["div.service-btn.lastfm",{data:{site:"lastfm"}}]]]},secondMenu:function(){var e=p.playlists,t=[],i=["div.content-scroller"];t.push(["li.option.switch-menu.second",["div.queue-plus"],["div.left-arrow"],["div.text","Add to playlist"]]);for(var n=0;n<e.length;n++){var o=e[n];p.activePlaylist!=o&&i.push(["li.option.playlist-add",{data:{playlist:o}},["div.playlist-queue"],["div.text",o]])}return t.push(i),t},removeSongConfirmation:function(e,t,i){return[n,{submitText:"Delete",submitCallback:i},["div.removeConfirmation","Are you sure you want to remove "+e+" from playlist '"+t+"'?"]]},removePlaylistConfirmation:function(e,t,i){return[n,{submitText:"Delete",submitCallback:t,closeCallback:i},["div.removeConfirmation","Are you sure you want to delete playlist '"+e+"'?"]]}},p.cache=function(){var e={prefix:"_pl_"};return{usable:!!window.localStorage,getItem:function(t){return JSON.parse(localStorage.getItem(e.prefix+t))},removeItem:function(t){localStorage.removeItem(e.prefix+t)},setItem:function(t,i){var n=JSON.stringify(i);try{localStorage.setItem(e.prefix+t,n)}catch(o){return LOG("cache size limit reached"),!1}return!0},toObject:function(){var t={};for(var i in localStorage)0===i.lastIndexOf(e.prefix,0)&&(i=i.slice(e.prefix.length),t[i]=this.getItem(i));return t},loadObject:function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=this.setItem(t,e[t]);if(!i)return!1}return!0},fromObject:function(t){for(var i in localStorage)0===i.lastIndexOf(e.prefix,0)&&localStorage.removeItem(i);return this.loadObject(t)}}}();var f=d.View.extend({options:{idd:"songList",songids:[],$viewport:null,itemHeight:50,maxItemsInDOM:150,titleText:null,backingMap:{},songConstructor:null,highlightTopSong:!1,alwaysShowTitle:!1},el:["div.song-list",["ul.songs"]],methodsToBind:[/notifyPreview/],init:function(){this.itemPaddingSize=Math.floor(this.options.maxItemsInDOM/2),this.itemPaddingHeight=this.itemPaddingSize*this.options.itemHeight,this.$viewport=this.options.$viewport,this.redraw=$.proxy(this.redraw,this),this.viewportScroll=$.proxy(this.viewportScroll,this),this.currentlyPlayingSongPassedFilter=!0,this.$songs=this.$el.find(".songs"),this.options.titleText&&(this.$title=$(i.buildTree(["div.separator",["div.text",this.options.titleText]])),this.$el.prepend(this.$title),this.titleVisible=!0),this.renderedItems={},this.reset(),this.$viewport.on("scroll",i.rateLimit(this,this.scroll,250)),this.$songs.on("click",".playSample",p.previewPlay).on("click",".pauseSample",p.previewStop).on("click",".buy",p.buySong).on("click",".soundcloud",p.soundCloudLink)},scroll:function(){var e=this.$viewport.scrollTop();Math.abs(e-this.lastRedrawScrollTop)>this.itemPaddingHeight-2*this.$viewport.height()?(this.redrawTimeout&&window.clearTimeout(this.redrawTimeout),this.redrawTimeout=null,this.redraw(e)):(this.redrawTimeout&&window.clearTimeout(this.redrawTimeout),this.redrawTimeout=window.setTimeout(this.redraw,1e3))},redraw:function(e){var t,n=this.$viewport.scrollTop(),o=this.$viewport.height(),s=n-this.$songs[0].offsetTop+o/2,r=Math.floor(s/this.options.itemHeight),a=this.options.itemHeight,l=this.filteredSongids||this.options.songids,u=l.length,d=0,h=this.options.highlightTopSong,c=this.currentlyPlayingSongid||this.options.songids[0],f={},m=!1,g=p.currentPreviewid,v=[];this.currentlyPlayingSongid&&this.currentlyPlayingSongid!=this.options.songids[0]&&this.currentlyPlayingSongPassedFilter&&(d=1),t=r<this.itemPaddingSize?0:r>u-this.itemPaddingSize?Math.max(0,u-this.options.maxItemsInDOM):r-this.itemPaddingSize;for(var b=Math.min(u,t+this.options.maxItemsInDOM),w=t;b>w;w++)void 0!=f[l[w]]&&(m=!0),f[l[w]]=w;this.currentlyPlayingSongid&&this.currentlyPlayingSongid!=this.options.songids[0]&&this.currentlyPlayingSongPassedFilter&&0===t&&(f[this.currentlyPlayingSongid]=0);for(var y in this.renderedItems)if(this.renderedItems.hasOwnProperty(y)){var _,x,S,k,C,T=this.renderedItems[y];if(this.currentlyPlayingSongid==y&&this.currentlyPlayingSongPassedFilter&&0===t)e&&(_=0,S=0,x=T.index,k=T.visibleIndex,C=T.$el.addClass("current-song"),T.currentSong=!0,C.trigger("song.currentSet",!0));else{if(void 0===f[y]||this.currentlyPlayingSongid==y){g&&g==y&&(window.setTimeout(this.notifyPreviewRemoved,0),g=null),T.$el.remove(),v.push(y),delete this.renderedItems[y];continue}e&&(_=f[y],S=_+d,x=T.index,k=T.visibleIndex,C=T.$el,T.currentSong&&(C.removeClass("current-song"),T.currentSong=!1,C.trigger("song.currentSet",!1)))}if(delete f[y],e){if(_!=x&&C.data("index",_),S!=k){var I=S*a;C.css("top",I),0===S%2?C.addClass("nth-child-even"):C.removeClass("nth-child-even"),T.index=_,T.visibleIndex=S}if(h){var M=c==y;0!==k||M?0===S&&M&&C.addClass("topSong"):C.removeClass("topSong")}}}var P=document.createDocumentFragment(),A=this.options.songConstructor,E=this.options.backingMap;for(y in f)if(f.hasOwnProperty(y)){var D=E[y];if(!D){m=!0;continue}var _=f[y],S=_;if(y!=this.currentlyPlayingSongid)S+=d;else if(0!==_)continue;var I=S*a,R=i.buildTree(A(D,I,S)),C=$(R),T={$el:C,index:_,visibleIndex:S};h&&c==y&&(R.className+=" topSong"),this.currentlyPlayingSongid==y&&(R.className+=" current-song",T.currentSong=!0),$.data(R,"index",_),this.renderedItems[y]=T,P.appendChild(R),g&&g==y&&(window.setTimeout(this.notifyPreviewCreated,0),g=null)}return this.$songs.append(P),$("#songs").trigger("renderedItem.removed",{songids:v}),!this.options.alwaysShowTitle&&this.$title&&(this.titleVisible||!u||this.hidingTitle?!this.titleVisible||u&&!this.hidingTitle||(this.$title.hide(),this.titleVisible=!1):(this.$title.show(),this.titleVisible=!0)),this.lastRedrawScrollTop=n,!m},reset:function(e){e&&(this.options.songids=e,this.filterSongs());var t=(this.filteredSongids||this.options.songids).length,i=t*this.options.itemHeight;this.$songs.css("height",i),this.redraw(!0)},add:function(e,t){0>t&&(t=this.options.songids.length);var i=this.options.songids.indexOf(e);-1!==i&&this.options.songids.splice(i,1),this.options.songids.splice(t,0,e),this.refilter()},setFilter:function(e){this.songsToShow=e,this.$el.addClass("filtered"),this.refilter()},refilter:function(){this.filterSongs(),this.reset()},clearFilter:function(){this.songsToShow=void 0,this.filteredSongids=void 0,this.currentlyPlayingSongPassedFilter=!0,this.$el.removeClass("filtered"),this.reset()},filterSongs:function(){if(!this.songsToShow)return this.filteredSongids=void 0,this.currentlyPlayingSongPassedFilter=!0,void 0;for(var e=this.options.songids,t=[],i=0,n=0,o=e.length;o>n;n++){var s=e[n];this.songsToShow[s]===!0&&(t[i++]=s)}this.currentlyPlayingSongPassedFilter=this.songsToShow[this.currentlyPlayingSongid],this.filteredSongids=t},hideTitle:function(){this.hidingTitle=!0,this.redraw()},showTitle:function(){this.hidingTitle=!1,this.redraw()},getNodeBySongid:function(e){return this.renderedItems[e]?this.renderedItems[e].$el:void 0},contains:function(e){return-1!==this.options.songids.indexOf(e)},notifyPreviewCreated:function(){this.$el.trigger("SongList:previewCreated")},notifyPreviewRemoved:function(){this.$el.trigger("SongList:previewRemoved")}}),m=f.extend({options:{idd:"queue"},methodsToBind:["batchSongMouseDown",/songMouse/],init:function(){this._super.apply(this,arguments),this.moveClone=i.makeDrawer(this,this.moveClone),this.throttledReorderIfRequired=i.rateLimit(this,this.reorderIfRequired,150),this.selectedSongs={},this.stateEnum={NORMAL:0,BATCHEDIT:1},this.mode=this.stateEnum.NORMAL,$("#songs").on("renderedItem.removed",$.proxy(this.onSongRemoval,this)),this.$currentSong=this.$(".current-song");var e=this.songDrag=new r;$.extend(e,{mousedown:this.songMouseDown,mousemove:this.songMouseMove,mouseup:this.songMouseUp,cursor:"move",scroller:this.$viewport[0]}),this.$songs.on("mousedown",".song",e.setup).on("click",".playlist-go-top",$.proxy(function(e){if(!this.locked){var t=$(e.target).closest(".song"),i=t.data("songData").fileId,n=this.options.songids.indexOf(i);p.reorder(n,0).done($.proxy(function(){this.reorderBySongid(i,0),p.isFiltering&&(p.savedScrollPosition=0)},this))}},this)).on("click",".playlist-open-options",$.proxy(this.initOpenOptions(),this))},moveBottom:function(e){if(!this.locked){var t=e.data("songData").fileId,i=this.options.songids.indexOf(t),n=this.options.songids.length;p.reorder(i,n-1).done($.proxy(function(){this.reorderBySongid(t,n-1)},this))}},initOpenOptions:function(){function e(){return r.hasClass("subsection-visible")?$("#song-option-second-pane"):$("#song-option-first-pane")}function t(t,i){var n=$("#songs"),o=e(),s=parseInt(i.css("top")),r=n.height(),a=l.renderedItems[t],u=l.options.itemHeight*a.visibleIndex-$("#songs").scrollTop(),d=s+10+o.height();return r-u-d}function n(e,i){var n=parseInt(i.css("top")),o=t(e,i);if(0>o){var s=i.find(".outer-arrow"),r=i.find(".inner-arrow");i.css("top",n+o+"px"),s.css("top",parseInt(s.css("top"))-o+"px"),r.css("top",parseInt(r.css("top"))-o+"px")}}function o(i,n){var o=t(i,n),s=e(),a=r.find(".content-scroller"),l=a.height();newPaneHeight=s.height(),detachedMenuThreshold=9,r.hasClass("subsection-visible")&&(0>o||parseInt(n.css("top"))+l<detachedMenuThreshold)?(a.height(a.height()+o),newPaneHeight+=o):a.height(""),n.height(newPaneHeight)}var s,r,l=this;return function(e){var t=$(e.target).closest(".song"),u=t.data("songData").fileId;if(s&&s.data("songid")==u)return p.displayMenu.removeMenu(),void 0;var d=s=$(i.buildTree(p.layouts.songOptionsMenu(u)));t.append(p.displayMenu.create(d,t)),r=$("#song-option-panes"),d.find(".switch-menu.disabled").tipsy({offset:-6,gravity:$.fn.tipsy.autoWE,fade:!0,opacity:1,title:function(){return"Create a playlist to add songs"}});var h=this.options.songids.length;this.options.songids[h-1]==u&&d.find(".move-bottom").hide(),n(u,d),o(u,d),t.on("song.currentSet",function(){o(u,d)}).one("menu.removed",function(){t.off("song.currentSet")}),d.on("click",".playlist-add",function(e){var i=$(e.currentTarget),n=t.data("songData"),o=i.data("playlist");i.html("Adding..."),p.addSong(n,o).done(function(){p.displayMenu.removeMenu(d)})}),d.find(".site-add").on("click",".service-btn",a.prototype._onSongAddClick),d.find(".switch-menu:not(.disabled)").on("click",function(){r.toggleClass("subsection-visible"),o(u,d)}),d.find(".playlist-remove").on("click",function(){if(!t.hasClass("current-song")){var e=t.data("songData"),n=e.fileId,o=l.options.songids.indexOf(n);i.buildTree(p.layouts.removeSongConfirmation(e.metadata.song,p.activePlaylist,function(){p.removeSong(n,o).done(function(){l.removeIndex(o),p.displayMenu.removeMenu(d)})}),l),l.modal.show()}}),d.find(".move-bottom").on("click",function(){t.hasClass("current-song")||(p.queue.moveBottom(t),p.displayMenu.removeMenu(d))})}},redraw:function(e){var t=this._super(e);t||(LOG("draw failed! reloading playlist"),p.loadList())},reset:function(e){this._super(e),p.decorateQueueView()},append:function(e){this.add(e,this.options.songids.length)},reorder:function(e,t){var i=this.options.songids.splice(e,1)[0];
this.options.songids.splice(t,0,i),this.refilter()},reorderBySongid:function(e,t){var i=this.options.songids,n=i.indexOf(e);-1!==n&&this.reorder(n,t)},removeIndex:function(e){this.removeIndices([e])},removeIndices:function(e){e=e.sort(function(e,t){return t-e});for(var t=0;t<e.length;t++)this.options.songids.splice(e[t],1);this.refilter()},removeBySongid:function(e){var t=this.options.songids,i=t.indexOf(e);-1!==i&&this.removeIndex(i)},updateSongFrequency:function(e){var t=p.songsByFid[e].lastPlayed,n=this.renderedItems[e];t&&n&&n.$el.find(".played-frequency").html(i.buildTree([["span.divider"," \u2022 "],"\u266a"])).tipsy({opacity:1,title:function(){return"Played here "+i.prettyTimeDelta(t)}})},deselectAllSongs:function(){if(this.mode==this.stateEnum.BATCHEDIT){for(var e in this.selectedSongs)this.selectedSongs[e]instanceof jQuery&&this.selectedSongs[e].removeClass("selected");this.selectedSongs={},this.queueButtonDecorator()}},removeSelectedSongs:function(){if(this.mode==this.stateEnum.BATCHEDIT){var e=[],t=[];for(var i in this.selectedSongs)this.selectedSongs[i]&&this.currentlyPlayingSongid!=i&&(e.push(this.options.songids.indexOf(i)),t.push(i));e.length&&p.removeSongs(e).done($.proxy(function(){this.removeIndices(e);for(var i=0;i<t.length;i++){var n=t[i];this.selectedSongs[n]=null}this.queueButtonDecorator()},this))}},addSelectedSongs:function(e){if(this.mode==this.stateEnum.BATCHEDIT){var t=[];for(var i in this.selectedSongs)this.selectedSongs[i]&&t.push(this.options.backingMap[i]);return p.addSongs(t,e)}},queueButtonDecorator:function(){var e=$("#queue-header .remove"),t=$("#queue-header .show-playlists");this.selectedSongExists(!0)?e.removeClass("disabled"):e.addClass("disabled"),this.selectedSongExists()&&p.playlists.length>1?(t.removeClass("disabled"),t.data("tipsy").disable()):(t.addClass("disabled"),t.data("tipsy").enable())},selectedSongExists:function(e){for(var t in this.selectedSongs)if(this.selectedSongs[t]&&(!e||t!=this.currentlyPlayingSongid))return!0;return!1},songMouseDown:function(e){var t=$(e.currentTarget),i=t.data("songData").fileId;return this.setupDragCompleted=!1,this.songsToShow||i==this.currentlyPlayingSongid||this.mode==this.stateEnum.BATCHEDIT||this.locked?(this.songDrag.cancelDrag(),void 0):(this.$viewport.on("scroll",this.viewportScroll),this.$songBeingDragged=t,this.mouseOffsetFromSong=e.pageY-t.offset().top,e.preventDefault(),void 0)},songMouseMove:function(e){if(!this.setupDragCompleted){var t=this.$songBeingDragged,i=t.clone().addClass("clone").appendTo(this.$viewport.parent());this.$clone=i.width(t.width()),t.css("opacity",0),this.originalIndex=t.data("index"),this.currentIndex=this.originalIndex,this.viewportScrollTop=this.$viewport.scrollTop(),this.viewportOffset=this.$viewport.offset().top,this.viewportHeight=this.$viewport.height(),this.listOffsetFromViewport=this.$songs[0].offsetTop,this.draggedSongid=t.data("songData").fileId,this.setupDragCompleted=!0,this.minSongVisibleHeight=i.height()/2}var n=this.viewportOffset,o=40,s=n+this.viewportHeight;if(e){var r=this.mouseOffsetY=e.pageY||this.mouseOffsetY;this.scrollVelocity=n>r?o*(r-n):r>s?o*(r-s):0}var a=this.mouseOffsetY-this.mouseOffsetFromSong-this.viewportOffset;this.cloneOffsetTop=Math.min(Math.max(-this.minSongVisibleHeight,a),this.viewportHeight-this.minSongVisibleHeight),this.moveClone(),this.throttledReorderIfRequired(),e&&e.preventDefault()},songMouseUp:function(){if(this.$viewport.off("scroll",this.viewportScroll),this.setupDragCompleted){this.reorderIfRequired(),this.throttledReorderIfRequired.cancel(),this.moveClone.cancel();var e=this.originalIndex,t=this.currentIndex,i=this.$songBeingDragged,n=this.$clone,o=i.data("songData").fileId,s=this,r=0;this.currentlyPlayingSongid&&this.currentlyPlayingSongid!=this.options.songids[0]&&this.currentlyPlayingSongPassedFilter&&(r=1),n.animate({top:(this.currentIndex+r)*this.options.itemHeight-this.$viewport.scrollTop()},300,function(){i.css({opacity:""}),n.remove(),p.reorder(e,t).fail(function(){s.reorderBySongid.call(s,o,e),alert("sorry move failed")})}),this.$clone=null}},cancelSongDrag:function(){this.$viewport.off("scroll",this.viewportScroll),this.songDrag.cancelDrag();var e=this.$clone,t=this.$songBeingDragged,i=this;e.animate({top:0},300,function(){t.css({opacity:""}),e.remove(),i.reset()}),this.$clone=null},batchSongMouseDown:function(e){var t=$(e.currentTarget),i=t.data("songData").fileId;if(!$(e.target).is(".playSample, .pauseSample")){if(e.shiftKey){var n=this.lastSelectedSongId||this.options.songids[0],o=this.options.songids.indexOf(n),s=this.options.songids.indexOf(i);if(o>s){var r=o;o=s,s=r}for(var a=o;s>=a;a++){var l=this.options.songids[a],u=this.getNodeBySongid(l);u?(u.addClass("selected"),this.selectedSongs[l]=u):this.selectedSongs[l]=!0}}else t.toggleClass("selected"),this.selectedSongs[i]=this.selectedSongs[i]?null:t;this.lastSelectedSongId=i,this.queueButtonDecorator()}},viewportScroll:function(){this.viewportScrollTop=this.$viewport.scrollTop(),this.songMouseMove()},reorderIfRequired:function(){this.draggedSongid==this.currentlyPlayingSongid&&this.cancelSongDrag();var e=0;this.currentlyPlayingSongid&&this.currentlyPlayingSongid!=this.options.songids[0]&&this.currentlyPlayingSongPassedFilter&&(e=1);var t=Math.round((this.cloneOffsetTop+this.viewportScrollTop)/this.options.itemHeight-e);t=Math.min(Math.max(t,0),this.options.songids.length-1-e),t!=this.currentIndex&&(0===t+e?this.$clone.addClass("topSong"):0===this.currentIndex&&this.$clone.removeClass("topSong"),this.reorder(this.currentIndex,t),this.currentIndex=t)},moveClone:function(){var e=Date.now();if(this.lastMoveTime){var t=(e-this.lastMoveTime)/1e3,i=this.scrollVelocity*t;this.$viewport.scrollTop(this.viewportScrollTop+i)}this.lastMoveTime=e,this.$clone.css({top:this.cloneOffsetTop})},batchEditMode:function(){if(this.mode!=this.stateEnum.BATCHEDIT){this.mode=this.stateEnum.BATCHEDIT;var e=p.$queue;e.off(i.transitionEnd),e.addClass("batch"),setTimeout(function(){e.addClass("slide")}),this.$songs.off("mousedown",".song",this.songDrag.setup).on("click",".song",this.batchSongMouseDown)}},normalMode:function(){if(this.mode!=this.stateEnum.NORMAL){this.deselectAllSongs(),this.mode=this.stateEnum.NORMAL;var e=p.$queue;e.removeClass("slide"),e.one(i.transitionEnd,function(){e.removeClass("batch")}),this.$songs.off("click",".song",this.batchSongMouseDown).on("mousedown",".song",this.songDrag.setup)}},onSongRemoval:function(e,t){if(this.mode==this.stateEnum.BATCHEDIT)for(var i=t.songids,n=0;n<i.length;n++){var o=i[n];this.selectedSongs[o]&&(this.selectedSongs[o]=!0)}},setCurrentlyPlayingSongid:function(e){this.currentlyPlayingSongid=e},clearCurrentlyPlayingSongid:function(){this.currentlyPlayingSongid=null}});return p}),define("piki",["require"],function(){var e=/^(\w+\.)turntable\.fm/.exec(window.location.host);e=e?e[1]:"";var t=function(){window.pikiFrameLocked=!0;var t=$.Deferred(),i=document.createElement("script");return i.setAttribute("type","text/javascript"),i.setAttribute("charset","UTF-8"),i.setAttribute("src","https://"+e+"piki.fm/static/js/bookmarklet/run.js?rnd="+99999999*Math.random()),document.body.appendChild(i),i.onload=function(){window.pikiFrameLocked=!1,t.resolve()},t},i=function(e){var t=e.metadata.song+" -- "+e.metadata.artist,i=e._id||e.fileId;window.PikiFrame.initialize(t,i)},n=function(e){window.PikiFrame?i(e):t().done(function(){i(e)})};return{createPick:n}}),define("models/song-play",["require","tt-base","mixins"],function(e){var t=e("tt-base");e("mixins");var i=t.Model.extend({idAttribute:"",methodsToBind:["tick"],defaults:{progress:0},init:function(){this._loading=$.Deferred(),this.loading=this._loading.promise()},parse:function(e){return _.moveKeys(e,{djid:"djId",djname:"djName",localstarttime:"localStartTime",localendtime:"localEndTime"})},setLoaded:function(){this._loading.resolve()},start:function(){this.tickId=window.setInterval(this.tick,1e3)},stop:function(){window.clearInterval(this.tickId)},tick:function(){var e=Date.now()/1e3,t=e-this.get("localStartTime");this.set({timeSinceStart:Math.floor(t),timeLeft:Math.floor(this.get("localEndTime")-e),progress:t/this.get("metadata").length})}},{_name:"SongPlay"});return i}),define("collections/song-log",["require","tt-base","models/song-play"],function(e){var t=e("tt-base"),i=e("models/song-play");return t.Collection.extend({model:i},{_name:"SongLog"})}),define("models/room",["require","tt-base","app","set","collections/song-log"],function(e){var t=e("tt-base"),i=e("app"),n=e("set"),o=e("collections/song-log");return t.Model.extend({methodsToBind:["_onSaveDescriptionSuccess"],init:function(){this.songLog=new o,this.moderators=new n},parse:function(e){return e=_.clone(e),_.extend(e,e.metadata),delete e.metadata,e.songlog&&(this.songLogParsed||(this.songLog.length&&_.isEqual(this.songLog.last().get("metadata"),_.last(e.songlog).metadata)&&e.songlog.pop(),this.songLog.add(e.songlog,{at:0,parse:!0,merge:!0})),delete e.songlog,this.songLogParsed=!0),e.moderator_id&&(this.moderators.set(e.moderator_id),delete e.moderator_id),e},getShortcut:function(){return this.get("shortcut")||this.id},getUrl:function(){return"/"+this.getShortcut()},hasModPowers:function(e){return e=e||i.user,this.isMod(e)||e.isSuperuser()},isMod:function(e){return e=e||i.user,this.moderators.has(e.id)},saveDescription:function(e){return e!==this.get("description")?(this.pendingDescription=e,ttCommon.apiPost({api:"room.modify",roomid:this.id,description:e}).done(this._onSaveDescriptionSuccess)):$.Deferred().resolve().promise()},_onSaveDescriptionSuccess:function(){this.set("description",this.pendingDescription)}},{_name:"RoomModel"})}),define("views/guest-list",["require","tt-base","app"],function(e){var t=e("tt-base"),i=e("app"),n=t.View.extend({el:["ul.guest-list"],init:function(){this.room=this.options.room,this.updateGuestList=_.debounce(_.bind(this.updateGuestList,this),100),this.room.loading.done(this.updateGuestList),this.listenTo(this.room.model,"change:current_dj",this.updateGuestList),this.listenTo(this.room.djs,"add remove",this.updateGuestList),this.listenTo(this.room.model.moderators,"add remove",this.updateGuestList),this.listenTo(this.room.listeners,"add remove change:registered",this.updateGuestList),this.listenTo(i.user,"change:fanof",this.updateGuestList)},guestListSort:function(e,t){var i=e.get("name").toLowerCase(),n=t.get("name").toLowerCase();return n>i?-1:i>n?1:0},updateGuestList:function(){for(var e=[],t=[],o=[],s=[],r=[],a=[],l=this.$el,u=this.room.userMap,d=i.user.get("fanof"),h=0,c=this.room.djids,p=c.length;p>h;h++)o.push(u[c[h]]);for(var h=0,f=this.room.listenerids,p=f.length;p>h;h++){var m=f[h],g=u[m];c.indexOf(m)>-1||(g.isSuperuser()?e.push(g):this.room.model.isMod(g)?t.push(g):d.indexOf(m)>-1?s.push(g):u[m].registered?r.push(g):a.push(m))}t=e.sort(this.guestListSort).concat(t.sort(this.guestListSort)),r=s.sort(this.guestListSort).concat(r.sort(this.guestListSort));var v=l.find(".guest.selected").data("id");l.children().remove();for(var b=[o,t,r],w=["DJs","Moderators","Audience"],y=0,_=b.length;_>y;y++){var x=b[y];if(x.length||"Audience"==w[y]){l.append(util.buildTree(["div.separator",["div.text",w[y]]]));for(var h=0,p=x.length;p>h;h++){var S=v&&v==x[h].userid;l.append(util.buildTree(n.layouts.guestListName.call(this,x[h],S)))}"Audience"==w[y]&&a.length&&l.append(util.buildTree(n.layouts.guestRow(a.length)))}}this.updateGuestListMenu()},addGuestListMenu:function(e,t){this.guestOptionsHoverTimer&&clearTimeout(this.guestOptionsHoverTimer),$("div.guest.selected").removeClass("selected");var i=$(util.buildTree(n.layouts.guestOptions.call(this,e,this.room))).css({visibility:"hidden"});t.addClass("selected").parent().append(i),this.updateGuestListMenu(i,t)},updateGuestListMenu:function(e,t){if(e||(e=$("div.guestOptionsContainer")),t||(t=$("div.guest.selected")),e.length&&t.length){var i=t.position().top,n=t.parent().scrollTop(),o=i+n-e.height()+6;(0>o||n>o&&i+n+t.height()+e.height()<e.parent()[0].scrollHeight)&&(o=i+n+t.height()-5,e.addClass("nibTop")),$(e).css({top:o+"px",visibility:"visible"})}},removeGuestListMenu:function(e){$("div.guest.selected").removeClass("selected"),$("div.guestOptionsContainer").fadeOut("fast",function(){$(this).remove(),e&&e()})}},{_name:"GuestList",layouts:{guestRow:function(e){return["div.guest",["div.guest-count",util.commafy(e)+" guest"+(e>1?"s":"")]]},guestListName:function(e,t){var n=e.get("images").headfront,o=t?".guest.selected":".guest",s=["div.icons",{}];e.isSuperuser()?s.push(["div.superuser.icon",{title:"Superuser"}]):this.room.model.isMod(e)&&s.push(["div.mod.icon",{title:"Moderator"}]),i.user.isFanof(e.id)&&s.push(["div.fanned.icon",{title:"Fanned"}]);var r=this,a=["div"+o,{event:{mouseover:function(){$(this).find("div.guestArrow").show()},mouseout:function(){$(this).find("div.guestArrow").hide()},click:function(){var t=$(this).parent().find("div.guestOptionsContainer"),i=$(this);t.length?$(this).hasClass("selected")?r.removeGuestListMenu():r.removeGuestListMenu(_.bind(r.addGuestListMenu,r,e,i)):r.addGuestListMenu(e,i)},dblclick:function(){r.room.zApRhMCallback("pm_user",e.id)}},data:{id:e.id}},["div.guest-avatar",{style:{"background-image":"url("+n+")"}}],["div.guest-name",{},e.get("name")],s,["div.guestArrow"]];return this.room.roomData.metadata.currentDj==e.id&&a.splice(2,0,["div.current-dj"]),a},guestOptions:function(e,t){var o=this,s=["div.guestOptions.options",{event:{mouseover:function(){o.guestOptionsHoverTimer&&clearTimeout(o.guestOptionsHoverTimer)},mouseout:function(){o.guestOptionsHoverTimer=setTimeout(function(){o.removeGuestListMenu()},1e3)}}}];return s.push(n.layouts.guestOption("View Profile",null,e.id,t,"/profile/"+e.id)),i.user.registered&&e.id!==i.user.id&&s.push(n.layouts.guestOption("Report User",null,e.id,t,"/profile/"+e.id+"/report")),e.id===i.user.id&&t.isDj()&&(s.push(n.layouts.guestOption("Skip My Song","stop_song",e.id,t)),s.push(n.layouts.guestOption("Quit DJing","rem_dj",e.id,t))),e.id!==i.user.id&&t.model.hasModPowers()&&(i.user.get("acl")>=e.get("acl")&&(s.push(n.layouts.guestOption("Boot User","boot_user",e.id,t)),t.model.isMod(e.id)?s.push(n.layouts.guestOption("Remove Moderator","rem_moderator",e.id,t)):s.push(n.layouts.guestOption("Make a Moderator","add_moderator",e.id,t))),t.isDj(e.id)&&s.push(n.layouts.guestOption("Remove DJ","remove_dj",e.id,t))),e.id!==i.user.id&&i.user.registered&&(e.get("isFanned")?s.push(n.layouts.guestOption("Unfan","remove_fan",e.id,t)):s.push(n.layouts.guestOption("Become a Fan","become_fan",e.id,t)),s.push(n.layouts.guestOption("Send Private Message",function(){t.zApRhMCallback("pm_user",e.id)}))),["div.guestOptionsContainer.contextual-popup",{},s,["div.guestOptionsNib.nib",{event:{click:function(){o.removeGuestListMenu()}}},["div.guestOptionsNibArrow"]]]},guestOption:function(e,t,i,n,o){return["a.guestOption.option",{href:o||"#",event:o?{}:{click:function(){"string"==typeof t?n.zApRhMCallback(t,i):"function"==typeof t&&t(),$("div.guestOptionsContainer").remove()}}},e]}}});return n}),define("views/listener-count",["require","tt-base","lib/jquery.tipsy"],function(e){var t=e("tt-base");return e("lib/jquery.tipsy"),t.View.extend({el:["span.listener-count"],init:function(){this.collection?(this.listenTo(this.collection,"add remove",this._onChange),this.$el.tipsy()):this.model&&this.listenTo(this.model,"change:listeners",this._onChange)},_onChange:function(){var e;if(this.collection){e=this.collection.length;var t,i=this.collection.filter(function(e){return e.get("registered")}).length,n=e-i;t=1==i?i+" user":i+" users",t+=1==n?" + "+n+" guest":" + "+n+" guests",this.$el.attr("title",t)}else this.model&&(e=this.model.get("listeners"));this.$el.text(e+" "+(e>1?"people":"person")+" here")}},{_name:"ListenerCount"})}),define("views/song-log",["require","tt-base","app","views/song-list"],function(e){var t=e("tt-base"),i=e("app"),n=e("views/song-list");return t.View.extend({el:function(){return[n,{className:"song-log",collection:this.model.songLog,reverse:!0,defaultMessage:"No songs have been played in here!"}]},onShow:function(){i.trigger("songLog:visible")}},{_name:"SongLog"})}),define("views/trending-songs",["require","tt-base","views/song-list"],function(e){var t=e("tt-base"),i=e("views/song-list");return t.View.extend({el:function(){return[i,{className:"trending-songs",collection:this.options.room.trendingSongs,defaultMessage:"Oh noes, trending songs isn't available for this room yet! Keep spinnin sweet tunes and check back later."}]}},{_name:"TrendingSongs"})}),define("views/room-tab-main",["require","rivets","tt-base","app","views/guest-list","views/listener-count","views/options-menu","views/sliding-nav-pane","views/song-log","views/trending-songs","lib/jquery.autosize"],function(e){var t=e("rivets"),i=e("tt-base"),n=e("app"),o=e("views/guest-list"),s=e("views/listener-count"),r=e("views/options-menu"),a=e("views/sliding-nav-pane"),l=e("views/song-log"),u=e("views/trending-songs");return e("lib/jquery.autosize"),i.View.extend({options:{delegate:null},el:function(){return["div.room-tab-main-view",["div.room-info-intro","Welcome to ",["a.creator",{"data-rv-href":"room.creator | getProfileUrl"},"{{ room.creator | getName }}"],"'s room,"],["div.room-info-wrap$infoWrap",["div.room-name","{{ room.name }}"],[s,{className:"num-listeners",model:this.model}],[r,{className:"room-options-menu",title:"Room Options"},["li.option.edit-description-option",{"data-rv-if":"room:hasModPowers < user.acl moderators."+n.user.id},"Edit Description"],["li.option.edit-screens-option",{"data-rv-if":"user:isGatekeeper < user.acl"},"Edit Screens"],["li.option.report-room-option","Report Room"]],["div.save-description-btn",{title:"Save Room Description"},["div.icon","Save"]],["div.description-wrap",["textarea.edit-description$edit"],["div.description",{"data-rv-class-default-message":"room.description | not","data-rv-html":"room.description | withDefault"}]]],["ul.room-info-nav",["li.flat-button.room-info-link.recently-played-link",{data:{viewName:"songLog"}},["h3","Recently Played Songs"]],["li.flat-button.room-info-link.trending-link",{data:{viewName:"trendingSongs"}},["h3","Trending Songs"]],["li.flat-button.room-info-link.guest-list-link",{data:{viewName:"guestList"}},["h3","People Here"]]]]},events:{"click .edit-description-option":"_onDescriptionEditClick","click .edit-screens-option":"_onScreenEditClick","click .report-room-option":"_onReportOptionClick","click .save-description-btn":"_onDescriptionSaveClick","click .room-info-link":"_onRoomLinkClick"},init:function(){var e=this.options.room;this.rivetsView=t.bind(this.el,{room:this.model,user:n.user,moderators:this.model.moderators},{formatters:{withDefault:function(t){if(t)return util.brText(util.spaceToNbsps(util.messageFilter(t)));var i="No room description. ";return i+=e.model.hasModPowers()?"Click the icon above to write one!":"Ask a moderator to write one!"},getName:function(e){return e?e.name:void 0},getProfileUrl:function(e){return e?"/profile/"+e._id:void 0}}}),this.nodes.$edit.autosize(),this.$(".room-info-wrap").on("scroll",this._onRoomInfoScroll);var i=new s({collection:this.options.room.listeners});this.subviews={songLog:new a({mainView:new l({model:this.model}),title:"Recent Songs"}),trendingSongs:new a({mainView:new u({room:this.options.room}),title:"Trending Songs"}),guestList:new a({mainView:new o({room:this.options.room}),title:i})}},remove:function(){this.$edit.trigger("autosize destroy"),this._super.apply(this,arguments)},_onScreenEditClick:function(){n.room.showScreenEditor()},_onDescriptionEditClick:function(){this.isEditing||(this.isEditing=!0,this.nodes.$infoWrap.addClass("editing"),this.nodes.$edit.val(this.model.get("description")).trigger("autosize.resize").focus(),this.nodes.$edit[0].selectionStart=this.model.get("description").length)},_onDescriptionSaveClick:function(){this.isEditing&&(this.isEditing=!1,this.nodes.$infoWrap.removeClass("editing"),this.model.saveDescription(this.nodes.$edit.val()))},_onReportOptionClick:function(){n.router.setRoute("reportRoom",{shortcut:this.model.getShortcut()})},_onRoomLinkClick:function(e){_gaq.push(["_trackEvent","room","info",$(e.currentTarget).find("h3").html()]),this.options.delegate&&this.options.delegate.onRoomSubviewSelect&&(this.currentViewName=$.data(e.currentTarget,"viewName"),this.options.delegate.onRoomSubviewSelect(this.subviews[this.currentViewName]))},_onRoomInfoScroll:function(e){e.currentTarget.scrollTop=0}},{_name:"RoomTabMainView"})}),define("views/room-tab",["require","tt-base","util","app","views/room-tab-main","views/sliding-nav","views/sliding-nav-pane"],function(e){var t=e("tt-base"),i=(e("util"),e("app"),e("views/room-tab-main")),n=e("views/sliding-nav"),o=e("views/sliding-nav-pane");return t.View.extend({options:{idd:"roomTab"},el:["div.room-tab"],init:function(){this.roomTabMainView=new i({model:this.model,room:this.options.room,delegate:this}),this.slidingNav=new n({topView:new o({mainView:this.roomTabMainView,showHeader:!1,backText:"Room"})}),this.$el.append(this.slidingNav.el),this.listenTo(this.slidingNav,{show:this._onViewShow,hide:this._onViewHide})},onShow:function(){this.isVisible=!0,this.currentView&&this.currentView.onShow&&this.currentView.onShow()},onHide:function(){this.isVisible=!1,this.currentView&&this.currentView.onHide&&this.currentView.onHide()},_onViewShow:function(e){e=this.currentView=e.options.mainView,e.onShow&&e.onShow()},_onViewHide:function(e){e=e.options.mainView,e.onHide&&e.onHide(),this.currentView=null},onRoomSubviewSelect:function(e){this.slidingNav.pushView(e)}},{_name:"MiniPMsView"})}),define("animation",["require","underscore","class"],function(e){var t=e("underscore"),i=e("class"),n={rock:{id:"rock",keyframes:[{"hb,hf":{y:1,x:3,angle:10},duration:100},{"hb,hf":{y:3,x:6,angle:10},duration:100},{"hb,hf":{y:3,x:6,angle:10},duration:100},{"hb,hf":{y:1,x:3,angle:0},duration:100},{"hb,hf":{y:0,x:0,angle:0},duration:100},{"hb,hf":{y:0,x:0,angle:0},duration:100},{"hb,hf":{y:1,x:-3,angle:-10},duration:100},{"hb,hf":{y:3,x:-6,angle:-10},duration:100},{"hb,hf":{y:3,x:-6,angle:-10},duration:100},{"hb,hf":{y:1,x:-3,angle:0},duration:100},{"hb,hf":{y:0,x:0,angle:0},duration:100},{"hb,hf":{y:0,x:0,angle:0},duration:100}],duration:1200,loop:!0},smallrock:{id:"smallrock",keyframes:[{"hb,hf":{y:1,x:2,angle:6},duration:100},{"hb,hf":{y:2,x:4,angle:6},duration:100},{"hb,hf":{y:2,x:4,angle:6},duration:100},{"hb,hf":{y:1,x:2,angle:0},duration:100},{"hb,hf":{y:0,x:0,angle:0},duration:100},{"hb,hf":{y:0,x:0,angle:0},duration:100},{"hb,hf":{y:1,x:-2,angle:-6},duration:100},{"hb,hf":{y:2,x:-4,angle:-6},duration:100},{"hb,hf":{y:2,x:-4,angle:-6},duration:100},{"hb,hf":{y:1,x:-2,angle:0},duration:100},{"hb,hf":{y:0,x:0,angle:0},duration:100},{"hb,hf":{y:0,x:0,angle:0},duration:100}],duration:1200,loop:!0},bob:{id:"bob",keyframes:[{"hb,hf":{y:7},duration:200},{"hb,hf":{y:7},duration:100},{"hb,hf":{y:0},duration:200},{"hb,hf":{y:0},duration:100}],duration:600,loop:!0}},o=i.extend({init:function(e){t.extend(this,e),this.ready=!1}});t.extend(o,{cache:{},cacheAnimation:function(e){this.cache[e.id]=e},getCachedAnimation:function(e){var t=e.id;return t?this.cache[t]:(e.id=JSON.stringify(e),void 0)},createAnimationGetter:function(e){return function(t){var i=o.getCachedAnimation(t);if(i)return i;var n=new e(t);return o.cacheAnimation(n),n}}});var s=o.extend({init:function(e){this._super(e),this.ready=!0;for(var t=0,i=this.keyframes,n=i.length,o=0;n>o;o++)t+=i[o].duration;this.duration=t}});t.extend(s,{getAnimation:o.createAnimationGetter(s)});var r=o.extend({init:function(e){this._super(e);var i=util.createImageWithLoader(this.url);this.image=i[0];var n=i[1];n.done(t.bind(function(){this.ready=!0},this))}});return t.extend(r,{getAnimation:o.createAnimationGetter(r)}),{animations:n,AvatarAnimation:s,SpriteAnimation:r}}),function(){function HEXtoRGB(e){return[(255&e>>16)/255,(255&e>>8)/255,(255&e)/255]}function determineMatrixArrayType(){return PIXI.Matrix="undefined"!=typeof Float32Array?Float32Array:Array,PIXI.Matrix}var root=this,PIXI=PIXI||{};PIXI.Point=function(e,t){this.x=e||0,this.y=t||0},PIXI.Point.clone=function(){return new PIXI.Point(this.x,this.y)},PIXI.Point.constructor=PIXI.Point,PIXI.Rectangle=function(e,t,i,n){this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0},PIXI.Rectangle.clone=function(){return new PIXI.Rectangle(this.x,this.y,this.width,this.height)},PIXI.Rectangle.constructor=PIXI.Rectangle,PIXI.DisplayObject=function(){this.position=new PIXI.Point,this.scale=new PIXI.Point(1,1),this.rotation=0,this.alpha=1,this.visible=!0,this.cacheVisible=!1,this.parent=null,this.stage=null,this.hitArea=null,this.worldAlpha=1,this.color=[],this.worldTransform=PIXI.mat3.create(),this.localTransform=PIXI.mat3.create(),this.dynamic=!0,this._sr=0,this._cr=1,this.renderable=!1,this.interactive=!1,this.buttonMode=!1},PIXI.DisplayObject.constructor=PIXI.DisplayObject,PIXI.DisplayObject.prototype.setInteractive=function(e){this.interactive=e,this.stage&&(this.stage.dirty=!0)},PIXI.DisplayObject.prototype.updateTransform=function(){this.rotation!=this.rotationCache&&(this.rotationCache=this.rotation,this._sr=Math.sin(this.rotation),this._cr=Math.cos(this.rotation));var e=this.localTransform,t=this.parent.worldTransform,i=this.worldTransform;e[0]=this._cr*this.scale.x,e[1]=-this._sr*this.scale.y,e[3]=this._sr*this.scale.x,e[4]=this._cr*this.scale.y,e[2]=this.position.x,e[5]=this.position.y;var n=e[0],o=e[1],s=e[2],r=e[3],a=e[4],l=e[5],u=t[0],d=t[1],h=t[2],c=t[3],p=t[4],f=t[5];i[0]=u*n+d*r,i[1]=u*o+d*a,i[2]=u*s+d*l+h,i[3]=c*n+p*r,i[4]=c*o+p*a,i[5]=c*s+p*l+f,this.worldAlpha=this.alpha*this.parent.worldAlpha},PIXI.DisplayObjectContainer=function(){PIXI.DisplayObject.call(this),this.children=[],this.renderable=!1},PIXI.DisplayObjectContainer.constructor=PIXI.DisplayObjectContainer,PIXI.DisplayObjectContainer.prototype=Object.create(PIXI.DisplayObject.prototype),PIXI.DisplayObjectContainer.prototype.addChild=function(e){void 0!=e.parent&&e.parent.removeChild(e),e.parent=this,e.childIndex=this.children.length,this.children.push(e),this.stage&&this.stage.__addChild(e)},PIXI.DisplayObjectContainer.prototype.addChildAt=function(e,t){if(!(t>=0&&t<=this.children.length))throw new Error(e+" The index "+t+" supplied is out of bounds "+this.children.length);void 0!=e.parent&&e.parent.removeChild(e),t==this.children.length?this.children.push(e):this.children.splice(t,0,e),e.parent=this,e.childIndex=t;for(var i=this.children.length,n=t;i>n;n++)this.children[n].childIndex=n;this.stage&&this.stage.__addChild(e)},PIXI.DisplayObjectContainer.prototype.swapChildren=function(e,t){var i=this.children.indexOf(e),n=this.children.indexOf(t);if(-1===i||-1===n)throw new Error(e+" Both the supplied DisplayObjects must be a child of the caller "+this);this.stage&&(this.stage.__removeChild(e),this.stage.__removeChild(t),this.stage.__addChild(e),this.stage.__addChild(t)),e.childIndex=n,t.childIndex=i,this.children[i]=t,this.children[n]=e},PIXI.DisplayObjectContainer.prototype.getChildAt=function(e){if(e>=0&&e<this.children.length)return this.children[e];throw new Error(child+" Both the supplied DisplayObjects must be a child of the caller "+this)},PIXI.DisplayObjectContainer.prototype.removeChild=function(e){var t=this.children.indexOf(e);if(-1===t)throw new Error(e+" The supplied DisplayObject must be a child of the caller "+this);this.stage&&this.stage.__removeChild(e),e.parent=void 0,this.children.splice(t,1);for(var i=t,n=this.children.length;n>i;i++)this.children[i].childIndex-=1},PIXI.DisplayObjectContainer.prototype.updateTransform=function(){if(this.visible){PIXI.DisplayObject.prototype.updateTransform.call(this);for(var e=0,t=this.children.length;t>e;e++)this.children[e].updateTransform()}},PIXI.blendModes={},PIXI.blendModes.NORMAL=0,PIXI.blendModes.SCREEN=1,PIXI.Sprite=function(e){PIXI.DisplayObjectContainer.call(this),this.anchor=new PIXI.Point,this.texture=e,this.blendMode=PIXI.blendModes.NORMAL,this._width=0,this._height=0,e.baseTexture.hasLoaded?this.updateFrame=!0:(this.onTextureUpdateBind=this.onTextureUpdate.bind(this),this.texture.addEventListener("update",this.onTextureUpdateBind)),this.renderable=!0},PIXI.Sprite.constructor=PIXI.Sprite,PIXI.Sprite.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),Object.defineProperty(PIXI.Sprite.prototype,"width",{get:function(){return this.scale.x*this.texture.frame.width},set:function(e){this.scale.x=e/this.texture.frame.width,this._width=e}}),Object.defineProperty(PIXI.Sprite.prototype,"height",{get:function(){return this.scale.y*this.texture.frame.height},set:function(e){this.scale.y=e/this.texture.frame.height,this._height=e}}),PIXI.Sprite.prototype.setTexture=function(e){this.texture.baseTexture!=e.baseTexture&&(this.textureChange=!0),this.texture=e,this.updateFrame=!0},PIXI.Sprite.prototype.onTextureUpdate=function(){this._width&&(this.scale.x=this._width/this.texture.frame.width),this._height&&(this.scale.y=this._height/this.texture.frame.height),this.updateFrame=!0},PIXI.Sprite.fromFrame=function(e){var t=PIXI.TextureCache[e];if(!t)throw new Error("The frameId '"+e+"' does not exist in the texture cache"+this);return new PIXI.Sprite(t)},PIXI.Sprite.fromImage=function(e){var t=PIXI.Texture.fromImage(e);return new PIXI.Sprite(t)},PIXI.MovieClip=function(e){PIXI.Sprite.call(this,e[0]),this.textures=e,this.currentFrame=0,this.animationSpeed=1,this.loop=!0,this.onComplete=null,this.playing},PIXI.MovieClip.constructor=PIXI.MovieClip,PIXI.MovieClip.prototype=Object.create(PIXI.Sprite.prototype),PIXI.MovieClip.prototype.stop=function(){this.playing=!1},PIXI.MovieClip.prototype.play=function(){this.playing=!0},PIXI.MovieClip.prototype.gotoAndStop=function(e){this.playing=!1,this.currentFrame=e;var t=0|this.currentFrame+.5;this.setTexture(this.textures[t%this.textures.length])},PIXI.MovieClip.prototype.gotoAndPlay=function(e){this.currentFrame=e,this.playing=!0},PIXI.MovieClip.prototype.updateTransform=function(){if(PIXI.Sprite.prototype.updateTransform.call(this),this.playing){this.currentFrame+=this.animationSpeed;var e=0|this.currentFrame+.5;this.loop||e<this.textures.length?this.setTexture(this.textures[e%this.textures.length]):e>=this.textures.length&&(this.gotoAndStop(this.textures.length-1),this.onComplete&&this.onComplete())}},PIXI.Text=function(e,t){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),PIXI.Sprite.call(this,PIXI.Texture.fromCanvas(this.canvas)),this.setText(e),this.setStyle(t),this.dirty=!0},PIXI.Text.constructor=PIXI.Text,PIXI.Text.prototype=Object.create(PIXI.Sprite.prototype),PIXI.Text.prototype.setStyle=function(e){e=e||{},e.font=e.font||"bold 20pt Arial",e.fill=e.fill||"black",e.align=e.align||"left",e.strokeThickness=e.strokeThickness||0,this.style=e,this.dirty=!0},PIXI.Sprite.prototype.setText=function(e){this.text=e||" ",this.dirty=!0},PIXI.Text.prototype.updateText=function(){this.context.font=this.style.font;for(var e=this.text.split("\n"),t=[],i=0,n=0;n<e.length;n++){var o=this.context.measureText(e[n]).width;t[n]=o,i=Math.max(i,o)}this.canvas.width=i+this.style.strokeThickness;var s=this.determineFontHeight("font: "+this.style.font+";")+this.style.strokeThickness;for(this.canvas.height=s*e.length,this.context.fillStyle=this.style.fill,this.context.font=this.style.font,this.context.strokeStyle=this.style.stroke,this.context.lineWidth=this.style.strokeThickness,this.context.textBaseline="top",n=0;n<e.length;n++){var r=new PIXI.Point(this.style.strokeThickness/2,this.style.strokeThickness/2+n*s);"right"==this.style.align?r.x+=i-t[n]:"center"==this.style.align&&(r.x+=(i-t[n])/2),this.style.stroke&&this.style.strokeThickness&&this.context.strokeText(e[n],r.x,r.y),this.style.fill&&this.context.fillText(e[n],r.x,r.y)}this.updateTexture()},PIXI.Text.prototype.updateTexture=function(){this.texture.baseTexture.width=this.canvas.width,this.texture.baseTexture.height=this.canvas.height,this.texture.frame.width=this.canvas.width,this.texture.frame.height=this.canvas.height,PIXI.texturesToUpdate.push(this.texture.baseTexture)
},PIXI.Text.prototype.updateTransform=function(){this.dirty&&(this.updateText(),this.dirty=!1),PIXI.Sprite.prototype.updateTransform.call(this)},PIXI.Text.prototype.determineFontHeight=function(e){var t=PIXI.Text.heightCache[e];if(!t){var i=document.getElementsByTagName("body")[0],n=document.createElement("div"),o=document.createTextNode("M");n.appendChild(o),n.setAttribute("style",e),i.appendChild(n),t=n.offsetHeight,PIXI.Text.heightCache[e]=t,i.removeChild(n)}return t},PIXI.Text.prototype.destroy=function(e){e&&this.texture.destroy()},PIXI.Text.heightCache={},PIXI.BitmapText=function(e,t){PIXI.DisplayObjectContainer.call(this),this.setText(e),this.setStyle(t),this.updateText(),this.dirty=!1},PIXI.BitmapText.constructor=PIXI.BitmapText,PIXI.BitmapText.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),PIXI.BitmapText.prototype.setText=function(e){this.text=e||" ",this.dirty=!0},PIXI.BitmapText.prototype.setStyle=function(e){e=e||{},e.align=e.align||"left",this.style=e;var t=e.font.split(" ");this.fontName=t[t.length-1],this.fontSize=t.length>=2?parseInt(t[t.length-2],10):PIXI.BitmapText.fonts[this.fontName].size,this.dirty=!0},PIXI.BitmapText.prototype.updateText=function(){for(var e=PIXI.BitmapText.fonts[this.fontName],t=new PIXI.Point,i=null,n=[],o=0,s=[],r=0,a=this.fontSize/e.size,l=0;l<this.text.length;l++){var u=this.text.charCodeAt(l);if(u!="\n".charCodeAt(0)){var d=e.chars[u];d&&(i&&d[i]&&(t.x+=d.kerning[i]),n.push({line:r,charCode:u,position:new PIXI.Point(t.x+d.xOffset,t.y+d.yOffset)}),t.x+=d.xAdvance,i=u)}else s.push(t.x),o=Math.max(o,t.x),r++,t.x=0,t.y+=e.lineHeight,i=null}s.push(t.x),o=Math.max(o,t.x);var h=[];for(l=0;r>=l;l++){var c=0;"right"==this.style.align?c=o-s[l]:"center"==this.style.align&&(c=(o-s[l])/2),h.push(c)}for(l=0;l<n.length;l++){var p=PIXI.Sprite.fromFrame(n[l].charCode);p.position.x=(n[l].position.x+h[n[l].line])*a,p.position.y=n[l].position.y*a,p.scale.x=p.scale.y=a,this.addChild(p)}this.width=t.x*a,this.height=(t.y+e.lineHeight)*a},PIXI.BitmapText.prototype.updateTransform=function(){if(this.dirty){for(;this.children.length>0;)this.removeChild(this.getChildAt(0));this.updateText(),this.dirty=!1}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)},PIXI.BitmapText.fonts={},PIXI.InteractionManager=function(e){this.stage=e,this.tempPoint=new PIXI.Point,this.mouseoverEnabled=!0,this.mouse=new PIXI.InteractionData,this.touchs={},this.pool=[],this.interactiveItems=[],this.last=0},PIXI.InteractionManager.constructor=PIXI.InteractionManager,PIXI.InteractionManager.prototype.collectInteractiveSprite=function(e,t){for(var i=e.children,n=i.length,o=n-1;o>=0;o--){var s=i[o];s.interactive?(t.interactiveChildren=!0,this.interactiveItems.push(s),s.children.length>0&&this.collectInteractiveSprite(s,s)):(s.__iParent=null,s.children.length>0&&this.collectInteractiveSprite(s,t))}},PIXI.InteractionManager.prototype.setTarget=function(e){window.navigator.msPointerEnabled&&(e.view.style["-ms-content-zooming"]="none",e.view.style["-ms-touch-action"]="none"),this.target=e,e.view.addEventListener("mousemove",this.onMouseMove.bind(this),!0),e.view.addEventListener("mousedown",this.onMouseDown.bind(this),!0),document.body.addEventListener("mouseup",this.onMouseUp.bind(this),!0),e.view.addEventListener("mouseout",this.onMouseUp.bind(this),!0),e.view.addEventListener("touchstart",this.onTouchStart.bind(this),!0),e.view.addEventListener("touchend",this.onTouchEnd.bind(this),!0),e.view.addEventListener("touchmove",this.onTouchMove.bind(this),!0)},PIXI.InteractionManager.prototype.update=function(){var e=Date.now(),t=e-this.last;if(t=30*t/1e3,!(1>t)){if(this.last=e,this.dirty){this.dirty=!1,this.interactiveItems.length;for(var i=0;i<this.interactiveItems.length;i++)this.interactiveItems[i].interactiveChildren=!1;this.interactiveItems=[],this.stage.interactive&&this.interactiveItems.push(this.stage),this.collectInteractiveSprite(this.stage,this.stage)}var n=this.interactiveItems.length;this.target&&(this.target.view.style.cursor="default");for(var i=0;n>i;i++){var o=this.interactiveItems[i];o.visible&&(o.mouseover||o.mouseout||o.buttonMode)&&(o.__hit=this.hitTest(o,this.mouse),o.__hit?(o.buttonMode&&(this.target.view.style.cursor="pointer"),o.__isOver||(o.mouseover&&o.mouseover(this.mouse),o.__isOver=!0)):o.__isOver&&(o.mouseout&&o.mouseout(this.mouse),o.__isOver=!1))}}},PIXI.InteractionManager.prototype.onMouseMove=function(e){e.preventDefault();var t=this.target.view.getBoundingClientRect();this.mouse.global.x=(e.clientX-t.left)*(this.target.width/t.width),this.mouse.global.y=(e.clientY-t.top)*(this.target.height/t.height);var i=this.interactiveItems.length;this.mouse.global;for(var n=0;i>n;n++){var o=this.interactiveItems[n];o.mousemove&&o.mousemove(this.mouse)}},PIXI.InteractionManager.prototype.onMouseDown=function(e){e.preventDefault();var t=this.interactiveItems.length;this.mouse.global,this.stage;for(var i=0;t>i;i++){var n=this.interactiveItems[i];if((n.mousedown||n.click)&&(n.__mouseIsDown=!0,n.__hit=this.hitTest(n,this.mouse),n.__hit&&(n.mousedown&&n.mousedown(this.mouse),n.__isDown=!0,!n.interactiveChildren)))break}},PIXI.InteractionManager.prototype.onMouseUp=function(e){e.preventDefault(),this.mouse.global;for(var t=this.interactiveItems.length,i=!1,n=0;t>n;n++){var o=this.interactiveItems[n];(o.mouseup||o.mouseupoutside||o.click)&&(o.__hit=this.hitTest(o,this.mouse),o.__hit&&!i?(o.mouseup&&o.mouseup(this.mouse),o.__isDown&&o.click&&o.click(this.mouse),o.interactiveChildren||(i=!0)):o.__isDown&&o.mouseupoutside&&o.mouseupoutside(this.mouse),o.__isDown=!1)}},PIXI.InteractionManager.prototype.hitTest=function(e,t){var i=t.global;if(!e.visible)return!1;if(e instanceof PIXI.Sprite){var n=e.worldTransform,o=n[0],s=n[1],r=n[2],a=n[3],l=n[4],u=n[5],d=1/(o*l+s*-a),h=l*d*i.x+-s*d*i.y+(u*s-r*l)*d,c=o*d*i.y+-a*d*i.x+(-u*o+r*a)*d,p=e.texture.frame.width,f=e.texture.frame.height,m=-p*e.anchor.x;if(h>m&&m+p>h){var g=-f*e.anchor.y;if(c>g&&g+f>c)return t.target=e,!0}}else if(e.hitArea){var n=e.worldTransform,v=e.hitArea,o=n[0],s=n[1],r=n[2],a=n[3],l=n[4],u=n[5],d=1/(o*l+s*-a),h=l*d*i.x+-s*d*i.y+(u*s-r*l)*d,c=o*d*i.y+-a*d*i.x+(-u*o+r*a)*d,m=v.x;if(h>m&&h<m+v.width){var g=v.y;if(c>g&&c<g+v.height)return!0}}for(var b=e.children.length,w=0;b>w;w++){var y=e.children[w],_=this.hitTest(y,t);if(_)return!0}return!1},PIXI.InteractionManager.prototype.onTouchMove=function(e){e.preventDefault();for(var t=this.target.view.getBoundingClientRect(),i=e.changedTouches,n=0;n<i.length;n++){var o=i[n],s=this.touchs[o.identifier];s.global.x=(o.clientX-t.left)*(this.target.width/t.width),s.global.y=(o.clientY-t.top)*(this.target.height/t.height)}for(var r=this.interactiveItems.length,n=0;r>n;n++){var a=this.interactiveItems[n];a.touchmove&&a.touchmove(s)}},PIXI.InteractionManager.prototype.onTouchStart=function(e){e.preventDefault();for(var t=this.target.view.getBoundingClientRect(),i=e.changedTouches,n=0;n<i.length;n++){var o=i[n],s=this.pool.pop();s||(s=new PIXI.InteractionData),this.touchs[o.identifier]=s,s.global.x=(o.clientX-t.left)*(this.target.width/t.width),s.global.y=(o.clientY-t.top)*(this.target.height/t.height);for(var r=this.interactiveItems.length,a=0;r>a;a++){var l=this.interactiveItems[a];if((l.touchstart||l.tap)&&(l.__hit=this.hitTest(l,s),l.__hit&&(l.touchstart&&l.touchstart(s),l.__isDown=!0,l.__touchData=s,!l.interactiveChildren)))break}}},PIXI.InteractionManager.prototype.onTouchEnd=function(e){e.preventDefault();for(var t=this.target.view.getBoundingClientRect(),i=e.changedTouches,n=0;n<i.length;n++){var o=i[n],s=this.touchs[o.identifier],r=!1;s.global.x=(o.clientX-t.left)*(this.target.width/t.width),s.global.y=(o.clientY-t.top)*(this.target.height/t.height);for(var a=this.interactiveItems.length,l=0;a>l;l++){var u=this.interactiveItems[l],d=u.__touchData;u.__hit=this.hitTest(u,s),d==s&&((u.touchend||u.tap)&&(u.__hit&&!r?(u.touchend&&u.touchend(s),u.__isDown&&u.tap&&u.tap(s),u.interactiveChildren||(r=!0)):u.__isDown&&u.touchendoutside&&u.touchendoutside(s),u.__isDown=!1),u.__touchData=null)}this.pool.push(s),this.touchs[o.identifier]=null}},PIXI.InteractionData=function(){this.global=new PIXI.Point,this.local=new PIXI.Point,this.target},PIXI.InteractionData.prototype.getLocalPosition=function(e){var t=e.worldTransform,i=this.global,n=t[0],o=t[1],s=t[2],r=t[3],a=t[4],l=t[5],u=1/(n*a+o*-r);return new PIXI.Point(a*u*i.x+-o*u*i.y+(l*o-s*a)*u,n*u*i.y+-r*u*i.x+(-l*n+s*r)*u)},PIXI.InteractionData.constructor=PIXI.InteractionData,PIXI.Stage=function(e,t){PIXI.DisplayObjectContainer.call(this),this.worldTransform=PIXI.mat3.create(),this.__childrenAdded=[],this.__childrenRemoved=[],this.childIndex=0,this.stage=this,this.stage.hitArea=new PIXI.Rectangle(0,0,1e5,1e5),this.interactive=!!t,this.interactionManager=new PIXI.InteractionManager(this),this.setBackgroundColor(e)},PIXI.Stage.constructor=PIXI.Stage,PIXI.Stage.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),PIXI.Stage.prototype.updateTransform=function(){this.worldAlpha=1;for(var e=0,t=this.children.length;t>e;e++)this.children[e].updateTransform();this.dirty&&(this.dirty=!1,this.interactionManager.dirty=!0),this.interactive&&this.interactionManager.update()},PIXI.Stage.prototype.setBackgroundColor=function(e){this.backgroundColor=e||0,this.backgroundColorSplit=HEXtoRGB(this.backgroundColor),this.backgroundColorString="#"+this.backgroundColor.toString(16)},PIXI.Stage.prototype.getMousePosition=function(){return this.interactionManager.mouse.global},PIXI.Stage.prototype.__addChild=function(e){if(e.interactive&&(this.dirty=!0),e.stage=this,e.children)for(var t=0;t<e.children.length;t++)this.__addChild(e.children[t])},PIXI.Stage.prototype.__removeChild=function(e){if(e.interactive&&(this.dirty=!0),this.__childrenRemoved.push(e),e.stage=void 0,e.children)for(var t=0,i=e.children.length;i>t;t++)this.__removeChild(e.children[t])},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),"function"!=typeof Function.prototype.bind&&(Function.prototype.bind=function(){var e=Array.prototype.slice;return function(t){function i(){var s=o.concat(e.call(arguments));n.apply(this instanceof i?this:t,s)}var n=this,o=e.call(arguments,1);if("function"!=typeof n)throw new TypeError;return i.prototype=function s(e){return e&&(s.prototype=e),this instanceof s?void 0:new s}(n.prototype),i}}());var AjaxRequest=function(){var e=["Msxml2.XMLHTTP","Microsoft.XMLHTTP"];if(!window.ActiveXObject)return window.XMLHttpRequest?new XMLHttpRequest:!1;for(var t=0;t<e.length;t++)try{return new ActiveXObject(e[t])}catch(i){}};PIXI.EventTarget=function(){var e={};this.addEventListener=this.on=function(t,i){void 0===e[t]&&(e[t]=[]),-1===e[t].indexOf(i)&&e[t].push(i)},this.dispatchEvent=this.emit=function(t){for(var i in e[t.type])e[t.type][i](t)},this.removeEventListener=this.off=function(t,i){var n=e[t].indexOf(i);-1!==n&&e[t].splice(n,1)}},determineMatrixArrayType(),PIXI.mat3={},PIXI.mat3.create=function(){var e=new PIXI.Matrix(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},PIXI.mat4={},PIXI.mat4.create=function(){var e=new PIXI.Matrix(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},PIXI.mat3.multiply=function(e,t,i){i||(i=e);var n=e[0],o=e[1],s=e[2],r=e[3],a=e[4],l=e[5],u=e[6],d=e[7],h=e[8],c=t[0],p=t[1],f=t[2],m=t[3],g=t[4],v=t[5],b=t[6],w=t[7],y=t[8];return i[0]=c*n+p*r+f*u,i[1]=c*o+p*a+f*d,i[2]=c*s+p*l+f*h,i[3]=m*n+g*r+v*u,i[4]=m*o+g*a+v*d,i[5]=m*s+g*l+v*h,i[6]=b*n+w*r+y*u,i[7]=b*o+w*a+y*d,i[8]=b*s+w*l+y*h,i},PIXI.mat3.toMat4=function(e,t){return t||(t=PIXI.mat4.create()),t[15]=1,t[14]=0,t[13]=0,t[12]=0,t[11]=0,t[10]=e[8],t[9]=e[7],t[8]=e[6],t[7]=0,t[6]=e[5],t[5]=e[4],t[4]=e[3],t[3]=0,t[2]=e[2],t[1]=e[1],t[0]=e[0],t},PIXI.mat4.create=function(){var e=new PIXI.Matrix(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},PIXI.mat4.transpose=function(e,t){if(!t||e===t){var i=e[1],n=e[2],o=e[3],s=e[6],r=e[7],a=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=i,e[6]=e[9],e[7]=e[13],e[8]=n,e[9]=s,e[11]=e[14],e[12]=o,e[13]=r,e[14]=a,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},PIXI.mat4.multiply=function(e,t,i){i||(i=e);var n=e[0],o=e[1],s=e[2],r=e[3],a=e[4],l=e[5],u=e[6],d=e[7],h=e[8],c=e[9],p=e[10],f=e[11],m=e[12],g=e[13],v=e[14],b=e[15],w=t[0],y=t[1],_=t[2],x=t[3];return i[0]=w*n+y*a+_*h+x*m,i[1]=w*o+y*l+_*c+x*g,i[2]=w*s+y*u+_*p+x*v,i[3]=w*r+y*d+_*f+x*b,w=t[4],y=t[5],_=t[6],x=t[7],i[4]=w*n+y*a+_*h+x*m,i[5]=w*o+y*l+_*c+x*g,i[6]=w*s+y*u+_*p+x*v,i[7]=w*r+y*d+_*f+x*b,w=t[8],y=t[9],_=t[10],x=t[11],i[8]=w*n+y*a+_*h+x*m,i[9]=w*o+y*l+_*c+x*g,i[10]=w*s+y*u+_*p+x*v,i[11]=w*r+y*d+_*f+x*b,w=t[12],y=t[13],_=t[14],x=t[15],i[12]=w*n+y*a+_*h+x*m,i[13]=w*o+y*l+_*c+x*g,i[14]=w*s+y*u+_*p+x*v,i[15]=w*r+y*d+_*f+x*b,i},PIXI.autoDetectRenderer=function(e,t,i,n){e||(e=800),t||(t=600);var o=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}}();return o?new PIXI.WebGLRenderer(e,t,i,n):new PIXI.CanvasRenderer(e,t,i,n)},PIXI.shaderFragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying float vColor;","uniform sampler2D uSampler;","void main(void) {","gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y));","gl_FragColor = gl_FragColor * vColor;","}"],PIXI.shaderVertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute float aColor;","uniform mat4 uMVMatrix;","varying vec2 vTextureCoord;","varying float vColor;","void main(void) {","gl_Position = uMVMatrix * vec4(aVertexPosition, 1.0, 1.0);","vTextureCoord = aTextureCoord;","vColor = aColor;","}"],PIXI.CompileVertexShader=function(e,t){return PIXI._CompileShader(e,t,e.VERTEX_SHADER)},PIXI.CompileFragmentShader=function(e,t){return PIXI._CompileShader(e,t,e.FRAGMENT_SHADER)},PIXI._CompileShader=function(e,t,i){var n=t.join("\n"),o=e.createShader(i);return e.shaderSource(o,n),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)?o:(alert(e.getShaderInfoLog(o)),null)},PIXI._defaultFrame=new PIXI.Rectangle(0,0,1,1),PIXI.WebGLRenderer=function(e,t,i,n){this.transparent=!!n,this.width=e||800,this.height=t||600,this.view=i||document.createElement("canvas"),this.view.width=this.width,this.view.height=this.height;var o=this;this.view.addEventListener("webglcontextlost",function(e){o.handleContextLost(e)},!1),this.view.addEventListener("webglcontextrestored",function(e){o.handleContextRestored(e)},!1),this.batchs=[];try{this.gl=this.view.getContext("experimental-webgl",{alpha:this.transparent,antialias:!1,premultipliedAlpha:!0})}catch(s){throw new Error(" This browser does not support webGL. Try using the canvas renderer"+this)}this.initShaders();var r=this.gl;this.batch=new PIXI.WebGLBatch(r),r.disable(r.DEPTH_TEST),r.enable(r.BLEND),r.colorMask(!0,!0,!0,this.transparent),this.projectionMatrix=PIXI.mat4.create(),this.resize(this.width,this.height),this.contextLost=!1},PIXI.WebGLRenderer.constructor=PIXI.WebGLRenderer,PIXI.WebGLRenderer.prototype.getBatch=function(){return 0==PIXI._batchs.length?new PIXI.WebGLBatch(this.gl):PIXI._batchs.pop()},PIXI.WebGLRenderer.prototype.returnBatch=function(e){e.clean(),PIXI._batchs.push(e)},PIXI.WebGLRenderer.prototype.initShaders=function(){var e=this.gl,t=PIXI.CompileFragmentShader(e,PIXI.shaderFragmentSrc),i=PIXI.CompileVertexShader(e,PIXI.shaderVertexSrc);this.shaderProgram=e.createProgram();var n=this.shaderProgram;e.attachShader(n,i),e.attachShader(n,t),e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS)||alert("Could not initialise shaders"),e.useProgram(n),n.vertexPositionAttribute=e.getAttribLocation(n,"aVertexPosition"),e.enableVertexAttribArray(n.vertexPositionAttribute),n.textureCoordAttribute=e.getAttribLocation(n,"aTextureCoord"),e.enableVertexAttribArray(n.textureCoordAttribute),n.colorAttribute=e.getAttribLocation(n,"aColor"),e.enableVertexAttribArray(n.colorAttribute),n.mvMatrixUniform=e.getUniformLocation(n,"uMVMatrix"),n.samplerUniform=e.getUniformLocation(n,"uSampler"),PIXI.shaderProgram=this.shaderProgram},PIXI.WebGLRenderer.prototype.checkVisibility=function(e,t){for(var i=e.children,n=0;n<i.length;n++){var o=i[n],s=o.visible&&t;o.textureChange&&(o.textureChange=!1,s&&(this.removeDisplayObject(o),this.addDisplayObject(o))),o.cacheVisible!=s&&(o.cacheVisible=s,o.cacheVisible?this.addDisplayObject(o):this.removeDisplayObject(o)),o.children.length>0&&this.checkVisibility(o,s)}},PIXI.WebGLRenderer.prototype.render=function(e){if(!this.contextLost){this.__stage!==e&&(this.__stage&&this.checkVisibility(this.__stage,!1),this.__stage=e);for(var t=0;t<e.__childrenRemoved.length;t++)this.removeDisplayObject(e.__childrenRemoved[t]);for(var t=0;t<PIXI.texturesToUpdate.length;t++)this.updateTexture(PIXI.texturesToUpdate[t]);for(var t=0;t<PIXI.texturesToDestroy.length;t++)this.destroyTexture(PIXI.texturesToDestroy[t]);e.__childrenRemoved=[],e.__childrenAdded=[],PIXI.texturesToUpdate=[],PIXI.texturesToDestroy=[],this.checkVisibility(e,!0),e.updateTransform();var i=this.gl;i.clear(i.COLOR_BUFFER_BIT),i.clearColor(e.backgroundColorSplit[0],e.backgroundColorSplit[1],e.backgroundColorSplit[2],0),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,!1,this.projectionMatrix);for(var n,t=0;t<this.batchs.length;t++)n=this.batchs[t],n instanceof PIXI.WebGLBatch?this.batchs[t].render():n instanceof PIXI.TilingSprite?n.visible&&this.renderTilingSprite(n):n instanceof PIXI.Strip&&n.visible&&this.renderStrip(n);if(e.interactive&&(e._interactiveEventsAdded||(e._interactiveEventsAdded=!0,e.interactionManager.setTarget(this))),PIXI.Texture.frameUpdates.length>0){for(var t=0;t<PIXI.Texture.frameUpdates.length;t++)PIXI.Texture.frameUpdates[t].updateFrame=!1;PIXI.Texture.frameUpdates=[]}}},PIXI.WebGLRenderer.prototype.updateTexture=function(e){var t=this.gl;e._glTexture||(e._glTexture=t.createTexture()),e.hasLoaded&&(t.bindTexture(t.TEXTURE_2D,e._glTexture),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.source),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),e._powerOf2?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),t.bindTexture(t.TEXTURE_2D,null)),this.refreshBatchs=!0},PIXI.WebGLRenderer.prototype.destroyTexture=function(e){var t=this.gl;e._glTexture&&(e._glTexture=t.createTexture(),t.deleteTexture(t.TEXTURE_2D,e._glTexture))},PIXI.WebGLRenderer.prototype.addDisplayObject=function(e){if(e.stage&&!e.__inWebGL&&(e.batch=null,e.renderable)){e.__inWebGL=!0;var t=e;do{if(0==t.childIndex)t=t.parent;else for(t=t.parent.children[t.childIndex-1];0!=t.children.length;)t=t.children[t.children.length-1];if(t==e.stage)break}while(!t.renderable||!t.__inWebGL);var i=e;do{if(0==i.children.length){for(;i.childIndex==i.parent.children.length-1;)if(i=i.parent,i==e.stage){i=null;break}i&&(i=i.parent.children[i.childIndex+1])}else i=i.children[0];if(!i)break}while(!i.renderable||!i.__inWebGL);if(e instanceof PIXI.Sprite){var n,o;if(t instanceof PIXI.Sprite){if(n=t.batch,n&&n.texture==e.texture.baseTexture&&n.blendMode==e.blendMode)return n.insertAfter(e,t),void 0}else n=t;if(i)if(i instanceof PIXI.Sprite){if(o=i.batch){if(o.texture==e.texture.baseTexture&&o.blendMode==e.blendMode)return o.insertBefore(e,i),void 0;if(o==n){var s=n.split(i),r=this.getBatch(),a=this.batchs.indexOf(n);return r.init(e),this.batchs.splice(a+1,0,r,s),void 0}}}else o=i;var r=this.getBatch();if(r.init(e),n){var a=this.batchs.indexOf(n);this.batchs.splice(a+1,0,r)}else this.batchs.push(r)}else e instanceof PIXI.TilingSprite?(this.initTilingSprite(e),this.batchs.push(e)):e instanceof PIXI.Strip&&(this.initStrip(e),this.batchs.push(e));this.batchUpdate=!0}},PIXI.WebGLRenderer.prototype.removeDisplayObject=function(e){if(e.cacheVisible=!1,e.renderable){e.__inWebGL=!1;var t;if(e instanceof PIXI.Sprite){var i=e.batch;if(!i)return;i.remove(e),0==i.size&&(t=i)}else t=e;if(t){var n=this.batchs.indexOf(t);if(-1==n)return;if(0==n||n==this.batchs.length-1)return this.batchs.splice(n,1),t instanceof PIXI.WebGLBatch&&this.returnBatch(t),void 0;if(this.batchs[n-1]instanceof PIXI.WebGLBatch&&this.batchs[n+1]instanceof PIXI.WebGLBatch&&this.batchs[n-1].texture==this.batchs[n+1].texture&&this.batchs[n-1].blendMode==this.batchs[n+1].blendMode)return this.batchs[n-1].merge(this.batchs[n+1]),t instanceof PIXI.WebGLBatch&&this.returnBatch(t),this.returnBatch(this.batchs[n+1]),this.batchs.splice(n,2),void 0;this.batchs.splice(n,1),t instanceof PIXI.WebGLBatch&&this.returnBatch(t)}}},PIXI.WebGLRenderer.prototype.resize=function(e,t){this.width=e,this.height=t,this.view.width=e,this.view.height=t,this.gl.viewport(0,0,this.width,this.height);var i=this.projectionMatrix;i[0]=2/this.width,i[5]=-2/this.height,i[12]=-1,i[13]=1},PIXI.WebGLRenderer.prototype.initTilingSprite=function(e){var t=this.gl;e.verticies=new Float32Array([0,0,e.width,0,e.width,e.height,0,e.height]),e.uvs=new Float32Array([0,0,1,0,1,1,0,1]),e.colors=new Float32Array([1,1,1,1]),e.indices=new Uint16Array([0,1,3,2]),e._vertexBuffer=t.createBuffer(),e._indexBuffer=t.createBuffer(),e._uvBuffer=t.createBuffer(),e._colorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,e.verticies,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,e._uvBuffer),t.bufferData(t.ARRAY_BUFFER,e.uvs,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,e._colorBuffer),t.bufferData(t.ARRAY_BUFFER,e.colors,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW),e.texture.baseTexture._glTexture?(t.bindTexture(t.TEXTURE_2D,e.texture.baseTexture._glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),e.texture.baseTexture._powerOf2=!0):e.texture.baseTexture._powerOf2=!0},PIXI.WebGLRenderer.prototype.renderTilingSprite=function(e){var t=this.gl;this.shaderProgram;var i=e.tilePosition,n=e.tileScale,o=i.x/e.texture.baseTexture.width,s=i.y/e.texture.baseTexture.height,r=e.width/e.texture.baseTexture.width/n.x,a=e.height/e.texture.baseTexture.height/n.y;e.uvs[0]=0+o,e.uvs[1]=0-s,e.uvs[2]=1*r+o,e.uvs[3]=0-s,e.uvs[4]=1*r+o,e.uvs[5]=1*a-s,e.uvs[6]=0+o,e.uvs[7]=1*a-s,t.bindBuffer(t.ARRAY_BUFFER,e._uvBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e.uvs),this.renderStrip(e)},PIXI.WebGLRenderer.prototype.initStrip=function(e){var t=this.gl;this.shaderProgram,e._vertexBuffer=t.createBuffer(),e._indexBuffer=t.createBuffer(),e._uvBuffer=t.createBuffer(),e._colorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,e.verticies,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,e._uvBuffer),t.bufferData(t.ARRAY_BUFFER,e.uvs,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,e._colorBuffer),t.bufferData(t.ARRAY_BUFFER,e.colors,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW)},PIXI.WebGLRenderer.prototype.renderStrip=function(e){var t=this.gl,i=this.shaderProgram,n=PIXI.mat3.toMat4(e.worldTransform);PIXI.mat4.transpose(n),PIXI.mat4.multiply(this.projectionMatrix,n,n),t.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,!1,n),e.blendMode==PIXI.blendModes.NORMAL?t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA):t.blendFunc(t.ONE,t.ONE_MINUS_SRC_COLOR),e.dirty?(e.dirty=!1,t.bindBuffer(t.ARRAY_BUFFER,e._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,e.verticies,t.STATIC_DRAW),t.vertexAttribPointer(i.vertexPositionAttribute,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,e._uvBuffer),t.bufferData(t.ARRAY_BUFFER,e.uvs,t.STATIC_DRAW),t.vertexAttribPointer(i.textureCoordAttribute,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.texture.baseTexture._glTexture),t.bindBuffer(t.ARRAY_BUFFER,e._colorBuffer),t.bufferData(t.ARRAY_BUFFER,e.colors,t.STATIC_DRAW),t.vertexAttribPointer(i.colorAttribute,1,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW)):(t.bindBuffer(t.ARRAY_BUFFER,e._vertexBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e.verticies),t.vertexAttribPointer(i.vertexPositionAttribute,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,e._uvBuffer),t.vertexAttribPointer(i.textureCoordAttribute,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.texture.baseTexture._glTexture),t.bindBuffer(t.ARRAY_BUFFER,e._colorBuffer),t.vertexAttribPointer(i.colorAttribute,1,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e._indexBuffer)),t.drawElements(t.TRIANGLE_STRIP,e.indices.length,t.UNSIGNED_SHORT,0),t.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,!1,this.projectionMatrix)},PIXI.WebGLRenderer.prototype.handleContextLost=function(e){e.preventDefault(),this.contextLost=!0},PIXI.WebGLRenderer.prototype.handleContextRestored=function(){this.gl=this.view.getContext("experimental-webgl",{alpha:!0}),this.initShaders();for(var e=0;e<PIXI.TextureCache.length;e++)this.updateTexture(PIXI.TextureCache[e]);for(var e=0;e<this.batchs.length;e++)this.batchs[e].restoreLostContext(this.gl),this.batchs[e].dirty=!0;PIXI._restoreBatchs(this.gl),this.contextLost=!1},PIXI._batchs=[],PIXI._getBatch=function(e){return 0==PIXI._batchs.length?new PIXI.WebGLBatch(e):PIXI._batchs.pop()},PIXI._returnBatch=function(e){e.clean(),PIXI._batchs.push(e)},PIXI._restoreBatchs=function(e){for(var t=0;t<PIXI._batchs.length;t++)PIXI._batchs[t].restoreLostContext(e)},PIXI.WebGLBatch=function(e){this.gl=e,this.size=0,this.vertexBuffer=e.createBuffer(),this.indexBuffer=e.createBuffer(),this.uvBuffer=e.createBuffer(),this.colorBuffer=e.createBuffer(),this.blendMode=PIXI.blendModes.NORMAL,this.dynamicSize=1},PIXI.WebGLBatch.constructor=PIXI.WebGLBatch,PIXI.WebGLBatch.prototype.clean=function(){this.verticies=[],this.uvs=[],this.indices=[],this.colors=[],this.dynamicSize=1,this.texture=null,this.last=null,this.size=0,this.head,this.tail},PIXI.WebGLBatch.prototype.restoreLostContext=function(e){this.gl=e,this.vertexBuffer=e.createBuffer(),this.indexBuffer=e.createBuffer(),this.uvBuffer=e.createBuffer(),this.colorBuffer=e.createBuffer()},PIXI.WebGLBatch.prototype.init=function(e){e.batch=this,this.dirty=!0,this.blendMode=e.blendMode,this.texture=e.texture.baseTexture,this.head=e,this.tail=e,this.size=1,this.growBatch()},PIXI.WebGLBatch.prototype.insertBefore=function(e,t){this.size++,e.batch=this,this.dirty=!0;var i=t.__prev;t.__prev=e,e.__next=t,i?(e.__prev=i,i.__next=e):this.head=e},PIXI.WebGLBatch.prototype.insertAfter=function(e,t){this.size++,e.batch=this,this.dirty=!0;var i=t.__next;t.__next=e,e.__prev=t,i?(e.__next=i,i.__prev=e):this.tail=e},PIXI.WebGLBatch.prototype.remove=function(e){return this.size--,0==this.size?(e.batch=null,e.__prev=null,e.__next=null,void 0):(e.__prev?e.__prev.__next=e.__next:(this.head=e.__next,this.head.__prev=null),e.__next?e.__next.__prev=e.__prev:(this.tail=e.__prev,this.tail.__next=null),e.batch=null,e.__next=null,e.__prev=null,this.dirty=!0,void 0)},PIXI.WebGLBatch.prototype.split=function(e){this.dirty=!0;var t=new PIXI.WebGLBatch(this.gl);t.init(e),t.tail=this.tail,this.tail=e.__prev,this.tail.__next=null,e.__prev=null;for(var i=0;e;)i++,e.batch=t,e=e.__next;return t.size=i,this.size-=i,t},PIXI.WebGLBatch.prototype.merge=function(e){this.dirty=!0,this.tail.__next=e.head,e.head.__prev=this.tail,this.size+=e.size,this.tail=e.tail;for(var t=e.head;t;)t.batch=this,t=t.__next},PIXI.WebGLBatch.prototype.growBatch=function(){var e=this.gl;this.dynamicSize=1==this.size?1:1.5*this.size,this.verticies=new Float32Array(8*this.dynamicSize),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.verticies,e.DYNAMIC_DRAW),this.uvs=new Float32Array(8*this.dynamicSize),e.bindBuffer(e.ARRAY_BUFFER,this.uvBuffer),e.bufferData(e.ARRAY_BUFFER,this.uvs,e.DYNAMIC_DRAW),this.dirtyUVS=!0,this.colors=new Float32Array(4*this.dynamicSize),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,this.colors,e.DYNAMIC_DRAW),this.dirtyColors=!0,this.indices=new Uint16Array(6*this.dynamicSize);for(var t=this.indices.length/6,i=0;t>i;i++){var n=6*i,o=4*i;this.indices[n+0]=o+0,this.indices[n+1]=o+1,this.indices[n+2]=o+2,this.indices[n+3]=o+0,this.indices[n+4]=o+2,this.indices[n+5]=o+3}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.indices,e.STATIC_DRAW)},PIXI.WebGLBatch.prototype.refresh=function(){this.gl,this.dynamicSize<this.size&&this.growBatch();for(var e,t=0,i=this.head;i;){e=8*t;var n=i.texture,o=n.frame,s=n.baseTexture.width,r=n.baseTexture.height;this.uvs[e+0]=o.x/s,this.uvs[e+1]=o.y/r,this.uvs[e+2]=(o.x+o.width)/s,this.uvs[e+3]=o.y/r,this.uvs[e+4]=(o.x+o.width)/s,this.uvs[e+5]=(o.y+o.height)/r,this.uvs[e+6]=o.x/s,this.uvs[e+7]=(o.y+o.height)/r,i.updateFrame=!1,colorIndex=4*t,this.colors[colorIndex]=this.colors[colorIndex+1]=this.colors[colorIndex+2]=this.colors[colorIndex+3]=i.worldAlpha,i=i.__next,t++}this.dirtyUVS=!0,this.dirtyColors=!0},PIXI.WebGLBatch.prototype.update=function(){this.gl;for(var e,t,i,n,o,s,r,a,l,u,d,h,c,p,f,m,g=0,v=this.head;v;){if(t=v.texture.frame.width,i=v.texture.frame.height,n=v.anchor.x-v.texture.trim.x,o=v.anchor.y-v.texture.trim.y,s=t*(1-n),r=t*-n,a=i*(1-o),l=i*-o,u=8*g,e=v.worldTransform,d=e[0],h=e[3],c=e[1],p=e[4],f=e[2],m=e[5],this.verticies[u+0]=d*r+c*l+f,this.verticies[u+1]=p*l+h*r+m,this.verticies[u+2]=d*s+c*l+f,this.verticies[u+3]=p*l+h*s+m,this.verticies[u+4]=d*s+c*a+f,this.verticies[u+5]=p*a+h*s+m,this.verticies[u+6]=d*r+c*a+f,this.verticies[u+7]=p*a+h*r+m,v.updateFrame||v.texture.updateFrame){this.dirtyUVS=!0;var b=v.texture,w=b.frame,y=b.baseTexture.width,_=b.baseTexture.height;this.uvs[u+0]=w.x/y,this.uvs[u+1]=w.y/_,this.uvs[u+2]=(w.x+w.width)/y,this.uvs[u+3]=w.y/_,this.uvs[u+4]=(w.x+w.width)/y,this.uvs[u+5]=(w.y+w.height)/_,this.uvs[u+6]=w.x/y,this.uvs[u+7]=(w.y+w.height)/_,v.updateFrame=!1}if(v.cacheAlpha!=v.worldAlpha){v.cacheAlpha=v.worldAlpha;var x=4*g;this.colors[x]=this.colors[x+1]=this.colors[x+2]=this.colors[x+3]=v.worldAlpha,this.dirtyColors=!0}g++,v=v.__next}},PIXI.WebGLBatch.prototype.render=function(){if(this.dirty&&(this.refresh(),this.dirty=!1),0!=this.size){this.update();var e=this.gl;this.blendMode==PIXI.blendModes.NORMAL?e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA):e.blendFunc(e.ONE,e.ONE_MINUS_SRC_COLOR);var t=PIXI.shaderProgram;e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this.verticies),e.vertexAttribPointer(t.vertexPositionAttribute,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.uvBuffer),this.dirtyUVS&&(this.dirtyUVS=!1,e.bufferSubData(e.ARRAY_BUFFER,0,this.uvs)),e.vertexAttribPointer(t.textureCoordAttribute,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture._glTexture),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),this.dirtyColors&&(this.dirtyColors=!1,e.bufferSubData(e.ARRAY_BUFFER,0,this.colors)),e.vertexAttribPointer(t.colorAttribute,1,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.drawElements(e.TRIANGLES,6*this.size,e.UNSIGNED_SHORT,0)}},PIXI.CanvasRenderer=function(e,t,i,n){this.transparent=n,this.width=e||800,this.height=t||600,this.refresh=!0,this.view=i||document.createElement("canvas"),this.view.width=this.width,this.view.height=this.height,this.count=0,this.context=this.view.getContext("2d")
},PIXI.CanvasRenderer.constructor=PIXI.CanvasRenderer,PIXI.CanvasRenderer.prototype.render=function(e){e.__childrenAdded=[],e.__childrenRemoved=[],PIXI.texturesToUpdate=[],PIXI.texturesToDestroy=[],this.context.setTransform(1,0,0,1,0,0),e.updateTransform(),this.context.setTransform(1,0,0,1,0,0),this.view.style.backgroundColor==e.backgroundColorString||this.transparent||(this.view.style.backgroundColor=e.backgroundColorString),this.context.clearRect(0,0,this.width,this.height),this.renderDisplayObject(e),e.interactive&&(e._interactiveEventsAdded||(e._interactiveEventsAdded=!0,e.interactionManager.setTarget(this))),PIXI.Texture.frameUpdates.length>0&&(PIXI.Texture.frameUpdates=[])},PIXI.CanvasRenderer.prototype.resize=function(e,t){this.width=e,this.height=t,this.view.width=e,this.view.height=t},PIXI.CanvasRenderer.prototype.renderDisplayObject=function(e){var t=e.worldTransform,i=this.context;i.globalCompositeOperation=e.globalCompositeOperation||"source-over";var n=!1;if(e.visible){if(e instanceof PIXI.Sprite){var o=e.texture.frame;o&&(i.globalAlpha=e.worldAlpha,n=!1,i.setTransform(t[0],t[3],t[1],t[4],t[2],t[5]),i.drawImage(e.texture.baseTexture.source,o.x,o.y,o.width,o.height,(e.anchor.x-e.texture.trim.x)*-o.width,(e.anchor.y-e.texture.trim.y)*-o.height,o.width,o.height))}else e instanceof PIXI.Strip?(i.setTransform(t[0],t[3],t[1],t[4],t[2],t[5]),this.renderStrip(e)):e instanceof PIXI.TilingSprite&&(i.setTransform(t[0],t[3],t[1],t[4],t[2],t[5]),this.renderTilingSprite(e));for(var s=0;s<e.children.length;s++)this.renderDisplayObject(e.children[s])}},PIXI.CanvasRenderer.prototype.renderStripFlat=function(e){var t=this.context,i=e.verticies;e.uvs;var n=i.length/2;this.count++,t.beginPath();for(var o=1;n-2>o;o++){var s=2*o,r=i[s],a=i[s+2],l=i[s+4],u=i[s+1],d=i[s+3],h=i[s+5];t.moveTo(r,u),t.lineTo(a,d),t.lineTo(l,h)}t.fillStyle="#FF0000",t.fill(),t.closePath()},PIXI.CanvasRenderer.prototype.renderTilingSprite=function(e){var t=this.context;e.__tilePattern||(e.__tilePattern=t.createPattern(e.texture.baseTexture.source,"repeat")),t.beginPath();var i=e.tilePosition,n=e.tileScale;t.scale(n.x,n.y),t.translate(i.x,i.y),t.fillStyle=e.__tilePattern,t.fillRect(-i.x,-i.y,e.width/n.x,e.height/n.y),t.scale(1/n.x,1/n.y),t.translate(-i.x,-i.y),t.closePath()},PIXI.CanvasRenderer.prototype.renderStrip=function(e){var t=this.context,i=e.verticies,n=e.uvs,o=i.length/2;this.count++;for(var s=1;o-2>s;s++){var r=2*s,a=i[r],l=i[r+2],u=i[r+4],d=i[r+1],h=i[r+3],c=i[r+5],p=n[r]*e.texture.width,f=n[r+2]*e.texture.width,m=n[r+4]*e.texture.width,g=n[r+1]*e.texture.height,v=n[r+3]*e.texture.height,b=n[r+5]*e.texture.height;t.save(),t.beginPath(),t.moveTo(a,d),t.lineTo(l,h),t.lineTo(u,c),t.closePath(),t.clip();var w=p*v+g*m+f*b-v*m-g*f-p*b,y=a*v+g*u+l*b-v*u-g*l-a*b,_=p*l+a*m+f*u-l*m-a*f-p*u,x=p*v*u+g*l*m+a*f*b-a*v*m-g*f*u-p*l*b,S=d*v+g*c+h*b-v*c-g*h-d*b,k=p*h+d*m+f*c-h*m-d*f-p*c,C=p*v*c+g*h*m+d*f*b-d*v*m-g*f*c-p*h*b;t.transform(y/w,S/w,_/w,k/w,x/w,C/w),t.drawImage(e.texture.baseTexture.source,0,0),t.restore()}},PIXI.Strip=function(e,t,i){PIXI.DisplayObjectContainer.call(this),this.texture=e,this.blendMode=PIXI.blendModes.NORMAL;try{this.uvs=new Float32Array([0,1,1,1,1,0,0,1]),this.verticies=new Float32Array([0,0,0,0,0,0,0,0,0]),this.colors=new Float32Array([1,1,1,1]),this.indices=new Uint16Array([0,1,2,3])}catch(n){this.uvs=[0,1,1,1,1,0,0,1],this.verticies=[0,0,0,0,0,0,0,0,0],this.colors=[1,1,1,1],this.indices=[0,1,2,3]}this.width=t,this.height=i,e.baseTexture.hasLoaded?(this.width=this.texture.frame.width,this.height=this.texture.frame.height,this.updateFrame=!0):(this.onTextureUpdateBind=this.onTextureUpdate.bind(this),this.texture.addEventListener("update",this.onTextureUpdateBind)),this.renderable=!0},PIXI.Strip.constructor=PIXI.Strip,PIXI.Strip.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),PIXI.Strip.prototype.setTexture=function(e){this.texture=e,this.width=e.frame.width,this.height=e.frame.height,this.updateFrame=!0},PIXI.Strip.prototype.onTextureUpdate=function(){this.updateFrame=!0},PIXI.Rope=function(e,t){PIXI.Strip.call(this,e),this.points=t;try{this.verticies=new Float32Array(4*t.length),this.uvs=new Float32Array(4*t.length),this.colors=new Float32Array(2*t.length),this.indices=new Uint16Array(2*t.length)}catch(i){this.verticies=verticies,this.uvs=uvs,this.colors=colors,this.indices=indices}this.refresh()},PIXI.Rope.constructor=PIXI.Rope,PIXI.Rope.prototype=Object.create(PIXI.Strip.prototype),PIXI.Rope.prototype.refresh=function(){var e=this.points;if(!(e.length<1)){var t=this.uvs,i=this.indices,n=this.colors,o=e[0],s=e[0];this.count-=.2,t[0]=0,t[1]=1,t[2]=0,t[3]=1,n[0]=1,n[1]=1,i[0]=0,i[1]=1;for(var r=e.length,a=1;r>a;a++){var s=e[a],l=4*a,u=a/(r-1);a%2?(t[l]=u,t[l+1]=0,t[l+2]=u,t[l+3]=1):(t[l]=u,t[l+1]=0,t[l+2]=u,t[l+3]=1),l=2*a,n[l]=1,n[l+1]=1,l=2*a,i[l]=l,i[l+1]=l+1,o=s}}},PIXI.Rope.prototype.updateTransform=function(){var e=this.points;if(!(e.length<1)){var t,i=this.verticies,n=e[0],o={x:0,y:0},s=e[0];this.count-=.2,i[0]=s.x+o.x,i[1]=s.y+o.y,i[2]=s.x-o.x,i[3]=s.y-o.y;for(var r=e.length,a=1;r>a;a++){var s=e[a],l=4*a;t=a<e.length-1?e[a+1]:s,o.y=-(t.x-n.x),o.x=t.y-n.y;var u=10*(1-a/(r-1));u>1&&(u=1);var d=Math.sqrt(o.x*o.x+o.y*o.y),h=this.texture.height/2;o.x/=d,o.y/=d,o.x*=h,o.y*=h,i[l]=s.x+o.x,i[l+1]=s.y+o.y,i[l+2]=s.x-o.x,i[l+3]=s.y-o.y,n=s}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)}},PIXI.Rope.prototype.setTexture=function(e){this.texture=e,this.updateFrame=!0},PIXI.TilingSprite=function(e,t,i){PIXI.DisplayObjectContainer.call(this),this.texture=e,this.width=t,this.height=i,this.renderable=!0,this.tileScale=new PIXI.Point(2,1),this.tilePosition=new PIXI.Point(0,0),this.blendMode=PIXI.blendModes.NORMAL},PIXI.TilingSprite.constructor=PIXI.TilingSprite,PIXI.TilingSprite.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),PIXI.TilingSprite.prototype.setTexture=function(e){this.texture=e,this.updateFrame=!0},PIXI.TilingSprite.prototype.onTextureUpdate=function(){this.updateFrame=!0},PIXI.BaseTextureCache={},PIXI.texturesToUpdate=[],PIXI.texturesToDestroy=[],PIXI.BaseTexture=function(e){if(PIXI.EventTarget.call(this),this.width=100,this.height=100,this.source=e,this.source instanceof Image)if(this.source.complete)this.hasLoaded=!0,this.width=this.source.width,this.height=this.source.height,PIXI.texturesToUpdate.push(this);else{var t=this;this.source.onload=function(){t.hasLoaded=!0,t.width=t.source.width,t.height=t.source.height,PIXI.texturesToUpdate.push(t),t.dispatchEvent({type:"loaded",content:t})}}else this.hasLoaded=!0,this.width=this.source.width,this.height=this.source.height,PIXI.texturesToUpdate.push(this);this._powerOf2=!1},PIXI.BaseTexture.constructor=PIXI.BaseTexture,PIXI.BaseTexture.prototype.destroy=function(){this.source instanceof Image&&(this.source.src=null),this.source=null,PIXI.texturesToDestroy.push(this)},PIXI.BaseTexture.fromImage=function(e,t){var i=PIXI.BaseTextureCache[e];if(!i){var n=new Image;t&&(n.crossOrigin=""),n.src=e,i=new PIXI.BaseTexture(n),PIXI.BaseTextureCache[e]=i}return i},PIXI.TextureCache={},PIXI.FrameCache={},PIXI.Texture=function(e,t){if(PIXI.EventTarget.call(this),t||(this.noFrame=!0,t=new PIXI.Rectangle(0,0,1,1)),this.trim=new PIXI.Point,e instanceof PIXI.Texture&&(e=e.baseTexture),this.baseTexture=e,this.frame=t,this.scope=this,e.hasLoaded)this.noFrame&&(t=new PIXI.Rectangle(0,0,e.width,e.height)),this.setFrame(t);else{var i=this;e.addEventListener("loaded",function(){i.onBaseTextureLoaded()})}},PIXI.Texture.constructor=PIXI.Texture,PIXI.Texture.prototype.onBaseTextureLoaded=function(){var e=this.baseTexture;e.removeEventListener("loaded",this.onLoaded),this.noFrame&&(this.frame=new PIXI.Rectangle(0,0,e.width,e.height)),this.noFrame=!1,this.width=this.frame.width,this.height=this.frame.height,this.scope.dispatchEvent({type:"update",content:this})},PIXI.Texture.prototype.destroy=function(e){e&&this.baseTexture.destroy()},PIXI.Texture.prototype.setFrame=function(e){if(this.frame=e,this.width=e.width,this.height=e.height,e.x+e.width>this.baseTexture.width||e.y+e.height>this.baseTexture.height)throw new Error("Texture Error: frame does not fit inside the base Texture dimensions "+this);this.updateFrame=!0,PIXI.Texture.frameUpdates.push(this)},PIXI.Texture.fromImage=function(e,t){var i=PIXI.TextureCache[e];return i||(i=new PIXI.Texture(PIXI.BaseTexture.fromImage(e,t)),PIXI.TextureCache[e]=i),i},PIXI.Texture.fromFrame=function(e){var t=PIXI.TextureCache[e];if(!t)throw new Error("The frameId '"+e+"' does not exist in the texture cache "+this);return t},PIXI.Texture.fromCanvas=function(e){var t=new PIXI.BaseTexture(e);return new PIXI.Texture(t)},PIXI.Texture.addTextureToCache=function(e,t){PIXI.TextureCache[t]=e},PIXI.Texture.removeTextureFromCache=function(e){var t=PIXI.TextureCache[e];return PIXI.TextureCache[e]=null,t},PIXI.Texture.frameUpdates=[],PIXI.AssetLoader=function(e){PIXI.EventTarget.call(this),this.assetURLs=e,this.crossorigin=!1,this.loadersByType={jpg:PIXI.ImageLoader,jpeg:PIXI.ImageLoader,png:PIXI.ImageLoader,gif:PIXI.ImageLoader,json:PIXI.SpriteSheetLoader,xml:PIXI.BitmapFontLoader,fnt:PIXI.BitmapFontLoader}},PIXI.AssetLoader.constructor=PIXI.AssetLoader,PIXI.AssetLoader.prototype.load=function(){var e=this;this.loadCount=this.assetURLs.length;for(var t=0;t<this.assetURLs.length;t++){var i=this.assetURLs[t],n=i.split(".").pop().toLowerCase(),o=this.loadersByType[n];if(!o)throw new Error(n+" is an unsupported file type");var s=new o(i,this.crossorigin);s.addEventListener("loaded",function(){e.onAssetLoaded()}),s.load()}},PIXI.AssetLoader.prototype.onAssetLoaded=function(){this.loadCount--,this.dispatchEvent({type:"onProgress",content:this}),this.onProgress&&this.onProgress(),0==this.loadCount&&(this.dispatchEvent({type:"onComplete",content:this}),this.onComplete&&this.onComplete())},PIXI.SpriteSheetLoader=function(e,t){PIXI.EventTarget.call(this),this.url=e,this.baseUrl=e.replace(/[^\/]*$/,""),this.texture=null,this.frames={},this.crossorigin=t},PIXI.SpriteSheetLoader.constructor=PIXI.SpriteSheetLoader,PIXI.SpriteSheetLoader.prototype.load=function(){this.ajaxRequest=new AjaxRequest;var e=this;this.ajaxRequest.onreadystatechange=function(){e.onJSONLoaded()},this.ajaxRequest.open("GET",this.url,!0),this.ajaxRequest.overrideMimeType&&this.ajaxRequest.overrideMimeType("application/json"),this.ajaxRequest.send(null)},PIXI.SpriteSheetLoader.prototype.onJSONLoaded=function(){if(4==this.ajaxRequest.readyState&&(200==this.ajaxRequest.status||-1==window.location.href.indexOf("http"))){var jsonData=eval("("+this.ajaxRequest.responseText+")"),textureUrl=this.baseUrl+jsonData.meta.image,image=new PIXI.ImageLoader(textureUrl,this.crossorigin);this.texture=image.texture.baseTexture;var scope=this;image.addEventListener("loaded",function(){scope.onLoaded()});var frameData=jsonData.frames;for(var i in frameData){var rect=frameData[i].frame;rect&&(PIXI.TextureCache[i]=new PIXI.Texture(this.texture,{x:rect.x,y:rect.y,width:rect.w,height:rect.h}),frameData[i].trimmed&&(PIXI.TextureCache[i].realSize=frameData[i].spriteSourceSize,PIXI.TextureCache[i].trim.x=0))}image.load()}},PIXI.SpriteSheetLoader.prototype.onLoaded=function(){this.dispatchEvent({type:"loaded",content:this})},PIXI.ImageLoader=function(e,t){PIXI.EventTarget.call(this),this.texture=PIXI.Texture.fromImage(e,t)},PIXI.ImageLoader.constructor=PIXI.ImageLoader,PIXI.ImageLoader.prototype.load=function(){if(this.texture.baseTexture.hasLoaded)this.onLoaded();else{var e=this;this.texture.baseTexture.addEventListener("loaded",function(){e.onLoaded()})}},PIXI.ImageLoader.prototype.onLoaded=function(){this.dispatchEvent({type:"loaded",content:this})},PIXI.BitmapFontLoader=function(e,t){PIXI.EventTarget.call(this),this.url=e,this.baseUrl=e.replace(/[^\/]*$/,""),this.texture=null,this.crossorigin=t},PIXI.BitmapFontLoader.constructor=PIXI.BitmapFontLoader,PIXI.BitmapFontLoader.prototype.load=function(){this.ajaxRequest=new XMLHttpRequest;var e=this;this.ajaxRequest.onreadystatechange=function(){e.onXMLLoaded()},this.ajaxRequest.open("GET",this.url,!0),this.ajaxRequest.overrideMimeType&&this.ajaxRequest.overrideMimeType("application/xml"),this.ajaxRequest.send(null)},PIXI.BitmapFontLoader.prototype.onXMLLoaded=function(){if(4==this.ajaxRequest.readyState&&(200==this.ajaxRequest.status||-1==window.location.href.indexOf("http"))){var e=this.baseUrl+this.ajaxRequest.responseXML.getElementsByTagName("page")[0].attributes.getNamedItem("file").nodeValue,t=new PIXI.ImageLoader(e,this.crossorigin);this.texture=t.texture.baseTexture;var i={},n=this.ajaxRequest.responseXML.getElementsByTagName("info")[0],o=this.ajaxRequest.responseXML.getElementsByTagName("common")[0];i.font=n.attributes.getNamedItem("face").nodeValue,i.size=parseInt(n.attributes.getNamedItem("size").nodeValue,10),i.lineHeight=parseInt(o.attributes.getNamedItem("lineHeight").nodeValue,10),i.chars={};for(var s=this.ajaxRequest.responseXML.getElementsByTagName("char"),r=0;r<s.length;r++){var a=parseInt(s[r].attributes.getNamedItem("id").nodeValue,10),l={x:parseInt(s[r].attributes.getNamedItem("x").nodeValue,10),y:parseInt(s[r].attributes.getNamedItem("y").nodeValue,10),width:parseInt(s[r].attributes.getNamedItem("width").nodeValue,10),height:parseInt(s[r].attributes.getNamedItem("height").nodeValue,10)};PIXI.TextureCache[a]=new PIXI.Texture(this.texture,l),i.chars[a]={xOffset:parseInt(s[r].attributes.getNamedItem("xoffset").nodeValue,10),yOffset:parseInt(s[r].attributes.getNamedItem("yoffset").nodeValue,10),xAdvance:parseInt(s[r].attributes.getNamedItem("xadvance").nodeValue,10),kerning:{}}}var u=this.ajaxRequest.responseXML.getElementsByTagName("kerning");for(r=0;r<u.length;r++){var d=parseInt(u[r].attributes.getNamedItem("first").nodeValue,10),h=parseInt(u[r].attributes.getNamedItem("second").nodeValue,10),c=parseInt(u[r].attributes.getNamedItem("amount").nodeValue,10);i.chars[h].kerning[d]=c}PIXI.BitmapText.fonts[i.font]=i;var p=this;t.addEventListener("loaded",function(){p.onLoaded()}),t.load()}},PIXI.BitmapFontLoader.prototype.onLoaded=function(){this.dispatchEvent({type:"loaded",content:this})},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=PIXI),exports.PIXI=PIXI):root.PIXI=PIXI}.call(this),define("pixi",function(e){return function(){var t;return t||e.PIXI}}(this)),define("blackswan/animator",["require","backbone","tt-base"],function(e){var t=(e("backbone"),e("tt-base")),i=t.Class.extend({init:function(){this.animationQueue=[]},pushAnimation:function(e){if(!e.duration)throw"animation must have a non-zero duration";this.animationQueue.push(e)},next:function(e){var t=this.nextAnimation();if(t){if(!this.animating)return this._shiftAnimation(e),void 0;if(this.nextAnimationStartTime)this.animationQueue.shift();else{var i=this.animation.duration,n="number"==typeof e?e:Date.now(),o=n-this.startTime,s=i?Math.max(1,Math.ceil(o/i)):1;this.nextAnimationStartTime=this.startTime+i*s}this.trigger("changing",this,t)}},_shiftAnimation:function(e){var t=this.animationQueue.shift();this.startTime="number"==typeof e?e:Date.now(),this.nextAnimationStartTime=void 0,this.animation&&this.animation===t||this.trigger("change",this,t),this.animation=t},nextAnimation:function(){return this.animationQueue[0]},clearAnimationQueue:function(){this.animationQueue=[]},start:function(e){this.stopTime=void 0,this.animating||(this.startTime="number"==typeof e?e:Date.now(),this.animating=!0,this.trigger("start",this))},stop:function(e){this.animating&&(e=Date.now(),this.stopTime=this._nextLoopStartTime(e),this.trigger("stopping",this))},_stop:function(){this.animating=!1,this.animation=void 0,this.startTime=void 0,this.stopTime=void 0,this.trigger("stop",this)},_nextLoopStartTime:function(e){e="number"==typeof e?e:Date.now();var t=this.animation.duration,i=e-this.startTime,n=t?Math.max(1,Math.ceil(i/t)):1;return this.startTime+t*n},tick:function(e){if(this.animating){if(e="number"==typeof e?e:Date.now(),void 0!==this.stopTime&&e>this.stopTime)return this._stop(),void 0;var t=this.animation,i=this.startTime,n=t?t.duration:0,o=this.nextAnimationStartTime;if(!t||!t.loop&&e>i+n||void 0!==o&&e>o){var s=this.nextAnimation();if(!s)return this._stop(),void 0;var r=void 0!==o?o:i+n;this._shiftAnimation(r),t=this.animation,n=t.duration}var a=e-this.startTime,l=a%n;0>l&&(l+=n),this.timeSinceLoopStart=l}},getCurrentState:function(e){return this.tick(e),{animating:this.animating,animation:this.animation,timeSinceLoopStart:this.timeSinceLoopStart}}});return i}),define("canvas",["require"],function(){var e=function(e,t){var i=document.createElement("canvas");return i.width=e,i.height=t,i};return e}),define("lib/underscore.deepExtend",["require","underscore"],function(e){var t,i,n,o,s,r,a=e("underscore"),l=[].slice;n=function(e){var t,i;return!a.isObject(e)||a.isFunction(e)?e:a.isDate(e)?new Date(e.getTime()):a.isRegExp(e)?new RegExp(e.source,e.toString().replace(/.*\//,"")):(i=a.isArray(e||a.isArguments(e)),t=function(e,t,o){return i?e.push(n(t)):e[o]=n(t),e},a.reduce(e,t,i?[]:{}))},r=function(e){return!(a.isNull(e)||e.prototype!=={}.prototype&&e.prototype!==Object.prototype||!a.isObject(e)||a.isArray(e)||a.isFunction(e)||a.isDate(e)||a.isRegExp(e)||a.isArguments(e))},i=function(e){return a.filter(a.keys(e),function(t){return r(e[t])})},t=function(e){return a.filter(a.keys(e),function(t){return a.isArray(e[t])})},s=function(e,n,o){var r,l,u,d,h,c,p,f,m,g;if(null==o&&(o=20),0>=o)return console.warn("_.deepExtend(): Maximum depth of recursion hit."),a.extend(e,n);for(c=a.intersection(i(e),i(n)),l=function(t){return n[t]=s(e[t],n[t],o-1)},p=0,m=c.length;m>p;p++)h=c[p],l(h);for(d=a.intersection(t(e),t(n)),r=function(t){return n[t]=a.union(e[t],n[t])},f=0,g=d.length;g>f;f++)u=d[f],r(u);return a.extend(e,n)},o=function(){var e,t,i,o;if(i=2<=arguments.length?l.call(arguments,0,o=arguments.length-1):(o=0,[]),t=arguments[o++],a.isNumber(t)||(i.push(t),t=20),i.length<=1)return i[0];if(0>=t)return a.extend.apply(this,i);for(e=i.shift();i.length>0;)e=s(e,n(i.shift()),t);return e},a.mixin({deepClone:n,isBasicObject:r,basicObjects:i,arrays:t,deepExtend:o})}),define("blackswan/tweener",["require","underscore","class","lib/underscore.deepExtend"],function(e){var t=e("underscore"),i=e("class");e("lib/underscore.deepExtend");var n=function(e){var i={};return t.each(e,function(e,n){if("duration"!==n){var o=n.split(",");o.length>1?t.each(n.split(","),function(n){i[n]=t.isObject(e)&&!t.isArray(e)?t.extend({},e):e}):i[n]=e}}),i},o={},s=i.extend({init:function(e){var t=this.animationId=e.animationId;this.keyframes=e.keyframes,this.frameRate=e.frameRate,this.msPerFrame=1e3/this.frameRate,this.frameCache=[],t&&(o[t]&&o[t][this.frameRate]?this.frameCache=o[t][this.frameRate]:(o[t]=o[t]||{},o[t][this.frameRate]=this.frameCache))},tween:function(e){var i=this.frameCache,o=this.msPerFrame,s=Math.floor(e/o);if(!i[s])for(var r,a,l=s*o,u={},d=this.keyframes,h=d.length,c=0;h>c;c++){if(r=d[c],a=n(r),c===h-1&&(l=Math.min(l,r.duration)),l<=r.duration){var p=l/r.duration,f=t.deepClone(u);t.each(a,function(e,i){f[i]||(f[i]={});var n=f[i];t.each(e,function(e,i){if(t.isNumber(e)){var o=t.isNumber(n[i])?n[i]:0;n[i]=(e-o)*p+o}})}),i[s]=f;break}l-=r.duration,t.deepExtend(u,a)}return t.clone(i[s])}});return s}),define("blackswan/avatar-spriter",["require","underscore","canvas","blackswan/tweener"],function(e){var t=e("underscore"),i=e("canvas"),n=e("blackswan/tweener"),o=function(e,o,r,l,u){var d=1e3/u,h=l.keyframes,c=l.duration,p=Math.floor(c/d);h||(p=1);var f,m="back"===r?"size":"frontSize",g=e[m],v=2*g[0],b=2*g[1],w=Math.floor(g[0]/2),y=Math.floor(g[1]/2),_=new i(v,b*p),x=_.getContext("2d");x.patternQuality="best",h&&(f=new n({animationId:l.id,keyframes:h,frameRate:u})),x.save(),x.translate(w,y);for(var S,k,C=0;p>C;C++)S=C*d,h&&(k=f.tween(S)),"frames"in e&&r in e.frames&&l.id in e.frames[r]&&u in e.frames[r][l.id]&&(k.hf.swap=C%e.frames[r][l.id][u].length),a(e.states[r],o,k,x),x.translate(0,b);x.restore();var T,I,M,P,$,A=[];for(C=0;p>C;C++)$=x.getImageData(0,b*C,v,b),A[C]=s($,v,b);T=Math.min.apply(null,t.pluck(A,"minX")),I=Math.max.apply(null,t.pluck(A,"maxX")),M=Math.min.apply(null,t.pluck(A,"minY")),P=Math.max.apply(null,t.pluck(A,"maxY"));var E=I-T,D=P-M,R=Math.floor(Math.sqrt(p)),L=Math.ceil(p/R),O=new i(E*R,D*L),j=O.getContext("2d");j.patternQuality="best";var F=0,B=0;for(C=0;p>C;C++)$=x.getImageData(T,b*C+M,E,D),j.putImageData($,F*E,B*D),F++,F===R&&(F=0,B++);var N=T-Math.floor(w+g[0]/2),z=M-(y+g[1]);return{canvas:O,offset:[N,z],size:[E,D],numFrames:p,numFramesX:R}},s=function(e,t,i){for(var n,o,s,r,a=e.data,l=!1,u=0;i>u;u++){for(var d=u*t,h=!1,c=!1,p=0,f=0;t>f;f++)a[4*(d+f)+3]&&(h||(l||(s=u,l=!0),r=u,h=!0),c||(n=void 0===n?f:Math.min(n,f),c=!0),p=f);p&&(o=void 0===o?p:Math.max(o,p))}return{minX:n,maxX:o+1,minY:s,maxY:r+1}},r=function(e,t){for(var i=[],n=[],o=[],s=[],r=0,a=e.length;a>r;r++){var l=e[r],u=t[l.name],d=l.offset[0],h=l.offset[1];i[r]=d,n[r]=h,o[r]=d+u.width,s[r]=h+u.height}var c={left:Math.min.apply(Math,i),top:Math.min.apply(Math,n),right:Math.max.apply(Math,o),bottom:Math.max.apply(Math,s)};return c.width=c.right-c.left,c.height=c.bottom-c.top,c},a=function(e,t,i,n){i=i||{};for(var o=0,s=e.length;s>o;o++){var r=e[o],a=r.name,l=t[a],u=i[a];if(u&&"swap"in u&&null!=u.swap&&(l=t[u.swap]),!l||!l.width||!l.height)throw"image not loaded: "+l.src;var d=l.width/2,h=l.height/2,c=r.offset[0],p=r.offset[1],f=0;u&&(c+=u.x||0,p+=u.y||0,f=(u.angle||0)*Math.PI/180),f?(n.save(),n.translate(c+d,p+h),n.rotate(f),n.drawImage(l,-d,-h,l.width,l.height),n.restore()):n.drawImage(l,c,p,l.width,l.height)}},l=function(e,t){var n=new i(e.width,e.height),o=n.getContext("2d");return o.patternQuality="best",o.drawImage(e,0,0),o.globalCompositeOperation="source-atop",o.fillStyle=t,o.fillRect(0,0,e.width,e.height),n};return{calculateStaticBoundingBox:r,drawFrame:a,shadeImage:l,makeSprite:o}}),define("models/avatar",["require","tt-base","blackswan/avatar-spriter"],function(e){var t=e("tt-base"),i=e("blackswan/avatar-spriter"),n={x:0,y:1},o=t.Model.extend({init:function(){var e=this.get("images"),t=this;this.images={};var i=_.map(e,function(e,i){var n=util.createImageWithLoader(e);return t.images[i]=n[0],n[1]});this.loading=$.when.apply($,i)},reversePartLayers:function(e){var t=this.get("states");if(!_.has(t,e))throw"invalid state name";t[e].reverse(),this.unset("states",{silent:!0}),this.set("states",t)},setPartOffset:function(e,t,o,s){for(var r,a=this.get("states"),l=a[e],u=0,d=l.length;d>u;u++)if(r=l[u],r.name===t){r.offset[n[o]]=s;break}var h=this;this.loading.done(function(){for(var t,n=i.calculateStaticBoundingBox(l,h.images),o=0,s=l.length;s>o;o++)t=l[o],t.offset[0]-=n.left,t.offset[1]-=n.top;var r={states:a},u="back"===e?"size":"frontSize";r[u]=[n.width,n.height],h.unset("states",{silent:!0}),h.set(r)})},isNew:function(){return this.get("files")},sync:function(e,t){if(["create","update"].indexOf(e)>=0){var i=new FormData;i.append("action","create"===e?"create":"edit"),i.append("avatar_type",t.get("type")),i.append("number",t.get("avatarId")),i.append("name",t.get("name")||null),i.append("userid",t.get("userId"));var n=t.get("files");if(n)for(var o=0;o<n.length;o++)i.append("file_"+n[o].name.replace(".png",""),n[o]);var s=_.clone(t.attributes);delete s.images,i.append("settings",JSON.stringify(s));var r=new XMLHttpRequest;r.open("POST","/admin/avatar"),r.onload=function(){200===r.status?LOG("all done: "+r.status):LOG("Something went terribly wrong...");var e=JSON.parse(r.responseText);alert(e[1].message)},r.send(i)}}},{_name:"Avatar"});return o}),define("blackswan/config",{BLACKSWAN_FRAMERATE:20,CROWD_SHADE:"rgba(16, 9, 17, 0.5)"}),define("blackswan/process-priority-queue",["require","underscore","tt-base"],function(e){var t=e("underscore"),i=e("tt-base"),n=i.Class.extend({init:function(e){e=e||{};var t=void 0!==e.processInterval?e.processInterval:1;e.process&&(this.process=e.process),this.queues={},this.maxPriority=0,this.start=$.proxy(this.start,this),this._process=util.rateLimit(this,this._process,t)},start:function(){this.processRequested||this._process()},push:function(e,t){t=t||0;var i=this.queues[t];i||(i=this.queues[t]=[]),i.push(e),this.maxPriority=Math.max(this.maxPriority,t)},flush:function(){for(var e;;){if(e=this._findJob(),!e)break;this.process(e)}},process:function(){},_process:function(){this.processRequested=void 0;var e=this._findJob();if(e){var i=this.process(e);t.isObject(i)&&i.then?(this.processRequested=!0,i.then(this._process)):this._process()}},_findJob:function(){for(var e,t;!t;)if(e=this.queues[this.maxPriority],e&&e.length>0)t=e.shift();else{if(0===this.maxPriority)return;this.maxPriority--}return t}},{_name:"ProcessPriorityQueue"});return n}),define("blackswan/avatar-spriter-queue",["require","underscore","util","app","blackswan/avatar-spriter","blackswan/config","blackswan/process-priority-queue"],function(e){var t,i=e("underscore"),n=e("util"),o=e("app"),s=e("blackswan/avatar-spriter"),r=e("blackswan/config"),a=e("blackswan/process-priority-queue"),l={},u={},d=r.BLACKSWAN_FRAMERATE,h=function(e,i,n,s){n=n||{};var r=$.Deferred();return p(e,i,n.keyframes).done(function(){t.push({makingSprite:r,avatarData:e,state:i,animation:n},s),o.initialLoading?o.initialLoading.done(t.start):t.start()}),r.promise()},c=function(e){var t={};i.each(e.avatarData.images,function(e,i){t[i]=l[e]});var n=s.makeSprite(e.avatarData,t,e.state,e.animation,d);e.makingSprite.resolve(n)},p=function(e,t,o){t=e.states[t];var s=[],r=i.pluck(t,"name");i.each(o,function(e){i.each(e,function(e){var t=e.swap;t&&-1===r.indexOf(t)&&r.push(t)})});for(var a=0,d=r.length;d>a;a++){var h,c,p=r[a],f=e.images[p];if(!u[f]){var m=n.createImageWithLoader(f);h=l[f]=m[0],c=u[f]=m[1]}s.push(u[f])}return $.when.apply(this,s)};return $(function(){t=$.browser.msie?new a({processInterval:5}):new a({processInterval:1}),t.process=c}),{makeSprite:h}}),define("blackswan/avatar-sprite-sheet",["require","class","animation","blackswan/avatar-spriter","blackswan/avatar-spriter-queue","blackswan/config"],function(e){var t=e("class"),i=e("animation"),n=e("blackswan/avatar-spriter"),o=e("blackswan/avatar-spriter-queue"),s=e("blackswan/config"),r=s.BLACKSWAN_FRAMERATE,a={},l=!1,u=/\s/g,d=function(e){return e.replace(u,"")},h=function(e,t,i,n){var o=e+t;return n&&(o+=d(n)),i&&(o+=i),o},c=function(e,t,i){var n=0;return i||(n+=3),t||(n+=2),"front"===e&&(n+=1),n},p=function(e,t,i,n){var o=$.Deferred();return m(e,t,i,n).done(function(e){o.resolve(e)}).fail(function(){f(e,t,i,n).done(function(e){o.resolve(e)}).fail(function(){o.reject()})}),o.promise()},f=function(e,t,i,s){var r=$.Deferred();if(s)p(e,t,i).done(function(e){e=_.clone(e),e.img=n.shadeImage(e.img,s),r.resolve(e)}).fail(function(){r.reject()});else{var l=c(t,i,s);o.makeSprite(e,t,i,l).done(function(e){e=_.clone(e),e.img=e.canvas,e.canvas=void 0,r.resolve(e)}).fail(function(){r.reject()})}return r.done(function(n){var o=e.avatarid,r=i?i.id:void 0,l=h(o,t,r,s);a[l]=n}),r.promise()},m=function(e,t,i,n){var o=e.avatarid,s=i?i.id:void 0,u=h(o,t,s,n),d=$.Deferred();if(a[u])return d.resolve(a[u]),d.promise();var c=e.sprites;if(!l&&c&&c[t]&&c[t][s]&&c[t][s][r]&&(!n||c[t][s][r][n])){n=n||"base";var p=c[t][s][r][n];util.loadImage(p).done(function(e){var i=c[t][s][r];d.resolve({offset:i.offset,size:i.size,numFrames:i.numFrames,numFramesX:i.numFramesX,img:e})}).fail(function(){d.reject()})}else d.reject();return d.promise()},g={front:i.animations.bob,back:i.animations.rock},v=t.extend({init:function(e,t,i,n){if(i&&(i=d(i)),this.loading=$.Deferred(),this.onSuccess=_.bind(this.onSuccess,this),this.onFail=_.bind(this.onFail,this),this.animation=n,n)this.fallback=v.get(e,t,i),p(e,t,n,i).done(this.onSuccess).fail(this.onFail);else{var o=g[t],s=this;m(e,t,o,i).done(this.onSuccess).fail(function(){f(e,t,n,i).done(s.onSuccess).fail(s.onFail)})}},onSuccess:function(e){this.data=e;var t=this.img=e.img,i=e.size[0],n=e.size[1];this.crop={x:0,y:0,width:i,height:n},this.offset={x:e.offset[0],y:e.offset[1]};for(var o=this.baseTexture=new PIXI.BaseTexture(this.img),s=e.numFramesX||1,r=e.numFrames||t.height/n,a=this.textures=[],l=0,u=0,d=0;r>d;d++)a.push(new PIXI.Texture(o,new PIXI.Rectangle(l*i,u*n,i,n))),l++,l===s&&(l=0,u++);this.loading.resolve(this)},onFail:function(){this.loading.reject()}},{_name:"AvatarSpriteSheet"}),b={};return _.extend(v,{get:function(e,t,i,n){var o=e.avatarid,s=n?n.id:void 0,r=h(o,t,s,i),a=b[r];return a||(a=b[r]=new v(e,t,i,n)),a},clearCache:function(){a={},b={}},ignorePrerenderedSprites:function(){l=!0}}),v}),define("blackswan/base-object",["require","underscore","backbone","tt-base"],function(e){var t=e("underscore"),i=(e("backbone"),e("tt-base")),n=0,o={x:0,y:0,z:0,offsetX:0,offsetY:0,width:0,height:0,scale:1,zIndex:0,opacity:1,globalCompositeOperation:"source-over",shouldExcludeFromBoundingBox:!1},s=function(e,i){t.extend(this,e),i||this.trigger("change",this,e)},r=i.Class.extend({init:function(e){this.set(t.extend({},o,e)),this.id=n++},set:s,makeView:function(e){var t=new this.View(this,e);return t},cleanup:function(){this.stopListening()},hasPosition:function(){return void 0===this.x||void 0===this.y||void 0===this.z?!1:!0},hasPositionChanged:function(e){return!e||void 0===e.x&&void 0===e.y&&void 0===e.z?!1:!0},View:i.Class.extend({init:function(e,t){this.object=e,this.renderer=t,this.viewScale=e.scale},set:s,cleanup:function(){this.stopListening()}},{_name:"BaseObjectView"})},{_name:"BaseObject"});return r});var Stats=function(){var e,t,i,n=0,o=1,s=!1,r=.02,a=Date.now(),l=a,u=0,d=1/0,h=0,c=0,p=1/0,f=0,m=0,g=0,v=document.createElement("div");v.id="stats",v.addEventListener("mousedown",function(e){e.preventDefault(),C(++g%2)},!1),v.style.cssText="width:80px;opacity:0.9;cursor:pointer";var b=document.createElement("div");b.id="fps",b.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",v.appendChild(b);var w=document.createElement("div");w.id="fpsText",w.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",w.innerHTML="FPS",b.appendChild(w);var y=document.createElement("div");for(y.id="fpsGraph",y.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",b.appendChild(y);y.children.length<74;){var _=document.createElement("span");_.style.cssText="width:1px;height:30px;float:left;background-color:#113",y.appendChild(_)}var x=document.createElement("div");x.id="ms",x.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",v.appendChild(x);var S=document.createElement("div");S.id="msText",S.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",S.innerHTML="MS",x.appendChild(S);var k=document.createElement("div");for(k.id="msGraph",k.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",x.appendChild(k);k.children.length<74;){var _=document.createElement("span");_.style.cssText="width:1px;height:30px;float:left;background-color:#131",k.appendChild(_)}var C=function(e){switch(g=e){case n:b.style.display=s?"block":"none",x.style.display="none";break;case o:b.style.display="none",x.style.display=s?"block":"none"}},T=function(e){s=e,C(g)},I=function(e,t){var i=e.appendChild(e.firstChild);i.style.height=t+"px"};return{REVISION:11,domElement:v,setMode:C,setGraph:T,begin:function(){a=Date.now()},end:function(){var v=Date.now();if(g===o&&(i=u,u=v-a,d=Math.min(d,u),h=Math.max(h,u),void 0===e?e=u:(t=e,e=r*i+(1-r)*t),s)){var b=e.toString().substr(0,5);S.textContent=u+" MS ("+d+"-"+h+") AVG:"+b,I(k,Math.min(30,30-30*(u/200)))}return m++,g===n&&v>l+1e3&&(c=Math.round(1e3*m/(v-l)),p=Math.min(p,c),f=Math.max(f,c),s&&(w.textContent=c+" FPS ("+p+"-"+f+")",I(y,Math.min(30,30-30*(c/100)))),l=v,m=0),v},update:function(){a=this.end()},getMovingAverage:function(){return e},reset:function(){u=i=e=t=0}}};define("lib/stats",function(e){return function(){var t;
return t||e.Stats}}(this)),define("blackswan/renderer",["require","underscore","backbone","lib/stats","tt-base","blackswan/config"],function(e){var t=e("underscore"),i=(e("backbone"),e("lib/stats")),n=e("tt-base");config=e("blackswan/config");var o,s=5,r=function(e){!this.config.autoRedraw||!this.sortedViews||e!==!0&&this.animating||this.renderOnNextFrame()},a=[],l=!1,u=config.BLACKSWAN_FRAMERATE,d=1e3/u,h=function(){if(!a.length)return l=!1,o&&o.reset(),void 0;o&&o.begin(),setTimeout(function(){requestAnimationFrame(h)},d),l=!0;for(var e=Date.now(),t=0,i=a.length;i>t;t++){var n=a[t];n.render(e,!0)}o&&o.end()},c={autoRedraw:!0,shouldCalcBoundingBox:!0,width:1,height:1,scale:1},p=n.Class.extend({init:function(e){this.config=t.extend({},c,e),this.msPerFrame=d,this.scale=this.config.scale,this.sortedViews=[],this.throttledSortObjects=util.rateLimit(this,this.sortObjects,300),this._setCameraNotMoving=util.delay(this,this._setCameraNotMoving,500),this.renderOnNextFrame=util.makeDrawer(this,this.render),this.viewMap={},this.config.camera&&this.setCamera(this.config.camera),this.config.scene&&this.setScene(this.config.scene),void 0!==this.config.width&&void 0!==this.config.height&&this.setSize(this.config.width,this.config.height),this._notifyCameraChange=util.rateLimit(this,this._notifyCameraChange,300),this.hasBoundingBox=!1},setSize:function(e,t){this.config.width=e,this.config.height=t,$(this.el).css({width:e,height:t}),e/=this.scale,t/=this.scale,this.width=e,this.height=t;var i=this.camera.crop;this.xScale=e/i.width,this.yScale=t/i.height,this.dirty=!0,this._onChange()},setCamera:function(e){this.camera&&this.stopListening(e),this.camera=this.config.camera=e,this.listenTo(e,"change",this.onCameraChange),this.onCameraChange(e,e)},setScene:function(e){this.scene&&(this.stopListening(this.scene),t.each(this.scene.objects,this.onSceneRemove,this)),this.scene=this.config.scene=e,t.each(this.scene.objects,this.onSceneAdd,this),this.listenTo(e,{add:this.onSceneAdd,remove:this.onSceneRemove,"change:object":this.onObjectChange,"reset:object":this.onObjectReset}),this.sortObjects(),this._onChange()},cleanup:function(){this.stopListening(),this.stop()},_onChange:r,onCameraChange:function(e,t){if(t.crop){var i=this.camera.crop;this.xScale=this.width/i.width,this.yScale=this.height/i.height}(e.hasPositionChanged(t)||t.crop)&&(this.projectObjects(),this.throttledSortObjects()),this.dirty=!0,this.isCameraMoving=!0,this._setCameraNotMoving(),this._onChange(!0),this._notifyCameraChange()},_notifyCameraChange:function(){this.trigger("change:camera",this)},_setCameraNotMoving:function(){this.isCameraMoving=!1},onSceneAdd:function(e){var t=this.viewMap[e.id]=e.makeView(this);this.listenTo(t,"change",this.onObjectViewChange),this._addView(t)&&(this.dirty=!0,this._onChange())},onSceneRemove:function(e){var t=this.viewMap[e.id];this._removeView(t)&&(this.dirty=!0,this._onChange()),this.stopListening(t),t.cleanup(),this.viewMap[e.id]=void 0},onObjectChange:function(e,t){t=t||{};var i=this.viewMap[e.id];i&&((e.hasPositionChanged(t)||void 0!==t.zIndex)&&(this._removeView(i),this._addView(i)),(t.direction||void 0!==t.animation)&&(this.updateView&&this.updateView(i),e.updateView&&e.updateView(i)),this.dirty=!0,this._onChange())},onObjectReset:function(e){var t=this.viewMap[e.id];this._removeView(t),this._addView(t),this._onChange()},onSortObjects:function(){this.dirty=!0,this._onChange()},onObjectViewChange:function(e){var t=e.object,i=this.camera.projectObject(t);i&&this._setViewPosition(e,i),this.dirty=!0,this._onChange()},_addView:function(e){var t=e.object,i=this.camera.projectObject(t);if(this.updateView&&this.updateView(e),t.updateView&&t.updateView(e),i){this._setViewPosition(e,i),e.zIndex=t.zIndex||0;var n=this.findIndex(e,!0);return this._addViewToList(e,n),this.config.shouldCalcBoundingBox&&!e.object.shouldExcludeFromBoundingBox&&this.updateBoundingBox(i,1===this.sortedViews.length),!0}},_removeView:function(e){var t=this.findIndex(e);if(void 0!==t){if(this._removeViewFromList(t),this.config.shouldCalcBoundingBox&&!e.object.shouldExcludeFromBoundingBox){var i=this.convertToBoundingBox(e);(i.minX===this.minX||i.maxX===this.maxX||i.minY===this.minY||i.maxY===this.maxY)&&this.resetBoundingBox()}return!0}},_addViewToList:function(e,t){this.sortedViews.splice(t,0,e)},_removeViewFromList:function(e){this.sortedViews.splice(e,1)},findIndex:function(e,t){return util.binarySearch(this.sortedViews,e,this._sortFn,t)},_sortFn:function(e,t){var i=e.scale,n=t.scale;if(i===n){var o=e.zIndex,s=t.zIndex;return o===s?e.x-t.x:o-s}return i-n},projectObjects:function(){var e,t=this.sortedViews;if(t){for(var i=0,n=t.length;n>i;i++){e=t[i];var o=this.camera.projectObject(e.object);o?this._setViewPosition(e,o):this._setViewPosition(e,null)}this.config.shouldCalcBoundingBox&&this.resetBoundingBox()}},sortObjects:function(){for(var e,t,i,n=[],o=this.scene.objects,s=0,r=0,a=o.length;a>s;s++)e=o[s],t=this.viewMap[e.id],i=this.camera.projectObject(e),i&&(this._setViewPosition(t,i),n[r]=t,r++);n.sort(this._sortFn),this.sortedViews=n,this.onSortObjects(),this.config.shouldCalcBoundingBox&&this.resetBoundingBox()},_setViewPosition:function(e,t){t?($.extend(e,t),e.isVisible=!0):e.isVisible=!1},start:function(){this.animating=!0,-1===a.indexOf(this)&&a.push(this),this.startTime=Date.now(),l||h()},stop:function(){this.animating=!1;var e=a.indexOf(this);-1!==e&&a.splice(e,1)},convertToBoundingBox:function(e){var t=this.width,i=this.height;return{minX:Math.max(0,Math.floor(e.minX*t)-s),maxX:Math.min(t,Math.ceil(e.maxX*t)+s),minY:Math.max(0,Math.floor(e.minY*i)-s),maxY:Math.min(i,Math.ceil(e.maxY*i)+s)}},updateBoundingBox:function(e,t){e=this.convertToBoundingBox(e);var i=e.minX,n=e.maxX,o=e.minY,s=e.maxY;!t&&this.hasBoundingBox&&(i=Math.min(this.minX,i),n=Math.max(this.maxX,n),o=Math.min(this.minY,o),s=Math.max(this.maxY,s)),isNaN(i)||isNaN(n)||isNaN(o)||isNaN(s)?(this.hasBoundingBox=!1,this.minX=this.maxX=this.minY=this.maxY=this.frameWidth=this.frameHeight=void 0):(this.hasBoundingBox=!0,this.minX=i,this.maxX=n,this.minY=o,this.maxY=s,this.frameWidth=n-i,this.frameHeight=s-o)},resetBoundingBox:function(){var e,t=this.sortedViews;if(!t||!t.length)return this.updateBoundingBox({},!0),void 0;for(var i,n,o,s,r=0,a=t.length;a>r;r++)if(e=t[r],!e.object.shouldExcludeFromBoundingBox){var l=e.minX,u=e.maxX,d=e.minY,h=e.maxY;(void 0===i||i>l)&&(i=l),(void 0===n||u>n)&&(n=u),(void 0===o||o>d)&&(o=d),(void 0===s||h>s)&&(s=h)}this.updateBoundingBox({minX:i,maxX:n,minY:o,maxY:s},!0)},isObjectInView:function(e){if(!this.viewMap[e.id])return!1;var t,i=this.sortedViews;if(!i)return!1;for(var n=0,o=i.length;o>n;n++)if(t=i[n],t.object===e)return!0;return!1},enableStats:function(e){return o=new i,o.setMode(1),e&&(o.setGraph(!0),document.body.appendChild(o.domElement)),o},disableStats:function(){o=void 0},setScale:function(e){this.scale=e;var t=this.config;this.setSize(t.width,t.height),this.resetBoundingBox()}},{_name:"Renderer"});return p}),define("blackswan/pixi-renderer",["require","underscore","pixi","blackswan/renderer"],function(e){var t=e("underscore"),i=e("pixi"),n=e("blackswan/renderer"),o=15,s=window.devicePixelRatio||1,r={shouldCacheFrames:!1,cacheDuration:1200,isRetinaDisabled:!1,type:"auto"},a=n.extend({init:function(e){e=t.extend({},r,e),e.shouldCalcBoundingBox=e.shouldCacheFrames;var n;if(this.stage=new i.Stage,n=this.renderer="canvas"===e.type?new i.CanvasRenderer(null,null,null,!0):i.autoDetectRenderer(null,null,null,!0),this.backingStorePixelRatio=1,n instanceof i.CanvasRenderer){var o=this.context=n.context;this.backingStorePixelRatio=o.webkitBackingStorePixelRatio||1,this.backingStorePixelRatio>=2?(o._getImageData=o.webkitGetImageDataHD,o._putImageData=o.webkitPutImageDataHD):(o._getImageData=o.getImageData,o._putImageData=o.putImageData)}this._super(e),this.config.isRetinaDisabled?this.disableRetina():this.enableRetina(),this.config.shouldCacheFrames&&this.setCacheDuration(e.cacheDuration),this.el=n.view},enableRetina:function(){this.pixelRatio=s;var e=this.pixelScale=s/this.backingStorePixelRatio;this.setSize(this.config.width,this.config.height),this.stage&&(this.stage.worldTransform=[e,0,0,0,e,0,0,0,e])},disableRetina:function(){this.pixelRatio=1,this.pixelScale=1/this.backingStorePixelRatio,this.setSize(this.config.width,this.config.height),this.stage&&(this.stage.worldTransform=[1,0,0,0,1,0,0,0,1])},setCacheDuration:function(e){this.emptyFrameCache(),this.config.cacheDuration=e,this.numCachedFrames=this.config.cacheDuration/this.msPerFrame},setSize:function(e,t){var i=this.pixelScale;this.renderer.resize(e*i/this.scale,t*i/this.scale),this.context&&this.context.scale(i,i),this._super(e,t)},setScale:function(){this._super.apply(this,arguments),this.projectObjects()},setScene:function(e){this._super(e),this.config.shouldCacheFrames&&this.listenTo(e,{"changing:object":this.onObjectChanging})},onObjectChanging:function(){this.config.shouldCacheFrames&&(this.dirty=!0)},emptyFrameCache:function(){this.config.shouldCacheFrames&&(this.frameCache=[])},cleanup:function(){this.emptyFrameCache(),this._super()},_addViewToList:function(e,t){this._super(e,t),this.stage.addChildAt(e.pixiObject,t)},_removeViewFromList:function(e){this.stage.removeChild(this.sortedViews[e].pixiObject),this._super(e)},sortObjects:function(){for(var e=this.sortedViews,t=0,i=e.length;i>t;t++)this.stage.removeChild(e[t].pixiObject);for(this._super(),e=this.sortedViews,t=0,i=e.length;i>t;t++)this.stage.addChild(e[t].pixiObject)},_setViewPosition:function(e,t){if(this._super(e,t),e.pixiObject)if(t){var i=e.pixiObject.position;i.x=t.x*this.width,i.y=t.y*this.height;var n=e.pixiObject.scale;n.x=e.viewScale*t.scale*this.xScale,n.y=e.viewScale*t.scale*this.yScale,e.pixiObject.visible=!0}else e.pixiObject.visible=!1},render:function(e,t){this.dirty&&(this.dirty=!1,this.emptyFrameCache());var i,n=this.context;if(void 0===e&&(e=Date.now()),this.config.shouldCacheFrames&&this.startTime&&t&&!this.isCameraMoving){i=Math.floor((e-this.startTime)/this.msPerFrame);var s=i%this.numCachedFrames,r=this.frameCache[s],a=0,l=0,u=1,d=1;this.hasBoundingBox&&(a=this.minX,l=this.minY,u=this.frameWidth,d=this.frameHeight);var h=this.pixelRatio;r?(n.setTransform(1,0,0,1,0,0),n.clearRect(a,l,u,d),n._putImageData(r,a*h,l*h),this.numConsecutiveCacheHits>o?this.hasTriggeredSteadyState||(this.trigger("steady"),this.hasTriggeredSteadyState=!0):this.numConsecutiveCacheHits++):(e=this.startTime+i*this.msPerFrame,this.animating&&this._tick(e),this._render(),this.frameCache[s]=n._getImageData(a*h,l*h,u*h,d*h),this.numConsecutiveCacheHits=0,this.hasTriggeredSteadyState=!1)}else this.startTime&&(i=Math.floor((e-this.startTime)/this.msPerFrame),e=this.startTime+i*this.msPerFrame),this.animating&&this._tick(e),this._render()},_tick:function(e){var t=this.sortedViews;if(!t||!t.length)return!0;for(var i=t.length;i--;){var n=t[i];n.isVisible&&n.tick&&n.tick(e)}},_render:function(){this.renderer.render(this.stage)}},{_name:"PixiRenderer"});return a}),define("blackswan/canvas-renderer",["require","pixi","blackswan/pixi-renderer","blackswan/renderer"],function(e){var t=e("pixi"),i=e("blackswan/pixi-renderer"),n=e("blackswan/renderer");window.devicePixelRatio||1;var o={shouldCacheFrames:!1,cacheDuration:1200,isRetinaDisabled:!1},s=i.extend({init:function(e){var t=this.canvas=this.el=e.canvas||document.createElement("canvas"),i=this.context=t.getContext("2d");e=_.extend({},o,e),e.shouldCalcBoundingBox=e.shouldCacheFrames,this.backingStorePixelRatio=i.webkitBackingStorePixelRatio||1,this.backingStorePixelRatio>=2?(i._getImageData=i.webkitGetImageDataHD,i._putImageData=i.webkitPutImageDataHD):(i._getImageData=i.getImageData,i._putImageData=i.putImageData),n.prototype.init.apply(this,arguments),this.config.isRetinaDisabled?this.disableRetina():this.enableRetina(),this.config.shouldCacheFrames&&this.setCacheDuration(e.cacheDuration),this.el=t},setSize:function(e,t){var i=this.pixelScale;this.canvas.width=e*i/this.scale,this.canvas.height=t*i/this.scale,this.context.scale(i,i),n.prototype.setSize.apply(this,arguments)},_addViewToList:n.prototype._addViewToList,_removeViewFromList:n.prototype._removeViewFromList,sortObjects:n.prototype.sortObjects,_render:function(){var e=this.sortedViews;if(!e||!e.length)return!0;var i=!0,n=this.canvas,o=this.context;o.clearRect(0,0,n.width,n.height);for(var s=0,r=e.length;r>s;s++){var a=e[s];if(a.isVisible){var l=a.pixiObject;if(l instanceof t.Sprite){var u=l.texture.frame,d=u.width*l.scale.x,h=u.height*l.scale.y;o.globalCompositeOperation=a.object.globalCompositeOperation,o.drawImage(l.texture.baseTexture.source,u.x,u.y,u.width,u.height,l.position.x-l.anchor.x*d,l.position.y-l.anchor.y*h,d,h)}}else i=!1}return i}},{_name:"CanvasRenderer"});return s}),define("blackswan/mouse-map-renderer",["require","underscore","blackswan/canvas-renderer"],function(e){var t=e("underscore"),i=e("blackswan/canvas-renderer"),n={shouldCacheFrames:!1,ignoreAnimations:!0,isRetinaDisabled:!0,type:"canvas"},o=i.extend({init:function(e){this._super(t.extend({},n,e))},onObjectChange:function(e,t){t&&void 0!==t.animation||this._super(e,t)},idToColor:function(e){var t=(e>>16)%256,i=(e>>8)%256,n=e%256;return"rgba("+t+", "+i+", "+n+", 1)"},pixelToId:function(e){return(e[0]<<16)+(e[1]<<8)+e[2]}},{_name:"MouseMapRenderer"});return o}),define("blackswan/avatar-object",["require","underscore","pixi","blackswan/animator","models/avatar","blackswan/avatar-sprite-sheet","blackswan/base-object","config","blackswan/mouse-map-renderer"],function(e){var t=e("underscore"),i=e("pixi"),n=e("blackswan/animator"),o=e("models/avatar"),s=e("blackswan/avatar-sprite-sheet"),r=e("blackswan/base-object"),a=(e("config"),e("blackswan/mouse-map-renderer")),l=i.Texture.fromImage("/roommanager_assets/props/pixel.png"),u={direction:-1,avatarData:void 0,shade:void 0},d=r.extend({init:function(e){var i=e.avatarData;if(i instanceof o){var r=this.avatar=i;this.listenTo(r,"change:states",t.debounce(function(){s.clearCache(),s.ignorePrerenderedSprites(),this.trigger("change:animation",this)},100)),i=e.avatarData=i.attributes}if(i){var a=i.size;$.extend(e,{offsetX:-a[0]/2,offsetY:-a[1],width:a[0],height:a[1]})}this._super(t.extend({},u,e)),this.animator=new n,this.listenTo(this.animator,{"change stop":function(e,t){this.animation=t,this.trigger("change:animation",this,{animation:t?t:null})},"changing stopping":function(){this.trigger("changing",this)}})},set:function(e,t){!t&&e.direction&&(this.direction=e.direction,this.trigger("change:direction",this,e.direction)),this._super(e,t)},setAnimation:function(e){this.animator.pushAnimation(e),this.animator.next(),this.animator.start()},stopAnimation:function(){this.animator.stop()},isAnimating:function(){return this.animator.animating},View:r.prototype.View.extend({methodsToBind:["onLoad"],init:function(e,t){this._super.apply(this,arguments);var n=this.pixiObject=new i.MovieClip([l]);n.anchor.x=.5,n.anchor.y=1,t instanceof a&&(this.shade=t.idToColor(e.id)),this.listenTo(e,"change:direction",this.updateState),t.ignoreAnimations||this.listenTo(e,"change:animation",this.loadSpriteSheet),this.updateState()},updateState:function(){this.state=this.renderer.camera.direction*this.object.direction>0?"back":"front",this.loadSpriteSheet()},loadSpriteSheet:function(){var e=this.object,t=this.shade||e.shade,i=s.get(e.avatarData,this.state,t,e.animation);i!==this.spriteSheet&&(this.drawn=!1,this.spriteSheet=i,this.spriteSheet.loading.done(this.onLoad))},updateAnchor:function(){var e=this.spriteSheet,t=this.pixiObject;t.anchor.x=-e.offset.x/e.crop.width,t.anchor.y=-e.offset.y/e.crop.height},onLoad:function(e){if(e===this.spriteSheet){var t=this.renderer,i=t.config.ignoreAnimations?!1:this.object.isAnimating();i&&this.renderer.animating||(this.pixiObject.textures=this.spriteSheet.textures,this.pixiObject.gotoAndStop(0),this.updateAnchor()),this.trigger("change",this)}},tick:function(e){var t=this.renderer,i=t.config.ignoreAnimations?{}:this.object.animator.getCurrentState(e),n=i.animating?Math.floor(i.timeSinceLoopStart/t.msPerFrame):0,o=!1;i.animating&&(this.drawn||(0===n&&"resolved"===this.spriteSheet.loading.state()?(this.pixiObject.textures=this.spriteSheet.textures,this.updateAnchor(),o=!0,this.drawn=!0,this.trigger("change",this)):n=0)),(this.pixiObject.currentFrame!==n||o)&&this.pixiObject.gotoAndStop(n)}})},{_name:"AvatarObject"});return d}),define("blackswan/dom-pane",["require","blackswan/base-object"],function(e){var t=e("blackswan/base-object"),i={useTransforms:!1},n=t.extend({init:function(e){this._super(_.extend({},i,e)),this.el=e.el||document.createElement("div"),this.$el=$(this.el)},cleanup:function(){this._super(),this.$el.remove()},View:t.prototype.View.extend({init:function(e){this._super.apply(this,arguments),this.el=e.el,this.$el=e.$el}})},{_name:"DOMPane"});return n}),define("avatar-popover",["require","backbone","tt-base","blackswan/dom-pane"],function(e){var t=(e("backbone"),e("tt-base")),i=e("blackswan/dom-pane"),n={objectId:null,mouseAdapter:null,scene:null,delay:150,avatar:null,isDj:!1,$tip:$({}),autoCleanup:!0},o=t.Class.extend({init:function(e){$.extend(this,n,e);var t=this.popover=new i({});t.$el.append(this.$tip),this.setPosition(this.avatar),this.listenTo(this.avatar,"change",this.setPosition),this.enter=$.proxy(this.enter,this),this.leave=$.proxy(this.leave,this),this.listenTo(this.mouseAdapter,"mouseenter",this.enter),this.listenTo(this.mouseAdapter,"mouseleave",this.leave),this.$tip.on("mouseenter",$.proxy(this.tipEnter,this)).on("mouseleave",$.proxy(this.tipLeave,this)).on("mousemove",function(e){e.stopPropagation()}).on("click",function(e){e.stopPropagation()}).on("click",".option",$.proxy(this.hide,this))},setPosition:function(e){var t=e.y;this.isDj||(t+=e.avatarData.size[1]),this.popover.set({x:e.x,y:t,z:e.z})},enter:function(e){if(e.id===this.objectId){if(this.trigger("mouseenter"),!this.delay)return this.show();clearTimeout(this.timeout),this.hoverState="in";var t=this;this.timeout=setTimeout(function(){"in"!=t.hoverState||t.$tip.hasClass("in")||t.show()},this.delay)}},leave:function(e){if(e.id===this.objectId){if(this.trigger("mouseleave"),this.timeout&&clearTimeout(this.timeout),!this.delay)return this.hide();this.hoverState="out";var t=this;this.timeout=setTimeout(function(){"out"==t.hoverState&&t.hide()},this.delay)}},tipEnter:function(){this.mouseAdapter.onMousemove.cancel(),this.hoverState="in",clearTimeout(this.timeout)},tipLeave:function(){this.leave({id:this.objectId}),this.listenToOnce(this.mouseAdapter,"mousemove",this.enter)},show:function(){this.$tip.addClass("in"),this.scene.add(this.popover)},hide:function(){this.$tip.removeClass("in"),this.scene.remove(this.popover),this.autoCleanup&&this.cleanup()},cleanup:function(){this.stopListening(),this.$tip.remove(),this.$tip=void 0,this.popover.cleanup(),this.trigger("cleanup")}},{_name:"AvatarPopover"});return o}),define("blackswan/mouse-adapter",["require","backbone","tt-base","util","app"],function(e){var t,i=(e("backbone"),e("tt-base")),n=e("util"),o=e("app");$(function(){t=$(window)});var s=i.Class.extend({init:function(e){var i=this.mouseTarget=e.mouseTarget;this.pixelToId=e.pixelToId;var s=this.canvas=e.canvas;this.context=s.getContext("2d"),this.ignoreInitialMouseEvents=e.ignoreInitialMouseEvents,this.ignoreExceptionSelector=e.ignoreExceptionSelector;var r=this.$target=$(i);this.onMousemove=n.rateLimit(this,this.onMousemove,100),this.onMouseenter=$.proxy(this.onMouseenter,this),this.onMouseleave=$.proxy(this.onMouseleave,this),this.onClick=$.proxy(this.onClick,this),this.delayedOnResizeOrScroll=n.delay(this,this.onResizeOrScroll,200),r.on("mouseenter",this.onMouseenter).on("mousemove",this.onMousemove).on("mouseleave",this.onMouseleave).on("click",this.onClick),t.on("resize",this.delayedOnResizeOrScroll),this.listenTo(o,"change:layout change:miniplayer",this.delayedOnResizeOrScroll),this.onResizeOrScroll()},onMouseenter:function(e){!this.ignoreInitialMouseEvents||this.ignoreExceptionSelector&&0!==$(e.relatedTarget).filter(this.ignoreExceptionSelector).length?this.ignoreMousemove=!1:(this.ignoreMousemove=!0,window.setTimeout($.proxy(function(){this.ignoreMousemove=!1},this),400))},onMousemove:function(e){if(!this.ignoreMousemove){var t=this.offset,i=e.pageX-t.left,n=e.pageY-t.top,o=this.getIdFromCoordinates(i,n);o?this.lastHoverObjectid===o?this.mousemoveObject(o):(this.mouseleaveObject(),this.mouseenterObject(o)):this.mouseleaveObject()}},onMouseleave:function(){this.onMousemove.cancel(),this.mouseleaveObject()},onClick:function(e){var t=this.offset,i=e.pageX-t.left,n=e.pageY-t.top,o=this.getIdFromCoordinates(i,n);o&&this.clickObject(o)},onResizeOrScroll:function(){var e=this.$target.offset();this.offset={left:e.left-t.scrollLeft(),top:e.top-t.scrollTop()},this._updateWidth()},mouseenterObject:function(e){this.lastHoverObjectid=e,this.trigger("mouseenter",e)},mouseleaveObject:function(){var e=this.lastHoverObjectid;e&&(this.trigger("mouseleave",e),this.lastHoverObjectid=null)},mousemoveObject:function(e){this.trigger("mousemove",e)},clickObject:function(e){this.trigger("click",e)},getIdFromCoordinates:function(e,t){e=Math.min(Math.max(1,e),this.canvasWidth-1);var i=this._getImageData(e-1,t,3,1).data;if(255===i[3]){for(var n=0;2>n;n++)for(var o=0;4>o;o++)if(i[4*n+o]!==i[4*(n+1)+o])return;return this.pixelToId(i)}},cleanup:function(){this.$target.off("mouseenter",this.onMouseenter).off("mousemove",this.onMousemove).off("mouseleave",this.onMouseleave).off("click",this.onClick),t.off("resize",this.delayedOnResizeOrScroll),this.stopListening()},_updateWidth:function(){this.canvasWidth=this.canvas.width},_getImageData:function(e,t,i,n){return this.context.getImageData(e,t,i,n)}},{_name:"MouseAdapter"});return s}),define("views/camera-control",["require","underscore","backbone","tt-base","util","draggable","blackswan/mouse-adapter","blackswan/mouse-map-renderer"],function(e){var t=e("underscore"),i=(e("backbone"),e("tt-base")),n=e("util"),o=e("draggable"),s=e("blackswan/mouse-adapter"),r=e("blackswan/mouse-map-renderer"),a=2,l=4,u=6,d=8,h=10,c=i.View.extend({id:"camera-control",initialize:function(e){this.roomView=e.roomView,this.render();var i=n.loadImage("/roommanager_assets/camera-control/flat-disc.png");i.done(t.bind(this.onLoad,this));var o=this.actions={};o[a]=this.roomView.moveCameraForward,o[l]=this.roomView.moveCameraRight,o[u]=this.roomView.moveCameraBack,o[d]=this.roomView.moveCameraLeft,this.listenTo(this.roomView,"change:autoCamera",this.onChangeAutoCamera)},render:function(){this.$el.append(n.buildTree(this.layout,this));var e=this.directions={};e[a]=$(this.top),e[l]=$(this.right),e[u]=$(this.bottom),e[d]=$(this.left),e[h]=$(this.center)},onLoad:function(e){var i=document.createElement("canvas");i.width=e.width,i.height=e.height,i.getContext("2d").drawImage(e,-15,-15),this.mouseAdapter=new s({canvas:i,pixelToId:r.prototype.pixelToId,mouseTarget:this.el}),this.listenTo(this.mouseAdapter,{mouseenter:this.onMouseenter,mouseleave:this.onMouseleave,click:this.onClick}),this.onMouseup=t.bind(this.onMouseup,this),this.draggable=new o({mousedown:t.bind(this.onMousedown,this),mousemove:this.mouseAdapter.onMousemove,mouseup:this.onMouseup,cursor:"pointer"}),this.$el.on("mousedown",this.draggable.setup),this.$el.one("mousedown",function(){_gaq.push(["_trackEvent","feature","camera control","widget"])})},layout:[["div#control-top##top"],["div#control-right##right"],["div#control-bottom##bottom"],["div#control-left##left"],["div#control-center##center"]],onMouseenter:function(e){var t=this.directions[e];if(t)if(this.isMousedown){t.addClass("active");var i=this.actions[e];i&&i.call(this.roomView)}else t.addClass("hover");this.currentDirection=e},onMouseleave:function(e){var t=this.directions[e];t&&(t.removeClass("hover"),e===h&&this.roomView.autoCamera||t.removeClass("active")),this.isMousedown&&this.roomView.cancelCameraTransition(),delete this.currentDirection},onMousedown:function(e){var t=this.currentDirection;if(t){this.directions[t].addClass("active");var i=this.actions[t];i&&i.call(this.roomView)}this.isMousedown=!0,e.preventDefault()},onMouseup:function(){var e=this.currentDirection;e&&e!==h&&(this.directions[e].removeClass("active"),this.roomView.cancelCameraTransition()),delete this.isMousedown},onClick:function(e){e===h&&(this.directions[e].addClass("active"),this.roomView.resetCamera())},onChangeAutoCamera:function(e){e?this.directions[h].addClass("active"):this.directions[h].removeClass("active")},show:function(){this.$el.show(),this.mouseAdapter&&this.mouseAdapter.onResizeOrScroll()},hide:function(){this.$el.hide()},cleanup:function(){this.mouseAdapter.cleanup()}},{_name:"CameraControl"});return c}),define("blackswan/dom-renderer",["require","underscore","blackswan/renderer"],function(e){var t=e("underscore"),i=e("blackswan/renderer"),n={shouldCalcBoundingBox:!1},o=i.extend({init:function(e){this.el=e.el||document.createElement("div");var i=this.$el=$(this.el);e.el&&void 0===e.width&&$.extend(e,{width:i.width(),height:i.height()}),this._super(t.extend({},n,e))},setSize:function(e,t){this.$el.css({width:e,height:t}),this._super(e,t)},setScene:function(){this.$el.children().detach(),this._super.apply(this,arguments)},onSceneRemove:function(e){e.$el.detach(),this._super(e)},updateView:function(e){e.$el&&e.$el.parent().length||(e.$el=e.object.$el.appendTo(this.$el).css("position","absolute"),e.object.useTransforms&&e.$el.css("transform-origin","top left"))},render:function(){if(!this.dirty)return!0;var e=this.sortedViews;if(!e||!e.length)return!0;for(var t=0,i=!0,n=this.width,o=this.height,s=this.xScale,r=this.yScale,a=0,l=e.length;l>a;a++){var u=e[a],d=u.object,h=u.scale*d.scale,c={"z-index":t++,top:u.y*o+d.offsetY*h*r,left:u.x*n+d.offsetX*h*s};u.object.useTransforms?(c.width=d.width,c.height=d.height,c.transform="scale("+h*s+", "+h*r+")"):(c.width=d.width*h*s,c.height=d.height*h*r),u.$el.css(c)}return this.dirty=!1,i},setScale:function(){},_setViewPosition:function(e,t){e.isVisible&&!t?e.$el.css("display","none"):!e.isVisible&&t&&e.$el.css("display",""),this._super(e,t)}},{_name:"DOMRenderer"});return o}),define("blackswan/fixed-orientation-camera",["require","underscore","blackswan/base-object"],function(e){var t=e("underscore"),i=e("blackswan/base-object"),n={focalLength:1,crop:{x:-.5,y:-.5,width:1,height:1}},o=i.extend({init:function(e){this._super(t.extend({},n,e))},direction:-1,projectObject:function(e){var t=this.projectLocation(e),i=this.crop;if(t){var n=t.minX=t.x+e.offsetX*e.scale*t.scale/i.width,o=t.maxX=n+e.width*e.scale*t.scale/i.width,s=t.minY=t.y+e.offsetY*e.scale*t.scale/i.height,r=t.maxY=s+e.height*e.scale*t.scale/i.height;if(!(0>o||n>1||0>r||s>1))return t}},projectLocation:function(e){var t=this.z-e.z;if(!(0>t)){var i=this.focalLength,n=this.crop,o=i/(i+t),s=(e.x-this.x)*o,r=(e.y-this.y)*o;return s=(s-n.x)/n.width,r=(-r-n.y)/n.height,{x:s,y:r,scale:o}}},fitX:function(e,t){var i=this.focalLength*(e.x-this.x-t)/t;return e.z+i},fitY:function(e,t){t=-t;var i=this.focalLength*(e.y-this.y-t)/t;return e.z+i},reverseProjectLocation:function(e,t){var i=this.z-t;if(!(0>i)){var n=this.focalLength,o=this.crop,s=e.x*o.width+o.x,r=-(e.y*o.height+o.y);return s=s*i/n+this.x,r=r*i/n+this.y,{x:s,y:r,z:t}}}},{_name:"FixedOrientationCamera"});return o}),define("blackswan/laptop",["require","underscore","util","pixi","blackswan/base-object","blackswan/mouse-map-renderer","sticker"],function(e){var t=e("underscore"),i=e("util"),n=e("pixi"),o=e("blackswan/base-object"),s=e("blackswan/mouse-map-renderer"),r=e("sticker"),a=n.Texture.fromImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2NkAAIAAAoAAggA9GkAAAAASUVORK5CYII="),l=250,u=170,d=89,h={iphone:"/roommanager_assets/props/laptop-iphone.png",android:"/roommanager_assets/props/laptop-android.png"},c={scale:.5,user:{}},p=o.extend({methodsToBind:["generateLaptopImage"],init:function(e){this._super(t.extend({},c,e)),r.loading||r.init(),r.loading.done(this.generateLaptopImage),window.turntable&&(this.messageHandler=$.proxy(this.messageHandler,this),turntable.addEventListener("message",this.messageHandler))},generateLaptopImage:function(){var e=this.user,t=e.get?e.get("laptop"):null;if("iphone"===t||"android"===t)i.loadImage(h[t]).done($.proxy(function(e){var t=document.createElement("canvas"),i=t.getContext("2d");this.height=t.height=u,this.width=t.width=e.width*this.height/e.height,i.drawImage(e,0,0,this.width,this.height),this.offsetX=-this.width/2,this.smallLaptopTexture=this.laptopTexture=n.Texture.fromCanvas(t),this.trigger("change",this)},this));else{var o=document.createElement("canvas"),s=o.getContext("2d");this.width=o.width=l,this.height=o.height=u,this.offsetX=-l/2,r.drawLaptopCanvas(e.id,s,.5),this.laptopImage=o,this.laptopTexture=n.Texture.fromCanvas(this.laptopImage),o=document.createElement("canvas"),s=o.getContext("2d"),o.width=l,o.height=u,r.drawLaptopCanvas(e.id,s,.5,null,!0),this.smallLaptopImage=o,this.smallLaptopTexture=n.Texture.fromCanvas(this.smallLaptopImage),this.trigger("change",this)}},generateShadedLaptopImage:function(e){var t=this.user,i=t.get?t.get("laptop"):null,o=document.createElement("canvas"),s=o.getContext("2d");return o.height=u,o.width="iphone"===i||"android"===i?d:l,s.fillStyle=e,s.fillRect(0,0,o.width,o.height),n.Texture.fromCanvas(o)},messageHandler:function(e){"update_sticker_placements"===e.command&&e.userid===this.user.id&&this.generateLaptopImage()},cleanup:function(){this._super(),turntable.removeEventListener("message",this.messageHandler)},View:o.prototype.View.extend({methodsToBind:["updateSprite"],init:function(e,t){this._super.apply(this,arguments);var i=this.pixiObject=new n.Sprite(a);i.anchor.x=.5,t instanceof s?(this.shade=t.idToColor(e.id),this.texture=e.generateShadedLaptopImage(this.shade)):(this.listenTo(t,"change:camera",this.updateSprite),this.listenTo(e,"change",this.updateSprite)),this.updateSprite()},updateSprite:function(){var e;e=this.shade?this.texture:this.scale*this.renderer.yScale>.65?this.object.laptopTexture:this.object.smallLaptopTexture,e&&e!==this.pixiObject.texture&&this.pixiObject.setTexture(e)}},{_name:"LaptopView"})},{_name:"Laptop"});return p}),define("blackswan/renderer-mouse-adapter",["require","util","blackswan/mouse-adapter"],function(e){var t=(e("util"),e("blackswan/mouse-adapter")),i=t.extend({init:function(e){e.canvas=e.renderer.el,e.pixelToId=e.renderer.pixelToId;var t=this.renderer=e.renderer;this.context=t.context,this._super(e),this.mapContext=t.context,this.objectMap=t.scene.objectMap},mouseenterObject:function(e){this.lastHoverObjectid=e;var t=this.objectMap[e];t&&this.trigger("mouseenter",t)},mouseleaveObject:function(){var e=this.lastHoverObjectid;if(e){var t=this.objectMap[e];t&&this.trigger("mouseleave",t),this.lastHoverObjectid=null}},mousemoveObject:function(e){var t=this.objectMap[e];t&&this.trigger("mousemove",t)},clickObject:function(e){var t=this.objectMap[e];t&&this.trigger("click",t)},_updateWidth:function(){this.canvasWidth=this.renderer.config.width},_getImageData:function(e,t,i,n){return this.context._getImageData(e,t,i,n)}},{_name:"RendererMouseAdapter"});return i}),define("blackswan/scene",["require","backbone","class","util"],function(e){var t=e("backbone"),i=e("class"),n=e("util"),o=i.extend({init:function(){this.objects=[],this.objectMap={}},add:function(e){if(e){var t=n.binarySearch(this.objects,e,this._sortFn);void 0===t&&(t=n.binarySearch(this.objects,e,this._sortFn,!0),this.objects.splice(t,0,e),this.objectMap[e.id]=e,this.trigger("add",e),this.listenTo(e,{change:this.onObjectChange,changing:this.onObjectChanging,reset:this.onObjectReset}))}},remove:function(e){if(e){var t=n.binarySearch(this.objects,e,this._sortFn);void 0!==t&&(this.objects.splice(t,1),this.objectMap[e.id]=void 0,this.trigger("remove",e),this.stopListening(e))}},onObjectChange:function(e,t){this.trigger("change:object",e,t)},onObjectChanging:function(e,t){this.trigger("changing:object",e,t)
},onObjectReset:function(e){this.trigger("reset:object",e)},cleanup:function(){this.stopListening()},_sortFn:function(e,t){return e.id-t.id}},{_name:"Scene"});return $.extend(o.prototype,t.Events),o}),define("text",["module"],function(e){var t,i,n,o,s=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],r=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,l="undefined"!=typeof location&&location.href,u=l&&location.protocol&&location.protocol.replace(/\:/,""),d=l&&location.hostname,h=l&&(location.port||void 0),c=[],p=e.config&&e.config()||{};return t={version:"2.0.5+",strip:function(e){if(e){e=e.replace(r,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:p.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){i=s[t];try{e=new ActiveXObject(i)}catch(n){}if(e){s=[i];break}}return e},parseName:function(e){var t,i,n,o=!1,s=e.indexOf("."),r=0===e.indexOf("./")||0===e.indexOf("../");return-1!==s&&(!r||s>1)?(t=e.substring(0,s),i=e.substring(s+1,e.length)):t=e,n=i||t,s=n.indexOf("!"),-1!==s&&(o="strip"===n.substring(s+1),n=n.substring(0,s),i?i=n:t=n),{moduleName:t,ext:i,strip:o}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,i,n,o){var s,r,a,l=t.xdRegExp.exec(e);return l?(s=l[2],r=l[3],r=r.split(":"),a=r[1],r=r[0],!(s&&s!==i||r&&r.toLowerCase()!==n.toLowerCase()||(a||r)&&a!==o)):!0},finishLoad:function(e,i,n,o){n=i?t.strip(n):n,p.isBuild&&(c[e]=n),o(n)},load:function(e,i,n,o){if(o.isBuild&&!o.inlineText)return n(),void 0;p.isBuild=o.isBuild;var s=t.parseName(e),r=s.moduleName+(s.ext?"."+s.ext:""),a=i.toUrl(r),c=p.useXhr||t.useXhr;!l||c(a,u,d,h)?t.get(a,function(i){t.finishLoad(e,s.strip,i,n)},function(e){n.error&&n.error(e)}):i([r],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,n)})},write:function(e,i,n){if(c.hasOwnProperty(i)){var o=t.jsEscape(c[i]);n.asModule(e+"!"+i,"define(function () { return '"+o+"';});\n")}},writeFile:function(e,i,n,o,s){var r=t.parseName(i),a=r.ext?"."+r.ext:"",l=r.moduleName+a,u=n.toUrl(r.moduleName+a)+".js";t.load(l,n,function(){var i=function(e){return o(u,e)};i.asModule=function(e,t){return o.asModule(e,u,t)},t.write(e,l,i,s)},s)}},"node"===p.env||!p.env&&"undefined"!=typeof process&&process.versions&&process.versions.node?(i=require.nodeRequire("fs"),t.get=function(e,t){var n=i.readFileSync(e,"utf8");0===n.indexOf("\ufeff")&&(n=n.substring(1)),t(n)}):"xhr"===p.env||!p.env&&t.createXhr()?t.get=function(e,i,n,o){var s,r=t.createXhr();if(r.open("GET",e,!0),o)for(s in o)o.hasOwnProperty(s)&&r.setRequestHeader(s.toLowerCase(),o[s]);p.onXhr&&p.onXhr(r,e),r.onreadystatechange=function(){var t,o;4===r.readyState&&(t=r.status,t>399&&600>t?(o=new Error(e+" HTTP status: "+t),o.xhr=r,n(o)):i(r.responseText))},r.send(null)}:"rhino"===p.env||!p.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?t.get=function(e,t){var i,n,o="utf-8",s=new java.io.File(e),r=java.lang.System.getProperty("line.separator"),a=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),o)),l="";try{for(i=new java.lang.StringBuffer,n=a.readLine(),n&&n.length()&&65279===n.charAt(0)&&(n=n.substring(1)),i.append(n);null!==(n=a.readLine());)i.append(r),i.append(n);l=String(i.toString())}finally{a.close()}t(l)}:("xpconnect"===p.env||!p.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(n=Components.classes,o=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),t.get=function(e,t){var i,s,r={},a=new FileUtils.File(e);try{i=n["@mozilla.org/network/file-input-stream;1"].createInstance(o.nsIFileInputStream),i.init(a,1,0,!1),s=n["@mozilla.org/intl/converter-input-stream;1"].createInstance(o.nsIConverterInputStream),s.init(i,"utf-8",i.available(),o.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),s.readString(i.available(),r),s.close(),i.close(),t(r.value)}catch(l){throw new Error((a&&a.path||"")+": "+l)}}),t}),define("text!blackswan/../../images/concert-scene/output.json",[],function(){return'{"images":{"retina":{"zoom-2":{"dimensions":{"x":0,"y":0,"scale":1.66008174386921,"width":1468,"height":903.5},"up-active":{"path":"zoom-2/up-active-2x.png","x":847.5,"y":114.5,"width":38,"height":64,"blendMode":"passthrough"},"up-hover":{"path":"zoom-2/up-hover-2x.png","x":847.5,"y":114.5,"width":38,"height":64,"blendMode":"passthrough"},"up":{"path":"zoom-2/up-2x.png","x":847.5,"y":114.5,"width":38,"height":64,"blendMode":"passthrough"},"down-active":{"path":"zoom-2/down-active-2x.png","x":583,"y":114.5,"width":38,"height":64,"blendMode":"passthrough"},"down-hover":{"path":"zoom-2/down-hover-2x.png","x":583,"y":114.5,"width":38,"height":64,"blendMode":"passthrough"},"down":{"path":"zoom-2/down-2x.png","x":583,"y":114.5,"width":38,"height":64,"blendMode":"passthrough"},"tt":{"path":"zoom-2/tt-2x.png","x":646.5,"y":135,"width":23.5,"height":23.5,"blendMode":"passthrough"},"amazon":{"path":"zoom-2/amazon-2x.png","x":677,"y":135,"width":23,"height":23.5,"blendMode":"passthrough"},"spotify":{"path":"zoom-2/spotify-2x.png","x":707,"y":135,"width":23.5,"height":23.5,"blendMode":"passthrough"},"itunes":{"path":"zoom-2/itunes-2x.png","x":737,"y":134.5,"width":24,"height":24,"blendMode":"passthrough"},"soundcloud":{"path":"zoom-2/soundcloud-2x.png","x":768,"y":135,"width":23,"height":23.5,"blendMode":"passthrough"},"lastfm":{"path":"zoom-2/lastfm-2x.png","x":798,"y":135,"width":23.5,"height":23.5,"blendMode":"passthrough"},"rdio":{"path":"zoom-2/rdio-2x.png","x":813.5,"y":135,"width":23,"height":23.5,"blendMode":"passthrough"},"progress-lit":{"path":"zoom-2/progress-lit-2x.png","x":665,"y":166,"width":138,"height":6.5,"blendMode":"normal"},"progress":{"path":"zoom-2/progress-2x.png","x":665,"y":166,"width":138,"height":6.5,"blendMode":"normal"},"board":{"path":"zoom-2/board-2x.png","x":575,"y":105.5,"width":318.5,"height":84.5,"blendMode":"passthrough"},"dial":{"path":"zoom-2/dial-2x.png","x":701,"y":85,"width":66,"height":65,"blendMode":"passthrough"},"needle":{"path":"zoom-2/needle-2x.png","x":732,"y":91,"width":3.5,"height":24.5,"blendMode":"normal"},"mac":{"path":"zoom-2/mac-2x.png","x":598,"y":259.5,"width":47,"height":34,"blendMode":"normal"},"lights0Normal":{"path":"zoom-2/lights0Normal-2x.png","x":119.5,"y":19.5,"width":1228.5,"height":18,"blendMode":"passthrough"},"lights0Add":{"path":"zoom-2/lights0Add-2x.png","x":523.5,"y":29.5,"width":421.5,"height":363,"blendMode":"lineardodge"},"lights1Normal":{"path":"zoom-2/lights1Normal-2x.png","x":119.5,"y":19.5,"width":1228.5,"height":18,"blendMode":"passthrough"},"lights1Add":{"path":"zoom-2/lights1Add-2x.png","x":484,"y":28,"width":500.5,"height":364.5,"blendMode":"lineardodge"},"lights2Normal":{"path":"zoom-2/lights2Normal-2x.png","x":40.5,"y":19.5,"width":1387,"height":345.5,"blendMode":"passthrough"},"lights2Add":{"path":"zoom-2/lights2Add-2x.png","x":0,"y":0,"width":1468,"height":436,"blendMode":"lineardodge"},"lights3Normal":{"path":"zoom-2/lights3Normal-2x.png","x":12.5,"y":19.5,"width":1443,"height":345.5,"blendMode":"passthrough"},"lights3Add":{"path":"zoom-2/lights3Add-2x.png","x":0,"y":0,"width":1468,"height":436,"blendMode":"lineardodge"},"screen":{"path":"zoom-2/screen-2x.png","x":614,"y":71.5,"width":240,"height":216.5,"blendMode":"normal"},"dj-table":{"path":"zoom-2/dj-table-2x.png","x":578,"y":284.5,"width":312,"height":35,"blendMode":"passthrough"},"stage":{"path":"zoom-2/stage-2x.png","x":0,"y":0,"width":1468,"height":373.5,"blendMode":"passthrough"},"curtain":{"path":"zoom-2/curtain-2x.png","x":526,"y":74,"width":416,"height":238.5,"blendMode":"passthrough"},"floor":{"path":"zoom-2/floor-2x.jpg","x":0,"y":331,"width":1468,"height":572.5,"blendMode":"passthrough"},"dj-light":{"path":"zoom-2/dj-light-2x.png","x":644,"y":182.5,"width":67,"height":92.5,"blendMode":"normal"},"record-pile":{"path":"zoom-2/record-pile-2x.png","x":829,"y":261.5,"width":37.5,"height":32.5,"blendMode":"normal"}},"zoom-1":{"dimensions":{"x":300,"y":0,"scale":1.25,"width":1468,"height":900},"up-active":{"path":"zoom-1/up-active-2x.png","x":886,"y":152,"width":50,"height":85,"blendMode":"passthrough"},"up-hover":{"path":"zoom-1/up-hover-2x.png","x":886,"y":152,"width":50,"height":86,"blendMode":"passthrough"},"up":{"path":"zoom-1/up-2x.png","x":886,"y":152,"width":50,"height":86,"blendMode":"passthrough"},"down-active":{"path":"zoom-1/down-active-2x.png","x":534.5,"y":152,"width":50,"height":86,"blendMode":"passthrough"},"down-hover":{"path":"zoom-1/down-hover-2x.png","x":534.5,"y":152,"width":50,"height":86,"blendMode":"passthrough"},"down":{"path":"zoom-1/down-2x.png","x":534.5,"y":152,"width":50,"height":86,"blendMode":"passthrough"},"tt":{"path":"zoom-1/tt-2x.png","x":618.5,"y":179.5,"width":31,"height":30.5,"blendMode":"passthrough"},"amazon":{"path":"zoom-1/amazon-2x.png","x":659,"y":179.5,"width":31,"height":30.5,"blendMode":"passthrough"},"spotify":{"path":"zoom-1/spotify-2x.png","x":699.5,"y":179.5,"width":30.5,"height":30.5,"blendMode":"passthrough"},"itunes":{"path":"zoom-1/itunes-2x.png","x":739,"y":179,"width":31,"height":31,"blendMode":"passthrough"},"soundcloud":{"path":"zoom-1/soundcloud-2x.png","x":780,"y":179.5,"width":30.5,"height":30.5,"blendMode":"passthrough"},"lastfm":{"path":"zoom-1/lastfm-2x.png","x":820,"y":179.5,"width":31,"height":30.5,"blendMode":"passthrough"},"rdio":{"path":"zoom-1/rdio-2x.png","x":840,"y":179.5,"width":31,"height":30.5,"blendMode":"passthrough"},"progress-lit":{"path":"zoom-1/progress-lit-2x.png","x":643.5,"y":220.5,"width":182.5,"height":8.5,"blendMode":"normal"},"progress":{"path":"zoom-1/progress-2x.png","x":643.5,"y":220.5,"width":182.5,"height":8.5,"blendMode":"normal"},"board":{"path":"zoom-1/board-2x.png","x":524,"y":139.5,"width":422.5,"height":112.5,"blendMode":"passthrough"},"dial":{"path":"zoom-1/dial-2x.png","x":691,"y":112,"width":87,"height":87.5,"blendMode":"passthrough"},"needle":{"path":"zoom-1/needle-2x.png","x":732.5,"y":121,"width":4,"height":32.5,"blendMode":"normal"},"mac":{"path":"zoom-1/mac-2x.png","x":554.5,"y":345,"width":62,"height":45,"blendMode":"normal"},"lights0Normal":{"path":"zoom-1/lights0Normal-2x.png","x":0,"y":26,"width":1468,"height":24,"blendMode":"passthrough"},"lights0Add":{"path":"zoom-1/lights0Add-2x.png","x":455.5,"y":39,"width":559,"height":482.5,"blendMode":"lineardodge"},"lights1Normal":{"path":"zoom-1/lights1Normal-2x.png","x":0,"y":26,"width":1468,"height":24,"blendMode":"passthrough"},"lights1Add":{"path":"zoom-1/lights1Add-2x.png","x":403,"y":37,"width":664.5,"height":484.5,"blendMode":"lineardodge"},"lights2Normal":{"path":"zoom-1/lights2Normal-2x.png","x":0,"y":26,"width":1468,"height":458.5,"blendMode":"passthrough"},"lights2Add":{"path":"zoom-1/lights2Add-2x.png","x":0,"y":0,"width":1468,"height":579,"blendMode":"lineardodge"},"lights3Normal":{"path":"zoom-1/lights3Normal-2x.png","x":0,"y":26,"width":1468,"height":458.5,"blendMode":"passthrough"},"lights3Add":{"path":"zoom-1/lights3Add-2x.png","x":0,"y":0,"width":1468,"height":579,"blendMode":"lineardodge"},"screen":{"path":"zoom-1/screen-2x.png","x":576,"y":95,"width":318,"height":287,"blendMode":"normal"},"dj-table":{"path":"zoom-1/dj-table-2x.png","x":527,"y":378,"width":415.5,"height":46,"blendMode":"passthrough"},"stage":{"path":"zoom-1/stage-2x.png","x":0,"y":0,"width":1468,"height":496,"blendMode":"passthrough"},"curtain":{"path":"zoom-1/curtain-2x.png","x":459,"y":98,"width":551.5,"height":316.5,"blendMode":"passthrough"},"floor":{"path":"zoom-1/floor-2x.jpg","x":0,"y":440,"width":1468,"height":460,"blendMode":"passthrough"},"dj-light":{"path":"zoom-1/dj-light-2x.png","x":615.5,"y":242,"width":88.5,"height":123.5,"blendMode":"normal"},"record-pile":{"path":"zoom-1/record-pile-2x.png","x":861.5,"y":347.5,"width":49,"height":42.5,"blendMode":"normal"}},"zoom-0":{"dimensions":{"x":484.5,"y":0,"scale":1,"width":1468,"height":900},"up-active":{"path":"zoom-0/up-active-2x.png","x":923,"y":190.5,"width":62,"height":105.5,"blendMode":"passthrough"},"up-hover":{"path":"zoom-0/up-hover-2x.png","x":923,"y":190.5,"width":62,"height":106.5,"blendMode":"passthrough"},"up":{"path":"zoom-0/up-2x.png","x":923,"y":190.5,"width":62,"height":106.5,"blendMode":"passthrough"},"down-active":{"path":"zoom-0/down-active-2x.png","x":484,"y":190.5,"width":62,"height":106.5,"blendMode":"passthrough"},"down-hover":{"path":"zoom-0/down-hover-2x.png","x":484,"y":190.5,"width":62,"height":106.5,"blendMode":"passthrough"},"down":{"path":"zoom-0/down-2x.png","x":484,"y":190.5,"width":62,"height":106.5,"blendMode":"passthrough"},"tt":{"path":"zoom-0/tt-2x.png","x":589,"y":224.5,"width":38,"height":38,"blendMode":"passthrough"},"amazon":{"path":"zoom-0/amazon-2x.png","x":639.5,"y":224.5,"width":38,"height":38,"blendMode":"passthrough"},"spotify":{"path":"zoom-0/spotify-2x.png","x":690,"y":224.5,"width":38,"height":38,"blendMode":"passthrough"},"itunes":{"path":"zoom-0/itunes-2x.png","x":739.5,"y":224,"width":38.5,"height":38.5,"blendMode":"passthrough"},"soundcloud":{"path":"zoom-0/soundcloud-2x.png","x":790.5,"y":224.5,"width":38,"height":38,"blendMode":"passthrough"},"lastfm":{"path":"zoom-0/lastfm-2x.png","x":841,"y":224.5,"width":38,"height":38,"blendMode":"passthrough"},"rdio":{"path":"zoom-0/rdio-2x.png","x":866,"y":224.5,"width":38,"height":38,"blendMode":"passthrough"},"progress-lit":{"path":"zoom-0/progress-lit-2x.png","x":620,"y":276,"width":228,"height":10,"blendMode":"normal"},"progress":{"path":"zoom-0/progress-2x.png","x":620,"y":276,"width":228,"height":10,"blendMode":"normal"},"board":{"path":"zoom-0/board-2x.png","x":470.5,"y":174.5,"width":528,"height":140.5,"blendMode":"passthrough"},"dial":{"path":"zoom-0/dial-2x.png","x":679.5,"y":140.5,"width":108.5,"height":108.5,"blendMode":"passthrough"},"needle":{"path":"zoom-0/needle-2x.png","x":731.5,"y":151.5,"width":4.5,"height":40,"blendMode":"normal"},"mac":{"path":"zoom-0/mac-2x.png","x":509,"y":431.5,"width":77,"height":55.5,"blendMode":"normal"},"lights0Normal":{"path":"zoom-0/lights0Normal-2x.png","x":17,"y":33,"width":1433.5,"height":29,"blendMode":"passthrough"},"lights0Add":{"path":"zoom-0/lights0Add-2x.png","x":385,"y":49,"width":698.5,"height":602.5,"blendMode":"lineardodge"},"lights1Normal":{"path":"zoom-0/lights1Normal-2x.png","x":17,"y":33,"width":1433.5,"height":29,"blendMode":"passthrough"},"lights1Add":{"path":"zoom-0/lights1Add-2x.png","x":319.5,"y":46.5,"width":830,"height":605,"blendMode":"lineardodge"},"lights2Normal":{"path":"zoom-0/lights2Normal-2x.png","x":0,"y":32.5,"width":1468,"height":573,"blendMode":"passthrough"},"lights2Add":{"path":"zoom-0/lights2Add-2x.png","x":0,"y":0,"width":1468,"height":716.5,"blendMode":"lineardodge"},"lights3Normal":{"path":"zoom-0/lights3Normal-2x.png","x":0,"y":32.5,"width":1468,"height":573,"blendMode":"passthrough"},"lights3Add":{"path":"zoom-0/lights3Add-2x.png","x":0,"y":0,"width":1468,"height":716.5,"blendMode":"lineardodge"},"screen":{"path":"zoom-0/screen-2x.png","x":535.5,"y":119,"width":397,"height":358.5,"blendMode":"normal"},"dj-table":{"path":"zoom-0/dj-table-2x.png","x":474.5,"y":472.5,"width":519,"height":57.5,"blendMode":"passthrough"},"stage":{"path":"zoom-0/stage-2x.png","x":0,"y":0,"width":1468,"height":620,"blendMode":"passthrough"},"curtain":{"path":"zoom-0/curtain-2x.png","x":389.5,"y":123,"width":689,"height":395,"blendMode":"passthrough"},"floor":{"path":"zoom-0/floor-2x.jpg","x":0,"y":550,"width":1468,"height":350,"blendMode":"passthrough"},"dj-light":{"path":"zoom-0/dj-light-2x.png","x":585,"y":303,"width":110,"height":153.5,"blendMode":"normal"},"record-pile":{"path":"zoom-0/record-pile-2x.png","x":892.5,"y":434.5,"width":61,"height":53,"blendMode":"normal"}}},"non-retina":{"zoom-2":{"dimensions":{"x":0,"y":0,"scale":1.66008174386921,"width":1468,"height":903.5},"up-active":{"path":"zoom-2/up-active.png","x":847,"y":114,"width":39,"height":65,"blendMode":"passthrough"},"up-hover":{"path":"zoom-2/up-hover.png","x":847,"y":114,"width":39,"height":65,"blendMode":"passthrough"},"up":{"path":"zoom-2/up.png","x":847,"y":114,"width":39,"height":65,"blendMode":"passthrough"},"down-active":{"path":"zoom-2/down-active.png","x":583,"y":114,"width":38,"height":65,"blendMode":"passthrough"},"down-hover":{"path":"zoom-2/down-hover.png","x":583,"y":114,"width":38,"height":65,"blendMode":"passthrough"},"down":{"path":"zoom-2/down.png","x":583,"y":114,"width":38,"height":65,"blendMode":"passthrough"},"tt":{"path":"zoom-2/tt.png","x":646,"y":135,"width":24,"height":24,"blendMode":"passthrough"},"amazon":{"path":"zoom-2/amazon.png","x":677,"y":135,"width":23,"height":24,"blendMode":"passthrough"},"spotify":{"path":"zoom-2/spotify.png","x":707,"y":135,"width":24,"height":24,"blendMode":"passthrough"},"itunes":{"path":"zoom-2/itunes.png","x":737,"y":134,"width":24,"height":25,"blendMode":"passthrough"},"soundcloud":{"path":"zoom-2/soundcloud.png","x":768,"y":135,"width":23,"height":24,"blendMode":"passthrough"},"lastfm":{"path":"zoom-2/lastfm.png","x":798,"y":135,"width":24,"height":24,"blendMode":"passthrough"},"rdio":{"path":"zoom-2/rdio.png","x":813,"y":135,"width":24,"height":24,"blendMode":"passthrough"},"progress-lit":{"path":"zoom-2/progress-lit.png","x":665,"y":166,"width":138,"height":7,"blendMode":"normal"},"progress":{"path":"zoom-2/progress.png","x":665,"y":166,"width":138,"height":7,"blendMode":"normal"},"board":{"path":"zoom-2/board.png","x":575,"y":105,"width":318,"height":86,"blendMode":"passthrough"},"dial":{"path":"zoom-2/dial.png","x":701,"y":85,"width":65,"height":65,"blendMode":"passthrough"},"needle":{"path":"zoom-2/needle.png","x":732,"y":91,"width":4,"height":25,"blendMode":"normal"},"mac":{"path":"zoom-2/mac.png","x":598,"y":259,"width":47,"height":35,"blendMode":"normal"},"lights0Normal":{"path":"zoom-2/lights0Normal.png","x":119,"y":19,"width":1229,"height":19,"blendMode":"passthrough"},"lights0Add":{"path":"zoom-2/lights0Add.png","x":523,"y":29,"width":422,"height":363,"blendMode":"lineardodge"},"lights1Normal":{"path":"zoom-2/lights1Normal.png","x":119,"y":19,"width":1229,"height":19,"blendMode":"passthrough"},"lights1Add":{"path":"zoom-2/lights1Add.png","x":484,"y":29,"width":501,"height":363,"blendMode":"lineardodge"},"lights2Normal":{"path":"zoom-2/lights2Normal.png","x":41,"y":19,"width":1387,"height":347,"blendMode":"passthrough"},"lights2Add":{"path":"zoom-2/lights2Add.png","x":0,"y":0,"width":1468,"height":436,"blendMode":"lineardodge"},"lights3Normal":{"path":"zoom-2/lights3Normal.png","x":12,"y":19,"width":1444,"height":347,"blendMode":"passthrough"},"lights3Add":{"path":"zoom-2/lights3Add.png","x":0,"y":0,"width":1468,"height":436,"blendMode":"lineardodge"},"screen":{"path":"zoom-2/screen.png","x":614,"y":71,"width":240,"height":218,"blendMode":"normal"},"dj-table":{"path":"zoom-2/dj-table.png","x":578,"y":284,"width":312,"height":36,"blendMode":"passthrough"},"stage":{"path":"zoom-2/stage.png","x":0,"y":0,"width":1468,"height":374,"blendMode":"passthrough"},"curtain":{"path":"zoom-2/curtain.png","x":526,"y":74,"width":416,"height":239,"blendMode":"passthrough"},"floor":{"path":"zoom-2/floor.jpg","x":0,"y":331,"width":1468,"height":573,"blendMode":"passthrough"},"dj-light":{"path":"zoom-2/dj-light.png","x":644,"y":182,"width":67,"height":94,"blendMode":"normal"},"record-pile":{"path":"zoom-2/record-pile.png","x":829,"y":261,"width":38,"height":34,"blendMode":"normal"}},"zoom-1":{"dimensions":{"x":300,"y":0,"scale":1.25,"width":1468,"height":900},"up-active":{"path":"zoom-1/up-active.png","x":886,"y":152,"width":50,"height":85,"blendMode":"passthrough"},"up-hover":{"path":"zoom-1/up-hover.png","x":886,"y":152,"width":50,"height":85,"blendMode":"passthrough"},"up":{"path":"zoom-1/up.png","x":886,"y":152,"width":50,"height":85,"blendMode":"passthrough"},"down-active":{"path":"zoom-1/down-active.png","x":534,"y":152,"width":51,"height":85,"blendMode":"passthrough"},"down-hover":{"path":"zoom-1/down-hover.png","x":534,"y":152,"width":51,"height":85,"blendMode":"passthrough"},"down":{"path":"zoom-1/down.png","x":534,"y":152,"width":51,"height":85,"blendMode":"passthrough"},"tt":{"path":"zoom-1/tt.png","x":618,"y":179,"width":32,"height":31,"blendMode":"passthrough"},"amazon":{"path":"zoom-1/amazon.png","x":659,"y":179,"width":31,"height":31,"blendMode":"passthrough"},"spotify":{"path":"zoom-1/spotify.png","x":699,"y":179,"width":31,"height":31,"blendMode":"passthrough"},"itunes":{"path":"zoom-1/itunes.png","x":739,"y":179,"width":31,"height":31,"blendMode":"passthrough"},"soundcloud":{"path":"zoom-1/soundcloud.png","x":780,"y":179,"width":31,"height":31,"blendMode":"passthrough"},"lastfm":{"path":"zoom-1/lastfm.png","x":820,"y":179,"width":31,"height":31,"blendMode":"passthrough"},"rdio":{"path":"zoom-1/rdio.png","x":840,"y":179,"width":31,"height":31,"blendMode":"passthrough"},"progress-lit":{"path":"zoom-1/progress-lit.png","x":643,"y":220,"width":183,"height":9,"blendMode":"normal"},"progress":{"path":"zoom-1/progress.png","x":643,"y":220,"width":183,"height":9,"blendMode":"normal"},"board":{"path":"zoom-1/board.png","x":524,"y":139,"width":422,"height":113,"blendMode":"passthrough"},"dial":{"path":"zoom-1/dial.png","x":691,"y":113,"width":87,"height":87,"blendMode":"passthrough"},"needle":{"path":"zoom-1/needle.png","x":732,"y":121,"width":5,"height":33,"blendMode":"normal"},"mac":{"path":"zoom-1/mac.png","x":554,"y":345,"width":63,"height":45,"blendMode":"normal"},"lights0Normal":{"path":"zoom-1/lights0Normal.png","x":0,"y":26,"width":1468,"height":24,"blendMode":"passthrough"},"lights0Add":{"path":"zoom-1/lights0Add.png","x":455,"y":39,"width":560,"height":483,"blendMode":"lineardodge"},"lights1Normal":{"path":"zoom-1/lights1Normal.png","x":0,"y":26,"width":1468,"height":24,"blendMode":"passthrough"},"lights1Add":{"path":"zoom-1/lights1Add.png","x":403,"y":37,"width":665,"height":485,"blendMode":"lineardodge"},"lights2Normal":{"path":"zoom-1/lights2Normal.png","x":0,"y":26,"width":1468,"height":459,"blendMode":"passthrough"},"lights2Add":{"path":"zoom-1/lights2Add.png","x":0,"y":0,"width":1468,"height":579,"blendMode":"lineardodge"},"lights3Normal":{"path":"zoom-1/lights3Normal.png","x":0,"y":26,"width":1468,"height":459,"blendMode":"passthrough"},"lights3Add":{"path":"zoom-1/lights3Add.png","x":0,"y":0,"width":1468,"height":579,"blendMode":"lineardodge"},"screen":{"path":"zoom-1/screen.png","x":576,"y":95,"width":318,"height":287,"blendMode":"normal"},"dj-table":{"path":"zoom-1/dj-table.png","x":528,"y":378,"width":414,"height":46,"blendMode":"passthrough"},"stage":{"path":"zoom-1/stage.png","x":0,"y":0,"width":1468,"height":496,"blendMode":"passthrough"},"curtain":{"path":"zoom-1/curtain.png","x":459,"y":98,"width":552,"height":317,"blendMode":"passthrough"},"floor":{"path":"zoom-1/floor.jpg","x":0,"y":440,"width":1468,"height":460,"blendMode":"passthrough"},"dj-light":{"path":"zoom-1/dj-light.png","x":616,"y":242,"width":88,"height":124,"blendMode":"normal"},"record-pile":{"path":"zoom-1/record-pile.png","x":861,"y":347,"width":50,"height":43,"blendMode":"normal"}},"zoom-0":{"dimensions":{"x":484.5,"y":0,"scale":1,"width":1468,"height":900},"up-active":{"path":"zoom-0/up-active.png","x":923,"y":190,"width":62,"height":106,"blendMode":"passthrough"},"up-hover":{"path":"zoom-0/up-hover.png","x":923,"y":190,"width":62,"height":107,"blendMode":"passthrough"},"up":{"path":"zoom-0/up.png","x":923,"y":190,"width":62,"height":107,"blendMode":"passthrough"},"down-active":{"path":"zoom-0/down-active.png","x":484,"y":190,"width":62,"height":107,"blendMode":"passthrough"},"down-hover":{"path":"zoom-0/down-hover.png","x":484,"y":190,"width":62,"height":107,"blendMode":"passthrough"},"down":{"path":"zoom-0/down.png","x":484,"y":190,"width":62,"height":107,"blendMode":"passthrough"},"tt":{"path":"zoom-0/tt.png","x":589,"y":224,"width":38,"height":39,"blendMode":"passthrough"},"amazon":{"path":"zoom-0/amazon.png","x":639,"y":224,"width":39,"height":39,"blendMode":"passthrough"},"spotify":{"path":"zoom-0/spotify.png","x":690,"y":224,"width":38,"height":39,"blendMode":"passthrough"},"itunes":{"path":"zoom-0/itunes.png","x":739,"y":224,"width":39,"height":39,"blendMode":"passthrough"},"soundcloud":{"path":"zoom-0/soundcloud.png","x":790,"y":224,"width":39,"height":39,"blendMode":"passthrough"},"lastfm":{"path":"zoom-0/lastfm.png","x":841,"y":224,"width":38,"height":39,"blendMode":"passthrough"},"rdio":{"path":"zoom-0/rdio.png","x":866,"y":224,"width":38,"height":39,"blendMode":"passthrough"},"progress-lit":{"path":"zoom-0/progress-lit.png","x":620,"y":276,"width":228,"height":10,"blendMode":"normal"},"progress":{"path":"zoom-0/progress.png","x":620,"y":276,"width":228,"height":10,"blendMode":"normal"},"board":{"path":"zoom-0/board.png","x":470,"y":175,"width":529,"height":140,"blendMode":"passthrough"},"dial":{"path":"zoom-0/dial.png","x":679,"y":141,"width":109,"height":108,"blendMode":"passthrough"},"needle":{"path":"zoom-0/needle.png","x":731,"y":151,"width":5,"height":41,"blendMode":"normal"},"mac":{"path":"zoom-0/mac.png","x":509,"y":431,"width":77,"height":56,"blendMode":"normal"},"lights0Normal":{"path":"zoom-0/lights0Normal.png","x":17,"y":33,"width":1434,"height":29,"blendMode":"passthrough"},"lights0Add":{"path":"zoom-0/lights0Add.png","x":385,"y":50,"width":699,"height":601,"blendMode":"lineardodge"},"lights1Normal":{"path":"zoom-0/lights1Normal.png","x":17,"y":33,"width":1434,"height":29,"blendMode":"passthrough"},"lights1Add":{"path":"zoom-0/lights1Add.png","x":319,"y":47,"width":831,"height":604,"blendMode":"lineardodge"},"lights2Normal":{"path":"zoom-0/lights2Normal.png","x":0,"y":32,"width":1468,"height":574,"blendMode":"passthrough"},"lights2Add":{"path":"zoom-0/lights2Add.png","x":0,"y":0,"width":1468,"height":717,"blendMode":"lineardodge"},"lights3Normal":{"path":"zoom-0/lights3Normal.png","x":0,"y":32,"width":1468,"height":574,"blendMode":"passthrough"},"lights3Add":{"path":"zoom-0/lights3Add.png","x":0,"y":0,"width":1468,"height":717,"blendMode":"lineardodge"},"screen":{"path":"zoom-0/screen.png","x":535,"y":119,"width":398,"height":359,"blendMode":"normal"},"dj-table":{"path":"zoom-0/dj-table.png","x":475,"y":472,"width":518,"height":58,"blendMode":"passthrough"},"stage":{"path":"zoom-0/stage.png","x":0,"y":0,"width":1468,"height":620,"blendMode":"passthrough"},"curtain":{"path":"zoom-0/curtain.png","x":389,"y":123,"width":690,"height":395,"blendMode":"passthrough"},"floor":{"path":"zoom-0/floor.jpg","x":0,"y":550,"width":1468,"height":350,"blendMode":"passthrough"},"dj-light":{"path":"zoom-0/dj-light.png","x":585,"y":303,"width":110,"height":154,"blendMode":"normal"},"record-pile":{"path":"zoom-0/record-pile.png","x":892,"y":434,"width":62,"height":54,"blendMode":"normal"}}}},"sceneDimensions":{"width":2437,"height":1500,"scale":1.53846153846154,"centerX":1218.5,"centerY":591.5},"props":{"dj-1":{"x":1032,"y":487,"width":20,"height":20},"dj-2":{"x":1078.5,"y":487,"width":20,"height":20},"dj-3":{"x":1125.5,"y":487,"width":20,"height":20},"dj-4":{"x":1172,"y":487,"width":20,"height":20},"dj-5":{"x":1218.5,"y":487,"width":20,"height":20},"dj-6":{"x":1265,"y":487,"width":20,"height":20},"dj-7":{"x":1312,"y":487,"width":20,"height":20},"dj-8":{"x":1358.5,"y":487,"width":20,"height":20},"dj-9":{"x":1405,"y":487,"width":20,"height":20},"dial-center":{"x":1218,"y":186,"width":47,"height":47},"songboard":{"x":1039.5,"y":190.5,"width":358.5,"height":105},"right-screen":{"x":1624,"y":156.5,"width":378.5,"height":315.5},"left-screen":{"x":433.5,"y":156.5,"width":378.5,"height":315.5},"curtain":{"x":874,"y":123,"width":689,"height":395},"right-screen-frame":{"x":1614,"y":119,"width":100.5,"height":95.5},"left-screen-frame":{"x":423.5,"y":119,"width":100.5,"height":95.5}},"text":{"add":{"size":17,"x":1218.5,"y":214},"service":{"size":17,"x":1218.5,"y":286.5},"time-remaining":{"size":14,"x":1389,"y":286},"time":{"size":14,"x":1049,"y":286},"title":{"size":20,"x":1218,"y":262},"artist":{"size":45,"x":1218.5,"y":237.5}}}\n'}),define("text!blackswan/../../images/concert-scene/config.json",[],function(){return'{\n    "path": "/roommanager_assets/concert-scene/",\n    "layers": [\n        "floor",\n        "curtain",\n        "stage",\n        "screen"\n    ],\n    "screens": {\n        "curtain": {\n            "image": "curtain",\n            "mask": false\n        },\n        "leftScreen": {\n            "image": "left-screen",\n            "mask": true\n        },\n        "rightScreen": {\n            "image": "right-screen",\n            "mask": true\n        }\n    }\n}'}),define("blackswan/scene-config",["require","underscore","class","text!../../images/concert-scene/output.json","text!../../images/concert-scene/config.json"],function(e){var t=e("underscore"),i=e("class"),n=e("text!../../images/concert-scene/output.json"),o=e("text!../../images/concert-scene/config.json");n=JSON.parse(n),o=JSON.parse(o);var s=!1,r=n.images["non-retina"];window.devicePixelRatio>1&&(s=!0,r=n.images.retina);var a=function(e,t){var i=t.dimensions,n=i.scale;return{x:(e.x-i.x)/n,y:(e.y-i.y)/n,width:e.width/n,height:e.height/n,scale:(e.scale||1)/n}},l=function(e,t){var i=t.dimensions,n=i.scale;return{x:i.x+e.x*n,y:i.y+e.y*n,width:e.width*n,height:e.height*n,scale:(e.scale||1)*n}},u=function(e){var t=n.sceneDimensions,i=t.scale;return{x:(e.x-t.centerX)*i,y:(t.centerY-e.y)*i,z:0,scale:(e.scale||1)*i,width:e.width,height:e.height}},d=i.extend({init:function(e){this.data=t.clone(e)},asLocation:function(){return t.extend({},this.data,u(this.data))},asSceneCoords:function(){return t.clone(this.data)},asLevelCoords:function(e){return e=e||0,t.isNumber(e)&&(e="zoom-"+e),t.extend({},this.data,a(this.data,r[e]))}},{_name:"SceneLayer"}),h=d.extend({asLocation:function(){var e=l(this.data,r[this.data.zoomLevel]),i=u(e);return t.extend({},this.data,i)},asSceneCoords:function(){return t.extend({},this.data,l(this.data,r[this.data.zoomLevel]))},asLevelCoords:function(e){if(e=e||0,t.isNumber(e)&&(e="zoom-"+e),e===this.data.zoomLevel)return t.clone(this.data);var i=l(this.data,r[this.data.zoomLevel]);return t.extend({},this.data,a(i,r[e]))}},{_name:"ImageLayer"}),c=i.extend({init:function(){this.path=o.path,this.data=n,this.config=o,this.retina=s,this.images=r,this.sceneDimensions=n.sceneDimensions,this.props=n.props,this.text=n.text,this.scale=this.sceneDimensions.scale},getImageLayer:function(e,i){i=i||0,t.isNumber(i)&&(i="zoom-"+i);var n=t.clone(this.images[i][e]);return n?(n.zoomLevel=i,n.src=this.path+n.path,new h(n)):void 0},getPropLayer:function(e){var t=this.props[e];return t?new d(t):void 0},getTextLayer:function(e){var t=this.text[e];return t?new d(t):void 0},sceneToLevel:function(e,t){var i=this.images[t];return a(e,i)},levelToScene:function(e,t){var i=this.images[t];return l(e,i)},sceneToLocation:u,getDjLocation:function(e,t){var i=2*(t-1),n=-i/2+2*e,o=5+n;return this.getPropLayer("dj-"+o).asLocation()}},{_name:"SceneConfig"});return c}),define("blackswan/scene-background",["require","underscore","pixi","blackswan/base-object"],function(e){var t=e("underscore"),i=e("pixi"),n=e("blackswan/base-object"),o=i.Texture.fromImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2NkAAIAAAoAAggA9GkAAAAASUVORK5CYII="),s={scale:1,lightLevel:0},r=n.extend({init:function(e){this._super(t.extend({},s,e)),this.images=this.sceneConfig.images,this.config=this.sceneConfig.config,this.sceneDimensions=this.sceneConfig.sceneDimensions,this.props=this.sceneConfig.props,this.scale=this.sceneConfig.scale,this.onImageLoad=t.bind(this.onImageLoad,this),this.sceneMaking={},this.cachedScenes={},this.makeCachedScene=util.delay(this,this.makeCachedScene,50)
},makeScene:function(e){var t=this.getRenderKey(e),n=this.sceneMaking[t];if(n)return n;n=this.sceneMaking[t]=$.Deferred();var o=this.config.layers.slice();o.push("lights"+e.lightLevel+"Add"),o.push("lights"+e.lightLevel+"Normal");var s=this;return this.loadImages(o,e).done(function(){var r=s._drawScene(o,e);s.cachedScenes[t]={texture:new i.Texture(new i.BaseTexture(r.img)),dimensions:r.dimensions},n.resolve()}),n.promise()},_drawScene:function(e,i){var n=document.createElement("canvas"),o=n.getContext("2d"),s=this.config,r=this.images[i.zoomName],a=(this.sceneDimensions,r.dimensions),l=(a.scale,this.scale,this.lightsRegex);if(this.props,n.width=a.width,n.height=a.height,this.sceneConfig.retina&&(n.width*=2,n.height*=2,o.scale(2,2)),t.each(e,$.proxy(function(e){var u=r[e],d=u.img;if("curtain"!==e||!i.isCurtainScreenVisible){if("screen"===e){if(!i.areSideScreensVisible)return;var h=this.sceneConfig.getPropLayer("left-screen-frame").asLevelCoords(i.zoomName),c=this.sceneConfig.getPropLayer("right-screen-frame").asLevelCoords(i.zoomName);return o.drawImage(d,h.x,h.y,u.width,u.height),o.drawImage(d,c.x,c.y,u.width,u.height),void 0}if(l.test(e)){i.areSideScreensVisible&&t.each(s.screens,$.proxy(function(e){if(e.mask){var t=this.sceneConfig.getPropLayer(e.image).asLevelCoords(i.zoomName);o.clearRect(t.x,t.y,t.width,t.height)}},this));var p=[];i.areSideScreensVisible&&(p=[s.screens.leftScreen,s.screens.rightScreen]),i.isCurtainScreenVisible&&p.push(s.screens.curtain),t.each(p,$.proxy(function(t){var o=this.sceneConfig.getPropLayer(t.image).asLevelCoords(i.zoomName),s=-1!==e.indexOf("Add"),r=s?.4:0;d=this.adjustLightingOverScreen(d,u,n,a,o,r)},this))}"lineardodge"==u.blendMode&&(o.globalCompositeOperation="lighter"),o.drawImage(d,u.x,u.y,u.width,u.height),"lineardodge"==u.blendMode&&(o.globalCompositeOperation="source-over")}},this)),"zoom-2"===i.zoomName){var u=n.width/2,d=u,h=0,c=.9*d,p=o.createRadialGradient(u,h,c,u,h,d);p.addColorStop(0,"rgba(0, 0, 0, 0)"),p.addColorStop(1,"rgba(0, 0, 0, 1)"),o.fillStyle=p,o.fillRect(0,0,n.width,n.height)}return{dimensions:a,img:n}},adjustLightingOverScreen:function(e,t,i,n,o,s){var r=t,a=n,l=o,u=util.buildTree(["canvas",{width:r.width,height:r.height}]),d=u.getContext("2d"),h=util.buildTree(["canvas",{width:l.width,height:l.height}]),c=util.buildTree(["canvas",{width:l.width,height:l.height}]);d.drawImage(e,0,0,r.width,r.height),h.getContext("2d").drawImage(e,r.x-l.x,r.y-l.y,r.width,r.height),c.getContext("2d").drawImage(i,-l.x,-l.y,a.width,a.height);var p=util.buildTree(["canvas",{width:l.width,height:l.height}]),f=p.getContext("2d");f.drawImage(h,0,0),f.globalCompositeOperation="destination-in",f.drawImage(c,0,0);var m=util.buildTree(["canvas",{width:l.width,height:l.height}]),g=m.getContext("2d");return g.drawImage(h,0,0),g.globalCompositeOperation="destination-out",g.drawImage(c,0,0),d.clearRect(l.x-r.x,l.y-r.y,l.width,l.height),d.drawImage(p,l.x-r.x,l.y-r.y),d.globalAlpha=s,d.drawImage(m,l.x-r.x,l.y-r.y),d.globalAlpha=1,u},determineZoomLevelForScale:function(e){var t,i,n,o=e.scale*e.renderer.xScale*this.scale,s=0;do{if(t="zoom-"+s,i=this.images[t],!i)break;n=i.dimensions.scale,s++}while(1/n>o);return t},determineZoomLevelForFit:function(e){var t,i,n,o,s,r,a,l=e.renderer.camera,u=this.z,d=l.reverseProjectLocation({x:0,y:0},u),h=l.reverseProjectLocation({x:1,y:1},u),c=d.x,p=h.x,f=(h.y,d.y,0);do{if(t="zoom-"+f,i=this.images[t],!i){t="zoom-"+(f-1);break}n=i.dimensions,d=this.sceneConfig.sceneToLocation(n),h=this.sceneConfig.sceneToLocation({x:n.x+n.width*n.scale,y:n.y+n.height*n.scale}),o=d.x,s=h.x,r=h.y,a=d.y,f++}while(o>c||p>s);return t},loadImages:function(e,i){var n=this.images[i.zoomName],o=this.config,s=[];return t.each(e,function(e){var t=n[e];if(t.img,!t.img||!t.loading){var i=util.createImageWithLoader(o.path+t.path);t.img=i[0],t.loading=i[1]}s.push(t.loading)}),$.when.apply(null,s)},onImageLoad:function(){this.trigger("change",this)},getRenderKey:function(e){var t=e.areSideScreensVisible,i=e.isCurtainScreenVisible;return e.zoomName+e.lightLevel+t+i},lightsRegex:/lights.*/,View:n.prototype.View.extend({methodsToBind:["updateSprite"],blah:!0,init:function(e,t){this._super.apply(this,arguments),this.pixiObject=new i.Sprite(o),this.listenTo(t,"change:camera",this.updateSprite),this.listenTo(e,"change",this.updateSprite),this.makeRequested={}},getRenderState:function(){var e=this.object;return{areSideScreensVisible:e.areSideScreensVisible,isCurtainScreenVisible:e.isCurtainScreenVisible,zoomName:this.zoomName,lightLevel:e.lightLevel}},updateSprite:function(){var e=this.object,t=(this.zoomName=e.determineZoomLevelForFit(this),this.getRenderState()),i=e.getRenderKey(t),n=e.cachedScenes[i];if(n){var o=this.pixiObject;if(n.texture!==o.texture){o.setTexture(n.texture);var s=n.dimensions;o.anchor.x=(e.sceneDimensions.centerX-s.x)/s.scale/s.width,o.anchor.y=(e.sceneDimensions.centerY-s.y)/s.scale/s.height;var r=e.scale*s.scale;this.object.sceneConfig.retina&&(r/=2),this.set({viewScale:r})}}else this.makeRequested[i]||(this.makeRequested[i]=!0,e.makeScene(t).done(this.updateSprite))}},{_name:"SceneBackgroundView"})},{_name:"SceneBackground"});return r}),define("blackswan/songboard",["require","underscore","util","app","blackswan/dom-pane","views/songboard"],function(e){var t=e("underscore"),i=e("util"),n=e("app"),o=e("blackswan/dom-pane"),s=e("views/songboard"),r={useTransforms:!0},a=o.extend({init:function(e){this._super(t.extend({},r,e));var o=this.room=n.room;this.songboard=new s({className:"room-view-board",model:o.currentSongPlay,songVote:o.songVote});var a=this.sceneConfig,l=a.getImageLayer("board").asLocation();this.scale=l.scale,this.width=l.width,this.height=l.height,this.$el.append(this.songboard.el),this.nodes=this.songboard.nodes;var u=a.getImageLayer("board").asLevelCoords(),d=a.getPropLayer("songboard").asLevelCoords();t.each(this.nodes,function(e,t){var i=$(e),n=a.getImageLayer(t),o=i.parents(".songboard").length?d:u;if(n)return n=n.asLevelCoords(),i.css({position:"absolute",backgroundImage:"url("+n.src+")",backgroundSize:"cover",top:n.y-o.y,left:n.x-o.x,width:n.width,height:n.height}),void 0;var s,r=a.getPropLayer(t);if(r)return s=r.asLevelCoords(),$(e).css({position:"absolute",top:s.y-o.y,left:s.x-o.x,width:s.width,height:s.height}),void 0;var l=a.getTextLayer(t);return l?(s=l.asLevelCoords(),$(e).css({top:s.y-o.y,fontSize:s.size}),void 0):void 0}),$(this.nodes["progress-lit"]).css({top:0,left:0});var h=a.getTextLayer("time").asLevelCoords(),c=a.getTextLayer("time-remaining").asLevelCoords();$([this.nodes.time,this.nodes["time-remaining"]]).css({left:h.x-d.x,width:c.x-h.x});var p=a.getPropLayer("dial-center").asLevelCoords(),f=a.getImageLayer("needle").asLevelCoords(),m=p.x-f.x,g=p.y-f.y;this.$needle=$(this.nodes.needle).css("transform-origin",m+"px "+g+"px"),$(this.nodes.dial).css("z-index",-2),$(this.nodes.needle).css("z-index",-1),$([this.nodes.up,this.nodes.down]).css("background","");var v=a.getTextLayer("service").asLevelCoords(),b={".room-view-board .awesome-button":{background:"url("+a.getImageLayer("up").data.src+") top left no-repeat","background-size":"contain"},".room-view-board.song-playing .awesome-button:hover":{"background-image":"url("+a.getImageLayer("up-hover").data.src+")"},".room-view-board.song-playing .awesome-button:active, .room-view-board .awesome-button.selected, .room-view-board .awesome-button.selected:hover":{"background-image":"url("+a.getImageLayer("up-active").data.src+")"},".room-view-board .lame-button":{background:"url("+a.getImageLayer("down").data.src+") top left no-repeat","background-size":"contain"},".room-view-board.song-playing .lame-button:hover":{"background-image":"url("+a.getImageLayer("down-hover").data.src+")"},".room-view-board.song-playing .lame-button:active, .room-view-board .lame-button.selected, .room-view-board .lame-button.selected:hover":{"background-image":"url("+a.getImageLayer("down-active").data.src+")"},".room-view-board .service-name":{top:v.y-d.y+"px"}};this.styleTag=i.css(b)},cleanup:function(){$(this.styleTag).remove(),this.room=void 0,this.songboard.remove(),this.stopListening()},moveNeedle:function(e){var t=70*(2*e-1);this.$needle.css("transform","rotate("+t+"deg)")}},{_name:"Songboard"});return a}),define("blackswan/sprite",["require","pixi","util","blackswan/base-object"],function(e){var t=e("pixi"),i=(e("util"),e("blackswan/base-object")),n={src:null},o=i.extend({init:function(e){if(!e.src)throw"no image src provided";this._super(_.extend({},n,e));var i=this._loading=$.Deferred();this.loading=i.promise();var o=this.texture=t.Texture.fromImage(e.src);o.baseTexture.hasLoaded?i.resolve():o.on("update",$.proxy(this.onTextureLoad,this))},onTextureLoad:function(){this._loading.resolve(),this.texture.baseTexture.off("loaded",this.onTextureLoad)},View:i.prototype.View.extend({methodsToBind:["setAnchor"],init:function(e){this._super.apply(this,arguments);var i=this.pixiObject=new t.Sprite(e.texture);"source-over"!==e.globalCompositeOperation&&(i.globalCompositeOperation=e.globalCompositeOperation),e.loading.done(this.setAnchor)},setAnchor:function(){var e=this.pixiObject.anchor,t=this.object;e.x=-t.offsetX/t.width,e.y=-t.offsetY/t.height,this.set({viewScale:this.viewScale*t.width/t.texture.width})}})},{_name:"Sprite"});return o}),$.fx.step.path=function(e){var t=e.end.css(1-e.pos);for(var i in t)e.elem.style[i]=t[i]},define("lib/jquery.step.path",function(){}),define("jkzzcP/jkzzcP",["require","backbone","util","action-modal","animation","app","blackswan/avatar-object","avatar-popover","blackswan/config","views/camera-control","blackswan/canvas-renderer","views/chatsticker-picker","config","blackswan/dom-pane","blackswan/dom-renderer","blackswan/fixed-orientation-camera","blackswan/laptop","blackswan/pixi-renderer","blackswan/renderer-mouse-adapter","blackswan/mouse-map-renderer","blackswan/scene","blackswan/scene-config","blackswan/scene-background","blackswan/songboard","blackswan/sprite","tt-base","lib/jquery.step.path"],function(e){var t=e("backbone"),i=e("util"),n=e("action-modal"),o=e("animation"),s=e("app"),r=e("blackswan/avatar-object"),a=e("avatar-popover"),l=e("blackswan/config"),u=e("views/camera-control"),d=e("blackswan/canvas-renderer"),h=e("views/chatsticker-picker"),c=(e("config"),e("blackswan/dom-pane")),p=e("blackswan/dom-renderer"),f=e("blackswan/fixed-orientation-camera"),m=e("blackswan/laptop"),g=e("blackswan/pixi-renderer"),v=e("blackswan/renderer-mouse-adapter"),b=e("blackswan/mouse-map-renderer"),w=e("blackswan/scene"),y=e("blackswan/scene-config"),x=e("blackswan/scene-background"),S=e("blackswan/songboard"),k=e("blackswan/sprite"),C=e("tt-base");e("lib/jquery.step.path"),window.MvxTJL=null;var T,I=null,M={},P=10,A=100,E=500,D=3e5,R=10,L=170,O={x:0,y:850,z:2500},j=1400,F=2500,B=3600,N=2,z=5,V=70,q=[1.5,2],U=[600,500,400,300];$(function(){T=$(window)});var X,H={},W=C.View.extend({options:{idd:"roomView",numDjSpots:5,callback:null,model:null,roomData:{},listenerids:[],crowdControl:{},addToDOM:$.Deferred(),prefs:null},el:function(){var e=["div#room-view.room-viewport"];return e},init:function(){this.room=this.options.room,this.roomData=this.options.roomData,this.callback=this.options.callback,this.avatarMap={},this.listenerMap={},this.djs={},this.djsBySpot=[],this.$fusWBa=null,this.$inviteDj=null,this.recordPiles=[],this.popovers={},this.marqueeTexts={},this.numAvatars=0,this.avatarMap={},this.objectIdToUserId={},this.setScreenConfigSrc(),this.listenTo(this.options.crowdControl,"change",this.resetListenerLocations),this._transitionCamera=i.makeDrawer(this,this._transitionCamera),this.delayedMoveCameraToFit=i.delay(this,this.moveCameraToFit,50),this.setCameraPosition=i.makeDrawer(this,this.setCameraPosition),this.monitorStats=i.makeDrawer(this,this.monitorStats),this.degradationLevel=0,this.numGoodStats=0,this.degradationHistory=[0],this.numInflections=0;var e=i.getSetting("allowGraphicsDegradation");this.wasGraphicsModalShown=!!e,this.hasAllowedDegradation="true"===i.getSetting("allowGraphicsDegradation"),this.maxAvg=0,this.avgs=[],this.consecutiveSongChanges=0,this.isShowingFuntimes=!1,this.render()},methodsToBind:[/(add|remove)CrowdMember/,/(start|stop)Bopping/,"resetCamera","sendGraphicsStats","cancelObjectPopoverShow","resetListenerLocations","makeRenderGroup",/onObject/,"onMousewheel",/on.*SettingChange/],renderGroups:[{name:"screen",renderer:p},{name:"stage",renderer:d},{name:"dj",renderer:d,start:!0},{name:"audience",renderer:g,start:!0},{name:"overlay",renderer:p,limitSortRate:!1,className:"mouse-map"},{name:"mouseMap",renderer:b,type:"canvas",hide:!0}],zIndexes:{audience:0,dj:0,light:1,activeDj:2,djTable:3,recordPile:4,laptop:4,spotlight:5},render:function(){var e=this,t=this.room.section;X?(this.camera=X,this.setCameraPosition({x:X.x,y:X.y,z:X.z})):(X=this.camera=new f(_.extend({focalLength:1.5},O)),this.setCameraPosition(O)),_.each(this.renderGroups,this.makeRenderGroup),this.mouseMapRenderer.renderOnNextFrame=i.delay(this.mouseMapRenderer,b.prototype.render,100),this.setupMouseEvents();var n=this.sceneConfig=new y("concert");this.setupSongboard();var o=this.sceneBackground=new x({sceneConfig:n});_.each({curtain:{propName:"curtain"},left:{propName:"left-screen",className:"side-screen",id:"left-screen",link:!0},right:{propName:"right-screen",className:"side-screen",id:"right-screen",link:!0}},function(e,t){var o=n.getPropLayer(e.propName).asLocation(),s=_.extend({useTransforms:!0},o),r=this[t+"ScreenContainer"]=new c(s);r.$el.addClass("screen"+(e.className?" "+e.className:"")).append(i.buildTree(["iframe.screen-content",{scrolling:"no",frameborder:"none"}])),e.id&&r.$el.attr("id",e.id),e.link&&(r=this[t+"LinkContainer"]=new c(_.extend({},s,{width:300,height:250,scale:1.26*s.scale})),r.$el.addClass("screen-link").append(i.buildTree(["iframe.screen-content",{scrolling:"no",frameborder:"none"}])),r.$el.append(i.buildTree(["a.why-ads",{href:"http://blog.turntable.fm/whyads",target:"_blank"},"why ads?"])))},this),this.drawScreens(),this.stageScene.add(o);var r=n.getImageLayer("dj-table").asLocation(),a=this.djTable=new k(_.extend({zIndex:this.zIndexes.djTable,shouldExcludeFromBoundingBox:!0},r));this.djScene.add(a);var l=n.getImageLayer("dj-light"),d=n.getPropLayer("dj-3"),h=l.asLocation();this.spotlightInitialPosition={x:h.x,y:h.y,z:h.z},_.extend(h,{shouldExcludeFromBoundingBox:!0,offsetX:l.asSceneCoords().x-d.asSceneCoords().x,zIndex:this.zIndexes.spotlight,globalCompositeOperation:"lighter"}),this.spotlight=new k(h),this.drawLightsOverDjs();for(var p=n.getImageLayer("record-pile").asLocation(),m={src:p.src,width:p.width,height:p.height,offsetX:-p.width/2,offsetY:-p.height+3,scale:p.scale,shouldExcludeFromBoundingBox:!0},g=0;g<this.options.numDjSpots;++g){var v=this.getDjLocation(g),w=this.recordPiles[g]=new k(m);w.set({x:v.x,y:v.y,z:v.z,zIndex:this.zIndexes.recordPile})}t||(this.fusWBaContainer=new c({useTransforms:!0,scale:1.25}),this.$fusWBa=$("<div>").click(function(e){e.pageX&&e.pageY&&s.room.fusWBa()}).appendTo(this.fusWBaContainer.$el),this.drawDjButton(),this.inviteDjContainer=new c({useTransforms:!0,scale:1.25}),this.$inviteDj=$('<div class="invite-dj"><span>Invite DJ</span></div>').click(function(){s.room.inviteDj()}).appendTo(this.inviteDjContainer.$el),this.shuffleDjSpots()),this.cameraControl=new u({roomView:this}),this.cameraControl.$el.css({position:"absolute",top:40,right:40}).appendTo(this.$el),this.onResize=i.rateLimit(this,this.onResize,50),this.listenTo(s,"change:layout",this.onResize),this.listenTo(s,"change:miniplayer",this.onMiniplayerChange),this.onMiniplayerChange(s.chromeView),this.options.addToDOM.done(this.onResize),this.options.addToDOM.done(function(){e.mouseAdapter.delayedOnResizeOrScroll()}),this.initialRenderDone=!0,this.stats=this.overlayRenderer.enableStats(),this.startMonitorStats();var S=this.options.prefs;S.loading.done(this.onZoomSettingChange,this.onAnimationSettingChange,this.onCameraSettingChange),this.listenTo(S,{"change:disableZoom":this.onZoomSettingChange,"change:disableAnimation":this.onAnimationSettingChange}),window.setTimeout(this.sendGraphicsStats,3e5),this.listenTo(s,"currentSong:change",this.onSongChange),s.currentSongPlay&&this.onSongChange(s.currentSongPlay),this.listenTo(this.room.djs,{reset:this.resetDjs,add:this.addDj,remove:this.removeDj,"change:avatarId":this.onDjAvatarChange})},cleanup:function(){if(!this.hasCleanedUp){var e;this.autoCamera?e="auto":(e=_.pick(this.camera,["x","y","z"]),_.each(e,function(t,i){e[i]=Math.round(t)}),e=JSON.stringify(e)),this.options.prefs.set("camera",e),_.each(this.renderGroups,function(e){var t=this[e.name+"Renderer"];if(t.cleanup(),!e.isBatch){var i=this[e.name+"Scene"];i.cleanup()}},this),this.songboard.cleanup(),delete this.songboard,this.$el.remove(),this.cameraControl.remove(),this.mouseAdapter.cleanup(),delete this.mouseAdapter,this.cameraControl.cleanup(),delete this.cameraControl,this.delayedMoveCameraToFit.cancel(),this.room.section||(this.inviteDjContainer.cleanup(),this.fusWBaContainer.cleanup()),_.invoke(this.popovers,"hide"),_.invoke(_.pluck(this.djs,"laptop"),"cleanup"),$(window).off("resize",this.onResize),I&&clearInterval(I),this.stopListening(),delete this.model,delete this.room,delete this.options.crowdControl,this.hasCleanedUp=!0}},onResize:function(){var e=this.$el.width(),t=this.$el.height(),i=e/t;_.isNaN(i)&&(i=1),_.each(this.renderGroups,$.proxy(function(i){var n=this[i.name+"Renderer"];n.setSize(e,t)},this)),this.camera.set({crop:{x:-i/2,y:0,width:i,height:1}})},onMiniplayerChange:function(){s.get("miniplayer")?($(window).off("resize",this.onResize),this.degradeAnimations()):($(window).on("resize",this.onResize),this.onResize(),this.onAnimationSettingChange(),this.autoCamera&&this.delayedMoveCameraToFit(1500))},makeRenderGroup:function(e,t){var i=this[e.name+"Scene"]=new w,n={camera:this.camera,scene:i,type:e.type};e.cacheDuration&&(n.cacheDuration=e.cacheDuration);var o=e.name+"Renderer",r=H[o];r?(this[o]=r,r.setScene(i),r.setCamera(this.camera)):(e.renderer===g&&s.prefs.get("disableWebgl")&&(n.type="canvas"),r=this[o]=H[o]=new e.renderer(n)),e.start&&r.start(),e.hide||($(r.el).addClass("room-renderer").css("z-index",t).appendTo(this.$el),e.className&&$(r.el).addClass(e.className))},setupSongboard:function(){var e=this.sceneConfig.getImageLayer("board").asLocation(),t=this.songboard=new S({sceneConfig:this.sceneConfig,x:e.x,y:e.y,z:e.z});this.overlayScene.add(t);var i=this.$board=this.$el.find("#board");this.$needle=i.find("#awesome-needle")},setupMouseEvents:function(){var e=this.mouseAdapter=new v({mouseTarget:this.overlayRenderer.el,renderer:this.mouseMapRenderer});this.listenTo(e,{mouseenter:this.onObjectMouseenter,mouseleave:this.onObjectMouseleave,click:this.onObjectClick})},setScreenConfigSrc:function(e){this.screens=e||this.roomData.metadata.screens},getScreenConfig:function(e){return this.screens[e]},getNormalizedScreenConfig:function(e){var t=this.screens,i=0,n=1-i,o=t[e],r=!1;if(o||("left"===e?o=t.right||{}:"right"===e&&(o=t.left||{}),r=!0),o){var a=o[i]||o[n];if(a)return{type:o.type,src:a,link:o.link,mirror:r}}return s.user.isPro()||"left"!==e&&"right"!==e?void 0:{type:"funtimes",mirror:!1}},drawScreens:function(e){var t=this,i=!1;$.each(["left","right"],function(n,o){var s=t.getNormalizedScreenConfig(o),r=t[o+"ScreenContainer"],a=t[o+"LinkContainer"];t.drawScreen(r,s,e),s?(i=!0,"funtimes"===s.type?(t.isShowingFuntimes=!0,a.$el.addClass("funtimes"),a.$el.find("iframe").attr("src","/ttads/?roomid="+t.roomData.roomid),t.overlayScene.add(a)):s.link?(t.isShowingFuntimes=!1,a.$el.removeClass("funtimes"),a.$el.find("iframe").attr("src","https://s3.amazonaws.com/assets.turntable.fm/link.html?href="+s.link),t.overlayScene.add(a)):(t.isShowingFuntimes=!1,t.overlayScene.remove(a))):(t.isShowingFuntimes=!1,t.overlayScene.remove(a))}),i?$("html").addClass("side-screens-visible"):$("html").removeClass("side-screens-visible");var n=this.getNormalizedScreenConfig("curtain");this.$el.find("#curtain"),this.drawScreen(this.curtainScreenContainer,n),this.updateSongboardPosition(),this.updateSpotlightPosition(),this.sceneBackground.set({areSideScreensVisible:i||!!e,isCurtainScreenVisible:!!n})},drawScreen:function(e,t,i){var n=e.$el;t&&"funtimes"!==t.type?(t.type&&"image"!==t.type?n.css("background-image","").find("iframe").attr("src",t.src).show():(n.css("background-image","url("+t.src+")"),n.find(".screen-content").hide()),this.screenScene.add(e)):(n.css("background-image","").find("iframe").attr("src",""),i?this.screenScene.add(e):this.screenScene.remove(e))},lastUpdateAmount:0,updateTotalListeners:function(e){_.isNumber(this.maxCrowdMembers)&&(e=Math.min(e,this.maxCrowdMembers));var t=e-this.lastUpdateAmount;if(!(Math.abs(t)<=P)){var i=this.options.crowdControl.updateCrowd(e);i&&(_.each(i.membersToHide,this.removeCrowdMember),_.each(i.membersToShow,this.addCrowdMember)),this.lastUpdateAmount=e}},updateCrowdVotes:function(e){if(!this.isCrowdBoppingDisabled){var t=this.options.crowdControl,i=parseInt(e)-t.crowdBoppers.length;if(!(Math.abs(i)<P)){var n=t.updateCrowdBoppers(e);_.each(n.membersToStart,this.startBopping),_.each(n.membersToStop,this.stopBopping)}}},startBopping:function(e){if(!this.isAnimationDisabled){var t,i=this.avatarMap[e];i&&(this.djs[e]?(t=o.animations.smallrock,i.setAnimation(t)):(t=o.animations.rock,i.setAnimation(t)))}},stopBopping:function(e){var t=this.avatarMap[e];t&&(this.djs[e]?t.stopAnimation():t.stopAnimation())},updateStage:function(e){var t=this.numDancersAtLastStageUpdate,i=this.roomData.metadata,n=i.listeners;if(!(!e&&t&&Math.abs(n-t)<R)){this.numDancersAtLastStageUpdate=n;var o=0;n>400?o=3:n>200?o=2:n>50&&(o=1),i.upvotes/i.listeners>.8&&o++,o=Math.min(3,o),this.level=o;var s=this.sceneLoading||{};$.when(s).done($.proxy(function(){this.sceneBackground.set({lightLevel:o}),this.drawLightsOverDjs(o)},this))}},drawLightsOverDjs:function(e){e=e||0;var t=this.sceneConfig.getImageLayer("lights"+e+"Add").asLocation(),i=this.lightsOverDjs,n=this.lightsOverDjs=new k(_.extend({zIndex:this.zIndexes.light,shouldExcludeFromBoundingBox:!0,globalCompositeOperation:"source-atop"},t)),o=this.djScene;o.add(n),i&&n.loading.done(function(){o.remove(i)})},moveNeedle:function(e){this.songboard.moveNeedle(e)},getExistingAvatarId:function(e){return e=e.toString(),e in s.avatars?e:Math.ceil(8*Math.random()).toString()},showYouMarker:function(e){var t=this.avatarMap[e];if(t&&t.hasPosition()){var n=new c({width:0,height:0}),o=function(e,t){e.hasPositionChanged(t)&&n.set({x:e.x,y:e.y+e.avatarData.size[1],z:e.z})};t.on("change",o),o(t,t),n.$el.append(i.buildTree(["div.you-marker","YOU"]));var s=this.overlayScene;s.add(n),window.setTimeout(function(){t.off("change",o),s.remove(n),n.cleanup()},3e3)}},resetListenerLocations:function(e){var t=this.listenerMap;s.user.id;for(var i=0,n=e.length;n>i;i++){var o=e[i],r=o.user.id,a=t[r];a&&a.set(o.location)}this.autoCamera&&this.delayedMoveCameraToFit()},addAvatar:function(e,t,i){var n=e.id||e._id,o=this.avatarMap[n];if(!o){var a=e.custom_avatar;if(!a){var l=e.avatarId;a=s.avatars[this.getExistingAvatarId(l)]}a.avatarid||(a.avatarid=n),"519bbe7eeb35c1694127e605"===this.roomData.roomid&&(a=s.avatars[999]),o=this.avatarMap[n]=new r($.extend({avatarData:a},t)),this.numAvatars++}if(i)this.djScene.add(o);else{var u=e.location||this.options.crowdControl.getLocation(n);o.set(u),this.audienceScene.add(o)}return o},removeAvatar:function(e,t){var i=e.id||e._id,n=this.avatarMap[i];return n?(delete this.avatarMap[i],this.numAvatars--,t?this.djScene.remove(n):this.audienceScene.remove(n),n):void 0},addCrowdMember:function(e){this.addAvatar(e,{shade:l.CROWD_SHADE})},removeCrowdMember:function(e){this.removeAvatar(e)},addListener:function(e){var t=e.id;if(!this.listenerMap[t]){var i=this.listenerMap[t]=this.addAvatar(e.attributes,{direction:-1});this.djScene.remove(i),this.mouseMapScene.add(i),this.objectIdToUserId[i.id]=t,this.autoCamera&&this.delayedMoveCameraToFit(1500)}},removeListener:function(e){var t=e.id,i=this.removeAvatar(e.attributes);delete this.listenerMap[t],this.mouseMapScene.remove(i),this.autoCamera&&this.delayedMoveCameraToFit(1500)},resetDjs:function(){this.stopActiveDj(),_.each(this.djs,function(e){this.removeDj(e.user,s.room.djs)},this),s.room.djs.each(function(e){this.addDj(e,s.room.djs)},this);var e=s.currentSongPlay;e&&this.setActiveDj(e.get("djId"))},addDj:function(e,t){var i=e.id,n=this.avatarMap[i],o=t.indexOf(e);n?(this.audienceScene.remove(n),this.djScene.add(n)):(n=this.avatarMap[i]=this.addAvatar(e.attributes,null,!0),this.objectIdToUserId[n.id]=i),delete this.listenerMap[e.id];var r=this.sceneConfig.getDjLocation(o,this.options.numDjSpots),a=new m({x:r.x,y:r.y+L/2,z:0,user:e,shouldExcludeFromBoundingBox:!0,zIndex:this.zIndexes.laptop});this.djScene.add(a),this.mouseMapScene.add(a);var l=n.avatarData;n.set({direction:1,x:r.x,y:a.y+l.ll-l.frontSize[1],z:0,zIndex:this.zIndexes.dj}),this.mouseMapScene.remove(n),this.djs[i]=this.djsBySpot[o]={userId:i,avatar:n,laptop:a,user:e},this.shuffleDjSpots(o,1),-1!==this.room.upvoters.indexOf(i)&&this.updateVote(e,"up");var u=s.currentSongPlay;return u&&i===u.get("djId")&&this.setActiveDj(i),n},removeDj:function(e){var t=this.djs[e.id],i=this.djsBySpot.indexOf(t);if(t&&-1!==i){this.removeAvatar(t.user.attributes,!0),this.djScene.remove(t.laptop),this.mouseMapScene.remove(t.laptop),t.laptop.cleanup(),this.overlayScene.remove(t.pointDisplay);var n=t.userId;delete this.djs[n],this.djsBySpot.splice(i,1);for(var o=i,s=this.djsBySpot.length;s>o;o++)this.repositionDj(this.djsBySpot[o],o);this.updateCurrentDjPosition(),this.shuffleDjSpots(i,-1),this._hidePopover(n)}},repositionDj:function(e,t){var i=this.sceneConfig.getDjLocation(t,this.options.numDjSpots);e.avatar.set({x:i.x}),e.laptop.set({x:i.x})},onDjAvatarChange:function(e){var t=this.djs[e.id],i=t.laptop,n=t.avatar;this.removeAvatar(e.attributes,!0);var o=this.addAvatar(e.attributes,null,!0),s=o.avatarData;o.set({direction:1,x:n.x,y:i.y+s.ll-s.frontSize[1],z:0,zIndex:this.zIndexes.dj}),t.avatar=o,e.id===this.model.get("currentDj")&&this.setActiveDj(e.id)},onObjectClick:function(e){var t=this.objectIdToUserId[e.id];if(t){var i=this.room.userMap[t];i&&i.registered&&s.router.setRoute("profile",{userId:t})}},onObjectMouseenter:function(e){this.showTimeout&&(window.clearTimeout(this.showTimeout),delete this.showTimeout);var t=this.objectIdToUserId[e.id];e instanceof m&&(t=e.user.id),!t||this.popovers[t]&&this.popovers[t].$tip||(this.showTimeout={timeout:window.setTimeout($.proxy(function(){this.showPopover(t)},this),150),id:e.id})},onObjectMouseleave:function(e){var t=this.showTimeout;t&&t.id===e.id&&this.cancelObjectPopoverShow()},showPopover:function(e,t){this._showPopover(e,t)},togglePopover:function(e,t){var i=!1;e in this.popovers&&(this._hidePopover(e),i=!0),i||this._showPopover(e,t)},_showPopover:function(e){var t=this.room.isDj(e),i=this.avatarMap[e];if(i){var n,o={position:"absolute",left:"-65px"};t?o.top=0:(o.bottom=0,n="top");var s=$(this.makePopoverContent(e,t,n)).css(o).data("userid",e),r=this.popovers[e]=new a({objectId:i.id,mouseAdapter:this.mouseAdapter,scene:this.overlayScene,avatar:t?this.djs[e].laptop:i,isDj:t,$tip:s});s.on("mouseenter",this.cancelObjectPopoverShow),this.listenTo(r,{mouseenter:this.cancelObjectPopoverShow,cleanup:$.proxy(function(){this.stopListening(r),delete this.popovers[e]},this)}),r.show()}},_hidePopover:function(e){var t=this.popovers[e];t&&(t.hide(),delete this.popovers[e])},cancelObjectPopoverShow:function(){var e=this.showTimeout;e&&(window.clearTimeout(e.timeout),delete this.showTimeout)},makePopoverContent:function(e,t,n){var o=this.room.userMap[e],r=["div.tooltip.avatar-tipsy.floating-menu"+(n?"."+n:""),o.registered?["div.option.special",{event:{click:function(){s.router.setRoute("profile",{userId:e})}}},["strong",o.get("name")],["br"],i.commafy(o.get("points"))+" DJ Point"+(1===o.get("points")?"":"s"),["br"],i.commafy(o.get("fans")||0)+" fan"+(1===o.get("fans")?"":"s")]:["div.option.special.disabled",["strong","Guest"]]];if(t){var a=this.currentDj||this.previousDj;o.id==s.user.id?(r.push(["div.option",{event:{click:_.bind(this.callback,this,"remove_dj",e)}},"Quit Djing"]),a&&a.userId==s.user.id&&r.push(["div.option",{event:{click:_.bind(this.callback,this,"stop_song")}},"Skip My Song"])):s.user.isSuperuser()&&a&&a.userId==o.id&&r.push(["div.option",{event:{click:_.bind(this.callback,this,"stop_song")}},"Skip Their Song"])}return o.registered&&o.id!=s.user.id&&this.model.hasModPowers()&&(s.user.get("acl")>=o.get("acl")&&(r.push(["div.option",{event:{click:_.bind(this.callback,this,"boot_user",e)}},"Boot User"]),this.model.isMod(this.room.userMap[e])?r.push(["div.option",{event:{click:_.bind(this.callback,this,"rem_moderator",e)}},"Remove Moderator"]):o.registered&&r.push(["div.option",{event:{click:_.bind(this.callback,this,"add_moderator",e)}},"Add Moderator"])),t&&r.push(["div.option",{event:{click:_.bind(this.callback,this,"remove_dj",e)}},"Remove DJ"])),o.registered&&s.user.registered&&o.id!=s.user.id&&(r.push(["div.option",{event:{click:_.bind(this.callback,this,"pm_user",e)}},"Send Message"]),o.get("isFanned")?r.push(["div.option",{event:{click:_.bind(this.callback,this,"remove_fan",e)}},"Unfan"]):r.push(["div.option",{event:{click:_.bind(this.callback,this,"become_fan",e)}},"Become a Fan"])),i.buildTree(r)},rightmostSpot:function(){return this.djsBySpot.length-1},drawDjButton:function(){var e=this.room.section,t=this.rightmostSpot()+1;if(!e){var i,n;1==this.roomData.metadata.dj_reservation?(i="reserved-dj",n="Reserved"):(i="become-dj",n="Play Music"),this.$fusWBa.html(n).data("spot",t).removeClass("reserved-dj become-dj").addClass(i)}},shuffleDjSpots:function(){var e=this.rightmostSpot()+1,t=this.room.section;t||(this.overlayScene.remove(this.fusWBaContainer),this.overlayScene.remove(this.inviteDjContainer));for(var i=this.options.numDjSpots,n=0;i>n;++n)this.djScene.remove(this.recordPiles[n]);if(e<this.options.numDjSpots){for(var n=e;i>n;++n)this.djScene.add(this.recordPiles[n]);if(!t){var o,r;if(this.djs[s.user.id]?(o=this.$inviteDj,r=this.inviteDjContainer):(o=this.$fusWBa,r=this.fusWBaContainer),s.user.registered){o.data("spot",e);var a=this.sceneConfig.getDjLocation(e,this.options.numDjSpots);r.set({x:a.x,y:a.y,z:a.z}),this.overlayScene.add(r)}else this.overlayScene.remove(r)}}},setDjPoints:function(e){this.currentDj&&this.currentDj.pointDisplay.$el.find(".point-display").text(i.commafy(e)+" points")},setActiveDj:function(e){var t=this.djs[e];if(t){var n,r=t.avatar,a=r.avatarData.avatarid,l=t.user,u=s.avatars[a];l.get("custom_avatar")?l.get("custom_avatar").animations&&(n=l.get("custom_avatar").animations.bob,this.djRenderer.setCacheDuration(7200)):u.animations?(n=u.animations.bob,this.djRenderer.setCacheDuration(7200)):this.djRenderer.setCacheDuration(2400),n=n||o.animations.bob,this.isAnimationDisabled||r.setAnimation(o.AvatarAnimation.getAnimation(n)),r.set({zIndex:this.zIndexes.activeDj}),this.currentDj=t;var d=this.room.djs.indexOf(t.user);this.currentDjSpot=d;var h=this.currentDj.pointDisplay;h||(h=this.currentDj.pointDisplay=new c({}),h.$el.append(i.buildTree(["div.point-display"]))),this.listenTo(l,"change:points",function(){this.setDjPoints(l.get("points"))});var p=this.sceneConfig.getDjLocation(d,this.options.numDjSpots);h.set({x:p.x,y:p.y,z:-1}),this.overlayScene.add(h),this.setDjPoints(t.user.get("points")),this.updateSpotlightPosition(),this.djScene.add(this.spotlight)}},updateCurrentDjPosition:function(){if(this.currentDj){var e=this.room.djs.indexOf(this.currentDj.user);if(-1!==e){this.currentDjSpot=e;var t=this.sceneConfig.getDjLocation(e,this.options.numDjSpots);this.currentDj.pointDisplay.set({x:t.x,y:t.y,z:-1}),this.updateSpotlightPosition()}}},stopActiveDj:function(){if(this.currentDj){var e=this.currentDj.avatar;e.stopAnimation(),e.set({zIndex:this.zIndexes.dj}),this.overlayScene.remove(this.currentDj.pointDisplay),this.djScene.remove(this.spotlight),this.previousDj=this.currentDj,this.stopListening(this.currentDj.user),this.currentDj=null,this.currentDjSpot=null
}},getDjLocation:function(e){return this.sceneConfig.getDjLocation(e,this.options.numDjSpots)},songboardOffsetWithScreen:100,updateSpotlightPosition:function(){if(null!=this.currentDjSpot){var e=this.getNormalizedScreenConfig("curtain");this.spotlight.set({x:this.getDjLocation(this.currentDjSpot).x,y:this.spotlightInitialPosition.y+(e?this.songboardOffsetWithScreen:0)})}},updateSongboardPosition:function(){var e=this.sceneConfig.getImageLayer("board").asLocation().y;this.getNormalizedScreenConfig("curtain")&&(e+=this.songboardOffsetWithScreen),this.songboard.set({y:e})},onSongChange:function(e){this.stopActiveDj();for(var t in this.listenerMap){var i=this.listenerMap[t];i&&i.stopAnimation()}for(var t in this.djs){var n=this.djs[t];n&&n.avatar.stopAnimation()}delete this.spotlightOffset,this.updateCrowdVotes(0),this.moveNeedle(.5),e&&this.setActiveDj(e.get("djId")),this.consecutiveSongChanges+=1,this.consecutiveSongChanges>2&&this.isShowingFuntimes&&(this.drawScreens(),this.consecutiveSongChanges=0)},updateVote:function(e,t){var i=e.id;"up"===t?this.startBopping(i):this.stopBopping(i)},SineWave:function(e){var t=$(e).position();this.css=function(e){var i=Math.sin(10*e),n=t.left+20*(1-e)*i,o=t.top+-150*(1-e),s=5*e-1;return{top:o+"px",left:n+"px",opacity:s}}},_appendFloater:function(e,t){var i=$(t).css({position:"absolute",top:0,left:-t.height/2,width:t.width,height:t.height,maxWidth:"none"}).appendTo(e.$el),n=this;i.animate({path:new this.SineWave(i)},5e3,function(){i.remove(),n.overlayScene.remove(e)})},showFloater:function(e,t){if(!this.isAnimationDisabled){var n=this.avatarMap[e];if(e&&n&&(this.audienceRenderer.isObjectInView(n)||this.djRenderer.isObjectInView(n))){var o=n.y+n.avatarData.size[1],s=new c({x:n.x,y:o,z:n.z}),r=this.overlayScene;r.add(s),i.loadImage(t).done(_.bind(this._appendFloater,this,s))}}},showHeart:function(e){this.showFloater(e,IMG_PATH+"floater/heart.png")},showStar:function(e){this.showFloater(e,IMG_PATH+"floater/spinning-star.gif")},speak:function(e,t){var n=e.id,o=this.avatarMap[n];if(o&&o.hasPosition()){var s=o.y,r=o.z;this.room.isDj(n)?(s+=o.avatarData.frontSize[1],r=0):s+=o.avatarData.size[1],t=i.emojify(i.safeText(i.stripComboDiacritics(t)));var a=h.showChatstickers(t,e,{display:"block",margin:"5px auto"}),l=new c({x:o.x,y:s,z:r,width:0,height:0}),u=$(i.buildTree(["div.speech-bubble"]));a==t?u.append(i.buildTree(["div.speech-text",i.domify(t)])):u.append(a),l.$el.append(u);var d=this.overlayScene;d.add(l),window.setTimeout(function(){d.remove(l)},2e3)}},marquee:function(e,t,i,n){this.marqueeTexts[e]=n,this._marqueeHelper(e,t,i)},_marqueeHelper:function(e,t,i){function n(){for(var t=!0,i=r.marqueeTexts[e];" "==i[s]||t;){s+=1;var t=!1}s==i.length&&(s=0);var n=i.substring(s)+" - "+i.substring(0,s-1);o.text(n)}var o=$("#"+e),s=0,r=this;return this.marqueeTexts[e].length<i?(o.text(this.marqueeTexts[e]),void 0):(M[e]||(M[e]=setInterval(n,t),n()),void 0)},clearMarquees:function(){for(var e in M)M[e]&&(clearInterval(M[e]),M[e]=null)},moveCameraToFit:function(e){this.cameraPanInterval&&(window.clearTimeout(this.cameraPanInterval),delete this.cameraPanInterval);var t=_.pluck(this.listenerMap,"z"),i=Math.max.apply(null,t),n=_.reduce(_.values(this.listenerMap),function(e,t){return Math.abs(t.x)>Math.abs(e.x)?t:e},{x:0,y:0,z:0});t.length||(i=0),n={x:Math.abs(n.x),y:n.y,z:n.z};var o,r=window.innerHeight;s.user.registered?(this.footerHeight||(this.footerHeight=$("#footer").outerHeight()),o=(r-this.footerHeight-5)/r):o=$("#guest-welcome").offset().top/r;var a=this.camera,l=a.crop,u=a.fitX(n,l.x+l.width),d=a.fitY({x:0,y:0,z:i},l.y+l.height*o),h=Math.ceil(Math.min(Math.max(u,d,F),B)),c=a.z;if(this.isCameraTransitioning&&(c=this.transitionEndPos.z),!(A>h-c&&E>c-h&&Date.now()-this.lastCameraMoveTime<D)||0!==a.x&&!this.isCameraTransitioning){var p={x:0,y:a.y,z:h};return this.isCameraTransitioning&&this.cancelCameraTransition(),e?this.transitionCameraTo(p,e):this.setCameraPosition(p),this.lastCameraMoveTime=Date.now(),!0}},resetCamera:function(){this.enableAutoCamera(),this.moveCameraToFit(1500),this.showYouMarker(s.user.id)},cancelCameraTransition:function(){window.clearTimeout(this.transitionTimeout),this._transitionCamera.cancel(),this.onCameraTransitionEnd()},transitionCameraTo:function(e,t){this.onCameraTransitionStart(),this.transitionStartTime=Date.now(),this.transitionEndTime=this.transitionStartTime+t,this.transitionDuration=t;var i=this.camera;this.transitionStartPos={x:i.x,y:i.y,z:i.z},this.transitionEndPos=e,e.x=this.adjustXPosition(e.x,e.z),this._transitionCamera()},_transitionCamera:function(){var e=Date.now();if(e>this.transitionEndTime)this.setCameraPosition(this.transitionEndPos),this.onCameraTransitionEnd();else{var t=this.transitionStartPos,i=this.transitionEndPos,n=e-this.transitionStartTime,o=this.transitionDuration,s={};n/=o/2,_.each(t,function(e,t){var o=i[t]-e;if(1>n)s[t]=o/2*n*n+e;else{var r=n-1;s[t]=-o/2*(r*(r-2)-1)+e}}),this.setCameraPosition(s),this.transitionTimeout=window.setTimeout(this._transitionCamera,20)}},onCameraTransitionStart:function(){this.stopMonitorStats(),this.isCameraTransitioning=!0},onCameraTransitionEnd:function(){this.startMonitorStats(),this.isCameraTransitioning=!1},onMousewheel:function(e,t,i,n){this.cameraPanInterval&&(window.clearInterval(this.cameraPanInterval),delete this.cameraPanInterval);var o=(this.camera,this.cameraPosition),s=o.z=Math.min(B,Math.max(j,o.z-8*n));return o.x=this.adjustXPosition(o.x+8*i,s),this.setCameraPosition(o),this.disableAutoCamera(),!1},setCameraPosition:function(e){this.camera.set({x:e.x,y:e.y,z:e.z}),this.cameraPosition=e},xBoundsatZ:function(e){return{min:-e/8,max:e/8}},adjustXPosition:function(e,t){var i=this.xBoundsatZ(t);return Math.max(i.min,Math.min(i.max,e))},moveCameraForward:function(){this.disableAutoCamera();var e=this.camera;this.transitionCameraTo({x:e.x,y:e.y,z:j},3e3)},moveCameraBack:function(){this.disableAutoCamera();var e=this.camera;this.transitionCameraTo({x:e.x,y:e.y,z:B},3e3)},moveCameraLeft:function(){this.disableAutoCamera();var e=this.camera;this.transitionCameraTo({x:this.xBoundsatZ(e.z).min,y:e.y,z:e.z},3e3)},moveCameraRight:function(){this.disableAutoCamera();var e=this.camera;this.transitionCameraTo({x:this.xBoundsatZ(e.z).max,y:e.y,z:e.z},3e3)},enableAutoCamera:function(){this.autoCamera||(this.autoCamera=!0,this.trigger("change:autoCamera",this.autoCamera))},disableAutoCamera:function(){this.autoCamera&&(this.autoCamera=!1,this.trigger("change:autoCamera",this.autoCamera))},fallbacks:[{method:"retina"},{method:"crowdBopping"},{method:"crowdSize",degradeArgs:[U[0]]},{method:"crowdSize",degradeArgs:[U[1]],upgradeArgs:[U[0]]},{method:"resolution",degradeArgs:[q[0]]},{method:"crowdSize",degradeArgs:[U[2]],upgradeArgs:[U[1]]},{method:"crowdSize",degradeArgs:[U[3]],upgradeArgs:[U[2]]},{method:"resolution",degradeArgs:[q[1]],upgradeArgs:[q[0]]},{method:"animations"}],specialDegradationIndex:3,monitorStats:function(){var e=this.stats.getMovingAverage();_.isNumber(e)&&(this.maxAvg=Math.max(this.maxAvg,e),this.wasGraphicsStatsSent||this.avgs.push(e)),e>V?(this.numGoodStats=0,this.numBadStats++):(this.numGoodStats++,this.numBadStats=0);var t=N+this.numInflections,i=z+this.numInflections;if(this.numBadStats>=t&&this.degradationLevel<this.fallbacks.length)if(this.degradationLevel===this.specialDegradationIndex){if(!this.wasGraphicsModalShown)return this.showGraphicsModal(),void 0;this.hasAllowedDegradation&&this.degrade()}else this.degrade();this.numGoodStats>=i&&this.degradationLevel>0&&this.upgrade(),this.monitorStatsTimeout=window.setTimeout(this.monitorStats,5e3)},startMonitorStats:function(){_.isNumber(this.numMonitorStoppers)&&this.numMonitorStoppers>0&&(this.numMonitorStoppers--,this.numMonitorStoppers>0)||this.monitorStats()},stopMonitorStats:function(){this.numMonitorStoppers=(this.numMonitorStoppers||0)+1,window.clearTimeout(this.monitorStatsTimeout),this.monitorStats.cancel()},sendGraphicsStats:function(){var e=Math.ceil(this.maxAvg),t=10*Math.ceil(this.roomData.metadata.listeners/10);_gaq.push(["_trackEvent","graphics","max ms by room",this.roomData.name,e]),_gaq.push(["_trackEvent","graphics","max ms by size",t.toString(),e]);for(var i=0,n=this.avgs,o=0,s=n.length;s>o;o++)i+=n[o];var r=Math.ceil(i/s);_gaq.push(["_trackEvent","graphics","avg ms by room",this.roomData.name,r]),_gaq.push(["_trackEvent","graphics","avg ms by size",t.toString(),r]),this.wasGraphicsStatsSent=!0},_pushDegradationLevel:function(e){var t=this.degradationHistory;t.push(e),t.length>3&&t.shift();var i=t.length;i>2&&t[i-1]===t[i-3]&&this.numInflections++},degrade:function(){this._grade("degrade"),_gaq.push(["_trackEvent","graphics","performance","degrade",this.degradationLevel]),this.degradationLevel++,this._pushDegradationLevel(this.degradationLevel)},upgrade:function(){return this.isFlipFlopping(this.degradationLevel-1)?(this.numBadStats=0,this.numGoodStats=0,void 0):(this.degradationLevel--,this._grade("upgrade"),this._pushDegradationLevel(this.degradationLevel),void 0)},_grade:function(e){this.numBadStats=0,this.numGoodStats=0;var t=this.fallbacks[this.degradationLevel],n=i.capitalize(t.method),o=e+n;this[o]||(o="change"+n),this[o].apply(this,t[e+"Args"])},degradeRetina:function(){this.audienceRenderer.disableRetina()},upgradeRetina:function(){this.audienceRenderer.enableRetina()},changeCrowdSize:function(e){this.maxCrowdMembers=e,this.updateTotalListeners(this.roomData.metadata.listeners)},changeResolution:function(e){e=e||1,_.each(this.renderGroups,$.proxy(function(t){if("mouseMap"!==t.name){var i=this[t.name+"Renderer"];i.setScale(e)}},this))},degradeCrowdBopping:function(){this.updateCrowdVotes(0),this.isCrowdBoppingDisabled=!0},upgradeCrowdBopping:function(){this.isCrowdBoppingDisabled=!1},degradeAnimations:function(){this.djRenderer.stop(),this.audienceRenderer.stop(),this.isAnimationDisabled=!0},upgradeAnimations:function(){delete this.isAnimationDisabled,this.djRenderer.start(),this.audienceRenderer.start();var e=this;_.each(this.room.upvoters,function(t){e.updateVote(e.room.userMap[t],"up")}),this.setActiveDj(this.model.get("currentDj"))},showGraphicsModal:function(){var e="This room is getting too rowdy for your computer! Would you like to disable certain graphics features? For a smoother experience, try turning off animations from the settings menu.";i.buildTree([n,{clickOut:!1,submitCallback:_.bind(function(){this.hasAllowedDegradation=!0,i.setSetting("allowGraphicsDegradation","true"),this.degrade(),this.startMonitorStats()},this),submitText:"Yes",cancelCallback:_.bind(function(){this.hasAllowedDegradation=!1,i.setSetting("allowGraphicsDegradation","false"),this.startMonitorStats()},this),cancelText:"No"},["div.graphics-text",e]],this),this.modal.show(),this.wasGraphicsModalShown=!0,this.stopMonitorStats()},isFlipFlopping:function(e){var t=this.degradationHistory;return t.length<3||e>t[2]?!1:e===t[1]&&t[0]===t[2]?!0:!1},onZoomSettingChange:function(){this.options.prefs.get("disableZoom")?this.disableZoom():this.enableZoom()},enableZoom:function(){this.$el.on("mousewheel",this.onMousewheel),this.$el.one("mousewheel",function(){_gaq.push(["_trackEvent","feature","camera control","scroll"])}),this.cameraControl.show()},disableZoom:function(){this.$el.off("mousewheel",this.onMousewheel),this.cameraControl.hide(),this.resetCamera()},onAnimationSettingChange:function(){this.options.prefs.get("disableAnimation")?this.degradeAnimations():s.get("miniplayer")||this.upgradeAnimations()},onCameraSettingChange:function(){var e=this.options.prefs.get("camera");if("auto"===e||this.options.prefs.get("disableZoom"))this.enableAutoCamera();else{try{e=JSON.parse(e)}catch(t){return this.enableAutoCamera(),this.options.prefs.set("camera","auto"),void 0}this.setCameraPosition(e)}}},{_name:"RoomView"});return $.extend(W.prototype,t.Events),W}),define("screen-editor",["require","util","app","modal","overlay","tt-base"],function(e){var t=e("util"),i=e("app"),n=e("modal"),o=e("overlay"),s=e("tt-base"),r=s.View.extend({options:{idd:"screenEditor",screenName:null,screens:{},originalScreens:{},roomView:null},el:function(){return["div.screen-editor",["button.file-picker.tt-button.small",{type:"button"},["input",{type:"file",name:this.options.screenName,accept:"image/jpeg,image/gif,image/png"}],"Upload an Image"],["div.file-name-bar",["div.file-name"]],["div.clear-screen",{style:{display:"none"}}]]},methodsToBind:["checkMirroring"],events:{"click .clear-screen":"clearScreen","change input[type=file]":"onFileChosen","click input[type=file]":function(e){e.stopPropagation()},"click .file-picker":function(){this.$imageFile.click()}},init:function(e){this.roomView=e.roomView,this.$name=this.$el.find(".file-name"),this.$clearScreen=this.$el.find(".clear-screen"),this.$imageFile=this.$el.find("input[type=file]")},redraw:function(){var e,t=this.options.screens[this.options.screenName],i=this.roomView.getNormalizedScreenConfig(this.options.screenName),n=!0;if(i)if(i.mirror)this.$clearScreen.hide(),e="mirroring";else{this.$clearScreen.show(),n=!1;var o,s;if("page"===t.type)e="custom page";else if(this.hasChanged()){o=this.$imageFile[0].value,s=o.split("\\"),e=s[s.length-1],this.$name.text(e);for(var r=this.$name[0];r.scrollWidth>r.offsetWidth;)e="\u2026"+e.substr(2),this.$name.text(e)}else{o=i.src,s=o.split(".");var a=s[s.length-1];e="custom "+a.toLowerCase()}}else e="empty",this.$clearScreen.hide();this.$name.text(e),n?this.$name.parent().addClass("empty"):this.$name.parent().removeClass("empty"),this.roomView.drawScreens(!0)},reposition:function(){var e=$("#"+this.options.screenName+"-screen"),t=e.offset(),i={top:t.top-30,left:t.left,width:e.width(),height:e.height()+30};this.$el.css(i)},onFileChosen:function(e){var t,i=e.target,n=i.files[0];if(-1===n.type.indexOf("image")?t="Sorry, only images can be uploaded.":n.size>2e6&&(t="Sorry, the chosen image is too big. Please choose a smaller one."),t)return this.trigger("error",t),i.value="",void 0;var o=new FileReader,s=this;o.onload=function(e){s.options.screens[s.options.screenName]={0:e.target.result,type:"image"},s.redraw(),s.trigger("change")},o.readAsDataURL(n)},clearScreen:function(){this.$imageFile.val(""),this.options.screens[this.options.screenName]=void 0,this.redraw(),this.trigger("change")},monitor:function(e){this.otherScreenEditor=e,this.listenTo(e,"change",this.checkMirroring)},checkMirroring:function(){var e=this.roomView.getNormalizedScreenConfig(this.options.screenName);(!e||e.mirror)&&this.redraw()},hasChanged:function(){var e=this.options.screens[this.options.screenName],t=this.options.originalScreens[this.options.screenName];if(e&&!t||!e&&t)return!0;for(var i in e)if(e.hasOwnProperty(i)&&t[i]!=e[i])return!0;return!1},cleanup:function(){this.otherScreenEditor&&(this.otherScreenEditor=void 0),this.stopListening()}},{_name:"ScreenEditor"}),a=s.View.extend({options:{roomView:null},el:function(){return["div#room-screen-editor",["form",[r,{idd:"leftScreenEditor",screenName:"left",originalScreens:this.options.roomView.roomData.metadata.screens,roomView:this.options.roomView}],[r,{idd:"rightScreenEditor",screenName:"right",originalScreens:this.options.roomView.roomData.metadata.screens,roomView:this.options.roomView}],["div.modal##modal",["div.content-container",["div.content",["div.instructions",["p","Customize this room by placing images on the screens on either side of the stage! Please keep in mind:"],["ul",["li","Each image MUST be a GIF, JPEG, or PNG under 2 MB in size."],["li","Screens can only be updated 3 times per day."],["li","Inappropriate images (NSFW or NSFL) will be removed."]]],["div.buttons",["button#cancel-screen-edit.tt-button",{type:"button"},"Cancel"],["button#submit-screen-edit.tt-button.primary",{type:"submit"},"Save"]]]]]]]},methodsToBind:["redrawUpdateButton","showAlert","alertUpdated","cleanup","onUploadDone"],events:{"submit form":"beginUpload","click #cancel-screen-edit":"hide"},init:function(){this.roomView=this.options.roomView,this.leftScreenEditor=this.nodes.leftScreenEditor,this.rightScreenEditor=this.nodes.rightScreenEditor,this.overlay=new o.ScrollableOverlay,this.$overlay=this.overlay.$overlay,this.requestReposition=t.makeDrawer(this,this.reposition),this.requestRepositionAndRedraw=t.makeDrawer(this,this.repositionAndRedraw),this.screens=this.leftScreenEditor.options.screens=this.rightScreenEditor.options.screens=$.extend({},this.roomView.roomData.metadata.screens),this.roomView.setScreenConfigSrc(this.screens)},show:function(){this.$overlay.append(this.$el),this.overlay.show(),$("html").addClass("centered-mode no-panels"),this.listenTo(this.roomView.camera,"change",this.requestReposition),this.listenTo(this.roomView.screenScene,"add",this.requestReposition),this.roomView.drawScreens(!0),this.screensAlreadyVisible=void 0!==this.roomView.getNormalizedScreenConfig("left"),this.$form=this.$el.find("form");var e=this.leftScreenEditor,t=this.rightScreenEditor;e.monitor(t),t.monitor(e);for(var i=0,n=[e,t],o=n.length;o>i;i++){var s=n[i];this.listenTo(s,{change:this.redrawUpdateButton,error:this.showAlert})}turntable.sOxwLW.$eventBus.on("screenUpdate",this.alertUpdated),this.$modalWindow=$(this.modal),this.$instructions=this.$el.find(".instructions"),this.reposition(),this.redraw()},hide:function(){this.overlay.hide().done(this.cleanup),$("html").removeClass("centered-mode no-panels"),this.roomView.setScreenConfigSrc(),this.roomView.updateStage(!0),this.roomView.drawScreens(),this.screensAlreadyVisible||$(".side-screen").hide(),$(".side-screen").css("z-index",""),$(window).off("resize",this.reposition),turntable.sOxwLW.$eventBus.off("screenUpdate",this.alertUpdated)},cleanup:function(){this.$el.remove(),this.leftScreenEditor.cleanup(),this.rightScreenEditor.cleanup(),this.stopListening()},reposition:function(){this.leftScreenEditor.reposition(),this.rightScreenEditor.reposition(),this.$modalWindow.css("margin-top",this.leftScreenEditor.$el.css("top")+30)},redraw:function(){var e=this.leftScreenEditor,t=this.rightScreenEditor;e.redraw(),t.redraw(),$(".side-screen").css("z-index",this.$overlay.css("z-index")+1),this.redrawUpdateButton()},repositionAndRedraw:function(){this.roomView.setScreenConfigSrc(this.screens),this.reposition(),this.redraw()},redrawUpdateButton:function(){var e=this.leftScreenEditor,t=this.rightScreenEditor;e.hasChanged()||t.hasChanged()?$("#submit-screen-edit").prop("disabled",!1).removeClass("disabled"):$("#submit-screen-edit").prop("disabled",!0).addClass("disabled")},beginUpload:function(e){var t=new FormData(this.$form[0]);t.append("userid",i.user.id),t.append("userauth",i.user.auth),t.append("roomid",turntable.sOxwLW.roomId),t.append("type","screen"),t.append("updateLeft",this.leftScreenEditor.hasChanged()),t.append("updateRight",this.rightScreenEditor.hasChanged());var n=new XMLHttpRequest;n.addEventListener("load",this.onUploadDone,!1),n.open("POST","/upload/"+turntable.currentSocketServer),n.send(t),this.showProcessing(),e.preventDefault()},onUploadDone:function(e){var t;try{t=JSON.parse(e.target.responseText)}catch(i){return this.showAlert("Sorry, image upload failed. Please try again."),this.hideProcessing(),void 0}t.success?this.hide():(this.showAlert(t.err),this.hideProcessing())},showProcessing:function(){this.$instructions.children().css("opacity",0),this.spinner=t.makeSpinner(this.$instructions[0]),$("#submit-screen-edit").prop("disabled",!0).addClass("disabled"),$("#cancel-screen-edit").prop("disabled",!0).addClass("disabled")},hideProcessing:function(){this.spinner.stop(),this.$instructions.children().css("opacity",1),$("#submit-screen-edit").prop("disabled",!1).removeClass("disabled"),$("#cancel-screen-edit").prop("disabled",!1).removeClass("disabled")},alertUpdated:function(){this.showAlert('Screens have been modified by somebody else. Press "Cancel" to see their changes.')},showAlert:n.prototype.showAlert,hideAlert:n.prototype.hideAlert},{_name:"RoomScreenEditor"});return a}),define("tour-overlay",["require","util","blackswan/dom-renderer","overlay","blackswan/scene","tt-base","util"],function(e){var t=e("util"),i=e("blackswan/dom-renderer"),n=e("overlay"),o=e("blackswan/scene"),s=e("tt-base"),t=e("util"),r=s.View.extend({options:{childNodes:[],nextCallback:null,backCallback:null,doneCallback:null,idd:"tourOverlay",camera:null},events:{"click .start, .next":"goNext","click .back":"goBack","click .done, .ok":"done"},init:function(e){if(this.currentNode=0,this.overlay=new n.ScrollableOverlay,this.$overlay=this.overlay.$overlay,e.camera){this.$rendererContainer=$(t.buildTree(["div.room-viewport"])).appendTo(this.$overlay);var s=this.scene=new o;this.renderer=new i({scene:s,camera:e.camera}),this.renderer.$el.appendTo(this.$rendererContainer),this.throttledOnResize=t.rateLimit(this,this.onResize,50),$(window).on("resize",this.throttledOnResize),this.throttledOnResize()}},show:function(){"array"==$.type(this.options.childNodes)&&this.options.childNodes.length&&(this.$skipTour=$(t.buildTree(["a.skip-tour","skip"])).click($.proxy(function(e){this.done(),e.preventDefault()},this)),this.showStep(this.currentNode),this.$overlay.append(this.$skipTour),this.overlay.show())},showStep:function(){var e=this.options.childNodes[this.currentNode],i=t.buildTree(e.layout);this.setElement(i,!0),$(i).appendTo(this.$overlay),e.setup&&e.setup.call(this,this.$el)},hideStep:function(){var e=this.options.childNodes[this.currentNode];e.cleanup&&e.cleanup.call(this,this.$el),this.$el.remove()},goNext:function(){this.options.nextCallback&&0==this.options.nextCallback()||this.currentNode+1<this.options.childNodes.length&&(this.hideStep(),this.currentNode++,this.showStep())},goBack:function(){this.options.backCallback&&0==this.options.backCallback()||this.currentNode&&(this.hideStep(),this.currentNode--,this.showStep())},done:function(){this.options.doneCallback&&0==this.options.doneCallback()||this.overlay.hide().done($.proxy(function(){this.hideStep(),this.$skipTour.remove(),this.options.camera&&(this.renderer.cleanup(),$(window).off("resize",this.throttledOnResize),this.$rendererContainer.remove())},this))},onResize:function(){var e=this.$rendererContainer.width(),t=this.$rendererContainer.height();this.renderer.setSize(e,t)}});return r}),define("room-onboarding-tour",["require","underscore","app","blackswan/dom-pane","tour-overlay"],function(e){var t=(e("underscore"),e("app")),i=e("blackswan/dom-pane"),n=e("tour-overlay"),o={},s=function(e,t){o.roomView=e,o.userId=t;var i=new n({childNodes:[l.listenerView,l.djView,l.songboardView,l.chatView,l.playlistView(!1)],doneCallback:function(){$.cookie("turntableShowBigWelcome",!0,{path:"/",expires:365}),o.roomView=void 0},camera:o.roomView.camera});i.show()},r=function(){var e=new n({childNodes:[l.playlistView(!0)]});e.show()},a=function(e,t){e.hasPositionChanged(t)&&o.pane.set({x:e.x,y:e.y+o.avatarHeight,z:e.z})},l={listenerView:{layout:["div.tour-overlay#listener-view",["h3.header","Welcome to Turntable!"],["div.message",["b",["i","This is you!"]," turntable.fm is a fun way to listen to music and play your favorite songs for your friends and strangers, in real-time, for free."]],["div.buttons",["div.start"]],["div.avatar"],["div.progress"]],setup:function(e){var t=o.avatar=o.roomView.avatarMap[o.userId],n=(o.avatarHeight=t.avatarData.size[1],o.pane=new i({}));t.on("change",a),a(t,t),n.$el.append(e),this.scene.add(n)},cleanup:function(){this.scene.remove(o.pane),o.avatar.off("change",a),o.pane=void 0,o.avatar=void 0}},djView:{layout:["div.tour-overlay#dj-view",["h3.header",["div.icon"],"DJ music"],["div.message",["b","DJ's play songs for everyone in the room. You can become one too and start earning DJ points!"]],["div.buttons",["div.back"],["div.next"]],["div.progress"]],setup:function(e){var t=o.roomView.getDjLocation(0),n=o.pane=new i({x:t.x,y:t.y,z:t.z});n.$el.append(e),this.scene.add(n)},cleanup:function(){this.scene.remove(o.pane),o.pane=void 0}},songboardView:{layout:["div.tour-overlay#songboard-view",["h3.header",["div.icon"],"Rate songs"],["div.message",["b",'Like what you hear? Clicking the "thumbs up" will award the DJ a DJ point. Enough "Lame" votes and the song will be skipped.']],["div.buttons",["div.back"],["div.next"]],["div.icon"],["div.progress"]],setup:function(e){var t=o.roomView.songboard,n=o.pane=new i({x:t.x+t.width*t.scale/2,y:t.y-t.height*t.scale,z:t.z});n.$el.append(e),this.scene.add(n)},cleanup:function(){this.scene.remove(o.pane),o.pane=void 0}},chatView:{layout:["div.tour-overlay#chat-view",["h3.header","Chat"],["div.message",["b","Show some love! You can talk to others in the room in real time."]],["div.buttons",["div.back"],["div.next"]],["div.icon"],["div.progress"]],setup:function(e){t.chromeView.nodes.rightPanel.selectTab("chat");var i=$("#chat-form").offset(),n={x:-43,y:-175};e.css({top:n.y+i.top,left:n.x+i.left})}},playlistView:function(e){e=void 0===e?!1:e;var i=["div.tour-overlay#playlist-view",["h3.header","Get Ready to DJ"],["div.icon"]];return e?i.push(["div.message",["b","Hold on a second! Before you can DJ you need to add some songs to your queue."]],["div.buttons",["div.ok"]]):i.push(["div.message",["b","Pick some songs to be played when it's your turn on deck."]],["div.buttons",["div.back"],["div.done"]],["div.progress"]),{layout:i,setup:function(e){var i=t.chromeView;i.nodes[("single"===i.visibleLayout?"right":"left")+"Panel"].selectTab("queue");var n=$("#songs").offset(),o={x:-270,y:-38};"dual"===i.visibleLayout?(o.x=263,e.addClass("right")):e.addClass("left"),e.css({top:o.y+n.top,left:o.x+n.left})}}}};return{show:s,showEmptyPlaylist:r}}),define("models/song-vote",["require","tt-base","app"],function(e){var t=e("tt-base"),i=e("app"),n=t.Model.extend({defaults:{vote:""},upvote:function(){this._vote("up")},downvote:function(){this._vote("down")},_vote:function(e){var t=i.room.roomId,n=i.room.section,o=i.room.currentSong,s=this.get("vote"),r=this;if(o&&i.presence.getIdleTime()<15e3){this.set("vote",e);var a=$.sha1(t+e+o._id),l=$.sha1(Math.random()+""),u=$.sha1(Math.random()+"");i.turntable.ZxcLsz({api:"room.vote",roomid:t,section:n,val:e,vh:a,th:l,ph:u}).fail(function(){r.set("vote",s)});try{var d="up"===e?1:0,h=i.room.roomData.name,c=o.metadata.artist+" - "+o.metadata.song;_gaq.push(["_trackEvent","roomvotes",h,c,d]),_gaq.push(["_trackEvent","songvotes",c,h,d]),_gaq.push(["_trackEvent","songvote",e,i.get("miniplayer")?"mini":"full"])}catch(p){}}}},{_name:"SongVote"});return n}),define("room",["require","underscore","tt-base","util","action-modal","app","views/chatsticker-picker","models/counter","crowd-control","collections/djs","dmca","extensions","facebook","headband","views/mini-room","modal","playlist","piki","popout","models/room","views/room-tab","jkzzcP/jkzzcP","screen-editor","room-onboarding-tour","collections/song-log","models/song-play","models/song-vote","store","tt-common","player","typeahead","lib/jquery.autosize","lib/jquery.tipsy"],function(e){var t=e("underscore"),i=e("tt-base"),n=e("util"),o=e("action-modal"),s=e("app"),r=e("views/chatsticker-picker"),a=e("models/counter"),l=e("crowd-control"),u=e("collections/djs"),d=(e("dmca"),e("extensions")),h=e("facebook");headband=e("headband"),MiniplayerRoomView=e("views/mini-room"),Modal=e("modal"),playlist=e("playlist"),piki=e("piki"),popout=e("popout"),RoomModel=e("models/room"),RoomTab=e("views/room-tab"),RoomView=e("jkzzcP/jkzzcP"),RoomScreenEditor=e("screen-editor"),RoomOnboardingTour=e("room-onboarding-tour"),SongLog=e("collections/song-log"),SongPlay=e("models/song-play"),SongVote=e("models/song-vote"),store=e("store"),ttCommon=e("tt-common"),turntablePlayer=e("player"),Typeahead=e("typeahead"),e("lib/jquery.autosize"),e("lib/jquery.tipsy"),CHAT_HISTORY_SIZE=300;var c,p=i.Class.extend(function(){var e={chatHistory:[],historyLength:3,lastChatTime:0,totalTimeDebt:0,intervalMultiplier:1,debtViolations:0,chatThrottlingThreshold:100,isLoadingTrendingSongs:!1,throttleChat:function(t){if(0===e.lastChatTime)return e.lastChatTime=new Date,e.chatHistory.push(t),!1;var i,n,o=c.id,s=this.userMap[o];if(this.numListeners()>=e.chatThrottlingThreshold){var i=5.4/(.01*s.fans+1)-.4,r=i*e.intervalMultiplier,a=new Date,n=0;if(chatInterval=(a-e.lastChatTime)/1e3,n=r-chatInterval,e.totalTimeDebt+n>r){var l=this.throttleMessages[Math.floor(Math.random()*this.throttleMessages.length)];return this.appendAction(o,s.get("name"),l,"action"),!0}}var u=e.chatHistory;for(u.push(t);u.length>e.historyLength;)u.shift();if(u.length==e.historyLength){for(var d=!0,h=1;h<u.length;h++)u[h]!=u[h-1]&&(d=!1);if(d){var l=this.repeatMessages[Math.floor(Math.random()*this.repeatMessages.length)];return this.appendAction(o,s.get("name"),l,"action"),!0}}return this.numListeners()>=e.chatThrottlingThreshold&&(e.lastChatTime=a,e.totalTimeDebt=Math.max(-i,e.totalTimeDebt+n),e.totalTimeDebt>=0?(e.debtViolations+=1,e.debtViolations>2&&(e.debtViolations=0,e.intervalMultiplier+=.1)):e.intervalMultiplier=1),!1}};return{timers:{},ignoredUsers:[],hasLoadedFavorites:!1,isFavorite:!1,suggestedName:!1,streamStarted:!1,currentDjPointDelta:0,init:function(e,o){c=s.user,this.roomId=e,this.section=o,this.model=new RoomModel({_id:e}),this.roomData={},this.listenerids=[],this.listenerMap={},this.listeners=new i.Collection,this.djids=[],this.djs=new u,this.userStore=store.stores.get([{name:"users"}],this),this.userMap={},this.users=this.userMap,this.songsDjed=[],this.starShown={},this.$eventBus=$({}),this.loading=$.Deferred(),this.lastStreamSegmentRequestTime=0,turntable.setSocketAddr(turntable.getHashedAddr(this.roomId,this.section)),this.trendingSongs=new SongLog,this.loadTrendingSongs(),t.bindAll(this),this.loadLayout(),this.initFavorite(),this.attachHeadbandHandlers(),headband.displayValidHeadband(),turntable.addEventListener("userinfo",this.updateUserFanofs),turntable.addEventListener("message",this.messageListener),turntable.addEventListener("reconnect",this.reconnectListener),httpStream.setCallback(this.httpStreamListener);var r=this.prefs=s.prefs;r.loading.done(this.onImageSettingChange),this.listenTo(r,{"change:disableImages":this.onImageSettingChange}),this.registerUser().done($.proxy(function(){this.loadRoomStateTask=this.loading,this.loadRoomState(),this.refreshFacebookToken(),this.loadRoomStateTask.done($.proxy(function(){s.initialLoading&&window.setTimeout(function(){s.initialLoading.resolve()},0)},this))},this)),turntable.addIdleListener(14400,this.checkIdle),n.nBAInQ(this),this.songVote=new SongVote,this.miniplayerRoomView=window.miniplayerRoomView=new MiniplayerRoomView({model:this}),$("body").append(this.miniplayerRoomView.el),window.onbeforeunload=this.onBeforeUnload,$(window).on("keydown",this.keyboardShortcuts),$.browser.mozilla&&$(window).on("unload",this.cleanup),this.listenTo(s,"popOut",this._onPopOutCreated),window.setInterval(this.checkStream,this.checkStreamInterval),this.on("streamSegmentRequest",this.onStreamSegmentRequest)},numListeners:function(){return this.listenerids.length},numDjs:function(){return this.djids.length},numAudienceMembers:function(){return this.section?this.listenerids.length:this.listenerids.length-this.djids.length},isFeatured:function(){return this.roomData.metadata.featured},registerUser:function(){var e={api:"room.register",roomid:this.roomId,section:this.section};return turntable.ZxcLsz(e,$.proxy(function(e){if(!e.success){if(4===e.errno){var t=window.history.state||TURNTABLE_ROOM,i="/"+(t.shortcut||t.roomid);return window.location.href=i,void 0}return this.lobbyRedirect(e.errno),void 0}if(e.roomid!=this.roomId&&(LOG("User registered into wrong room"),this.lobbyRedirect(3)),e.section!=this.section&&(this.section=e.section,window.history&&window.history.replaceState)){var t=window.history.state||TURNTABLE_ROOM,n=$.extend({},t,{section:e.section}),i=n.shortcut||n.roomid;i="/"+i+"/"+n.section,window.history.replaceState(n,i,i)}this.reconnecting&&turntable.socketDumpLog()},this))},lastRoomStateLoadTime:0,loadRoomState:function(){LOG("LOAD ROOM STATE");
var e=this.loading,t={api:"room.info",roomid:this.roomId,section:this.section};if($("#song-log").children().size()>0&&(t.extended=!1),t.extended){var i=Date.now()/1e3;if(i-this.lastRoomStateLoadTime<2)return LOG("THROTTLED LOADROOMSTATE"),void 0;this.lastRoomStateLoadTime=lastRoomStateLoadTime}var o=$.when(turntable.ZxcLsz(t),turntable.avatarLoad);return o.done($.proxy(function(t){var i=t.room,o=t.users,s=t.djids,r=t.listenerids;n.notEmpty(this.roomData)||$.extend(this.roomData,i);for(var a=0,u=o.length;u>a;a++)this.addUserToMap(o[a]);this.crowdControl=new l(this,this.section);for(var a=0;a<r.length;a++){var d=r[a];this.userMap[d]?this.$eventBus.trigger("Room.addListener",r[a]):(r.splice(a,1),a--)}this.djids=s.slice(),this.listenerids=r,this.setupRoom(i);for(var h=r.slice(),a=0;a<h.length;a++)this.addListener(h[a],!0);var c=i.metadata.djs.slice();this.djs.reset();for(var a=0;a<c.length;a++)this.addDj(c[a]);this.setCurrentSong(i.metadata),this.updateVotes(i.metadata,!1),this.roomInfoHandler(i),e.resolve()},this)),o.fail(function(t){turntable.showAlert("The requested room could not found: "+t.err),e.reject(),window.location.href="/"}),e.done($.proxy(this.highlightUser,this)),e.promise()},highlightUser:function(){var e=$.cookie("turntableShowBigWelcome");playlist.playlistLoading.done($.proxy(function(){var t=playlist.queue.options.songids.length;!c.registered||e||t?this.roomView.showYouMarker(c.id):RoomOnboardingTour.show(this.roomView,c.id)},this))},messageListener:function(e){if(!e.hasOwnProperty("msgid"))if("speak"==e.command)this.showChatMessage(e.userid,e.name,e.text);else if("newsong"==e.command)LOG("newsong message received"),this.currentSongEndTime&&this.currentSongEndTime-Date.now()/1e3>10&&(LOG("previous song ended early"),turntablePlayer.playEphemeral(UI_SOUND_ENDSONG,!0)),this.setCurrentSong(e.room.metadata,e.current_dj_points),this.roomInfoHandler(e.room);else if("nosong"==e.command)this.setCurrentSong(null),this.roomInfoHandler(e.room);else if("registered"==e.command){var t=e.user[0],i=t.userid;this.addUserToMap(t),this.$eventBus.trigger("Room.addListener",i),this.addListener(i),this.roomData.metadata&&this.roomData.metadata.listeners&&this.roomData.metadata.listeners++}else if("deregistered"==e.command){var i=e.user[0].userid;this.removeListener(i),this.roomData.metadata&&this.roomData.metadata.listeners&&this.roomData.metadata.listeners--}else if("update_user"==e.command)this.updateUser(e);else if("add_dj"==e.command){var t=e.user[0],n={};n[t.userid]=e.placements,$(document).trigger("add_sticker_placements",n),this.addUserToMap(t),this.addDj(t.userid),this.djids.length>1&&turntablePlayer.oLWsfDd&&turntablePlayer.zPSPGa(!1)}else if("rem_dj"==e.command){var t=e.user[0];this.addUserToMap(t);var o=t.userid;if(this.removeDj(o),e.modid){var s;1==e.modid?s=" was booed off the stage.":(s=" was kindly escorted off the stage",s+=this.userMap[e.modid]?" by "+this.userMap[e.modid].get("name")+".":"."),this.appendAction(o,this.userMap[o].get("name"),s,"action")}}else if("update_votes"==e.command){LOG("update_votes message received");var r=e.current_song;if(!this.currentSong||!r||r._id===this.currentSong._id&&Math.floor(r.starttime)===Math.floor(this.currentSong.starttime))this.updateVotes(e.room.metadata,!0),this.roomInfoHandler(e.room);else if(this.previousDjid&&this.previousDjid in this.users){var a=e.room.metadata.upvotes-this.previousDjPointDelta;this.users[this.previousDjid].points+=a,this.previousDjid===this.roomData.metadata.current_dj&&(this.currentDjPointsAtSongStart+=a),this.previousDjPointDelta=e.room.metadata.upvotes}}else if("new_moderator"==e.command)this.model.moderators.add(e.userid),e.userid==c.id&&this.showRoomTip("You are now a moderator of this room. Moderators can boot people out of the room who act inappropriately. Thanks for your help.",10);else if("rem_moderator"==e.command)this.model.moderators.remove(e.userid),e.userid==c.id&&this.showRoomTip("You are no longer a moderator of this room.",10);else if("booted_user"==e.command)if(e.userid==c.id)this.gotBooted(e.reason,this.userMap[e.modid].get("name"));else{var l=this.userMap[e.modid],u=" was booted from the room"+(l?" by "+l.get("name"):"")+".";e.reason&&(u+=" Reason: "+e.reason);var t=this.userMap[e.userid],d=t&&t.get("registered")?t.get("name"):"Somebody";this.appendAction(e.userid,d,u,"action")}else if("stop_song"==e.command){var u=" had their song skipped by "+this.userMap[e.skipperId].get("name")+".",t=this.userMap[e.skippedId],d=t?t.get("name"):"Somebody";this.appendAction(e.userid,d,u,"action")}else if("dmca_error"==e.command){var u="song"==e.type?"We had to skip your song because our music licenses force us to limit the number of times an artist can be played each hour in a room. Playing the next song in your queue that is in compliance.":"We had to skip your turn because our music licenses force us to limit the number of times an artist can be played each hour in a room. Add some new artists to your queue or try joining a new room.";this.showRoomTip("Bummer! "+u,10)}else if("song_blocked"==e.command){var u="We had to skip your ";u+="song"==e.type?"song":"turn",u+=" due to a copyright claim",e.label&&(u+=" by "+e.label),u+="song"==e.type?". Playing the next song in your queue that is in compliance.":". Try adding more songs to your queue.",this.showRoomTip("Bummer! "+u,10)}else"update_room"==e.command?(e.description&&this.updateRoomDesc(e),e.screens&&this.updateScreens(e)):"snagged"==e.command?this.handleSnagged(e):"guest_registered"==e.command?(e.registered=!0,this.updateUser(e)):"headband"==e.command&&headband.isValid(e)&&headband.displayHeadband(e)},updateScreens:function(e){$.extend(this.roomData.metadata.screens,e.screens),this.$eventBus.trigger("screenUpdate"),this.roomView.drawScreens(),this.roomView.updateStage(!0)},updateUserFanofs:function(){if(this.userMap){var e,t=c.get("fanof");for(var i in this.userMap)e=this.userMap[i],-1!==t.indexOf(i)?e.set("isFanned",!0):e.set("isFanned",!1);!this.roomView}},reconnectListener:function(){LOG("Reconnected to server"),this.reconnecting=!0;var e=this.isDj(),t=this;this.loadRoomState().done(function(){t.reconnecting=!1,e&&!t.isDj()&&turntable.showAlert("You stopped DJing because you were disconnected for too long.")})},onStreamSegmentRequest:function(){this.lastStreamSegmentRequestTime=Date.now()},checkStreamInterval:3e4,checkStream:function(){if(this.currentSong){var e=Date.now();e-this.lastStreamSegmentRequestTime>this.checkStreamInterval&&(_gaq.push(["_trackEvent","missing stream segment request","room",this.roomId]),_gaq.push(["_trackEvent","missing stream segment request","user",s.user.id]))}},httpStreamListener:function(e){"resync"==e?this.scheduleResyncStream():"streamstart"==e?this.streamStarted||(this.streamStarted=!0,turntablePlayer.zPSPGa(!1),this.roomData.metadata.currentDj==c.id&&1==this.numDjs()&&1!=this.roomData.metadata.single_dj_enabled&&"sc"!=this.currentSong.source&&(this.timers.oLWsfD=setTimeout(this.oLWsfD,3e4)),this.logSongRequest(),s.currentSongPlay.setLoaded()):"status"==e&&this.trigger("streamSegmentRequest")},logSongRequest:function(){var e={api:"room.log_song_request",roomid:this.roomId,section:this.section,song:this.currentSong};turntable.ZxcLsz(e,function(e){e.success&&LOG("logged song request")})},scheduleResyncStream:function(e){LOG("schedule resync stream");var t=this,i=function(){var e={api:"room.stream_info",roomid:t.roomId};turntable.ZxcLsz(e).done(function(e){t.setCurrentSong(e.room.metadata,null,!0)})};e?setTimeout(i,e):i()},roomInfoHandler:function(e){this.model.set(this.model.parse(e)),$.extend(this.roomData.metadata,e.metadata);var t=e.metadata;if(t){var i=t.listeners;this.roomView.updateTotalListeners(i),this.roomView.updateCrowdVotes(t.upvotes-this.upvoters.length),this.roomView.updateStage(),this.roomView.drawDjButton(),this.miniplayerRoomView.nodes.miniDjs.updateDjButton()}},zApRhMCallback:function(e,t){if("upvote"==e)this.songVote.upvote();else if("downvote"==e)this.songVote.downvote();else if("stop_song"==e)turntable.ZxcLsz({api:"room.stop_song",roomid:this.roomId,section:this.section,djid:this.roomData.metadata.currentDj,songid:this.currentSong._id}),(c.isSuperuser()||this.roomData.metadata.currentDj==c.id)&&this.songsDjed.length>0&&this.songsDjed[this.songsDjed.length-1].fileId==this.currentSong._id&&this.songsDjed.pop();else if("rem_dj"==e)this.quitDj();else if("remove_dj"==e)turntable.ZxcLsz({api:"room.rem_dj",roomid:this.roomId,section:this.section,djid:t});else if("boot_user"==e){var i=this,o=this.userMap[t],r=o.registered?o.get("name"):"a guest";n.buildTree(p.layouts.bootConfirmView(r,function(){var e={api:"room.boot_user",roomid:i.roomId,section:i.section,target_userid:t},n=$.trim($(".bootReasonField").val());n&&"(optional)"!=n&&(e.reason=n),turntable.ZxcLsz(e),i.modal.close();var o=i.roomData.name;_gaq.push(["_trackEvent","room","boot",o+"--"+c.get("name")])}),this),this.modal.show()}else if("add_song_to"==e)this.addSong(t);else if("become_fan"==e){var a=this.userMap[t],l=this;a&&a.set("isFanned",!0),c.addFan(t).done(function(){s.pms.manualInsert(l.roomData,a.attributes)})}else if("remove_fan"==e){var a=this.userMap[t];a&&a.set("isFanned",!1),c.removeFan(t).done(function(){s.pms.remove(a.id)})}else if("add_moderator"==e){var i=this;n.buildTree(p.layouts.addModConfirmView(this.userMap[t].get("name"),function(){turntable.ZxcLsz({api:"room.add_moderator",roomid:i.roomId,section:i.section,target_userid:t}),i.modal.close()}),this),this.modal.show()}else if("rem_moderator"==e){var i=this;n.buildTree(p.layouts.removeModConfirmView(this.userMap[t].get("name"),function(){turntable.ZxcLsz({api:"room.rem_moderator",roomid:i.roomId,section:i.section,target_userid:t}),i.modal.close()}),this),this.modal.show()}else if("pm_user"==e){if(t===s.user.id)return;s.pms.manualInsert(this.roomData,this.userMap[t].attributes),s.pms.get(t).select(),s.get("miniplayer")&&s.chromeView.nodes.rightPanel.selectTab("pm")}},addSong:function(e,t){if(!t){if(!this.currentSong)return;t=this.currentSong}var i=!1,n=t._id||t.fileId,o=playlist.queue.contains(n);if("queue"==e){if(!s.user.registered||t.snaggable===!1)return;var r;o?r="This song is already in your queue!":(playlist.addSong({fileId:n,metadata:t.metadata}),r="Song added to queue."),this.showRoomTip(r,5)}else"piki"===e?piki.createPick(t):window.open("/link/?fileid="+n+"&site="+e,e+n);var a=t?t.djid:this.roomData.metadata.currentDj,l=t==this.currentSong?"board":"songlog";this.sendSnag(c.id,this.roomId,this.section,a,n,e,l,o?"true":"false",i)},sendSnag:function(e,t,i,n,o,s,r,a,l){if(n){var u=$.sha1(Math.random()+""),d=$.sha1(Math.random()+"");l=l.toString();var h=[e,n,o,t,s,r,a,l,u],c=$.sha1(h.join("/"));turntable.ZxcLsz({api:"snag.add",djid:n,songid:o,roomid:t,section:i,site:s,location:r,in_queue:a,blocked:l,vh:c,sh:u,fh:d}),_gaq.push(["_trackEvent","song","snag",s,a?0:1])}},handleSnagged:function(e){this.roomView.showHeart(e.userid)},handleFanned:function(e){var t=e.userid,i=this.userMap[e.userid],n=e.fanid;i.get("fans")||i.set("fans",0),i.set("fans",i.get("fans")+e.fans),!(t===this.roomData.metadata.current_dj&&e.fans>0)||this.starShown[t]&&this.starShown[t][n]||(this.roomView.showStar(n),this.starShown[t]||(this.starShown[t]={}),this.starShown[t][n]=!0)},userIdFromName:function(e){for(var t in this.userMap){var i=this.userMap[t];if(i&&i.get("name")==e)return t}return null},throttleMessages:[", relax and just enjoy the music."," has been awfully chatty lately...",", quiet down; the neighbors are complaining about the noise."],repeatMessages:[" sounds like a broken record...",", okay, we get it."],speak:function(t){t.preventDefault();var i=$.trim(this.nodes.chatText.value),n=!1;if(i){if(0==i.indexOf("/ignore ")){var o=i.substr(8),s=this.userIdFromName(o);return s&&-1==$.inArray(s,this.ignoredUsers)&&(this.ignoredUsers.push(s),this.appendAction(s,o," will be ignored.")),void 0}if(0!=i.indexOf("/unignore "))"/up"==i?(this.songVote.upvote(),n=!0):"/down"==i&&(this.songVote.downvote(),n=!0),i=r.throttleText(i),(n||!e.throttleChat.apply(this,[i]))&&(this.nodes.chatText.value="",$("#chat-input").trigger("autosize.resize"),n||this.sendSpeakMessage(i));else{var o=i.substr(10),s=this.userIdFromName(o);if(s){var a=$.inArray(s,this.ignoredUsers);-1!=a&&(this.ignoredUsers.splice(a,1),this.appendAction(s,o," will be ignored no more."))}}}},sendSpeakMessage:function(e){var t=turntable.ZxcLsz({api:"room.speak",roomid:this.roomId,section:this.section,text:e}),i=this;t.fail(function(e){e&&"user not in room"==e.err&&i.reconnectListener()})},clearRoomUsers:function(){if(this.roomView)for(var e=this.listenerids,i=this.userMap,n=this.roomView,o=0,s=e.length;s>o;o++)n.removeListener(i[e[o]]);t.each(this.userMap,function(e){this.userStore.release(e,this)},this),this.userMap={},this.djids=[],this.listenerids=[]},cleanup:function(){this.clearRoomUsers(),turntable.removeEventListener("auth",this.authListener),turntable.removeEventListener("userinfo",this.updateUserFanofs),turntable.removeEventListener("message",this.messageListener),turntable.removeEventListener("reconnect",this.reconnectListener),httpStream.setCallback(null),this.roomList&&(this.roomList.cleanup(),this.roomList=null),httpStream.closeStream(),popout.isPopoutHost()||turntable.ZxcLsz({api:"room.deregister",roomid:this.roomId,section:this.section}),playlist.decorateQueueView();for(var e in this.timers)this.timers[e]&&clearTimeout(this.timers[e]);turntable.removeIdleListener(14400,this.checkIdle),this.$view.find("#layout-option, #zoom-option, #animation-option").off("click"),this.$view.find(".dropdown-container").off(),$("#chat-input").trigger("autosize.destroy"),$(".edit-description").trigger("autosize.destroy"),this.$dingMenu.find("#img-option").off("click"),this.$dingMenu.remove(),$("#footer").appendTo("body"),$(this.view).remove(),this.view=void 0,this.typeahead.remove(),this.crowdControl.cleanup(),this.crowdControl=void 0,this.roomView.cleanup(),this.roomView=void 0,window.onbeforeunload=null,$(window).off("keydown",this.keyboardShortcuts),$.browser.mozilla&&$(window).off("unload",this.cleanup),this.volumeKnob=void 0,this.$eventBus=void 0,store.stores.release(this.userStore,this),this.userStore=void 0,s.chromeView.nodes.header.$(".header-room-twitter").off("click"),s.chromeView.nodes.header.$(".header-room-facebook").off("click"),this.nodes.roomTab.remove(),this.stopListening()},getEntropyForUser:function(e){return turntable.seedPRNG(e.get("userid")+e.get("points")+this.roomId+Math.round(turntable.serverNow()/21600))},attachHeadbandHandlers:function(){$("#turntable").on("Headband",function(e,t){$panels=$(".floating-panel, #header"),"up"==t?$panels.removeClass("down"):"down"==t&&$panels.addClass("down")})},openRegistration:function(e){e&&e.preventDefault(),s.router.setRoute("signup")},loadGuestLayout:function(){var e=this;n.buildTree(p.layouts.signupButton(this.openRegistration));var t=n.buildTree(p.layouts.guestChatButton(this.openRegistration));$(this.nodes.chat).append(t),$(this.nodes.chatBar).hide(),turntable.playlist.$panes.hide().parent().append(n.buildTree(p.layouts.guestPlaylistPane(e.openRegistration)));var i=n.buildTree(p.layouts.guestWelcome(this.openRegistration));this.$view.append(i);var o=n.getUrlParam("complete_register");o&&this.openRegistration()},displayRegisteredLayout:function(){$(this.nodes.chatBar).add("#settings").show(),$(".guest-signin-container, #guest-chat-bar, #guest-welcome").remove(),turntable.buddyList.showPMWindows(),$("#guest-playlist-pane").remove(),turntable.playlist.$panes.show(),MvxTJL.shuffleDjSpots()},chatKeyDownListener:function(e){var t=e.charCode||e.keyCode;13===t&&($(this.nodes.chatForm).submit(),e.preventDefault())},onChatTabSelect:function(){this.chatUnreadCount.reset(),this.updateChatScroll(),this.$chatInput.focus()},onChatTabDeselect:function(){this.typeahead.clearTypeahead()},loadLayout:function(){this.nodes={},this.view=n.buildTree(p.layouts.page.call(this),this.nodes);var e=this.$view=$(this.view);$("#footer").appendTo(this.view);var i=this.chatUnreadCount=new a(null,{max:99});this.chatTabItem=s.chromeView.chatTabItem,this.chatTabItem.setBadgeModel(i),this.listenTo(this.chatTabItem,{select:this.onChatTabSelect,deselect:this.onChatTabDeselect}),s.chromeView.chatPane.$(".chat").replaceWith(this.nodes.chat),n.buildTree([RoomTab,{model:this.model,room:this}],this.nodes),s.chromeView.roomPane.$el.append(this.nodes.roomTab.el),c.registered||(this.listenTo(s,{loggedin:function(){window.location=ttCommon.getRoomUrl(turntable.sOxwLW.roomData)},registered:function(){c.fetchInfo({fullInfo:!0}).done(t.bind(this.displayRegisteredLayout,this))},finishedRegistration:function(){$(window).one("Modal:hidden",function(){RoomOnboardingTour.show(s.room.roomView,c.id)})}}),this.loadGuestLayout()),e.find(".searchView").hide(),e.find("#feedback-link").on("click",this.feedbackShow),e.find("#help-link").on("click",this.helpShow),this.typeahead=new Typeahead({input:this.nodes.chatText,checkUsers:!0,room:this});var o=$(this.nodes.chat);if(c.isPro()?(this.chatstickerPicker=new r({delegate:this}),o.find(".chatsticker-icon").on("click",t.bind(function(e){e.preventDefault(),this.chatstickerPicker.toggle()},this)).on("mouseleave",t.bind(function(){this.chatstickerPicker.setCloseTimer()},this))):o.find(".chatsticker-icon").hide(),e.find(".roomTip").click(this.hideRoomTip),$(this.nodes.chatForm).submit(this.speak),$(this.nodes.chatText).keydown(this.chatKeyDownListener),n.getSetting("playdingsound"))this.dingSetting=n.getSetting("playdingsound");else{var l="true"==n.getSetting("playding")?"on":"mention";n.setSetting("playdingsound",l),this.dingSetting=l}this.$dingMenu=$(n.buildTree(p.layouts.dingMenu)).hide().appendTo("body"),this.$dingMenu.find("."+this.dingSetting).addClass("selected"),this.$dingButton=$(this.nodes.chatSound),this.$dingButton.addClass(n.getSetting("playdingsound")),this.$dingButton.add(this.$dingMenu).on("mouseenter",this.dingMenuMouseEnter).on("mouseleave",this.dingMenuMouseLeave),this.$dingMenu.on("click",".option",this.dingMenuClick),this.$dingMenu.find("#img-option").tipsy({className:"chat-option",offset:-8,gravity:"w",fade:!0,opacity:1}).on("click",".option",t.bind(function(e){var t=$(e.currentTarget).data();this.prefs.set(t)},this)),$(this.nodes.chatLog).on("click",".speaker, .subject",$.proxy(function(e){this.roomView.togglePopover($.data(e.target,"userid"),!0)},this)),$(this.nodes.chatText).on("focus",$.proxy(function(e){var t=$(e.target);0!==t.val().length&&t.closest(".chat-bar").addClass("chat-focused"),this.checkChatScroll()},this)).on("blur",function(){var e=$(this);0===e.val().length&&e.closest(".chat-bar").removeClass("chat-focused")}).on("keyup",function(e){var t=$(e.target);0===t.val().length?t.closest(".chat-bar").removeClass("chat-focused"):t.closest(".chat-bar").addClass("chat-focused")}),e.find(".dropdown-container").on("mouseenter",this.dropDownMouseEnter).on("mouseleave",this.dropDownMouseLeave)},keyboardShortcuts:function(e){var t="TEXTAREA"==e.srcElement.nodeName||"INPUT"==e.srcElement.nodeName;t||32!=e.keyCode||this.toggleMute()},onLayoutSettingChange:function(){var e=this.prefs.get("layout")||"single";this.$view.find("."+e+"-panel").addClass("selected").siblings(".selected").removeClass("selected")},onZoomSettingChange:function(){var e=this.$view.find("#zoom-option");this.prefs.get("disableZoom")?(e.find(".on").removeClass("selected"),e.find(".off").addClass("selected")):(e.find(".on").addClass("selected"),e.find(".off").removeClass("selected"))},onAnimationSettingChange:function(){var e=this.$view.find("#animation-option");this.prefs.get("disableAnimation")?(e.find(".on").removeClass("selected"),e.find(".off").addClass("selected")):(e.find(".on").addClass("selected"),e.find(".off").removeClass("selected"))},onImageSettingChange:function(){var e=this.$dingMenu.find("#img-option");this.prefs.get("disableImages")?(e.find(".on").removeClass("selected"),e.find(".off").addClass("selected"),$(".chat-image, .chat-image-overlay").hide(),$(".chat-text").show()):(e.find(".on").addClass("selected"),e.find(".off").removeClass("selected"))},dingMenuHideTimeout:null,dingMenuHide:function(){this.$dingButton.removeClass("hover"),this.$dingMenu.hide()},dingMenuMouseEnter:function(){this.chatstickerPicker&&this.chatstickerPicker.close(),window.clearTimeout(this.dingMenuHideTimeout);var e=this.$dingButton.offset();this.$dingMenu.css({top:e.top,left:e.left+this.$dingButton.width()/2}).show(),this.$dingButton.addClass("hover")},dingMenuMouseLeave:function(){this.dingMenuHideTimeout=window.setTimeout(this.dingMenuHide,500)},dingMenuClick:function(e){var t=$(e.target),i=t.data("setting");t.parents("li.option").hasClass("split-option")||t.hasClass("split-option")||(t.addClass("selected").siblings(".option").removeClass("selected"),this.dingSetting=i,n.setSetting("playdingsound",i))},$lastHoveredHeaderButton:null,dropDownHideTimeout:null,dropDownHide:function(){var e=this.$lastHoveredHeaderButton;e&&e.removeClass("hover").find(".floating-menu").hide(),this.$lastHoveredHeaderButton=null},dropDownMouseEnter:function(e){var t=$(e.target).closest(".dropdown-container"),i=this.$lastHoveredHeaderButton;if(i){if(window.clearTimeout(this.dropDownHideTimeout),i[0]===t[0])return;this.dropDownHide()}var n=t.find(".floating-menu");n.show(),t.addClass("hover"),this.$lastHoveredHeaderButton=t},dropDownMouseLeave:function(){this.dropDownOverride||(this.dropDownHideTimeout=window.setTimeout(this.dropDownHide,500))},$lastSelectedSubsection:null,transitionEndHandler:function(e){$(e.target),this.$lastSelectedSubsection.removeClass("selected")},volumeControlClasses:["volume-high","volume-medium","volume-low","volume-mute"],toggleMute:function(){if(this.muted)this.volumeKnobDraw(),turntablePlayer.setVolume(4*this.volumePercentage),this.muted=!1;else{this.volumeKnobDraw(null,0);var e=this.volumeControlClasses.slice(0,3);this.$volumeControl.removeClass(e.join(" ")).addClass(this.volumeControlClasses[3]),turntablePlayer.setVolume(0),this.muted=!0}},yOffsetFromKnobCenter:null,knobMaxY:null,knobMinY:null,fillRadius:3,volumeKnobMouseDown:function(e){this.dropDownOverride=!0,this.muted=!1;var t=this.$fill,i=this.$slider;this.yOffsetFromKnobCenter=e.pageY-t.offset().top,this.knobMinY=i.offset().top,this.knobMaxY=this.knobMinY+i.height(),this.knobMinY+=this.fillRadius,this.knobMaxY-=this.fillRadius,e.preventDefault()},volumeKnobMouseMove:function(e){var t=e.pageY-this.yOffsetFromKnobCenter;t=Math.min(this.knobMaxY,Math.max(this.knobMinY,t));var i=this.knobMaxY-t,n=i/(this.knobMaxY-this.knobMinY);this.volumeFillHeight=i+2*this.fillRadius,this.requestVolumeKnobDraw(),this.bufferedSetVolume(4*n),this.volumePercentage=n,e.preventDefault()},volumeKnobMouseUp:function(){this.dropDownOverride=!1,this.dropDownMouseLeave()},volumeKnobDraw:function(e,t){t=void 0!==t?t:this.volumePercentage;var i=t*(this.$slider.height()-2*this.fillRadius)+2*this.fillRadius;this.$fill.height(i);var n=this.volumeControlClasses.slice(),o=Math.round(2*(1-t)),s=n.splice(o,1)[0];s!=this.currentVolumeClass&&this.$volumeControl.removeClass(n.join(" ")).addClass(s)},initFavorite:function(){turntable.favorites&&(this.hasLoadedFavorites=!0,this.roomId in turntable.favorites&&($(this.nodes.favorite).addClass("favorite-on"),this.isFavorite=!0))},toggleFavorite:function(){if(this.hasLoadedFavorites){var e=this;this.isFavorite?($(e.nodes.favorite).removeClass("favorite-on"),turntable.ZxcLsz({api:"room.rem_favorite",roomid:this.roomId,section:this.section},function(t){t.success?(e.isFavorite=!1,turntable.favorites[e.roomId]=void 0):$(e.nodes.favorite).addClass("favorite-on")})):($(e.nodes.favorite).addClass("favorite-on"),turntable.ZxcLsz({api:"room.add_favorite",roomid:this.roomId,section:this.section},function(t){t.success?(e.isFavorite=!0,turntable.favorites[e.roomId]=!0):$(e.nodes.favorite).removeClass("favorite-on")}))}},onAddedToDOM:function(){var e=s.chromeView.chatPane.$(".chat-bar"),t=this.$chatInput=$(this.nodes.chatText),i=s.chromeView.chatPane.$(".messages");t.autosize({callback:$.proxy(function(){var n=t.outerHeight(!0)+8;t[0],e.height(n),i.css("bottom",n),this.updateChatScroll()},this)});var n=s.chromeView.roomPane.$(".edit-description");n.autosize(),this.$eventBus.trigger("Room.visible")},setupRoom:function(e){var t=e.metadata;$(this.nodes.roomName).text(e.name);var i=$("#guest-welcome .roomName");i.length&&i.text(e.name);var o=t.sticker_placements;if(o&&$(document).trigger("add_sticker_placements",o),this.setupSharing(e.name),this.updateRoomDesc(e),$(".room-info .room-name").text(e.name),e.metadata.creator&&(e.metadata.creator&&e.metadata.creator.userid,$(".room-info .creator").text(n.safeText(e.metadata.creator.name)).attr("href","/profile/"+e.metadata.creator.userid)),this.roomView||(window.MvxTJL=this.roomView=this.makeRoomView(),this.roomView.$el,$(this.nodes.roomArea).append(this.roomView.el),this.roomView.options.addToDOM.resolve()),this.muted===!0||0===this.volumePercentage);else{var s=parseFloat(n.getSetting("volume"))||turntablePlayer.volume;turntablePlayer.setVolume(s),this.bufferedSetVolume=n.rateLimit(turntablePlayer,turntablePlayer.setVolume,200),this.$fill=$("#volume-fill"),this.$slider=$("#volume-slider"),this.$volumeControl=$("#volume-control"),this.volumePercentage=s/4,this.requestVolumeKnobDraw=n.makeDrawer(this,this.volumeKnobDraw),this.volumeKnobDraw()}},makeRoomView:function(e){e||(e=this.roomData);var t=new RoomView({numDjSpots:e.metadata.max_djs,callback:this.zApRhMCallback,model:this.model,room:this,roomData:this.roomData,listenerids:this.listenerids,crowdControl:this.crowdControl,addToDOM:$.Deferred(),prefs:this.prefs});return t},track_share_action:function(e,t){try{_gaq.push(["_trackEvent","share",e,t])}catch(i){}},setupSharing:function(e){var t=this,i=function(){if(t.currentSong){var e=t.currentSong.metadata.coverart;if(e)return e.replace("_50","_100")}return""},o=function(){var e="";return t.currentSong&&(e="Now playing: "+t.currentSong.metadata.artist+" - "+t.currentSong.metadata.song),e},r=function(){var t=e;return t.match(/^the/i)||(t="the "+t),t.match(/room$/i)||(t+=" room"),t},a=function(){var e=[(t.isDj()?"DJing in ":"I'm listening to ")+r()+"."," Come hang out!"," \u266b\u266a"," @turntablefm"],i=[1,-2,-1];t.currentSong&&(e.splice(2,0," Now playing "+t.currentSong.metadata.artist,": "+t.currentSong.metadata.song),i.splice(2,0,3));for(var n=0,o=0;o<e.length;o++)n+=e[o].length;for(var o=0;o<i.length&&n>120;o++){var s=i[o];0>s&&(s+=e.length),n-=e[s].length,e[s]=""}return encodeURIComponent(e.join(""))},l=encodeURIComponent(location.href);s.chromeView.nodes.header.$(".header-room-twitter").click(function(){var i=a(),n=600,o=300,s=screen.width/2-n/2,r=screen.height/3-o/2;t.track_share_action("twitter",e),window.open("http://twitter.com/share?text="+i+"&url="+l,"tweet","menubar=0,resizable=0,width="+n+",height="+o+",left="+s+",top="+r)}),s.chromeView.nodes.header.$(".header-room-facebook").click(function(){a();var s=r(),u=i(),d="turntable.fm+lets+you+listen+to+music+at+the+same+time+with+your+friends.",h=o();h&&(d=h);var c=1e3,p=460,f=screen.width/2-c/2,m=screen.height/3-p/2;t.track_share_action("facebook",e),window.open("https://www.facebook.com/dialog/feed?app_id=127146244018710&redirect_uri="+encodeURIComponent("http://"+location.host+"/close_window")+"&link="+l+"&picture="+u+"&caption=Come+join+me+and+let's+listen+to+music+together"+"&description="+d+"&name=I'm+in+"+n.title(s)+"+on+turntable.fm","fb","menubar=0,resizable=0,width="+c+",height="+p+",left="+f+",top="+m)})},refreshFacebookToken:function(){setTimeout(function(){turntable.ZxcLsz({api:"user.update_facebook_token",fbtoken:h.USER_FBTOKEN})},3e4)},loadTrendingSongs:function(){this.isLoadingTrendingSongs||(ttCommon.apiGet({api:"room.top_tracks",roomid:this.roomId}).done($.proxy(function(e){if(e&&e.top_tracks&&e.top_tracks.tracks){var t=e.top_tracks.tracks;this.trendingSongs.set(t)}},this)),this.isLoadingTrendingSongs=!0)},showScreenEditor:function(){var e=new RoomScreenEditor({roomView:this.roomView});e.show()},updateRoomDesc:function(e){this.model.set("description",e.description)},facebookSendDialog:function(){var e=465,t=225,i=screen.width/2-e/2,n=screen.height/3-t/2;this.track_share_action("facebook-invite",this.roomData.name),window.open("https://www.facebook.com/plugins/send_button_form_shell.php?api_key=113869198637480&nodeImageURL=https://s3.amazonaws.com/assets.turntable.fm/images/record-large.png&nodeSummary=turntable.fm+lets+you+listen+to+music+at+the+same+time+with+your+friends.&nodeTitle=Play+music+together.&nodeURL="+encodeURIComponent(location.href),"fb","menubar=0,resizable=0,width="+e+",height="+t+",left="+i+",top="+n)},feedbackShow:function(){FBY.showForm("633"),this.feedbackifyInstrument()},helpShow:function(e){e&&e.preventDefault(),FBY.showForm("3178"),this.feedbackifyInstrument()},feedbackifyInstrument:function(){/chrome/i.test(navigator.userAgent)&&(this.extensionTesting=d.testForKnownExtensions());var e=$("#feedbackify .fsend");if(0==e.length)return setTimeout(this.feedbackifyInstrument,300),void 0;var i=e.filter(".new");if(0==i.length){var i=e.clone(!1).addClass("new");i.insertAfter(e),i.click(t.bind(function(){var e=$("#feedbackify .feedback-holder textarea"),t=e.val();this.getFeedbackMetadata().done(function(i){"string"==typeof t&&e.val(t+i),$(".fsend.new").hide(),$(".fsend.old").show(),YUI().use("node-event-simulate",function(e){e.one(".fsend.old").simulate("click")})})},this))}else i.show();e.addClass("old").hide()},getFeedbackMetadata:function(){var e=$.Deferred(),i="\n\nSent by user "+c.id+"\n"+navigator.userAgent+"\n\n";return i+="avg msPerFrame: "+this.roomView.stats.getMovingAverage()+"\n",i+="max msPerFrame: "+this.roomView.maxAvg+"\n",i+="degradation level: "+this.roomView.degradationLevel,this.extensionTesting?this.extensionTesting.done(function(n){var o=t.filter(t.keys(n),function(e){return n[e]}),s=t.map(o,function(e){return d.getExtensionName(e)});s.length&&(i+="\n\nExtensions: "+s.join(", ")),e.resolve(i)}):e.resolve(i),e.promise()},addUserToMap:function(e){e.isFanned=c.isFanof(e.userid),e.isBuddy=c.isBuddy(e.userid);var t=this.userMap[e.userid];t?t.set(t.parse(e)):this.userStore.has([e])?(t=this.userStore.get([e],this),t.set(t.parse(e))):t=this.userStore.get([e,{parse:!0}],this),this.userMap[t.id]=t},addListener:function(e,t){if(null==this.roomView)return this.loadRoomStateTask?this.loadRoomStateTask.done($.proxy(function(){this.addListener(e)},this)):LOG("Attempted to add listener without a room manager"),void 0;var i=this.userMap[e],n=this.listenerMap[e];n?this.updateUserInRoomView(i):(this.roomView.addListener(i,this.getEntropyForUser(i)),this.updateUserVoteInRoomView(i),this.listenerMap[e]=!0),this.listeners.add(i),-1===this.listenerids.indexOf(e)&&this.listenerids.push(e),t||this.roomView.updateTotalListeners(this.roomData.metadata.listeners),i.set({roomId:this.roomData.roomid,roomName:this.roomData.name,roomShortcut:this.roomData.shortcut}),(i.get("isFanned")||i.get("isBuddy"))&&(i.set("status","available"),s.pms.manualInsert(this.roomData,i.attributes))},removeListener:function(e){if(!this.userMap.hasOwnProperty(e))return LOG(e+" is not a listener!"),void 0;var t=this.userMap[e];this.listeners.remove(t),this.listenerMap[e]=void 0;var i=this.listenerids.indexOf(e);-1!==i&&this.listenerids.splice(i,1),i=this.djids.indexOf(e),-1!==i&&this.djids.splice(i,1),this.roomView.removeListener(t),this.roomView.updateTotalListeners(this.roomData.metadata.listeners),this.$eventBus.trigger("Room.removeListener",e)},updateUser:function(e){var t=this.userMap[e.userid];e.hasOwnProperty("registered")&&t.set("registered",!0),e.hasOwnProperty("avatarid")&&t.set("avatarId",e.avatarid),e.hasOwnProperty("name")&&e.name!=t.get("name")&&(e.hasOwnProperty("registered")||this.appendAction(t.id,t.get("name")," shall now be known as "+e.name+".","action"),t.set("name",e.name)),e.hasOwnProperty("fans")&&this.handleFanned(e),this.updateUserInRoomView(t)
},updateUserInRoomView:function(e){var t=$.inArray(e.id,this.djids);-1==t&&(this.roomView.removeListener(e),this.roomView.addListener(e,this.getEntropyForUser(e))),this.updateUserVoteInRoomView(e)},updateUserVoteInRoomView:function(e){-1!=$.inArray(e.id,this.upvoters)&&this.roomView.updateVote(e,"up")},addDj:function(e){var t=this.userMap[e];this.djs.add(t),this.updateUserVoteInRoomView(t);var i=this.djids.indexOf(e);-1!==i&&this.djids.splice(i,1),this.djids.length<this.roomData.metadata.max_djs?(this.djids.push(e),this.roomData.metadata.djs=this.djids.slice()):this.loadRoomState()},removeDj:function(e){this.djs.remove(e);var t=this.djids.indexOf(e);if(-1!=t){this.djids.splice(t,1),this.roomData.metadata.djs=this.djids.slice();var i=this.userMap[e];i&&!this.section&&(this.roomView.addListener(i,this.getEntropyForUser(i)),this.updateUserVoteInRoomView(i))}},inviteDj:function(){this.facebookSendDialog()},fusWBa:function(){if(!(s.presence.getIdleTime()>15e3)&&c.registered&&!this.isDj()){if(0==playlist.fileids.length)return RoomOnboardingTour.showEmptyPlaylist(),void 0;var e=this;turntable.ZxcLsz({api:"room.add_dj",roomid:this.roomId,section:this.section},function(t){_gaq.push(["_trackEvent","dj","become",s.get("miniplayer")?"mini":"full"]),t.success||e.isDj()||turntable.showAlert(t.err)})}},quitDj:function(){this.isDj()&&(turntable.ZxcLsz({api:"room.rem_dj",roomid:this.roomId,section:this.section}),_gaq.push(["_trackEvent","dj","quit",s.get("miniplayer")?"mini":"full"]))},isDj:function(e){e||(e=c.id);var t=this.userMap[e];return this.djs.contains(t)},onBeforeUnload:function(){return this.isDj()?"Warning: if you leave this page, you'll give up your DJ spot.":($.browser.mozilla||this.cleanup(),void 0)},postUsernameRegex:/^([^A-Za-z0-9!@#$%^&*()+=_\[\]{}~|;:\'"<>,.?\/\\ -]|[!);:\',.?]*(\s|$))/,isImageRegex:/^https?:\/\/[!#$&-;=?-[\]%_a-z~]+[&\?\.#=](gif|jpg|jpeg|png)$/i,showImage:function(e,t){var i=t&&t.get("subscriptionLevel")>0;if(this.isImageRegex.test(e)&&!this.prefs.get("disableImages")&&i){var o=n.createImageWithLoader(e),s=o[0],r=o[1];return $(s).attr("alt",e).addClass("chat-image"),r.done(this.updateChatScroll),n.buildTree(["div.chat-image-container",[s,["span.chat-text",["a",{href:e,target:"_blank"},e]],["div.chat-image-overlay",["a.close",{href:"#",event:{click:function(e){e.preventDefault();var t=$(e.target).parents(".chat-image-container");t.find(".chat-image").hide(),t.find(".chat-text").show(),t.find(".chat-image-overlay").hide()}}}]]]])}return e},onStickerClick:function(t){var i="$"+t+"$";e.throttleChat.apply(this,[i])||this.sendSpeakMessage(i)},isMention:function(e){if(e&&c.registered){var t=c.get("name").toLowerCase(),e=e.toLowerCase();"@"!==t[0]&&(t="@"+t);for(var i,n=e.indexOf(t),o=t.length;-1!==n;){if(i=n+o,this.postUsernameRegex.test(e.substring(i)))return!0;n=e.indexOf(t,n+1)}return!1}},showChatMessage:function(e,t,i){if(-1==$.inArray(e,this.ignoredUsers)){var n=this.isMention(i);if("/me "===i.substr(0,4))this.appendAction(e,t,i.substr(3)),this.roomView&&this.roomView.speak(this.userMap[e],"*"+i.substr(4)+"*");else{var o,s=this.userMap[e]||{};s.get("verified")&&this.isDj(e)&&(this.numListeners()>150||this.isFeatured())&&(o="verified"),o=n?"mention":o,this.appendChatMessage(e,t,i,o),this.roomView&&this.roomView.speak(s,i)}!n||"on"!==this.dingSetting&&"mention"!==this.dingSetting?"on"===this.dingSetting&&turntablePlayer.playEphemeral(UI_SOUND_CHAT,!0):turntablePlayer.playEphemeral(UI_SOUND_MENTION,!0)}},lastChatSpeakerid:null,$lastChatMessage:null,appendChatMessage:function(e,t,i,o){var s,a=!1,l=this.userMap[e]||{};if(this.lastChatSpeakerid===e)s=this.$lastChatMessage;else{s=$(n.buildTree(p.layouts.chatMessage));var u;if("TURNTABLE"==t)u="url("+IMG_PATH+"loudspeaker.png)";else{var l=this.userMap[e];if(!l)return;u="url("+l.get("images").headfront+")"}s.find(".avatar").css("background-image",u),s.find(".speaker").text(t).data("userid",e),a=!0,this.lastChatSpeakerid=e,this.$lastChatMessage=s}var d,h=this.showImage(i,l),c=r.showChatstickers(i,l,{display:"block",margin:"5px 0"});h!=i?d=$(h):c!=i?d=$(c):(d=$(n.buildTree(["div.text"])),this._attachTruncatedText(d,n.messageFilter(n.stripComboDiacritics(i)))),o&&s.addClass(o),a?(s.find(".textContainer").append(d),this.appendMessage(s)):(this.checkChatScroll(),s.find(".textContainer").append(d),this.updateChatScroll()),this.chatTabItem.isSelected||this.chatUnreadCount.inc()},appendAction:function(e,t,i,o){this.lastChatSpeakerid=null;var s=$(n.buildTree(p.layouts.actionMessage)),r=s.find(".text");this._attachTruncatedText(r,n.messageFilter(i)),s.find(".subject").text(t).data("userid",e),o&&s.addClass(o),this.appendMessage(s)},_attachTruncatedText:function(e,t){t.length>446&&(e.attr("title",t),t=t.substr(0,440)+"..."),e.html(t)},emptyMessageRemoved:!1,appendMessage:function(e){var t=this.nodes.chatLog,i=$(t);this.emptyMessageRemoved||(i.find(".default-message").remove(),this.emptyMessageRemoved=!0),this.checkChatScroll(),i.append(e),this.updateChatScroll();var n=$(t).find(".message");if(n.length>CHAT_HISTORY_SIZE){n=n.slice(0,2);var o=n.first().outerHeight(!0)+n.last().outerHeight(!0);n.remove(),this.chatScrollBottom||(t.scrollTop-=o)}},chatScrollBottom:!0,checkChatScroll:function(){var e=this.nodes.chatLog,t=e.scrollTop+e.offsetHeight+20>=e.scrollHeight;this.chatScrollBottom=t},updateChatScroll:function(){var e=this.nodes.chatLog;this.chatScrollBottom&&(e.scrollTop=e.scrollHeight)},votes:0,upvoters:[],currentSong:null,setCurrentSong:function(e,t,i){LOG("setCurrentSong");var o=n.now()/1e3,r=e?e.current_dj:null,a=e?e.current_song:null;r&&a||(r=a=null);var l=!(this.currentSong&&a&&this.currentSong._id==a._id&&Math.abs(this.currentSong.starttime-a.starttime)<.1);i||(this.upvoters=[]);var u=this.roomData.metadata;if(l)if(LOG("song change"),httpStream.closeStream(),this.streamStarted=!1,u.currentDj&&(this.userMap[u.currentDj].set("points",this.currentDjPointsAtSongStart+this.currentDjPointDelta),this.previousDjid=u.currentDj,this.previousDjPointDelta=this.currentDjPointDelta,u.currentDj==c.id&&c.set("points",this.userMap[u.currentDj].get("points"))),n.notEmpty(t)&&this.userMap[r].set("points",t),r&&(this.currentDjPointsAtSongStart=this.userMap[r].get("points")-e.upvotes),this.currentDjPointDelta=0,this.timers.oLWsfD&&(clearTimeout(this.timers.oLWsfD),this.timers.oLWsfD=null),playlist.notifyCurrentSong(a,r),LOG("current dj? ",r==c.id),r==c.id){for(;this.songsDjed.length&&this.songsDjed[0].time+10800<o;)this.songsDjed.shift();if(a){for(var d=!1,h=0;h<this.songsDjed.length;h++)if(this.songsDjed[h].fileId==a._id){d=!0;break}d?s.presence.getIdleTime()>12e4:this.songsDjed.push({fileId:a._id,time:o})}}else s.presence.getIdleTime()>18e5&&this.isDj()&&(this.showRoomTip("It looks like you've been falling asleep at the deck. How about taking a break from DJing?"),this.quitDj());if(u.currentDj===r&&n.notEmpty(t)&&(LOG("same DJ"),this.userMap[r].set("points",t)),u.currentDj=r,a){var p=a.metadata,f=o-turntable.clientTimeDelta;if(f<a.starttime&&(f=a.starttime,turntable.clientTimeDelta=o-f),e.netloc&&e.sync&&e.sync.current_seg){var m=e.netloc+this.roomId,g=function(){httpStream.loadStream(m,e.sync.current_seg,e.sync.tstamp,500)};l?"resolved"!==this.loadRoomStateTask.state()?g():(LOG("seting timeout to load stream"),setTimeout(g,500)):i&&g()}else LOG("scheduling resync stream"),this.scheduleResyncStream(2e3);var v=$.inArray(u.currentDj,this.djids);if(ASSERT(-1!==v),l&&this.appendAction(u.currentDj,this.userMap[u.currentDj].get("name"),' started playing "'+a.metadata.song+'" by '+a.metadata.artist),this.currentSong=a,this.currentSongEndTime=a.starttime+turntable.clientTimeDelta+p.length,LOG("current song end time: "+this.currentSongEndTime),LOG("current time: "+Date.now()/1e3),l){this.exposeSongInfo(),s.currentSongPlay&&s.currentSongPlay.stop(),a.localstarttime=a.starttime+turntable.clientTimeDelta,a.localendtime=this.currentSongEndTime,a.score=.5;var b=s.currentSongPlay=new SongPlay(a,{parse:!0});b.start(),this.songVote.set("vote",""),this.model.songLog.add(b),s.trigger("currentSong:change",b)}}else LOG("no song"),this.currentSong=null,s.currentSongPlay&&s.currentSongPlay.stop(),this.songVote.set("vote",""),s.trigger("currentSong:change",null),s.currentSongPlay=void 0},exposeSongInfo:function(){song=this.currentSong,turntable.current_artist=song.metadata.artist,turntable.current_title=song.metadata.song,turntable.current_songid=song._id},getCurrentSongProgress:function(){var e=this.currentSong.metadata;return 1-(this.currentSongEndTime-n.now()/1e3)/e.length},oLWsfD:function(){this.timers.oLWsfD=null,1==this.numDjs()&&(turntablePlayer.zPSPGa(!0),this.showRoomTip("We can only play you a preview of your song until someone else also starts DJing. Everyone else can still hear the song playing."))},getScore:function(e){return e||(e=this.roomData.metadata),(e.upvotes-e.downvotes+e.listeners)/(2*e.listeners)},updateVotes:function(e,t){LOG("updateVotes",e,t),e.upvotes-e.downvotes;var i=this.getScore(e);i&&(this.roomView&&this.roomView.moveNeedle(i),s.currentSongPlay&&s.currentSongPlay.set("score",i)),this.upvoters.length,LOG("votelog length",e.votelog.length);for(var n=0;n<e.votelog.length;n++){var o=e.votelog[n],r=this.userMap[o[0]];if(r){null==this.roomView?this.loadRoomStateTask?this.loadRoomStateTask.done($.proxy(function(){this.roomView.updateVote(r,o[1])},this)):window.setTimeout($.proxy(function(){this.updateVotes(e,t)},this),1e3):this.roomView.updateVote(r,o[1]);var a=$.inArray(r.id,this.upvoters);"up"==o[1]&&-1==a?(LOG("pushing"),this.upvoters.push(r.id)):"down"==o[1]&&-1!=a&&(LOG("splicing"),this.upvoters.splice(a,1))}else LOG("no user!!");o[0]===s.user.id&&this.songVote.set("vote",o[1])}if(t){if(!this.roomData.metadata)return;var l=this.roomData.metadata.current_dj;ASSERT(l,"Somebody voted but no DJ was active"),this.currentDjPointDelta=e.upvotes,this.users[l].set("points",this.currentDjPointsAtSongStart+this.currentDjPointDelta)}},lobbyRedirect:function(e){var t="Sorry, you weren't able to enter the room (error "+e+"). Please choose another room.";1==e?(t="Due to fire codes, this room is at maximum capacity. We'll escort you back to the lobby.",_gaq.push(["_trackEvent","room","deny","full"])):2==e?(t="Looks like you're already in another room. Please close that room before entering another one.",_gaq.push(["_trackEvent","room","deny","otherroom"])):3==e&&(t="The bouncer has decided not to let you in, and will escort you back to the lobby.",_gaq.push(["_trackEvent","room","deny","bouncer"])),turntable.showAlert(t,function(){window.location.href="/"}),this.setCurrentSong(null)},gotBooted:function(e,t){t||(t="The Moderator");var i=e?" (Reason: "+e+")":"",s=this;n.buildTree([o,{className:"booted",showCancel:!1,showClose:!1,clickOut:!1,submitCallback:function(){s.modal.close(),window.location.href="/"}},["div.section",["div.unhappyFace"],["br"],t," booted you from the room.",i,["br"],["br"],"We'll take you back to the lobby to choose a new room.",["br"]]],this),this.modal.show()},checkIdle:function(){turntable.showAlert("Hey sleepyhead, are you idle? Click OK to continue listening, or you will be escorted to the lobby in two minutes.");var e=this;this.originalVolume=turntablePlayer.volume,turntablePlayer.setVolume(0),this.timers.checkIdle=setTimeout(function(){e.timers.checkIdle=null,turntable.removeEventListener("unidle",e.cancelIdleBoot),s.room.modal.close(),turntablePlayer.setVolume(e.originalVolume),window.location.href="/"},12e4),turntable.addEventListener("unidle",this.cancelIdleBoot)},cancelIdleBoot:function(){clearTimeout(this.timers.checkIdle),this.timers.checkIdle=null,turntable.removeEventListener("unidle",this.cancelIdleBoot),s.room.modal.close(),turntablePlayer.setVolume(this.originalVolume)},showRoomTip:function(e,t){var i=$(".roomTip .text");i.text(e),this.timers.hideRoomTip?(clearTimeout(this.timers.hideRoomTip),this.timers.hideRoomTip=null):$(".roomTip").fadeIn(),setTimeout(function(){i.css("margin-top",($(".roomTip").height()-i.height())/2+"px")},0),t&&(this.timers.hideRoomTip=setTimeout(this.hideRoomTip,1e3*t))},hideRoomTip:function(){$(".roomTip").fadeOut(),this.timers.hideRoomTip&&(clearTimeout(this.timers.hideRoomTip),this.timers.hideRoomTip=null)},handlePM:function(e,t){var i=function(){e&&e.senderid&&e.text&&turntable.buddyList.pmWindows[e.senderid].addPM(e)};e.senderid in turntable.buddyList.pmWindows?(i(),turntable.buddyList.pmWindows[e.senderid].open(t)):turntable.buddyList.addPMWindow(e.senderid,t,i)},_onPopOutCreated:function(){var e="You are now using the miniplayer. You may close this window.";n.buildTree([Modal,{showClose:!1,clickOut:!1},["div.alert-message",e]],this),this.modal.show(),this.roomView.cleanup(),httpStream.closeStream(),$("#footer, #guest-welcome").hide()},moveRoom:function(e,i){this.isDj()?(n.buildTree([o,{showClose:!1,clickOut:!1,submitCallback:t.bind(this._moveRoom,this,e,i)},["div.alert-message","Are you sure you want to leave this room? You will lose your DJ spot."]],this),this.modal.show()):this._moveRoom(e,i)},_moveRoom:function(e,t){s.router.setRoute("room",{shortcut:e},{roomId:t})}}}(),{_name:"Room"});return p.layouts={zeroClip:null,page:function(){return["div.room-container.room-viewport",["div##roomArea#scene"],["div.roomTip",{},["div.roomTipClose"],["div.text"]],["div##chat.chat",["div##chatLog.messages",["div.default-message",["p","It's a little quiet in here. Start the conversation!"]]],["div##chatBar.chat-bar.floating-panel-bar",["div.chatsound-container",["div##chatSound.chatsound"]],["div.divider"],["form##chatForm#chat-form",["textarea##chatText#chat-input.message-input",{event:{keyup:this.chatTextListener},type:"text",placeholder:"enter a message"}],["img.chatsticker-icon",{src:IMG_PATH+"chatstickers/icon.png"}]]]]]},dingMenu:["ul#ding-menu.floating-menu.up",["li.option.on",{data:{setting:"on"}},"Ding on"],["li.option.mention",{data:{setting:"mention"}},"Ding on Mention"],["li.option.off",{data:{setting:"off"}},"Ding off"],["li.option.split-option#img-option",{title:"Toggle inline images"},["div.description","Images"],["div.options",["div.option.off",{data:{disableImages:!0}},["span","Off"]],["div.option.on.selected",{data:{disableImages:!1}},["span","On"]]]]],chatMessage:["div.message",{},["div.avatar"],["div.speaker"],["div.textContainer"]],actionMessage:["div.message",{},["span.subject"],["span.text"]],bootConfirmView:function(e,t){return[o,{title:"Boot User",submitCallback:t},["div.field",{},"You're about to boot ",e," from the room.",["br"],["br"],"Care to give a reason?",["br"],["input.bootReasonField.text",{placeholder:"(optional)"}]]]},addModConfirmView:function(e,t){return[o,{title:"Add Moderator",submitCallback:t},["div.field",{},"You're about to bestow moderator powers upon ",e,".",["br"]]]},removeModConfirmView:function(e,t){return[o,{title:"Remove Moderator",submitCallback:t},["div.field",{},"You're about to remove ",e,"'s moderator powers.",["br"]]]},signupButton:function(e){return["div.guest-signin-container",["button#sign-up.tt-button.small.primary.inset",{event:{click:e}},"Sign up"]]},guestPlaylistPane:function(e){return["div#guest-playlist-pane",["div.guest-queue-icon"],["div.message-1","Sign up to DJ"],["div.message-2","Play your favorite music for the listeners in the room!"],["div.message-3","You can either search our vast library, or upload your own tracks. Once you're ready, take the stage and show what you've got!"],["button.sign-up.tt-button.small.primary.inset",{event:{click:e}},"Sign up"]]},guestChatButton:function(e){return["div#guest-chat-bar.chat-bar.floating-panel-bar",["button#chat-sign-up.tt-button.small.primary.inset",{event:{click:e}},"Sign up to chat"]]},guestWelcome:function(e){return["div#guest-welcome",["div.avatar"],["div.header","Welcome to ",["span.roomName"]," at turntable.fm!"],["div.message","Sign up to customize your avatar, participate in the room chat, step up to DJ and more!"],["div.sign-in",["a.login-link",{href:"/login"},"Log in"]," or"],["button.sign-up",{event:{click:e}},"Sign up"]]}},p}),define("main",["require","httpstream","socket.io","soundmanager","swfobject","util","action-modal","app","buddylistpm","config","popout","room","sticker","tt-common","player"],function(e){var t=e("httpstream"),i=e("socket.io"),n=e("soundmanager"),o=e("swfobject"),s=e("util"),r=e("action-modal"),a=e("app"),l=e("buddylistpm"),u=e("config"),d=e("popout"),h=(e("room"),e("sticker")),c=e("tt-common"),p=e("player");n.setup({url:"/static/swf/soundmanager2/soundmanager2_flash9.swf",consoleOnly:!0,debugMode:!1,debugFlash:!1,flashVersion:9,flashLoadTimeout:1e4,useFlashBlock:!0,onready:function(){LOG("soundManager onready"),p.init()}});var f,m={sOxwLW:null,pendingCalls:[],deferreds:[],clientId:s.now()+"-"+Math.random(),clientTimeDelta:0,eventListeners:{auth:[],avatarchange:[],message:[],messagefinish:[],reconnect:[],trackstart:[],trackfinish:[],unidle:[],userinfo:[]},socket:null,socketVerbose:!0,socketErrors:[],messageId:0,currentSocketPort:0,currentSocketServer:null,favorites:!1,buddyList:!1,presenceUpdateInterval:10,syncServerClock:function(e){return a.presence.save(null,{force:e})},main:function(){return u.IS_FRAMED?!1:(d.isPopout()&&(m.clientId=d.getClientId(),d.becomePopout()),a.on("popOut",function(){m.closeSocket()}),$("body").append(s.buildTree(["div#httpstream"])),t.url="/static/swf/HTTPSimpleStream.swf",o.embedSWF(t.url+"?v="+s.now(),"httpstream","1","1","10.1.0",null,{},{bgcolor:"red"},{},function(){o.hasFlashPlayerVersion("10.1.0")?window.setTimeout(function(){try{$("#httpstream")[0].getPosition()}catch(e){m.showAlert("Could not load player. Is Flash blocked?"),_gaq(["_trackEvent","user","flash","blocked"])}},5e3):(m.showAlert("Sorry! You need a recent version of Flash to listen to music on Turntable."),_gaq(["_trackEvent","user","flash","outdated"]))}),m.avatarLoad=c.apiGet({api:"avatar.all"}).done(function(e){a.avatars=e.avatars,a.avatars[999]={avatarid:"999",frontSize:[176,167],images:{bb:"/roommanager_assets/avatars/999/bodyback.png?t=1369411802",bf:"/roommanager_assets/avatars/999/bodyfront.png?t=1369411802",fb:"/roommanager_assets/avatars/999/fullback.png?t=1369411802",ff:"/roommanager_assets/avatars/999/fullfront.png?t=1369411802",hb:"/roommanager_assets/avatars/999/headback.png?t=1369411802",hf:"/roommanager_assets/avatars/999/headfront.png?t=1369411802"},ll:101,name:"null",size:[176,167],sprites:{back:{bob:{20:{base:"/roommanager_assets/avatars/999/back/bob/20new.png?t=1369411802",numFrames:12,numFramesX:3,offset:[-88,-167],"rgba(16,9,17,0&#46;5)":"/roommanager_assets/avatars/999/back/bob/20-rgba(16,9,17,0.5)new.png?t=1369411802",size:[176,167]}},rock:{20:{base:"/roommanager_assets/avatars/999/back/rock/20new.png?t=1369411802",numFrames:24,numFramesX:4,offset:[-91,-174],"rgba(16,9,17,0&#46;5)":"/roommanager_assets/avatars/999/back/rock/20-rgba(16,9,17,0.5)new.png?t=1369411802",size:[182,174]}},smallrock:{20:{base:"/roommanager_assets/avatars/999/back/smallrock/20new.png?t=1369411802",numFrames:24,numFramesX:4,offset:[-91,-171],"rgba(16,9,17,0&#46;5)":"/roommanager_assets/avatars/999/back/smallrock/20-rgba(16,9,17,0.5)new.png?t=1369411802",size:[182,171]}}},front:{bob:{20:{base:"/roommanager_assets/avatars/999/front/bob/20new.png?t=1369411802",numFrames:12,numFramesX:3,offset:[-88,-167],"rgba(16,9,17,0&#46;5)":"/roommanager_assets/avatars/999/front/bob/20-rgba(16,9,17,0.5)new.png?t=1369411802",size:[176,167]}},rock:{20:{base:"/roommanager_assets/avatars/999/front/rock/20new.png?t=1369411802",numFrames:24,numFramesX:4,offset:[-91,-174],"rgba(16,9,17,0&#46;5)":"/roommanager_assets/avatars/999/front/rock/20-rgba(16,9,17,0.5)new.png?t=1369411802",size:[182,174]}},smallrock:{20:{base:"/roommanager_assets/avatars/999/front/smallrock/20new.png?t=1369411802",numFrames:24,numFramesX:4,offset:[-91,-171],"rgba(16,9,17,0&#46;5)":"/roommanager_assets/avatars/999/front/smallrock/20-rgba(16,9,17,0.5)new.png?t=1369411802",size:[182,171]}}}},states:{back:[{name:"hb",offset:[0,0]},{name:"bb",offset:[19,20]}],front:[{name:"bf",offset:[19,20]},{name:"hf",offset:[0,0]}]}}}),m.loadTime=s.now(),m.setSocketAddr(m.getHashedAddr(window.TURNTABLE_ROOM.roomid,window.TURNTABLE_ROOM.section)),f=a.user,f.loading.done(function(){h.init(),$(window).bind("keydown",function(e){8==e.keyCode&&-1==$.inArray(e.target.tagName.toLowerCase(),["input","textarea"])&&e.preventDefault()});var e,t={pushState:!0};window.history.pushState||(e=window.location.pathname,t.root="/"+e),Backbone.history.start(t),window.history.pushState||a.router.navigate(e,{trigger:!0,replace:!0}),a.presence.on("change:idle",_.bind(m.onIdleChange,m)),m.buddyList=new l(m.sOxwLW)}),s.nBAInQ(m),void 0)},socketsByPort:{},flushUnsentMessages:function(){for(var e=0;e<m.unsentMessageCallbacks.length;e++)m.unsentMessageCallbacks[e]();m.unsentMessageCallbacks=[]},setSocketAddr:function(e){if(u.IS_FRAMED)return!1;if(LOG("Setting socket addr to "+e),e[0]!=m.currentSocketServer||e[1]!=m.currentSocketPort){m.socketKeepAlive(!1),m.currentSocketServer=e[0],m.currentSocketPort=e[1];var t=function(){if(m.removeEventListener("messagefinish",t),m.socket){LOG("Disconnecting "+m.socket.host),m.socket.removeListener("reconnect",m.socketReconnected),m.socket.send("disconnect");var n=m.socket;setTimeout(function(){n.disconnect()},1e3)}LOG("Switching to addr "+e),m.socket=new i.Socket(e[0],{port:e[1],transports:["websocket","flashsocket","xhr-polling"],rememberTransport:!1,connectTimeout:5e3}),"websocket"==m.socket.transport.type&&(m.socket.transport.options.timeout=25e3),m.connectionTimeout=setTimeout(function(){m.die("Could not connect to turntable. Please try again. If you still cannot connect, you might have a firewall blocking your connection. ("+e[1]+")"),m.connectionTimeout=null},3e4),m.socket.connect(),m.socket.on("connect",m.socketConnected),m.socket.on("message",m.messageReceived),m.socket.on("reconnect",m.socketReconnected)};m.socket&&m.socket.connected&&m.numRecentPendingCalls(15)>0?(m.addEventListener("messagefinish",t),LOG("There are "+m.pendingCalls.length+" pending calls on old socket! Waiting...")):(LOG("No pending calls on old socket... setting up new socket"),t())}},socketConnected:function(){m.connectionTimeout&&(clearTimeout(m.connectionTimeout),m.connectionTimeout=null),m.syncServerClock(!0),m.flushUnsentMessages(),m.socket.removeListener("connect",m.socketConnected)},socketKeepAlive:function(e){m.socketKeepAliveTimer&&(clearTimeout(m.socketKeepAliveTimer),m.socketKeepAliveTimer=null),e&&(m.socketKeepAliveTimer=setTimeout(m.syncServerClock,2e4))},socketLog:function(e){for(;m.socketErrors.length&&m.socketErrors[0].time+6e4<s.now();)m.socketErrors.shift();m.socketErrors.push({time:s.now(),msg:e})},socketDumpLog:function(){for(;m.socketErrors.length&&m.socketErrors[0].time+6e4<s.now();)m.socketErrors.shift();if(!(s.now()<m.socketDumpLogLast+6e4)&&(m.socketDumpLogLast=s.now(),m.socketErrors.length))for(var e="",t=0;t<m.socketErrors.length;t++){var i=m.socketErrors[t];e+=Math.round((s.now()-i.time)/100)/10+":"+i.msg+","}},onIdleChange:function(){if(a.presence.get("idle"))for(var e in m.idleTimers){var t=m.idleTimers[e];t.timeout=setTimeout(t.callback,1e3*Number(e)-a.presence.getIdleTime())}else{for(var e in m.idleTimers)clearTimeout(m.idleTimers[e].timeout);m.dispatchEvent("unidle")}},pingTimer:null,numPings:0,socketReconnected:function(){m.socketLog("rc"),LOG("socket reconnected?"),m.pingTimer||(m.numPings=0,m.pingTimer=setInterval(m.pingSocket,5e3),m.pingSocket())},pingSocket:function(){m.syncServerClock(!0).done(function(e){e&&e.success&&m.pingTimer&&(m.numPings=0,clearInterval(m.pingTimer),m.pingTimer=null,m.dispatchEvent("reconnect"))}),m.numPings+=1,m.numPings>5&&(clearInterval(m.pingTimer),m.pingTimer=null)},closeSocket:function(){f&&m.sOxwLW&&!d.isPopoutHost()&&m.socket.send('{"api":"room.deregister","userid":"'+f.id+'","userauth":"'+f.auth+'","roomid":"'+(m.sOxwLW.roomId||"")+'","section":"'+(m.sOxwLW.section||"")+'"}'),m.isSocketClosed=!0},addEventListener:function(e,t){var i=m.eventListeners[e];ASSERT(i,"Unknown event '"+e+"'"),-1==$.inArray(t,i)&&i.push(t)},removeEventListener:function(e,t){var i=m.eventListeners[e];ASSERT(i,"Unknown event "+e);var n=$.inArray(t,i);-1!=n&&i.splice(n,1)},dispatchEvent:function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n=m.eventListeners[e];ASSERT(n,"Unknown event "+e),n=n.slice();for(var i=0;i<n.length;i++)n[i].apply(m,t)},idleTimers:{},addIdleListener:function(e,t){var i=m.idleTimers[String(e)],n=1e3*e-a.presence.getIdleTime();i?-1==$.inArray(t,i.listeners)&&(i.listeners.push(t),0>=n&&t()):(i={timeout:null,listeners:[t],callback:function(){for(var e=0;e<i.listeners.length;e++)i.listeners[e]()}},m.idleTimers[String(e)]=i,m.isIdle&&(i.timeout=setTimeout(i.callback,n)))},removeIdleListener:function(e,t){var i=m.idleTimers[String(e)],n=i?$.inArray(t,i.listeners):-1;-1!=n&&i.listeners.splice(n,1)},hashMod:function(e,t){for(var i=$.sha1(e),n=0,o=0;o<i.length;o++)n+=i.charCodeAt(o);return n%t},getHashedAddr:function(e,t){var i=e||String(Math.random());return t&&(i=i+"_"+t),CHATSERVER_ADDRS[m.hashMod(i,CHATSERVER_ADDRS.length)]},ZxcLsz:function(e,t){if(m.isSocketClosed)return $.Deferred().reject();if("room.now"!=e.api){e.msgid=m.messageId,e.client="web",m.messageId+=1,e.clientid=m.clientId,f.id&&!e.userid&&(e.userid=f.id,e.userauth=f.auth);var i=JSON.stringify(e);m.socketVerbose&&LOG(s.nowStr()+" Preparing message "+i);var n=$.Deferred();return m.whenSocketConnected(function(){m.socketVerbose&&LOG(s.nowStr()+" Sending message "+e.msgid+" to "+m.socket.host),"websocket"==m.socket.transport.type&&m.socketLog(m.socket.transport.sockets[0].id+":<"+e.msgid),m.socket.send(i),m.socketKeepAlive(!0),m.pendingCalls.push({msgid:e.msgid,handler:t,deferred:n,time:s.now()})}),n.promise()}},numRecentPendingCalls:function(e){for(var t=s.now(),i=0,n=0;n<m.pendingCalls.length;n++)t-m.pendingCalls[n].time<1e3*e&&(i+=1);return i},unsentMessageCallbacks:[],whenSocketConnected:function(e){m.socket.connected&&m.socket.host==m.currentSocketServer&&m.socket.options.port==m.currentSocketPort?e():m.unsentMessageCallbacks.push(e)},messageReceived:function(e){if(u.DEBUG_MODE)m._messageReceived(e);else try{m._messageReceived(e)}catch(t){LOG("Exception in MessageReceived"),LOG(t)}},_messageReceived:function(e){if(m.socketVerbose&&LOG(s.nowStr()+" Received: "+e),"no_session"!=e){if(e=JSON.parse(e),"killdashnine"==e.command){var t=m.sOxwLW;if(s.notEmpty(e.roomid,e.section,t.roomId,t.section)&&(t.roomId!=e.roomid||t.section!=e.section))return;m.socket.disconnect(),m.socket=null;var i=e.msg||"This session has been disconnected because you signed on from another location. Refresh this page if you want to continue.";return m.die(i),void 0}if(m.dispatchEvent("message",e),"websocket"==m.socket.transport.type&&m.socketLog(m.socket.transport.sockets[0].id+":>"+(e.hasOwnProperty("msgid")?e.msgid:e.command||"?")),e.hasOwnProperty("msgid")){ASSERT(e.msgid<m.messageId,"Future msg "+JSON.stringify(e));for(var n=m.pendingCalls.length,o=!1,r=0;n>r;r++){var a=m.pendingCalls[r];if(a.msgid==e.msgid){var l=a.handler,u=a.deferred;l&&l(e),(e.success?u.resolve:u.reject)(e);var d=s.now();d-m.loadTime>6e4&&d-a.time>1e4&&m.socketDumpLog(),m.pendingCalls.splice(r,1),o=!0;break}}o?0==m.pendingCalls.length&&m.dispatchEvent("messagefinish"):LOG("Unexpected msg "+JSON.stringify(e))}}},logMessage:function(e){if(m.pendingLogMessage)return m.pendingLogMessage=e,void 0;var t=(m.lastLogPacket||0)+5e3-s.now();if(0>=t){var i=navigator.userAgent.substr(navigator.userAgent.lastIndexOf(")")+2);return m.ZxcLsz({api:"room.log",error:"v3 "+i+" "+e}),m.lastLogPacket=s.now(),void 0}m.pendingLogMessage=e,setTimeout(function(){m.ZxcLsz({api:"room.log",error:m.pendingLogMessage}),m.pendingLogMessage=null,m.lastLogPacket=s.now()},t)},die:function(e){m.showAlert(e)},showAlert:function(e,t){var i={closeCallback:t,showCancel:!1};s.buildTree([r,i,["div.alert-message",e]],a.room),a.room.modal.show()},serverNow:function(){return s.now()/1e3-m.clientTimeDelta},seedPRNG:function(e){return function(){var t=e,i=9001;return{random:function(){i+4>t.length&&(t=$.sha1(t),i=0);var e=t.substr(i,4);return i+=4,(parseInt(e,16)+1)/65537}}}()}};return m}),define("page",["require","tt-base"],function(e){var t=e("tt-base");return t.Class.extend(_.extend({title:"",init:function(){this.loadingTitle=$.Deferred(),this.title&&this.loadingTitle.resolve(this.title)},cleanup:function(){this.removeSubviews()}},t.Layout),{_name:"Page"})}),define("pages/modal",["require","util","action-modal","app","page","resize"],function(e){var t=e("util"),i=e("action-modal"),n=e("app"),o=e("page"),s=e("resize"),r=o.extend({methodsToBind:["_onResizeCancel","_onNoResize"],init:function(){this._super.apply(this,arguments);var e=Array.prototype.slice.call(arguments);!this.supportsMiniplayer&&n.get("miniplayer")?(s.canResize?t.buildTree([i,{showClose:!1,clickOut:!1,submitCallback:_.bind(function(){popout.resizeToFull(),this.initModal.apply(this,e)},this),cancelCallback:this._onResizeCancel},["div.alert-message","By using this feature, you will return to the full-view."]],this):t.buildTree([i,{showClose:!1,clickOut:!1,showCancel:!1,submitCallback:this._onNoResize},["div.alert-message","To use this feature, you need to return to the full-view by making your browser window wider."]],this),this.modal.show()):this.initModal.apply(this,arguments)},_onResizeCancel:function(){this.loadingTitle.resolve(""),n.router.navigateHome(),_gaq.push(["_trackEvent","miniplayer","auto expand","false"])},_onNoResize:function(){this.loadingTitle.resolve(""),n.router.navigateHome(),_gaq.push(["_trackEvent","miniplayer","can't auto resize"])},cleanup:function(e){this.removeSubviews({transition:e&&e.modal?!0:!1})}},{_name:"ModalPage"});return r}),define("models/profile",["require","tt-base","app","store"],function(e){var t=e("tt-base"),i=e("app"),n=e("store"),o=t.Model.extend({init:function(e,t){this.userId=t.userId,this.loading=this.fetch({validate:!0}),this.userStore=n.stores.get([{name:"users"}],this),this.loading.done(_.bind(function(){this.userStore.has([{_id:this.userId}])&&(this.user=this.userStore.get([{_id:this.userId}],this),this.user.set("points",this.get("points")))},this))},parse:function(e){return _.has(e,"avatarid")&&(e.avatarId=e.avatarid,delete e.avatarid),_.has(e,"subscription_level")&&(e.subscriptionLevel=e.subscription_level,delete e.subscription_level),e},isSelf:function(){return this.userId===i.user.id},isPro:function(){return this.get("subscriptionLevel")>0},getFrontSrc:function(){var e=this.get("images");return e?e.fullfront:void 0},getUserType:function(){var e=this.get("verified"),t=this.get("acl");return e?"Verified "+e:t>1?"gatekeeper":t>0?"superuser":void 0},getTwitterUrl:function(){var e=this.get("twitter");return e?"http://twitter.com/"+e:void 0},getFacebookUrl:function(){var e=this.get("facebook");return e?"http://facebook.com/"+e:void 0},getSoundcloudUrl:function(){var e=this.get("soundcloud");return e?"http://soundcloud.com/"+e:void 0},hasLink:function(){return this.get("twitter")||this.get("facebook")||this.get("soundcloud")||this.get("website")},validate:function(e){return e.registered?void 0:"can't load guest profiles"},sync:function(e,t,i){return"create"===e||"update"===e?(i.api="user.modify_profile",i.attrs=_.clone(t.attributes),i.attrs.userid=void 0):"read"===e&&(i.api="user.get_profile_info",i.attrs={profileid:t.userId}),this._super(e,t,i)},cleanup:function(){this.user&&this.userStore.release(this.user,this),n.stores.release(this.userStore,this),this._super.apply(this,arguments)}},{_name:"Profile"});return o}),!function(e){var t=function(t,i){this.$element=e(t),this.options=e.extend({},e.fn.button.defaults,i)};t.prototype.setState=function(e){var t="disabled",i=this.$element,n=i.data(),o=i.is("input")?"val":"html";e+="Text",n.resetText||i.data("resetText",i[o]()),i[o](n[e]||this.options[e]),setTimeout(function(){"loadingText"==e?i.addClass(t).attr(t,t):i.removeClass(t).removeAttr(t)
},0)},t.prototype.toggle=function(){var e=this.$element.closest('[data-toggle="buttons-radio"]');e&&e.find(".active").removeClass("active"),this.$element.toggleClass("active")};var i=e.fn.button;e.fn.button=function(i){return this.each(function(){var n=e(this),o=n.data("button"),s="object"==typeof i&&i;o||n.data("button",o=new t(this,s)),"toggle"==i?o.toggle():i&&o.setState(i)})},e.fn.button.defaults={loadingText:"loading..."},e.fn.button.Constructor=t,e.fn.button.noConflict=function(){return e.fn.button=i,this},e(document).on("click.button.data-api","[data-toggle^=button]",function(t){var i=e(t.target);i.hasClass("btn")||(i=i.closest(".btn")),i.button("toggle")})}(window.jQuery),define("lib/bootstrap/bootstrap-button",function(){}),!function(e){function t(){e(".dropdown-backdrop").remove(),e(n).each(function(){i(e(this)).removeClass("open")})}function i(t){var i,n=t.attr("data-target");return n||(n=t.attr("href"),n=n&&/#/.test(n)&&n.replace(/.*(?=#[^\s]*$)/,"")),i=n&&e(n),i&&i.length||(i=t.parent()),i}var n="[data-toggle=dropdown]",o=function(t){var i=e(t).on("click.dropdown.data-api",this.toggle);e("html").on("click.dropdown.data-api",function(){i.parent().removeClass("open")})};o.prototype={constructor:o,toggle:function(){var n,o,s=e(this);if(!s.is(".disabled, :disabled"))return n=i(s),o=n.hasClass("open"),t(),o||("ontouchstart"in document.documentElement&&e('<div class="dropdown-backdrop"/>').insertBefore(e(this)).on("click",t),n.toggleClass("open")),s.focus(),!1},keydown:function(t){var o,s,r,a,l;if(/(38|40|27)/.test(t.keyCode)&&(o=e(this),t.preventDefault(),t.stopPropagation(),!o.is(".disabled, :disabled"))){if(r=i(o),a=r.hasClass("open"),!a||a&&27==t.keyCode)return 27==t.which&&r.find(n).focus(),o.click();s=e("[role=menu] li:not(.divider):visible a",r),s.length&&(l=s.index(s.filter(":focus")),38==t.keyCode&&l>0&&l--,40==t.keyCode&&l<s.length-1&&l++,~l||(l=0),s.eq(l).focus())}}};var s=e.fn.dropdown;e.fn.dropdown=function(t){return this.each(function(){var i=e(this),n=i.data("dropdown");n||i.data("dropdown",n=new o(this)),"string"==typeof t&&n[t].call(i)})},e.fn.dropdown.Constructor=o,e.fn.dropdown.noConflict=function(){return e.fn.dropdown=s,this},e(document).on("click.dropdown.data-api",t).on("click.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.dropdown.data-api",n,o.prototype.toggle).on("keydown.dropdown.data-api",n+", [role=menu]",o.prototype.keydown)}(window.jQuery),define("lib/bootstrap/bootstrap-dropdown",function(){}),define("views/user-with-action",["require","underscore","tt-base","app","tt-common","lib/bootstrap/bootstrap-button","lib/bootstrap/bootstrap-dropdown"],function(e){var t=e("underscore"),i=e("tt-base"),n=e("app");e("tt-common"),e("lib/bootstrap/bootstrap-button"),e("lib/bootstrap/bootstrap-dropdown");var o="Ignore User",s="Unignore User",r="Fan",a="Fanned",l=i.View.extend({events:{"click .follow-button:not(.disabled)":"onFanButtonClick","click .ignore-action":"onIgnoreClick","mouseenter .follow-button.fanned":"onFannedMouseEnter","mouseleave .follow-button.fanned":"onFannedMouseLeave"},init:function(e){this.fan=e.fan,this.parent=e.parent,this.modal=this.parent.modal;var t=this.build("userView",this.fan);this.$fanText=$(this.nodes.fanText),this.setElement(t),this.setNumFans(this.fan.fans),this.displayFan(),n.user.id===this.fan._id?this.$el.find(".tt-button").addClass("disabled"):this.$el.find(".dropdown-toggle").dropdown()},displayFan:function(){n.user.isFanof(this.fan._id)&&(this.$el.find(".follow-button").removeClass("unfanned").addClass("fanned primary").find("span").text(a),this.$el.find(".dropdown-toggle").addClass("primary")),n.user.isBlocked(this.fan._id)&&(this.$el.find("img.fan-avatar").addClass("blocked"),this.$el.find(".ignore-action").text(s))},setNumFans:function(e){this.fan.fans=e;var t=e+(1===e?" fan":" fans");this.$el.find(".num-fans").text(t)},onFanButtonClick:function(e){e.preventDefault();var i=$(e.target).closest(".fan"),o=i.find(".follow-button"),s=this.fan._id;n.user.isFanof(s)?n.user.removeFan(s).done(t.bind(function(){o.removeClass("fanned primary").addClass("unfanned").find("span").text(r),i.find("button.dropdown-toggle.primary").removeClass("primary"),this.parent.fanRemoved(s),this.setNumFans(this.fan.fans-1)},this)).fail(t.bind(function(){this.modal.showAlert("Unfanning failed.")},this)):n.user.addFan(s).done(t.bind(function(){o.addClass("primary fanned").removeClass("unfanned").find("span").text(a),i.find(".dropdown-toggle").addClass("primary"),this.parent.fanAdded(s),this.setNumFans(this.fan.fans+1)},this)).fail(t.bind(function(e){this.modal.showAlert(e.err)},this))},onIgnoreClick:function(e){e.preventDefault();var i=$(e.target).closest(".fan"),r=this.fan._id;n.user.isBlocked(r)?n.user.removeBlocked(r).done(t.bind(function(){i.find("img").removeClass("blocked"),i.find(".ignore-action").text(o)},this)).fail(function(e){this.modal.showAlert(e.err)}):n.user.addBlocked(r).done(t.bind(function(e){e.unfanned&&this.modal.showAlert(this.fan.name+" is no longer your fan","success"),i.find("img").addClass("blocked"),i.find(".ignore-action").text(s)},this)).fail(t.bind(function(e){this.modal.showAlert(e.err)},this))},onFannedMouseEnter:function(){this.$fanText.text("Unfan")},onFannedMouseLeave:function(){this.$fanText.text("Fanned")},openDropdown:function(){this.$el.find(".btn-group:not(.open) .dropdown-toggle").dropdown("toggle")},closeDropdown:function(){this.$el.find(".btn-group.open .dropdown-toggle").dropdown("toggle")}},{_name:"UserWithActionView"});return l.layouts={userView:function(e){return["div.fan",["img.fan-avatar",{src:e.image_url}],["div",["p.name",e.name],["p.stats",["span.num-fans"]," | "+e.points+" points"]],["div.btn-group",["button.btn.tt-button.follow-button.unfanned",["span##fanText",r]],["button.btn.dropdown-toggle.tt-button",{"data-toggle":"dropdown"},["span.caret"]],["ul.dropdown-menu",["li.ignore",["a.ignore-action",o]]]]]}},l}),define("views/avatar-modal",["require","underscore","util","tt-base","app","modal","tt-common","views/user-with-action"],function(e){var t=e("underscore"),i=e("util"),n=e("tt-base"),o=e("app"),s=e("modal"),r=e("tt-common"),a=e("views/user-with-action"),l=25,u=n.View.extend({events:{"click .pagination .next-page":"onNextPageClick","click .pagination .prev-page":"onPrevPageClick","submit .goto-page":"onGotoPageSubmit","click :not(.btn-group .open .dropdown-toggle)":"onNonDropdownClick"},init:function(e){this.titleString=e.titleString,this.apiString=e.apiString,this.profileid=e.profileid,this.page=1,this.avatars=[],this.togglePaginationControls=i.rateLimit(this,this.togglePaginationControls,100);var n,s,a=r.apiGet({api:this.apiString,userid:this.profileid,page_number:this._apiPageNumber()}).done(t.bind(function(e){n=e,this.numFans=n.numFans,i.buildTree(u.layouts.avatarModal(n,this.titleString,this.options.shouldRoute),this),this.setElement(this.modal.$el),this.setPageTotal(n.pages)},this));s=o.user.has("fanof")?{}:o.user.fetchFans();var l;l=o.user.has("blocked")?{}:o.user.fetchBlockedUsers(),$.when(a,s,l).done($.proxy(function(){$(window).on("resize",this.togglePaginationControls),this.showingModal=this.modal.show(),this.displayFans(n)},this))},_apiPageNumber:function(e){return e="undefined"==typeof e?this.page:e,e-1},setPageTotal:function(e){this.pageTotal=e,1===this.pageTotal?this.$el.find(".pagination").hide():this.$el.find(".pagination").first().show(),this.$el.find(".page-total").text(" of "+e)},onNextPageClick:function(){if(!(this.page>=this.pageTotal)){var e=this.page+1;r.apiGet({api:this.apiString,userid:this.profileid,page_number:this._apiPageNumber(e)}).done(t.bind(this.pageChangeCallback,this,e))}},onPrevPageClick:function(){if(!(this.page<=1)){var e=this.page-1;r.apiGet({api:this.apiString,userid:this.profileid,page_number:this._apiPageNumber(e)}).done(t.bind(this.pageChangeCallback,this,e))}},pageChangeCallback:function(e,t){this.page=e,this.setPageTotal(t.pages),this.removeAvatars(),this.$el.find(".content").scrollTop(0),this.$el.find(".current").attr("placeholder",this.page).val(""),this.displayFans(t),this.page<=1?this.$el.find(".prev-page").removeClass("enabled"):this.$el.find(".prev-page").addClass("enabled"),this.page>=this.pageTotal?this.$el.find(".next-page").removeClass("enabled"):this.$el.find(".next-page").addClass("enabled")},displayFans:function(e){for(var t=this.$el,i=[],n=0,o=e.info.length;o>n;n++){var s=e.info[n],r=new a({fan:s,parent:this});this.avatars.push(r),i.push(r.$el)}t.find(".fan-grid").append(i),this.togglePaginationControls()},togglePaginationControls:function(){if(this.pageTotal>1){var e=this.$el.find(".fan-grid + .pagination").hide();this.showingModal.done($.proxy(function(){var t=this.$el.find(".content")[0];t.offsetHeight+l<t.scrollHeight&&e.show()},this))}},onGotoPageSubmit:function(e){e.preventDefault();var i=parseInt($(e.currentTarget).find(".current").val());return t.isNaN(i)||1>i||i>this.pageTotal?(this.modal.showAlert("Please enter a number between 1 and "+this.pageTotal),void 0):(r.apiGet({api:this.apiString,userid:this.profileid,page_number:this._apiPageNumber(i)}).done(t.bind(this.pageChangeCallback,this,i)),void 0)},onNonDropdownClick:function(){t.invoke(this.avatars,"closeDropdown")},fanAdded:function(){o.user.id===this.profileid&&"Fanned"===this.titleString&&(this.numFans+=1,this.$el.find(".title").text(this.numFans+" "+this.titleString))},fanRemoved:function(){o.user.id===this.profileid&&"Fanned"===this.titleString&&(this.numFans-=1,this.$el.find(".title").text(this.numFans+" "+this.titleString))},removeAvatars:function(){t.invoke(this.avatars,"remove"),this.avatars=[]},remove:function(e){this.modal.close(e),this._super.apply(this,arguments),$(window).off("resize",this.togglePaginationControls)}},{_name:"AvatarModal"});return u.layouts={paginationControls:["div.pagination",["div.prev-page"],["form.goto-page",["span","Page "],["input.current",{placeholder:1}],["span.page-total"]],["div.next-page.enabled"]],avatarModal:function(e,t,i){return[s,{title:e.numFans+" "+t,style:{width:625},preCloseCallback:i?r.modalCloseOverride:void 0},this.paginationControls,["div.fan-grid"],this.paginationControls]}},u}),define("views/modal-wrapper",["require","tt-base"],function(e){var t=e("tt-base"),i=t.View.extend({show:function(){this.nodes.modal.show()},remove:function(e){var t=this._super;this.nodes.modal.close(e).done(_.bind(function(){t.apply(this,arguments)},this))}},{_name:"ModalWrapperView"});return i}),define("views/profile-modal",["require","rivets","app","views/avatar-modal","modal","views/modal-wrapper","sticker","tt-common"],function(e){var t=e("rivets"),i=e("app"),n=(e("views/avatar-modal"),e("modal")),o=e("views/modal-wrapper"),s=e("sticker"),r=e("tt-common"),a=o.extend({el:[n,{className:"profile",width:480},["div.profile-images",["div.avatar",{"data-rv-class-actionable":"profile:isSelf"},["img",{"data-rv-src":"profile:getFrontSrc < .images"}]],["canvas.laptop##laptop",{"data-rv-class-actionable":"profile:isSelf",width:282,height:190}]],["div.section.big",["div.name",{"data-rv-text":"profile.name"}],["div.acl",{"data-rv-text":"profile:getUserType < .verified .acl"}],["div.userid##userid",{style:{display:"none"},"data-rv-text":"profile.userid"}],["a.gold-emblem",{title:"learn more about gold",href:"/gold",target:"_blank"},["span.chrome-gold-record"],"Gold"],["div.edit",{"data-rv-show":"profile:isSelf"}]],["div.section.web-links",{"data-rv-show":"profile:hasLink < profile.twitter profile.facebook profile.soundcloud profile.website"},["div.social",["a.twitter",{target:"_blank","data-rv-show":"profile.twitter","data-rv-href":"profile:getTwitterUrl < .twitter"},["div.twitterbird"]],["a.facebook",{target:"_blank","data-rv-show":"profile.facebook","data-rv-href":"profile:getFacebookUrl < .facebook"},["div.facebooklogo"]],["a.soundcloud",{target:"_blank","data-rv-show":"profile.soundcloud","data-rv-href":"profile:getSoundcloudUrl < .soundcloud"}]],["div.website",{"data-rv-html":"profile.website | linkify"}]],["div.section",["div.joined","Joined",["div.stat-number",{"data-rv-text":"profile.created | date"}]],["div.points","DJ points",["div.stat-number",{"data-rv-text":"profile.points"}]],["div.fans","Fans",["div.stat-number",{"data-rv-class-disabled":"profile.fans | not","data-rv-text":"profile.fans"}]],["div.fanofs","Fanned",["div.stat-number",{"data-rv-class-disabled":"profile.fanofs | not","data-rv-text":"profile.fanofs"}]]],["div.section.about",{"data-rv-show":"profile.about"},["div.left","About me"],["div.right",["div.profileText",{"data-rv-html":"profile.about | messageFilter"}]]],["div.section.topartists",{"data-rv-show":"profile.topartists"},["div.left","Favorite artists"],["div.right",["div.profileText",{"data-rv-html":"profile.topartists | messageFilter"}]]],["div.section.hangout",{"data-rv-show":"profile.hangout"},["div.left","Usually hanging out in"],["div.right",["div.profileText",{"data-rv-html":"profile.hangout | messageFilter"}]]],["div.section.past-names",{"data-rv-show":"profile.pastNames"},["div.left","Past names"],["div.right",["div.profileText",{"data-rv-html":"profile.pastNames | messageFilter"}]]]],methodsToBind:["onStickerLoad"],events:{"click .avatar.actionable":"setAvatar","click .laptop.actionable":"editStickers","click .edit":"showEditModal","click .fans .stat-number:not(.disabled)":"showFansModal","click .fanofs .stat-number:not(.disabled)":"showFanofsModal","dblclick .name":"toggleUserId"},init:function(){this.rivetsView=t.bind(this.el,{profile:this.model}),this.options.shouldRoute&&(this.nodes.modal.options.preCloseCallback=r.modalCloseOverride),this.$userid=$(this.nodes.userid),$.when(this.model.loading,s.loading,r.apiGet({api:"sticker.get_placements",userid:this.model.userId})).done(this.onStickerLoad)},onStickerLoad:function(e,t,i){var n={};n[this.model.userId]=i.placements,$(document).trigger("add_sticker_placements",n);var o=this.nodes.laptop.getContext("2d"),r=this.model.get("laptop");("iphone"==r||"android"==r)&&(r="mac");try{s.drawLaptopCanvas(this.model.userId,o,.5,r)}catch(a){LOG(a)}var l=this.$el.find(".gold-emblem");l.tipsy({gravity:"s",fade:!0,opacity:1}),this.model.isPro()||l.hide()},toggleUserId:function(e){e.preventDefault(),this.$userid.toggle()},setAvatar:function(){i.router.setRoute("avatarPicker")},editStickers:function(){i.router.setRoute("stickerEdit")},showEditModal:function(){i.router.setRoute("profileEdit")},showFansModal:function(){i.router.setRoute("userFans",{userId:this.model.userId})},showFanofsModal:function(){i.router.setRoute("userFanned",{userId:this.model.userId})},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)}},{_name:"ProfileModal"});return a}),define("pages/profile",["require","app","pages/modal","models/profile","views/profile-modal"],function(e){var t=e("app"),i=e("pages/modal"),n=e("models/profile"),o=e("views/profile-modal"),s=i.extend({initModal:function(e){var i=e.userId||t.user.id,s=this.profile=new n(null,{userId:i});this.addSubview(new o({model:this.profile,shouldRoute:!0}),"profileModal"),this.profileModal.show();var r=this;s.loading.done(function(){r.loadingTitle.resolve(s.get("name")+"'s profile")})},cleanup:function(){this._super.apply(this,arguments),this.profile&&(this.profile.cleanup&&this.profile.cleanup(),this.profile=void 0)}},{_name:"ProfilePage"});return s}),define("pages/fanned",["require","pages/modal","views/avatar-modal"],function(e){var t=e("pages/modal"),i=e("views/avatar-modal"),n=t.extend({title:"Fanned",initModal:function(e){this.addSubview(new i({profileid:e.userId,apiString:"user.get_fan_of_info",titleString:"Fanned",shouldRoute:!0}))}},{_name:"FannedPage"});return n}),define("pages/fans",["require","pages/modal","views/avatar-modal"],function(e){var t=e("pages/modal"),i=e("views/avatar-modal"),n=t.extend({title:"Fans",initModal:function(e){this.addSubview(new i({profileid:e.userId,apiString:"user.get_fan_info",titleString:"Fans",shouldRoute:!0}))}},{_name:"FansPage"});return n}),define("views/report-user-modal",["require","tt-base","action-modal","app","modal","views/modal-wrapper","tt-common"],function(e){var t=(e("tt-base"),e("action-modal")),i=e("app"),n=(e("modal"),e("views/modal-wrapper")),o=e("tt-common"),s=n.extend({methodsToBind:["onSubmit"],el:function(){return[t,{title:"Report User",style:{width:480},submitCallback:this.onSubmit,submitText:"Save",preCloseCallback:this.options.shouldRoute?o.modalCloseOverride:void 0},["div.fields",{},["div.field.settings",{},["div","Why are you reporting "+(this.options.username||"this user")+"? Please give a short explanation and be as specific as you can. Keep in mind that you can't report someone for dissing your song, refusing to awesome, or playing something that's a little off genre."],["textarea#reasonField##reason.textarea",{maxlength:400,placeholder:"Please enter a reason."}]]]]},methodsToBind:["onSubmit"],onSubmit:function(){var e=$(this.nodes.reason).val();if(!e)return this.nodes.modal.showAlert("Please supply a detailed reason"),!1;var t="";return $("div.messages .message").slice(-25,-1).each(function(){t+="<div>"+$(this).html()+"</div>"}),o.apiPost({api:"room.report_user",roomid:i.room?i.room.roomId:null,reported:this.options.userId,reason:e,chatlog:t}).done(i.router.navigateHome).fail(this.onFail),!1},onFail:function(e){this.nodes.modal.showAlert(e)}},{_name:"ReportUserModal"});return s}),define("pages/report-user",["require","pages/modal","views/report-user-modal"],function(e){var t=e("pages/modal"),i=e("views/report-user-modal"),n=t.extend({title:"Report User",initModal:function(e,t){var n=this.addSubview(new i({userId:e.userId,username:t&&t.username,shouldRoute:!0}));n.show()}},{_name:"ReportUserPage"});return n}),!function(e){var t=function(t,i){this.$element=e(t),this.$indicators=this.$element.find(".carousel-indicators"),this.options=i,"hover"==this.options.pause&&this.$element.on("mouseenter",e.proxy(this.pause,this)).on("mouseleave",e.proxy(this.cycle,this))};t.prototype={cycle:function(t){return t||(this.paused=!1),this.interval&&clearInterval(this.interval),this.options.interval&&!this.paused&&(this.interval=setInterval(e.proxy(this.next,this),this.options.interval)),this},getActiveIndex:function(){return this.$active=this.$element.find(".item.active"),this.$items=this.$active.parent().children(),this.$items.index(this.$active)},to:function(t){var i=this.getActiveIndex(),n=this;if(!(t>this.$items.length-1||0>t))return this.sliding?this.$element.one("slid",function(){n.to(t)}):i==t?this.pause().cycle():this.slide(t>i?"next":"prev",e(this.$items[t]))},pause:function(t){return t||(this.paused=!0),this.$element.find(".next, .prev").length&&e.support.transition.end&&(this.$element.trigger(e.support.transition.end),this.cycle(!0)),clearInterval(this.interval),this.interval=null,this},next:function(){return this.sliding?void 0:this.slide("next")},prev:function(){return this.sliding?void 0:this.slide("prev")},slide:function(t,i){var n,o=this.$element.find(".item.active"),s=i||o[t](),r=this.interval,a="next"==t?"left":"right",l="next"==t?"first":"last",u=this;if(this.sliding=!0,r&&this.pause(),s=s.length?s:this.$element.find(".item")[l](),n=e.Event("slide",{relatedTarget:s[0],direction:a}),!s.hasClass("active")){if(this.$indicators.length&&(this.$indicators.find(".active").removeClass("active"),this.$element.one("slid",function(){var t=e(u.$indicators.children()[u.getActiveIndex()]);t&&t.addClass("active")})),e.support.transition&&this.$element.hasClass("slide")){if(this.$element.trigger(n),n.isDefaultPrevented())return;s.addClass(t),s[0].offsetWidth,o.addClass(a),s.addClass(a),this.$element.one(e.support.transition.end,function(){s.removeClass([t,a].join(" ")).addClass("active"),o.removeClass(["active",a].join(" ")),u.sliding=!1,setTimeout(function(){u.$element.trigger("slid")},0)})}else{if(this.$element.trigger(n),n.isDefaultPrevented())return;o.removeClass("active"),s.addClass("active"),this.sliding=!1,this.$element.trigger("slid")}return r&&this.cycle(),this}}};var i=e.fn.carousel;e.fn.carousel=function(i){return this.each(function(){var n=e(this),o=n.data("carousel"),s=e.extend({},e.fn.carousel.defaults,"object"==typeof i&&i),r="string"==typeof i?i:s.slide;o||n.data("carousel",o=new t(this,s)),"number"==typeof i?o.to(i):r?o[r]():s.interval&&o.pause().cycle()})},e.fn.carousel.defaults={interval:5e3,pause:"hover"},e.fn.carousel.Constructor=t,e.fn.carousel.noConflict=function(){return e.fn.carousel=i,this},e(document).on("click.carousel.data-api","[data-slide], [data-slide-to]",function(t){var i,n,o=e(this),s=e(o.attr("data-target")||(i=o.attr("href"))&&i.replace(/.*(?=#[^\s]+$)/,"")),r=e.extend({},s.data(),o.data());s.carousel(r),(n=o.attr("data-slide-to"))&&s.data("carousel").pause().to(n).cycle(),t.preventDefault()})}(window.jQuery),define("lib/bootstrap/bootstrap-carousel",function(){}),!function(e){e(function(){e.support.transition=function(){var e=function(){var e,t=document.createElement("bootstrap"),i={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(e in i)if(void 0!==t.style[e])return i[e]}();return e&&{end:e}}()})}(window.jQuery),define("lib/bootstrap/bootstrap-transition",function(){}),define("views/choose-avatar-modal",["require","rivets","app","util","modal","views/modal-wrapper","tt-common","lib/bootstrap/bootstrap-carousel","lib/bootstrap/bootstrap-transition"],function(e){var t=e("rivets"),i=e("app"),n=e("util"),o=e("modal"),s=e("views/modal-wrapper"),r=e("tt-common");e("lib/bootstrap/bootstrap-carousel"),e("lib/bootstrap/bootstrap-transition");var a=s.extend({el:[o,{preCloseCallback:r.modalCloseOverride,title:"Change Avatar","class":"new-modal choose-avatar-modal",width:700,id:"choose-avatar-modal",footer:[["a.carousel-left",{href:"#tier-carousel","data-slide":"prev"}],["a.carousel-right",{href:"#tier-carousel","data-slide":"next"}],["div.tier-data",["div.level","Level 1"],["div.points-info"]],["ol.carousel-indicators"]]},["div.header",["h2.points-msg",["span.dj-name",{"data-rv-text":"profile.name"}],", you have ",["span.dj-points",{"data-rv-text":"profile.points | commafy"}]," points."],["h4.subtitle","Earn more points to unlock new avatars!"],["div.pill-button",["div.standard-avatars","regular avatars"],["div.gold-avatars",["span.pill-lock"],"gold avatars"]]],["div.body",["div##$tierCarousel#tier-carousel.carousel.slide",["div.##$standard.carousel-inner"]],["div.##$gold.carousel-inner"],["div.go-gold-button-container",["a#go-gold-button.gold-button",{href:"/gold",target:"_blank"},"\u2605 Turn Gold to unlock \u2605"]]]],tier:function(){return["div.tier.item",["div.avatarList.grid"]]},img:function(e,t){var n=i.user.getAvatarUrl("fullfront",e),o=this.model.get("avatarId")==e;return["div.avatar.avatar-col"+(t?".available":".locked")+(o?".current-avatar":""),{data:{avatarId:e}},["div.ff-fix",["img.avatar-img"+(t?".available":""),{src:n}],t?null:["span.lock-icon"],["div.dj-name-container",["div.dj-name","DJ ",["span.bind-user-name",{"data-rv-text":"profile.name"}]]]]]},events:{"click .avatar.available":"onAvatarClick","slid #tier-carousel":"onCarouselSlid","click .carousel-indicators li":"onIndicatorClick","click .standard-avatars:not(.active), .gold-avatars:not(.active)":"onGoldToggle"},init:function(){r.apiGet({api:"user.available_avatars"}).done(_.bind(function(e){this.avatarData=this.initAvatarData(e.avatars),this.avatarsShowTiers(),this.rivetsView=t.bind(this.el,{profile:this.model}),this.nodes.modal.show()},this))},initAvatarData:function(e){for(var t={standard:[],gold:[]},i=0;i<e.length;i++){var o=e[i];if(o.pro)for(var s=0;s<o.pro.length;s++){var r=o.pro[s],a=r.colwidth||4;t.gold.push({avatars:r.avatarids,title:r.name,reqs:r.name,colwidth:a})}else{var l="Level "+(i+1),u=o.acl?"Superusers":"";o.min>0&&i<e.length-3?u=n.commafy(o.min)+" points required":i==e.length-3&&(u="Over "+n.commafy(o.min)+" Points");var a=o.colwidth||4;t.standard.push({avatars:o.avatarids,title:l,reqs:u,min:o.min,acl:o.acl,colwidth:a})}}return t},avatarsShowTiers:function(){for(var e,t=this.nodes.$standard,o=this.nodes.$gold,s=this.avatarData.standard,r=this.avatarData.gold,a=this.model,l=["div.grid-row"],u=function(t,i,o){for(var s=0;s<t.length;s++){var r=t[s],a=this.img(r,i);l.push(a),0==(s+1)%o&&(e.append(n.buildTree(l)),l=["div.grid-row"])}l.length&&(e.append(n.buildTree(l)),l=["div.grid-row"])},d=0;d<s.length;d++){var h=s[d];if(h.avatars.length){var c=n.buildTree(this.tier());e=$(c).find(".avatarList");var p=a.get("points")>=h.min,f=h.acl?a.get("acl")>=h.acl:!0;u.call(this,h.avatars,p&&f,h.colwidth),t.append(c)}}var m=i.user.isPro();for(d=0;d<r.length;d++){var h=r[d],c=n.buildTree(this.tier());e=$(c).find(".avatarList"),u.call(this,h.avatars,m,h.colwidth),o.append(c)}m&&this.$el.find(".pill-lock").hide(),this.options.showGold?this.activate("gold"):this.activate("standard")},buildIndicators:function(e){for(var t=this.$el.find(".carousel-indicators"),i=[],o=0;e>o;o++)i.push(["li"+(o?"":".active"),{"data-target":"#tier-carousel","data-slide-to":o}]);t.html(n.buildTree(i))},onCarouselSlid:function(){var e=this.nodes.$tierCarousel.find(".item.active"),t=e.parent().children().index(e);$(".carousel-indicators li").removeClass("active"),$(".carousel-indicators li:eq("+t+")").addClass("active");var i=this.avatarData[this.state][t];this.$el.find(".tier-data .level").text(i.title),this.$el.find(".tier-data .points-info").text(i.reqs)},onIndicatorClick:function(e){var t=$(e.currentTarget),i=t.parent().children().index(t);this.carousel.carousel(i)},onAvatarClick:function(e){var t=$(e.currentTarget);this.$(".avatar.current-avatar").removeClass("current-avatar"),t.closest(".avatar").addClass("current-avatar")},onGoldToggle:function(e){var t=$(e.currentTarget),i=t.hasClass("standard-avatars")?"standard":"gold";this.activate(i)},activate:function(e){this.state=e;var t="standard"==e,n=this.nodes.$gold,o=this.nodes.$standard;if(t){var s=n;n=o,o=s,this.$(".go-gold-button-container").hide(),this.$(".gold-avatars").removeClass("active"),this.$(".standard-avatars").addClass("active")}else this.$(".gold-avatars").addClass("active"),this.$(".standard-avatars").removeClass("active");o.find(".item.active").removeClass("active"),o.appendTo(this.$(".body")).hide(),n.appendTo(this.$("#tier-carousel")).show(),this.carousel=this.$el.find("#tier-carousel").carousel({interval:!1}),this.$(".tier:first").addClass("active"),this.onCarouselSlid(),this.buildIndicators(this.avatarData[e].length),t||i.user.isPro()||$(".go-gold-button-container").show()},setSelectedAvatar:function(){var e=this,t=$(".avatar.current-avatar").data("avatarId");t!=this.model.get("avatarId")&&r.apiGet({api:"user.set_avatar",avatarid:t}).done(function(){i.user.set("avatarId",t)}).fail(function(t){e.nodes.modal.showAlert("Sorry, "+t.err)})},remove:function(){this.setSelectedAvatar(),this.rivetsView.unbind(),this._super.apply(this,arguments)}},{_name:"ChooseAvatarModal"});return a}),define("pages/avatar-picker",["require","app","models/profile","pages/modal","views/choose-avatar-modal"],function(e){var t=e("app"),i=e("models/profile"),n=e("pages/modal"),o=e("views/choose-avatar-modal"),s=n.extend({title:"Change Avatar",initModal:function(e,n){var s=this,r=new i(null,{userId:t.user.id});r.loading.done(function(){var e=_.extend({model:r},_.pick(n||{},"showGold"));s.addSubview(new o(e))})}});return s}),jQuery.fn.limitMaxLength=function(e){var t=jQuery.extend({attribute:"maxlength",onLimit:function(){},onEdit:function(){}},e),i=function(){var e=jQuery(this),i=parseInt(e.attr(t.attribute));e.val().length>i&&(e.val(e.val().substr(0,i)),jQuery.proxy(t.onLimit,this)()),jQuery.proxy(t.onEdit,this)(i-e.val().length)};return this.each(i),this.keyup(i).keydown(i).focus(i)},define("jquery.maxlength",function(){}),define("settings",["require","underscore","tt-base","util","action-modal","app","facebook","tt-common","jquery.maxlength","lib/jquery.tipsy"],function(e){var t=e("underscore"),i=e("tt-base"),n=e("util"),o=e("action-modal"),s=e("app"),r=e("facebook"),a=e("tt-common");e("jquery.maxlength"),e("lib/jquery.tipsy");var l=i.View.extend({initMethodNames:["updateAvatar","checkPasswordResetToken","checkEmailVerificationToken","checkCustomAvatarUser","expiredShow"],methodsToBind:function(){return this.initMethodNames.concat(["contactSettingsShow","contactSettingsSubmit","editProfileSubmit","editProfileCancel"])},el:["ul.dropdown"],render:function(){return this.$el.append(n.buildTree(l.layouts.menuContent(this.user.logout)),this.nodes),this},init:function(e){this.user=e.user,"changed"===n.getUrlParam("prefs")?(this.oneClickUpdate=!0,s.router.navigate("account/contact",{trigger:!0})):this.oneClickUpdate=!1,this.listenTo(s,"connectTwitter",this.connectTwitter),this.listenTo(s,"connectFacebook",this.connectFacebook),this.listenTo(this.user,"change:avatarId",this.updateAvatar);var i=t.values(t.pick(this,this.initMethodNames));this.user.loading.done.apply(this,i)},updateAvatar:function(){$(".settings-head").css("background-image","url("+this.user.getAvatarUrl("headfront")+")")},expiredShow:function(){var e=window.location.href.split("?expired=");if(2==e.length){var t=e[1],i="";"email"===t?i="email verification ":"password"===t&&(i="password reset ");var o={};n.buildTree(l.layouts.expiredView(i),o),o.modal.show()}},checkPasswordResetToken:function(){var e=n.getUrlParam("reset_token");e&&s.router.setRoute("accounts",null,{resetToken:e},{replace:!0})},checkEmailVerificationToken:function(){var e=n.getUrlParam("verify_token"),t=n.getUrlParam("first")?!0:!1;e&&s.router.setRoute("accounts",null,{verifyToken:e,first:t},{replace:!0})},checkCustomAvatarUser:function(){this.user.get("custom_avatar")&&$("div.avatar-option").hide()},contactSettingsShow:function(e){a.apiGet({api:"user.get_contact_prefs"}).done(t.bind(function(t){t=t.sorted_prefs,n.buildTree(l.layouts.editContactSettings(this.contactSettingsSubmit,t,this.oneClickUpdate),this),e.shouldRoute&&(this.modal.options.preCloseCallback=a.modalCloseOverride),this.modal.show(),this.oneClickUpdate&&(this.modal.$el.find("input").click(function(){this.modal.revertAlternate()}),this.modal.showAlert("Your preferences have been saved.","success"),this.oneClickUpdate=!1)},this))},contactSettingsSubmit:function(){var e={api:"user.edit_prefs"};$("#editContactSettings").find("input").each(function(t,i){var n=i.getAttribute("name");n&&(e[n]=i.checked)});var t=this.modal;return a.apiPost(e).done(function(){s.router.navigateHome()}).fail(function(e){t.showAlert("Sorry, "+e.err)}),!1},stripDomain:function(e,t){if(!e)return"";var i=new RegExp("(http://)?(www.)?"+t+".com/");return e.replace(i,"")},editProfileShow:function(e){var i=this.user;a.apiGet({api:"user.get_profile_info",profileid:i.id}).done(t.bind(function(t){n.buildTree(l.layouts.editProfile(this.editProfileSubmit,this.editProfileCancel,e.shouldRoute),this);var i=this.modal.$el;i.find("#displayNameField").val(t.name),i.find("#twitterField").val(t.twitter),i.find("#facebookField").val(this.stripDomain(t.facebook,"facebook")),i.find("#soundcloudField").val(t.soundcloud),i.find("#websiteField").val(t.website),i.find("#aboutField").val(t.about),i.find("#aboutField").limitMaxLength(),i.find("#topArtistsField").val(t.topartists),i.find("#topArtistsField").limitMaxLength(),i.find("#hangoutField").val(t.hangout),i.find("#hangoutField").limitMaxLength(),i.find("#displayNameFieldWrapper").tipsy({className:"fieldWrapperTipsy",opacity:1,gravity:"n",fade:!0}),this.modal.show()},this))},editProfileSubmit:function(){var e=$("#displayNameField").val(),t=$("#twitterField").val(),i=$("#facebookField").val(),n=$("#soundcloudField").val(),o=$("#websiteField").val(),r=$("#aboutField").val(),l=$("#topArtistsField").val(),u=$("#hangoutField").val(),d=this.modal,h=this.user;return a.apiPost({api:"user.modify_profile",name:e,twitter:t,facebook:i,soundcloud:n,website:o,about:r,topartists:l,hangout:u}).done(function(){s.router.setRoute("profile",{userId:h.id}),h.set("name",e)
}).fail(function(e){d.showAlert("Sorry, "+e.err)}),!1},editProfileCancel:function(){return window.history.back(),!1},logout:a.logout,connectTwitter:function(e){n.setSetting("connectBannerClicked"+e,"Twitter"),n.setSetting("hideConnectError"+e,null),n.setSetting("hideConnectBanner"+e,null),window.location.href="/twitter_login/"},disconnectTwitter:function(e){var t="Please set and verify your email address and password before disconnecting your Twitter account.";!e||e.has("fbid")||!e.has("unverified_email")&&e.has("has_tt_password")?(n.setSetting("connectBannerClicked"+e.id,null),window.location.href="/twitter_unattach/"):$(".accounts-modal").data("object").showAlert(t)},connectFacebook:function(e){n.setSetting("connectBannerClicked"+e,"Facebook"),n.setSetting("hideConnectError"+e,null),n.setSetting("hideConnectBanner"+e,null),r.login()},disconnectFacebook:function(e){var t="Please set and verify your email address and password before disconnecting your Facebook account.";!e||e.has("twitterid")||!e.has("unverified_email")&&e.has("has_tt_password")?(n.setSetting("connectBannerClicked"+e.id,null),window.location.href="/facebook_unattach/"):$(".accounts-modal").data("object").showAlert(t)},remove:function(e){this.modal&&this.modal.close(e),this._super.apply(this,arguments)}},{_name:"Setting"});return l.layouts={menuContent:function(e){return[["ul",["li.option.link",["a",{href:"/export"},"Export Playlists"]],["li.option.link",["a",{href:"/profile/avatar"},"Change Avatar"]],["li.option.link",["a",{href:"/profile/stickers"},"Laptop Stickers"]],["li.option.link",["a",{href:"/profile/"+s.user.id},"Profile"]],["li.option.link",["a",{href:"/graphics"},"Graphics Settings"]],["li.option.link",["a",{href:"/account/contact"},"Contact Settings"]],["li.option.link",["a",{href:"/account/social"},"Social Settings"]],["li.option.link",["a",{href:"/account"},"Manage Account"]]],["li.logout",{event:{click:e}},"Logout"]]},editContactSettings:function(e,t,i){for(var n=function(e,t){var i=["input",{type:"checkbox",name:e,id:"pref-"+e}];return t&&(i[1].checked="checked"),i},s=["form#editContactSettings"],r=0,a=t.length;a>r;r++){var l=t[r],u=l[0],d=l[1],h=l[3];s.push(["div.left",n(u,d)],["div.right",["label.contactSetting",{"for":"pref-"+u}," "+h]])}return[o,{title:"Edit Contact Settings",submitCallback:e,submitText:"Save",showAlternate:i},["div.field",s]]},editProfile:function(e,t,i){return[o,{title:"Edit Profile",style:{width:480},cancelCallback:t,submitCallback:e,preCloseCallback:i?a.modalCloseOverride:void 0,submitText:"Save"},["div.fields",{},["div.field.settings",{},["div#displayNameFieldWrapper",{title:"Can't be changed more than once every seven days"},["div",{},"Display Name:"],["input#displayNameField.text.name"]],["div","Other profiles:"],["div","twitter.com/",["input#twitterField.text.twitter",{maxlength:15}]],["div","facebook.com/",["input#facebookField.text.facebook"]],["div","soundcloud.com/",["input#soundcloudField.text.soundcloud"]],["div",{},"Website:"],["input#websiteField.text.website"],["div",{},"Write something about yourself:"],["textarea#aboutField.textarea",{maxlength:400}],["div",{},"Got some favorite artists?"],["textarea#topArtistsField.textarea",{maxlength:400}],["div",{},"Where do you usually hang out on turntable?"],["textarea#hangoutField.textarea",{maxlength:400}]]]]},expiredView:function(e){return[o,{id:"link-expired-modal",showClose:!1,clickOut:!1,showCancel:!1,submitCallback:this.close,style:{width:480}},["h2","This "+e+"link has expired. Please contact ",["a",{href:"mailto:help@turntable.fm"},"help@turntable.fm"],"."]]}},l}),define("pages/profile-edit",["require","app","pages/modal","settings"],function(e){var t=e("app"),i=e("pages/modal"),n=e("settings"),o=i.extend({title:"Edit Profile",initModal:function(){this.addSubview(new n({user:t.user}),"settings"),this.settings.editProfileShow({shouldRoute:!0})}},{_name:"ProfileEditPage"});return o}),define("pages/sticker-edit",["require","pages/modal","page","sticker"],function(e){var t=e("pages/modal"),i=e("page"),n=e("sticker"),o=i.extend({title:"Edit Laptop Stickers",methodsToBind:["_onResizeCancel"],init:t.prototype.init,_onResizeCancel:t.prototype._onResizeCancel,initModal:function(){n.showEditor({shouldRoute:!0})},cleanup:function(e){n.modal&&n.modal.close({transition:e.modal?!0:!1})}},{_name:"StickerEditPage"});return o}),define("views/gold-account",["require","app","util","tt-base"],function(e){var t=e("app"),i=e("util"),n=e("tt-base");return n.View.extend({el:function(){return["div.subscription-info.box",["div.account-fields",["div.account-field",["h3","Account type"],["div.field-content.account-type","Gold"]],["div.account-field.payment-method",["h3","Payment method"],["div.field-content.card-number",this.options.user.getCardNumber()],["div.field-content.change-method-container",["a.change",{href:"#"},"change method"]],["div.field-content.cancel-gold-container",["a.cancel",{href:"#"},"cancel turntable gold"]],["div.field-content.reactivate-gold-container",["a.reactivate",{href:"#"},"reactivate turntable gold"]]]]]},events:{"click .change":"onClickChange","click .cancel":"onClickCancel","click .reactivate":"onClickReactivate"},init:function(){var e=this;$.when(this.options.user.getSubscription()).done(function(t){var n=t.subscription;"pendcancel"==n.state&&(e.$el.find(".change-method-container").hide(),e.$el.find(".cancel-gold-container").hide(),e.$el.find(".reactivate-gold-container").show(),e.$el.find(".account-type").text("Gold until "+i.prettierDate(n.period_end))),n.state||e.$el.find(".payment-method").hide()})},onClickChange:function(e){e.preventDefault(),t.router.setRoute("payment")},onClickCancel:function(e){e.preventDefault(),t.router.setRoute("cancelGold")},onClickReactivate:function(e){e.preventDefault(),t.router.setRoute("reactivateGold")}})}),define("validated-form",["require","tt-base"],function(e){var t=e("tt-base"),i=t.View.extend({options:{validator:null,groupValidatorWith:null,width:null,showIcon:!0,defaultValue:null,label:null},el:function(){var e,t={name:this.options.name,placeholder:this.options.placeholder,required:this.options.required,type:this.options.type,value:this.options.defaultValue,autofocus:this.options.autofocus,maxlength:this.options.maxlength};if(this.options.label){var i=this.options.name+"-input";_.extend(t,{id:i}),e=["label",{"for":i},this.options.label]}return["div.validated-input",e,["input",t],["div.validation"]]},init:function(){$.data(this.el,"object",this),this.validate=_.bind(this.validate,this),this.$input=this.$el.find("input"),this.$validation=this.$el.find(".validation"),this.options.showIcon||this.$validation.css("display","none"),this.options.validator&&this.$input.on("keyup change",this.validate)},resize:function(){var e=this.$input.width();this.$input.css({width:e-18,"padding-right":30})},validate:function(e){if((!e||9!=e.keyCode&&16!=e.keyCode)&&this.options.validator){var t=[this.$input.val()],i=this.options.groupValidatorWith;if(i){if(_.isArray(i)||(i=[i]),!this.$groupValidatorWith){var n=this.$el.closest("form");this.$groupValidatorWith=_.map(i,function(e){return n.find('[name="'+e+'"]')})}_.each(this.$groupValidatorWith,function(e){t.push(e.val())})}var o=this.options.validator.apply(null,t);return o.pending?$.noop():o.valid?($().add.apply(this.$input,this.$groupValidatorWith).addClass("valid").removeClass("invalid"),this.options.showIcon&&this.$validation.addClass("valid").removeClass("invalid")):($().add.apply(this.$input,this.$groupValidatorWith).addClass("invalid").removeClass("valid"),this.options.showIcon&&this.$validation.addClass("invalid").removeClass("valid")),o}}},{_name:"ValidatedInput"}),n=t.View.extend({el:function(){return["form",t.View.Children]},events:{submit:"validate"},validate:function(e){var t=null;return this.$el.find(".validated-input").each(function(){var e=$.data(this,"object");if(e.$input.attr("required")){var i=e.validate();i&&!i.valid&&(t=i)}}),t?(this.$el.trigger("ValidatedForm:invalid",t),e.stopImmediatePropagation(),e.preventDefault(),t):{valid:!0}}},{_name:"ValidatedForm"});return{Form:n,Input:i}}),define("views/input-layouts",["require","util","validated-form"],function(e){var t=e("util"),i=e("validated-form"),n=function(e){return[i.Input,e]},o=function(e){return""===e?{valid:!1,err:"Your DJ name can't be blank"}:e.match(/[\s\xA0]{2,}/)?{valid:!1,err:"Your DJ name can't have multiple adjacent spaces"}:e.length>20?{valid:!1,err:"Your DJ name is too long! Keep it under 20 characters"}:e.match(/[^A-Za-z0-9!@#$%^&*()+=_\[\]{}~|;:\'"<>,.?\/\\ -]/)?{valid:!1,err:"Your DJ name can't have special characters"}:{valid:!0}};return{inputLayout:n,djNameValidator:o,nameInput:function(e){var t={idd:"nameInput",name:"name",type:"text",placeholder:"DJ name",required:"required",validator:o};return n(_.extend(t,e))},emailInput:function(e){var i={idd:"emailInput",name:"email",type:"email",placeholder:"email address",required:"required",invalidMessage:"Please enter a valid email address",validator:t.validators.email};return n(_.extend(i,e))},passwordInput:function(e){var i={idd:"passwordInput",name:"password",type:"password",placeholder:"password",required:"required",invalidMessage:"Your password must be at least 6 characters",validator:t.validators.password};return n(_.extend(i,e))}}}),define("views/standard-account",["require","tt-base","app"],function(e){var t=e("tt-base");return e("app"),t.View.extend({el:["div.subscription-info.box",["div.account-fields",["div.account-field",["h3","Account type"],["div.account-type","Standard"]],["div.account-field",["h3","Upgrade"],["button.gold-button.turn-gold","\u2605 Turn Gold \u2605"]]]],events:{"click .turn-gold":"onClickGold"},onClickGold:function(){window.location.href="/gold"}})}),define("views/manage-accounts",["require","rivets","views/gold-account","views/input-layouts","modal","views/modal-wrapper","views/standard-account","validated-form","tt-common"],function(e){var t=e("rivets"),i=e("views/gold-account"),n=e("views/input-layouts"),o=e("modal"),s=e("views/modal-wrapper"),r=e("views/standard-account"),a=e("validated-form"),l=e("tt-common"),u=!1,d=s.extend(n).extend({el:[o,{preCloseCallback:l.modalCloseOverride,title:"Manage Accounts",style:{width:520},"class":"accounts-modal new-modal"},["h3","Manage your subscription type and sign in details"],["div#box-container##$account"]],events:{"click .change-password":"onChangePasswordClick","click .forgot-password":"onForgotPasswordClick","click .change-email":"onChangeEmailClick","click .resend-email":"onResendEmailClick","click .cancelAndReplace":"onCancelAndReplace","click .forgotPasswordLink":"onForgotPasswordClick","click .sendPassword":"onForgotPasswordSend","submit #change-password":"onChangePasswordSubmit","submit #change-email":"onChangeEmailSubmit","submit #set-email-password":"onSetEmailPasswordSubmit"},init:function(e){var i=this.user=e.user;$.when(i.fetchInfo(),i.fetchCard(),i.fetchSubscription()).done(_.bind(function(){this.initAccount(),this.rivetsView=t.bind(this.el,{user:i}),this.nodes.modal.show(),this.options.verifyToken&&!u&&this.checkVerifyToken(this.options.verifyToken)},this))},initAccount:function(){var e;this.options.resetToken&&(e="password");var t=[this._accountLayout(e),this.subscriptionLayout()];this.nodes.$account.append(util.buildTree(t,this.nodes))},subscriptionLayout:function(){var e=this.user;return e.isPro()?[i,{user:e}]:[r]},checkVerifyToken:function(e){u=!0;var t=this.options.first,i={api:"user.change_email",verify_token:e};return this.replaceWithSpinner("form[name=ttAccount]"),l.apiGet(i,!0).done(_.bind(function(){_gaq.push(["_trackEvent","user","verified",t.toString()]),this.user.verifyEmail(),t?this.flash("Your email and password have been saved!"):this.flash("Successfully changed your email!")},this)).fail(_.bind(function(e){this.flash(e.err+".","error")},this)).always(_.bind(function(){this.replaceAccountWith(this._accountLayout())},this))},replaceAccountWith:function(e){this.$el.find(".account-info").replaceWith(util.buildTree(e,this.nodes)),this.rivetsView=t.bind(this.el,{user:this.user})},replaceWithSpinner:function(e){$(e).replaceWith(util.buildTree(["div.account-loading"," "])),util.makeSpinner($(".account-loading")[0])},flash:function(e,t){t=t?t:"success",this.nodes.modal.showAlert(e,t)},onChangePasswordSubmit:function(){var e={api:"user.change_password",password:this.$el.find("input[name=new-password]").val()};return this.$el.find("input[name=reset-token]").length?e.reset_token=this.$el.find("input[name=reset-token]").val():e.old_password=this.$el.find("input[name=old-password]").val(),this.replaceWithSpinner("#change-password"),l.apiGet(e,this).done(_.bind(function(){this.user.passwordChanged(),this.replaceAccountWith(this._accountLayout()),this.flash("Successfully changed your password.")},this)).fail(_.bind(function(e){this.replaceAccountWith(this._accountLayout("password")),this.flash(e.err+".","error")},this)),!1},onChangeEmailSubmit:function(e){e.preventDefault();var t=this.nodes.emailInput.$input.val(),i=this.nodes.passwordInput.$input.val(),n={api:"user.change_email",email:t,password:i};return this.replaceWithSpinner("#change-email"),l.apiGet(n,!0).done(_.bind(function(e){this.user.setUnverifiedEmail(t),this.replaceAccountWith(this._accountLayout()),this.flash(e.notice+".")},this)).fail(_.bind(function(e){this.replaceAccountWith(this._accountLayout("email")),this.flash(e.err+".","error")},this)),!1},onSetEmailPasswordSubmit:function(e){e.preventDefault();var t={api:"user.set_email_password",email:this.$el.find("input[name=email]").val(),password:this.$el.find("input[name=password]").val()};return this.replaceWithSpinner("form[name=ttAccount]"),l.apiGet(t,!0).done(_.bind(function(e){this.user.setUnverifiedEmail(t.email);var i=e.notice||"Successfully updated your email and password! Thanks!";this.replaceAccountWith(this._accountLayout()),this.flash(i)},this)).fail(_.bind(function(e){this.replaceAccountWith(this._setEmailPasswordLayout()),this.flash(e.err+".","error")},this)),!1},onCancelAndReplace:function(e){e.preventDefault(),this.replaceAccountWith(this._accountLayout())},onForgotPasswordSend:function(){return this.replaceWithSpinner(".forgot-password-container"),l.apiPost({api:"user.forgot_password",email:this.user.get("email")},!0).done(_.bind(function(){this.flash("Successfully sent your password reset link.  Please check your email.")},this)).fail(_.bind(function(e){this.flash(e.err+".","error")},this)).always(_.bind(function(){this.replaceAccountWith(this._accountLayout())},this)),!1},onResendEmailClick:function(e){e.preventDefault();var t={api:"user.reverify_email",email:this.user.get("unverified_email")};return this.replaceWithSpinner(".account-fields.verify-email"),l.apiGet(t,!0).done(_.bind(function(e){this.flash(e.notice+".")},this)).fail(_.bind(function(e){this.flash(e.err+".","error")},this)).always(_.bind(function(){this.replaceAccountWith(this._accountLayout())},this)),!1},onForgotPasswordClick:function(e){e.preventDefault(),this.replaceAccountWith(["div.account-info.box",this._forgotPasswordLayout],this.nodes)},onChangePasswordClick:function(e){e.preventDefault(),this.replaceAccountWith(this._accountLayout("password"))},onChangeEmailClick:function(e){e.preventDefault(),this.replaceAccountWith(this._accountLayout("email"))},_accountLayout:function(e){var t=["div.account-info.box"],i=this.user,n=i.has("unverified_email"),o=i.has("has_tt_password"),s=[];return s=n||o?"password"==e?this._changePasswordLayout():"email"==e?this._changeEmailLayout():i.has("unverified_email")?this._verifyEmailLayout():this._defaultAccountLayout():this._setEmailPasswordLayout(),t.push(s),t},_accountFieldLayout:function(e){var t=["div.account-field"];return e&&t.push(["h3.label",e]),_.reduce(_.rest(arguments),function(e,t){return e.push(["div.field-content",t]),e},t)},_changeEmailLink:["div",["a.change-email",{href:"#"},"change email"]],_resendEmailLink:["div",["a.resend-email",{href:"#"},"resend email"]],_changePasswordLink:["div",["a.change-password",{href:"#"},"change password"]],_forgotPasswordLink:["div",["a.forgot-password",{href:"#"},"forgot password?"]],_defaultAccountLayout:function(){var e=this._accountFieldLayout,t=this.user.get("email");return["div.account-fields",e("Email",t,this._changeEmailLink),e("Password","\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",this._changePasswordLink,this._forgotPasswordLink)]},_verifyEmailLayout:function(){var e=this._accountFieldLayout;return["div.account-fields.verify-email",e("Unverified Email",["div",{"data-rv-text":"user.unverified_email"}],this._resendEmailLink,this._changeEmailLink)]},_forgotPasswordLayout:["div.account-fields.forgot-password-container",["div.message",["p","Forgot your Turntable password?"],["p","Click Send and we'll email a password reset link to ",["span",{"data-rv-text":"user.email"}]]],["div.account-buttons",["button.gold-button.sendPassword","Send"],["button.gray-button.cancelAndReplace","Cancel"]]],_changePasswordLayout:function(){var e,t=this.options.resetToken,i=this._accountFieldLayout;e=t?["input",{type:"hidden",value:t,name:"reset-token"}]:this.passwordInput({idd:null,name:"old-password",label:"Old password: ",placeholder:null,showIcon:!1,autofocus:"autofocus"});var n=[a.Form,{action:"#",method:"post",id:"change-password"},i("Email: ",this.user.get("email")),e,this.passwordInput({idd:null,name:"new-password",label:"New password: ",placeholder:null,showIcon:!1}),["div.account-buttons",["button.gold-button",{type:"submit"},"Save"],["button.gray-button.cancelAndReplace","Cancel"]]];return n},_changeEmailLayout:function(){return[a.Form,{action:"#",method:"post",id:"change-email"},this.emailInput({showIcon:!1,label:"New email: ",placeholder:null,autofocus:"autofocus"}),this.passwordInput({showIcon:!1,label:"Password: ",placeholder:null}),["div.account-buttons",["button.gold-button.submit",{type:"submit"},"Save"],["button.gray-button.cancel.cancelAndReplace","Cancel"]]]},_setEmailPasswordLayout:function(){var e=this.user,t=e.get("email")||"",i=this._accountInputLayout,n=["div.account-buttons",["button.submit",{type:"submit"},"Save"]];return e.has("unverified_email")&&n.push(["button.cancel.cancelAndReplace","Cancel"]),["form#set-email-password",{action:"#",method:"post",name:"ttAccount"},i(util.validators.email,"email","Email",t),i(util.validators.password,"password","Password"),i(util.validators.makePasswordConfirm("input[name=password]"),"confirmpassword","Confirm"),n]},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)}},{_name:"ManageAccountsModal"});return d}),define("pages/accounts",["require","app","pages/modal","views/manage-accounts"],function(e){var t=e("app"),i=e("pages/modal"),n=e("views/manage-accounts"),o=i.extend({title:"Manage Accounts",initModal:function(e,i){t.user.loading.done(_.bind(function(){var e=_.extend({user:t.user},_.pick(i||{},"resetToken","verifyToken","first"));this.addSubview(new n(e))},this))}},{_name:"AccountsPage"});return o}),define("views/credit-card",["require","app","stripe","tt-base","util","validated-form"],function(e){var t=e("app"),i=e("stripe"),n=e("tt-base"),o=e("util"),s=e("validated-form"),r=IMG_PATH+"payment/",a={Visa:r+"visa.png","American Express":r+"amex.png",MasterCard:r+"mastercard.png",Discover:r+"discover.png","Diners Club":r+"dinersclub.png",JCB:r+"jcb.png"},l=n.View.extend({options:{idd:"creditCard"},init:function(e){if(this.useSavedCard=!1,e&&e.fetchCard){var i=this,n=o.makeSpinner(this.el,{top:57,left:148});$.when(t.user.getCard()).done(function(e){n.stop(),_.has(e,"card")&&i.setSavedCard(e.card)})}},events:{'keyup input[name="card-number"]':"onNumberChange",'change input[name="card-number"]':"onNumberChange","click input":"onCardChange","keydown input":"onCardChange"},getInfo:function(){return this.useSavedCard?null:{number:this.$('input[name="card-number"]').val(),exp_year:this.$('input[name="expiration-year"]').val(),exp_month:this.$('input[name="expiration-month"]').val(),cvc:this.$('input[name="cvc"]').val(),address_zip:this.$('input[name="zipcode"]').val()}},onNumberChange:function(e){var t=$(e.currentTarget).val();return i.card.validateCardNumber(t)?(this.displayCardType(i.card.cardType(t)),void 0):(this.clearCardType(),void 0)},onCardChange:function(){this.useSavedCard&&this.clearSavedCard()},setSavedCard:function(e){this.useSavedCard=!0,this.$("input").attr("required",!1),this.updateForm(e)},updateForm:function(e){this.$('input[name="card-number"]').val("xxxx xxxx xxxx "+e.last_four),this.$('input[name="expiration-month"]').val(e.exp_month),this.$('input[name="expiration-year"]').val(e.exp_year),this.$('input[name="zipcode"]').val(e.address_zip),this.displayCardType(e.type)},clearSavedCard:function(){this.useSavedCard=!1,this.$("input").attr("required","required").val(""),this.clearCardType()},clearCardType:function(){this.$("#card-image").hide()},displayCardType:function(e){var t;console.log(e),(t=a[e])?this.$("#card-image").attr("src",t).show():this.$("#card-image").hide()},el:function(){return["div#card.box",["div.card-content",["div.desc","Payment details"],["img#card-image"],[s.Input,{name:"card-number",label:"Card number",required:"required",invalidMessage:"Please enter a valid credit card number",maxlength:19,validator:u,showIcon:!1}],["img.lock",{src:IMG_PATH+"payment/lock.png"}],[s.Input,{name:"expiration-month",required:"required",label:"Expires",maxlength:2,validator:c,showIcon:!1,groupValidatorWith:"expiration-year"}],[s.Input,{name:"expiration-year",required:"required",maxlength:4,validator:p,showIcon:!1,groupValidatorWith:"expiration-month"}],[s.Input,{name:"cvc",label:"CVC",required:"required",maxlength:4,validator:d,showIcon:!1}],["img.question",{src:IMG_PATH+"payment/question.png"}],[s.Input,{name:"zipcode",label:"Zip Code",required:"required",maxlength:5,validator:f,showIcon:!1}]]]}},{_name:"CreditCard"}),u=function(e){return i.card.validateCardNumber(e)?{valid:!0}:{valid:!1,err:"Please enter a valid credit card number"}},d=function(e){return i.card.validateCVC(e)?{valid:!0}:{valid:!1,err:"Please enter a valid CVC"}},h=function(e,t){return t&&2==t.length&&(t="20".concat(t)),i.card.validateExpiry(e,t)?{valid:!0}:{valid:!1,err:"Please enter a valid date"}},c=h,p=function(e,t){return h(t,e)},f=function(e){return/\d{5}/.test(e)?{valid:!0}:{valid:!1,err:"Please enter a valid ZIP code"}};return l}),define("views/credit-card-modal",["require","app","views/credit-card","modal","views/modal-wrapper","tt-common","util","validated-form"],function(e){var t=e("app"),i=e("views/credit-card"),n=e("modal"),o=e("views/modal-wrapper"),s=e("tt-common"),r=e("util"),a=e("validated-form"),l=o.extend({el:function(){return[n,{preCloseCallback:s.modalCloseOverride,title:"Update Credit Card",id:"credit-card-modal","class":"new-modal",width:520},[a.Form,i,["div.buttons.clear",["button.cancel.gray-button",{type:"button"},"Cancel"],["button.submit.gold-button",{type:"submit"},"Save"]]]]},events:{"submit form":"onSubmit","click .cancel":"onCancel"},onSubmit:function(e){e.preventDefault();var i=this.nodes.creditCard.getInfo(),n=this,o=this.nodes.creditCard;o.$(".card-content").hide();var s=r.makeSpinner(o.el);t.user.createCCToken(i).done(function(){s.stop(),t.router.setRoute("accounts",null,{alert:"Credit card informaiton successfully updated!"})}).fail(function(e){n.nodes.modal.showAlert(e.err)})},onCancel:function(e){e.preventDefault(),t.router.setRoute("accounts")}},{_name:"CreditCardModal"});return l}),define("pages/payment",["require","views/credit-card-modal","pages/modal"],function(e){var t=e("views/credit-card-modal"),i=e("pages/modal");return i.extend({title:"Update Credit Card",initModal:function(){var e=this.addSubview(new t);e.show()}},{_name:"PaymentPage"})}),define("views/cancel-gold-modal",["require","app","modal","views/modal-wrapper","tt-common","util"],function(e){var t=e("app"),i=e("modal"),n=e("views/modal-wrapper"),o=e("tt-common"),s=e("util");return n.extend({el:function(){return[i,{preCloseCallback:o.modalCloseOverride,title:"Oh no! I hope it wasn't something we said...","class":"new-modal cancel-gold-modal",width:520},["img",{src:IMG_PATH+"payment/cancel-avatar-temp.png"}],["div.body##body",["p","Turntable gold is constantly improving, so you'll be missing out on new features every month."],["p","No worries though, we'll be here if you decide to Turn Gold again!"]],["div.buttons",["button.stay-gold.gray-button","Stay Gold"],["button.cancel.gold-button","Cancel Gold"]]]},events:{"click .stay-gold":"onStayGold","click .cancel":"onCancel"},onStayGold:function(){t.router.setRoute("accounts")},onCancel:function(){var e=s.makeSpinner(this.nodes.body),i=this;t.user.cancelSubscription().done(function(){t.router.setRoute("accounts",null,{alert:"Turntable Gold canceled."})}).fail(function(e){i.nodes.modal.showAlert(e.err)}).always(function(){e.stop()})}},{_name:"CancelGoldModal"})}),define("pages/cancel-gold",["require","app","views/cancel-gold-modal","pages/modal"],function(e){var t=e("app"),i=e("views/cancel-gold-modal"),n=e("pages/modal");return n.extend({title:"Cancel Subscription",initModal:function(){var e=this;t.user.loading.done(function(){if(!t.user.isPro())return t.router.navigateHome(),void 0;var n=e.addSubview(new i);n.show()})}},{_name:"CancelGoldPage"})}),define("views/reactivate-gold-modal",["require","app","modal","views/modal-wrapper","tt-common","util"],function(e){var t=e("app"),i=e("modal"),n=e("views/modal-wrapper"),o=e("tt-common"),s=e("util");return n.extend({el:function(){return[i,{preCloseCallback:o.modalCloseOverride,title:"Welcome back!","class":"new-modal reactivate-gold-modal",width:520},["div.body##body",["p","Turntable gold is constantly improving, so you won't regret your change of heart!"]],["div.buttons",["button.stay-canceled.gray-button","Go Back"],["button.reactivate.gold-button","Turn Gold"]]]},events:{"click .stay-canceled":"onStayCanceled","click .reactivate":"onReactivate"},onStayCanceled:function(){t.router.setRoute("accounts")},onReactivate:function(){var e=s.makeSpinner(this.nodes.body),i=this;t.user.reactivateSubscription().done(function(){t.router.setRoute("accounts",null,{alert:"Turntable Gold reactivated."})}).fail(function(e){i.nodes.modal.showAlert(e.err)}).always(function(){e.stop()})}},{_name:"ReactivateGoldModal"})}),define("pages/reactivate-gold",["require","app","views/reactivate-gold-modal","pages/modal"],function(e){var t=e("app"),i=e("views/reactivate-gold-modal"),n=e("pages/modal");return n.extend({title:"Reactivate Subscription",initModal:function(){var e=this;t.user.loading.done(function(){if(!t.user.isPro())return t.router.navigateHome(),void 0;var n=e.addSubview(new i);n.show()})}},{_name:"ReactivateGoldPage"})}),define("views/manage-social",["require","rivets","facebook","app","modal","views/modal-wrapper","tt-common"],function(e){var t=e("rivets"),i=e("facebook"),n=e("app"),o=e("modal"),s=e("views/modal-wrapper"),r=e("tt-common"),a="We never post to your newsfeed or tweet unless you explicitly tell us to",l="https://graph.facebook.com/",u="Please set and verify your email address and password",d=u+" before disconnecting your Twitter account.",h=u+" before disconnecting your Facebook account.",c=s.extend({el:[o,{preCloseCallback:r.modalCloseOverride,className:"socialModal",title:"Social",style:{width:400}},["div.socialFinePrint",a],["div#facebookAccountInfo",["div.connected",["img.connectedImg",{"data-rv-src":"user.facebookProfileImg"}],["div.connectedAccountText","Facebook Connected"],["a.disconnectAccount#disconnectFacebook","Disconnect Facebook account"]],["div.disconnected","Find more friends, connect to Facebook!",["div.socialButton.facebookButton#connectFacebook"]]],["div.separator"],["div#twitterAccountInfo",["div.connected",["img.connectedImg",{"data-rv-src":"user.twitter_profile_image"}],["div.connectedAccountText","Twitter Connected"],["a.disconnectAccount#disconnectTwitter","Disconnect Twitter account"]],["div.disconnected","Find more friends, connect to Twitter!",["div.socialButton.twitterButton#connectTwitter"]]]],events:{"click #connectFacebook":"connectFacebook","click #connectTwitter":"connectTwitter","click #disconnectFacebook":"disconnectFacebook","click #disconnectTwitter":"disconnectTwitter"},init:function(){var e=this.nodes.modal;e.options.closeCallback=_.bind(this.remove,this),this.initSocial(),this.rivetsView=t.bind(this.el,{user:this.model}),n.user.loading.done(function(){e.show()})},initSocial:function(){var e="#twitterAccountInfo .disconnected",t="#facebookAccountInfo .disconnected",i=this.model;i.has("twitterid")&&(e="#twitterAccountInfo .connected"),i.has("fbid")&&(i.set("facebookProfileImg",l+i.get("fbid")+"/picture"),t="#facebookAccountInfo .connected"),this.$el.find(e).show(),this.$el.find(t).show()},flash:function(e,t){t=t?t:"success",this.nodes.modal.showAlert(e,t)},connectFacebook:function(){util.setSetting("connectBannerClicked"+n.user.id,"Facebook"),util.setSetting("hideConnectError"+n.user.id,null),util.setSetting("hideConnectBanner"+n.user.id,null),i.login()},connectTwitter:function(){util.setSetting("connectBannerClicked"+n.user.id,"Twitter"),util.setSetting("hideConnectError"+n.user.id,null),util.setSetting("hideConnectBanner"+n.user.id,null),window.location.href="/twitter_login/"},disconnectFacebook:function(){var e=this.model,t=e.has("unverified_email"),i=!e.has("has_tt_password");e.has("twitterid")||!t&&!i?(util.setSetting("connectBannerClicked"+e.id,null),window.location.href="/facebook_unattach/"):this.flash(h,"error")},disconnectTwitter:function(){var e=this.model,t=e.has("unverified_email"),i=!e.has("has_tt_password");e.has("fbid")||!t&&!i?(util.setSetting("connectBannerClicked"+e.id,null),window.location.href="/twitter_unattach/"):this.flash(d,"error")},remove:function(){this.rivetsView.unbind(),this._super.apply(this,arguments)}},{_name:"ManageSocialModal"});return c}),define("pages/social-settings",["require","app","pages/modal","views/manage-social"],function(e){var t=e("app"),i=e("pages/modal"),n=e("views/manage-social"),o=i.extend({title:"Manage Social",initModal:function(){t.user.loading.done(_.bind(function(){this.addSubview(new n({model:t.user}))},this))}},{_name:"SocialPage"});return o}),define("pages/contact-settings",["require","app","pages/modal","settings"],function(e){var t=e("app"),i=e("pages/modal"),n=e("settings"),o=i.extend({title:"Contact Settings",initModal:function(){this.addSubview(new n({user:t.user}),"settings"),this.settings.contactSettingsShow({shouldRoute:!0})}},{_name:"ContactSettingsPage"});return o}),define("pages/ignore",["require","util","app","modal","pages/modal","page","tt-common"],function(e){var t=e("util"),i=e("app"),n=e("modal"),o=e("pages/modal"),s=e("page"),r=e("tt-common"),a=s.extend({title:"Ignore Users",methodsToBind:["_onResizeCancel"],init:o.prototype.init,_onResizeCancel:o.prototype._onResizeCancel,initModal:function(e,n){n=n||{},t.buildTree(l,this),this.modal.show();var o=this,s=function(e,n){if(!($("#ignored-"+e).length>0)){var o=function(){var e=$(this).parent();return i.user.removeBlocked(e.attr("id").split("-")[1]).done(function(){e.hide("slow",function(){$(this).remove()})}).fail(function(){$("#addIgnoreFieldError").html("An error occurred when removing the user").show("slow")}),!1},s=t.buildTree(["li#ignored-"+e+".ignored",{},["a.remove",{event:{click:o}}],["span.name",{},void 0===n?"Loading...":n]]);return void 0===n&&r.apiGet({api:"user.get_profile_info",profileid:e}).done(function(t){$("#ignored-"+e+" span.name").html(t.name)}),s}};i.user.fetchBlockedUsers().done(function(e){$.each(e.blocks,function(){var e=this.block;$("ul#ignoredUsers").append(s(e.blockedid,e.blocked.username))})});var a="Enter a username...";$("div.addIgnore input").val(a).addClass("default"),$("div.addIgnore input").focus(function(){$(this).val()==a&&$(this).val("").removeClass("default")}),$("div.addIgnore input").keyup(function(e){13==e.keyCode&&$("div.addIgnore button").click()}),$("div.addIgnore input").focus(function(){setTimeout(function(){$("#addIgnoreFieldError").hide("slow")
},1e3)}),$("div.addIgnore button").click(function(){var e=$("#addIgnoreField").val();$.trim(e).length>0&&r.apiGet({api:"user.get_id",name:e}).done(function(e){i.user.addBlocked(e.userid).done(function(){$("ul#ignoredUsers").append(s(e.userid)),$("#ignored-"+e.userid).hide().show("slow"),$("#addIgnoreField").val("")}).fail(function(e){o.modal.showAlert(e.err)})}).fail(function(e){o.modal.showAlert(e.err)})}),$("#addIgnoreField").length&&($("#addIgnoreField").focus()[0].value=n.ignoreName||"")},cleanup:function(e){this._super.apply(this,arguments),this.modal&&this.modal.close({transition:e.modal?!0:!1})}},{_name:"IgnorePage"}),l=[n,{title:"Ignored Users",className:"ignoreModal",preCloseCallback:r.modalCloseOverride},["div.field",["div.ignoredDescription","Someone bothering you? Add a user to this list to block their incoming chat messages."],["div.addIgnore",["input#addIgnoreField",{size:"15"}],["button.tt-button.primary",{},"Add user"],["div#addIgnoreFieldError",{}]],["ul#ignoredUsers",{}]]];return a}),define("account-modal-mixin",["require","app","facebook","tt-common"],function(e){var t=e("app"),i=e("facebook"),n=e("tt-common"),o={setAuthenticationCookies:function(e){var t="https://"+window.location.host+"/email_login/";return e=n.prepApiData(e||{}),n.crossDomainAjaxRequest({url:t,type:"POST",data:e})},facebookErrorMessage:"Something's not right. Facebook Connect is unreachable right now\u2014please try again later.",_facebookHandler:function(e){var t=this;return function(){var n=t.nodes.modal.$el,o=n.find(".facebookbtn, .twitterbtn"),s=n.find(".buttons");o.hide(),s.spin("large"),i.login(function(t){t.authResponse?window.location="/facebook_login?fbtoken="+t.authResponse.accessToken+"&"+e:(o.show(),s.spin(!1))},{scope:"publish_actions,offline_access,email,user_about_me,user_birthday"})}},_getRedirectPath:function(){var e="redirect=";return e+=t.room&&t.room.roomData?n.getRoomUrl(t.room.roomData):"/"},layouts:{registrationFooter:["div","Not yet a member? ",["a",{href:"/signup"},"Click here to sign up"]],loginFooter:["div","Already a member? ",["a",{href:"/login"},"Click here to sign in"]]}};return o}),define("views/forgot-password-modal",["require","account-modal-mixin","views/input-layouts","modal","views/modal-wrapper","tt-common","validated-form"],function(e){var t=e("account-modal-mixin"),i=e("views/input-layouts"),n=e("modal"),o=e("views/modal-wrapper"),s=e("tt-common"),r=e("validated-form"),a=o.extend(i).extend({el:function(){return[n,{"class":"new-modal forgotpw-modal",title:"Forgot your password?",preCloseCallback:this.options.shouldRoute?s.modalCloseOverride:void 0,footer:t.layouts.loginFooter},["div.message-1","We'll send you an email to reset it."],[r.Form,{id:"tt-forgot-pw",idd:"ttForgotPw"},this.emailInput(),["button.submit",{type:"submit"},"Send email"]]]},init:function(){var e=this;this.nodes.modal.showing.done(function(){e.nodes.emailInput.$input.focus()}),this.nodes.ttForgotPw.$el.on("ValidatedForm:invalid",function(t,i){e.nodes.modal.showAlert(i.err)}).submit(function(t){t.preventDefault(),e.submitForgotPassword()})},submitForgotPassword:function(){var e=this.nodes.ttForgotPw.$el,t=this.nodes.modal.$el,i=this.nodes.emailInput.$input.val();e.hide(),t.spin({bottom:125});var n=this;s.apiGet({api:"user.forgot_password",email:i},!0).done(function(){n.nodes.modal.showAlert("Successfully sent your password reset link. Please check your email.","success")}).fail(function(e){n.nodes.modal.showAlert(e.err)}).always(function(){e.show(),t.spin(!1)})}},{_name:"ForgotPWModal"});return _.extend(a.prototype,t),a}),define("pages/reset-password",["require","pages/modal","views/forgot-password-modal"],function(e){var t=e("pages/modal"),i=e("views/forgot-password-modal"),n=t.extend({title:"Reset Password",initModal:function(){var e=this.addSubview(new i({shouldRoute:!0}));e.show()}},{_name:"ResetPasswordPage"});return n}),function(e){e.fn.rotate=function(e){var t=this.data("rotation")||0;t+=e,this.css("transform","rotate("+t+"deg)").data("rotation",t)}}(jQuery),define("jquery.rotate",function(){}),function(e){e.fn.spin=function(t,i){var n={tiny:{lines:8,length:2,width:2,radius:3},small:{lines:8,length:4,width:3,radius:5},large:{lines:10,length:8,width:4,radius:8}};if(Spinner)return this.each(function(){var o=e(this),s=o.data();s.spinner&&(s.spinner.stop(),delete s.spinner),t!==!1&&("string"==typeof t&&(t=t in n?n[t]:{},i&&(t.color=i)),s.spinner=new Spinner(e.extend({color:o.css("color")},t)).spin(this))});throw"Spinner class not available."}}(jQuery),define("lib/jquery.spin",function(){}),define("views/registration-modal",["require","account-modal-mixin","app","views/input-layouts","modal","views/modal-wrapper","tt-common","validated-form","jquery.rotate","lib/jquery.spin"],function(e){var t=e("account-modal-mixin"),i=e("app"),n=e("views/input-layouts"),o=e("modal"),s=e("views/modal-wrapper"),r=e("tt-common"),a=e("validated-form");e("jquery.rotate"),e("lib/jquery.spin");var l="It looks like you're not a member yet. Choose an avatar and DJ name!",u=8,d={8:[34,5],4:[111,96],34:[141,185],1:[238,274],7:[330,366],5:[407,456]},h=s.extend(n).extend({methodsToBind:["onRefreshClick"],options:{avatarId:u},events:{"click .avatar":"onAvatarClick","click .guest-refresh":"onRefreshClick"},el:function(){function e(e){var t=["div.avatar.avatar-"+e,{data:{avatarId:e}}];return e==i&&(t[0]+=".selected"),t}var i=this.options.avatarId;return[o,{"class":"new-modal guest-modal",title:"Sign up for turntable.fm",preCloseCallback:this.options.shouldRoute?r.modalCloseOverride:void 0,footer:t.layouts.loginFooter},["p.message-1",this.options.completeRegister?l:"Choose an avatar and DJ name"],["div.avatar-speech-bubble",["p.message-2","Just call me"],[a.Form,{id:"tt-register",idd:"ttRegister"},this.nameInput(),["div.guest-refresh"],["button.submit",{type:"submit"},["span.signup-text","Sign up"]]],["div.arrow"]],["div.avatars",["div.guest-avatar-halo"],e(8),e(4),e(34),e(1),e(7),e(5)]]},init:function(e){var t,i=this;this.avatarId=this.options.avatarId,this.nodes.modal.showing.done(function(){i.nodes.nameInput.$input.select()}),e||(e={}),t=_.has(e,"name")?{}:r.apiGet({api:"user.suggest_name"}),$.when(t).done(function(t){var n=e.name||t.suggested_name;i.nodes.ttRegister.$el.find(".guest-refresh").mouseenter(function(e){$(e.currentTarget).rotate(180)}).mouseleave(function(e){$(e.currentTarget).rotate(-180)}),i.nodes.nameInput.$input.val(n),i.nodes.nameInput.validate(),i._positionAvatarDivs(),i.nodes.ttRegister.$el.on("ValidatedForm:invalid",function(e,t){i.nodes.modal.showAlert(t.err)}).submit(function(e){e.preventDefault(),i.submitGuestRegistration()})})},onRefreshClick:function(e){$(e.currentTarget).rotate(180);var t=this;r.apiGet({api:"user.suggest_name"}).done(function(e){t.nodes.nameInput.$input.val(e.suggested_name),t.nodes.nameInput.validate()})},onAvatarClick:function(e){var t=$(e.currentTarget),i=t.data("avatarId");this.avatarId=i,this._positionAvatarDivs(),t.siblings(".selected").removeClass("selected"),t.addClass("selected")},_positionAvatarDivs:function(){var e=this.nodes.modal.$el.find(".arrow"),t=this.nodes.modal.$el.find(".guest-avatar-halo"),i=this._positionAvatarDivs=function(){var i=this.avatarId,n={left:d[i][0]};8==i||4==i?e.removeClass("guest-bubble-arrow-right").addClass("guest-bubble-arrow-left"):e.addClass("guest-bubble-arrow-right").removeClass("guest-bubble-arrow-left"),e.css(n),t.css({left:d[i][1]})};i.call(this)},submitGuestRegistration:function(){var e=this,t=e.nodes.ttRegister.$el,n=e.nodes.modal.$el,o=e.nodes.nameInput.$input.val(),s=e.avatarId,a=n.find(".avatar-speech-bubble"),l=t.add(n.find(".message-2"));l.hide(),a.spin({left:195,top:36}),r.apiGet({api:"user.verify_name",name:o}).done(function(){i.router.setRoute("signupEmailStep",{},{name:o,avatarId:s,completeRegister:e.options.completeRegister},{replace:!0})}).fail(function(t){e.nodes.modal.showAlert(t.err),l.show()}).always(function(){a.spin(!1)})}},{_name:"RegistrationModal"});return _.extend(h.prototype,t),h}),define("pages/signup",["require","pages/modal","views/registration-modal"],function(e){var t=e("pages/modal"),i=e("views/registration-modal"),n=t.extend({title:"Sign Up",initModal:function(e,t){t=t||{},_.extend(t,{shouldRoute:!0});var n=this.addSubview(new i(t));n.show()}},{_name:"SignupPage"});return n}),define("views/complete-registration-modal",["require","account-modal-mixin","app","facebook","views/input-layouts","modal","views/modal-wrapper","fingerprint","tt-common","validated-form"],function(e){var t=e("account-modal-mixin"),i=e("app"),n=e("facebook"),o=e("views/input-layouts"),s=e("modal"),r=e("views/modal-wrapper"),a=e("fingerprint"),l=e("tt-common"),u=e("validated-form"),d=r.extend(o).extend({options:{avatarId:8},events:{"click .selected-avatar":"onAvatarClick"},el:function(){return[s,{"class":"new-modal guest-complete-modal",title:"Sign up for turntable.fm",preCloseCallback:this.options.shouldRoute?l.modalCloseOverride:void 0,footer:t.layouts.loginFooter},["div.selected-avatar",{style:{"background-image":"url("+i.user.getAvatarUrl("fullfront",this.options.avatarId)+")"}},["div.change-avatar","Change"]],[u.Form,{id:"tt-complete-register",idd:"ttCompleteRegister"},this.nameInput(),this.emailInput(),this.passwordInput({placeholder:"new password"}),["button.submit",{type:"submit"},"Sign up"]]]},init:function(){var e=this;this.nodes.modal.showing.done(function(){e.nodes.emailInput.$input.focus()}),e.nodes.nameInput.$input.val(this.options.name),e.nodes.nameInput.validate(),e.nodes.ttCompleteRegister.$el.on("ValidatedForm:invalid",function(t,i){e.nodes.modal.showAlert(i.err)}).submit(function(t){t.preventDefault(),e.submitCompleteGuestRegistration()})},onAvatarClick:function(e){e.preventDefault(),i.router.setRoute("signup",{},{avatarId:this.options.avatarId,name:this.nodes.nameInput.$input.val()},{replace:!0})},submitCompleteGuestRegistration:function(){var e=this;a().done(function(t){var o=e.nodes.ttCompleteRegister.$el,s=e.nodes.modal.$el.find(".content"),r=e.nodes.nameInput.$input.val(),a=e.nodes.emailInput.$input.val(),u=e.nodes.passwordInput.$input.val(),d=e.options.avatarId,h={name:r,email:a,password:u,avatarid:d,fingerprint:t};i.user.id?h.api="user.guest_register":(h.api="user.email_register",h.usertoken=window.TURNTABLE_TOKEN),o.hide(),s.spin(),l.apiPost(h).done(function(t){_gaq.push(["_trackEvent","user","registered",i.user.id?"guest":"nonguest"]),e.setAuthenticationCookies(t).done(function(){var t=e._getRedirectPath();"twitter"==e.options.completeRegister?window.location.href="/twitter_login?"+t:"facebook"==e.options.completeRegister?n.login(function(e){window.location.href="/facebook_login?fbtoken="+e.authResponse.accessToken+"&"+t}):(i.trigger("registered"),i.router.setRoute("signupSocialStep",{},{},{replace:!0}))})}).fail(function(t){o.show(),e.nodes.modal.showAlert(t.err)}).always(function(){s.spin(!1)})})}},{_name:"CompleteRegistrationModal"});return _.extend(d.prototype,t),d}),define("pages/signup-email-step",["require","underscore","pages/modal","views/complete-registration-modal"],function(e){var t=e("underscore"),i=e("pages/modal"),n=e("views/complete-registration-modal"),o=i.extend({title:"Sign Up",initModal:function(e,i){i=i||{},t.extend(i,{shouldRoute:!0});var o=this.addSubview(new n(i));o.show()}},{_name:"SignupEmailStepPage"});return o}),define("views/social-modal",["require","account-modal-mixin","app","facebook","modal","views/modal-wrapper","tt-common"],function(e){var t=e("account-modal-mixin"),i=e("app"),n=e("facebook"),o=e("modal"),s=e("views/modal-wrapper"),r=e("tt-common"),a=s.extend({el:function(){var e,t=this._getRedirectPath(),s=this._facebookHandler(t);return e=n.FB?["div.facebookbtn",{event:{click:s}},"Facebook"]:["p",this.facebookErrorMessage],[o,{"class":"new-modal connect-friends-modal",title:"Turntable is awesome with friends!",preCloseCallback:this.options.shouldRoute?r.modalCloseOverride:void 0,closeCallback:function(){i.trigger("finishedRegistration")}},["div.friends-banner"],["div.connect-buttons.buttons",["a.twitterbtn",{href:"/twitter_login?"+t},"Twitter"],e],["p.message-1","Become a fan of your friends on turntable. Keep track of what they're listening to and when they're DJing!"],["p.message-2","Fan or invite them by clicking a service above."],["a.skip-this-step",{event:{click:function(){i.router.navigateHome()}}},"No thanks, I'll do it later"]]}},{_name:"SocialModal"});return _.extend(a.prototype,t),a}),define("pages/signup-social-step",["require","pages/modal","views/social-modal"],function(e){var t=e("pages/modal"),i=e("views/social-modal"),n=t.extend({title:"Sign Up",initModal:function(){var e=this.addSubview(new i({shouldRoute:!0}));e.show()}},{_name:"SignupSocialStepPage"});return n}),define("views/login-modal",["require","account-modal-mixin","app","facebook","views/input-layouts","modal","views/modal-wrapper","fingerprint","tt-common","validated-form"],function(e){var t=e("account-modal-mixin"),i=e("app"),n=e("facebook"),o=e("views/input-layouts"),s=e("modal"),r=e("views/modal-wrapper"),a=e("fingerprint"),l=e("tt-common"),u=e("validated-form"),d=r.extend(o).extend({el:function(){var e,i=this._getRedirectPath(),o=this._facebookHandler(i);return e=n.FB?["div.facebookbtn",{event:{click:o}},"Sign in with Facebook"]:["p",this.facebookErrorMessage],[s,{"class":"new-modal login-modal",title:"Sign in to turntable.fm",preCloseCallback:this.options.shouldRoute?l.modalCloseOverride:void 0,footer:t.layouts.registrationFooter},[u.Form,{id:"tt-login",idd:"ttLogin"},this.emailInput(),this.passwordInput(),["button.submit",{type:"submit"},"Log in"]],["a.forgot-pw",{href:"/reset-password"},"Forgot your password?"],["div.divider"],["div.guest-or-circle","OR"],["div.buttons",e,["a.twitterbtn",{href:"/twitter_login?"+i,"data-no-route":"true"},"Sign in with Twitter"]]]},init:function(){var e=this;this.nodes.modal.showing.done(function(){e.nodes.emailInput.$input.focus()}),this.nodes.ttLogin.$el.on("ValidatedForm:invalid",function(t,i){e.nodes.modal.showAlert(i.err)}).submit(function(t){t.preventDefault(),e.submitMemberLogin()})},submitMemberLogin:function(){var e=this,t=this.nodes.emailInput.$input.val(),n=this.nodes.passwordInput.$input.val();this.emailLogin(t,n).done(function(e){i.trigger("loggedin",e)}).fail(function(t){e.nodes.modal.showAlert(t.err+".")})},emailLogin:function(e,t){var i=$.Deferred(),n=this.setAuthenticationCookies;return a().done(function(o){var s="https://"+window.location.host+"/api/user.email_login",r=l.prepApiData({email:e,password:t,fingerprint:o});l.crossDomainAjaxRequest({url:s,type:"POST",data:r,success:function(e){if(!e[0])return i.reject(e[1]),void 0;var t=l.prepApiData(e[1]);n(t).done(function(e){i.resolve(e.redirect)}).fail(function(){i.reject()})},error:function(){i.reject()}})}),i.promise()}},{_name:"LoginModal"});return _.extend(d.prototype,t),d}),define("pages/login",["require","pages/modal","views/login-modal"],function(e){var t=e("pages/modal"),i=e("views/login-modal"),n=t.extend({title:"Log In",initModal:function(){var e=this.addSubview(new i({shouldRoute:!0}));e.show()}},{_name:"LoginPage"});return n}),define("views/create-room-modal",["require","tt-base","app","action-modal","views/modal-wrapper","tt-common"],function(e){var t=(e("tt-base"),e("app")),i=e("action-modal"),n=e("views/modal-wrapper"),o=e("tt-common"),s=n.extend({methodsToBind:[/on.*/],el:function(){return[i,{title:"Create Room",className:"createRoom",submitText:"Create Room",submitCallback:this.onSubmit,preCloseCallback:this.options.shouldRoute?o.modalCloseOverride:void 0},["div.field","Room name:",["br"],["input##roomName.roomName.text"],["br"],["br"],"Set my room as:",["div.type",["label.roomtype",{"for":"public"},["div.roomtype-option.roomtype-option-on","Public",["div.radios",["input.radio-input.public#public##isPublic",{type:"radio",name:"type",value:"public",checked:!0}]],["div.tip","(anyone can join)"]]],["label.roomtype",{"for":"unlisted"},["div.roomtype-option","Unlisted",["div.radios",["input.radio-input#unlisted",{type:"radio",name:"type",value:"unlisted"}]],["div.tip","(only people with the link can join)"]]]],["div.advanced##advanced","Let up to ",["select##maxDjs",{name:"maxdjs"},["option",{value:"1"},"1"],["option",{value:"2"},"2"],["option",{value:"3"},"3"],["option",{value:"4"},"4"],["option",{value:"5",selected:"selected"},"5"]]," people DJ",["br"],["br"],"Require ",["input.djThreshold.text##djThreshold",{value:"0",size:3}]," points to DJ",["br"],["br"]],["div.show-advanced##advancedToggle","advanced options"]]]},events:{"click .show-advanced":"onAdvancedClick","click .roomtype-option":"onClickRoomtype"},init:function(){this._super.apply(this,arguments),this.$advanced=$(this.nodes.advanced),this.$advancedToggle=$(this.nodes.advancedToggle)},onSubmit:function(){var e,i,n,s=$.trim(this.nodes.roomName.value);return s?(e=parseInt(this.nodes.maxDjs.value,10),i={api:"room.create",room_name:s,max_djs:e},this.nodes.isPublic.checked||(i.privacy="unlisted"),n=parseInt(this.nodes.djThreshold.value,10),n&&(i.djthreshold=n),o.apiPost(i).done(this.onSuccess).fail(this.onFail),_gaq.push(["_trackEvent","room","create",t.user.get("name"),"unlisted"==i.privacy?0:1]),!1):(this.nodes.modal.showAlert("Room needs a name."),!1)},onAdvancedClick:function(){var e=this.$advanced,t=this.$advancedToggle;"none"==e.css("display")?(e.show(),t.text("close advanced options")):(e.hide(),t.text("advanced options"))},onClickRoomtype:function(e){var t=$(e.currentTarget);t.closest(".type").find(".roomtype-option").removeClass("roomtype-option-on"),t.addClass("roomtype-option-on")},onSuccess:function(e){var i=e.shortcut||e.roomid;t.router.hasRoute("room")?t.router.setRoute("room",{shortcut:i},{roomId:e.roomid}):window.location.href="/"+i},onFail:function(){this.nodes.modal.showAlert("Sorry, an error occurred, please try again!")}},{_name:"CreateRoomModal"});return s}),define("pages/create-room",["require","views/create-room-modal","pages/modal"],function(e){var t=e("views/create-room-modal"),i=e("pages/modal"),n=i.extend({title:"Create Room",initModal:function(){var e=this.addSubview(new t({shouldRoute:!0}));e.show()}},{_name:"CreateRoomPage"});return n}),define("views/graphics-modal",["require","rivets","app","modal","views/modal-wrapper","tt-common"],function(e){var t=e("rivets"),i=e("app"),n=e("modal"),o=e("views/modal-wrapper"),s=e("tt-common");return o.extend({el:function(){return[n,{"class":"new-modal graphics-modal",title:"Graphics Settings",preCloseCallback:this.options.shouldRoute?s.modalCloseOverride:void 0},["div.section",["h3","Zoom"],["div.toggle",["div.option.off",{"data-rv-class-selected":"prefs.disableZoom",data:{disableZoom:!0}},["span","Off"]],["div.option.on",{"data-rv-class-selected":"prefs.disableZoom | not",data:{disableZoom:!1}},["span","On"]]],["p.description","When enabled, scrolling with your mouse or trackpad will move your turntable.fm viewport, allowing you to focus on certain areas of the room. ","When disabled, the viewport will adjust automatically to fit all listeners in the room."]],["div.section",["h3","Animation"],["div.toggle",["div.option.off",{"data-rv-class-selected":"prefs.disableAnimation",data:{disableAnimation:!0}},["span","Off"]],["div.option.on",{"data-rv-class-selected":"prefs.disableAnimation | not",data:{disableAnimation:!1}},["span","On"]]],["p.description","Turn animations off if the site appears slow or laggy."]],["div.section",["h3","WebGL"],["div.toggle",["div.option.off",{"data-rv-class-selected":"prefs.disableWebgl",data:{disableWebgl:!0}},["span","Off"]],["div.option.on",{"data-rv-class-selected":"prefs.disableWebgl | not",data:{disableWebgl:!1}},["span","On"]]],["p.description","When supported, WebGL allows your browser to render the turntable room more quickly and efficiently. ","However, in certain browser/computer combinations, it can cause graphical glitches. ","Disabling WebGL will switch turntable.fm to use Canvas, which is more reliable but slower."],["p.description.important",["strong","TL;DR: "],"Turn off if avatars are missing. Turn on if the site appears slow or laggy."],["p.description.warning",{"data-rv-if":"app:isRoom"},["strong","NOTE: "],"Changing this setting will cause a page refresh. Do not change this setting if you're currently DJing."]]]},events:{"click .option":"onOptionClick"},init:function(){this._super.apply(this,arguments),i.user.authenticating.done(_.bind(function(){this.rivetsView=t.bind(this.el,{prefs:i.prefs,app:i})},this))},onOptionClick:function(e){var t=$.data(e.currentTarget);i.prefs.set(t),i.isRoom&&t.hasOwnProperty("disableWebgl")&&(window.location.href=i.baseUrl)}})}),define("pages/graphics",["require","pages/modal","views/graphics-modal"],function(e){var t=e("pages/modal"),i=e("views/graphics-modal");return t.extend({title:"Graphics Settings",initModal:function(e,t){t=t||{},_.extend(t,{shouldRoute:!0});var n=this.addSubview(new i(t));n.show()}},{_name:"GraphicsPage"})}),define("routes/base",["require","pages/profile","pages/profile","pages/fanned","pages/fans","pages/report-user","pages/avatar-picker","pages/profile-edit","pages/sticker-edit","pages/accounts","pages/payment","pages/cancel-gold","pages/reactivate-gold","pages/social-settings","pages/contact-settings","pages/ignore","pages/reset-password","pages/signup","pages/signup-email-step","pages/signup-social-step","pages/login","pages/create-room","pages/graphics"],function(e){return[{path:"profile(/)",name:"myProfile",modal:e("pages/profile")},{path:"profile/:userId(/)",name:"profile",modal:e("pages/profile")},{path:"profile/:userId/fanned(/)",name:"userFanned",modal:e("pages/fanned")},{path:"profile/:userId/fans(/)",name:"userFans",modal:e("pages/fans")},{path:"profile/:userId/report(/)",name:"reportUser",modal:e("pages/report-user")},{path:"profile/avatar(/)",name:"avatarPicker",modal:e("pages/avatar-picker")},{path:"profile/edit(/)",name:"profileEdit",modal:e("pages/profile-edit")},{path:"profile/stickers(/)",name:"stickerEdit",modal:e("pages/sticker-edit")},{path:"account(/)",name:"accounts",modal:e("pages/accounts")},{path:"account/payment(/)",name:"payment",modal:e("pages/payment")},{path:"account/cancel-gold(/)",name:"cancelGold",modal:e("pages/cancel-gold")},{path:"account/reactivate-gold(/)",name:"reactivateGold",modal:e("pages/reactivate-gold")},{path:"account/social(/)",name:"social",modal:e("pages/social-settings")},{path:"account/contact(/)",name:"contactSettings",modal:e("pages/contact-settings")},{path:"account/ignore(/)",name:"ignore",modal:e("pages/ignore")},{path:"reset-password(/)",name:"resetPassword",modal:e("pages/reset-password")},{path:"signup(/)",name:"signup",modal:e("pages/signup")},{path:"signup/email(/)",name:"signupEmailStep",modal:e("pages/signup-email-step")},{path:"signup/social(/)",name:"signupSocialStep",modal:e("pages/signup-social-step")},{path:"login(/)",name:"login",modal:e("pages/login")},{path:"create-room(/)",name:"createRoom",modal:e("pages/create-room")},{path:"graphics(/)",name:"graphics",modal:e("pages/graphics")}]}),define("pages/room",["require","app","page","room","tt-common"],function(e){var t=e("app"),i=e("page"),n=e("room"),o=e("tt-common"),s=/^[A-Fa-f0-9]{24}$/,r=i.extend({methodsToBind:["onShortcutLoad"],init:function(e,t){this._super.apply(this,arguments);var i=this.shortcut=e.shortcut;this.section=e.section,s.test(i)?(this.roomId=i,this.initRoom()):t&&t.roomId?(this.roomId=t.roomId,this.initRoom()):o.apiGet({api:"room.shortcut_info",shortcut:i,extended:!1}).done(this.onShortcutLoad)},onShortcutLoad:function(e){this.roomId=e.room.roomid,this.initRoom()},initRoom:function(){var e=this.room=new n(this.roomId,this.section);$("#turntable").append(e.view),e.onAddedToDOM&&e.onAddedToDOM(),t.room=turntable.buddyList.room=turntable.sOxwLW=e,t.baseUrl=this.shortcut+(this.section?"/"+this.section:""),t.trigger("room:join",e);var i=this;e.loading.done(function(){i.loadingTitle.resolve(e.roomData.name)})},clearModals:function(){this.room.modal&&this.room.modal.close()},cleanup:function(){this.clearModals(),this.room.cleanup(),$("#turntable").empty()}},{_name:"RoomPage"});return r}),define("views/report-room-modal",["require","tt-base","action-modal","app","views/modal-wrapper","tt-common"],function(e){var t=(e("tt-base"),e("action-modal")),i=e("app"),n=e("views/modal-wrapper"),o=e("tt-common"),s=n.extend({methodsToBind:["onSubmit"],el:function(){return[t,{title:"Report Room",style:{width:480},submitCallback:this.onSubmit,submitText:"Save",preCloseCallback:this.options.shouldRoute?o.modalCloseOverride:void 0},["div.fields",{},["div.field.settings",{},["div","Why are you reporting this room? Please give a short explanation and be as specific as you can."],["textarea#reasonField##reason.textarea",{maxlength:400,placeholder:"Please enter a reason."}]]]]},methodsToBind:["onSubmit"],onSubmit:function(){var e=$(this.nodes.reason).val();if(!e)return this.nodes.modal.showAlert("Please supply a detailed reason"),!1;var t="";return $("div.messages .message").slice(-25,-1).each(function(){t+="<div>"+$(this).html()+"</div>"}),o.apiPost({api:"room.report_room",roomid:this.options.roomId,reason:e,chatlog:t}).done(i.router.navigateHome).fail(this.onFail),!1},onFail:function(e){this.nodes.modal.showAlert(e)}},{_name:"ReportRoomModal"});return s}),define("pages/report-room",["require","pages/modal","views/report-room-modal"],function(e){var t=e("pages/modal"),i=e("views/report-room-modal"),n=/^[A-Fa-f0-9]{24}$/,o=t.extend({methodsToBind:["onShortcutLoad"],title:"Report Room",initModal:function(e,t){var i=this.shortcut=e.shortcut;n.test(i)?(this.roomId=i,this.initReportRoom()):t&&t.roomId?(this.roomId=t.roomId,this.initReportRoom()):ttCommon.apiGet({api:"room.shortcut_info",shortcut:i,extended:!1}).done(this.onShortcutLoad)},initReportRoom:function(){var e=this.addSubview(new i({roomId:this.roomId,shouldRoute:!0}));e.show()},onShortcutLoad:function(e){this.roomId=e.room.roomid,this.initReportRoom()}},{_name:"ReportRoomPage"});return o}),define("infobox",["require","tt-base","app","tt-common"],function(e){var t=e("tt-base"),i=e("app");e("tt-common");var n=t.View.extend({el:["div#myInfo",["span.myName","Loading..."]],events:{"click .myAvatar":"showAvatarsHandler","click .myName":"onNameClick","click .myFans":"onFansClick","click #connectBanner .connectClose":"closeConnectBanner","click #connectError .connectClose":"closeConnectError","click .connectBtn":"connectSocial"},init:function(e){this.user=e.user,this.listenTo(this.user,"change:avatarId",this.updateAvatar),this.listenTo(this.user,"change:name",this.updateName)},render:function(){return this.user.loading.done(_.bind(function(){var e=this.user,t=e.get("name"),i=e.get("images").fullfront,n=e.get("points"),o=e.get("fans");this.$el.html(this.build("myInfo",t,i,n,o)),!$("div#connectBanner").length&&e.registered&&this.$el.prepend(this.drawConnectBanner())},this)),this},onNameClick:function(){i.router.setRoute("profile",{userId:this.user.id})},onFansClick:function(){i.router.setRoute("userFans",{userId:this.user.id})},updateAvatar:function(e){var t=this.$el.find(".myAvatar");if(t.length){var i=e.getAvatarUrl("fullfront");t.attr("src",i)}},updateName:function(e,t){var i=this.$el.find(".myName");i.length&&i.text(t)},showAvatarsHandler:function(){i.router.setRoute("avatarPicker")},drawConnectBanner:function(){var e=[],t=this.user.id,i=util.getSetting("connectBannerClicked"+t),n=util.getSetting("hideConnectError"+t),o=util.getSetting("hideConnectBanner"+t);if(this.user.has("twitterid"))if(this.user.has("fbid")){if(!o&&i){var s=this;setTimeout(function(){s.closeConnectBanner()},7e3),e.push(s.build("connectBanner",i,!0))}}else n||"Facebook"!=i||e.push(this.build("connectError","Facebook")),o||e.push(this.build("connectBanner","Facebook",!1));else n||"Twitter"!=i||e.push(this.build("connectError","Twitter")),o||e.push(this.build("connectBanner","Twitter",!1));return e},closeConnectBanner:function(){this.$el.find("#connectBanner, #connectError").slideUp("slow"),util.setSetting("hideConnectBanner"+this.user.id,"true"),util.setSetting("hideConnectError"+this.user.id,"true")},closeConnectError:function(){this.$el.find("#connectError").slideUp("slow"),util.setSetting("hideConnectError"+this.user.id,"true")},connectSocial:function(e){$(e.currentTarget).hasClass("twitter")?i.trigger("connectTwitter",this.user.id):i.trigger("connectFacebook",this.user.id)}});return n.layouts={myInfo:function(e,t,i,n){return[["img.myAvatar",{src:t,align:"right",height:"60"}],["span.myName",e],["span.myStats",["span.myStatsNum",i]," DJ points"],["span.myStats.myFans",["span.myStatsNum",n]," fans"]]},connectBanner:function(e,t){var i,n,o,s;return t?(i="You're connected!",n=["div.connectText.connected",{},"Yay! Your "+e+" pals will now show up in your friends list below."],o=["div.connectBtn.connected."+e.toLowerCase()],s=["div.connectCheck"]):(i="See more friends.",n=["div.connectText",{},"Connect your "+e+" account & see more friends below."],o=["div.connectBtn."+e.toLowerCase()],s=["div.connectHappyBoy"]),["div#connectBanner",["div.connectClose"],["div.connectHeader",i],n,o,s]},connectError:function(e){return["div#connectError",["div.connectClose"],["h2",e+" connect error"],"Sorry, an error occurred while trying to connect your "+e+" account.",["br"],["a",{href:"/static/faq.html"},"Check out our FAQ"]," for help, or e-mail help at turntable.fm."]}},n}),define("lobby-panel",["require","underscore","tt-base","app","infobox","tt-common","util","lib/jquery.tipsy"],function(e){var t=(e("underscore"),e("tt-base")),i=e("app"),n=e("infobox"),o=e("tt-common"),s=e("util");e("lib/jquery.tipsy");var r="Friends",a="buddy-list-friend-icon.png",l=t.View.extend({el:function(){return l.layouts.panel},init:function(e){this.user=e.user,this.buddyRooms={},this.listenTo(i.directoryGraph,"change:rooms",function(){this.updateList(i.directoryGraph.attributes)}),this.updateList(i.directoryGraph.attributes);var t=new n({user:this.user});this.addSubView("infobox",t),this.renderSubViews()},updateList:function(e){var t=!1,i=0;if(this.buddyRooms={},e.rooms&&e.rooms.length)for(var n=this.sortBuddyRooms(e.rooms),o=0,a=n.length;a>o;o++){var u=n[o];if(u.length>=2){var d=$(this.nodes.container);t||(d.empty(),t=!0);var h=s.buildTree(l.layouts.room(u[0],u[1]));d.append(h),d.children().last().find(".buddyIcon").each(function(e){if("undefined"!=typeof u[1][e]){var t=$(this).find(".buddyImg"),i='url("'+l.layouts.getBuddyIcon(u[1][e])+'")';t.css("background-image",i)}}),$("div.buddyIcon").tipsy({gravity:"s",offset:-7,html:!1,opacity:.9}),i+=u[1].length,this.buddyRooms[u[0].roomid]=[];for(var c=0,p=u[1].length;p>c;c++){var f=u[1][c],m="undefined"==typeof f.fbid&&"undefined"==typeof f.twitterid?"fanned":"friends";this.buddyRooms[u[0].roomid].push({name:f.name,userid:f.userid,type:m,icon:l.layouts.getBuddyIcon(f)})}}}if(!t){var g=s.buildTree(l.layouts.noItems(r));$(this.nodes.container).empty(),$(this.nodes.container).append(g)}$(this.nodes.buddyCount).html(i)},sortBuddyRooms:function(e){var t=this;e.sort(function(e,i){return e.length>=2&&i.length>=2?e[1].length!=i[1].length?i[1].length-e[1].length:t.countFBFriends(i[1])-t.countFBFriends(e[1]):0});for(var i=function(e,t){var i,n;return i="undefined"!=typeof e.fbid?1:0,n="undefined"!=typeof t.fbid?1:0,n-i},n=0,o=e.length;o>n;n++)"undefined"!=typeof e[n][1]&&e[n][1].sort(i);return e},countFBFriends:function(e){for(var t=0,i=0,n=e.length;n>i;i++)"undefined"!=typeof e[i].fbid&&t++;return t}},{_name:"Panel"});return l.layouts={panel:["div#buddyList.right-column.lobby-panel",["div#buddyListHeader.lobby-panel-header",["div##infobox"]],["div#buddyListContent",["div.buddyListTitle",["div.buddyListTitleText",r],["div.buddyCount",["div.buddyCountIcon.friendsIcon",["img",{src:IMG_PATH+"lobby/"+a}]],["div##buddyCount.buddyCountMid","0"]]],["div##container",["div.buddyListNone","Loading..."]]]],noItems:function(e){return["div.buddyListNone",{},"No "+e+" are online."]},room:function(e,t){for(var i=o.getRoomUrl(e),n=["div.buddyListRoom",{event:{click:function(){window.location.href=i
}}},["div.buddyRoomName",{},e.name],["div.joinRoomButton"]],s=["div.buddyIcons",{}],r=0,a=t.length;a>r;r++)s.push(l.layouts.buddyInfo(t[r]));for(var u=0==t.length%5?0:5-t.length%5,r=0;u>r;r++)s.push(l.layouts.buddyInfo());return n.push(s),n.push(["div.buddyRoomFloatClear"]),n},buddyInfo:function(e){var t=e&&e.name?{title:e.name}:{},i=["div.buddyIcon",t];if(e&&(e.fbid||e.twitterid||e.images.headfront)){var n=!(e.fbid||e.twitterid),o=n?".isAvatar":"";i.push(["div.buddyIconFrame"]),i.push(["div.buddyImg"+o])}return i},getBuddyIcon:function(e){return e.fbid?"https://graph.facebook.com/"+e.fbid+"/picture":e.twitter_profile_image?e.twitter_profile_image:e.images.headfront}},l}),define("models/roomlist-settings",["require","tt-base","util"],function(e){var t=e("tt-base"),i=e("util"),n="allRooms",o="hotness",s="newLobbyView",r="newLobbySort",a=t.Model.extend({defaults:{view:n,sort:o},init:function(){this.has("registered")||(this.set("view",n),this.set("sort",o)),i.setSetting("lobbyView",null),i.setSetting("lobbySort",null)},getView:function(){return this.get("view")},getSort:function(){return this.get("sort")},setView:function(e){var t=o,n={view:e,sort:t};this.set(n),this.unset("query"),i.setSetting(s,e),i.setSetting(r,t)},setSort:function(e){this.set("sort",e),i.setSetting(r,e)}});return a.defaultView=n,a.defaultSort=o,a.viewCookie=s,a.sortCookie=r,a}),define("lobby-roomlist",["require","underscore","tt-base","util","app","lobby-panel","models/roomlist-settings","tt-common","lib/jquery.tipsy"],function(e){var t=e("underscore"),i=e("tt-base"),n=e("util"),o=e("app"),s=e("lobby-panel"),r=e("models/roomlist-settings"),a=e("tt-common");e("lib/jquery.tipsy");var l=20,u=IMG_PATH+"playlist/empty-record.png",d=i.View.extend({options:{idd:"roomList"},el:["div.room-list"],methodsToBind:["scrollHandler"],init:function(e){this.buddyRooms=[],this.currentRoomId=e.currentRoomId,this.searchQuery=null,this.skip=0,this.last_refresh=0,this.$window=$(window),this.refreshRoomList(),this.listenTo(this.model,"change",this.onSettingChange),this.loadingBuddyList=$.Deferred(),this.listenTo(o.directoryGraph,"change:rooms",function(){this.loadBuddyList(o.directoryGraph.get("rooms"))});var t=o.directoryGraph.get("rooms");t&&this.loadBuddyList(t)},onSettingChange:function(){this.refreshRoomList()},refreshRoomList:function(e){var i=this.model;this.$window.off("scroll",this.scrollHandler),this.showLoading(),e||(this.skip=0),o.trigger("refreshRoomList");var n=this.skip/l||0,s={limit:l};if(this.skip&&(s.skip=this.skip),i.has("query")){var u=i.get("query");s.api="room.search",s.query=u,_gaq.push(["_trackPageview","/virtual/lobby/search/"+u+"/"+n])}else{var d=i.getSort(),h=i.getView();s.api="room.directory_rooms",s.section_aware=!0;var c=[];if("DJsNeeded"==h)c.push("available_djs");else if("favorites"==h)c.push("favorites");else if("allRooms"==h&&"created"==d)c.push("has_people=1");else if("allRooms"==h&&"random"==d)c.push("has_people=5");else if("allRooms"==h&&d.indexOf("-")>=0){for(var p=d.split(","),f=0,m=p.length;m>f;f++){var g=p[f].split("-");g&&2==g.length&&c.push(g[0]+"="+g[1])}c.push("has_people=1");var v=r.defaultSort;d.indexOf(v)<0&&(d=v+","+d)}c.length&&(s.constraints=c.join(",")),d&&(s.sort=d),_gaq.push(["_trackPageview","/virtual/lobby/"+h+"/"+d+"/"+n])}e?a.apiGet(s).done(t.bind(this.listRoomsAppend,this)):a.apiGet(s).done(t.bind(this.listRooms,this))},showLoading:function(){var e=$("#mainPanelLoadOverlay"),t=$("#mainPanelLoadOverlay img");if(this.$el.length&&e.length&&t.length){var i=this.$el.position(),n=3;e.css({left:i.left+n+"px",top:i.top+"px"}),e.width(this.$el.width()-2*n),e.height(this.$el.height());var o=this.$window.scrollTop();if(o>i.top){var s=o-i.top+this.$window.height()/2;t.css({marginTop:s+"px"})}else t.css({marginTop:"20px"});e.show()}},listRooms:function(e,i){if($("div#mainPanelLoadOverlay").hide(),i||(this.$el.empty(),this.el.scrollTop=0),!e.rooms.length){var o;return o=n.buildTree(d.layouts.noResults()),this.el.appendChild(o),!1}for(var s=this,r=function(){s.enterRoom($(this))},a=0;a<e.rooms.length;a++){var h=e.rooms[a],c=null;t.isArray(h)&&(c=h[2][0],h=h[0]),!c&&h.metadata.current_song&&(c=h.metadata.current_song.metadata);var p=c&&c.coverart?c.coverart:u,f=c?c.artist+" \u2015 "+c.song:"",m=n.buildTree(d.layouts.roomViewIndex(h,p,f,r)),g=$(m).find(".songName");g.append(f),g.attr("title",f),c&&c.played&&g.append(n.buildTree(["span.songPlayed","played "+n.prettyTimeDelta(c.played)])),h.roomid==this.currentRoomId&&$(m).addClass("currentRoom"),this.el.appendChild(m)}e.rooms.length>=l?(this.hideListBottom(),this.$window.on("scroll",this.scrollHandler)):this.showListBottom(),this.addBuddyIcons()},listRoomsAppend:function(e){this.listRooms(e,!0)},scrollHandler:function(){var e=this.$el.offset().top+this.$el.outerHeight(!0),t=this.$window.scrollTop()+this.$window.height();if(t>=e){var i=(new Date).getTime();(i-this.last_refresh)/1e3>1&&(this.skip+=l,this.refreshRoomList(!0),this.last_refresh=(new Date).getTime())}},showListBottom:function(){$("div#mainPanel").css({paddingBottom:"11px",marginBottom:"25px"})},hideListBottom:function(){$("div#mainPanel").css({paddingBottom:"0px",marginBottom:"0px"})},loadBuddyList:function(e){for(var t=0,i=e.length;i>t;t++){var n=e[t];this.buddyRooms[n[0].roomid]=[];for(var o=0,r=n[1].length;r>o;o++){var a=n[1][o],l="undefined"==typeof a.fbid&&"undefined"==typeof a.twitterid?"fanned":"friends";this.buddyRooms[n[0].roomid].push({name:a.name,userid:a.userid,type:l,icon:s.layouts.getBuddyIcon(a)})}}this.loadingBuddyList.resolve(),this.addBuddyIcons()},addBuddyIcons:function(){var e=this;this.loadingBuddyList.done(function(){var t=e.buddyRooms;e.$el.find(".roomListItem").each(function(){var i=$(this),o=i.data();if("undefined"!=typeof t[o.id]){i.find(".roomListBuddies").remove();var s=e.sortBuddies(t[o.id]);i.find(".roomListItemContent").after(n.buildTree(d.layouts.buddyIcons(s)));var r=0,a=47;i.find(".roomListBuddy").each(function(e){var t=s[e];3*a>r&&(r+=a);var i='url("'+t.icon+'")';$(this).find(".roomListBuddyIcon").css("background-image",i)}),i.find(".roomListItemContent").css({paddingRight:r})}}),$("div.roomListBuddyIcon").tipsy({gravity:"s",offset:-7,html:!1,opacity:.9})})},sortBuddies:function(e){var t=[],i=[];for(var n in e)"friends"==e[n].type?i.push(e[n]):t.push(e[n]);var o=i.concat(t);return o},enterRoom:function(e){if(!e.hasClass("currentRoom")){var t=e.data();if(t.shortcut||t.id||alert("Sorry, this room appears to be broken! Please refresh and try again, and let us know if you continue to have trouble."),o.router.hasRoute("room"))o.router.setRoute("room",{shortcut:e.data("shortcut")},{roomId:e.data("id")},{replace:!0});else{var i=a.getRoomUrl(e.data()),n=window.location.hostname;window.location.href="http://"+n+i}}}},{_name:"RoomList"});return d.layouts={roomViewIndex:function(e,t,i,n){var o=e.metadata.max_djs-e.metadata.djcount,s=o>0?".needed":"",r=1==o?" DJ spot":" DJ spots";0==o&&(o="No");var a=e.metadata.featured?["span.featured","Featured"]:null;return["div.roomListItem",{data:{id:e.roomid,shortcut:e.shortcut},event:{click:n}},["div.roomAlbumArt",{style:{"background-image":"url("+t+")"}}],["div.roomListItemContent",{},["span.roomName",{},e.name],a,["span.songName",{}],["div.roomStats",{},["div.stat.roomDJs"+s,{},["div.icon"],["div.count",o,r]],["div.stat.roomListeners",["div.icon"],["div.count",e.metadata.listeners.toString()," listeners"]]]],["div.listenNow","Listen now"]]},noResults:function(){return["div.noResults",{},["h1",{},"Sorry, no results were returned."],["div",{},"Try another search term, or click a navigation button."]]},buddyIcons:function(e){for(var t=["div.roomListBuddies",{}],i=0,n=Math.min(3,e.length);n>i;i++)t.push(d.layouts.buddyIcon(e[i]));return e.length>3&&t.push(["div.moreRoomBuddies",{},"+"+(e.length-3)+" more"]),t},buddyIcon:function(e){var t="40",i="";return"fanned"==e.type&&(t="33",i=".isAvatar"),["div.roomListBuddy",{},["div.roomListBuddyIcon"+i,{title:e.name}]]}},d}),define("roomsearch",["require","rivets","tt-base"],function(e){var t=e("rivets"),i=e("tt-base");return i.View.extend({el:["form.room-search-input",["input##searchQuery",{"data-rv-class-active":"settings.query",placeholder:"Search all Rooms"}],["div.mag-glass"],["div.clear-search",{"data-rv-show":"settings.query"}]],events:{submit:"searchSubmit","click .clear-search":"clearSearch"},init:function(){this.rivetsView=t.bind(this.el,{settings:this.model}),this.listenTo(this.model,"change:query",this._onQueryChange)},searchSubmit:function(e){e.preventDefault();var t=$.trim(this.nodes.searchQuery.value);this.model.set("query",t)},clearSearch:function(){this.model.unset("query")},_onQueryChange:function(e,t,i){this.nodes.searchQuery.value=i&&i.unset?"":t}},{_name:"RoomSearchInput"})}),define("views/room-list-modal",["require","app","modal","views/modal-wrapper","lobby-roomlist","models/roomlist-settings","roomsearch","tt-common"],function(e){var t=e("app"),i=e("modal"),n=e("views/modal-wrapper"),o=e("lobby-roomlist"),s=e("models/roomlist-settings"),r=e("roomsearch"),a=e("tt-common"),l=n.extend({el:function(){return this.roomListSettings=new s,[i,{className:"room-list-modal",showClose:!1,clickOut:!1},[r,{model:this.roomListSettings}],[o,{currentRoomId:t.room.id,model:this.roomListSettings}],["div.buttons",["button.create-room","Create Room"],["button.random-room","Random Room"],["button.cancel","Close"]]]},events:{"click .create-room":"createRoom","click .random-room":"randomRoom","click .cancel":"onCancel"},createRoom:function(){t.router.setRoute("createRoom")},randomRoom:function(){a.apiGet({api:"room.random_room"}).done(function(e){t.router.setRoute("room",{shortcut:e.room.shortcut},{roomId:e.room.roomid},{replace:!0})})},onCancel:function(){t.router.navigateHome()},remove:function(){this.nodes.roomList.remove(),this.nodes.roomList=void 0,this._super.apply(this,arguments)}},{_name:"RoomListModal"});return l}),define("pages/room-list",["require","views/room-list-modal","pages/modal","page"],function(e){var t=e("views/room-list-modal"),i=e("pages/modal"),n=e("page"),o=i.extend({title:"Room List",supportsMiniplayer:!0,init:function(){n.prototype.init.apply(this,arguments);var e=this.addSubview(new t);e.show()}},{_name:"RoomListPage"});return o}),define("routes/room",["require","routes/base","pages/room","pages/report-room","pages/room-list"],function(e){var t=e("routes/base"),i=e("pages/room");return[{path:":shortcut(/)",name:"room",page:i},{path:":shortcut/:section(/)",name:"roomSection",page:i},{path:":shortcut/report(/)",name:"reportRoom",page:i,modal:e("pages/report-room")},{path:"rooms",name:"rooms",modal:e("pages/room-list")}].concat(t)}),define("models/message",["require","tt-base","app"],function(e){var t=e("tt-base"),i=e("app");return t.Model.extend({idAttribute:"time",api:"pm.send",parse:function(e){return e.text?e:{time:Date.now(),senderid:i.user.id}},save:function(){return this._super(null,{attrs:{receiverid:this.get("userid"),text:this.get("text")}})}},{_name:"Message"})}),define("collections/message-history",["require","tt-base","models/message"],function(e){var t=e("tt-base"),i=e("models/message");return t.Collection.extend({api:"pm.history",model:i,init:function(e,t){t.user&&(this.user=t.user,this.loading=this.fetch({attrs:{receiverid:this.user.id},silent:!0})),this.fetchTime=Date.now()},parse:function(e){return e.history}},{_name:"MessageHistory"})}),define("models/conversation",["require","tt-base","app","models/counter","models/message","collections/message-history","player","models/user"],function(e){var t=e("tt-base"),i=e("app"),n=e("models/counter"),o=e("models/message"),s=e("collections/message-history"),r=e("player"),a=e("models/user");return t.Model.extend({stores:{user:"users"},methodsToBind:["_onSendFail"],init:function(){this.unreadCount=new n(null,{max:99});var e=a.prototype.parse(this.get("user")),t=this.user=this.getUser({_id:e._id});t.set(e),this.unset("user"),this.listenTo(this.unreadCount,"change:count",this._onUnreadCountChange),this.on("change:selected change:visible",this.onVisibilityChange),this.listenTo(i,"room:join",this._onRoomChange),this.listenTo(this.user,{"change:roomId":this._onRoomChange,"change:status":this._onStatusChange})},open:function(){this.get("open")||(this.messageHistory=new s(null,{user:this.user}),this.listenTo(this.messageHistory,"add",this.onMessageAdd),this.set("open",!0))},select:function(){this.get("open")||this.open(),this.set("selected",!0)},deselect:function(){this.set("selected",!1)},send:function(e){if(i.user.isBlocked(this.user.id))return!1;_gaq.push(["_trackEvent","pm","send",i.get("miniplayer")?"mini":"full"]);var t=new o({userid:this.user.id,text:e}),n=this;return t.save().done(function(){n.messageHistory.add(t),n.user.get("status").match(/offline|unavailable/)&&n.user.fetchStatus()}).fail(this._onSendFail)},onMessageAdd:function(e){e.get("senderid")===i.user.id||this.get("selected")&&this.get("visible")||(this.unreadCount.inc(),i.volume.get("pmDing")&&r.playEphemeral(UI_SOUND_PM,!0))},onVisibilityChange:function(){this.get("selected")&&this.get("visible")&&this.unreadCount.reset()},_onUnreadCountChange:function(){this.trigger("change:unreadCount",this,this.unreadCount)},_onRoomChange:function(){i.room.roomId===this.user.get("roomId")?this.set("inSameRoom",!0):this.set("inSameRoom",!1)},_onStatusChange:function(){"offline"===this.user.get("status")&&(this.user.set({roomId:null,roomName:null,roomShortcut:null}),this.set("inSameRoom",!1))},_onSendFail:function(e){var t=e.errorId;4===t?this.user.set("status","offline"):5===t?this.user.set("status","unavailable"):6===t&&i.presence.set("unavailable",!0)}},{_name:"Conversation"})}),define("collections/pms",["require","tt-base","app","models/conversation","models/counter","models/message","tt-common"],function(e){var t=e("tt-base"),i=e("app"),n=e("models/conversation"),o=e("models/counter"),s=e("models/message"),r=e("tt-common");return t.Collection.extend({model:n,methodsToBind:["_onSocketMessage"],init:function(){this.unreadCount=new o(null,{max:99}),this.on("change:selected",this._onConversationSelectedChange),this.on("change:unreadCount add remove",this._onUnreadCountChange),this.listenTo(i.directoryGraph,"change",function(){this.set(this.parse(i.directoryGraph.attributes))}),turntable.addEventListener("message",this._onSocketMessage)},manualInsert:function(e,t){t=this._parseUser(e,t,!0),t&&this.add([t],{merge:!0})},comparator:function(e){return e.user.get("name").toLowerCase()},remove:function(e,t){var i=_.map(_.isArray(e)?e.slice():[e],this.get,this),n=_.filter(i,function(e){return e.get("open")});this._fetchPresence(n);var o=_.without.apply(_,[i].concat(n));return _.invoke(o,"cleanup"),this._super(o,t)},parse:function(e){return _.flatten(_.map(e.rooms,this._parseRoom,this))},_parseRoom:function(e){var t=e[0],i=e[1];return _.compact(_.map(i,_.bind(this._parseUser,this,t)))},_parseUser:function(e,t,n){return"offline"===t.status&&!n||t._id===i.user.id?void 0:(t.laptop&&("android"===t.laptop||"iphone"===t.laptop&&parseFloat(t.laptop_version)<2.1)&&(t.status="no-pm"),t.roomName=e.name,t.roomShortcut=e.shortcut,t.roomId=e.roomid,{_id:t._id,user:t})},_onConversationSelectedChange:function(e,t){t?(this.selectedConversation&&this.selectedConversation!==e&&this.selectedConversation.deselect(),this.selectedConversation=e):this.selectedConversation=void 0},_onUnreadCountChange:function(){this.unreadCount.set("count",this.reduce(this._unreadCountIterator,0))},_unreadCountIterator:function(e,t){return e+t.unreadCount.get("count")},_onSocketMessage:function(e){if("pmmed"===e.command){var t=new s(e),i=this.get(e.senderid);if(!i){i=new n({_id:e.senderid,user:{_id:e.senderid}});var o=i.user;o.get("name")?this.add(i):o.fetchInfo().done(_.bind(this.add,this,i))}if(i.get("open")?i.messageHistory.add(t):(i.open(),i.messageHistory.loading.done(function(){i.messageHistory.add(t),i.onMessageAdd(t)})),e.roomobj){var r=e.roomobj;i.user.set({roomId:r.roomid,roomName:r.name,roomShortcut:r.shortcut})}this.trigger("newMessage",i)}},_fetchPresence:function(e){e=_.isArray(e)?e.slice():[e];var t=this,i=_.pluck(e,"id");r.apiPost({api:"presence.get_multi",uids:i}).done(function(e){var n=_.pluck(_.pluck(e.presences,"presence"),"userid"),o=_.difference(i,n);_.each(o,function(e){t.get(e).user.set("status","offline")}),_.each(e.presences,function(e){e=e.presence,t.get(e.userid).user.set("status",e.status)})})}},{_name:"PMs"})}),define("models/volume",["require","tt-base","player"],function(e){var t=e("tt-base"),i=e("player"),n=t.Model.extend({init:function(){this.set({volume:(parseFloat(util.getSetting("volume"))||i.volume)/4,mute:!1,pmDing:!("false"===util.getSetting("pmding"))}),this.listenTo(this,{"change:volume":this._setVolume,"change:mute":this._setMute}),this.listenTo(this,{"change:volume":_.debounce(this._saveVolume,200),"change:pmDing":this._savePMDing})},set:function(e,t){"volume"===e?(t=Math.min(1,Math.max(0,t)),this._super(e,t)):this._super.apply(this,arguments)},_setVolume:function(e,t){i.setVolume(4*t),this.get("mute")&&this.set("mute",!1)},_saveVolume:function(e,t){util.setSetting("volume",4*t)},_setMute:function(e,t){t?i.setVolume(0):i.setVolume(4*this.get("volume"))},_savePMDing:function(e,t){util.setSetting("pmding",t.toString())}},{_name:"Volume"});return n}),function(e){e.fn.konami=function(t){var i=e.extend({},e.fn.konami.defaults,t);return this.each(function(){var t=[38,38,40,40,37,39,37,39,66,65],n=[];e(window).keyup(function(e){var o=e.keyCode?e.keyCode:e.which;if(n.push(o),10===n.length){for(var s=!0,r=0,a=t.length;a>r;r++)t[r]!==n[r]&&(s=!1);s&&i.cheat(),n.shift()}})})},e.fn.konami.defaults={cheat:null}}(jQuery),define("lib/jquery.konami",function(){}),define("snake",["require","util","modal","app","lib/jquery.konami"],function(e){var t=e("util"),i=e("modal"),n=e("app");e("lib/jquery.konami");var o=function(){function e(){_="right",o(),r(),S=0,"undefined"!=typeof k&&window.clearInterval(k),k=window.setInterval(a,90)}function o(){var e=5;C=[];for(var t=e-1;t>=0;t--)C.push({x:t,y:0})}function s(){for(var e in n.avatars){var t=new Image;t.src=n.avatars[e].images.hf,M.push(t)}}function r(){x={x:Math.round(Math.random()*(w-I)/I),y:Math.round(Math.random()*(y-I)/I)},x.image=M[Math.floor(Math.random()*M.length)];var e=0;for(var t in n.avatars)Math.random()<1/++e&&(x.image.src=n.avatars[t].images.hf)}function a(){if(0!==P.length){var e=P.shift();"37"==e&&"right"!=_?_="left":"38"==e&&"down"!=_?_="up":"39"==e&&"left"!=_?_="right":"40"==e&&"up"!=_&&(_="down")}T.clearRect(0,0,w,y),T.strokeStyle="black",T.strokeRect(0,0,w,y);var n=C[0].x,o=C[0].y;switch(_){case"right":n++;break;case"left":n--;break;case"up":o--;break;case"down":o++}if(-1==n||n==w/I||-1==o||o>=y/I||h(n,o,C))return $(document).off("keydown",D),c.modal.close(),window.clearInterval(k),$(t.buildTree([i,["div#snake-loser","You got "+S+" points! You're a wizard!"]],c)),c.modal.show(),void 0;var s;n==x.x&&o==x.y?(s={x:n,y:o},S++,r()):(s=C.pop(),s.x=n,s.y=o),C.unshift(s);for(var a=0;a<C.length;a++){var p=C[a];0===a?u(p.x,p.y):d(p.x,p.y)}l(x);var f="Score: "+S;T.fillStyle="#D8A126",T.fillText(f,5,y-5)}function l(e){if(e.image.complete){var t,i;e.image.width>e.image.height?(t=I,i=e.image.height/e.image.width*I):(i=I,t=e.image.width/e.image.height*I),T.drawImage(e.image,e.x*I,e.y*I,t,i)}}function u(e,t){switch(T.save(),T.translate(e*I+I/2,t*I+I/2),_){case"right":T.rotate(3*(Math.PI/2));break;case"left":T.rotate(Math.PI/2);break;case"up":T.rotate(Math.PI);break;case"down":}T.drawImage(v,-I/2,-I/2,I,I),T.restore()}function d(e,t){T.drawImage(b,e*I,t*I,I,I)}function h(e,t,i){for(var n=0;n<i.length;n++)if(i[n].x==e&&i[n].y==t)return!0;return!1}LOG("it's time to snake this joint up");var c={},p=t.buildTree([i,{showClose:!1,clickOut:!1},["canvas#snakecvs"],["div#snake-time-to-start"]],c);c.modal.show();var f=$(p).find("#snakecvs"),m=f.get(0),g=$(p).find("#snake-time-to-start"),v=new Image,b=new Image;v.src=IMG_PATH+"snake/head.png",b.src=IMG_PATH+"snake/body.png";var w=f.width(),y=f.height();f.attr({width:w,height:y});var _,x,S,k,C,T=m.getContext("2d"),I=32,M=[],P=[];s();var A=3;g.show();var E=setInterval(function(){g.text(A),0===A&&(clearInterval(E),g.hide(),e()),A--},1e3),D=function(e){var t=e.which;P.push(t)};$(document).on("keydown",D)};$(window).konami({cheat:o})}),define("apps/room",["require","soundmanager","tt-base","app","views/chrome","config","models/directory-graph","models/favorites","models/preferences","models/presence","sticker","main","resize","room","routes/room","store","playlist","collections/pms","models/user","models/volume","snake"],function(e){var t=e("soundmanager"),i=e("tt-base"),n=e("app"),o=e("views/chrome"),s=e("config"),r=e("models/directory-graph"),a=e("models/favorites"),l=e("models/preferences"),u=e("models/presence"),d=(e("sticker"),e("main")),h=(e("resize"),e("room")),c=e("routes/room"),p=e("store"),f=e("playlist"),m=e("collections/pms"),g=e("models/user"),v=e("models/volume");if(e("snake"),$.browser.msie){var b=util.detectIEVersion();(!b||9>b)&&alert("Turntable.fm doesn't work too well in Internet Explorer right now. Join the party with Firefox, Chrome, or Safari!"),b>=9&&10>b&&$(function(){WebSocket.__initialize()})}n.isRoom=!0,n.volume=new v;var w=p.stores.get([{name:"users"}],this),y=g.prototype.getUser(),_=y?y.id:void 0,x=n.user=d.user=w.get([{_id:_},{fullInfo:!0}],this);x.authenticating.done(function(){var e=n.presence=new u;n.directoryGraph=new r(void 0,{presence:e}),n.prefs=new l,n.favorites=new a,n.pms=new m(void 0,{presence:e});var t=n.chromeView=new o;f.init(t.playlistPane.$("#playlist")),$("#maindiv").append(t.el)}),n.initialLoading=$.Deferred(),n.turntable=window.turntable=d,d.playlist=f,window.Room=h,n.router=new i.Router(c,{routeLinks:!0,title:"turntable.fm"}),$(function(){t.beginDelayedInit(),s.DEBUG_MODE&&$(".less-error-message").length&&$("#turntable").hide()}),$(document).ready(d.main),$(window).on("beforeunload unload",d.closeSocket),s.DEBUG_MODE&&(window.app=n)}),require(["apps/room"]);